{"version":3,"file":"build.service-Cqpku5ux.js","sources":["../../../../src/services/build.service.ts"],"sourcesContent":["import { db } from './db/indexeddb.service';\r\nimport { useSavedBuildsStore, useProfileStore } from '../store';\r\nimport { transferService } from './bungie/transfer.service';\r\nimport { manifestService } from './bungie/manifest.service';\r\nimport { profileService } from './bungie/profile.service';\r\nimport { modService } from './bungie/mod.service';\r\nimport { SOCKET_CATEGORY_HASHES, STAT_HASHES } from '../config/bungie.config';\r\nimport type { BuildTemplate, SavedBuild, SynergyDefinition, ElementType, GuardianClass, Difficulty, Expansion } from '../types';\r\nimport { errorLog, warnLog } from '../utils/logger';\r\n\r\nclass BuildService {\r\n    // Save a build to IndexedDB and update store\r\n    async saveBuild(template: BuildTemplate, name?: string): Promise<SavedBuild> {\r\n        // Ensure DB is initialized\r\n        await db.init();\r\n\r\n        const build: SavedBuild = {\r\n            id: `build-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n            name: name || template.name,\r\n            template,\r\n            createdAt: Date.now(),\r\n            lastModified: Date.now(),\r\n            tags: [],\r\n        };\r\n\r\n        await db.setSavedBuild(build);\r\n        useSavedBuildsStore.getState().addBuild(build);\r\n        return build;\r\n    }\r\n\r\n    // Load all saved builds from IndexedDB\r\n    async loadSavedBuilds(): Promise<void> {\r\n        useSavedBuildsStore.getState().setLoading(true);\r\n        try {\r\n            const builds = await db.getSavedBuilds();\r\n            useSavedBuildsStore.getState().setBuilds(builds);\r\n        } catch (error) {\r\n            errorLog('Build', 'Failed to load saved builds:', error);\r\n        } finally {\r\n            useSavedBuildsStore.getState().setLoading(false);\r\n        }\r\n    }\r\n\r\n    // Remove a build\r\n    async deleteBuild(id: string): Promise<void> {\r\n        await db.deleteSavedBuild(id);\r\n        useSavedBuildsStore.getState().removeBuild(id);\r\n    }\r\n\r\n    // Convert synergy to build template for equipment\r\n    synergyToTemplate(synergy: SynergyDefinition): BuildTemplate {\r\n        return {\r\n            id: synergy.id,\r\n            name: synergy.name,\r\n            element: synergy.element,\r\n            guardianClass: synergy.guardianClass,\r\n            requiredExpansion: synergy.requiredExpansion,\r\n            exoticWeapon: synergy.exoticWeapon ? {\r\n                hash: synergy.exoticWeapon.hash,\r\n                name: synergy.exoticWeapon.name,\r\n                slot: 1, // Default to energy, will be discovery-corrected if possible\r\n            } : { hash: 0, name: 'None', slot: 0 },\r\n            exoticArmor: synergy.exoticArmor,\r\n            subclassConfig: {\r\n                superHash: synergy.subclassNode.superHash || 0,\r\n                aspects: synergy.subclassNode.aspectHashes,\r\n                fragments: synergy.subclassNode.fragmentHashes || [],\r\n                grenadeHash: synergy.subclassNode.grenadeHash,\r\n                meleeHash: synergy.subclassNode.meleeHash,\r\n                classAbilityHash: synergy.subclassNode.classAbilityHash,\r\n            },\r\n            playstyle: synergy.playstyle,\r\n            difficulty: synergy.difficulty,\r\n            armorMods: modService.suggestMods(synergy.element, synergy.difficulty),\r\n            items: (synergy.recommendedWeapons || []).map(w => ({\r\n                hash: w.hash,\r\n                name: w.name\r\n            }))\r\n        };\r\n    }\r\n\r\n\r\n\r\n    // Equip a Synergy or Build\r\n    async equip(\r\n        build: BuildTemplate | SynergyDefinition,\r\n        characterId: string,\r\n        onProgress?: (step: string, progress: number) => void,\r\n        transferOnly = false\r\n    ): Promise<{ success: boolean; error?: string; equipped?: string[]; failed?: string[]; missing?: string[] }> {\r\n        const template = 'subclassNode' in build ? this.synergyToTemplate(build as SynergyDefinition) : build as BuildTemplate;\r\n        const buildName = template.name || 'Loadout';\r\n\r\n        const result = await transferService.equipBuild(template, characterId, onProgress, transferOnly);\r\n\r\n        if (!result) {\r\n            return { success: false, error: \"Equip failed to starting or returned no results.\" };\r\n        }\r\n\r\n        const missing = result.missing || [];\r\n        const failed = result.failed || [];\r\n        const equipped = result.equipped || [];\r\n\r\n        if (result.success) {\r\n            return { success: true, equipped };\r\n        } else {\r\n            let error = `Failed to equip \"${buildName}\".`;\r\n            if (missing.length > 0) {\r\n                error = `Cannot equip \"${buildName}\" - Missing: ${missing.join(', ')}`;\r\n            } else if (failed.length > 0) {\r\n                error = `\"${buildName}\" partially equipped. Failed items: ${failed.join(', ')}`;\r\n            } else if (result.error) {\r\n                error = result.error;\r\n            }\r\n            return {\r\n                success: false,\r\n                error,\r\n                equipped,\r\n                failed,\r\n                missing\r\n            };\r\n        }\r\n    }\r\n\r\n    // Snapshot current state to in-game loadout slot\r\n    async snapshotToInGameSlot(characterId: string, slotIndex: number): Promise<{ success: boolean; error?: string }> {\r\n        return transferService.snapshotLoadout(characterId, slotIndex);\r\n    }\r\n\r\n    // Capture current character loadout as a BuildTemplate\r\n    async captureLoadout(\r\n        characterId: string,\r\n        name: string,\r\n        onProgress?: (step: string, progress: number) => void,\r\n        fallbackElement?: ElementType\r\n    ): Promise<BuildTemplate | null> {\r\n        onProgress?.('Initializing capture...', 10);\r\n        const state = useProfileStore.getState();\r\n        const equipment = state.characterEquipment[characterId];\r\n\r\n        if (!equipment) return null;\r\n\r\n        onProgress?.('Analyzing equipment...', 20);\r\n\r\n        // 1. Identify Items & Capture Sockets\r\n        const items: BuildTemplate['items'] = [];\r\n        let exoticWeapon: any = { hash: 0, name: 'None', slot: 0 };\r\n        let exoticArmor: any = { hash: 0, name: 'None', slot: 0 };\r\n        let subclassItem: any = null;\r\n        let armorMods: number[] = [];\r\n        let artifactPerks: number[] = [];\r\n\r\n        onProgress?.('Fetching item detail sockets...', 40);\r\n\r\n        // Pre-fetch all sockets in parallel for performance\r\n        const itemSocketPromises = equipment.map(async (item) => {\r\n            if (!item.itemInstanceId) return { item, sockets: [] };\r\n            try {\r\n                const sockets = await profileService.getItemSockets(item.itemInstanceId);\r\n                return { item, sockets };\r\n            } catch (e) {\r\n                warnLog('Build', `Failed to fetch sockets for ${item.itemHash}`, e);\r\n                return { item, sockets: [] };\r\n            }\r\n        });\r\n\r\n        const itemsWithSockets = await Promise.all(itemSocketPromises);\r\n\r\n        onProgress?.('Parsing item configurations and mods...', 60);\r\n\r\n        for (const { item, sockets } of itemsWithSockets) {\r\n            const def = manifestService.getItem(item.itemHash);\r\n            if (!def) continue;\r\n\r\n            const socketOverrides: { [socketIndex: number]: number } = {};\r\n\r\n            // Parse Sockets\r\n            if (sockets && Array.isArray(sockets) && def.sockets) {\r\n                const getSocketCategory = (index: number) => {\r\n                    const cats = def.sockets.socketCategories || (def.sockets as any).categories;\r\n                    return cats?.find((c: any) => c.socketIndexes.includes(index))?.socketCategoryHash;\r\n                };\r\n\r\n                sockets.forEach((socket: any, index: number) => {\r\n                    if (!socket.isEnabled || !socket.plugHash) return;\r\n\r\n                    const catHash = getSocketCategory(index);\r\n                    const plugDef = manifestService.getItem(socket.plugHash);\r\n                    const plugName = plugDef?.name || '';\r\n\r\n                    // Noise Filter: Skip known junk/placeholder plugs\r\n                    const isNoise =\r\n                        plugName.includes('Upgrade Armor') ||\r\n                        plugName.includes('Empty Mod Socket') ||\r\n                        plugName.includes('Empty Socket') ||\r\n                        socket.plugHash === 3696633656;\r\n\r\n                    if (isNoise) return;\r\n\r\n                    // Logic for Armor Mods (DIM Category Check) OR Artifact Perks\r\n                    const isArtifact = def.itemCategoryHashes?.includes(1378222069);\r\n                    const isArmorMod = catHash === SOCKET_CATEGORY_HASHES.ARMOR_MODS ||\r\n                        plugDef?.itemCategoryHashes?.includes(59) ||\r\n                        plugName.includes('Mod');\r\n\r\n                    if (isArmorMod || isArtifact) {\r\n                        armorMods.push(socket.plugHash);\r\n                    }\r\n\r\n                    // Logic for Weapon Perks / Mods\r\n                    if (catHash === SOCKET_CATEGORY_HASHES.WEAPON_PERKS || catHash === SOCKET_CATEGORY_HASHES.WEAPON_MODS) {\r\n                        socketOverrides[index] = socket.plugHash;\r\n                    }\r\n\r\n                    // For Subclass, we capture everything relevant later, but good to have overrides ready\r\n                    if (def.itemType === 16) {\r\n                        socketOverrides[index] = socket.plugHash;\r\n                        // Special check for Transcendence\r\n                        if (catHash === SOCKET_CATEGORY_HASHES.TRANSCENDENCE) {\r\n                            socketOverrides[index] = socket.plugHash;\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n            if (def.itemType === 16) { // Subclass\r\n                subclassItem = { ...item, socketOverrides }; // Attach overrides\r\n            } else if (def.isExotic) { // Exotic\r\n                if (def.itemType === 2) {\r\n                    exoticArmor = { hash: item.itemHash, name: def.name, slot: 2, socketOverrides };\r\n                } else if (def.itemType === 3) {\r\n                    exoticWeapon = { hash: item.itemHash, name: def.name, slot: 1, socketOverrides };\r\n                }\r\n            } else if (def.itemType === 2 || def.itemType === 3) {\r\n                // Legendary Items\r\n                items.push({\r\n                    hash: item.itemHash,\r\n                    name: def.name,\r\n                    socketOverrides // Save the perks!\r\n                });\r\n            }\r\n        }\r\n\r\n        onProgress?.('Extracting subclass nodes...', 80);\r\n\r\n        // 2. Subclass Config Extraction (from the captured overrides)\r\n        const subclassConfig: NonNullable<BuildTemplate['subclassConfig']> = {\r\n            subclassHash: subclassItem?.itemHash || 0,\r\n            superHash: 0,\r\n            aspects: [],\r\n            fragments: [],\r\n            grenadeHash: 0,\r\n            meleeHash: 0,\r\n            classAbilityHash: 0,\r\n            jumpHash: 0\r\n        };\r\n\r\n        if (subclassItem && subclassItem.socketOverrides) {\r\n            const def = manifestService.getItem(subclassItem.itemHash);\r\n            if (def && def.sockets) {\r\n                Object.entries(subclassItem.socketOverrides).forEach(([_indexStr, plugHash]) => {\r\n                    const ph = plugHash as number;\r\n                    const plugDef = manifestService.getRawDefinition('DestinyInventoryItemDefinition', ph);\r\n                    if (!plugDef) return;\r\n\r\n                    const plugCatId = plugDef.plug?.plugCategoryIdentifier || '';\r\n\r\n                    // Use Manifest-based category detection (DIM Standard)\r\n                    if (plugCatId.includes('supers')) subclassConfig.superHash = ph;\r\n                    else if (plugCatId.includes('class_abilities')) subclassConfig.classAbilityHash = ph;\r\n                    else if (plugCatId.includes('grenades')) subclassConfig.grenadeHash = ph;\r\n                    else if (plugCatId.includes('melee')) subclassConfig.meleeHash = ph;\r\n                    else if (plugCatId.includes('movement')) subclassConfig.jumpHash = ph;\r\n                    else if (plugCatId.includes('aspects')) subclassConfig.aspects?.push(ph);\r\n                    else if (plugCatId.includes('fragments')) subclassConfig.fragments?.push(ph);\r\n                });\r\n            }\r\n        }\r\n\r\n        onProgress?.('Capturing artifact perks...', 90);\r\n\r\n        // 2. Artifact Perk Extraction (from progressions)\r\n        const progressions = state.characterProgressions?.[characterId];\r\n        if (progressions?.seasonalArtifact?.tiers) {\r\n            progressions.seasonalArtifact.tiers.forEach(tier => {\r\n                tier.items.forEach(item => {\r\n                    if (item.isActive) {\r\n                        artifactPerks.push(item.itemHash);\r\n                    }\r\n                });\r\n            });\r\n        }\r\n\r\n        // 3. Derive Class & Element\r\n        const character = state.characters.find(c => c.characterId === characterId);\r\n        const guardianClass = character?.classType ?? 0;\r\n\r\n        // 4. Capture Character Stats (Health/Resilience etc.)\r\n        let stats: any = undefined;\r\n        if (character?.stats) {\r\n            stats = {\r\n                mobility: character.stats[STAT_HASHES.MOBILITY] || 0,\r\n                resilience: character.stats[STAT_HASHES.RESILIENCE] || 0,\r\n                recovery: character.stats[STAT_HASHES.RECOVERY] || 0,\r\n                discipline: character.stats[STAT_HASHES.DISCIPLINE] || 0,\r\n                intellect: character.stats[STAT_HASHES.INTELLECT] || 0,\r\n                strength: character.stats[STAT_HASHES.STRENGTH] || 0,\r\n                total: Object.values(character.stats).reduce((a, b) => a + b, 0)\r\n            };\r\n        }\r\n\r\n        const subclassDef = subclassConfig.subclassHash ? manifestService.getItem(subclassConfig.subclassHash) : null;\r\n        let element: ElementType = fallbackElement || 'kinetic';\r\n        if (subclassDef) {\r\n            const damageType = (subclassDef as any).talentGrid?.hudDamageType || subclassDef.defaultDamageType || subclassDef.itemType;\r\n            const damageTypeMap: Record<number, ElementType> = {\r\n                1: 'kinetic',\r\n                2: 'arc',\r\n                3: 'solar',\r\n                4: 'void',\r\n                6: 'stasis',\r\n                7: 'strand'\r\n            };\r\n            const detectedElement = damageTypeMap[damageType];\r\n            if (detectedElement && detectedElement !== 'kinetic') {\r\n                element = detectedElement;\r\n            } else if (detectedElement === 'kinetic' && fallbackElement) {\r\n                element = fallbackElement;\r\n            } else if (!detectedElement) {\r\n                element = 'prismatic';\r\n            }\r\n\r\n            // Special Case: Prismatic Check (Plug Category ID, Name, or Hardcoded Hash)\r\n            const PRISMATIC_HASHES = [2946726027, 2603483315, 3170703816, 3893112950];\r\n\r\n            if (\r\n                PRISMATIC_HASHES.includes(subclassConfig.subclassHash || 0) ||\r\n                (subclassDef as any).plug?.plugCategoryIdentifier?.includes('prismatic') ||\r\n                subclassDef.name?.toLowerCase().includes('prismatic') ||\r\n                subclassDef.itemTypeDisplayName?.toLowerCase().includes('prismatic')\r\n            ) {\r\n                element = 'prismatic';\r\n            }\r\n        }\r\n\r\n        onProgress?.('Build captured!', 100);\r\n\r\n        return {\r\n            id: `captured-${Date.now()}`,\r\n            name,\r\n            element,\r\n            guardianClass,\r\n            requiredExpansion: 0 as unknown as Expansion,\r\n            exoticWeapon,\r\n            exoticArmor,\r\n            subclassConfig,\r\n            items,\r\n            playstyle: 'Captured Loadout',\r\n            difficulty: 'intermediate',\r\n            armorMods,\r\n            artifactPerks,\r\n            stats\r\n        };\r\n    }\r\n\r\n    // Export loadout to DIM-compatible JSON\r\n    exportToJson(build: SavedBuild): string {\r\n        const dimFormat = {\r\n            id: build.id,\r\n            name: build.name,\r\n            classType: build.template.guardianClass,\r\n            clearSpace: false,\r\n            equipped: [\r\n                // Exotics\r\n                { hash: build.template.exoticWeapon?.hash || 0, socketOverrides: {} },\r\n                { hash: build.template.exoticArmor?.hash || 0, socketOverrides: {} },\r\n                // Subclass\r\n                {\r\n                    hash: build.template.subclassConfig?.subclassHash || build.template.subclassConfig?.superHash || 0,\r\n                    socketOverrides: {} // We could map back from config -> socketOverrides but it's complex.\r\n                    // DIM might accept just the hash for the subclass itself?\r\n                },\r\n                // All other items\r\n                ...(build.template.items || []).map(i => ({\r\n                    hash: i.hash || 0,\r\n                    socketOverrides: i.socketOverrides || {}\r\n                }))\r\n            ].filter(i => (i.hash || 0) > 0),\r\n            unequipped: [],\r\n            parameters: {\r\n                mods: build.template.armorMods || [],\r\n                modsByBucket: {},\r\n                exoticArmorHash: build.template.exoticArmor?.hash || 0,\r\n                statConstraints: []\r\n            }\r\n        };\r\n\r\n        return JSON.stringify(dimFormat, null, 2);\r\n    }\r\n\r\n    // Import loadout from DIM JSON\r\n    async importFromJson(jsonString: string): Promise<SavedBuild> {\r\n        const dimLoadout = JSON.parse(jsonString);\r\n\r\n        // Map DIM format to ExoEngine BuildTemplate\r\n        const template: BuildTemplate = {\r\n            id: dimLoadout.id || `imported-${Date.now()}`,\r\n            name: dimLoadout.name || 'Imported Loadout',\r\n            element: 'solar' as ElementType,\r\n            guardianClass: (dimLoadout.classType || 0) as GuardianClass,\r\n            exoticWeapon: {\r\n                hash: dimLoadout.equipped?.[0]?.hash || 0,\r\n                name: 'Unknown',\r\n                slot: 1\r\n            },\r\n            exoticArmor: {\r\n                hash: dimLoadout.parameters?.exoticArmorHash || dimLoadout.equipped?.[1]?.hash || 0,\r\n                name: 'Unknown',\r\n                slot: 3\r\n            },\r\n            subclassConfig: {\r\n                superHash: 0,\r\n                aspects: [],\r\n                fragments: []\r\n            },\r\n            armorMods: dimLoadout.parameters?.mods || [],\r\n            playstyle: 'Imported',\r\n            difficulty: 'intermediate' as Difficulty\r\n        };\r\n\r\n        const build: SavedBuild = {\r\n            id: template.id,\r\n            name: template.name,\r\n            template,\r\n            createdAt: Date.now(),\r\n            lastModified: Date.now(),\r\n            tags: ['imported']\r\n        };\r\n\r\n        await db.setSavedBuild(build);\r\n        useSavedBuildsStore.getState().addBuild(build);\r\n\r\n        return build;\r\n    }\r\n\r\n}\r\n\r\nexport const buildService = new BuildService();\r\n"],"names":["BuildService","template","name","db","build","useSavedBuildsStore","builds","error","errorLog","id","synergy","modService","w","characterId","onProgress","transferOnly","buildName","result","transferService","missing","failed","equipped","slotIndex","fallbackElement","state","useProfileStore","equipment","items","exoticWeapon","exoticArmor","subclassItem","armorMods","artifactPerks","itemSocketPromises","item","sockets","profileService","e","warnLog","itemsWithSockets","def","manifestService","socketOverrides","getSocketCategory","index","c","socket","catHash","plugDef","plugName","isArtifact","SOCKET_CATEGORY_HASHES","subclassConfig","_indexStr","plugHash","ph","plugCatId","progressions","tier","character","guardianClass","stats","STAT_HASHES","a","b","subclassDef","element","damageType","detectedElement","dimFormat","i","jsonString","dimLoadout","buildService"],"mappings":"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"}