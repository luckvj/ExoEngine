{"version":3,"file":"sync.service-DMM3Unrq.js","sources":["../../../../src/services/bungie/sync.service.ts"],"sourcesContent":["import { bungieApi } from './api-client';\r\nimport { db } from '../db/indexeddb.service';\r\nimport { useSavedBuildsStore } from '../../store';\r\nimport type { SavedBuild } from '../../types';\r\nimport { infoLog, errorLog } from '../../utils/logger';\r\n\r\nconst SYNC_KEY = 'exoengine_saved_builds_v1';\r\n\r\nclass SyncService {\r\n    private isSyncing = false;\r\n\r\n    /**\r\n     * Pulls builds from Bungie Cloud and merges with local storage.\r\n     * Uses last-modified-wins conflict resolution.\r\n     */\r\n    async pullFromCloud(): Promise<void> {\r\n        if (this.isSyncing) return;\r\n        this.isSyncing = true;\r\n\r\n        try {\r\n            const cloudData = await bungieApi.getUserApplicationData();\r\n            const cloudBuilds: SavedBuild[] = cloudData[SYNC_KEY] || [];\r\n\r\n            if (cloudBuilds.length === 0) {\r\n                // No builds in cloud - this is normal\r\n                return;\r\n            }\r\n\r\n            const localBuilds = await db.getSavedBuilds();\r\n            const mergedBuilds = this.mergeBuilds(localBuilds, cloudBuilds);\r\n\r\n            // Update local DB and Store\r\n            for (const build of mergedBuilds.toUpdate) {\r\n                await db.setSavedBuild(build);\r\n            }\r\n\r\n            if (mergedBuilds.toUpdate.length > 0) {\r\n                const finalBuilds = await db.getSavedBuilds();\r\n                useSavedBuildsStore.getState().setBuilds(finalBuilds);\r\n                infoLog('Sync', `Pulled ${mergedBuilds.toUpdate.length} updates from cloud.`);\r\n            }\r\n\r\n            // If we have local changes that weren't in cloud, push back\r\n            if (mergedBuilds.requiresPush) {\r\n                await this.pushToCloud();\r\n            }\r\n        } catch (error: any) {\r\n            // Silently ignore 404s - cloud data may not exist for this user or the endpoint may not be available\r\n            if (error?.message?.includes('404') || error?.message?.includes('not valid JSON')) {\r\n                // Expected for new users or when endpoint is unavailable\r\n                return;\r\n            }\r\n            errorLog('Sync', 'Pull failed:', error);\r\n        } finally {\r\n            this.isSyncing = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Pushes all local builds to Bungie Cloud.\r\n     */\r\n    async pushToCloud(): Promise<void> {\r\n        try {\r\n            const localBuilds = await db.getSavedBuilds();\r\n            const cloudData = await bungieApi.getUserApplicationData();\r\n\r\n            cloudData[SYNC_KEY] = localBuilds;\r\n            await bungieApi.setUserApplicationData(cloudData);\r\n\r\n            infoLog('Sync', `Pushed ${localBuilds.length} builds to cloud.`);\r\n        } catch (error) {\r\n            errorLog('Sync', 'Push failed:', error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Merges two sets of builds based on lastModified timestamp.\r\n     */\r\n    private mergeBuilds(local: SavedBuild[], cloud: SavedBuild[]): {\r\n        toUpdate: SavedBuild[],\r\n        requiresPush: boolean\r\n    } {\r\n        const toUpdate: SavedBuild[] = [];\r\n        let requiresPush = false;\r\n\r\n        const localMap = new Map(local.map(b => [b.id, b]));\r\n        const cloudMap = new Map(cloud.map(b => [b.id, b]));\r\n\r\n        // Process all cloud builds\r\n        for (const cloudBuild of cloud) {\r\n            const localBuild = localMap.get(cloudBuild.id);\r\n\r\n            if (!localBuild) {\r\n                // New build from cloud\r\n                toUpdate.push(cloudBuild);\r\n            } else if ((cloudBuild.lastModified || 0) > (localBuild.lastModified || 0)) {\r\n                // Cloud build is newer\r\n                toUpdate.push(cloudBuild);\r\n            } else if ((localBuild.lastModified || 0) > (cloudBuild.lastModified || 0)) {\r\n                // Local build is newer, needs push\r\n                requiresPush = true;\r\n            }\r\n        }\r\n\r\n        // Check for local builds not in cloud\r\n        for (const localBuild of local) {\r\n            if (!cloudMap.has(localBuild.id)) {\r\n                requiresPush = true;\r\n            }\r\n        }\r\n\r\n        return { toUpdate, requiresPush };\r\n    }\r\n\r\n    /**\r\n     * Start a periodic sync heartbeat\r\n     */\r\n    startHeartbeat(intervalMs = 5 * 60 * 1000): void {\r\n        setInterval(() => {\r\n            this.pullFromCloud().catch(err => errorLog('Sync', 'Heartbeat pull failed:', err));\r\n        }, intervalMs);\r\n    }\r\n}\r\n\r\nexport const syncService = new SyncService();\r\n"],"names":["SYNC_KEY","SyncService","cloudBuilds","bungieApi","localBuilds","db","mergedBuilds","build","finalBuilds","useSavedBuildsStore","infoLog","error","errorLog","cloudData","local","cloud","toUpdate","requiresPush","localMap","b","cloudMap","cloudBuild","localBuild","intervalMs","err","syncService"],"mappings":"4LAMA,MAAMA,EAAW,4BAEjB,MAAMC,CAAY,CACN,UAAY,GAMpB,MAAM,eAA+B,CACjC,GAAI,MAAK,UACT,MAAK,UAAY,GAEjB,GAAI,CAEA,MAAMC,GADY,MAAMC,EAAU,uBAAA,GACUH,CAAQ,GAAK,CAAA,EAEzD,GAAIE,EAAY,SAAW,EAEvB,OAGJ,MAAME,EAAc,MAAMC,EAAG,eAAA,EACvBC,EAAe,KAAK,YAAYF,EAAaF,CAAW,EAG9D,UAAWK,KAASD,EAAa,SAC7B,MAAMD,EAAG,cAAcE,CAAK,EAGhC,GAAID,EAAa,SAAS,OAAS,EAAG,CAClC,MAAME,EAAc,MAAMH,EAAG,eAAA,EAC7BI,EAAoB,SAAA,EAAW,UAAUD,CAAW,EACpDE,EAAQ,OAAQ,UAAUJ,EAAa,SAAS,MAAM,sBAAsB,CAChF,CAGIA,EAAa,cACb,MAAM,KAAK,YAAA,CAEnB,OAASK,EAAY,CAEjB,GAAIA,GAAO,SAAS,SAAS,KAAK,GAAKA,GAAO,SAAS,SAAS,gBAAgB,EAE5E,OAEJC,EAAS,OAAQ,eAAgBD,CAAK,CAC1C,QAAA,CACI,KAAK,UAAY,EACrB,EACJ,CAKA,MAAM,aAA6B,CAC/B,GAAI,CACA,MAAMP,EAAc,MAAMC,EAAG,eAAA,EACvBQ,EAAY,MAAMV,EAAU,uBAAA,EAElCU,EAAUb,CAAQ,EAAII,EACtB,MAAMD,EAAU,uBAAuBU,CAAS,EAEhDH,EAAQ,OAAQ,UAAUN,EAAY,MAAM,mBAAmB,CACnE,OAASO,EAAO,CACZC,EAAS,OAAQ,eAAgBD,CAAK,CAC1C,CACJ,CAKQ,YAAYG,EAAqBC,EAGvC,CACE,MAAMC,EAAyB,CAAA,EAC/B,IAAIC,EAAe,GAEnB,MAAMC,EAAW,IAAI,IAAIJ,EAAM,IAAIK,GAAK,CAACA,EAAE,GAAIA,CAAC,CAAC,CAAC,EAC5CC,EAAW,IAAI,IAAIL,EAAM,IAAII,GAAK,CAACA,EAAE,GAAIA,CAAC,CAAC,CAAC,EAGlD,UAAWE,KAAcN,EAAO,CAC5B,MAAMO,EAAaJ,EAAS,IAAIG,EAAW,EAAE,EAExCC,GAGOD,EAAW,cAAgB,IAAMC,EAAW,cAAgB,GAEpEN,EAAS,KAAKK,CAAU,GAChBC,EAAW,cAAgB,IAAMD,EAAW,cAAgB,KAEpEJ,EAAe,IANfD,EAAS,KAAKK,CAAU,CAQhC,CAGA,UAAWC,KAAcR,EAChBM,EAAS,IAAIE,EAAW,EAAE,IAC3BL,EAAe,IAIvB,MAAO,CAAE,SAAAD,EAAU,aAAAC,CAAA,CACvB,CAKA,eAAeM,EAAa,IAAS,IAAY,CAC7C,YAAY,IAAM,CACd,KAAK,gBAAgB,MAAMC,GAAOZ,EAAS,OAAQ,yBAA0BY,CAAG,CAAC,CACrF,EAAGD,CAAU,CACjB,CACJ,CAEO,MAAME,EAAc,IAAIxB"}