{"version":3,"mappings":"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","names":["TARGET_STATS","StatsPanel","stats","subclassElement","synergyElement","displayStats","setDisplayStats","useState","hoveredStat","setHoveredStat","tooltipPosition","setTooltipPosition","useEffect","result","targetName","found","manifestService","label","value","icon","description","BUNGIE_CONFIG","elementColors","activeElement","barColor","handleStatMouseEnter","stat","e","rect","handleStatMouseLeave","jsxs","jsx","VaultSearch","onSearch","selectedElement","onSelectElement","selectedClass","onSelectClass","onClose","query","setQuery","isLoaded","useManifestStore","elementIcons","setElementIcons","classIcons","setClassIcons","TitanLogo","HunterLogo","WarlockLogo","elements","ElementType","classes","icons","type","prismatic","sub","fetchNodeIcon","name","fallback","handleChange","cls","getBungieUrl","elem","CharacterScreen","synergyFilter","vaultSearchQuery","setVaultSearchQuery","isVaultSearchVisible","setIsVaultSearchVisible","activeSynergyElement","setActiveSynergyElement","viewMode","setViewMode","vaultElementFilter","setVaultElementFilter","vaultClassFilter","setVaultClassFilter","isSynergyOverlayOpen","setIsSynergyOverlayOpen","activeSynergy","setActiveSynergy","isEquipping","setIsEquipping","forceCloseOverlayTrigger","setForceCloseOverlayTrigger","equipProgress","setEquipProgress","galaxyResetRef","useRef","handleGalaxyRefresh","profileLoader","selectedCharacterId","characterEquipment","itemInstances","useProfileStore","hideGlobalUI","useUIStore","toast","useToast","screenRef","equipment","useMemo","calculateCharacterStats","equippedSubclass","subclassItem","item","hash","color","handleEquipBuild","prev","buildService","step","progress","handleKeyDown","activeEl","newState","SynergyGalaxy","isOpen","synergy","SYNERGY_DEFINITIONS","__vitePreload","n","synergyDef","s","weaponName","armorName","makePickerItem","AbilityPicker","items","columns","onSelect","element","equippedHash","style","ref","hoveredHash","setHoveredHash","handleClickOutside","handleEscape","timer","index","iconUrl","isEquipped","isHovered","RichTooltip","CLASS_NAMES","makeAbilityItem","resolveIcon","def","fallbackIcon","raw","categorizeEquippedSockets","sockets","subclassDef","HASH_TO_GROUP","cat","group","socketIndex","socket","plugHash","specificGroup","plugCat","getAvailableForSocket","subclassItemHash","excludedHashes","rawDef","socketEntry","plugSetHash","p","a","b","aEmpty","bEmpty","SubclassScreen","propSubclassHash","propInstanceId","onBack","characterInventories","characters","vaultInventory","manifestLoaded","socketLockRef","openPicker","setOpenPicker","hoveredSlot","setHoveredSlot","equipping","setEquipping","optimisticOverrides","setOptimisticOverrides","parallax","setParallax","uiVisible","setUiVisible","showLore","setShowLore","isMoving","setIsMoving","v","handleEquipSubclass","togglePicker","useCallback","id","handleMouseMove","inventory","classType","c","className","eq","i","inv","getEquippedItem","BUCKET_HASHES","transferService","createMoveSession","error","subclassHash","subclassName","realSockets","socketIdx","equipped","allFragments","handleEquip","previousPlugHash","vaultItem","r","next","config","h","f","backgroundImage","buckets","it","d","superId","superAvail","SubclassNode","CommonSlot","sorted","_b","padded","hashes","max","FALLBACK","st","sd","equippedFragments","categoryId","indexInCat","nodeType","customLabel","pickerColumns","pickerAlign","size","pickerId","slotId","avail","BuilderPage","useLocation","builderView","builderSubView","setBuilderView","hoveredSubclass","setHoveredSubclass","activeSubclass","setActiveSubclass","handleSubclassClick","itemHash","itemInstanceId","handleSubclassDataReady","subclass","instance","TooltipProvider","BuilderContainer"],"ignoreList":[],"sources":["../../../../src/components/builder/StatsPanel.tsx","../../../../src/components/builder/VaultSearch.tsx","../../../../src/components/builder/CharacterScreen.tsx","../../../../src/components/builder/AbilityPicker.tsx","../../../../src/components/builder/SubclassScreen.tsx","../../../../src/pages/BuilderPage.tsx"],"sourcesContent":["import { useEffect, useState } from 'react';\r\nimport type { ArmorStats } from '../../types';\r\nimport { BUNGIE_CONFIG } from '../../config/bungie.config';\r\nimport { manifestService } from '../../services/bungie/manifest.service';\r\nimport './StatsPanel.css';\r\n\r\ninterface StatsPanelProps {\r\n  stats: ArmorStats;\r\n  subclassElement?: string; // 'solar', 'arc', 'void', 'stasis', 'strand', 'prismatic'\r\n  synergyElement?: string | null;\r\n}\r\n\r\ninterface StatDisplay {\r\n  key: string;\r\n  label: string;\r\n  value: number;\r\n  icon?: string;\r\n  description?: string;\r\n}\r\n\r\n// User requested specific stat list for \"Edge of Fate\"\r\nconst TARGET_STATS = [\r\n  'Health',\r\n  'Melee',\r\n  'Grenade',\r\n  'Super',\r\n  'Class',\r\n  'Weapons'\r\n];\r\n\r\nexport function StatsPanel({ stats, subclassElement, synergyElement }: StatsPanelProps) {\r\n  const [displayStats, setDisplayStats] = useState<StatDisplay[]>([]);\r\n  const [hoveredStat, setHoveredStat] = useState<StatDisplay | null>(null);\r\n  const [tooltipPosition, setTooltipPosition] = useState<{ x: number; y: number } | null>(null);\r\n\r\n  useEffect(() => {\r\n    const loadStats = () => {\r\n      const result: StatDisplay[] = [];\r\n\r\n      TARGET_STATS.forEach(targetName => {\r\n        // 1. Try to find the stat by name in the manifest (Edge of Fate new stats)\r\n        const found = manifestService.searchStatByName(targetName);\r\n\r\n        let label = targetName;\r\n        let value = 0;\r\n        let icon: string | undefined = undefined;\r\n        let description: string | undefined = undefined;\r\n\r\n        if (found) {\r\n          description = found.description;\r\n          icon = found.icon ? `${BUNGIE_CONFIG.bungieNetOrigin}${found.icon}` : undefined;\r\n\r\n          // Map the new stat names to traditional stat values\r\n          switch (targetName) {\r\n            case 'Health': value = stats.resilience; break;\r\n            case 'Melee': value = stats.strength; break;\r\n            case 'Grenade': value = stats.discipline; break;\r\n            case 'Super': value = stats.intellect; break;\r\n            case 'Class': value = stats.recovery; break;\r\n            case 'Weapons': value = stats.mobility; break;\r\n          }\r\n        }\r\n\r\n        result.push({ key: targetName, label, value, icon, description });\r\n      });\r\n\r\n      setDisplayStats(result);\r\n    };\r\n\r\n    loadStats();\r\n  }, [stats]);\r\n\r\n  const elementColors: Record<string, string> = {\r\n    solar: '#f0631e',\r\n    arc: '#7df9ff',\r\n    void: '#bf84ff',\r\n    stasis: '#4d88ff',\r\n    strand: '#4aff9b',\r\n    prismatic: '#ff8df6'\r\n  };\r\n\r\n  // Priority: synergyElement > subclassElement > white default\r\n  const activeElement = synergyElement || subclassElement || null;\r\n  const barColor = activeElement ? (elementColors[activeElement.toLowerCase()] || '#ffffff') : '#ffffff';\r\n\r\n  const handleStatMouseEnter = (stat: StatDisplay, e: React.MouseEvent) => {\r\n    if (!stat.description) return;\r\n    setHoveredStat(stat);\r\n    const rect = (e.currentTarget as HTMLElement).getBoundingClientRect();\r\n    setTooltipPosition({\r\n      x: rect.left + rect.width / 2,\r\n      y: rect.top - 8\r\n    });\r\n  };\r\n\r\n  const handleStatMouseLeave = () => {\r\n    setHoveredStat(null);\r\n    setTooltipPosition(null);\r\n  };\r\n\r\n  return (\r\n    <div className=\"stats-panel\">\r\n      {displayStats.map((stat) => (\r\n        <div\r\n          key={stat.key}\r\n          className=\"stats-panel__row\"\r\n          onMouseEnter={(e) => handleStatMouseEnter(stat, e)}\r\n          onMouseLeave={handleStatMouseLeave}\r\n        >\r\n          {stat.icon ? (\r\n            <img src={stat.icon} alt={stat.label} className=\"stats-panel__icon-img\" />\r\n          ) : (\r\n            <div className=\"stats-panel__icon-placeholder\" />\r\n          )}\r\n          <div className=\"stats-panel__bar-outer\">\r\n            <div\r\n              className=\"stats-panel__bar-inner\"\r\n              style={{\r\n                width: `${Math.min((stat.value / 200) * 100, 100)}%`,\r\n                backgroundColor: barColor,\r\n                boxShadow: `0 0 8px ${barColor}80`\r\n              }}\r\n            />\r\n            {/* Tier marker at 100 */}\r\n            <div className=\"stats-panel__bar-tier-marker\" />\r\n          </div>\r\n          <span className=\"stats-panel__value\">{stat.value}</span>\r\n        </div>\r\n      ))}\r\n\r\n      {/* Rich tooltip with Bungie description */}\r\n      {hoveredStat && tooltipPosition && hoveredStat.description && (\r\n        <div\r\n          className=\"stats-panel__tooltip\"\r\n          style={{\r\n            position: 'fixed',\r\n            left: `${tooltipPosition.x}px`,\r\n            top: `${tooltipPosition.y}px`,\r\n            transform: 'translate(-50%, -100%)',\r\n            pointerEvents: 'none',\r\n            zIndex: 100001\r\n          }}\r\n        >\r\n          <div className=\"stats-panel__tooltip-wrapper\">\r\n            <div className=\"stats-panel__tooltip-header\">\r\n              <div className=\"stats-panel__tooltip-header-content\">\r\n                {hoveredStat.icon && (\r\n                  <img\r\n                    src={hoveredStat.icon}\r\n                    alt=\"\"\r\n                    className=\"stats-panel__tooltip-icon\"\r\n                  />\r\n                )}\r\n                <span className=\"stats-panel__tooltip-name\">{hoveredStat.label}</span>\r\n              </div>\r\n            </div>\r\n            <div className=\"stats-panel__tooltip-main\">\r\n              <div className=\"stats-panel__tooltip-description\">\r\n                {hoveredStat.description}\r\n              </div>\r\n            </div>\r\n            <div className=\"stats-panel__tooltip-footer\">\r\n              <div className=\"stats-panel__tooltip-stat-value\">\r\n                {hoveredStat.value}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","import { useState, useEffect } from 'react';\r\nimport { ElementType } from '../../types';\r\nimport { manifestService } from '../../services/bungie/manifest.service';\r\nimport { getBungieUrl } from '../../utils/url-helper';\r\nimport { useManifestStore } from '../../store';\r\nimport TitanLogo from '../../assets/logos/titan.png';\r\nimport HunterLogo from '../../assets/logos/hunter.png';\r\nimport WarlockLogo from '../../assets/logos/warlock.png';\r\nimport './VaultSearch.css';\r\n\r\ninterface VaultSearchProps {\r\n    onSearch: (query: string) => void;\r\n    selectedElement: string;\r\n    onSelectElement: (element: string) => void;\r\n    selectedClass: string;\r\n    onSelectClass: (cls: string) => void;\r\n    onClose?: () => void;\r\n}\r\n\r\nexport function VaultSearch({\r\n    onSearch,\r\n    selectedElement,\r\n    onSelectElement,\r\n    selectedClass,\r\n    onSelectClass,\r\n    onClose\r\n}: VaultSearchProps) {\r\n    const [query, setQuery] = useState('');\r\n    const { isLoaded } = useManifestStore();\r\n    const [elementIcons, setElementIcons] = useState<Record<string, string>>({});\r\n    const [classIcons, setClassIcons] = useState<Record<string, string>>({\r\n        'titan': TitanLogo,\r\n        'hunter': HunterLogo,\r\n        'warlock': WarlockLogo\r\n    });\r\n\r\n    const elements = [\r\n        'all',\r\n        ElementType.Solar,\r\n        ElementType.Void,\r\n        ElementType.Arc,\r\n        ElementType.Stasis,\r\n        ElementType.Strand,\r\n        ElementType.Prismatic\r\n    ];\r\n\r\n    const classes = [\r\n        'titan',\r\n        'hunter',\r\n        'warlock'\r\n    ];\r\n\r\n    useEffect(() => {\r\n        if (!isLoaded) return;\r\n\r\n        // Load Element Icons\r\n        const icons: Record<string, string> = {\r\n            'all': manifestService.getDamageTypeIcon('kinetic') || ''\r\n        };\r\n\r\n        elements.forEach(type => {\r\n            if (type !== 'all') {\r\n                const icon = manifestService.getDamageTypeIcon(type as any);\r\n                if (icon) icons[type] = icon;\r\n\r\n                // Special handling for prismatic icon if needed\r\n                if (type === ElementType.Prismatic) {\r\n                    const allSubclasses = manifestService.getAllSubclassComponents();\r\n                    const prismatic = allSubclasses.find(sub => sub.name.toLowerCase().includes('prismatic'));\r\n                    if (prismatic?.icon) icons[type] = prismatic.icon;\r\n                }\r\n            }\r\n        });\r\n        setElementIcons(icons);\r\n\r\n        // Load Class Icons\r\n        const fetchNodeIcon = (name: string, fallback: string) => {\r\n            const node = manifestService.searchPresentationNodeByName(name, true);\r\n            return node?.icon || fallback;\r\n        };\r\n\r\n        setClassIcons({\r\n            'titan': fetchNodeIcon(\"Titan\", TitanLogo),\r\n            'hunter': fetchNodeIcon(\"Hunter\", HunterLogo),\r\n            'warlock': fetchNodeIcon(\"Warlock\", WarlockLogo)\r\n        });\r\n\r\n    }, [isLoaded]);\r\n\r\n    const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const value = e.target.value;\r\n        setQuery(value);\r\n        onSearch(value);\r\n    };\r\n\r\n    return (\r\n        <div\r\n            className=\"vault-search-container\"\r\n            onMouseDown={(e) => e.stopPropagation()}\r\n            onClick={(e) => e.stopPropagation()}\r\n        >\r\n            <div className=\"vault-search-bar\">\r\n                <input\r\n                    id=\"vault-search-input\"\r\n                    name=\"vault-search-input\"\r\n                    type=\"text\"\r\n                    placeholder=\"Search vault...\"\r\n                    value={query}\r\n                    onChange={handleChange}\r\n                    onKeyDown={(e) => {\r\n                        if (e.key === 'Escape') {\r\n                            onClose?.();\r\n                        }\r\n                    }}\r\n                    className=\"vault-search\"\r\n                    autoFocus\r\n                />\r\n                <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n                    <circle cx=\"11\" cy=\"11\" r=\"8\" />\r\n                    <line x1=\"21\" y1=\"21\" x2=\"16.65\" y2=\"16.65\" />\r\n                </svg>\r\n            </div>\r\n\r\n            <div className=\"vault-filters\">\r\n                <div className=\"vault-filter-group\">\r\n                    {classes.map(cls => (\r\n                        <button\r\n                            key={cls}\r\n                            className={`vault-filter-btn ${selectedClass === cls ? 'active' : ''}`}\r\n                            onClick={() => onSelectClass(selectedClass === cls ? 'all' : cls)}\r\n                            title={cls.toUpperCase()}\r\n                        >\r\n                            <img\r\n                                src={classIcons[cls].startsWith('/') ? getBungieUrl(classIcons[cls]) : classIcons[cls]}\r\n                                alt={cls}\r\n                                className=\"vault-filter-icon\"\r\n                            />\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n\r\n                <div className=\"vault-filter-divider\" />\r\n\r\n                <div className=\"vault-filter-group\">\r\n                    {elements.map(elem => (\r\n                        <button\r\n                            key={elem}\r\n                            className={`vault-filter-btn element-${elem} ${selectedElement === elem ? 'active' : ''}`}\r\n                            onClick={() => onSelectElement(selectedElement === elem ? 'all' : elem)}\r\n                            title={elem.toUpperCase()}\r\n                        >\r\n                            {elementIcons[elem] && (\r\n                                <img src={getBungieUrl(elementIcons[elem])} alt={elem} className=\"vault-filter-icon\" />\r\n                            )}\r\n                        </button>\r\n                    ))}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","import { useMemo, useRef, useEffect, useState } from 'react';\r\nimport { useProfileStore, useUIStore } from '../../store';\r\nimport { StatsPanel } from './StatsPanel';\r\nimport {\r\n  calculateCharacterStats,\r\n} from '../../utils/character-helpers';\r\nimport { SynergyGalaxy } from '../synergy/SynergyGalaxy';\r\nimport { VaultSearch } from './VaultSearch';\r\nimport { buildService } from '../../services/build.service';\r\nimport { profileLoader } from '../../services/bungie/profile.service';\r\nimport { useToast } from '../common/Toast';\r\nimport './CharacterScreen.css';\r\n\r\ninterface CharacterScreenProps {\r\n  activeSubclass?: { item: any; instance: any } | null;\r\n  synergyFilter?: {\r\n    weaponName?: string;\r\n    armorName?: string;\r\n    element?: string;\r\n    buildName?: string;\r\n  };\r\n}\r\n\r\nexport function CharacterScreen({ synergyFilter }: CharacterScreenProps = {}) {\r\n  const [vaultSearchQuery, setVaultSearchQuery] = useState('');\r\n  const [isVaultSearchVisible, setIsVaultSearchVisible] = useState(false);\r\n  const [activeSynergyElement, setActiveSynergyElement] = useState<string | null>(null);\r\n  const [viewMode, setViewMode] = useState<'all' | 'subclass-only' | 'inventory-only'>('all');\r\n  const [vaultElementFilter, setVaultElementFilter] = useState<string>('all');\r\n  const [vaultClassFilter, setVaultClassFilter] = useState<string>('all');\r\n  const [isSynergyOverlayOpen, setIsSynergyOverlayOpen] = useState(false);\r\n  const [activeSynergy, setActiveSynergy] = useState<any>(null);\r\n  const [isEquipping, setIsEquipping] = useState(false);\r\n  // Add force close trigger to handle child overlay state\r\n  const [forceCloseOverlayTrigger, setForceCloseOverlayTrigger] = useState(0);\r\n  const [equipProgress, setEquipProgress] = useState<string>('');\r\n  // Ref to call SynergyGalaxy's reset function directly\r\n  const galaxyResetRef = useRef<(() => void) | null>(null);\r\n\r\n  // Listen for galaxy-refresh events from the navigation tab\r\n  useEffect(() => {\r\n    const handleGalaxyRefresh = () => {\r\n      // 1. Reset the galaxy view (camera, etc)\r\n      if (galaxyResetRef.current) {\r\n        galaxyResetRef.current();\r\n      }\r\n\r\n      // 2. FORCE REFRESH Profile from Bungie (DIM-Parity)\r\n      profileLoader.loadProfile(true);\r\n    };\r\n\r\n    window.addEventListener('galaxy-refresh', handleGalaxyRefresh);\r\n    return () => window.removeEventListener('galaxy-refresh', handleGalaxyRefresh);\r\n  }, []);\r\n\r\n  const {\r\n    selectedCharacterId,\r\n    characterEquipment,\r\n    itemInstances,\r\n  } = useProfileStore();\r\n  const { hideGlobalUI } = useUIStore();\r\n  const toast = useToast();\r\n  const screenRef = useRef<HTMLDivElement>(null);\r\n  const equipment = characterEquipment[selectedCharacterId || ''] || [];\r\n\r\n  const stats = useMemo(() => calculateCharacterStats(equipment, itemInstances), [equipment, itemInstances]);\r\n\r\n  // Get equipped subclass element\r\n  const equippedSubclass = useMemo((): string | undefined => {\r\n    const subclassItem = equipment.find(item => {\r\n      // Check if this is a subclass by bucket hash (would need manifest lookup)\r\n      // For now, we'll use known subclass hashes\r\n      const SUBCLASS_HASHES = [\r\n        3893112950, 4282591831, 1616346845, // Prismatic\r\n        3941205951, 2550323932, 2453351420, // Solar\r\n        3168997075, 2328211300, 2932390913, // Arc  \r\n        3382391785, 2842471112, 2842471119, // Void\r\n        3291545503, 873720784, 613647804,   // Stasis\r\n        242419885, 3785442599, 3948463201   // Strand\r\n      ];\r\n      return SUBCLASS_HASHES.includes(item.itemHash);\r\n    });\r\n\r\n    if (!subclassItem) {\r\n      return undefined;\r\n    }\r\n\r\n    // Map subclass hashes to elements\r\n    const hash = subclassItem.itemHash;\r\n\r\n    if ([3893112950, 4282591831, 1616346845].includes(hash)) return 'prismatic';\r\n    if ([3941205951, 2550323932, 2453351420].includes(hash)) return 'solar';\r\n    if ([3168997075, 2328211300, 2932390913].includes(hash)) return 'arc';\r\n    if ([3382391785, 2842471112, 2842471119].includes(hash)) return 'void';\r\n    if ([3291545503, 873720784, 613647804].includes(hash)) return 'stasis';\r\n    if ([242419885, 3785442599, 3948463201].includes(hash)) return 'strand';\r\n\r\n    return undefined;\r\n  }, [equipment]);\r\n\r\n  // Set global CSS variables for dynamic tooltip colors\r\n  useEffect(() => {\r\n    const elementColors: Record<string, string> = {\r\n      solar: '#f0631e',\r\n      arc: '#7df9ff',\r\n      void: '#bf84ff',\r\n      stasis: '#4d88ff',\r\n      strand: '#4aff9b',\r\n      prismatic: '#ff8df6'\r\n    };\r\n\r\n    const color = equippedSubclass ? elementColors[equippedSubclass.toLowerCase()] : undefined;\r\n    if (color) {\r\n      document.documentElement.style.setProperty('--tooltip-element-color', color);\r\n    }\r\n  }, [equippedSubclass]);\r\n\r\n  // Handle equipping the active active synergy build\r\n  const handleEquipBuild = async () => {\r\n    if (isEquipping || !activeSynergy || !selectedCharacterId) return;\r\n\r\n    setIsEquipping(true);\r\n    setIsSynergyOverlayOpen(false); // Close overlay immediately\r\n    setForceCloseOverlayTrigger(prev => prev + 1); // Signal child to close\r\n    setEquipProgress('Preparing build...');\r\n\r\n    try {\r\n      const result = await buildService.equip(\r\n        activeSynergy,\r\n        selectedCharacterId,\r\n        (step: string, progress: number) => {\r\n          setEquipProgress(`${step} (${Math.round(progress)}%)`);\r\n        }\r\n      );\r\n\r\n      if (result.success) {\r\n        toast.success(`Successfully equipped ${activeSynergy.name || 'build'}!`);\r\n        setEquipProgress('');\r\n        // PULL BACK TO ORBIT: Reset view mode to 'all'\r\n        setViewMode('all');\r\n      } else {\r\n        toast.error(result.error || 'Failed to equip build');\r\n        setEquipProgress('');\r\n      }\r\n    } catch (error) {\r\n      toast.error('Failed to equip build. Please try again.');\r\n      setEquipProgress('');\r\n    } finally {\r\n      setIsEquipping(false);\r\n    }\r\n  };\r\n\r\n  // Keyboard shortcuts for view modes\r\n  useEffect(() => {\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      const activeEl = document.activeElement;\r\n      const isTyping = activeEl && (\r\n        activeEl.tagName === 'INPUT' ||\r\n        activeEl.tagName === 'TEXTAREA' ||\r\n        (activeEl as HTMLElement).isContentEditable\r\n      );\r\n\r\n      if (isTyping) return;\r\n\r\n      // Toggle Inventory-only view with 'I' key\r\n      if (e.key.toLowerCase() === 'i') {\r\n        setViewMode(prev => prev === 'inventory-only' ? 'all' : 'inventory-only');\r\n      }\r\n\r\n      // Toggle Vault Search with 'V' key\r\n      if (e.key.toLowerCase() === 'v') {\r\n        e.preventDefault();\r\n        setIsVaultSearchVisible(prev => {\r\n          const newState = !prev;\r\n          if (!newState) {\r\n            setVaultSearchQuery('');\r\n            setVaultElementFilter('all');\r\n            setVaultClassFilter('all');\r\n          }\r\n          return newState;\r\n        });\r\n      }\r\n\r\n      // Toggle Subclass-only view with 'J' key\r\n      if (e.key.toLowerCase() === 'j') {\r\n        setViewMode(prev => prev === 'subclass-only' ? 'all' : 'subclass-only');\r\n      }\r\n\r\n      // Equip active build with 'F' key (only if overlay is open)\r\n      if (e.key.toLowerCase() === 'f' && isSynergyOverlayOpen) {\r\n        handleEquipBuild();\r\n      }\r\n\r\n      // Close vault search with Escape if search is open (but keep the query)\r\n      if (e.key === 'Escape' && isVaultSearchVisible) {\r\n        setIsVaultSearchVisible(false);\r\n        // Don't clear query - keep it so it shows again when pressing V\r\n      }\r\n\r\n      // Reset view mode with Escape\r\n      if (e.key === 'Escape' && viewMode !== 'all') {\r\n        setViewMode('all');\r\n      }\r\n    };\r\n\r\n    window.addEventListener('keydown', handleKeyDown);\r\n    return () => window.removeEventListener('keydown', handleKeyDown);\r\n  }, [isVaultSearchVisible, viewMode, activeSynergy, isSynergyOverlayOpen, isEquipping, selectedCharacterId]);\r\n\r\n  // Auto-focus on mount so keyboard events work immediately\r\n  useEffect(() => {\r\n    screenRef.current?.focus();\r\n  }, []);\r\n\r\n  return (\r\n    <div\r\n      ref={screenRef}\r\n      className=\"character-screen animate-fade-in\"\r\n      style={{ position: 'relative' }}\r\n      tabIndex={0}\r\n    >\r\n      {/* Vault Search Bar (Initially Hidden) */}\r\n      {isVaultSearchVisible && (\r\n        <VaultSearch\r\n          onSearch={setVaultSearchQuery}\r\n          selectedElement={vaultElementFilter}\r\n          onSelectElement={setVaultElementFilter}\r\n          selectedClass={vaultClassFilter}\r\n          onSelectClass={setVaultClassFilter}\r\n          onClose={() => setIsVaultSearchVisible(false)}\r\n        />\r\n      )}\r\n\r\n      {/* New 3D Synergy Galaxy Environment */}\r\n      <SynergyGalaxy\r\n        searchQuery={vaultSearchQuery}\r\n        elementFilter={vaultElementFilter}\r\n        classFilter={vaultClassFilter}\r\n        isVaultSearchVisible={isVaultSearchVisible}\r\n        onSynergyElementChange={setActiveSynergyElement}\r\n        viewMode={viewMode}\r\n        synergyFilter={synergyFilter}\r\n        onSynergyOverlayChange={(isOpen, synergy) => {\r\n          setIsSynergyOverlayOpen(isOpen);\r\n          setActiveSynergy(synergy);\r\n        }}\r\n        onResetView={() => setViewMode('all')}\r\n        forceCloseTrigger={forceCloseOverlayTrigger}\r\n        resetViewRef={galaxyResetRef}\r\n      />\r\n\r\n      {/* Stats and Info Overlay Layer */}\r\n      <div\r\n        className=\"character-screen__overlay\"\r\n        style={{\r\n          opacity: hideGlobalUI ? 0 : 1,\r\n          transition: 'opacity 0.3s ease-out'\r\n        }}\r\n      >\r\n        <div className=\"character-screen__left-info\">\r\n          <StatsPanel\r\n            stats={stats}\r\n            subclassElement={equippedSubclass}\r\n            synergyElement={activeSynergyElement}\r\n          />\r\n        </div>\r\n\r\n        <div className=\"character-screen__right-info\">\r\n          {/* Synergy Detail Panel Removed per User Request */}\r\n        </div>\r\n\r\n      </div>\r\n\r\n      {/* Bottom Control Bar */}\r\n      <div className=\"character-screen__footer\">\r\n        <div className=\"character-screen__footer-left\">\r\n          <div\r\n            className=\"character-screen__control-item character-screen__control-item--clickable\"\r\n            onClick={() => {\r\n              // Dispatch ESC key event to trigger reset view in SynergyGalaxy\r\n              window.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape', bubbles: true }));\r\n            }}\r\n          >\r\n            <div className=\"character-screen__control-key\">ESC</div>\r\n            <span>Back to Orbit</span>\r\n          </div>\r\n          <div className=\"character-screen__control-item\" style={{ marginLeft: '12px' }}>\r\n            <div style={{ display: 'flex', gap: '2px' }}>\r\n              <div className=\"character-screen__control-key\">W</div>\r\n              <div className=\"character-screen__control-key\">A</div>\r\n              <div className=\"character-screen__control-key\">S</div>\r\n              <div className=\"character-screen__control-key\">D</div>\r\n            </div>\r\n            <span style={{ marginLeft: '8px' }}>MOVE</span>\r\n          </div>\r\n        </div>\r\n        <div className=\"character-screen__footer-right\">\r\n          {isSynergyOverlayOpen && activeSynergy && (\r\n            <div\r\n              className={`character-screen__control-item character-screen__control-item--clickable ${isEquipping ? 'disabled' : ''}`}\r\n              onClick={async () => {\r\n                if (isEquipping || !activeSynergy || !selectedCharacterId) return;\r\n\r\n                setIsEquipping(true);\r\n                setEquipProgress('Preparing build...');\r\n\r\n                try {\r\n                  // activeSynergy is a DashboardSynergy from the synergy matcher\r\n                  // We need to find the original SynergyDefinition from constants\r\n\r\n                  // Import synergy definitions and find the matching one\r\n                  const { SYNERGY_DEFINITIONS } = await import('../../constants/synergy-definitions');\r\n                  let synergyDef = SYNERGY_DEFINITIONS.find(s => s.name === activeSynergy.buildName);\r\n\r\n                  // DYNAMIC SYNERGY FALLBACK:\r\n                  // If no static definition is found (e.g. for generated synergies like \"Eye of Another World Solar\"),\r\n                  // construct a dynamic definition from the active synergy data.\r\n                  if (!synergyDef) {\r\n\r\n                    // Fallback to empty strings if undefined to ensure object creation,\r\n                    // but warn if they are missing.\r\n                    const weaponName = activeSynergy.weapon || activeSynergy.exoticWeapon; // Try potential alias\r\n                    const armorName = activeSynergy.armor || activeSynergy.exoticArmor;    // Try potential alias\r\n\r\n                    if (!weaponName && !armorName) {\r\n                      toast.error(\"Invalid build data: No weapon or armor specified.\");\r\n                      setIsEquipping(false);\r\n                      return;\r\n                    }\r\n\r\n                    // Import types to ensure we match the interface if needed (implied by usage)\r\n                    // We construct a minimal SynergyDefinition compatible object\r\n                    synergyDef = {\r\n                      id: `dynamic-${Date.now()}`,\r\n                      name: activeSynergy.buildName || 'Custom Build',\r\n                      element: activeSynergy.element,\r\n                      guardianClass: activeSynergy.guardianClass,\r\n                      requiredExpansion: 'base' as any, // Assume base for dynamic\r\n                      exoticArmor: {\r\n                        hash: 0, // BuildService will lookup by name if hash is 0/missing\r\n                        name: armorName,\r\n                        slot: 'chest' as any // Slot is irrelevant for lookup by name\r\n                      },\r\n                      exoticWeapon: {\r\n                        hash: 0,\r\n                        name: weaponName,\r\n                      },\r\n                      playstyle: 'Dynamic Synergy Build',\r\n                      difficulty: 'intermediate' as any,\r\n                      tags: [],\r\n                      loopDescription: 'Auto-generated synergy build.'\r\n                    } as any;\r\n                  }\r\n\r\n\r\n                  // Use buildService.equip with the proper SynergyDefinition\r\n                  if (synergyDef) {\r\n                    setIsSynergyOverlayOpen(false); // Close overlay immediately\r\n                    setForceCloseOverlayTrigger(prev => prev + 1); // Signal child to close\r\n                    const result = await buildService.equip(\r\n                      synergyDef,\r\n                      selectedCharacterId,\r\n                      (step: string, progress: number) => {\r\n                        setEquipProgress(`${step} (${Math.round(progress)}%)`);\r\n                      }\r\n                    );\r\n\r\n                    if (result.success) {\r\n                      toast.success(`Successfully equipped ${synergyDef.name}!`);\r\n                      setEquipProgress('');\r\n                      // PULL BACK TO ORBIT: Reset view mode to 'all'\r\n                      setViewMode('all');\r\n                    } else {\r\n                      toast.error(result.error || 'Failed to equip build');\r\n                      setEquipProgress('');\r\n                    }\r\n                  }\r\n                } catch (error) {\r\n                  toast.error('Failed to equip build. Please try again.');\r\n                  setEquipProgress('');\r\n                } finally {\r\n                  setIsEquipping(false);\r\n                }\r\n              }}\r\n            >\r\n              <div className=\"character-screen__control-key\">F</div>\r\n              <span>{isEquipping ? equipProgress || 'Equipping...' : 'Equip Build'}</span>\r\n            </div>\r\n          )}\r\n          <div\r\n            className=\"character-screen__control-item character-screen__control-item--clickable\"\r\n            onClick={() => setViewMode(prev => prev === 'inventory-only' ? 'all' : 'inventory-only')}\r\n          >\r\n            <div className={`character-screen__control-key ${viewMode === 'inventory-only' ? 'active' : ''}`}>I</div>\r\n            <span>Inventory{viewMode === 'inventory-only' ? ' (Active)' : ''}</span>\r\n          </div>\r\n          <div\r\n            className=\"character-screen__control-item character-screen__control-item--clickable\"\r\n            onClick={() => setIsVaultSearchVisible(prev => !prev)}\r\n          >\r\n            <div className={`character-screen__control-key ${isVaultSearchVisible ? 'active' : ''}`}>V</div>\r\n            <span>Vault{isVaultSearchVisible ? ' (Active)' : ''}</span>\r\n          </div>\r\n          <div\r\n            className=\"character-screen__control-item character-screen__control-item--clickable\"\r\n            onClick={() => setViewMode(prev => prev === 'subclass-only' ? 'all' : 'subclass-only')}\r\n          >\r\n            <div className={`character-screen__control-key ${viewMode === 'subclass-only' ? 'active' : ''}`}>J</div>\r\n            <span>Subclass{viewMode === 'subclass-only' ? ' (Active)' : ''}</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","import { useEffect, useRef, useState } from 'react';\nimport { getBungieUrl } from '../../utils/url-helper';\nimport { RichTooltip } from './RichTooltip';\nimport type { DestinyItem } from '../../types';\nimport './AbilityPicker.css';\n\nexport interface AbilityPickerItem {\n    hash: number;\n    name: string;\n    icon: string;\n}\n\ninterface AbilityPickerProps {\n    items: AbilityPickerItem[];\n    columns: number;\n    onSelect: (hash: number) => void;\n    onClose: () => void;\n    element?: string;\n    equippedHash?: number;\n    style?: React.CSSProperties;\n    type?: 'diamond' | 'square' | 'round';\n}\n\n/** Create a minimal DestinyItem for RichTooltip */\nfunction makePickerItem(hash: number): DestinyItem {\n    return {\n        itemHash: hash,\n        itemInstanceId: undefined,\n        quantity: 1,\n        bindStatus: 0,\n        location: 0,\n        bucketHash: 0,\n        transferStatus: 0,\n        lockable: false,\n        state: 0,\n    };\n}\n\nexport function AbilityPicker({ items, columns, onSelect, onClose, element = 'void', equippedHash, style, type = 'square' }: AbilityPickerProps) {\n    const ref = useRef<HTMLDivElement>(null);\n    const [hoveredHash, setHoveredHash] = useState<number | null>(null);\n\n    useEffect(() => {\n        const handleClickOutside = (e: MouseEvent) => {\n            if (ref.current && !ref.current.contains(e.target as Node)) {\n                onClose();\n            }\n        };\n        const handleEscape = (e: KeyboardEvent) => {\n            if (e.key === 'Escape') onClose();\n        };\n\n        // Delay adding click listener to avoid immediately closing from the click that opened picker\n        const timer = setTimeout(() => {\n            document.addEventListener('mousedown', handleClickOutside);\n        }, 50);\n        document.addEventListener('keydown', handleEscape);\n        return () => {\n            clearTimeout(timer);\n            document.removeEventListener('mousedown', handleClickOutside);\n            document.removeEventListener('keydown', handleEscape);\n        };\n    }, [onClose]);\n\n    return (\n        <div\n            className={`ability-picker element-${element} ability-picker--${type}`}\n            ref={ref}\n            style={style}\n            onClick={(e) => {\n                e.preventDefault();\n                e.stopPropagation();\n            }}\n            onMouseDown={(e) => e.stopPropagation()}\n        >\n            <div\n                className=\"ability-picker__grid\"\n                style={{ gridTemplateColumns: `repeat(${columns}, 1fr)` }}\n            >\n                {items.map((item, index) => {\n                    const iconUrl = item.icon?.startsWith('/')\n                        ? getBungieUrl(item.icon)\n                        : item.icon;\n                    const isEquipped = item.hash === equippedHash;\n                    const isHovered = hoveredHash === item.hash;\n\n                    return (\n                        <div\n                            key={item.hash}\n                            className=\"ability-picker__cell-wrapper\"\n                            style={{ '--delay': `${index * 0.02}s` } as any}\n                            onMouseEnter={() => setHoveredHash(item.hash)}\n                            onMouseLeave={() => setHoveredHash(null)}\n                        >\n                            <button\n                                className={`ability-picker__cell${isEquipped ? ' ability-picker__cell--equipped' : ''}`}\n                                onClick={() => onSelect(item.hash)}\n                            >\n                                {iconUrl && (\n                                    <img\n                                        src={iconUrl}\n                                        alt={item.name}\n                                        className=\"ability-picker__icon\"\n                                    />\n                                )}\n                            </button>\n                            {isHovered && (\n                                <RichTooltip item={makePickerItem(item.hash)} hideStats={true} />\n                            )}\n                        </div>\n                    );\n                })}\n            </div>\n        </div>\n    );\n}\n","import { useMemo, useState, useCallback, useEffect, useRef } from 'react';\r\nimport { useProfileStore, useManifestStore } from '../../store';\r\nimport { BUCKET_HASHES } from '../../config/bungie.config';\r\nimport { manifestService } from '../../services/bungie/manifest.service';\r\nimport { transferService, createMoveSession } from '../../services/bungie/transfer.service';\r\nimport { profileLoader } from '../../services/bungie/profile.service';\r\nimport { getEquippedItem } from '../../utils/character-helpers';\r\nimport { getBungieUrl } from '../../utils/url-helper';\r\nimport { SubclassNode } from './SubclassNode';\r\nimport { AbilityPicker, type AbilityPickerItem } from './AbilityPicker';\r\nimport { RichTooltip } from './RichTooltip';\r\nimport type { DestinyItem } from '../../types';\r\nimport './SubclassScreen.css';\r\n\r\nconst CLASS_NAMES: Record<number, string> = { 0: 'TITAN', 1: 'HUNTER', 2: 'WARLOCK' };\r\n\r\nfunction makeAbilityItem(hash: number): DestinyItem {\r\n    return {\r\n        itemHash: hash, itemInstanceId: undefined, quantity: 1, bindStatus: 0, location: 0,\r\n        bucketHash: 0, transferStatus: 0, lockable: false, state: 0,\r\n    };\r\n}\r\n\r\nfunction resolveIcon(def: any, fallbackIcon?: string): string {\r\n    if (def?.displayProperties?.icon) {\r\n        const raw = def.displayProperties.icon;\r\n        // If it's already an absolute URL (from transformItemDefinition), return it\r\n        if (raw.startsWith('http')) return raw;\r\n        return getBungieUrl(raw) || '';\r\n    }\r\n    if (fallbackIcon) {\r\n        if (fallbackIcon.startsWith('http')) return fallbackIcon;\r\n        return getBungieUrl(fallbackIcon) || '';\r\n    }\r\n    return '';\r\n}\r\n\r\nfunction categorizeEquippedSockets(\r\n    sockets: Array<{ plugHash?: number; plugName?: string; plugIcon?: string; socketIndex?: number }>,\r\n    subclassDef?: any\r\n): Record<string, EquippedAbility[]> {\r\n    const result: Record<string, EquippedAbility[]> = {\r\n        SUPER: [], GRENADES: [], MELEE: [], CLASS_ABILITIES: [],\r\n        JUMP: [], ASPECTS: [], FRAGMENTS: [], PRISMATIC_FRAGMENTS: [],\r\n        TRANSCENDENCE: [],\r\n    };\r\n\r\n    if (!subclassDef?.sockets?.socketCategories) return result;\r\n\r\n    // Map Bungie's Socket Categories to our internal groups\r\n    // Hashes verified against bungie.config.ts and DIM\r\n    const HASH_TO_GROUP: Record<number, string> = {\r\n        457473665: 'SUPER',      // Super\r\n        2047681910: 'ASPECTS',   // Aspects\r\n        2140934067: 'ASPECTS',   // Aspects (Ikora)\r\n        3400923910: 'ASPECTS',   // Aspects (Stranger/Stasis)\r\n        764703411: 'ASPECTS',    // Aspects (Neomuna/Strand)\r\n        271461480: 'FRAGMENTS',  // Fragments\r\n        1313488945: 'FRAGMENTS', // Fragments (Ikora)\r\n        2819965312: 'FRAGMENTS', // Fragments (Stranger)\r\n        193371309: 'FRAGMENTS',  // Fragments (Neomuna)\r\n        4112185160: 'FRAGMENTS', // Fragments (Prismatic Facets)\r\n        309722977: 'CLASS_ABILITIES', // Abilities\r\n        3218807805: 'CLASS_ABILITIES', // Abilities (Ikora) - Light 3.0 subclasses\r\n        1905270138: 'TRANSCENDENCE', // Prismatic Transcendence\r\n    };\r\n\r\n    // Subclasses use Socket Categories for primary organization\r\n    for (const cat of subclassDef.sockets.socketCategories) {\r\n        let group = HASH_TO_GROUP[cat.socketCategoryHash];\r\n\r\n        // Special case for Prismatic Tertiary Sockets (Facets)\r\n        // If not in HASH_TO_GROUP, try regex on category info if available\r\n        // but hashes 271461480 usually cover Prismatic too.\r\n\r\n        if (group && result[group]) {\r\n            for (const socketIndex of cat.socketIndexes) {\r\n                const socket = sockets[socketIndex];\r\n                const plugHash = socket?.plugHash || 0;\r\n\r\n                // For abilities, we might need further refinement based on discovered abilities\r\n                // (e.g. distinguishing grenade vs melee vs class ability in the same category)\r\n                let specificGroup = group;\r\n                if (group === 'CLASS_ABILITIES' || group === 'ASPECTS' || group === 'FRAGMENTS') {\r\n                    // These are generally fine as-is\r\n                }\r\n\r\n                if (group === 'CLASS_ABILITIES' && plugHash) {\r\n                    const plugDef = manifestService.getItem(plugHash);\r\n                    const plugCat = plugDef?.plug?.plugCategoryIdentifier || '';\r\n                    if (/grenade/i.test(plugCat)) specificGroup = 'GRENADES';\r\n                    else if (/melee/i.test(plugCat)) specificGroup = 'MELEE';\r\n                    else if (/movement/i.test(plugCat)) specificGroup = 'JUMP';\r\n                }\r\n\r\n                const def = plugHash ? manifestService.getItem(plugHash) : undefined;\r\n\r\n                // DIM Parity: Always prefer manifest data for icons/names if available\r\n                const name = def?.displayProperties?.name || socket?.plugName || (plugHash === 0 ? 'Empty Socket' : '');\r\n                const icon = resolveIcon(def, socket?.plugIcon);\r\n\r\n                result[specificGroup].push({\r\n                    hash: plugHash,\r\n                    name,\r\n                    icon,\r\n                    socketIndex: socketIndex,\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    // Filter out potential duplicates or misplaced abilities if any\r\n    return result;\r\n}\r\n\r\nfunction getAvailableForSocket(subclassItemHash: number, socketIndex: number, excludedHashes: number[] = []): AbilityPickerItem[] {\r\n    const rawDef = (manifestService as any).getRawDefinition('DestinyInventoryItemDefinition', subclassItemHash);\r\n    if (!rawDef?.sockets?.socketEntries) return [];\r\n    const socketEntry = rawDef.sockets.socketEntries[socketIndex];\r\n    if (!socketEntry) return [];\r\n    const plugSetHash = socketEntry.reusablePlugSetHash || socketEntry.randomizedPlugSetHash;\r\n    if (!plugSetHash) return [];\r\n    const plugs = manifestService.getPlugSet(plugSetHash);\r\n    return plugs\r\n        .filter(p => !excludedHashes.includes(p.hash))\r\n        .filter(p => p.name && p.name !== 'Unknown Perk')\r\n        .map(p => ({ hash: p.hash, name: p.name, icon: p.icon || '' }))\r\n        .sort((a, b) => {\r\n            const aEmpty = a.name.toLowerCase().includes('empty');\r\n            const bEmpty = b.name.toLowerCase().includes('empty');\r\n            if (aEmpty && !bEmpty) return -1;\r\n            if (!aEmpty && bEmpty) return 1;\r\n            return a.name.localeCompare(b.name);\r\n        });\r\n}\r\n\r\ninterface EquippedAbility {\r\n    hash: number; name: string; icon: string; socketIndex: number;\r\n}\r\n\r\nexport function SubclassScreen({ subclassHash: propSubclassHash, itemInstanceId: propInstanceId, onBack }: { subclassHash?: number; itemInstanceId?: string; onBack: () => void }) {\r\n    const {\r\n        selectedCharacterId,\r\n        characterEquipment,\r\n        characterInventories,\r\n        itemInstances,\r\n        characters,\r\n        vaultInventory\r\n    } = useProfileStore();\r\n    const { isLoaded: manifestLoaded } = useManifestStore();\r\n    const socketLockRef = useRef(false);\r\n\r\n    const [openPicker, setOpenPicker] = useState<string | null>(null);\r\n    const [hoveredSlot, setHoveredSlot] = useState<string | null>(null);\r\n    const [equipping, setEquipping] = useState(false);\r\n    const [optimisticOverrides, setOptimisticOverrides] = useState<Record<number, number>>({});\r\n    const [parallax, setParallax] = useState({ x: 0, y: 0 });\r\n    const [uiVisible, setUiVisible] = useState(true);\r\n    const [showLore, setShowLore] = useState(false);\r\n    const [equipProgress, setEquipProgress] = useState<{ status: string; percent: number } | null>(null);\r\n    const [isMoving, setIsMoving] = useState(false);\r\n\r\n\r\n    useEffect(() => {\r\n        const handleKeyDown = (e: KeyboardEvent) => {\r\n            if (e.key === 'Escape') { e.preventDefault(); onBack(); }\r\n            if (e.key === 'Control') { e.preventDefault(); setUiVisible(v => !v); }\r\n            if (e.key.toLowerCase() === 'a') { e.preventDefault(); setShowLore(v => !v); }\r\n            if (e.key.toLowerCase() === 'f') { e.preventDefault(); handleEquipSubclass(); }\r\n        };\r\n        window.addEventListener('keydown', handleKeyDown);\r\n        return () => window.removeEventListener('keydown', handleKeyDown);\r\n    }, [onBack]);\r\n\r\n    const togglePicker = useCallback((id: string) => setOpenPicker(prev => prev === id ? null : id), []);\r\n    const handleMouseMove = useCallback((e: React.MouseEvent) => {\r\n        setParallax({ x: (e.clientX / window.innerWidth) - 0.5, y: (e.clientY / window.innerHeight) - 0.5 });\r\n    }, []);\r\n\r\n    const equipment = characterEquipment[selectedCharacterId || ''] || [];\r\n    const inventory = characterInventories[selectedCharacterId || ''] || [];\r\n    const character = characters.find(c => c.characterId === selectedCharacterId);\r\n    const classType = character?.classType ?? 2;\r\n    const className = CLASS_NAMES[classType] || 'GUARDIAN';\r\n\r\n    const subclassItem = useMemo(() => {\r\n        if (propSubclassHash) {\r\n            const eq = equipment.find(i => i.itemHash === propSubclassHash);\r\n            if (eq) return eq;\r\n            const inv = inventory.find(i => i.itemHash === propSubclassHash && (!propInstanceId || i.itemInstanceId === propInstanceId));\r\n            if (inv) return inv;\r\n            const vlt = vaultInventory.find(i => i.itemHash === propSubclassHash && (!propInstanceId || i.itemInstanceId === propInstanceId));\r\n            return vlt || null;\r\n        }\r\n        return getEquippedItem(equipment, BUCKET_HASHES.SUBCLASS);\r\n    }, [propSubclassHash, propInstanceId, equipment, inventory, vaultInventory]);\r\n\r\n    // Auto-move if in vault\r\n    useEffect(() => {\r\n        const checkVault = async () => {\r\n            if (!subclassItem || !selectedCharacterId || isMoving) return;\r\n            const inVault = vaultInventory.some(i => i.itemInstanceId === subclassItem.itemInstanceId);\r\n            if (inVault && subclassItem.itemInstanceId) {\r\n                setIsMoving(true);\r\n                setEquipProgress({ status: 'Retrieving subclass from Vault...', percent: 0 });\r\n                try {\r\n                    await transferService.smartTransfer(\r\n                        subclassItem.itemInstanceId,\r\n                        subclassItem.itemHash,\r\n                        false,\r\n                        selectedCharacterId,\r\n                        createMoveSession([], 1)\r\n                    );\r\n                    await profileLoader.loadProfile(true);\r\n                    setEquipProgress({ status: 'Data retrieved!', percent: 100 });\r\n                    setTimeout(() => setEquipProgress(null), 1000);\r\n                } catch (error: any) {\r\n                    setEquipProgress({ status: `Failed to retrieve: ${error.message}`, percent: 0 });\r\n                } finally {\r\n                    setIsMoving(false);\r\n                }\r\n            }\r\n        };\r\n        checkVault();\r\n    }, [subclassItem?.itemInstanceId, selectedCharacterId]);\r\n\r\n    const subclassHash = subclassItem?.itemHash || 0;\r\n    const subclassDef = subclassItem ? manifestService.getItem(subclassItem.itemHash) : undefined;\r\n\r\n    const subclassElement = useMemo(() => {\r\n        if (!subclassDef) return 'void';\r\n        let type = subclassDef.defaultDamageType;\r\n        if (!type || type === 0) type = subclassDef.talentGrid?.hudDamageType;\r\n        if (type === 2) return 'arc';\r\n        if (type === 3) return 'solar';\r\n        if (type === 4) return 'void';\r\n        if (type === 6) return 'stasis';\r\n        if (type === 7) return 'strand';\r\n        const name = subclassDef.displayProperties?.name?.toLowerCase() || '';\r\n        // Use word boundary regex to avoid partial matches\r\n        if (/\\bprismatic\\b/.test(name)) return 'prismatic';\r\n        if (/\\bsolar\\b/.test(name) || /\\bdawn\\b/.test(name) || /\\bgunslinger\\b/.test(name) || /\\bfire\\b/.test(name)) return 'solar';\r\n        if (/\\bvoid\\b/.test(name) || /\\bnight\\b/.test(name) || /\\bvoidwalker\\b/.test(name) || /\\bsentinel\\b/.test(name)) return 'void';\r\n        if (/\\barc\\b/.test(name) || /\\bstorm\\b/.test(name) || /\\bstriker\\b/.test(name) || /\\bstrider\\b/.test(name)) return 'arc';\r\n        if (/\\bstasis\\b/.test(name) || /\\bshade\\b/.test(name) || /\\brevenant\\b/.test(name) || /\\bbehemoth\\b/.test(name)) return 'stasis';\r\n        if (/\\bstrand\\b/.test(name) || /\\bbrood\\b/.test(name) || /\\bthread\\b/.test(name) || /\\bberserk\\b/.test(name)) return 'strand';\r\n        return 'void';\r\n    }, [subclassDef]);\r\n\r\n    const subclassName = subclassDef?.displayProperties?.name || `${subclassElement.toUpperCase()} ${className}`;\r\n\r\n    const realSockets = subclassItem?.itemInstanceId ? (itemInstances[subclassItem.itemInstanceId]?.sockets || []) : [];\r\n    // DIM Parity: Use socket.socketIndex (not array index) as the key for optimistic overrides\r\n    const sockets = useMemo(() => realSockets.map((s) => {\r\n        const socketIdx = s.socketIndex ?? realSockets.indexOf(s);\r\n        return optimisticOverrides[socketIdx] !== undefined ? { ...s, plugHash: optimisticOverrides[socketIdx] } : s;\r\n    }), [realSockets, optimisticOverrides]);\r\n    const equipped = useMemo(() => categorizeEquippedSockets(sockets, subclassDef), [sockets, subclassDef]);\r\n\r\n    const allFragments = [...(equipped.FRAGMENTS || []), ...(equipped.PRISMATIC_FRAGMENTS || [])];\r\n\r\n    const handleEquip = useCallback(async (socketIndex: number, plugHash: number) => {\r\n        if (!subclassItem?.itemInstanceId || !selectedCharacterId || equipping || socketLockRef.current) return;\r\n\r\n        socketLockRef.current = true;\r\n        setOpenPicker(null);\r\n\r\n        // DIM Parity: Apply optimistic update immediately - UI should update instantly\r\n        // Find socket by its socketIndex property, not array position\r\n        const currentSocket = realSockets.find(s => s.socketIndex === socketIndex);\r\n        const previousPlugHash = currentSocket?.plugHash;\r\n        setOptimisticOverrides(prev => ({ ...prev, [socketIndex]: plugHash }));\r\n        setEquipping(true);\r\n\r\n        try {\r\n            const vaultItem = vaultInventory.find(i => i.itemHash === (subclassItem?.itemHash || 0));\r\n            if (vaultItem && vaultItem.itemInstanceId && selectedCharacterId) {\r\n                await transferService.smartTransfer(vaultItem.itemInstanceId, vaultItem.itemHash, false, selectedCharacterId, createMoveSession([], 1));\r\n                await profileLoader.loadProfile(true);\r\n                await new Promise(r => setTimeout(r, 1000));\r\n            }\r\n            if (!subclassItem?.itemInstanceId) throw new Error('Subclass item instance not found.');\r\n\r\n            const success = await transferService.insertSocketPlugFree(subclassItem.itemInstanceId, plugHash, socketIndex, selectedCharacterId);\r\n\r\n            // DIM Parity: Don't reload profile on success - the local socket update already happened\r\n            // and calling loadProfile causes the UI to flash. Keep optimistic override as-is.\r\n            // The API response already updated the local item via updateLocalSocketPlug/updateItemFromChange.\r\n            if (!success) {\r\n                throw new Error('Socket plug failed');\r\n            }\r\n            // No background sync needed - the store was updated in insertSocketPlugFree\r\n        } catch (error: any) {\r\n            // Rollback to previous state\r\n            setOptimisticOverrides(prev => {\r\n                const next = { ...prev };\r\n                if (previousPlugHash !== undefined) {\r\n                    next[socketIndex] = previousPlugHash;\r\n                } else {\r\n                    delete next[socketIndex];\r\n                }\r\n                return next;\r\n            });\r\n            // Force profile reload on error to ensure UI consistency\r\n            await profileLoader.loadProfile(true);\r\n        } finally {\r\n            setEquipping(false);\r\n            socketLockRef.current = false;\r\n        }\r\n    }, [subclassItem, selectedCharacterId, equipping, vaultInventory, realSockets]);\r\n\r\n    const handleEquipSubclass = useCallback(async () => {\r\n        if (!subclassItem?.itemInstanceId || !selectedCharacterId || equipping || equipProgress) return;\r\n        try {\r\n            setEquipping(true);\r\n            setEquipProgress({ status: 'Preparing to equip subclass...', percent: 0 });\r\n            const curEq = characterEquipment[selectedCharacterId] || [];\r\n            const curSub = curEq.find(i => i.bucketHash === BUCKET_HASHES.SUBCLASS);\r\n            if (curSub?.itemInstanceId !== subclassItem.itemInstanceId) {\r\n                setEquipProgress({ status: 'Switching to this subclass...', percent: 20 });\r\n                await transferService.equipItem(subclassItem.itemInstanceId, selectedCharacterId);\r\n                await new Promise(r => setTimeout(r, 500));\r\n                await profileLoader.loadProfile(true);\r\n            }\r\n            const config = {\r\n                subclassHash: subclassItem.itemHash,\r\n                superHash: equipped.SUPER[0]?.hash,\r\n                grenadeHash: equipped.GRENADES[0]?.hash,\r\n                meleeHash: equipped.MELEE[0]?.hash,\r\n                classAbilityHash: equipped.CLASS_ABILITIES[0]?.hash,\r\n                movementHash: equipped.JUMP[0]?.hash,\r\n                aspects: equipped.ASPECTS?.map(a => a.hash).filter(h => h !== undefined) || [],\r\n                fragments: allFragments?.map(f => f.hash).filter(h => h !== undefined) || [],\r\n            };\r\n            await transferService.applySubclassConfiguration(subclassItem, config, selectedCharacterId, (s: string, p: number) => setEquipProgress({ status: s, percent: 40 + (p * 0.6) }));\r\n            setEquipProgress({ status: 'Subclass equipped successfully!', percent: 100 });\r\n\r\n            // Pulse back to orbit immediately upon confirmation\r\n            onBack();\r\n\r\n            setTimeout(() => setEquipProgress(null), 1000);\r\n            await profileLoader.loadProfile(true);\r\n        } catch (e: any) {\r\n            setEquipProgress({ status: `Error: ${e.message}`, percent: 0 });\r\n            setTimeout(() => setEquipProgress(null), 3000);\r\n        } finally { setEquipping(false); }\r\n    }, [subclassItem, selectedCharacterId, equipping, equipProgress, equipped, allFragments, characterEquipment]);\r\n\r\n    const backgroundImage = useMemo(() => {\r\n        if (subclassDef?.screenshot) return getBungieUrl(subclassDef.screenshot);\r\n        if (subclassDef?.displayProperties?.icon) return getBungieUrl(subclassDef.displayProperties.icon);\r\n        const buckets = [BUCKET_HASHES.HELMET, BUCKET_HASHES.GAUNTLETS, BUCKET_HASHES.CHEST_ARMOR, BUCKET_HASHES.LEG_ARMOR, BUCKET_HASHES.CLASS_ARMOR];\r\n        for (const b of buckets) {\r\n            const it = getEquippedItem(equipment, b);\r\n            if (it) {\r\n                const d = manifestService.getItem(it.itemHash);\r\n                if (d?.inventory?.tierType === 6 && d.screenshot) return getBungieUrl(d.screenshot);\r\n            }\r\n        }\r\n        return null;\r\n    }, [subclassDef, equipment, manifestLoaded]);\r\n\r\n    const superId = 'SUPER-main';\r\n    const superAvail = useMemo(() => (equipped.SUPER[0]?.socketIndex !== undefined) ? getAvailableForSocket(subclassHash, equipped.SUPER[0].socketIndex) : [], [subclassHash, equipped.SUPER[0]?.socketIndex]);\r\n\r\n    return (\r\n        <div className={`subclass-screen element-${subclassElement} animate-fade-in ${!uiVisible ? 'ui-hidden' : ''}`} onMouseMove={handleMouseMove} style={{ '--parallax-x': parallax.x, '--parallax-y': parallax.y } as any} onMouseDown={() => setOpenPicker(null)}>\r\n            {backgroundImage && <div className=\"subclass-screen__exotic-bg\" style={{ backgroundImage: `url(${backgroundImage})` }} />}\r\n            <div className=\"subclass-screen__header\">\r\n                <button className=\"btn-back\" onMouseDown={(e) => { e.stopPropagation(); onBack(); }}>&larr; Back to Character</button>\r\n                <div className=\"subclass-screen__title\"><h1>{subclassName}</h1><p className=\"subclass-screen__subtitle\">{className} SUBCLASS</p></div>\r\n            </div>\r\n            <div className=\"subclass-screen__content\">\r\n                <div className=\"subclass-screen__super-section\">\r\n                    <div className=\"subclass-screen__diamond-wrapper\" onMouseEnter={() => setHoveredSlot('slot-super')} onMouseLeave={() => setHoveredSlot(null)} onMouseDown={(e) => { e.stopPropagation(); togglePicker(superId); }}>\r\n                        <SubclassNode type=\"square\" size=\"large\" icon={equipped.SUPER[0]?.icon} status=\"active\" element={subclassElement as any} />\r\n                        {hoveredSlot === 'slot-super' && openPicker !== superId && equipped.SUPER[0] && <RichTooltip item={makeAbilityItem(equipped.SUPER[0].hash)} overrideElement={subclassElement as any} hideStats={true} />}\r\n                        {openPicker === superId && superAvail.length > 0 && (\r\n                            <AbilityPicker items={superAvail} columns={4} equippedHash={equipped.SUPER[0]?.hash} onSelect={(h) => equipped.SUPER[0] && handleEquip(equipped.SUPER[0].socketIndex, h)} onClose={() => setOpenPicker(null)} element={subclassElement} type=\"square\" />\r\n                        )}\r\n                    </div>\r\n                </div>\r\n                <div className=\"subclass-screen__middle\">\r\n                    <div className=\"subclass-screen__top-row\">\r\n                        {(equipped.TRANSCENDENCE?.length || 0) > 0 && (\r\n                            <div className=\"subclass-group\"><h3 className=\"section-label\">TRANSCENDENCE</h3><div className=\"subclass-group__slots\">\r\n                                {equipped.TRANSCENDENCE.map((it, i) => <CommonSlot key={`trans-${i}`} item={it} label=\"\" categoryId=\"TRANSCENDENCE\" indexInCat={i} subclassHash={subclassHash} subclassElement={subclassElement} openPicker={openPicker} togglePicker={togglePicker} hoveredSlot={hoveredSlot} setHoveredSlot={setHoveredSlot} handleEquip={handleEquip} setOpenPicker={setOpenPicker} />)}\r\n                            </div></div>\r\n                        )}\r\n                        <div className=\"subclass-group\"><h3 className=\"section-label\">ABILITIES</h3><div className=\"subclass-group__slots\">\r\n                            {['CLASS_ABILITIES', 'JUMP', 'MELEE', 'GRENADES'].map(cat => <CommonSlot key={cat} item={equipped[cat][0]} label=\"\" categoryId={cat} subclassHash={subclassHash} subclassElement={subclassElement} openPicker={openPicker} togglePicker={togglePicker} hoveredSlot={hoveredSlot} setHoveredSlot={setHoveredSlot} handleEquip={handleEquip} setOpenPicker={setOpenPicker} />)}\r\n                        </div></div>\r\n                        <div className=\"subclass-group\"><h3 className=\"section-label\">ASPECTS</h3><div className=\"subclass-group__slots\">\r\n                            {(() => {\r\n                                const raw = equipped.ASPECTS || [];\r\n                                const sorted = [...raw].sort((a, _b) => a.name.toLowerCase().includes('empty') ? -1 : 1);\r\n                                const padded = [...Array(Math.max(0, 2 - sorted.length)).fill(undefined), ...sorted];\r\n                                const hashes = padded.map(a => a?.hash).filter(h => h !== undefined) as number[];\r\n                                return padded.slice(0, 2).map((it, i) => <CommonSlot key={`aspect-${i}`} item={it} label=\"\" categoryId=\"ASPECTS\" indexInCat={i} subclassHash={subclassHash} subclassElement={subclassElement} openPicker={openPicker} togglePicker={togglePicker} hoveredSlot={hoveredSlot} setHoveredSlot={setHoveredSlot} handleEquip={handleEquip} setOpenPicker={setOpenPicker} excludedHashes={hashes.filter(h => h !== it?.hash)} />);\r\n                            })()}\r\n                        </div></div>\r\n                    </div>\r\n                    <div className=\"subclass-screen__bottom-row\"><div className=\"subclass-group\"><h3 className=\"section-label\">FRAGMENTS</h3><div className=\"subclass-group__slots\">\r\n                        {(() => {\r\n                            let max = 0;\r\n                            const FALLBACK: Record<string, number> = { 'Feed the Void': 2, 'Hellion': 2, 'Bleak Watcher': 2, 'Frostpulse': 2, 'Iceflare Bolts': 2, 'Glacial Harvest': 2, 'Weaver\\'s Call': 3, 'Lightning Surge': 3, 'Stylish Executioner': 2, 'On the prowl': 3, 'On the Prowl': 3, 'Storm\\'s Keep': 2, 'Storm\\'s keep': 2, 'Storm Keep': 2, 'Storm keep': 2, 'Ascension': 2, 'Winter\\'s Shroud': 2, 'Shatterdive': 2, 'Grim Harvest': 3, 'Touch of Winter': 2, 'Gunpowder Gamble': 3, 'Threaded Specter': 3, 'Consecration': 2, 'Knockout': 2, 'Cryoclasm': 2, 'Tectonic Harvest': 2, 'Howl of the Storm': 2, 'Drengr\\'s Lash': 3, 'Diamond Lance': 3, 'Unbreakable': 3 };\r\n                            (equipped.ASPECTS || []).forEach(a => {\r\n                                const d = manifestService.getItem(a.hash);\r\n                                let s = 0;\r\n                                if (d?.investmentStats) for (const st of d.investmentStats) {\r\n                                    const sd = manifestService.getStat(st.statTypeHash);\r\n                                    // 2855639344 is the standard hash for Fragment Slots (AspectEnergyCapacity)\r\n                                    if (st.statTypeHash === 2855639344 || sd?.name?.includes('Slots')) s += st.value;\r\n                                }\r\n                                if (s === 0 && d?.displayProperties?.name) s = FALLBACK[d.displayProperties.name] ?? 2;\r\n                                max += s;\r\n                            });\r\n                            const equippedFragments = allFragments || [];\r\n                            // Filter to unique socket indices\r\n                            const uniqueFragments = Array.from(new Map(equippedFragments.map(f => [f.socketIndex, f])).values());\r\n                            const sorted = [...uniqueFragments.sort((a, b) => {\r\n                                if (a.hash === 0 && b.hash === 0) return a.socketIndex - b.socketIndex;\r\n                                if (a.hash === 0) return 1;\r\n                                if (b.hash === 0) return -1;\r\n                                return a.socketIndex - b.socketIndex;\r\n                            })];\r\n                            // Pad with generic empty objects if we haven't reached 'max' yet\r\n                            // These will have undefined socketIndex which means they won't be interactive \r\n                            // unless we find their actual socket indices from the manifest.\r\n                            // But 'uniqueFragments' SHOUD already contain all available sockets.\r\n                            const padded = [...sorted];\r\n                            while (padded.length < max) {\r\n                                padded.push({ hash: 0, name: 'Empty Slot', icon: '', socketIndex: -1 });\r\n                            }\r\n                            const hashes = padded.map(p => p?.hash).filter(h => h !== 0) as number[];\r\n                            return padded.slice(0, max).map((it, i) => <CommonSlot key={`frag-${i}`} item={it} label=\"\" categoryId=\"FRAGMENTS\" indexInCat={i} nodeType=\"square\" subclassHash={subclassHash} subclassElement={subclassElement} openPicker={openPicker} togglePicker={togglePicker} hoveredSlot={hoveredSlot} setHoveredSlot={setHoveredSlot} handleEquip={handleEquip} setOpenPicker={setOpenPicker} pickerColumns={8} pickerAlign=\"start\" size=\"small\" excludedHashes={hashes.filter(h => h !== it?.hash)} />);\r\n                        })()}\r\n                    </div></div></div>\r\n                </div>\r\n                <div className=\"subclass-screen__right-spacer\"></div>\r\n            </div>\r\n            <div className=\"subclass-screen__footer\">\r\n                <div className=\"subclass-screen__controls-right\">\r\n                    <div className=\"d2-control-item\" onClick={() => setUiVisible(!uiVisible)}><span className=\"d2-key-btn\">Ctrl</span><span className=\"d2-control-label\">{uiVisible ? 'Hide Menu' : 'Show Menu'}</span></div>\r\n                    <div className=\"d2-control-item\" onClick={onBack}><span className=\"d2-key-btn\">Esc</span><span className=\"d2-control-label\">Dismiss</span></div>\r\n                    <div className=\"d2-control-item\" onClick={handleEquipSubclass}><span className=\"d2-key-btn\">F</span><span className=\"d2-control-label\">Equip Subclass</span></div>\r\n                </div>\r\n            </div>\r\n            {equipProgress && (\r\n                <div className=\"subclass-screen__service-alert animate-slide-up\">\r\n                    <div className=\"service-alert-content\"><div className=\"service-alert-icon\"><svg viewBox=\"0 0 24 24\" width=\"18\" height=\"18\" fill=\"currentColor\"><path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z\" /></svg></div><div className=\"service-alert-text\"><span className=\"alert-bold\">SERVICE ALERT</span><span className=\"alert-message\">{equipProgress.status}</span></div></div>\r\n                    {equipProgress.percent > 0 && <div className=\"service-alert-progress\"><div className=\"service-alert-progress-fill\" style={{ width: `${equipProgress.percent}%` }} /></div>}\r\n                </div>\r\n            )}\r\n            {showLore && (\r\n                <div className=\"subclass-lore-overlay animate-fade-in\" onClick={() => setShowLore(false)}>\r\n                    <div className=\"subclass-lore-content\" onClick={e => e.stopPropagation()}>\r\n                        <div className=\"lore-header\"><div className=\"lore-title\">{subclassName}</div><div className=\"lore-subtitle\">LORE</div></div>\r\n                        <div className=\"lore-body\">{subclassDef?.displayProperties?.description || \"No lore found for this subclass.\"}</div>\r\n                        <div className=\"lore-footer\"><span className=\"d2-key-btn\">Esc</span> Dismiss</div>\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\nfunction CommonSlot({ item, label, categoryId, indexInCat = 0, nodeType = 'square', customLabel, subclassHash, subclassElement, openPicker, togglePicker, hoveredSlot, setHoveredSlot, handleEquip, setOpenPicker, pickerColumns = 4, pickerAlign = 'center', excludedHashes = [], size }: { item?: EquippedAbility, label: string, categoryId: string, indexInCat?: number, nodeType?: 'square' | 'diamond' | 'round', customLabel?: string, subclassHash: number, subclassElement: string, openPicker: string | null, togglePicker: (id: string) => void, hoveredSlot: string | null, setHoveredSlot: (id: string | null) => void, handleEquip: (idx: number, hash: number) => void, setOpenPicker: (id: string | null) => void, pickerColumns?: number, pickerAlign?: 'start' | 'center', excludedHashes?: number[], size?: 'normal' | 'large' | 'small' }) {\r\n    const pickerId = `${categoryId}-${indexInCat}`;\r\n    const isOpen = openPicker === pickerId;\r\n    const slotId = `slot-${categoryId}-${indexInCat}`;\r\n    const avail = useMemo(() => item?.socketIndex !== undefined ? getAvailableForSocket(subclassHash, item.socketIndex, excludedHashes) : [], [subclassHash, item?.socketIndex, excludedHashes]);\r\n    const style = useMemo(() => pickerAlign === 'start' ? { '--picker-x': `-${(indexInCat || 0) * 72}px`, left: '0', transform: 'none' } : {}, [pickerAlign, indexInCat]);\r\n    return (\r\n        <div className=\"subclass-slot-col\">\r\n            <span className=\"slot-label\">{customLabel || label}</span>\r\n            <div className=\"subclass-slot\" onMouseEnter={() => setHoveredSlot(slotId)} onMouseLeave={() => setHoveredSlot(null)} onMouseDown={(e) => { e.stopPropagation(); togglePicker(pickerId); }}>\r\n                <SubclassNode type={nodeType} size={size} icon={item?.icon} status={item && item.hash !== 0 ? 'active' : 'empty'} element={subclassElement as any} />\r\n                {hoveredSlot === slotId && !isOpen && item && item.hash !== 0 && <RichTooltip item={makeAbilityItem(item.hash)} overrideElement={subclassElement as any} hideStats={true} />}\r\n                {isOpen && avail.length > 0 && (\r\n                    <AbilityPicker items={avail} columns={pickerColumns} equippedHash={item?.hash} onSelect={(h) => item?.socketIndex !== undefined && handleEquip(item.socketIndex, h)} onClose={() => setOpenPicker(null)} element={subclassElement} style={style as any} type={nodeType} />\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","import { useState, useCallback } from 'react';\r\nimport { useLocation } from 'react-router-dom';\r\nimport { useUIStore } from '../store';\r\nimport { CharacterScreen } from '../components/builder/CharacterScreen';\r\nimport { SubclassScreen } from '../components/builder/SubclassScreen';\r\nimport { BuilderContainer } from '../components/builder/BuilderContainer';\r\nimport { TooltipProvider } from '../components/builder/TooltipManager';\r\n\r\ninterface LocationState {\r\n    synergyFilter?: {\r\n        weaponName?: string;\r\n        armorName?: string;\r\n        element?: string;\r\n        buildName?: string;\r\n    };\r\n}\r\n\r\nfunction BuilderPage() {\r\n    // Get synergy filter from navigation state (from Vault builds)\r\n    const location = useLocation();\r\n    const locationState = location.state as LocationState | null;\r\n    const synergyFilter = locationState?.synergyFilter;\r\n\r\n    const { builderView, builderSubView, setBuilderView } = useUIStore();\r\n    const [hoveredSubclass, setHoveredSubclass] = useState<{ item: any; instance?: any } | null>(null);\r\n    const [activeSubclass, setActiveSubclass] = useState<{ item: any; instance: any } | null>(null);\r\n\r\n    const handleSubclassClick = useCallback((itemHash: number, itemInstanceId?: string) => {\r\n        setBuilderView('subclass', { hash: itemHash, itemInstanceId });\r\n    }, [setBuilderView]);\r\n\r\n    const handleSubclassDataReady = useCallback((subclass: any, instance: any) => {\r\n        setActiveSubclass({ item: subclass, instance });\r\n    }, []);\r\n\r\n    return (\r\n        <TooltipProvider>\r\n            {builderView === 'character' ? (\r\n                <BuilderContainer\r\n                    onSubclassClick={handleSubclassClick}\r\n                    hoveredSubclass={hoveredSubclass}\r\n                    setHoveredSubclass={setHoveredSubclass}\r\n                    onSubclassDataReady={handleSubclassDataReady}\r\n                >\r\n                    <CharacterScreen\r\n                        activeSubclass={activeSubclass}\r\n                        synergyFilter={synergyFilter}\r\n                    />\r\n                </BuilderContainer>\r\n            ) : (\r\n                <SubclassScreen\r\n                    subclassHash={builderSubView?.hash}\r\n                    itemInstanceId={builderSubView?.itemInstanceId}\r\n                    onBack={() => setBuilderView('character')}\r\n                />\r\n            )}\r\n        </TooltipProvider>\r\n    );\r\n}\r\n\r\nexport default BuilderPage;\r\n"],"file":"BuilderPage-DCwlU_mB.js"}