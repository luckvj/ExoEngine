{"version":3,"mappings":"4wCAAMA,GAAmBC,GAAgB,CACvC,IAAIC,EACJ,MAAMC,EAA4B,IAAI,IAChCC,EAAW,CAACC,EAASC,IAAY,CACrC,MAAMC,EAAY,OAAOF,GAAY,WAAaA,EAAQH,CAAK,EAAIG,EACnE,GAAI,CAAC,OAAO,GAAGE,EAAWL,CAAK,EAAG,CAChC,MAAMM,EAAgBN,EACtBA,EAASI,IAA4B,OAAOC,GAAc,UAAYA,IAAc,MAAQA,EAAY,OAAO,OAAO,GAAIL,EAAOK,CAAS,EAC1IJ,EAAU,QAASM,GAAaA,EAASP,EAAOM,CAAa,CAAC,CAChE,CACF,EACME,EAAW,IAAMR,EAMjBS,EAAM,CAAE,SAAAP,EAAU,SAAAM,EAAU,gBALV,IAAME,EAKqB,UAJhCH,IACjBN,EAAU,IAAIM,CAAQ,EACf,IAAMN,EAAU,OAAOM,CAAQ,EAEoB,EACtDG,EAAeV,EAAQD,EAAYG,EAAUM,EAAUC,CAAG,EAChE,OAAOA,CACT,EACME,IAAgBZ,GAAgBA,EAAcD,GAAgBC,CAAW,EAAID,IClB7Ec,GAAYC,GAAQA,EAC1B,SAASC,GAASL,EAAKM,EAAWH,GAAU,CAC1C,MAAMI,EAAQC,GAAM,qBAClBR,EAAI,UACJQ,GAAM,YAAY,IAAMF,EAASN,EAAI,SAAQ,CAAE,EAAG,CAACA,EAAKM,CAAQ,CAAC,EACjEE,GAAM,YAAY,IAAMF,EAASN,EAAI,iBAAiB,EAAG,CAACA,EAAKM,CAAQ,CAAC,CAC5E,EACE,OAAAE,GAAM,cAAcD,CAAK,EAClBA,CACT,CACA,MAAME,GAAcnB,GAAgB,CAClC,MAAMU,EAAME,GAAYZ,CAAW,EAC7BoB,EAAiBJ,GAAaD,GAASL,EAAKM,CAAQ,EAC1D,cAAO,OAAOI,EAAeV,CAAG,EACzBU,CACT,EACMC,IAAWrB,GAAgBA,EAAcmB,GAAWnB,CAAW,EAAImB,ICZzE,SAASG,IAAuB,CAC5B,OAAO,IAAI,OAAO,mBAAmB,QAAS,CAAE,OAAQ,GAAO,KAAM,UAAW,OAAQ,UAAW,OAAQ,UAAW,CAC1H,CAGO,SAASC,GAASC,KAAgBC,EAAuB,CACvC,aAAa,QAAQ,MAAM,IAAM,KACtD,QAAQ,IAAI,WAAWD,CAAG,KAAKF,IAAc,IAAK,GAAGG,CAAI,CAC7D,CAGO,SAASC,GAAQF,KAAgBC,EAAuB,CAC3D,QAAQ,IAAI,UAAUD,CAAG,KAAKF,IAAc,IAAK,GAAGG,CAAI,CAC5D,CAGO,SAASE,GAAQH,KAAgBC,EAAuB,CAC3D,QAAQ,KAAK,UAAUD,CAAG,KAAKF,IAAc,IAAK,GAAGG,CAAI,CAC7D,CAGO,SAASG,GAASJ,KAAgBC,EAAuB,CAC5D,QAAQ,MAAM,WAAWD,CAAG,KAAKF,IAAc,IAAK,GAAGG,CAAI,CAC/D,CAGO,SAASI,GAAWL,KAAgBC,EAAuB,CAC9D,QAAQ,IAAI,aAAaD,CAAG,KAAKF,IAAc,IAAK,GAAGG,CAAI,CAC/D,CAEO,SAASK,GAASC,EAAqB,CAC1C,QAAQ,MAAM,WAAWA,CAAK,EAAE,CACpC,CAEO,SAASC,IAAoB,CAChC,QAAQ,UACZ,CAEO,SAASC,GAAST,EAAaU,EAAqB,CACvD,QAAQ,IAAI,WAAWV,CAAG,GAAG,EAC7B,QAAQ,MAAMU,CAAI,CACtB,CAEO,SAASC,GAAaX,EAAa,CACtC,MAAO,CACH,MAAO,IAAIC,IAAoBF,GAASC,EAAK,GAAGC,CAAI,EACpD,KAAM,IAAIA,IAAoBC,GAAQF,EAAK,GAAGC,CAAI,EAClD,KAAM,IAAIA,IAAoBE,GAAQH,EAAK,GAAGC,CAAI,EAClD,MAAO,IAAIA,IAAoBG,GAASJ,EAAK,GAAGC,CAAI,EACpD,QAAS,IAAIA,IAAoBI,GAAWL,EAAK,GAAGC,CAAI,EACxD,MAAQS,GAAkBD,GAAST,EAAKU,CAAI,EAC5C,MAAQH,GAAkBD,GAAS,IAAIN,CAAG,KAAKO,CAAK,EAAE,EACtD,SAAU,IAAMC,GAAA,CAAY,CAEpC,wNC7DA,SAASI,GAAiBC,EAAS,CAC/B,OAAO,IAAI,QAAQ,CAACC,EAASC,IAAW,CAEpCF,EAAQ,WAAaA,EAAQ,UAAY,IAAMC,EAAQD,EAAQ,MAAM,EAErEA,EAAQ,QAAUA,EAAQ,QAAU,IAAME,EAAOF,EAAQ,KAAK,CAClE,CAAC,CACL,CACA,SAASzB,GAAY4B,EAAQC,EAAW,CACpC,IAAIC,EACJ,MAAMC,EAAQ,IAAM,CAChB,GAAID,EACA,OAAOA,EACX,MAAML,EAAU,UAAU,KAAKG,CAAM,EACrC,OAAAH,EAAQ,gBAAkB,IAAMA,EAAQ,OAAO,kBAAkBI,CAAS,EAC1EC,EAAMN,GAAiBC,CAAO,EAC9BK,EAAI,KAAME,GAAO,CAGbA,EAAG,QAAU,IAAOF,EAAM,MAC9B,EAAG,IAAM,CAAE,CAAC,EACLA,CACX,EACA,MAAO,CAACG,EAAQC,IAAaH,EAAK,EAAG,KAAMC,GAAOE,EAASF,EAAG,YAAYH,EAAWI,CAAM,EAAE,YAAYJ,CAAS,CAAC,CAAC,CACxH,CACA,IAAIM,GACJ,SAASC,IAAkB,CACvB,OAAKD,KACDA,GAAsBnC,GAAY,eAAgB,QAAQ,GAEvDmC,EACX,CAOA,SAASE,GAAIC,EAAKC,EAAcH,KAAmB,CAC/C,OAAOG,EAAY,WAAaC,GAAUhB,GAAiBgB,EAAM,IAAIF,CAAG,CAAC,CAAC,CAC9E,CAQA,SAASG,GAAIH,EAAKI,EAAOH,EAAcH,GAAe,EAAI,CACtD,OAAOG,EAAY,YAAcC,IAC7BA,EAAM,IAAIE,EAAOJ,CAAG,EACbd,GAAiBgB,EAAM,WAAW,EAC5C,CACL,CClDO,MAAMG,EAAc,CACzB,KAAM,OACN,MAAO,QACP,IAAK,MACL,OAAQ,SACR,OAAQ,SACR,UAAW,YACX,QAAS,UACT,QAAS,SACX,EAGaC,EAAY,CACvB,SAAU,OACV,SAAU,WACV,WAAY,aACZ,YAAa,eACb,WAAY,cACZ,UAAW,YACX,WAAY,cACZ,gBAAiB,mBACjB,SAAU,WACV,WAAY,cACd,EAGaC,EAAgB,CAC3B,MAAO,EACP,OAAQ,EACR,QAAS,CACX,EAGaC,EAAW,CACtB,QAAS,EACT,OAAQ,EACR,MAAO,EACP,OAAQ,EACR,KAAM,EACN,MAAO,EACP,KAAM,EACN,UAAW,CACb,EAGaC,EAAa,CACxB,SAAU,WACV,aAAc,eACd,SAAU,UACZ,ECjDaC,GAAgB,CAE3B,OAAQ,mCACR,SAAU,QACV,YACG,OAAO,OAAW,IACf,GAAG,OAAO,SAAS,MAAM,iBACzB,yCAKN,QAA6C,kCAE7C,iBAAkB,4CAElB,SAAU,aAEV,YAAa,iBAEb,gBAAiB,yBAGjB,UAAW,CACT,SAAU,sBACV,eAAiBC,GACf,wBAAwBA,CAAY,mBACtC,QAAS,CAACC,EAAwBD,IAChC,aAAaC,CAAc,YAAYD,CAAY,IACrD,UAAW,CAACC,EAAwBD,EAAsBE,IACxD,aAAaD,CAAc,YAAYD,CAAY,cAAcE,CAAW,IAC9E,aAAc,wCACd,UAAW,qCACX,WAAY,sCACZ,mBAAoB,8CACpB,gBAAiB,8CACjB,qBAAsB,gDACtB,aAAc,yCAKhB,WAAY,CACV,SAAU,IACV,eAAgB,IAChB,mBAAoB,IACpB,kBAAmB,IACnB,mBAAoB,IACpB,eAAgB,IAChB,WAAY,IACZ,qBAAsB,IACtB,sBAAuB,IACvB,oBAAqB,IACrB,oBAAqB,IACrB,mBAAoB,IACpB,cAAe,IACf,eAAgB,IAChB,UAAW,IACX,eAAgB,IAChB,UAAW,IACX,YAAa,IACb,gBAAiB,IACjB,eAAgB,IAChB,eAAgB,IAChB,mBAAoB,IACpB,kBAAmB,IACnB,QAAS,IACT,iBAAkB,IAClB,YAAa,IACb,OAAQ,IACR,gBAAiB,IACjB,kBAAmB,IACnB,aAAc,IACd,QAAS,IACT,WAAY,IACZ,QAAS,KACT,gBAAiB,KACjB,WAAY,KACZ,kBAAmB,KAIrB,0BAA2B,CACzB,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,IACA,KACA,KACA,MAIF,cAAwB,CACtB,MAAO,CAAC,EAAE,KAAK,QAAU,KAAK,SAChC,EAGA,mBAAmBC,EAA8B,CAC/C,MAAO,cAAcA,EAAW,KAAK,GAAG,CAAC,EAC3C,CACF,EAGaC,EAAgB,CAC3B,gBAAiB,WACjB,eAAgB,WAChB,cAAe,UACf,OAAQ,WACR,UAAW,WACX,YAAa,SACb,UAAW,SACX,YAAa,WACb,MAAO,WACP,QAAS,WACT,MAAO,UACP,SAAU,WACV,MAAO,UACP,QAAS,UACT,YAAa,WACb,cAAe,WACf,OAAQ,WACR,OAAQ,WACR,UAAW,WACX,kBAAmB,WACnB,WAAY,SACd,EA0BaC,GAAqB,CAChC,QAAS,WACT,IAAK,WACL,MAAO,WACP,KAAM,WACN,OAAQ,UACR,OAAQ,WACR,UAAW,UACb,EAGaC,GAAc,CACzB,SAAU,WACV,WAAY,UACZ,SAAU,WACV,WAAY,WACZ,UAAW,UACX,SAAU,UAQZ,EA8BaC,GAAyB,CACpC,MAAO,UACP,QAAS,WACT,cAAe,WACf,iBAAkB,WAClB,gBAAiB,UACjB,UAAW,UACX,gBAAiB,WACjB,mBAAoB,WACpB,kBAAmB,UACnB,UAAW,UACX,gBAAiB,WACjB,cAAe,WACf,aAAc,WAGd,YAAa,WACb,WAAY,SACd,ECnOMC,GAAuB,UACvBC,GAAa,IACbC,GAAY,GACZC,GAAc,GACdC,GAAa,IAQnB,MAAMC,EAAuB,CACjB,cAAkC,KAM1C,MAAM,YAA4B,CAC9B,GAAI,MAAK,cAET,GAAI,CAEA,MAAMC,EAAc,MAAM,KAAK,sBAGzBC,EAAO,MAAM,KAAK,kBACxB,KAAK,cAAgB,MAAM,OAAO,OAAO,UACrC,CACI,KAAM,SACN,KAAAA,EACA,WAAYH,GACZ,KAAM,WAEVE,EACA,CACI,KAAMN,GACN,OAAQC,EAAA,EAEZ,GACA,CAAC,UAAW,SAAS,EAE7B,OAASO,EAAO,CACZ,MAAAjD,GAAS,kBAAmB,eAAgBiD,CAAK,EAC3C,IAAI,MAAM,uCAAuC,CAC3D,CACJ,CAKA,MAAM,QAAQC,EAA2C,CAGrD,GAFA,MAAM,KAAK,aAEP,CAAC,KAAK,cACN,MAAM,IAAI,MAAM,gCAAgC,EAGpD,GAAI,CAEA,MAAMC,EAAK,OAAO,gBAAgB,IAAI,WAAWR,EAAS,CAAC,EAIrDrC,EADU,IAAI,cACC,OAAO4C,CAAS,EAG/BE,EAAa,MAAM,OAAO,OAAO,QACnC,CACI,KAAMX,GACN,GAAAU,CAAA,EAEJ,KAAK,cACL7C,CAAA,EAIE0C,EAAO,MAAM,KAAK,kBAExB,MAAO,CACH,WAAY,KAAK,oBAAoBI,CAAU,EAC/C,GAAI,KAAK,oBAAoBD,CAAE,EAC/B,KAAM,KAAK,oBAAoBH,CAAI,EAE3C,OAASC,EAAO,CACZ,MAAAjD,GAAS,kBAAmB,kBAAmBiD,CAAK,EAC9C,IAAI,MAAM,wBAAwB,CAC5C,CACJ,CAKA,MAAM,QAAQI,EAA2C,CAGrD,GAFA,MAAM,KAAK,aAEP,CAAC,KAAK,cACN,MAAM,IAAI,MAAM,gCAAgC,EAGpD,GAAI,CAEA,MAAMD,EAAa,KAAK,oBAAoBC,EAAU,UAAU,EAC1DF,EAAK,KAAK,oBAAoBE,EAAU,EAAE,EAG1CC,EAAY,MAAM,OAAO,OAAO,QAClC,CACI,KAAMb,GACN,GAAAU,CAAA,EAEJ,KAAK,cACLC,CAAA,EAKJ,OADgB,IAAI,cACL,OAAOE,CAAS,CACnC,OAASL,EAAO,CACZ,MAAAjD,GAAS,kBAAmB,kBAAmBiD,CAAK,EAC9C,IAAI,MAAM,wBAAwB,CAC5C,CACJ,CAKA,MAAc,qBAA0C,CAEpD,MAAMM,EAAU,KAAK,uBAGrB,OAAO,OAAO,OAAO,UACjB,MACAA,EACA,SACA,GACA,CAAC,WAAW,EAEpB,CAOQ,sBAAmC,CAiBvC,MAAMC,EAhBU,CAEZ,UAAU,UACV,UAAU,SACV,UAAU,qBAAqB,YAAc,GAC7C,OAAO,OAAO,YAAc,GAC5B,OAAO,QAAQ,YAAc,GAC7B,OAAO,YAAY,YAAc,GACjC,IAAI,OAAO,oBAAoB,WAE/B,UAAU,SACV,UAAU,gBAAgB,YAAc,KAKnB,KAAK,GAAG,EAEjC,OADgB,IAAI,cACL,OAAOA,CAAQ,CAClC,CAKA,MAAc,iBAAuC,CACjD,MAAMC,EAAW,sBAEjB,GAAI,CAEA,MAAMC,EAAS,aAAa,QAAQD,CAAQ,EAC5C,GAAIC,EACA,OAAO,KAAK,oBAAoBA,CAAM,CAE9C,MAAY,CAEZ,CAGA,MAAMV,EAAO,OAAO,gBAAgB,IAAI,WAAWJ,EAAW,CAAC,EAE/D,GAAI,CAEA,aAAa,QAAQa,EAAU,KAAK,oBAAoBT,CAAI,CAAC,CACjE,MAAY,CACRjD,GAAQ,kBAAmB,qBAAqB,CACpD,CAEA,OAAOiD,CACX,CAKQ,oBAAoBW,EAA0C,CAClE,MAAMC,EAAQD,aAAkB,WAAaA,EAAS,IAAI,WAAWA,CAAM,EAC3E,IAAIE,EAAS,GACb,QAASC,EAAI,EAAGA,EAAIF,EAAM,WAAYE,IAClCD,GAAU,OAAO,aAAaD,EAAME,CAAC,CAAC,EAE1C,OAAO,KAAKD,CAAM,CACtB,CAKQ,oBAAoBE,EAA4B,CACpD,MAAMF,EAAS,KAAKE,CAAM,EACpBH,EAAQ,IAAI,WAAWC,EAAO,MAAM,EAC1C,QAASC,EAAI,EAAGA,EAAID,EAAO,OAAQC,IAC/BF,EAAME,CAAC,EAAID,EAAO,WAAWC,CAAC,EAElC,OAAOF,CACX,CAMA,UAAiB,CACb,KAAK,cAAgB,IACzB,CACJ,CAGO,MAAMI,GAAkB,IAAIlB,GC3O7BmB,GAAU,YACVC,GAAa,EAQbC,GAAwB,CAC5B,CACE,KAAM,WACN,QAAS,aAEX,CACE,KAAM,eACN,QAAS,OAEX,CACE,KAAM,OACN,QAAS,OAEX,CACE,KAAM,cACN,QAAS,KACT,QAAS,CACP,CAAE,KAAM,WAAY,QAAS,0BAC7B,CAAE,KAAM,aAAc,QAAS,oBAC/B,CAAE,KAAM,aAAc,QAAS,YAAY,CAC7C,EAEF,CACE,KAAM,WACN,QAAS,OAEX,CACE,KAAM,QACN,QAAS,OAEX,CACE,KAAM,uBACN,QAAS,OAEX,CACE,KAAM,kBACN,QAAS,MAEb,EAEA,MAAMC,EAAiB,CACb,GAAyB,KACzB,YAAoC,KAE5C,MAAM,MAAsB,CAC1B,GAAI,MAAK,GACT,OAAI,KAAK,YAAoB,KAAK,aAElC,KAAK,YAAc,IAAI,QAAQ,CAAC1D,EAASC,IAAW,CAClD,MAAMF,EAAU,UAAU,KAAKwD,GAASC,EAAU,EAElDzD,EAAQ,QAAU,IAAM,CACtBT,GAAS,YAAa,2BAA4BS,EAAQ,KAAK,EAC/DE,EAAOF,EAAQ,KAAK,CACtB,EAEAA,EAAQ,UAAY,IAAM,CACxBV,GAAQ,YAAa,+DAA+D,CAGtF,EAEAU,EAAQ,UAAY,IAAM,CACxB,KAAK,GAAKA,EAAQ,OAClB,MAAM4D,EAAa,MAAM,KAAK,KAAK,GAAG,gBAAgB,EACtD1E,GAAS,YAAa,aAAa,KAAK,GAAG,OAAO,gCAAiC0E,CAAU,EAC7F3D,EAAA,CACF,EAEAD,EAAQ,gBAAmB6D,GAAU,CACnC,MAAMtD,EAAMsD,EAAM,OAA4B,OACxCC,EAAaD,EAAM,WACnBE,EAAaF,EAAM,WACzBxE,GAAQ,YAAa,4BAA4ByE,CAAU,QAAQC,CAAU,EAAE,EAE/E,UAAWhD,KAAS2C,GAClB,GAAI,CAACnD,EAAG,iBAAiB,SAASQ,EAAM,IAAI,EAAG,CAC7C,MAAMiD,EAAczD,EAAG,kBAAkBQ,EAAM,KAAM,CACnD,QAASA,EAAM,QAChB,EAED,GAAIA,EAAM,QACR,UAAWkD,KAASlD,EAAM,QACxBiD,EAAY,YAAYC,EAAM,KAAMA,EAAM,QAASA,EAAM,OAAO,CAGtE,CAEJ,CACF,CAAC,EAEM,KAAK,YACd,CAEA,MAAc,OAA8B,CAE1C,GADA,MAAM,KAAK,OACP,CAAC,KAAK,GAAI,MAAM,IAAI,MAAM,0BAA0B,EACxD,OAAO,KAAK,EACd,CAGA,MAAM,IAAO7D,EAAmBS,EAAqC,CACnE,MAAMN,EAAK,MAAM,KAAK,QAEtB,OAAO,IAAI,QAAQ,CAACN,EAASC,IAAW,CAGtC,MAAMF,EAFcO,EAAG,YAAYH,EAAW,UAAU,EAC9B,YAAYA,CAAS,EACzB,IAAIS,CAAG,EAE7Bb,EAAQ,QAAU,IAAME,EAAOF,EAAQ,KAAK,EAC5CA,EAAQ,UAAY,IAAMC,EAAQD,EAAQ,MAAM,CAClD,CAAC,CACH,CAEA,MAAM,IAAOI,EAAmBa,EAAyB,CACvD,MAAMV,EAAK,MAAM,KAAK,QAEtB,OAAO,IAAI,QAAQ,CAACN,EAASC,IAAW,CACtC,MAAMgE,EAAc3D,EAAG,YAAYH,EAAW,WAAW,EAC3C8D,EAAY,YAAY9D,CAAS,EACzC,IAAIa,CAAK,EAEfiD,EAAY,WAAa,IAAMjE,EAAA,EAC/BiE,EAAY,QAAU,IAAMhE,EAAOgE,EAAY,KAAK,CACtD,CAAC,CACH,CAEA,MAAM,OAAO9D,EAAmBS,EAA4B,CAC1D,MAAMN,EAAK,MAAM,KAAK,QAEtB,OAAO,IAAI,QAAQ,CAACN,EAASC,IAAW,CAGtC,MAAMF,EAFcO,EAAG,YAAYH,EAAW,WAAW,EAC/B,YAAYA,CAAS,EACzB,OAAOS,CAAG,EAEhCb,EAAQ,QAAU,IAAME,EAAOF,EAAQ,KAAK,EAC5CA,EAAQ,UAAY,IAAMC,EAAA,CAC5B,CAAC,CACH,CAEA,MAAM,OAAUG,EAAiC,CAC/C,MAAMG,EAAK,MAAM,KAAK,QAEtB,OAAO,IAAI,QAAQ,CAACN,EAASC,IAAW,CAGtC,MAAMF,EAFcO,EAAG,YAAYH,EAAW,UAAU,EAC9B,YAAYA,CAAS,EACzB,SAEtBJ,EAAQ,QAAU,IAAME,EAAOF,EAAQ,KAAK,EAC5CA,EAAQ,UAAY,IAAMC,EAAQD,EAAQ,MAAM,CAClD,CAAC,CACH,CAEA,MAAM,MAAMI,EAAkC,CAC5C,MAAMG,EAAK,MAAM,KAAK,QAEtB,OAAO,IAAI,QAAQ,CAACN,EAASC,IAAW,CAGtC,MAAMF,EAFcO,EAAG,YAAYH,EAAW,WAAW,EAC/B,YAAYA,CAAS,EACzB,QAEtBJ,EAAQ,QAAU,IAAME,EAAOF,EAAQ,KAAK,EAC5CA,EAAQ,UAAY,IAAMC,EAAA,CAC5B,CAAC,CACH,CAEA,MAAM,cACJG,EACA+D,EACAlD,EACc,CACd,MAAMV,EAAK,MAAM,KAAK,QAEtB,OAAO,IAAI,QAAQ,CAACN,EAASC,IAAW,CAItC,MAAMF,EAHcO,EAAG,YAAYH,EAAW,UAAU,EAC9B,YAAYA,CAAS,EAC3B,MAAM+D,CAAS,EACb,OAAOlD,CAAK,EAElCjB,EAAQ,QAAU,IAAME,EAAOF,EAAQ,KAAK,EAC5CA,EAAQ,UAAY,IAAMC,EAAQD,EAAQ,MAAM,CAClD,CAAC,CACH,CAGA,MAAM,iBAAoBoE,EAA2D,CAKnF,OAJe,MAAM,KAAK,IACxB,WACAA,CAAA,IAEa,IACjB,CAEA,MAAM,iBAAoBA,EAAmBvE,EAAwC,CACnF,MAAM,KAAK,IAAI,WAAY,CAAE,UAAAuE,EAAW,KAAAvE,EAAM,CAChD,CAEA,MAAM,oBAAkD,CAKtD,OAJe,MAAM,KAAK,IACxB,eACA,aAEa,OACjB,CAEA,MAAM,mBAAmBwE,EAAgC,CACvD,MAAM,KAAK,IAAI,eAAgB,CAAE,IAAK,UAAW,QAAAA,EAAS,UAAW,KAAK,KAAI,CAAG,CACnF,CAEA,MAAM,eAA+B,CACnC,MAAM,KAAK,MAAM,UAAU,EAC3B,MAAM,KAAK,MAAM,cAAc,CACjC,CAGA,MAAM,eAKS,CACb,MAAMC,EAAS,MAAM,KAAK,IAAS,OAAQ,QAAQ,EAEnD,GAAKA,EAKL,IAAIA,EAAO,aAAeA,EAAO,aAAc,CAC7CjF,GAAQ,YAAa,mDAAmD,EAExE,GAAI,CAEF,aAAM,KAAK,cAAc,CACvB,YAAaiF,EAAO,YACpB,aAAcA,EAAO,aACrB,UAAWA,EAAO,UAClB,aAAcA,EAAO,aACtB,EAGM,CACL,YAAaA,EAAO,YACpB,aAAcA,EAAO,aACrB,UAAWA,EAAO,UAClB,aAAcA,EAAO,aAEzB,OAAS9B,EAAO,CACdjD,GAAS,YAAa,4BAA6BiD,CAAK,EAExD,MAAM,KAAK,YACX,MACF,CACF,CAGA,GAAI8B,EAAO,sBAAwBA,EAAO,sBACxC,GAAI,CAEF,MAAMC,EAAkB,KAAK,MAAMD,EAAO,oBAAoB,EACxDE,EAAmB,KAAK,MAAMF,EAAO,qBAAqB,EAE1DG,EAAc,MAAMlB,GAAgB,QAAQgB,CAAe,EAC3DG,EAAe,MAAMnB,GAAgB,QAAQiB,CAAgB,EAEnE,MAAO,CACL,YAAAC,EACA,aAAAC,EACA,UAAWJ,EAAO,UAClB,aAAcA,EAAO,aAEzB,OAAS9B,EAAO,CACdjD,GAAS,YAAa,4BAA6BiD,CAAK,EAExD,MAAM,KAAK,YACX,MACF,CAIFlD,GAAQ,YAAa,wCAAwC,EAC7D,MAAM,KAAK,YAEb,CAEA,MAAM,cAAcqF,EAKF,CAChB,GAAI,CAEF,MAAMC,EAAuB,MAAMrB,GAAgB,QAAQoB,EAAO,WAAW,EACvEE,EAAwB,MAAMtB,GAAgB,QAAQoB,EAAO,YAAY,EAE/E,MAAM,KAAK,IAAI,OAAQ,CACrB,IAAK,SACL,qBAAsB,KAAK,UAAUC,CAAoB,EACzD,sBAAuB,KAAK,UAAUC,CAAqB,EAC3D,UAAWF,EAAO,UAClB,aAAcA,EAAO,aACtB,CACH,OAASnC,EAAO,CACd,MAAAjD,GAAS,YAAa,4BAA6BiD,CAAK,EAClD,IAAI,MAAM,gDAAgD,CAClE,CACF,CAEA,MAAM,WAA2B,CAC/B,MAAM,KAAK,MAAM,MAAM,EAEvBe,GAAgB,UAClB,CAEA,MAAM,eAAe3F,EAA8B,CACjD,MAAM,KAAK,IAAI,OAAQ,CAAE,IAAK,cAAe,MAAOA,EAAO,UAAW,KAAK,KAAI,CAAG,CACpF,CAEA,MAAM,eAA6C,CAEjD,OADe,MAAM,KAAK,IAAoC,OAAQ,aAAa,IACpE,KACjB,CAGA,MAAM,gBAAwC,CAC5C,OAAO,KAAK,OAAmB,aAAa,CAC9C,CAEA,MAAM,cAAckH,EAAkC,CACpD,MAAM,KAAK,IAAI,cAAeA,CAAK,CACrC,CAEA,MAAM,iBAAiBC,EAA2B,CAChD,MAAM,KAAK,OAAO,cAAeA,CAAE,CACrC,CAGA,MAAM,mBAAiD,CAErD,OADe,MAAM,KAAK,IAAoC,kBAAmB,SAAS,IAC3E,KACjB,CAEA,MAAM,kBAAkBV,EAAgC,CACtD,MAAM,KAAK,IAAI,kBAAmB,CAAE,IAAK,UAAW,MAAOA,EAAS,CACtE,CAEA,MAAM,wBAAmD,CAEvD,OADe,MAAM,KAAK,IAAgC,uBAAwB,KAAK,IACxE,IACjB,CAEA,MAAM,uBAAuBxE,EAA0B,CACrD,MAAM,KAAK,IAAI,uBAAwB,CAAE,IAAK,MAAO,KAAAA,EAAM,CAC7D,CAOA,MAAM,WAAcgB,EAAqC,CAEvD,OADe,MAAM,KAAK,IAA+B,WAAYA,CAAG,IACzD,KACjB,CAEA,MAAM,WAAcA,EAAaI,EAAyB,CACxD,MAAM,KAAK,IAAI,WAAY,CAAE,IAAAJ,EAAK,MAAAI,EAAO,CAC3C,CAGA,MAAM,UAAaJ,EAAqC,CACtD,MAAMyD,EAAS,MAAM,KAAK,IAIvB,QAASzD,CAAG,EAEf,GAAKyD,EACL,IAAIA,EAAO,UAAY,KAAK,MAAO,CACjC,MAAM,KAAK,OAAO,QAASzD,CAAG,EAC9B,MACF,CAEA,OAAOyD,EAAO,MAChB,CAEA,MAAM,UAAazD,EAAaI,EAAU+D,EAA8B,CACtE,MAAM,KAAK,IAAI,QAAS,CACtB,IAAAnE,EACA,MAAAI,EACA,UAAW,KAAK,MAAQ+D,CAAA,CACzB,CACH,CAGA,MAAM,cAA0D,CAC9D,GAAI,YAAa,WAAa,aAAc,UAAU,QAAS,CAC7D,MAAMC,EAAW,MAAM,UAAU,QAAQ,WACzC,MAAO,CACL,MAAOA,EAAS,OAAS,EACzB,MAAOA,EAAS,OAAS,EAE7B,CACA,MAAO,CAAE,MAAO,EAAG,MAAO,EAC5B,CAGA,MAAM,mBAAmC,CACvC,MAAM,KAAK,MAAM,OAAO,CAC1B,CAGA,MAAM,UAA0B,CAC9B,MAAM1E,EAAK,MAAM,KAAK,QAChBqD,EAAa,MAAM,KAAKrD,EAAG,gBAAgB,EAEjD,UAAWH,KAAawD,EACtB,MAAM,KAAK,MAAMxD,CAAS,CAE9B,CAGA,MAAM,OAAuB,CACvB,KAAK,KACP,KAAK,GAAG,QACR,KAAK,GAAK,KACV,KAAK,YAAc,KAEvB,CAMA,MAAM,gBAAgC,CACpC,aAAM,KAAK,QACJ,IAAI,QAAQ,CAACH,EAASC,IAAW,CACtC,MAAMF,EAAU,UAAU,eAAewD,EAAO,EAChDxD,EAAQ,QAAU,IAAME,EAAOF,EAAQ,KAAK,EAC5CA,EAAQ,UAAY,IAAM,CACxBX,GAAQ,YAAa,+BAA+B,EACpDY,EAAA,CACF,CACF,CAAC,CACH,CACF,CAGO,MAAMM,GAAK,IAAIoD,GAGlB,OAAO,OAAW,KACpB,OAAO,iBAAiB,SAAU,IAAM,CACtCpD,GAAG,QAAQ,MAAM2E,GAAO3F,GAAS,YAAa,4BAA6B2F,CAAG,CAAC,CACjF,CAAC,4GC3bUC,GAAqB,CAChC,QAAS,EAET,sBAAuB,GACvB,gBAAiB,KACjB,yBAA0B,KAC1B,2BAA4B,KAC5B,2BAA4B,KAC5B,uBAAwB,KACxB,yBAA0B,KAE1B,6BAA8B,GAC9B,iCAAkC,GAClC,6BAA8B,GAC9B,6BAA8B,KAC9B,+BAAgC,GAChC,wCAAyC,GACzC,4CAA6C,GAC7C,wBAAyB,GAEzB,2BAA4B,KAC5B,oBAAqB,KACrB,2BAA4B,KAC5B,wBAAyB,KACzB,yCAA0C,KAC1C,2BAA4B,KAC5B,iBAAkB,KAClB,8BAA+B,KAC/B,yCAA0C,KAC1C,2BAA4B,KAE5B,eAAgB,EAChB,uBAAwB,CAC1B,EAGMC,OAAoC,IAAI,CAC5CD,GAAmB,sBACnBA,GAAmB,gBACnBA,GAAmB,yBACnBA,GAAmB,2BACnBA,GAAmB,2BACnBA,GAAmB,uBACnBA,GAAmB,wBACrB,CAAC,EAGKE,OAAwC,IAAI,CAChDF,GAAmB,6BACnBA,GAAmB,iCACnBA,GAAmB,6BACnBA,GAAmB,6BACnBA,GAAmB,+BACnBA,GAAmB,wCACnBA,GAAmB,4CACnBA,GAAmB,uBACrB,CAAC,EAGD,MAAMG,EAAe,CACX,YAAgC,QAAQ,UACxC,8BAAqD,IACrD,sBAAwB,EACxB,MAAQ,EAEC,UAAoC,CACnD,aAAgB,IAChB,UAAa,IACb,WAAc,IACd,mBAAsB,IACtB,iBAAoB,IACpB,qBAAwB,IACxB,gBAAmB,IACnB,aAAgB,IAChB,QAAW,IAGL,YAAYC,EAA0B,CAC5C,SAAW,CAAC1E,EAAKI,CAAK,IAAK,OAAO,QAAQ,KAAK,SAAS,EACtD,GAAIsE,EAAS,SAAS1E,CAAG,EAAG,OAAOI,EAErC,OAAO,KAAK,UAAU,OACxB,CAEA,MAAM,IAAOuE,EAA6BD,EAA8B,CACtE,KAAK,QAEL,MAAME,EAAY,SAAwB,CAExC,IAAIC,EACJ,GAAI,OAAO,UAAc,KAAe,aAAc,UACpD,GAAI,CAAEA,EAAW,MAAO,UAAkB,SAAS,QAAQ,QAAQ,CAAG,MAAQ,CAAE,CAGlF,GAAI,CAEF,MAAMC,EAAM,KAAK,MACXC,EAAc,OAAO,KAAK,KAAK,SAAS,EAAE,KAAKC,GAAKN,EAAS,SAASM,CAAC,CAAC,GAAK,UAC7EC,EAAmB,KAAK,0BAA0B,IAAIF,CAAW,GAAK,EAGtEG,EAAa,KAAK,IAAI,EAAG,IAAMJ,EAAM,KAAK,sBAAsB,EAEhEK,EAAe,KAAK,IAAI,EAAG,KAAK,YAAYT,CAAQ,GAAKI,EAAMG,EAAiB,EAChFG,EAAW,KAAK,IAAIF,EAAYC,CAAY,EAE9CC,EAAW,GAAG,MAAM,IAAI,QAAQC,GAAK,WAAWA,EAAGD,CAAQ,CAAC,EAGhE,MAAM3B,EAAS,MAAMkB,EAAA,EAGfW,EAAc,KAAK,MACzB,YAAK,sBAAwBA,EAC7B,KAAK,0BAA0B,IAAIP,EAAaO,CAAW,EAEpD7B,CACT,SACE,KAAK,QAEDoB,GAAU,MAAMA,EAAS,SAC/B,CACF,EAGMU,EAAc,KAAK,YAAY,KAAKX,EAAWA,CAAS,EAC9D,YAAK,YAAcW,EACZA,CACT,CAEA,eAAwB,CACtB,OAAO,KAAK,KACd,CACF,CAEA,MAAMC,EAAgB,CACZ,aAAe,GACf,eAA0C,KAC1C,QAAU,IAAIf,GACd,cAA2D,KAG3D,eAAiB,EACjB,iBAAmB,EACV,eAAiB,IAAS,IAC1B,uBAAyB,IAE1C,MAAc,WAAWgB,EAA6C,CACpE,MAAMC,EAAuB,CAC3B,YAAahF,GAAc,OAC3B,eAAgB,oBAGlB,GAAI+E,EAAc,CAChB,MAAM3B,EAAS,MAAMpE,GAAG,gBACxB,GAAIoE,EAEF,GAAIA,EAAO,UAAY,KAAK,MAAQ,IAAO,CAEzC,GADkB,MAAM,KAAK,qBACd,CACb,MAAM6B,EAAY,MAAMjG,GAAG,gBACvBiG,IACFD,EAAQ,cAAmB,UAAUC,EAAU,WAAW,GAE9D,CACAD,EAAQ,cAAmB,UAAU5B,EAAO,WAAW,EACzD,MACE4B,EAAQ,cAAmB,UAAU5B,EAAO,WAAW,EAI7D,CAEA,OAAO4B,CACT,CAEA,MAAc,sBAAsC,CAOlD,GAL8B,KAAK,MAAQ,KAAK,iBACpB,KAAK,wBAA0B,KAAK,eAAiB,IAC/E,KAAK,eAAiB,KAAK,IAAI,EAAG,KAAK,eAAiB,CAAC,GAGvD,KAAK,eAAiB,EAAG,CAE3B,MAAMN,EAAW,KAAK,IAAI,KAAK,eAAgB,KAAK,IAAI,EAAG,KAAK,cAAc,EAAI,GAAG,EAErF,MAAM,IAAI,QAAQhG,GAAW,WAAWA,EAASgG,CAAQ,CAAC,CAC5D,CACF,CAEA,MAAM,QACJV,EACAkB,EAAwB,GACZ,CACZ,KAAM,CAAE,OAAAC,EAAS,MAAO,KAAAC,EAAM,aAAAL,EAAe,GAAO,UAAAM,EAAY,IAAUH,EAE1E,OAAO,KAAK,QAAQ,IAAI,SAAY,CAClC,IAAII,EAAa,EACjB,MAAMC,EAAqBF,GAAcH,EAAe,mBAExD,OAAa,CAEX,MAAM,KAAK,uBAEX,MAAMM,EAAM,GAAGxF,GAAc,OAAO,GAAGgE,CAAQ,GACzCgB,EAAU,MAAM,KAAK,WAAWD,CAAY,EAE9CI,IAAW,OACbrH,GAAQ,MAAO,KAAKqH,CAAM,IAAInB,CAAQ,EAAE,EAExCrG,GAAS,MAAO,KAAKwH,CAAM,IAAInB,CAAQ,EAAE,EAG3C,MAAMyB,EAAiB,WAAW,IAAM,CACtCC,GAAc,WAAW,SAAS,CAChC,KAAM,UACN,QAAS,mEACT,SAAU,IACX,CACH,EAAG,IAAK,EAER,GAAI,CACF,MAAMC,EAAW,MAAM,MAAMH,EAAK,CAChC,OAAAL,EACA,QAAAH,EACA,KAAMI,EAAO,KAAK,UAAUA,CAAI,EAAI,OACpC,YAAa,OACd,EACD,aAAaK,CAAc,EAM3B,MAAMG,EAAkB5B,EAAS,SAAS,cAAc,GACtDA,EAAS,SAAS,kBAAkB,GACpCA,EAAS,SAAS,WAAW,EAE/B,GAAI2B,EAAS,QAAU,KAAOA,EAAS,QAAU,KAAO,CAACJ,GAAsBD,EAAa,EAAG,CAC7F,MAAMO,EAAQ,IAAO,KAAK,IAAI,EAAGP,CAAU,EAC3CvH,GAAQ,MAAO,4BAA4B4H,EAAS,MAAM,QAAQ3B,CAAQ,iBAAiB6B,CAAK,QAAS,CAAE,WAAAP,CAAA,CAAY,EACvH,MAAM,IAAI,QAAQ5G,GAAW,WAAWA,EAASmH,CAAK,CAAC,EACvDP,IACA,QACF,CAIA,GAAIK,EAAS,SAAW,KAAO,CAACC,GAAmB,CAACL,GAAsBD,EAAa,EAAG,CACxF,MAAMO,EAAQ,IAAO,KAAK,IAAI,EAAGP,CAAU,EAC3CvH,GAAQ,MAAO,yBAAyBiG,CAAQ,iBAAiB6B,CAAK,QAAS,CAAE,WAAAP,EAAY,EAC7F,MAAM,IAAI,QAAQ5G,GAAW,WAAWA,EAASmH,CAAK,CAAC,EACvDP,IACA,QACF,CAGA,GAAIK,EAAS,SAAW,IAAK,CAC3B,MAAMG,EAAa,SAASH,EAAS,QAAQ,IAAI,aAAa,GAAK,IAAK,EAAE,EAM1E,GALA7H,GAAQ,MAAO,sCAAsCgI,CAAU,MAAM,EACrE,KAAK,iBACL,KAAK,iBAAmB,KAAK,MAC7B,MAAM,IAAI,QAAQpH,GAAW,WAAWA,EAASoH,EAAa,GAAI,CAAC,EAE/DP,EAAoB,MAAM,IAAI,MAAM,mCAAmC,EAC3E,QACF,CAGA,IAAIjH,EACJ,GAAI,CACFA,EAAO,MAAMqH,EAAS,MACxB,OAASI,EAAG,CAEV,GAAIJ,EAAS,QAAU,IAAK,CAC1B,MAAMK,EAAW,IAAIC,GAAe,sBAAuB,GAAI,YAAajC,EAAU2B,EAAS,MAAM,EACrG,MAAIC,IACFI,EAAS,mBAAqB,IAE1BA,CACR,CACA,MAAMD,CACR,CAGA,GAAIzH,EAAK,YAAcsF,GAAmB,QAAS,CAOjD,IAHyBtF,EAAK,YAAcsF,GAAmB,wBAC7DtF,EAAK,YAAcsF,GAAmB,+BAEhB,CAAC2B,GAAsBD,EAAa,EAAG,CAC7D,MAAMO,EAAQ,IAAO,KAAK,IAAI,EAAGP,CAAU,EAC3CvH,GAAQ,MAAO,2BAA2BO,EAAK,SAAS,QAAQ0F,CAAQ,iBAAiB6B,CAAK,QAAS,CAAE,WAAAP,CAAA,CAAY,EACrH,MAAM,IAAI,QAAQ5G,GAAW,WAAWA,EAASmH,CAAK,CAAC,EACvDP,IACA,QACF,CAcA,IAXcK,EAAS,SAAW,KAAOrH,EAAK,YAAcsF,GAAmB,oBAAsBjG,GAAWK,IAC1G,MAAO,uBAAwB,CACnC,SAAAgG,EACA,UAAW1F,EAAK,UAChB,YAAaA,EAAK,YAClB,QAASA,EAAK,QACd,YAAaA,EAAK,YAClB,gBAAiBA,EAAK,gBACvB,EAGGwF,GAAqB,IAAIxF,EAAK,SAAS,EAAG,CAC5C,KAAK,iBACL,KAAK,iBAAmB,KAAK,MAC7B,MAAMoG,EAAWpG,EAAK,gBAAkB,EAAIA,EAAK,gBAAkB,IAAO,IAG1E,GAFAP,GAAQ,MAAO,oBAAoBO,EAAK,SAAS,cAAcoG,CAAQ,OAAO,EAC9E,MAAM,IAAI,QAAQhG,GAAW,WAAWA,EAASgG,CAAQ,CAAC,EACtDa,EAAoB,MAAM,IAAIU,GAAe3H,EAAK,QAASA,EAAK,UAAWA,EAAK,YAAa0F,EAAU2B,EAAS,MAAM,EAC1H,QACF,CAGA,GAAIrH,EAAK,YAAcsF,GAAmB,eAAgB,CACxD,KAAM,CAAE,cAAAsC,CAAA,EAAkBC,GAAa,WACvC,MAAKD,IACHnI,GAAQ,MAAO,kDAAkD,EAC7D,KAAK,eAAe,KAAK,cAAc,EAAI,GAG3C,IAAIkI,GAAe3H,EAAK,QAASA,EAAK,UAAWA,EAAK,YAAa0F,EAAU2B,EAAS,MAAM,CACpG,CAGA,GAAI9B,GAAiB,IAAIvF,EAAK,SAAS,GAAK,CAACiH,GAAsBR,GAE/C,MAAM,KAAK,qBACd,CAGZG,EAAe,mBAAqB,GACrC,QACF,CAIF,GAAI5G,EAAK,YAAc,MAAQA,EAAK,YAAc,KAChD,OAAOA,EAAK,SAId,MAAIA,EAAK,YAAcsF,GAAmB,2BACxC5F,GAAS,MAAO,yDAAyD,EAChEM,EAAK,YAAcsF,GAAmB,4BAC/C7F,GAAQ,MAAO,+BAA+B,EAG1C,IAAIkI,GACR3H,EAAK,SAAW,2BAChBA,EAAK,UACLA,EAAK,YACL0F,CAAA,CAEJ,CAGA,OAAI,KAAK,eAAiB,IACxB,KAAK,eAAiB,KAAK,MAAM,KAAK,eAAiB,CAAC,GAGnD1F,EAAK,QACd,OAAS2C,EAAO,CACd,GAAIA,aAAiBgF,GAAgB,MAAMhF,EAI3C,GAAIA,aAAiB,WAAa,CAACsE,GAAsBD,EAAa,EAAG,CACvEvH,GAAQ,MAAO,+BAAgC,CAAE,SAAAiG,EAAU,WAAAsB,EAAY,EACvE,MAAM,IAAI,QAAQ5G,GAAW,WAAWA,EAAS,GAAI,CAAC,EACtD4G,IACA,QACF,CAGA,MAAM,IAAIW,GACRhF,aAAiB,MAAQA,EAAM,QAAU,iBACzC,GACA,eACA+C,CAAA,CAEJ,CACF,CACF,EAAGA,CAAQ,CACb,CAEA,MAAM,IAAOA,EAAkBe,EAAe,GAAOqB,EAAW,EAAe,CAC7E,OAAO,KAAK,QAAWpC,EAAU,CAAE,OAAQ,MAAO,aAAAe,EAAc,SAAAqB,EAAU,CAC5E,CAEA,MAAM,KAAQpC,EAAkBoB,EAAeL,EAAe,GAAOqB,EAAW,EAAe,CAC7F,OAAO,KAAK,QAAWpC,EAAU,CAAE,OAAQ,OAAQ,KAAAoB,EAAM,aAAAL,EAAc,SAAAqB,EAAU,CACnF,CAGA,MAAM,qBAAuC,CAC3C,MAAM/J,EAAQ,OAAO,WAAa,OAAO,aACvC,KAAK,SAAS,SAAS,EAAE,EAAE,UAAU,EAAG,EAAE,EAAI,KAAK,SAAS,SAAS,EAAE,EAAE,UAAU,EAAG,EAAE,EAE1FyB,GAAQ,OAAQ,yBAA0B,CAAE,MAAAzB,EAAO,OAAQ,OAAO,SAAS,OAAQ,EAEnF,GAAI,CACF,MAAM2C,GAAG,eAAe3C,CAAK,EAE7B,MAAMgK,EAAW,MAAMrH,GAAG,gBACtBqH,IAAahK,EACfyB,GAAQ,OAAQ,2CAA4C,CAAE,MAAAzB,CAAA,CAAO,EAErE0B,GAAQ,OAAQ,kEAAmE,CAAE,SAAU1B,EAAO,OAAQgK,EAAU,CAE5H,OAAS1C,EAAK,CACZ3F,GAAS,OAAQ,oCAAqC2F,CAAG,CAC3D,CAEA,MAAM2C,EAAS,IAAI,gBAAgB,CACjC,UAAWtG,GAAc,SACzB,cAAe,OACf,aAAcA,GAAc,YAC5B,MAAA3D,EAGA,YAAa,UACd,EAED,MAAO,GAAG2D,GAAc,gBAAgB,IAAIsG,EAAO,UAAU,EAC/D,CAGA,MAAM,aAAaC,EAKhB,CACD,MAAMnB,EAAO,IAAI,gBAAgB,CAC/B,WAAY,qBACZ,KAAAmB,EACA,UAAWvG,GAAc,SACzB,aAAcA,GAAc,YAC7B,EAEK2F,EAAW,MAAM,MAAM3F,GAAc,SAAU,CACnD,OAAQ,OACR,QAAS,CACP,eAAgB,oCAChB,YAAaA,GAAc,QAE7B,KAAMoF,EAAK,UAAS,CACrB,EAED,GAAI,CAACO,EAAS,GAAI,CAChB,MAAM1E,EAAQ,MAAM0E,EAAS,OAC7B,MAAM,IAAIM,GAAe,4BAA4BhF,CAAK,GAAI,EAAG,YAAa,OAAO,CACvF,CAEA,MAAM3C,EAAO,MAAMqH,EAAS,OAGvBrH,EAAK,eACRP,GAAQ,MAAO,2EAA2E,EAG5F,MAAMqF,EAAS,CACb,YAAa9E,EAAK,aAClB,aAAcA,EAAK,eAAiB,GACpC,UAAWA,EAAK,WAChB,aAAcA,EAAK,eAGrB,aAAMU,GAAG,cAAc,CACrB,YAAaoE,EAAO,YACpB,aAAcA,EAAO,aACrB,UAAW,KAAK,MAAQA,EAAO,UAAY,IAC3C,aAAcA,EAAO,aACtB,EAEMA,CACT,CAGA,MAAM,oBAAuC,CAE3C,GAAI,KAAK,aACP,OAAO,KAAK,gBAAkB,QAAQ,QAAQ,EAAK,EAGrD,KAAK,aAAe,GACpB,KAAK,eAAiB,KAAK,iBAE3B,GAAI,CACF,OAAO,MAAM,KAAK,cACpB,SACE,KAAK,aAAe,GACpB,KAAK,eAAiB,IACxB,CACF,CAEA,MAAc,gBAAmC,CAC/C,MAAMA,EAAS,MAAMpE,GAAG,gBACxB,GAAI,CAACoE,GAAQ,aACX,OAAApF,GAAS,MAAO,wDAAwD,EAExE,MAAM,KAAK,qBACJ,GAGT,GAAI,CACF,MAAMoH,EAAO,IAAI,gBAAgB,CAC/B,WAAY,gBACZ,cAAehC,EAAO,aACtB,UAAWpD,GAAc,SACzB,aAAcA,GAAc,YAC7B,EAEK2F,EAAW,MAAM,MAAM3F,GAAc,SAAU,CACnD,OAAQ,OACR,QAAS,CACP,eAAgB,oCAChB,YAAaA,GAAc,QAE7B,KAAMoF,EAAK,UAAS,CACrB,EAED,GAAI,CAACO,EAAS,GAAI,CAEhB,IAAIa,EAAiB,KACrB,GAAI,CACFA,EAAY,MAAMb,EAAS,MAC7B,MAAQ,CAAE,CAGV,GAAIa,GAAW,QAAU,eAAgB,CACvC,MAAMC,EAAOD,EAAU,kBACvB,GAAIC,IAAS,iBACX,MAAA1I,GAAQ,MAAO,qDAAqD,EAC9D,IAAI,MAAM,iCAAiC,EAGnD,GAAI,CAAC,0BAA2B,wBAAyB,2BACvD,6BAA8B,6BAA8B,0BAA0B,SAAS0I,CAAI,EACnG,OAAAzI,GAAS,MAAO,wBAAwByI,CAAI,kBAAkB,EAC9D,MAAM,KAAK,qBACJ,EAEX,CAGA,GAAId,EAAS,SAAW,KAAOA,EAAS,SAAW,IACjD,OAAA3H,GAAS,MAAO,kDAAkD,EAClE,MAAM,KAAK,qBACJ,GAKT,GAAI2H,EAAS,QAAU,IACrB,MAAA5H,GAAQ,MAAO,uCAAuC4H,EAAS,MAAM,uBAAuB,EACtF,IAAI,MAAM,+BAA+BA,EAAS,MAAM,EAAE,EAIlE,OAAA3H,GAAS,MAAO,oCAAqC2H,EAAS,MAAM,EAEhEA,EAAS,QAAU,KAAOA,EAAS,OAAS,KAC9C,MAAM,KAAK,qBAEN,EACT,CAEA,MAAMrH,EAAO,MAAMqH,EAAS,OAItBe,EAAgB,MAAM1H,GAAG,gBACzB2H,EAAkBrI,EAAK,eAAiBoI,GAAe,aAE7D,OAAKC,GACH3I,GAAS,MAAO,2DAA2D,EAG7E,MAAMgB,GAAG,cAAc,CACrB,YAAaV,EAAK,aAClB,aAAcqI,GAAmB,GACjC,UAAW,KAAK,MAAQrI,EAAK,WAAa,IAC1C,aAAcA,EAAK,cACpB,EAEM,EACT,OAAS2C,EAAO,CAEd,GAAIA,aAAiB,UACnB,MAAAlD,GAAQ,MAAO,mEAAoEkD,CAAK,EAClFA,EAOR,GAHAjD,GAAS,MAAO,uBAAwBiD,CAAK,EAGzCA,aAAiB,OAASA,EAAM,QAAQ,SAAS,aAAa,EAChE,MAAMA,EAGR,aAAM,KAAK,qBACJ,EACT,CACF,CAGA,sBAAsB2F,EAA2C,CAC/D,KAAK,cAAgBA,CACvB,CAGQ,cAAqC,KAE7C,sBAAsBA,EAAqB,CACzC,KAAK,cAAgBA,CACvB,CAEA,MAAc,oBAAqB,CACjC7I,GAAQ,MAAO,wCAAwC,EACvD,MAAMiB,GAAG,YACL,KAAK,eACP,KAAK,eAET,CAGA,MAAM,iBAAoC,CACxC,MAAMoE,EAAS,MAAMpE,GAAG,gBACxB,OAAKoE,EAGDA,EAAO,UAAY,KAAK,MACnB,KAAK,qBAGP,GAPa,EAQtB,CAGA,MAAM,QAAwB,CAC5B,MAAMpE,GAAG,YACT,KAAK,eAAiB,CACxB,CAGA,MAAM,iBAA0C,CAE9C,OADe,MAAMA,GAAG,kBACT,cAAgB,IACjC,CAGA,kBAA0D,CACxD,MAAO,CACL,MAAO,KAAK,eACZ,WAAY,KAAK,QAAQ,eAAc,CAE3C,CAKA,MAAM,wBAAuD,CAC3D,MAAO,EACT,CAEA,MAAM,uBAAuB6H,EAA8C,CAEzE,MAAO,EACT,CACF,CAGO,MAAMZ,WAAuB,KAAM,CACjC,UACA,YACA,SACA,WACA,mBAA8B,GAErC,YAAYa,EAAiBC,EAAmBC,EAAqBhD,EAAmB,GAAIiD,EAAqB,EAAG,CAElH,IAAIC,EAAcJ,EACdC,IAAcnD,GAAmB,kBACnCmD,IAAcnD,GAAmB,0CACjCmD,IAAcnD,GAAmB,2BACjCsD,EAAc,gKACLH,IAAcnD,GAAmB,2BAC1CsD,EAAc,gFACLH,IAAcnD,GAAmB,2BAC1CsD,EAAc,gFACLH,IAAcnD,GAAmB,6BAC1CsD,EAAc,oFACLH,IAAcnD,GAAmB,iBAC1CsD,EAAc,yGAGhB,MAAMA,CAAW,EACjB,KAAK,UAAYH,EACjB,KAAK,YAAcC,EACnB,KAAK,SAAWhD,EAChB,KAAK,WAAaiD,EAClB,KAAK,KAAO,iBAGZtJ,GAAS,MAAO,iBAAiBoJ,CAAS,QAAQ/C,CAAQ,KAAK8C,CAAO,EAAE,CAC1E,CAGA,eAAyB,CACvB,OAAO,KAAK,YAAclD,GAAmB,0BAC/C,CAEA,aAAuB,CACrB,OAAOC,GAAiB,IAAI,KAAK,SAAS,CAC5C,CAEA,iBAA2B,CACzB,OAAOC,GAAqB,IAAI,KAAK,SAAS,GAAK,KAAK,YAAc,EACxE,CAEA,gBAA0B,CACxB,OAAO,KAAK,cAAgB,cAC9B,CACF,CAGO,MAAMqD,GAAY,IAAIrC,GC5tBhBqB,GAAe1I,GAAmBgC,IAAS,CACtD,gBAAiB,GACjB,UAAW,GACX,cAAe,GACf,OAAQ,KACR,WAAY,KACZ,iBAAmB2H,GAAS3H,EAAI,CAAE,gBAAiB2H,EAAM,EACzD,WAAaC,GAAY5H,EAAI,CAAE,UAAW4H,EAAS,EACnD,eAAiBnB,GAAkBzG,EAAI,CAAE,cAAAyG,EAAe,EACxD,UAAY9C,GAAW3D,EAAI,CAAE,OAAA2D,EAAQ,EACrC,cAAgBkE,GAAe7H,EAAI,CAAE,WAAA6H,EAAY,EACjD,OAAQ,MAAOC,EAAY,KAAU,CAEnC,GADA,MAAMJ,GAAU,SACZI,EAAW,CACb,KAAM,CAAE,GAAAvI,CAAA,EAAO,MAAAwI,GAAA,mBAAAxI,CAAA,QAAM,2BAAAyI,EAAA,EAAyC,UAAAzI,CAAA,WAC9D,MAAMA,EAAG,iBACT,aAAa,QACb,eAAe,OACjB,CACA0I,EAAgB,WAAW,QAC3BjI,EAAI,CAAE,gBAAiB,GAAO,OAAQ,KAAM,WAAY,KAAM,cAAe,GAAO,EACpF,OAAO,SAAS,KAAO,GACzB,CACF,EAAE,EAGWkI,GAAuB,CAClC,SAAU,WACV,kBAAmB,oBACnB,gBAAiB,iBACnB,EAgFaD,EAAkBjK,GAAqB,CAACgC,EAAKJ,KAAS,CACjE,WAAY,GACZ,oBAAqB,aAAa,QAAQ,wBAAwB,EAClE,qBAAsB,GACtB,mBAAoB,GACpB,eAAgB,GAChB,cAAe,GACf,SAAU,KACV,sBAAuB,KACvB,UAAW,GACX,YAAa,GACb,YAAa,KACb,wBAAyB,KACzB,oBAAqB,EACrB,kBAAmB,EACnB,uBAAwB,GACxB,4BAA6B,GAC7B,cAAe,EACf,iBAAkB,EAClB,cAAe,EACf,WAAY,CAAE,QAAS,EAAG,MAAO,GACjC,aAAc,CAAE,QAAS,EAAG,MAAO,GACnC,kBAAmB,EACnB,sBAAuB,EACvB,kBAAmB,KACnB,oBAAqB,IACrB,oBAAqB,IACrB,wBAAyB,IACzB,oBAAqB,IACrB,gBAAiB,KACjB,kBAAmB,KACnB,iBAAkB,IAAM,CACtB,GAAI,CACF,MAAMuI,EAAQ,aAAa,QAAQ,sBAAsB,EACzD,OAAOA,EAAQ,KAAK,MAAMA,CAAK,EAAI,EACrC,MAAY,CACV,MAAO,EACT,CACF,KAEA,cAAgBC,GAAe,CAC7B,MAAMC,EAAYzI,IAAM,oBAIxB,GAHAI,EAAI,CAAE,WAAAoI,EAAY,EAGd,EAAAC,GAAaD,EAAW,QAAUE,EAAE,cAAgBD,CAAS,IAK7DD,EAAW,OAAS,EAAG,CACzB,MAAMG,EAAUH,EAAW,CAAC,EAAE,YAC9BpI,EAAI,CAAE,oBAAqBuI,EAAS,EACpC,aAAa,QAAQ,yBAA0BA,CAAO,CACxD,CACF,EACA,qBAAuBxE,GAAO,CAC5B/D,EAAI,CAAE,oBAAqB+D,EAAI,EAC3BA,EAAI,aAAa,QAAQ,yBAA0BA,CAAE,EACpD,aAAa,WAAW,wBAAwB,CACvD,EACA,qBAAuByE,GAAcxI,EAAI,CAAE,kBAAmBwI,EAAW,EACzE,eAAiB3J,GAAS,CACxB,MAAMjC,EAAQgD,EAAA,EACR6I,EAAoB5J,EAAK,wBACzB6J,EAAmB9L,EAAM,wBAG/B,GAAI6L,GAAqBC,GAAoB,IAAI,KAAKD,CAAiB,EAAE,WAAa,IAAI,KAAKC,CAAgB,EAAE,UAC/G,OAAOR,GAAqB,gBAG9B,MAAMS,EAAkB,IAAI,IAAI/L,EAAM,eAAe,EAC/CgM,EAAkB,IAAI,IAAIhM,EAAM,eAAe,EAG/CiM,EAAgB,CAACC,EAA8BC,EAAiBC,IAAqC,CAkBzG,MAAMC,EAAa,CAAC,GAhBAH,EAAc,OAAOI,GAAQ,CAC/C,MAAMC,EAAaD,EAAK,eACxB,OAAKC,GAEDR,EAAgB,IAAIQ,CAAU,EACfP,EAAgB,IAAIO,CAAU,IAE9BJ,EALK,EAW1B,CAAC,CAGmC,EACpC,SAAW,CAACI,EAAYC,CAAQ,IAAKR,EAAgB,UACnD,GAAIQ,IAAaL,EAIf,GAHmBE,EAAW,UAAU5G,GAAKA,EAAE,iBAAmB8G,CAAU,IAGzD,GACjBR,EAAgB,OAAOQ,CAAU,EACjCP,EAAgB,OAAOO,CAAU,MAC5B,CAEL,MAAME,EAAYL,EAAkB,KAAK3G,GAAKA,EAAE,iBAAmB8G,CAAU,EACzEE,GAAWJ,EAAW,KAAKI,CAAS,CAC1C,CAIJ,OAAOJ,CACT,EAASK,EAAsD,GAC/D,OAAO,KAAKzK,EAAK,sBAAwB,EAAE,EAAE,QAAQ0K,GAAU,CAC7DD,EAAqBC,CAAM,EAAIV,EAAchK,EAAK,qBAAqB0K,CAAM,EAAGA,EAAQ3M,EAAM,qBAAqB2M,CAAM,GAAK,EAAE,CAClI,CAAC,EACD,MAAMC,EAAoD,GAC1D,OAAO,KAAK3K,EAAK,oBAAsB,EAAE,EAAE,QAAQ0K,GAAU,CAC3DC,EAAmBD,CAAM,EAAIV,EAAchK,EAAK,mBAAmB0K,CAAM,EAAGA,EAAQ3M,EAAM,mBAAmB2M,CAAM,GAAK,EAAE,CAC5H,CAAC,EACD,MAAME,EAAaZ,EAAchK,EAAK,eAAgB,QAASjC,EAAM,cAAc,EACnF,OAAAoD,EAAI,CACF,GAAGnB,EACH,qBAAsByK,EACtB,mBAAoBE,EACpB,eAAgBC,EAChB,gBAAAd,EACA,gBAAAC,EACA,wBAAyB/J,EAAK,yBAA2BjC,EAAM,wBAC/D,gBAAiBiC,EAAK,iBAAmBjC,EAAM,gBAC/C,kBAAmBiC,EAAK,mBAAqBjC,EAAM,kBACnD,YAAa,KAAK,KAAI,CACvB,EACMsL,GAAqB,QAC9B,EACA,WAAawB,GAAc1J,EAAI,CAAE,UAAA0J,EAAW,EAC5C,aAAeC,GAAgB3J,EAAI,CAAE,YAAA2J,EAAa,EAClD,mBAAoB,CAACR,EAAoBS,IAAmC5J,EAAIpD,IAAU,CACxF,cAAe,CACb,GAAGA,EAAM,cACT,CAACuM,CAAU,EAAG,CAAE,GAAGvM,EAAM,cAAcuM,CAAU,EAAG,GAAGS,CAAA,CAAQ,EAEjE,YAAa,KAAK,KAAI,EACtB,EACF,iBAAkB,CAACT,EAAoBU,EAAqBC,EAAkBC,EAAmBC,IAAsBhK,EAAIpD,GAAS,CAClI,MAAMqN,EAAWrN,EAAM,cAAcuM,CAAU,EAC/C,GAAI,CAACc,GAAY,CAACA,EAAS,QAAS,OAAOrN,EAE3C,MAAMsN,EAAa,CAAC,GAAGD,EAAS,OAAO,EACjCE,EAAOD,EAAW,UAAUE,GAAKA,EAAE,cAAgBP,CAAW,EAEpE,OAAIM,IAAS,GACXD,EAAWC,CAAI,EAAI,CACjB,GAAGD,EAAWC,CAAI,EAClB,SAAAL,EACA,UAAW,GACX,SAAUC,GAAYG,EAAWC,CAAI,EAAE,SACvC,SAAUH,GAAYE,EAAWC,CAAI,EAAE,UAIrCN,EAAcK,EAAW,SAC3BA,EAAWL,CAAW,EAAI,CACxB,GAAGK,EAAWL,CAAW,EACzB,SAAAC,EACA,UAAW,GACX,SAAUC,GAAYG,EAAWL,CAAW,EAAE,SAC9C,SAAUG,GAAYE,EAAWL,CAAW,EAAE,WAK7C,CACL,cAAe,CACb,GAAGjN,EAAM,cACT,CAACuM,CAAU,EAAG,CAAE,GAAGc,EAAU,QAASC,CAAA,CAAW,EAEnD,YAAa,KAAK,KAAI,CAE1B,CAAC,EACD,kBAAmB,CAACf,EAAYC,IAAa,CAC3C,MAAMT,EAAkB,IAAI,IAAI/I,EAAA,EAAM,eAAe,EAC/CgJ,EAAkB,IAAI,IAAIhJ,EAAA,EAAM,eAAe,EACrD+I,EAAgB,IAAIQ,CAAU,EAC1BC,GAAUR,EAAgB,IAAIO,EAAYC,CAAQ,EACtDpJ,EAAI,CAAE,gBAAA2I,EAAiB,gBAAAC,EAAiB,YAAa,KAAK,MAAO,CACnE,EACA,qBAAsB,CAACO,EAAYkB,EAAU,GAAOC,EAAU,KAAU,CACtE,MAAM3B,EAAkB,IAAI,IAAI/I,EAAA,EAAM,eAAe,EAC/CgJ,EAAkB,IAAI,IAAIhJ,EAAA,EAAM,eAAe,EAC/C2K,EAAsB,IAAI,IAAI3K,EAAA,EAAM,mBAAmB,EACvD4K,EAAkB,IAAI,IAAI5K,EAAA,EAAM,eAAe,EACjDyK,GACFE,EAAoB,IAAIpB,CAAU,EAClCqB,EAAgB,OAAOrB,CAAU,GACxBmB,IACTE,EAAgB,IAAIrB,CAAU,EAC9BR,EAAgB,OAAOQ,CAAU,EACjCP,EAAgB,OAAOO,CAAU,GAEnCnJ,EAAI,CAAE,gBAAA2I,EAAiB,gBAAAC,EAAiB,oBAAA2B,EAAqB,gBAAAC,EAAiB,YAAa,KAAK,MAAO,CACzG,EACA,wBAA0BrB,GAAenJ,EAAKpD,GAAU,CACtD,MAAM6N,EAAa,IAAI,IAAI7N,EAAM,mBAAmB,EACpD,OAAA6N,EAAW,OAAOtB,CAAU,EACrB,CAAE,oBAAqBsB,CAAA,CAChC,CAAC,EACD,oBAAsBtB,GAAenJ,EAAKpD,GAAU,CAClD,MAAM8N,EAAS,IAAI,IAAI9N,EAAM,eAAe,EAC5C,OAAA8N,EAAO,OAAOvB,CAAU,EACjB,CAAE,gBAAiBuB,CAAA,CAC5B,CAAC,EACD,qBAAsB,IAAM,CAC1B,MAAM9N,EAAQgD,EAAA,EACd,OAAOhD,EAAM,WAAW,QAAU0L,EAAE,cAAgB1L,EAAM,mBAAmB,CAC/E,EACA,gBAAiB,IAAM,CACrB,MAAMA,EAAQgD,EAAA,EACd,MAAO,CAAC,GAAGhD,EAAM,eAAgB,GAAG,OAAO,OAAOA,EAAM,oBAAoB,EAAE,OAAQ,GAAG,OAAO,OAAOA,EAAM,kBAAkB,EAAE,MAAM,CACzI,EACA,mBAAqB+N,GAAY,CAC/B,MAAMC,EAAU,CAAE,GAAGhL,EAAA,EAAM,gBAAiB,CAAC+K,EAAQ,EAAE,EAAGA,CAAA,EAC1D,aAAa,QAAQ,uBAAwB,KAAK,UAAUC,CAAO,CAAC,EACpE5K,EAAI,CAAE,gBAAiB4K,EAAS,CAClC,EACA,qBAAuB7G,GAAO,CAC5B,MAAM6G,EAAU,CAAE,GAAGhL,EAAA,EAAM,iBAC3B,OAAOgL,EAAQ7G,CAAE,EACjB,aAAa,QAAQ,uBAAwB,KAAK,UAAU6G,CAAO,CAAC,EACpE5K,EAAI,CAAE,gBAAiB4K,EAAS,CAClC,EACA,MAAO,IAAM,CACX,aAAa,WAAW,wBAAwB,EAChD5K,EAAI,CACF,WAAY,GAAI,oBAAqB,KAAM,qBAAsB,GAAI,mBAAoB,GAAI,eAAgB,GAC7G,cAAe,GAAI,SAAU,KAAM,sBAAuB,KAAM,UAAW,GAAO,YAAa,GAAO,YAAa,KACnH,wBAAyB,KAAM,oBAAqB,IAAO,oBAAqB,IAAO,wBAAyB,IAAO,oBAAqB,IAAO,kBAAmB,KACtK,gBAAiB,KAAM,kBAAmB,KAC3C,CACH,EACA,iBAAkB,SAAY,CAC5B,GAAI,CACF,MAAM6K,EAAS,MAAMC,GAAY,mBAAmB,EACpD,GAAID,EACF,OAAA7K,EAAI,CAAE,GAAG6K,EAAQ,UAAW,GAAO,EAC5B,EAEX,OAASvE,EAAG,CACVhI,GAAQ,eAAgB,0BAA2BgI,CAAC,CACtD,CACA,MAAO,EACT,CACF,EAAE,EAuBWyE,GAAa/M,GAAiBgC,IAAS,CAClD,WAAY,SACZ,YAAa,GACb,YAAa,YACb,eAAgB,KAChB,aAAc,GACd,eAAgB,OAChB,cAAe,GACf,eAAgB,OAChB,iBAAkB,KAElB,OAASgL,GAAQhL,EAAI,CAAE,WAAYgL,EAAK,EACxC,eAAiBC,GAASjL,EAAI,CAAE,YAAaiL,EAAM,EACnD,eAAgB,CAACC,EAAMC,EAAU,OAASnL,EAAI,CAAE,YAAakL,EAAM,eAAgBC,EAAS,EAC5F,gBAAkBC,GAASpL,EAAI,CAAE,aAAcoL,EAAM,EACrD,sBAAwBC,GAAW,CACjCrL,EAAI,CAAE,eAAgBqL,EAAQ,eAAgBA,EAAQ,EACtD,WAAW,IAAMrL,EAAI,CAAE,eAAgB,OAAQ,eAAgB,OAAQ,EAAG,IAAI,CAChF,EACA,iBAAmBsL,GAAkBtL,EAAI,CAAE,cAAAsL,EAAe,EAC1D,oBAAsBC,GAAqBvL,EAAI,CAAE,iBAAAuL,EAAkB,CACrE,EAAE,EAeWC,GAAmBxN,GAAuBgC,IAAS,CAC9D,SAAU,GACV,UAAW,GACX,gBAAiB,EACjB,MAAO,KACP,YAAa,KACb,UAAYyL,GAAazL,EAAI,CAAE,SAAAyL,EAAU,YAAa,KAAK,MAAO,EAClE,WAAa/B,GAAc1J,EAAI,CAAE,UAAA0J,EAAW,EAC5C,YAAcgC,GAAoB1L,EAAI,CAAE,gBAAA0L,EAAiB,EACzD,SAAWlK,GAAUxB,EAAI,CAAE,MAAAwB,EAAO,CACpC,EAAE,EAgCWmK,GAAmB3N,GAAsB,CAACgC,EAAKJ,KAAS,CACnE,gBAAiB,OACjB,aAAc,GACd,gBAAiB,GACjB,gBAAiB,KAAK,SACtB,aAAc,GACd,SAAU,MACV,WAAY,KACZ,UAAW,GACX,gBAAiB,GACjB,iBAAmBgM,GAAQhM,IAAM,gBAAgB,SAASgM,CAAG,EAC7D,aAAc,GACd,QAAS,GACT,cAAe,GAEf,mBAAqBC,GAAoB7L,EAAI,CAAE,gBAAA6L,EAAiB,EAChE,gBAAkBC,GAAiB9L,EAAI,CAAE,aAAA8L,EAAc,EACvD,mBAAqBC,GAAoB/L,EAAI,CAAE,gBAAA+L,EAAiB,EAChE,sBAAuB,IAAM/L,EAAIpD,IAAU,CAAE,gBAAiB,CAACA,EAAM,iBAAkB,EACvF,gBAAiB,IAAMoD,EAAI,CAAE,gBAAiB,KAAK,SAAU,EAC7D,mBAAoB,IAAMA,EAAIpD,IAAU,CAAE,aAAc,CAACA,EAAM,cAAe,EAC9E,YAAcoP,GAAahM,EAAI,CAAE,SAAAgM,EAAU,EAC3C,cAAgBC,GAAejM,EAAI,CAAE,WAAAiM,EAAY,EACjD,aAAeC,GAAclM,EAAI,CAAE,UAAAkM,EAAW,EAC9C,mBAAqBC,GAAoBnM,EAAI,CAAE,gBAAAmM,EAAiB,EAChE,mBAAoB,IAAMnM,EAAIpD,IAAU,CAAE,aAAc,CAACA,EAAM,cAAe,EAC9E,cAAe,IAAMoD,EAAIpD,IAAU,CAAE,QAAS,CAACA,EAAM,SAAU,EAC/D,oBAAqB,IAAMoD,EAAIpD,IAAU,CAAE,cAAe,CAACA,EAAM,eAAgB,CACnF,EAAE,EASWqJ,GAAgBjI,GAAoBgC,IAAS,CACxD,OAAQ,GACR,SAAWoM,GAAU,CACnB,MAAMrI,EAAK,KAAK,SAAS,SAAS,EAAE,EAAE,UAAU,EAAG,CAAC,EAC9CsI,EAAW,CAAE,GAAGD,EAAO,GAAArI,EAAI,UAAW,KAAK,KAAI,EACrD/D,EAAKpD,IAAW,CAAE,OAAQ,CAAC,GAAGA,EAAM,OAAQyP,CAAQ,GAAI,EACxD,WAAW,IAAM,CACfrM,EAAKpD,IAAW,CAAE,OAAQA,EAAM,OAAO,OAAQ0P,GAAMA,EAAE,KAAOvI,CAAE,GAAI,CACtE,EAAGqI,EAAM,UAAY,GAAI,CAC3B,EACA,YAAcrI,GAAO/D,EAAKpD,IAAW,CAAE,OAAQA,EAAM,OAAO,OAAQ0P,GAAMA,EAAE,KAAOvI,CAAE,GAAI,CAC3F,EAAE,EAcWwI,GAAsBvO,GAA0BgC,IAAS,CACpE,OAAQ,GACR,UAAW,GACX,MAAO,KACP,WAAY,SAAY,CACtBA,EAAI,CAAE,UAAW,GAAM,EACvB,GAAI,CACF,MAAMwM,EAAS,MAAM1B,GAAqB,kBAAkB,GAAK,GACjE9K,EAAI,CAAE,OAAAwM,EAAQ,UAAW,GAAO,CAClC,MAAY,CACVxM,EAAI,CAAE,MAAO,wBAAyB,UAAW,GAAO,CAC1D,CACF,EACA,SAAU,MAAO8D,GAAU,CACzB9D,EAAIpD,GAAS,CACX,MAAM6P,EAAO,CAAC,GAAG7P,EAAM,OAAQkH,CAAK,EACpC4I,UAAO,mBAAoBD,CAAI,EACxB,CAAE,OAAQA,CAAA,CACnB,CAAC,CACH,EACA,YAAa,MAAO1I,GAAO,CACzB/D,EAAIpD,GAAS,CACX,MAAM6P,EAAO7P,EAAM,OAAO,OAAO+P,GAAKA,EAAE,KAAO5I,CAAE,EACjD2I,UAAO,mBAAoBD,CAAI,EACxB,CAAE,OAAQA,CAAA,CACnB,CAAC,CACH,EACA,WAAa/C,GAAc1J,EAAI,CAAE,UAAA0J,EAAW,EAC5C,UAAY8C,GAAWxM,EAAI,CAAE,OAAAwM,EAAQ,CACvC,EAAE,EAYWI,GAAoB5O,GAAwBgC,IAAS,CAChE,WAAY,GACZ,aAAc,KACd,YAAa,GACb,YAAc6M,GAAe7M,EAAI,CAAE,WAAA6M,EAAY,EAC/C,gBAAkBC,GAAiB9M,EAAI,CAAE,aAAA8M,EAAc,EACvD,WAAaC,GAAS/M,EAAIpD,IAAU,CAClC,YAAa,CAAE,GAAGA,EAAM,YAAa,CAACmQ,CAAI,EAAG,CAACnQ,EAAM,YAAYmQ,CAAI,EAAE,EACtE,CACJ,EAAE,6QCzlBIC,GAAe,sCACfC,GAA2B,GAAGD,EAAY,8CAC1CE,GAAsB,GAAGF,EAAY,sCAU3C,MAAMG,EAAe,CACX,aAA0C,KAC1C,SAAW,GAKnB,MAAM,MAAyB,CAC7B,GAAI,KAAK,SAAU,MAAO,GAE1B,GAAI,CAIF,MAAMC,GADc,MADA,MAAM,MAAMF,EAAmB,GACb,QACN,aAG1BG,EAAgB,MAAM9N,GAAG,oBAC/B,IAAIV,EAAO,MAAMU,GAAG,yBAEpB,MAAI,CAACV,GAAQwO,IAAkBD,GAC7B/O,GAAQ,UAAW,oBAAoB+O,CAAW,aAAaC,GAAiB,MAAM,GAAG,EAGzFxO,EAAO,MADU,MAAM,MAAMoO,EAAwB,GAC/B,OAEtB,MAAM1N,GAAG,uBAAuBV,CAAK,EACrC,MAAMU,GAAG,kBAAkB6N,CAAW,GAEtClP,GAAS,UAAW,gCAAgCmP,CAAa,GAAG,EAGtE,KAAK,aAAexO,EACpB,KAAK,SAAW,GACT,EACT,OAAS,EAAG,CACV,OAAAN,GAAS,UAAW,wCAAyC,CAAC,EACvD,EACT,CACF,CAKA,eAAe+O,EAA6B,CAC1C,OAAK,KAAK,cACI,KAAK,aAAaA,CAAI,GACtB,aAAe,IAC/B,CAKA,YAAYA,EAA0B,CACpC,OAAK,KAAK,cACH,KAAK,aAAaA,CAAI,GAAK,IACpC,CACF,CAEO,MAAMC,GAAiB,IAAIJ,GC1E5BK,GAAqC,CAEvC,mCAAoC,YACpC,iCAAoC,kBACpC,kCAAmC,YACnC,kCAAmC,kBACnC,gCAAmC,eACnC,UAAa,aACb,YAAa,WAIb,gCAAmC,qBACnC,kCAAmC,sBACnC,UAAa,qBACb,UAAa,qBAGb,+BAAkC,kBAClC,eAAgB,oBAChB,SAAY,kBAChB,EAKO,SAASC,GAA2BC,EAA2C,CAClF,GAAI,CAACA,EAAe,OAGpB,MAAMJ,EAAOI,EAAc,MAAM,GAAG,EAAE,OAAO,MAAM,GAAG,EAAE,CAAC,EACzD,GAAKJ,EAGL,IAAIE,GAAWF,CAAI,EAAG,OAAOE,GAAWF,CAAI,EAG5C,SAAW,CAACzN,EAAK8N,CAAI,IAAK,OAAO,QAAQH,EAAU,EAC/C,GAAIF,EAAK,SAASzN,CAAG,GAAKA,EAAI,SAASyN,CAAI,EACvC,OAAOK,EAKnB,CAiBO,SAASC,GAAgBvK,EAAsC,CAClE,OAAIA,IAAY,OAAkB,GAC3BA,EAAU,EACrB,CC1DA,MAAMwK,GAAM/O,GAAa,UAAU,EAG7BgP,GAA+C,CACnD,SAAY,WACZ,SAAY,WACZ,UAAa,UACb,UAAa,UACb,UAAa,WACb,WAAc,UACd,WAAc,WACd,WAAc,WACd,WAAc,WACd,WAAc,UACd,WAAc,WACd,WAAc,WACd,WAAc,UACd,WAAc,WACd,aAAc,WACd,aAAc,UACd,aAAc,WACd,aAAc,WACd,aAAc,WACd,aAAc,UACd,aAAc,UACd,aAAc,WACd,aAAc,UACd,aAAc,UAChB,EAGA,SAASC,GAAeT,EAAkC,CACxD,GAAIA,IAAS,UAAW,MAAO,GAC/B,GAAIA,IAAS,WAAY,MAAO,GAChC,GAAIA,IAAS,WAAY,MAAO,EAElC,CAuCA,MAAMU,GAAkB,CACtB,iCACA,mCACA,wBACA,yBACA,8BACA,+BACA,8BACA,kCACA,2BAEA,+BACA,gCACA,+BAEA,oCACA,4BAEA,+BAEA,gCACA,yCAEA,gCAEA,0CACA,sCAEA,0BAEA,mCACF,EAMMC,GAAsD,CAE1D,WAAY,EACZ,WAAY,EACZ,WAAY,EACZ,UAAW,EACX,WAAY,EAGZ,WAAY,EACZ,WAAY,EACZ,WAAY,EACZ,UAAW,EACX,WAAY,EAGZ,WAAY,EACZ,WAAY,EACZ,WAAY,EACZ,WAAY,EACZ,WAAY,EAEZ,WAAY,CACd,EAEMC,GAA8C,CAClD,WAAY,EACZ,WAAY,EACZ,WAAY,EACZ,WAAY,EACZ,UAAW,EACX,WAAY,EACZ,WAAY,CACd,EAEO,MAAMC,EAAgB,CACnB,aAAoE,GACpE,oBAAgF,GAChF,YAAqC,GACrC,UAAY,GACZ,YAAoC,KAG5C,MAAM,gBAAqE,CACzE,GAAI,CACF,MAAMC,EAAe,MAAM1G,GAAU,IACnCnH,GAAc,UAAU,UAGpB8N,EAAiB,MAAM9O,GAAG,qBAChC,IAAI+O,EAAc,CAACD,GAAkBA,IAAmBD,EAAa,QAQrE,GANKE,GACHjQ,GAAQ,WAAY,wBAAwBgQ,CAAc,qCAAqC,EAK7F,CAACC,EAAa,CAChB,MAAMC,EAAkBH,EAAa,+BAA+B,GACpE,UAAWhL,KAAa4K,GAAiB,CAEvC,GAAI,CAACO,EAAgBnL,CAAS,EAAG,SAGjC,GAAI,CADc,MAAM7D,GAAG,iBAAiB6D,CAAS,EACrC,CACd/E,GAAQ,WAAY,yBAAyB+E,CAAS,yBAAyB,EAC/EkL,EAAc,GACd,KACF,CACF,CACF,CAEA,OAAIA,GAAeD,IAAmBD,EAAa,QACjD/P,GAAQ,WAAY,6BAA6BgQ,GAAkB,MAAM,gDAAgD,EAChHC,EACTjQ,GAAQ,WAAY,6BAA6B+P,EAAa,OAAO,cAAcC,GAAkB,MAAM,GAAG,EAE9GnQ,GAAS,WAAY,2BAA2BmQ,CAAc,GAAG,EAG5D,CACL,YAAAC,EACA,QAASF,EAAa,QAE1B,OAAS5M,EAAO,CACd,OAAAqM,GAAI,MAAM,oCAAqCrM,CAAK,EAC7C,CAAE,YAAa,GAAM,QAAS,GACvC,CACF,CAGA,MAAM,KACJgN,EACe,CACf,GAAI,KAAK,YACP,OAAO,KAAK,YAGd,KAAK,YAAc,KAAK,OAAOA,CAAU,EAEzC,GAAI,CACF,MAAM,KAAK,WACb,SACE,KAAK,YAAc,IACrB,CACF,CAEA,MAAc,OACZA,EACe,CACf,GAAI,MAAK,UACT,MAAK,UAAY,GAEjB,GAAI,CACF,KAAM,CAAE,YAAAF,EAAa,QAAAjL,CAAA,EAAY,MAAM,KAAK,iBAExCiL,GACFT,GAAI,KAAK,oCAAqCxK,CAAO,EACrD,MAAM,KAAK,iBAAiBmL,CAAU,IAEtCX,GAAI,KAAK,6BAA6B,EACtC,MAAM,KAAK,cAAcW,CAAU,GAIrCjB,GAAe,MACjB,SACE,KAAK,UAAY,EACnB,EACF,CAEA,MAAa,wBAAwC,CACnD,MAAMhO,GAAG,eACX,CAEA,MAAa,iBACXiP,EACe,CAIf,OAAK,UAAU,MAKR,UAAU,MAAM,QAAQ,oBAAqB,SAAY,CAE9D,KAAM,CAAE,YAAAF,CAAA,EAAgB,MAAM,KAAK,iBACnC,GAAI,CAACA,EAAa,CAChBT,GAAI,KAAK,0CAA0C,EACnD,MAAM,KAAK,cAAcW,CAAU,EACnC,MACF,CAEA,OAAO,KAAK,mBAAmBA,CAAU,CAC3C,CAAC,EAbQ,KAAK,mBAAmBA,CAAU,CAc7C,CAEA,MAAc,mBACZA,EACe,CACf,MAAMJ,EAAe,MAAM1G,GAAU,IACnCnH,GAAc,UAAU,UAGpBkO,EAAiBL,EAAa,+BAA+B,GAGnE,IAAIM,EAAkB,EACtB,MAAMC,EAAcX,GAAgB,OAE9BY,EAAgBZ,GAAgB,IAAI,MAAO5K,EAAWyL,IAAW,CACrE,MAAMC,EAAOL,EAAerL,CAAS,EACrC,GAAI,CAAC0L,EAAM,OAEX,MAAMC,EAAe,CACnB,MAAMX,EAAa,QAAQ,QAAQ,gBAAiB,EAAE,CAAC,GACvD,OAAO,KAAK,SAAS,SAAS,EAAE,EAAE,UAAU,CAAC,CAAC,GAC9C,UAAU,KAAK,KAAK,IAGtB,IAAIY,EAAiB,KACjBnQ,EAAY,KAGhB,UAAWoQ,KAAUF,EACnB,GAAI,CACF,MAAMhJ,EAAM,GAAGxF,GAAc,eAAe,GAAGuO,CAAI,GAAGG,CAAM,GACtD/I,EAAW,MAAM,MAAMH,CAAG,EAEhC,GAAI,CAACG,EAAS,GACZ,MAAM,IAAI,MAAM,sBAAsB9C,CAAS,aAAa8C,EAAS,MAAM,GAAG,EAIhF,GADArH,EAAO,MAAMqH,EAAS,OAClBrH,GAAQ,OAAOA,GAAS,SAAU,KACxC,OAAS2C,EAAO,CACdwN,EAAYxN,EACZqM,GAAI,KAAK,sBAAsBzK,CAAS,UAAU6L,CAAM,KAAK,CAC/D,CAGF,GAAI,CAACpQ,EACH,MAAMmQ,GAAa,IAAI,MAAM,sBAAsB5L,CAAS,qBAAqB,EAInFvE,EAAO,KAAK,UAAUuE,EAAWvE,CAAI,EAGrC,MAAMU,GAAG,iBAAiB6D,EAAWvE,CAAW,EAGhD,KAAK,aAAauE,CAAS,EAAIvE,EAE/B6P,IACA,MAAMQ,EAAYR,EAAkBC,EAAe,IACnDH,IAAapL,EAAW8L,CAAQ,EAGhCrB,GAAI,KAAK,gCAAgCa,CAAe,IAAIC,CAAW,MAAMvL,CAAS,KAAK,OAAO,KAAKvE,CAAI,EAAE,MAAM,WAAW,CAChI,CAAC,EAED,GAAI,CACF,MAAM,QAAQ,IAAI+P,CAAa,EAG/B,MAAMrP,GAAG,mBAAmB6O,EAAa,OAAO,EAChDI,IAAa,WAAY,GAAG,EAG5BX,GAAI,QAAQ,+BAA+Bc,CAAW,gBAAgB,EACtE,KAAK,4BACP,OAASnN,EAAO,CACd,MAAAqM,GAAI,MAAM,0CAA2CrM,CAAK,EACpDA,CACR,CACF,CAEQ,UAAU2N,EAAuBC,EAAiD,CAExF,OAAOA,CACT,CAEA,MAAc,cACZZ,EACe,CACf,MAAMG,EAAcX,GAAgB,OAC9BI,EAAe,MAAM1G,GAAU,IACnCnH,GAAc,UAAU,UAG1B,QAAS8B,EAAI,EAAGA,EAAI2L,GAAgB,OAAQ3L,IAAK,CAC/C,MAAMe,EAAY4K,GAAgB3L,CAAC,EACnCmM,IAAapL,EAAYf,EAAIsM,EAAe,GAAG,EAE/C,IAAI9P,EAAO,MAAMU,GAAG,iBAAiB6D,CAAS,EAE9C,GAAI,CAACvE,EAAM,CAETgP,GAAI,KAAK,SAASzK,CAAS,kCAAkC,EAC7D,MAAMiM,EAAWjB,EAAa,+BAA+B,GAAGhL,CAAS,EACrEiM,IACFxQ,EAAO,MAAM6I,GAAU,IAA6B2H,EAAU,EAAK,EACnE,MAAM9P,GAAG,iBAAiB6D,EAAWvE,CAAI,EAE7C,CAEIA,IACF,KAAK,aAAauE,CAAS,EAAIvE,EAEnC,CAEA2P,IAAa,WAAY,GAAG,EAC5B,KAAK,4BACP,CAEQ,4BAAmC,CACzC,MAAMc,EAAQ,KAAK,aAAa,+BAChC,GAAI,CAACA,EAAO,OAGZ,KAAK,oBAAsB,CACzB,EAAG,GAAI,EAAG,GAAI,EAAG,GAAI,EAAG,EAAC,EAE3B,KAAK,YAAc,GAGnB,MAAMC,EAA0C,CAC9C,OAAU,QACV,MAAS,QACT,gBAAmB,kBACnB,cAAiB,kBACjB,MAAS,QACT,SAAY,WACZ,QAAW,WACX,SAAY,OACZ,KAAQ,OACR,QAAW,UACX,OAAU,UACV,eAAkB,UAClB,UAAa,YACb,SAAY,YACZ,QAAW,YACX,iBAAoB,YAEpB,kBAAqB,UACrB,oBAAuB,sBACvB,UAAa,uBAGf,UAAWrG,KAAQ,OAAO,OAAOoG,CAAK,EAAG,CASvC,GAPI,CAACpG,EAAK,mBAAmB,MAAQA,EAAK,kBAAkB,OAAS,WAAa,CAACA,EAAK,kBAAkB,MAKtGA,EAAK,kBAAkB,OAAS,cAChCA,EAAK,cAAgB,IAAMA,EAAK,kBAAkB,KAAK,SAAS,UAAU,GAC1EA,EAAK,WAAa,GAAKA,EAAK,WAAa,EAAG,SAGhD,MAAMsG,EAAYtG,EAAK,kBAAkB,KAAK,cACxCuG,GAAavG,EAAK,qBAAuB,IAAI,cAKnD,GAJIsG,EAAU,SAAS,UAAU,GAAKC,EAAU,SAAS,UAAU,GAC/DD,EAAU,SAAS,YAAY,GAAKC,EAAU,SAAS,YAAY,GACnED,EAAU,SAAS,OAAO,GAAKA,EAAU,SAAS,QAAQ,GAC1DA,EAAU,SAAS,WAAW,GAAKA,EAAU,SAAS,aAAa,GACnEtG,EAAK,OAAS,WAAY,SAG9B,MAAMwG,EAAaxG,EAAa,MAAM,wBAAwB,eAAiB,GAG/E,IAAIyG,EACJ,SAAW,CAAC9P,EAAK+P,CAAK,IAAK,OAAO,QAAQL,CAAe,EAGvD,GADc,IAAI,OAAO,WAAW1P,CAAG,WAAY,GAAG,EAC5C,KAAK6P,CAAS,EAAG,CACzBC,EAAgBC,EAChB,KACF,CAIE1G,EAAK,kBAAkB,KAAK,WAAW,UAAU,IACnDyG,EAAgB,uBAIlB,MAAME,GAAe3G,EAAK,qBAAuB,IAAI,cAerD,GAdKyG,IAEC,YAAY,KAAKE,CAAW,EAAGF,EAAgB,QAC1C,aAAa,KAAKE,CAAW,EAAGF,EAAgB,UAChD,eAAe,KAAKE,CAAW,EAAGF,EAAgB,YAClD,cAAc,KAAKE,CAAW,EAEhCA,EAAY,SAAS,UAAU,IAAGF,EAAgB,YAEhD,YAAY,KAAKE,CAAW,EAAGF,EAAgB,QAC/CE,EAAY,SAAS,eAAe,EAAGF,EAAgB,mBACvDE,EAAY,SAAS,MAAM,GAAKA,EAAY,SAAS,OAAO,GAAKA,EAAY,SAAS,MAAM,KAAGF,EAAgB,SAGtH,CAACA,EAAe,SAEpB,MAAMG,EAAY5G,EAAK,WAAa,EAGpC,IAAI6G,EAAa7G,EAAK,mBAAqB,EAM3C,GALI6G,EAAa,MACfA,EAAa7B,GAAoB6B,CAAU,GAAK,GAI9CA,IAAe,GAAM7G,EAAa,MAAM,iBAAkB,CAC5D,MAAM8G,EAAS/B,GAA6B/E,EAAa,KAAK,gBAAgB,EAC1E8G,IAAW,SAAWD,EAAaC,EACzC,EAIEN,EAAU,SAAS,WAAW,GAC9BC,IAAkB,uBAClBzG,EAAK,kBAAkB,KAAK,WAAW,UAAU,IAChDA,EAAK,qBAAuB,IAAI,cAAc,SAAS,WAAW,KAGnE6G,EAAa,EACTJ,IAAkB,cAAaA,EAAgB,wBAGhD,KAAK,oBAAoBG,CAAS,IAAG,KAAK,oBAAoBA,CAAS,EAAI,IAC3E,KAAK,oBAAoBA,CAAS,EAAEC,CAAU,IAAG,KAAK,oBAAoBD,CAAS,EAAEC,CAAU,EAAI,IACnG,KAAK,oBAAoBD,CAAS,EAAEC,CAAU,EAAEJ,CAAa,IAChE,KAAK,oBAAoBG,CAAS,EAAEC,CAAU,EAAEJ,CAAa,EAAI,IAGnE,KAAK,oBAAoBG,CAAS,EAAEC,CAAU,EAAEJ,CAAa,EAAE,KAAKzG,EAAK,IAAI,CAC/E,CACA2E,GAAI,KAAK,wCAAwC,CACnD,CAEA,uBAAuBiC,EAAmBC,EAA8C,CACtF,OAAQ,KAAK,oBAAoBD,CAAS,GAAK,KAAK,oBAAoBA,CAAS,EAAEC,CAAU,GAAM,EACrG,CAKA,0BAOG,CACD,MAAME,EAOD,GAEL,SAAW,CAACH,EAAWI,CAAW,IAAK,OAAO,QAAQ,KAAK,mBAAmB,EAC5E,SAAW,CAACH,EAAYI,CAAU,IAAK,OAAO,QAAQD,CAAW,EAC/D,SAAW,CAACE,EAAUC,CAAM,IAAK,OAAO,QAAQF,CAAU,EACxDE,EAAO,QAAQ/C,GAAQ,CACrB,MAAMpE,EAAO,KAAK,QAAQoE,CAAI,EAC1BpE,GACF+G,EAAQ,KAAK,CACX,KAAM/G,EAAK,kBAAkB,KAC7B,KAAMA,EAAK,KACX,KAAMA,EAAK,kBAAkB,KAC7B,SAAAkH,EACA,UAAW,OAAON,CAAS,EAC3B,WAAY,OAAOC,CAAU,EAC9B,CAEL,CAAC,EAKP,MAAMT,EAAQ,KAAK,aAAa,+BAChC,GAAIA,GACF,SAAW,CAAChC,EAAMpE,CAAI,IAAK,OAAO,QAAQoG,CAAK,EAC7C,GAAIpG,EAAK,WAAa,IAAMA,EAAK,mBAAmB,MAAQA,EAAK,kBAAkB,KAAM,CACvF,MAAMsG,EAAYtG,EAAK,kBAAkB,KAAK,cAC9C,GAAIsG,EAAU,SAAS,WAAW,GAAKA,EAAU,SAAS,OAAO,GAAKA,EAAU,SAAS,QAAQ,GAAKA,EAAU,SAAS,UAAU,EAAG,SAEtIS,EAAQ,KAAK,CACX,KAAM/G,EAAK,kBAAkB,KAC7B,KAAM,OAAOoE,CAAI,EACjB,KAAMpE,EAAK,kBAAkB,KAC7B,SAAU,WACV,UAAWA,EAAK,WAAa,EAC7B,WAAaA,EAAK,mBAAqBA,EAAK,kBAAoB,IAC3DgF,GAAoBhF,EAAK,iBAAiB,GAAK,EAC/CA,EAAK,mBAAqB,EAChC,CACH,EAKJ,OAAO+G,EAAQ,KAAK,CAAC,EAAGtD,IAIlB,EAAE,aAAeA,EAAE,WAAmB,EAAE,WAAaA,EAAE,WAGvD,EAAE,YAAcA,EAAE,UAAkB,EAAE,UAAYA,EAAE,UAGjD,EAAE,KAAK,cAAcA,EAAE,IAAI,CACnC,CACH,CAIA,QAAQW,EAAmD,CACzD,MAAMgC,EAAQ,KAAK,aAAa,+BAKhC,GAAI,CAACA,EAAO,OAGZ,IAAIpG,EAAOoG,EAAM,OAAOhC,CAAI,CAAC,EAG7B,GAAI,CAACpE,EAAM,CACT,MAAMoH,EAAa,OAAOhD,CAAI,EAAI,EAClCpE,EAAOoG,EAAM,OAAOgB,CAAU,CAAC,CACjC,CAEA,GAAKpH,EAEL,OAAO,KAAK,wBAAwBA,CAAI,CAC1C,CAGA,QAAQoE,EAA2C,CACjD,MAAMpE,EAAO,KAAK,QAAQoE,CAAI,EAC9B,GAAIpE,GAAM,mBAAmB,KAAM,OAAOA,EAAK,kBAAkB,KAGjE,MAAMqH,EAAQ,KAAK,aAAa,6BAChC,GAAIA,EAAO,CACT,MAAMC,EAAS,OAAOlD,CAAI,EACpBmD,EAAOF,EAAMC,CAAM,EACzB,GAAIC,GAAM,mBAAmB,KAAM,OAAOA,EAAK,kBAAkB,KAGjE,MAAMH,EAAa,OAAOhD,CAAI,EAAI,EAC5BoD,EAAaH,EAAM,OAAOD,CAAU,CAAC,EAC3C,GAAII,GAAY,mBAAmB,KAAM,OAAOA,EAAW,kBAAkB,IAC/E,CAGA,MAAMC,EAAS,KAAK,UAAUrD,CAAI,EAClC,GAAIqD,GAAQ,KAAM,OAAOA,EAAO,IAGlC,CAMA,UAAUrD,EAAgH,CACxH,MAAMsD,EAAU,KAAK,aAAa,wBAClC,GAAI,CAACA,EAAS,OAEd,IAAID,EAASC,EAAQ,OAAOtD,CAAI,CAAC,EACjC,GAAI,CAACqD,EAAQ,CACX,MAAML,EAAa,OAAOhD,CAAI,EAAI,EAClCqD,EAASC,EAAQ,OAAON,CAAU,CAAC,CACrC,CAEA,GAAKK,GAAQ,kBAEb,MAAO,CACL,KAAMA,EAAO,kBAAkB,KAC/B,YAAaA,EAAO,kBAAkB,YACtC,KAAMA,EAAO,kBAAkB,KAC/B,eAAgBA,EAAO,eAE3B,CAGA,mBAAmBE,EAAeC,EAAiB,GAAkE,CACnH,MAAMF,EAAU,KAAK,aAAa,wBAClC,GAAI,CAACA,EAAS,OAEd,MAAMG,EAASF,EAAM,cAGrB,IAAIG,EAEJ,SAAW,CAAC1D,EAAMqD,CAAM,IAAK,OAAO,QAAQC,CAAO,EAAG,CACpD,GAAI,CAACD,GAAQ,mBAAmB,KAAM,SAEtC,MAAMhD,EAAOgD,EAAO,kBAAkB,KAAK,cACrCM,EAAU,CAAC,CAACN,EAAO,kBAAkB,KAE3C,GAAIG,GACF,GAAInD,IAASoD,EAAQ,CACnB,GAAIE,EACF,MAAO,CACL,KAAMN,EAAO,kBAAkB,KAC/B,KAAMA,EAAO,kBAAkB,KAC/B,KAAM,OAAOrD,CAAI,GAGhB0D,IACHA,EAAY,CACV,KAAML,EAAO,kBAAkB,KAC/B,KAAM,OACN,KAAM,OAAOrD,CAAI,GAGvB,OAEIK,EAAK,SAASoD,CAAM,GAClBE,IACE,CAACD,GAAa,CAACA,EAAU,QAC3BA,EAAY,CACV,KAAML,EAAO,kBAAkB,KAC/B,KAAMA,EAAO,kBAAkB,KAC/B,KAAM,OAAOrD,CAAI,GAM7B,CACA,OAAO0D,CACT,CAGA,oBAAoB1D,EAAwI,CAC1J,MAAM4D,EAAQ,KAAK,aAAa,kCAChC,GAAI,CAACA,EAAO,OAEZ,IAAIC,EAAOD,EAAM,OAAO5D,CAAI,CAAC,EAC7B,GAAI,CAAC6D,EAAM,CACT,MAAMb,EAAa,OAAOhD,CAAI,EAAI,EAClC6D,EAAOD,EAAM,OAAOZ,CAAU,CAAC,CACjC,CAEA,GAAKa,GAAM,kBAEX,MAAO,CACL,KAAMA,EAAK,kBAAkB,KAC7B,YAAaA,EAAK,kBAAkB,YACpC,KAAMA,EAAK,kBAAkB,KAC7B,aAAcA,EAAK,aACnB,aAAcA,EAAK,aAEvB,CAGA,wBAAwBC,EAA8I,CACpK,MAAMF,EAAQ,KAAK,aAAa,kCAChC,GAAI,CAACA,EAAO,MAAO,GAEnB,MAAMjB,EAAoI,GACpIoB,EAAcD,EAAW,cAE/B,SAAW,CAAC9D,EAAM6D,CAAI,IAAK,OAAO,QAAQD,CAAK,EAAG,CAChD,MAAMvD,EAAOwD,GAAM,mBAAmB,MAAQ,GACxCG,EAAcH,GAAM,mBAAmB,aAAe,IAExDxD,EAAK,cAAc,SAAS0D,CAAW,GAAKC,EAAY,cAAc,SAASD,CAAW,IAC5FpB,EAAQ,KAAK,CACX,KAAM,OAAO3C,CAAI,EACjB,KAAAK,EACA,KAAMwD,EAAK,mBAAmB,KAC9B,aAAcA,EAAK,aACnB,aAAcA,EAAK,aACnB,YAAAG,CAAA,CACD,CAEL,CAGA,OAAOrB,EAAQ,KAAK,CAACsB,EAAG5E,IAClB4E,EAAE,cAAgB,CAAC5E,EAAE,aAAqB,GAC1C,CAAC4E,EAAE,cAAgB5E,EAAE,aAAqB,EAC1C4E,EAAE,MAAQ,CAAC5E,EAAE,KAAa,GAC1B,CAAC4E,EAAE,MAAQ5E,EAAE,KAAa,EACvB4E,EAAE,KAAK,cAAc5E,EAAE,IAAI,CACnC,CACH,CAGA,6BAA6BkE,EAAeC,EAAiB,GAAkE,CAC7H,MAAMI,EAAQ,KAAK,aAAa,kCAChC,GAAI,CAACA,EAAO,OAEZ,MAAMH,EAASF,EAAM,cACrB,IAAIG,EAEJ,SAAW,CAAC1D,EAAM6D,CAAI,IAAK,OAAO,QAAQD,CAAK,EAAG,CAGhD,GAFI,CAACC,GAAM,mBAAmB,MAE1BA,EAAK,kBAAkB,OAAS,GAAI,SAExC,MAAMxD,EAAOwD,EAAK,kBAAkB,KAAK,cAEnCF,EAAU,CAAC,CAACE,EAAK,kBAAkB,MAAQ,CAAC,CAACA,EAAK,aAClDK,EAAWL,EAAK,kBAAkB,MAAQA,EAAK,aAErD,GAAIL,GACF,GAAInD,IAASoD,EAAQ,CACnB,GAAIE,EACF,MAAO,CACL,KAAME,EAAK,kBAAkB,KAC7B,KAAMK,EACN,KAAM,OAAOlE,CAAI,GAGhB0D,IAAWA,EAAY,CAAE,KAAMG,EAAK,kBAAkB,KAAM,KAAM,OAAW,KAAM,OAAO7D,CAAI,GACrG,OAEIK,EAAK,SAASoD,CAAM,GAClBE,IAEE,CAACD,GAAcrD,EAAK,WAAWoD,CAAM,GAAK,CAACC,EAAU,KAAK,cAAc,WAAWD,CAAM,KAC3FC,EAAY,CACV,KAAMG,EAAK,kBAAkB,KAC7B,KAAMK,EACN,KAAM,OAAOlE,CAAI,GAM7B,CACA,OAAO0D,CACT,CAGA,YAAY1D,EAA8G,CACxH,MAAMmE,EAAa,KAAK,aAAa,0BACrC,GAAI,CAACA,EAAY,OAGjB,IAAIC,EAAWD,EAAW,OAAOnE,CAAI,CAAC,EAGtC,GAAI,CAACoE,EAAU,CACb,MAAMpB,EAAa,OAAOhD,CAAI,EAAI,EAClCoE,EAAWD,EAAW,OAAOnB,CAAU,CAAC,CAC1C,CAEA,GAAKoB,GAAU,kBAEf,MAAO,CACL,KAAMA,EAAS,kBAAkB,MAAQ,GACzC,YAAaA,EAAS,kBAAkB,YACxC,KAAMA,EAAS,kBAAkB,KACjC,UAAWA,EAAS,UAExB,CAGA,gBAAgBpE,EAAwC,CACtD,MAAMqE,EAAO,KAAK,aAAa,8BAC/B,GAAI,CAACA,EAAM,OAEX,IAAIC,EAASD,EAAK,OAAOrE,CAAI,CAAC,EAC9B,GAAI,CAACsE,EAAQ,CACX,MAAMtB,EAAa,OAAOhD,CAAI,EAAI,EAClCsE,EAASD,EAAK,OAAOrB,CAAU,CAAC,CAClC,CACA,OAAOsB,CACT,CAGA,UAAUtE,EAA0F,CAClG,MAAMuE,EAAU,KAAK,aAAa,iCAClC,GAAI,CAACA,EAAS,OAGd,IAAIC,EAASD,EAAQ,OAAOvE,CAAI,CAAC,EACjC,GAAI,CAACwE,EAAQ,CACX,MAAMxB,EAAa,OAAOhD,CAAI,EAAI,EAClCwE,EAASD,EAAQ,OAAOvB,CAAU,CAAC,CACrC,CAEA,GAAKwB,GAAQ,kBAEb,MAAO,CACL,KAAMA,EAAO,kBAAkB,MAAQ,GACvC,YAAaA,EAAO,kBAAkB,YACtC,KAAMA,EAAO,kBAAkB,KAEnC,CAGA,QAAQxE,EAA0F,CAChG,MAAMyE,EAAQ,KAAK,aAAa,sBAChC,GAAI,CAACA,EAAO,OAGZ,IAAIC,EAAOD,EAAM,OAAOzE,CAAI,CAAC,EAC7B,GAAI,CAAC0E,EAAM,CACT,MAAM1B,EAAa,OAAOhD,CAAI,EAAI,EAClC0E,EAAOD,EAAM,OAAOzB,CAAU,CAAC,CACjC,CAEA,GAAK0B,GAAM,kBAEX,MAAO,CACL,KAAMA,EAAK,KACX,KAAMA,EAAK,kBAAkB,MAAQ,GACrC,YAAaA,EAAK,kBAAkB,YACpC,KAAMA,EAAK,kBAAkB,KAEjC,CAGA,iBAAiBrE,EAA+F,CAC9G,MAAMoE,EAAQ,KAAK,aAAa,sBAChC,GAAI,CAACA,EAAO,OAEZ,MAAMhB,EAASpD,EAAK,cACpB,SAAW,CAACL,EAAM0E,CAAI,IAAK,OAAO,QAAQD,CAAK,EAC7C,GAAIC,GAAM,mBAAmB,MAAM,gBAAkBjB,EACnD,MAAO,CACL,KAAMiB,EAAK,kBAAkB,KAC7B,KAAM,OAAO1E,CAAI,EACjB,KAAM0E,EAAK,kBAAkB,KAC7B,YAAaA,EAAK,kBAAkB,YAK5C,CAGA,iBAAiBnB,EAAeC,EAAiB,GAAmC,CAClF,MAAMxB,EAAQ,KAAK,aAAa,+BAChC,GAAI,CAACA,EAAO,OAEZ,MAAMyB,EAASF,EAAM,cACrB,UAAW3H,KAAQ,OAAO,OAAOoG,CAAK,EAAG,CACvC,MAAM3B,EAAOzE,EAAK,mBAAmB,MAAM,cAC3C,GAAKyE,GAEL,GAAImD,GACF,GAAInD,IAASoD,EAAQ,OAAO,KAAK,wBAAwB7H,CAAI,UAEzDyE,EAAK,SAASoD,CAAM,EAAG,OAAO,KAAK,wBAAwB7H,CAAI,EAEvE,CAEF,CAGA,oBAAoBoE,EAAgH,CAClI,MAAM2E,EAAY,KAAK,aAAa,kCACpC,GAAI,CAACA,EAAW,OAGhB,IAAIC,EAAWD,EAAU,OAAO3E,CAAI,CAAC,EAGrC,GAAI,CAAC4E,EAAU,CACb,MAAM5B,EAAa,OAAOhD,CAAI,EAAI,EAClC4E,EAAWD,EAAU,OAAO3B,CAAU,CAAC,CACzC,CAEA,GAAI,CAAC4B,GAAU,kBAAmB,OAElC,IAAIC,EAAcD,EAAS,YAQ3B,GALI,CAACC,GAAerE,GAAqB,OAAOR,CAAI,CAAC,IACnD6E,EAAcpE,GAAeD,GAAqB,OAAOR,CAAI,CAAC,CAAC,GAI7D,CAAC6E,EAAa,CAChB,MAAM7B,EAAa,OAAOhD,CAAI,EAAI,EAC9BQ,GAAqB,OAAOwC,CAAU,CAAC,IACzC6B,EAAcpE,GAAeD,GAAqB,OAAOwC,CAAU,CAAC,CAAC,EAEzE,CAEA,MAAO,CACL,KAAM4B,EAAS,kBAAkB,MAAQ,GACzC,YAAaA,EAAS,kBAAkB,YACxC,KAAMA,EAAS,kBAAkB,KACjC,YAAAC,CAAA,CAEJ,CAIA,eAAeA,EAA2E,CAExF,MAAMC,EAA8D,CAClE,EAAG,CAAE,KAAM,UAAW,KAAM,uEAC5B,EAAG,CAAE,KAAM,WAAY,KAAM,uEAC7B,EAAG,CAAE,KAAM,cAAe,KAAM,sEAAsE,EAGlGC,EAAa,OAAOF,CAAW,EACrC,GAAIC,EAAYC,CAAU,EACxB,OAAOD,EAAYC,CAAU,EAG/B,MAAMC,EAAW,KAAK,aAAa,6BACnC,GAAI,CAACA,EAAU,OAGf,MAAMC,EAASD,EAAS,OAAOH,CAAW,CAAC,EAC3C,GAAII,GAAQ,kBACV,MAAO,CACL,KAAMA,EAAO,kBAAkB,MAAQ,GACvC,KAAMA,EAAO,kBAAkB,MAKnC,UAAWC,KAAW,OAAO,OAAOF,CAAQ,EAC1C,GAAIE,GAAS,YAAcH,EACzB,MAAO,CACL,KAAMG,EAAQ,mBAAmB,MAAQ,GACzC,KAAMA,EAAQ,mBAAmB,KAMzC,CAGA,gBAAgBC,EAA0E,CAExF,MAAMC,EAAqC,CACzC,QAAW,EACX,SAAY,EACZ,YAAe,GAIjB,OADoB,KAAK,eAAeA,EAAWD,CAAY,CAAC,GAC5C,IACtB,CAGA,oBAAoBE,EAAuG,CACzH,MAAMC,EAAQ,KAAK,aAAa,8BAC1BC,EAAY,KAAK,aAAa,uCACpC,GAAI,CAACD,EAAO,OAEZ,MAAME,EAAU,OAAO,OAAOF,CAAK,EAAE,KAAK1N,GAAKA,EAAE,aAAeyN,CAAI,EACpE,GAAI,CAACG,EAAS,OAId,MAAMC,EAAgBF,EAAY,OAAO,OAAOA,CAAS,EAAE,CAAC,EAAI,KAChE,IAAIG,EAEJ,GAAID,GAAe,gBAAiB,CAClC,MAAME,EAAcF,EAAc,gBAC9BJ,GAAQ,EACVK,EAAQC,EAAY,8CAEpBD,EAAQC,EAAY,kCAExB,CAEA,MAAO,CACL,WAAYH,EAAQ,mBAAqB,GAAGvS,GAAc,eAAe,GAAGuS,EAAQ,kBAAkB,GAAK,OAC3G,WAAYA,EAAQ,mBAAqB,GAAGvS,GAAc,eAAe,GAAGuS,EAAQ,kBAAkB,GAAK,OAC3G,KAAMA,EAAQ,mBAAmB,KAAO,GAAGvS,GAAc,eAAe,GAAGuS,EAAQ,kBAAkB,IAAI,GAAK,OAC9G,MAAOE,EAAQ,GAAGzS,GAAc,eAAe,GAAGyS,CAAK,GAAK,OAEhE,CAGA,aAAalD,EAAuC,CAOlD,MAAMoD,EANqC,CACzC,EAAG,QACH,EAAG,SACH,EAAG,WAGwBpD,CAAS,EACtC,GAAIoD,EAAW,CACb,MAAM/B,EAAO,KAAK,6BAA6B+B,EAAW,EAAI,EAC9D,GAAI/B,GAAM,KAAM,OAAOA,EAAK,IAC9B,CAGA,MAAMgC,EAAU,KAAK,aAAa,uBAClC,OAAKA,EAEY,OAAO,OAAOA,CAAO,EAAE,KAAK,GAAK,EAAE,YAAcrD,CAAS,GAC1D,mBAAmB,KAHtB,MAIhB,CAGA,kBAAkBC,EAAsH,CAEtI,MAAMqD,EAAwC,CAC5C,QAAW,WACX,MAAS,WACT,IAAO,WACP,KAAQ,WACR,OAAU,UACV,OAAU,WACV,UAAa,YAETlD,EAAc,KAAK,aAAa,4BACtC,GAAI,CAACA,EAAa,OAElB,MAAM5C,EAAO8F,EAAcrD,EAAW,aAAa,EACnD,GAAI,CAACzC,EAAM,OAEX,IAAI+F,EAAMnD,EAAY,OAAO5C,CAAI,CAAC,EAGlC,GAAI,CAAC+F,EAAK,CACR,MAAM/C,EAAa,OAAOhD,CAAI,EAAI,EAClC+F,EAAMnD,EAAY,OAAOI,CAAU,CAAC,CACtC,CAEA,GAAI+C,GAAK,mBAAmB,KAC1B,OAAOA,EAAI,kBAAkB,IAIjC,CAGA,oBAAoB/F,EAAkG,CACpH,MAAM4D,EAAQ,KAAK,aAAa,wCAChC,GAAI,CAACA,EAAO,OAEZ,IAAImC,EAAMnC,EAAM,OAAO5D,CAAI,CAAC,EAC5B,GAAI,CAAC+F,EAAK,CACR,MAAM/C,EAAa,OAAOhD,CAAI,EAAI,EAClC+F,EAAMnC,EAAM,OAAOZ,CAAU,CAAC,CAChC,CAEA,GAAK+C,EAEL,MAAO,CACL,KAAMA,EAAI,KACV,KAAMA,EAAI,mBAAmB,MAAQ,GACrC,KAAMA,EAAI,mBAAmB,KAAO,GAAG9S,GAAc,eAAe,GAAG8S,EAAI,kBAAkB,IAAI,GAAK,OACtG,MAAOA,EAAI,MAAQ,OAAOA,EAAI,MAAM,GAAG,KAAKA,EAAI,MAAM,KAAK,KAAKA,EAAI,MAAM,IAAI,IAAM,OAExF,CAGA,gBAAgB/F,EAAyF,CACvG,MAAMgG,EAAQ,KAAK,aAAa,oCAChC,GAAI,CAACA,EAAO,OAEZ,IAAID,EAAMC,EAAM,OAAOhG,CAAI,CAAC,EAC5B,GAAI,CAAC+F,EAAK,CACR,MAAM/C,EAAa,OAAOhD,CAAI,EAAI,EAClC+F,EAAMC,EAAM,OAAOhD,CAAU,CAAC,CAChC,CAEA,GAAK+C,EAEL,MAAO,CACL,KAAMA,EAAI,mBAAmB,MAAQ,GACrC,YAAaA,EAAI,mBAAmB,aAAe,GACnD,KAAMA,EAAI,mBAAmB,KAAO,GAAG9S,GAAc,eAAe,GAAG8S,EAAI,kBAAkB,IAAI,GAAK,OAE1G,CAGA,oBAAoBV,EAAkC,CACpD,MAAMC,EAAQ,KAAK,aAAa,8BAChC,OAAKA,EAGO,OAAO,OAAOA,CAAK,EAAE,KAAK,GAAK,EAAE,OAASD,CAAI,GAC9C,mBAAmB,KAJnB,MAKd,CAGA,iBAAiB9B,EAAe0C,EAAQ,GAAW,CACjD,MAAM9B,EAAa,KAAK,aAAa,0BACrC,GAAI,CAACA,EAAY,MAAO,GAGxB,MAAM+B,EAAaC,GAAgBA,EAChC,cACA,UAAU,KAAK,EACf,QAAQ,mBAAoB,EAAE,EAC9B,QAAQ,eAAgB,EAAE,EAC1B,OAEGC,EAAkBF,EAAU3C,CAAK,EACjCZ,EAAiB,GAEvB,UAAWyB,KAAY,OAAO,OAAOD,CAAU,EAAG,CAChD,GAAI,CAACC,GAAU,mBAAmB,KAAM,SAIxC,GAFuB8B,EAAU9B,EAAS,kBAAkB,IAAI,EAE7C,SAASgC,CAAe,IACzCzD,EAAQ,KAAKyB,CAAQ,EACjBzB,EAAQ,QAAUsD,GAAO,KAEjC,CAEA,OAAOtD,CACT,CAGA,QAAQ3C,EAA2C,CACjD,MAAMpE,EAAO,KAAK,QAAQoE,CAAI,EAC9B,GAAIpE,GAAM,kBAAkB,KAAM,OAAOA,EAAK,kBAAkB,KAEhE,MAAMuH,EAAO,KAAK,QAAQnD,CAAI,EAC9B,GAAImD,GAAM,KAAM,OAAOA,EAAK,IAG9B,CAGA,kBAAkBnD,EAUJ,CAEZ,MAAMpE,EAAO,KAAK,QAAQoE,CAAI,EAC9B,GAAIpE,EAAM,CACR,MAAMyK,EAA2D,GAG3DC,EAAW,KAAK,aAAa,iCAAyC,OAAOtG,CAAI,CAAC,EAGpFsG,GAAS,OAAO,OAClB,OAAO,OAAOA,EAAQ,MAAM,KAAK,EAAE,QAAS5B,GAAc,CACxD,MAAM6B,EAAU,KAAK,QAAQ7B,EAAK,QAAQ,EACtC6B,GACFF,EAAQ,KAAK,CACX,KAAME,EAAQ,KACd,MAAO7B,EAAK,MACb,CAEL,CAAC,EAIC4B,GAAS,iBAAmBD,EAAQ,SAAW,GACjDC,EAAQ,gBAAgB,QAAS5B,GAAc,CAC7C,MAAM6B,EAAU,KAAK,QAAQ7B,EAAK,YAAY,EAE1C6B,GAAW7B,EAAK,QAAU,GAE5B2B,EAAQ,KAAK,CACX,KAAME,EAAQ,KACd,MAAO7B,EAAK,MAAQ,EAAI,IAAIA,EAAK,KAAK,GAAK,GAAGA,EAAK,KAAK,GACzD,CAEL,CAAC,EAGH,IAAIV,EAAcpI,EAAK,kBAAkB,YACrC4K,EAGJ,GAAIF,GAAS,SAAS,eAAiB1K,EAAK,WAAW,WAAa,GAElE,UAAW6K,KAAUH,EAAQ,QAAQ,cACnC,GAAIG,EAAO,sBAAuB,CAChC,MAAMC,EAAY,KAAK,aAAa,iCAAyC,OAAOD,EAAO,qBAAqB,CAAC,EAEjH,GAAIC,GAAYA,EAAS,mBAAmB,cACtBA,EAAS,sBAAwB,aACnDA,EAAS,sBAAwB,SACjCA,EAAS,MAAM,wBAAwB,SAAS,WAAW,IAE1CA,EAAS,kBAAkB,YAAY,OAAS,GAAI,CACrE1C,EAAc0C,EAAS,kBAAkB,YACzCF,EAAWE,EAAS,kBAAkB,KACtC,KACF,CAEJ,EAKJ,GAAI,CAAC1C,GAAesC,GAAS,OAAO,OAClC,UAAWK,KAAKL,EAAQ,MAAO,CAC7B,MAAMM,EAAU,KAAK,QAAQD,EAAE,QAAQ,EACvC,GAAIC,GAAS,aAAeA,EAAQ,YAAY,OAAS,GAAI,CAC3D5C,EAAc4C,EAAQ,YACtBJ,EAAWI,EAAQ,KACnB,KACF,CACF,CAIF,OAAI,CAAC5C,GAAeA,EAAY,OAAS,MACvCA,EAAcpI,EAAK,kBAAkB,aAAe0K,GAAS,YAGxD,CACL,KAAM1K,EAAK,kBAAkB,KAC7B,KAAMA,EAAK,WAAW,cAAgB,OACtC,YAAAoI,EACA,WAAYsC,GAAS,WACrB,SAAAE,EACA,KAAM5K,EAAK,kBAAkB,MAAQA,EAAK,WAC1C,MAAOyK,EACP,QAAUzK,EAAK,mBAAqB,KAAK,cAAcA,EAAK,iBAAiB,GAAG,MAAS,OAE7F,CAGA,MAAMiL,EAAc,KAAK,YAAY7G,CAAI,EACzC,GAAI6G,EACF,MAAO,CACL,KAAMA,EAAY,KAClB,KAAM,WACN,YAAaA,EAAY,YACzB,KAAMA,EAAY,WAAaA,EAAY,MAK/C,MAAMC,EAAc,KAAK,oBAAoB9G,CAAI,EACjD,GAAI8G,EACF,MAAO,CACL,KAAMA,EAAY,KAClB,KAAM,WACN,YAAaA,EAAY,YACzB,KAAMA,EAAY,KAClB,YAAaA,EAAY,aAK7B,MAAM3D,EAAO,KAAK,QAAQnD,CAAI,EAC9B,GAAImD,EACF,MAAO,CACL,KAAMA,EAAK,KACX,KAAM,eACN,YAAaA,EAAK,YAClB,KAAMA,EAAK,KAKjB,CAEQ,wBAAwB4D,EAAwC,CAGtE,IAAItE,EAAasE,EAAI,kBACrB,GAAIA,EAAI,MAAM,iBAAkB,CAC9B,MAAMC,EAAmBrG,GAA4BoG,EAAI,KAAK,gBAAgB,EAC1EC,IAAqB,SACvBvE,EAAauE,EAEjB,CAEA,OAAID,EAAI,WAAW,WAAa,GAEzBA,EAAI,gBAAgB,YAKpB,CACL,GAAGA,EACH,KAAMA,EAAI,KACV,kBAAmB,CACjB,KAAMA,EAAI,mBAAmB,MAAQ,UACrC,YAAaA,EAAI,mBAAmB,aAAe,GACnD,KAAMA,EAAI,mBAAmB,KACzB,GAAG9T,GAAc,eAAe,GAAG8T,EAAI,kBAAkB,IAAI,GAC7D,GACJ,QAAS,CAAC,CAACA,EAAI,mBAAmB,MAEpC,WAAYA,EAAI,WACZ,GAAG9T,GAAc,eAAe,GAAG8T,EAAI,UAAU,GACjD,OACJ,SAAUA,EAAI,SACd,YAAaA,EAAI,YACjB,UAAWA,EAAI,UACf,WAAYA,EAAI,YAAc,GAC9B,kBAAmBtE,EACnB,sBAAuBsE,EAAI,sBAC3B,SAAUA,EAAI,WAAW,SACzB,SAAUA,EAAI,WAAW,WAAa,EACtC,oBAAqBA,EAAI,oBACzB,2BAA4BA,EAAI,2BAChC,QAASA,EAAI,QACb,mBAAoBA,EAAI,mBACxB,KAAMA,EAAI,KACV,UAAWA,EAAI,UAAY,CACzB,SAAUA,EAAI,UAAU,UAAY,EACpC,aAAcA,EAAI,UAAU,cAAgB,GAC5C,eAAgBA,EAAI,UAAU,gBAAkB,EAChD,uBAAyBA,EAAI,UAAkB,wBAA0B,EACzE,aAAeA,EAAI,UAAkB,cAAgB,EACrD,eAAiBA,EAAI,UAAkB,gBAAkB,GACzD,iBAAmBA,EAAI,UAAkB,kBAAoB,GAC7D,eAAgBA,EAAI,gBAAgB,YACpC,WAAaA,EAAI,UAAkB,YAAc,IAC/C,OACJ,eAAgBA,EAAI,eACpB,MAAOA,EAAI,MAAQ,CACjB,0BAA2B,CAAC,CAACA,EAAI,MAAM,0BACvC,cAAeA,EAAI,MAAM,eAAiB,EAC1C,MAAOA,EAAI,MAAM,OAAS,GAC1B,oBAAqBA,EAAI,MAAM,qBAAuB,EAAC,EACrD,OACJ,cAAeA,EAAI,eAAiBA,EAAI,SAAS,+BAA+B,CAAC,EACjF,iBAAkBA,EAAI,iBAClB,GAAG9T,GAAc,eAAe,GAAG8T,EAAI,gBAAgB,GACvD,OACJ,iBAAkBA,EAAI,iBAClB,GAAG9T,GAAc,eAAe,GAAG8T,EAAI,gBAAgB,GACvD,OACJ,cAAeA,EAAI,cACf,GAAG9T,GAAc,eAAe,GAAG8T,EAAI,aAAa,GACpD,OACJ,YAAa5G,GAA2B4G,EAAI,eAAiBA,EAAI,SAAS,+BAA+B,CAAC,GAAK,EAAE,EACjH,qBAAsBA,EAAI,sBAAwB,OAClD,QAASA,EAAI,QAAU,CACrB,eAAiBA,EAAI,QAAgB,gBAAkB,EACvD,6BAA8BA,EAAI,QAAQ,8BAAgC,EAAC,EACzE,OAER,CAEA,SAAShE,EAA+C,CACtD,OAAOA,EACJ,IAAK/C,GAAS,KAAK,QAAQA,CAAI,CAAC,EAChC,OAAQpE,GAAiCA,IAAS,MAAS,CAChE,CAOA,kBAAkBqL,EAAkBC,EASjC,CACD,MAAMC,EAAW,QAAQF,CAAQ,SAASC,CAAQ,GAClD,GAAI,KAAK,YAAYC,CAAQ,EAC3B,OAAO,KAAK,YAAYA,CAAQ,EAGlC,MAAMnF,EAAQ,KAAK,aAAa,+BAChC,GAAI,CAACA,EAAO,MAAO,GAEnB,MAAMW,EASD,GAEL,SAAW,CAAC3C,EAAMpE,CAAI,IAAK,OAAO,QAAQoG,CAAK,EACzCpG,EAAK,WAAaqL,GAAYrL,EAAK,WAAW,WAAasL,GAAYtL,EAAK,mBAAmB,MACjG+G,EAAQ,KAAK,CACX,KAAM/G,EAAK,kBAAkB,KAC7B,YAAaA,EAAK,kBAAkB,aAAe,GACnD,KAAM,OAAOoE,CAAI,EACjB,KAAMpE,EAAK,kBAAkB,KAC7B,UAAWA,EAAK,WAAa,EAC7B,WAAYA,EAAK,WAAW,gBAAkB,EAC9C,WAAYA,EAAK,mBAAqB,EACtC,YAAaA,EAAK,aAAe,EAClC,EAIL,YAAK,YAAYuL,CAAQ,EAAIxE,EACtBA,CACT,CAEA,YAAYY,EAAe6D,EAAiE,CAC1F,MAAMpF,EAAQ,KAAK,aAAa,+BAKhC,GAAI,CAACA,EAAO,MAAO,GAEnB,MAAMW,EAAqD,GAGrD0E,EAAYvK,GAAcA,EAAE,cAAc,QAAQ,cAAe,EAAE,EACnEwK,EAAaD,EAAS9D,CAAK,EAEjC,UAAW3H,KAAQ,OAAO,OAAOoG,CAAK,EAAG,CAIvC,GAFIoF,GAAS,WAAa,QAAaxL,EAAK,WAAW,WAAawL,EAAQ,UACxEA,GAAS,YAAc,QAAaxL,EAAK,YAAcwL,EAAQ,WAC/DA,GAAS,WAAa,QAAaxL,EAAK,WAAawL,EAAQ,SAAU,SAE3E,MAAMG,EAAW3L,EAAK,mBAAmB,KACzC,GAAI,CAAC2L,EAAU,SAEf,MAAMC,EAAYH,EAASE,CAAQ,EACnC,IAAIE,EAAQ,GAGZ,GAAID,EAAU,SAASF,CAAU,EAE/BG,EAAQ,GAAKD,EAAU,OAASF,EAAW,QAAU,YAG9CF,GAAS,OAEZ,KAAK,IAAII,EAAU,OAASF,EAAW,MAAM,GAAK,EAAG,CACvD,MAAMI,EAAO,KAAK,YAAYJ,EAAYE,CAAS,EAE/CE,GAAQ,IACVD,EAAQC,EAEZ,CAGED,IAAU,IACZ9E,EAAQ,KAAK,CACX,KAAM,KAAK,wBAAwB/G,CAAI,EACvC,MAAA6L,CAAA,CACD,CAEL,CAGA9E,EAAQ,KAAK,CAACsB,EAAG5E,IAAM4E,EAAE,MAAQ5E,EAAE,KAAK,EAGxC,MAAM4G,EAAQmB,GAAS,OAAS,GAChC,OAAOzE,EAAQ,MAAM,EAAGsD,CAAK,EAAE,IAAIrO,GAAKA,EAAE,IAAI,CAChD,CAGQ,YAAYqM,EAAW5E,EAAmB,CAChD,GAAI4E,EAAE,SAAW,EAAG,OAAO5E,EAAE,OAC7B,GAAIA,EAAE,SAAW,EAAG,OAAO4E,EAAE,OAE7B,MAAM0D,EAAS,GACf,QAAS5S,EAAI,EAAGA,GAAKsK,EAAE,OAAQtK,IAAK4S,EAAO5S,CAAC,EAAI,CAACA,CAAC,EAClD,QAAS6S,EAAI,EAAGA,GAAK3D,EAAE,OAAQ2D,IAAKD,EAAO,CAAC,EAAEC,CAAC,EAAIA,EAEnD,QAAS7S,EAAI,EAAGA,GAAKsK,EAAE,OAAQtK,IAC7B,QAAS6S,EAAI,EAAGA,GAAK3D,EAAE,OAAQ2D,IACzBvI,EAAE,OAAOtK,EAAI,CAAC,IAAMkP,EAAE,OAAO2D,EAAI,CAAC,EACpCD,EAAO5S,CAAC,EAAE6S,CAAC,EAAID,EAAO5S,EAAI,CAAC,EAAE6S,EAAI,CAAC,EAElCD,EAAO5S,CAAC,EAAE6S,CAAC,EAAI,KAAK,IAClBD,EAAO5S,EAAI,CAAC,EAAE6S,EAAI,CAAC,EAAI,EACvB,KAAK,IAAID,EAAO5S,CAAC,EAAE6S,EAAI,CAAC,EAAI,EAAGD,EAAO5S,EAAI,CAAC,EAAE6S,CAAC,EAAI,CAAC,GAK3D,OAAOD,EAAOtI,EAAE,MAAM,EAAE4E,EAAE,MAAM,CAClC,CAGA,eAAezB,EAAsC,CACnD,MAAMR,EAAQ,KAAK,aAAa,+BAKhC,OAAKA,EAEE,OAAO,OAAOA,CAAK,EACvB,OAAQpG,GAEH,EAAAA,EAAK,WAAW,WAAa,GAC7BA,EAAK,WAAa,GAGlB4G,IAAc,QAAa5G,EAAK,YAAc4G,GAG9C,CAAC5G,EAAK,mBAAmB,KAG9B,EACA,IAAKA,GAAS,KAAK,wBAAwBA,CAAI,CAAC,EAhBhC,EAiBrB,CAEA,kBAAqC,CACnC,MAAMoG,EAAQ,KAAK,aAAa,+BAKhC,OAAKA,EAEE,OAAO,OAAOA,CAAK,EACvB,OAAQpG,GAEH,EAAAA,EAAK,WAAW,WAAa,GAC7BA,EAAK,WAAa,GAGlB,CAACA,EAAK,mBAAmB,KAG9B,EACA,IAAKA,GAAS,KAAK,wBAAwBA,CAAI,CAAC,EAbhC,EAcrB,CAGA,QAAQoE,EAAsG,CAC5G,MAAMiD,EAAQ,KAAK,aAAa,6BAKhC,GAAI,CAACA,EAAO,OAEZ,MAAME,EAAOF,EAAM,OAAOjD,CAAI,CAAC,EAC/B,GAAKmD,EAEL,MAAO,CACL,KAAMA,EAAK,KACX,KAAMA,EAAK,kBAAkB,KAC7B,YAAaA,EAAK,kBAAkB,YACpC,KAAMA,EAAK,kBAAkB,KACzB,GAAGlQ,GAAc,eAAe,GAAGkQ,EAAK,kBAAkB,IAAI,GAC9D,GAER,CAGA,YAAYI,EAAe0C,EAAQ,EAA8E,CAC/G,MAAMhD,EAAQ,KAAK,aAAa,6BAChC,GAAI,CAACA,EAAO,MAAO,GAEnB,MAAMiD,EAAapJ,GAAcA,EAAE,cAAc,QAAQ,cAAe,EAAE,EACpEwK,EAAapB,EAAU3C,CAAK,EAC5BZ,EAAoG,GAE1G,UAAWQ,KAAQ,OAAO,OAAOF,CAAK,EAAG,CACvC,GAAI,CAACE,GAAM,mBAAmB,KAAM,SAEpC,MAAMqE,EAAYtB,EAAU/C,EAAK,kBAAkB,IAAI,EACnDqE,EAAU,SAASF,CAAU,GAC/B3E,EAAQ,KAAK,CACX,KAAMQ,EAAK,kBAAkB,KAC7B,YAAaA,EAAK,kBAAkB,aAAe,GACnD,KAAMA,EAAK,KACX,KAAMA,EAAK,kBAAkB,KAC7B,MAAOqE,EAAU,OAASF,EAAW,OACtC,CAEL,CAEA,OAAO3E,EACJ,KAAK,CAACsB,EAAG5E,IAAM4E,EAAE,MAAQ5E,EAAE,KAAK,EAChC,MAAM,EAAG4G,CAAK,EACd,IAAI,CAAC,CAAE,MAAAwB,EAAO,GAAGI,CAAA,IAAWA,CAAI,CACrC,CAGA,uBAAuBtE,EAAe0C,EAAQ,EAAyD,CACrG,MAAMjE,EAAQ,KAAK,aAAa,+BAChC,GAAI,CAACA,EAAO,MAAO,GAEnB,MAAMkE,EAAapJ,GAAcA,EAAE,cAAc,QAAQ,cAAe,EAAE,EACpEwK,EAAapB,EAAU3C,CAAK,EAC5BZ,EAA+E,GAErF,UAAW/G,KAAQ,OAAO,OAAOoG,CAAK,EACpC,GAAIpG,EAAK,WAAa,GAAKA,EAAK,WAAW,WAAa,EAAG,CACzD,GAAI,CAACA,EAAK,mBAAmB,KAAM,SACnC,MAAM4L,EAAYtB,EAAUtK,EAAK,kBAAkB,IAAI,EACnD4L,EAAU,SAASF,CAAU,GAC/B3E,EAAQ,KAAK,CACX,KAAM/G,EAAK,kBAAkB,KAC7B,KAAMA,EAAK,KACX,KAAMA,EAAK,kBAAkB,KAAO,GAAG3I,GAAc,eAAe,GAAG2I,EAAK,kBAAkB,IAAI,GAAK,OACvG,MAAO4L,EAAU,OAASF,EAAW,OACtC,CAEL,CAGF,OAAO3E,EACJ,KAAK,CAACsB,EAAG5E,IAAM4E,EAAE,MAAQ5E,EAAE,KAAK,EAChC,MAAM,EAAG4G,CAAK,EACd,IAAI,CAAC,CAAE,MAAAwB,EAAO,GAAGI,CAAA,IAAWA,CAAI,CACrC,CAEA,cAAcC,EAAiD,CAC7D,MAAMC,EAAQ,KAAK,aAAa,4BAKhC,GAAKA,GAEL,UAAWC,KAAQ,OAAO,OAAOD,CAAK,EACpC,GAAIC,EAAK,YAAcF,EACrB,MAAO,CAAE,KAAME,EAAK,kBAAkB,MAK5C,CAEA,aAAaxF,EAA2B,CACtC,MAAMqD,EAAU,KAAK,aAAa,uBAKlC,GAAI,CAACA,EAAS,MAAO,UAErB,UAAWoC,KAAO,OAAO,OAAOpC,CAAO,EACrC,GAAIoC,EAAI,YAAczF,EACpB,OAAOyF,EAAI,kBAAkB,KAIjC,MAAO,SACT,CAEA,WAAWjI,EAAkG,CAC3G,MAAMkI,EAAW,KAAK,aAAa,yBACnC,GAAI,CAACA,EAAU,MAAO,GAEtB,MAAMC,EAAUD,EAAS,OAAOlI,CAAI,CAAC,EACrC,OAAKmI,GAAS,kBAEPA,EAAQ,kBACZ,IAAKvM,GAAc,CAClB,MAAMwM,EAAU,KAAK,iBAAiB,iCAAkCxM,EAAK,YAAY,EAIzF,MAHI,CAACwM,GAGDA,EAAQ,WAAa,IAAMA,EAAQ,WAAa,GAAW,KAKxD,CACL,KAAMA,EAAQ,mBAAmB,MAAQ,eACzC,YAAaA,EAAQ,mBAAmB,aAAe,GACvD,KAAMA,EAAQ,KACd,KAAMA,EAAQ,mBAAmB,KAAO,GAAGnV,GAAc,eAAe,GAAGmV,EAAQ,kBAAkB,IAAI,GAAK,OAElH,CAAC,EACA,OAAQzB,GAAWA,IAAM,MAAQA,EAAE,OAAS,OAAO,EAEnD,OAAO,CAACA,EAAQhR,EAAe0S,IAAgB1S,IAAU0S,EAAK,UAAWrJ,GAAWA,GAAG,OAAS2H,GAAG,IAAI,CAAC,EAtBnE,EAuB1C,CAKA,YAAY2B,EAAiI,CAC3I,MAAMC,EAAS,KAAK,iBAAiB,iCAAkCD,CAAU,EACjF,GAAI,CAACC,GAAQ,SAAS,oBAAsB,GAE5C,MAAMC,EAAc,GASdC,EAJeF,EAAO,QAAQ,kBAAkB,KACnD,GAAW,EAAE,qBAAuB,aAGJ,eAAiB,GAEpD,OAAAA,EAAO,QAAQ,cAAc,QAAQ,CAACG,EAAY/S,IAAkB,CAElE,GAAI8S,EAAa,OAAS,GAAK,CAACA,EAAa,SAAS9S,CAAK,EAAG,OAE9D,MAAMgT,EAAcD,EAAM,uBAAyBA,EAAM,oBACzD,GAAIC,EAAa,CACf,MAAM1F,EAAQ,KAAK,WAAW0F,CAAW,EACrC1F,EAAM,OAAS,GACjBuF,EAAK,KAAK,CACR,OAAQ7S,EACR,MAAAsN,CAAA,CACD,CAEL,CACF,CAAC,EAEMuF,CACT,CACA,UAAoB,CAClB,OAAO9H,GAAgB,MAAOoB,GAAU,KAAK,aAAaA,CAAK,IAAM,MAAS,CAChF,CAGA,MAAM,YAA4B,CAChC,MAAM7P,GAAG,gBACT,KAAK,aAAe,GACpB,KAAK,YAAc,EACrB,CAEA,cAAc6D,EAAsBkK,EAA4B,CAC9D,OAAQ,KAAK,aAAalK,CAAS,IAA4B,OAAOkK,CAAI,CAAC,CAC7E,CAGA,iBAAiBlK,EAAsBkK,EAA4B,CACjE,OAAO,KAAK,cAAclK,EAAWkK,CAAI,CAC3C,CAGA,kBAAkB4I,EAA4B,CAC5C,MAAM7C,EAAM,KAAK,iBAAiB,iCAAkC6C,CAAU,EAG9E,OAAO7C,GAAK,MAAM,gBAAgB,eAAiBA,GAAK,QAAQ,eAAiB,CACnF,CAIA,8BAAiG,CAC/F,MAAM8C,EAAQ,KAAK,aAAa,6BAC1BC,EAAS,KAAK,aAAa,8BAC3BC,EAAQ,KAAK,aAAa,6BAEhC,GAAI,CAACF,GAAS,CAACC,GAAU,CAACC,EACxB,OAAO,KAIT,MAAMC,EAAgBlH,GACJ,OAAO,OAAOA,CAAK,EAChC,OAAO9I,GAAK,CAACA,EAAE,QAAQ,EACvB,KAAK,CAACiL,EAAG5E,KAAO4E,EAAE,OAAS,IAAM5E,EAAE,OAAS,EAAE,EAClC,CAAC,GAAG,MAAQ,KAGvB4J,EAAWD,EAAaH,CAAK,EAC7BK,EAAYF,EAAaF,CAAM,EAC/BK,EAAWH,EAAaD,CAAK,EAEnC,OAAIE,IAAa,MAAQC,IAAc,MAAQC,IAAa,KACnD,KAGF,CAAE,SAAAF,EAAU,UAAAC,EAAW,SAAAC,CAAA,CAChC,CAGA,cAAuB,CACrB,MAAMnH,EAAQ,KAAK,aAAa,+BAChC,OAAOA,EAAQ,OAAO,KAAKA,CAAK,EAAE,OAAS,CAC7C,CAGA,cAAuB,CACrB,MAAMA,EAAQ,KAAK,aAAa,+BAChC,GAAI,CAACA,EAAO,MAAO,kBAGnB,MAAMoH,EAAe,aACfC,EAAa,aAEnB,IAAIrT,EAAS,UAAU,OAAO,KAAKgM,CAAK,EAAE,MAAM;AAAA,EAE5CA,EAAMoH,CAAY,EAAGpT,GAAU,mBAAoBgM,EAAMoH,CAAY,EAAU,mBAAmB,IAAI;AAAA,EACrGpT,GAAU,qBAAqBoT,CAAY;AAAA,EAE5CpH,EAAMqH,CAAU,EAAGrT,GAAU,iBAAkBgM,EAAMqH,CAAU,EAAU,mBAAmB,IAAI;AAAA,EAC/FrT,GAAU,mBAAmBqT,CAAU;AAAA,EAG5C,IAAIC,EAAW,GACf,UAAW/W,KAAOyP,EAAO,CAEvB,MAAM+D,EAAM/D,EAAMzP,CAAG,EACrB,GAAIwT,GAAK,mBAAmB,OAAS,gBAAiB,CACpDuD,EAAW/W,EACX,MAAMgX,EAAU,KAAK,UAAUxD,CAAG,EAAE,UAAU,EAAG,GAAG,EACpD/P,GAAU,0BAA0BzD,CAAG;AAAA,aAAiBgX,CAAO,MAC/D,KACF,CACF,CAEA,OAAKD,IAAUtT,GAAU,gDAElBA,CACT,CACF,CA4EO,MAAMwT,EAAkB,IAAI3I,GC17D5B,MAAM4I,EAAW,CAKpB,MAAM,eAAerW,EAAqBsW,EAAgBxI,EAAiBkG,EAA+C,CACtH,MAAM9X,GAAS,MAAAmL,GAAA,gCAAAE,CAAA,QAAM,2BAAAhF,EAAA,EAAoB,uBAAAgF,CAAA,YAAG,gBAAgB,WACtDgP,GAAiBra,EAAM,qBAAqB8D,CAAW,GAAK,IAAI,OAAO2B,GACzE,CAACzB,EAAc,OAAQA,EAAc,UAAWA,EAAc,YAAaA,EAAc,UAAWA,EAAc,WAAW,EAAE,SAASyB,EAAE,UAAU,GAGxJ,GAAI4U,EAAc,SAAW,EAAG,OAGhC,MAAMC,EAAmB,MAAM,QAAQ,IAAID,EAAc,IAAI,MAAM/N,IAAS,CACxE,KAAAA,EACA,SAAUtM,EAAM,cAAcsM,EAAK,cAAe,EAClD,QAAS,MAAMiO,GAAe,eAAejO,EAAK,cAAe,GACnE,CAAC,EAGG,CAAE,YAAAkO,CAAA,EAAgB,KAAK,QAAQJ,EAAME,EAAiB,OAAO3F,GAAKA,EAAE,SAAWA,EAAE,QAAQ,CAAQ,EAEvG,QAASlP,EAAI,EAAGA,EAAI+U,EAAY,OAAQ/U,IAAK,CACzC,MAAMkP,EAAI6F,EAAY/U,CAAC,EAKvB,GAFkB6U,EAAiB,KAAKG,GAAMA,EAAG,KAAK,iBAAmB9F,EAAE,cAAc,GACxD,QAAQ,QAAQ,KAAMnH,GAAWA,EAAE,cAAgBmH,EAAE,WAAW,GAC9E,WAAaA,EAAE,QAC9B,SAKJ,GAFA/C,EAAW,OAAOnM,EAAI,CAAC,IAAI+U,EAAY,MAAM,GAAI,GAAM/U,EAAI+U,EAAY,OAAU,EAAE,GACvE,MAAME,GAAgB,qBAAqB/F,EAAE,eAAgBA,EAAE,QAASA,EAAE,YAAa7Q,EAAagU,CAAO,GAC/G,KAAM,CACVrW,GAAQ,WAAY,4DAA4D,EAChF,KACJ,CAGA,MAAM,IAAI,QAAQ6G,GAAK,WAAWA,EAAG,GAAG,CAAC,CAC7C,CACJ,CAKA,MAAM,2BAA2BqS,EAAuB9R,EAAa/E,EAAqB8N,EAAiBkG,EAA+C,CACtJ,GAAI,CAACjP,GAAU,CAAC8R,EAAS,eAAgB,OAEzC/I,EAAW,0BAA2B,EAAE,EAIxC,MAAMgJ,GADS,MAAAzP,GAAA,gCAAAE,CAAA,QAAM,2BAAAhF,EAAA,EAAoB,uBAAAgF,CAAA,YAAG,gBAAgB,WAC/B,kBAAkB,KAAK5F,GAAKA,EAAE,iBAAmBkV,EAAS,cAAc,EACrG,GAAI,CAACC,GAAkB,CAACA,EAAe,eAAgB,OAEvD,MAAM9B,EAAUoB,EAAgB,iBAAiB,iCAAkCU,EAAe,QAAQ,EAC1G,GAAI,CAAC9B,GAAS,SAAS,kBAAoB,CAACA,EAAQ,QAAQ,cAAe,OAG3E,MAAM+B,EAAiB,MAAMN,GAAe,eAAeK,EAAe,cAAc,EACxF,GAAI,CAACC,EAAgB,OAErB,MAAMC,EAAoC,GAGpCC,EAA2B,WAE3BC,EAAuBC,GAA2B,CACpD,IAAIC,EAAW,EACf,OAAAD,EAAa,QAAQE,GAAK,CAEtB,MAAM/F,EADM8E,EAAgB,iBAAiB,iCAAkCiB,CAAC,GAC9D,iBAAiB,KAAM3N,GAAWA,EAAE,eAAiBuN,CAAwB,EAC3F3F,OAAkBA,EAAK,MAC/B,CAAC,EACM8F,CACX,EAEME,EAAyBnO,GAAwB,CACnD,MAAMmM,EAAQN,EAAQ,QAAQ,cAAc7L,CAAW,EACvD,OAAImM,GAAO,uBAAyBA,EAAM,wBAA0B,EACzDA,EAAM,sBAGbA,GAAO,qBACSc,EAAgB,iBAAiB,2BAA4Bd,EAAM,mBAAmB,GACtF,oBAAoB,CAAC,GAAG,cAAgB,CAGhE,EAGMiC,EAAeC,GACVA,EAAe,QAAQH,GAAK,CAC/B,MAAMI,EAAMzC,EAAQ,QAAQ,iBAAiB,KAAMpN,IAAWA,GAAE,qBAAuByP,CAAC,EACxF,OAAOI,EAAMA,EAAI,cAAgB,EACrC,CAAC,EAAE,KAAK,CAAC5G,EAAG5E,IAAM4E,EAAI5E,CAAC,EAGrByL,EAAwB,CAACC,EAAyBC,IAA4B,CAChF,MAAMC,EAAe,CAAC,GAAGD,CAAa,EAChCE,GAAsE,GAEvEf,EAAe,UAGpBY,EAAc,QAAQI,GAAO,CAEzB,MAAMC,EADSjB,EAAe,QAAQgB,CAAG,GACb,SAEtBE,EAAWJ,EAAa,QAAQG,GAAe,CAAC,EAClDC,IAAa,GAEbJ,EAAa,OAAOI,EAAU,CAAC,EAG/BH,GAAc,KAAK,CAAE,MAAOC,EAAK,YAAAC,EAAa,CAEtD,CAAC,EAGDF,GAAc,QAAQ,CAACI,EAAQvW,IAAM,CACjC,GAAIA,EAAIkW,EAAa,OAEbK,EAAO,cAAgBL,EAAalW,CAAC,IACrCqV,EAAUkB,EAAO,KAAK,EAAIL,EAAalW,CAAC,OAEzC,CAGH,MAAMwW,EAAcb,EAAsBY,EAAO,KAAK,EAClDC,GAAeD,EAAO,cAAgBC,IACtCnB,EAAUkB,EAAO,KAAK,EAAIC,EAElC,CACJ,CAAC,EACL,EAGMC,EAAiBb,EAAY,CAC/BlX,GAAuB,MACvBA,GAAuB,UACvBA,GAAuB,gBAC1B,EAEsB,CACnB,CAAE,KAAM0E,EAAO,UAAW,KAAM,UAChC,CAAE,KAAMA,EAAO,iBAAkB,KAAM,mBACvC,CAAE,KAAMA,EAAO,UAAW,KAAM,SAChC,CAAE,KAAMA,EAAO,YAAa,KAAM,YAClC,CAAE,KAAMA,EAAO,UAAYA,EAAO,aAAc,KAAM,WAAW,EAGtD,QAAQ,CAACsT,EAAS1W,IAAM,CACnC,IAAI2W,EAAaD,EAAQ,KAGzB,MAAME,GAAcH,EAAe,KAAKL,GAAO,CAC3C,GAAIf,EAAUe,CAAG,EAAG,MAAO,GAC3B,MAAMzC,EAAQN,EAAQ,QAAQ,cAAc+C,CAAG,EACzCS,EAAapC,EAAgB,iBAAiB,8BAA+Bd,GAAO,cAAc,EAGxG,GAAIgD,EAAY,CACZ,MAAMG,EAAUrC,EAAgB,iBAAiB,iCAAkCkC,CAAU,EAC7F,OAAOE,GAAY,eAAe,KAAME,GAAWA,EAAE,eAAiBD,GAAS,MAAM,gBAAgB,CACzG,CAIA,OAAO9W,EAAI,CACf,CAAC,EAED,GAAI4W,KAAgB,OAAW,CAO3B,GANKD,IACDA,EAAahB,EAAsBiB,EAAW,GAI5BxB,EAAe,QAAQwB,EAAW,GACrC,WAAaD,EAC5B,OAGAA,IACAtB,EAAUuB,EAAW,EAAID,EAEjC,CACJ,CAAC,EAGD,MAAMK,EAAgBpB,EAAY,CAC9BlX,GAAuB,QACvBA,GAAuB,cACvBA,GAAuB,iBACvBA,GAAuB,gBAC1B,EACG0E,EAAO,SAAW4T,EAAc,OAAS,GACzCjB,EAAsBiB,EAAe5T,EAAO,OAAO,EAIvD,MAAM6T,EAAkBrB,EAAY,CAChClX,GAAuB,UACvBA,GAAuB,gBACvBA,GAAuB,mBACvBA,GAAuB,kBAC1B,EAED,GAAIuY,EAAgB,OAAS,EAAG,CAE5B,IAAIC,EAAe9T,EAAO,QAC1B,GAAI,CAAC8T,GAAgBA,EAAa,SAAW,EAAG,CAC5C,MAAMF,GAAgBpB,EAAY,CAC9BlX,GAAuB,QACvBA,GAAuB,cACvBA,GAAuB,iBACvBA,GAAuB,gBAC1B,EACG0W,GAAgB,UAChB8B,EAAeF,GACV,IAAIZ,GAAOhB,EAAe,QAAQgB,CAAG,GAAG,QAAQ,EAChD,OAAO,OAAO,EAE3B,CAEA,MAAMX,EAAWF,EAAoB2B,GAAgB,EAAE,EACjDC,GAAoB/T,EAAO,WAAa,IAAI,MAAM,EAAGqS,CAAQ,EACnEM,EAAsBkB,EAAgB,MAAM,EAAGxB,CAAQ,EAAG0B,CAAgB,CAC9E,CAGA,GAAI,OAAO,KAAK9B,CAAS,EAAE,OAAS,EAAG,CAEnC,MAAM+B,EAAgB,OAAO,KAAK/B,CAAS,EAAE,IAAI,MAAM,EAAE,KAAK,CAACnG,EAAG5E,IAAM4E,EAAI5E,CAAC,EAC7E,UAAW8L,KAAOgB,EAAe,CAE7B,IADY,MAAMnC,GAAgB,qBAAqBC,EAAS,eAAgBG,EAAUe,CAAG,EAAGA,EAAK/X,EAAagU,CAAO,GACjH,KAAM,CACVrW,GAAQ,WAAY,6DAA6D,EACjF,KACJ,CACA,MAAM,IAAI,QAAQ6G,IAAK,WAAWA,GAAG,GAAG,CAAC,CAC7C,CACJ,CACJ,CAKA,iBAAiBwU,EAAyB,CAEtC,OADY5C,EAAgB,iBAAiB,iCAAkC4C,CAAO,GAC1E,MAAM,YAAY,YAAc,CAChD,CAKA,UAAUC,EAAkBD,EAAiB7P,EAA8B,CACvE,MAAM6L,EAAUoB,EAAgB,iBAAiB,iCAAkC6C,CAAQ,EACrFC,EAAS9C,EAAgB,iBAAiB,iCAAkC4C,CAAO,EAMzF,GAJI,CAAChE,GAAW,CAACkE,GAIb,CADkBA,EAAO,oBAAoB,SAAS,EAAE,GACtCA,EAAO,WAAa,GAAI,MAAO,GAGrD,MAAM5D,EAAQN,EAAQ,SAAS,gBAAgB7L,CAAW,EAC1D,GAAI,CAACmM,EAAO,MAAO,GAGnB,MAAM6D,EAAiB7D,EAAM,eAQ7B,GAPsBc,EAAgB,iBAAiB,8BAA+B+C,CAAc,GAG/D,eAAe,KAAMT,GACtDQ,EAAO,MAAM,mBAAqBR,EAAE,cAGrB,MAAO,GAG1B,MAAMU,EAAkBF,EAAO,MAAM,iBAUrC,MAR4C,CACxC,UAAWhZ,EAAc,OACzB,WAAYA,EAAc,UAC1B,WAAYA,EAAc,YAC1B,WAAYA,EAAc,UAC1B,WAAYA,EAAc,aAGdkZ,CAAe,IAAMpE,EAAQ,WAAW,cAG5D,CAMA,QACIsB,EACA1H,EACsD,CACtD,MAAM8H,EAA+B,GAC/B2C,EAAuB,CAAC,GAAG/C,CAAI,EAG/BgD,EAAc,CAAC,GAAG1K,CAAK,EAAE,KAAK,CAACiC,EAAG5E,IAAM,CAC1C,MAAMsN,EAAY1I,EAAE,SAAS,QAAQ,gBAAkB,EAEvD,OADkB5E,EAAE,SAAS,QAAQ,gBAAkB,GACpCsN,CACvB,CAAC,EAKD,UAAWP,KAAW1C,EAAM,CACxB,MAAMkD,EAAO,KAAK,iBAAiBR,CAAO,EAG1C,IAAIS,EAAc,GACdC,EAAgB,GAEpB,QAAS/X,EAAI,EAAGA,EAAI2X,EAAY,OAAQ3X,IAAK,CACzC,KAAM,CAAE,KAAMgY,EAAW,SAAApQ,EAAU,QAAAqQ,CAAA,EAAYN,EAAY3X,CAAC,EACtDkY,GAActQ,EAAS,QAAQ,gBAAkB,IAAMA,EAAS,QAAQ,YAAc,GAE5F,GAAIA,GAAU,QAAUsQ,GAAcL,EAAM,CAExC,MAAMM,EAAoBF,GAAS,SAAS,UAAUlQ,GAClDA,EAAE,WACF,CAACgN,EAAY,KAAK7F,GAAKA,EAAE,iBAAmB8I,EAAU,gBAAkB9I,EAAE,cAAgBnH,EAAE,WAAW,GAG3G,GAAIoQ,IAAsB,QAAaA,IAAsB,GAAI,CAC7DL,EAAc9X,EACd+X,EAAgBI,EAChB,KACJ,CACJ,CACJ,CAEA,GAAIL,IAAgB,GAAI,CACpB,MAAMjR,EAAO8Q,EAAYG,CAAW,EACpC/C,EAAY,KAAK,CACb,eAAgBlO,EAAK,KAAK,eAC1B,YAAaA,EAAK,QAAQ,QAAQkR,CAAa,EAAE,YACjD,QAAAV,CAAA,CACH,EAEGxQ,EAAK,SAAS,SACdA,EAAK,SAAS,OAAO,YAAcgR,GAIvC,MAAMzB,EAAMsB,EAAW,QAAQL,CAAO,EAClCjB,IAAQ,IAAIsB,EAAW,OAAOtB,EAAK,CAAC,CAC5C,CACJ,CAEA,MAAO,CAAE,YAAArB,EAAa,WAAA2C,CAAA,CAC1B,CAKA,cAAc9P,EAAwBwQ,EAAwC,CAC1E,MAAMC,EAAczQ,EAAS,QAAQ,YAAc,EAC7C6N,EAAW7N,EAAS,QAAQ,gBAAkB,EAC9C0Q,EAAiBF,EAAoB,OAAO,CAACG,EAAKtN,IAASsN,EAAM,KAAK,iBAAiBtN,CAAI,EAAG,CAAC,EAErG,OAAQoN,EAAcC,GAAmB7C,CAC7C,CAKA,YAAY+C,EAAiBC,EAA8B,CACvD,MAAM9D,EAAiB,GAGvBA,EAAK,KAAK,UAAU,EAkBpB,MAAM+D,EATqC,CACvC,KAAQ,WACR,MAAS,WACT,IAAO,WACP,OAAU,WACV,OAAU,WACV,UAAa,YAGYF,EAAQ,aAAa,EAClD,OAAIE,IACA/D,EAAK,KAAK+D,CAAS,EACfD,IAAe,YAAY9D,EAAK,KAAK+D,CAAS,GAItD/D,EAAK,KAAK,SAAS,EAGnBA,EAAK,KAAK,UAAU,EACpBA,EAAK,KAAK,QAAQ,EAClBA,EAAK,KAAK,UAAU,EAEbA,CACX,CACJ,CAEO,MAAMgE,GAAa,IAAIjE,GCjbxBkE,GAA6B,GAI5B,SAASC,GAAeC,EAAkC,CAC/D,MAAMC,EAAgCH,GAAO,OAASA,GAAO,GAAG,EAAE,EAAK,QAAQ,UAGzEI,EAAa,SAAY,CAC7B,IAAI3W,EACJ,GAAI,aAAc,UAChB,GAAI,CACFA,EAAW,MAAO,UAAkB,SAAS,QAAQ,QAAQ,CAC/D,OAAS4B,EAAG,CACVjI,GAAQ,WAAY,qCAAsCiI,CAAC,CAC7D,CAEF,GAAI,CACF,OAAO,MAAM6U,EAAA,CACf,SACE,MAAMzW,GAAU,SAClB,CACF,EAIM4W,EAAiBF,EAAY,KAAKC,EAAYA,CAAU,EAAE,KAC7Dpb,IACCgb,GAAO,QACAhb,GAERqG,GAAM,CACL,MAAA2U,GAAO,QACD3U,CACR,GAEF,OAAA2U,GAAO,KAAKK,CAAc,EAEnBA,CACT,CC1BA,MAAMC,OAAoB,IAAI,CAC5B3a,EAAc,gBACdA,EAAc,eACdA,EAAc,cACdA,EAAc,OACdA,EAAc,UACdA,EAAc,YACdA,EAAc,UACdA,EAAc,YACdA,EAAc,MACdA,EAAc,QAChB,CAAC,EAEK4a,GAA4C,CAChD,CAAC5a,EAAc,eAAe,EAAG,GACjC,CAACA,EAAc,cAAc,EAAG,GAChC,CAACA,EAAc,aAAa,EAAG,GAC/B,CAACA,EAAc,MAAM,EAAG,GACxB,CAACA,EAAc,SAAS,EAAG,GAC3B,CAACA,EAAc,WAAW,EAAG,GAC7B,CAACA,EAAc,SAAS,EAAG,GAC3B,CAACA,EAAc,WAAW,EAAG,GAC7B,CAACA,EAAc,KAAK,EAAG,GACvB,CAACA,EAAc,QAAQ,EAAG,GAC1B,CAACA,EAAc,WAAW,EAAG,GAC7B,CAACA,EAAc,aAAa,EAAG,EACjC,EAEM6a,GAAuB,IAMvBC,GAAwC,CAC5C,WAAY,WACZ,WAAY,WACZ,WAAY,WACZ,WAAY,WACZ,WAAY,WACZ,WAAY,WACZ,WAAY,WACZ,WAAY,WACZ,WAAY,UACd,EAwBO,SAASC,GAAkBC,EAA0C,GAAIC,EAAa,EAAGC,EAA0C,CACxI,MAAO,CACL,8BAA+B,IAC/B,uBAAwB,IACxB,6BAA8B,IAC9B,cAAe,IAAI,IAAIF,CAAe,EACtC,kBAAmB,IACnB,QAAS,GACT,OAAQ,GACR,WAAY,EACZ,WAAAC,EACA,UAAW,KAAK,MAChB,mBAAAC,EACA,aAAc,EAAC,CAEnB,CAEA,MAAMC,EAAgB,CAEpB,MAAM,aACJC,EACArC,EACAsC,EACAvb,EACAwb,EAAY,EACZC,EACAzH,EACyB,CACpBA,GAAS,QAAQrW,GAAQ,WAAY,uBAAwB,CAAE,eAAA2d,EAAgB,QAAAC,EAAS,YAAAvb,EAAa,EAC1G,KAAM,CAAE,kBAAA0b,CAAA,EAAsBnU,EAAgB,WACxC,CAAE,SAAAoU,CAAA,EAAapW,GAAc,WAE7BmD,EAAW6S,EAAU,QAAUvb,EACrC0b,EAAkBJ,EAAgB5S,CAAQ,EAE1C,MAAMvB,EAAa,MAAMsP,GAAe,uBACxC,GAAI,CAACtP,EAAY,MAAO,CAAE,QAAS,GAAO,MAAO,gBAAiB,QAAS,CAAE,OAAQmU,EAAgB,SAAArC,EAAU,YAAavQ,EAAU,OAAQ,WAAW,EAEzJ,IAAIxM,EAAQqL,EAAgB,WACxBiB,EAAOtM,EAAM,kBAAkB,KAAKyF,GAAKA,EAAE,iBAAmB2Z,CAAc,EAEhF,GAAI,CAAC9S,IACHhL,GAAS,WAAY,sBAAsB8d,CAAc,mEAAmE,EAC5H,MAAMM,GAAc,YAAY,EAAI,EACpC1f,EAAQqL,EAAgB,WACxBiB,EAAOtM,EAAM,kBAAkB,KAAKyF,GAAKA,EAAE,iBAAmB2Z,CAAc,EAExE,CAAC9S,GACH,OAAA3K,GAAS,WAAY,sBAAsByd,CAAc,yCAAyC,EAC3F,CAAE,QAAS,GAAO,MAAO,eAAgB,QAAS,CAAE,OAAQA,EAAgB,SAAArC,EAAU,YAAavQ,EAAU,OAAQ,WAAW,EAM3I,MAAMmT,EAAWN,EAAUvb,EAAc,QAEnC8b,GADcD,IAAa,QAAU3f,EAAM,eAAkBA,EAAM,qBAAqB2f,CAAQ,GAAK,IACzE,OAAQla,GAAWA,EAAE,WAAa6G,EAAK,QAAQ,EAAE,OAAS,EACtFuT,EAAqBvT,EAAK,UAAYsT,GAAmBtT,EAAK,MAAQ,KAAO,EAAK,OAClFwT,GAAaxT,EAAK,MAAQ,KAAO,EAEvC,GAAIiT,GACEF,GAAWE,EAAQ,mBAAmB,IAAI,KAAK,oBAAoBjT,CAAI,CAAC,EAAG,MAAO,CAAE,QAAS,GAAO,MAAO,aAAc,QAAS,CAAE,OAAQ8S,EAAgB,SAAArC,EAAU,YAAa,QAAS,OAAQ,WAAW,EAOrN,GAAI,CAACsC,GAAW,CAACvH,GAAS,eAAgB,CACxC,MAAM3U,EAAQnD,EAAM,WAAW,KAAK0L,GAAKA,EAAE,cAAgB5H,CAAW,EACtE,GAAIX,EAAO,CACT,MAAM4c,EAAa,KAAK,oBAAoBzT,CAAI,EAGhD,GAFc,KAAK,iBAAiByT,EAAYjc,EAAa9D,EAAOuf,CAAO,GAE9D,EAAG,CAGd,GAFA9d,GAAQ,WAAY,eAAeqC,CAAW,aAAaic,CAAU,mBAAmB,EAEpF,CADe,MAAM,KAAK,qBAAqBzT,EAAMnJ,EAAO,EAAGoc,GAAWR,GAAkB,CAACK,CAAc,CAAC,CAAC,EAE/G,MAAO,CAAE,QAAS,GAAO,MAAO,UAAW,QAAS,CAAE,OAAQA,EAAgB,SAAArC,EAAU,YAAajZ,EAAa,OAAQ,WAAW,EAGvI9D,EAAQqL,EAAgB,UAC1B,CACF,CACF,CAEA,GAAI,CACFkP,GAAe,iBAAiB,CAC9B,WAAY6E,EACZ,SAAUC,EAAUvb,EAAc,QAClC,SAAUub,EAAU,QAAUvb,EAC9B,QAAS,GACV,EAED,MAAM6D,EAAW2E,EAAK,aAAetI,EAAc,WAAaL,GAAc,UAAU,mBAAqBA,GAAc,UAAU,aAUrI,GATA,MAAMmH,GAAU,KAAKnD,EAAU,CAC7B,kBAAmBoV,EACnB,UAAAuC,EACA,gBAAiBD,EACjB,OAAQD,EACR,YAAAtb,EACA,eAAgBmH,EAAW,gBAC1B,EAAI,EAEH4U,IAAsB,QAEvB,SAAY,CACX,MAAMG,EAAaX,EAAUrf,EAAM,WAAW,CAAC,EAAE,YAAc8D,EAC/DrC,GAAQ,WAAY,4BAA4B6K,GAAM,QAAQ,OAAOuT,CAAiB,2CAA2C,EACjI,MAAM,KAAK,iBAAiBT,EAAgBY,EAAYH,CAAiB,CAC3E,aACSC,EAAW,CACpB,MAAME,EAAaX,EAAUrf,EAAM,WAAW,CAAC,EAAE,YAAc8D,EAC/D,MAAM,KAAK,iBAAiBsb,EAAgBY,EAAY,EAAI,CAC9D,CAEA,GAAI,CAAClI,GAAS,OAAQ,CACpB,MAAMgB,EAAUoB,EAAgB,QAAQ6C,CAAQ,EAChD0C,EAAS,CAAE,KAAM,UAAW,QAAS,GAAG3G,GAAS,mBAAmB,MAAQ,MAAM,SAAU,SAAU,IAAM,CAC9G,CAEA,MAAO,CAAE,QAAS,GAAM,QAAS,CAAE,OAAQsG,EAAgB,SAAArC,EAAU,YAAavQ,EAAU,OAAQ,WAAW,CACjH,OAAS5H,EAAY,CAInB,IAFoBA,GAAO,aAAe,KAAOA,GAAO,aAAe,KAAOA,GAAO,YAAc,OAEhF,CAACkT,GAAS,SACvB,CAACyH,GAAWA,EAAQ,WAAa,GAAG,CACtC,MAAMlX,EAAWzD,GAAO,YAAc,KAAO,IAAO,KAAQ2a,EAAUA,EAAQ,WAAa,EAAI,GAC/F,OAAA9d,GAAQ,WAAY,oBAAoBmD,GAAO,WAAaA,GAAO,UAAU,wBAAwBwa,CAAc,aAAa/W,CAAQ,oBAAoB,EAE5J,MAAM,IAAI,QAAQC,IAAK,WAAWA,GAAGD,CAAQ,CAAC,EAC1CkX,GAASA,EAAQ,aACd,KAAK,aAAaH,EAAgBrC,EAAUsC,EAASvb,EAAawb,EAAWC,EAASzH,CAAO,CACtG,CAIF,GAAIlT,GAAO,aAAe,KAAOA,GAAO,mBAAoB,CAC1DnD,GAAQ,WAAY,gCAAgC2d,CAAc,8BAA8B,EAEhG,MAAM,IAAI,QAAQ9W,GAAK,WAAWA,EAAG,IAAI,CAAC,EAC1C,MAAMoX,GAAc,YAAY,EAAI,EAEpC,IAAIO,EAAc5U,EAAgB,WAC9B6U,GAAaD,EAAY,kBAAkB,KAAKxa,GAAKA,EAAE,iBAAmB2Z,CAAc,EACxFe,EAAiBD,GAAa,KAAK,cAAcA,EAAU,EAAI,UACnE,MAAME,EAAiBf,EAAU,QAAUvb,EAE3C,GAAIqc,IAAmBC,EAAgB,CAErC,GADA3e,GAAQ,WAAY,8BAA8B2d,CAAc,uBAAuBgB,CAAc,EAAE,EACnG,CAACtI,GAAS,QAAU,CAACuH,EAAS,CAEhC,MAAMpH,EADMiC,EAAgB,QAAQ6C,CAAQ,GACtB,mBAAmB,MAAQ,OACjD0C,EAAS,CAAE,KAAM,UAAW,QAAS,GAAGxH,CAAQ,sBAAuB,CACzE,CACA,MAAO,CAAE,QAAS,GAAM,QAAS,CAAE,OAAQmH,EAAgB,SAAArC,EAAU,YAAavQ,EAAU,OAAQ,WAAW,CACjH,CAQA,GALA,MAAM,IAAI,QAAQlE,GAAK,WAAWA,EAAG,GAAI,CAAC,EAC1C,MAAMoX,GAAc,YAAY,EAAI,EACpCO,EAAc5U,EAAgB,WAC9B6U,GAAaD,EAAY,kBAAkB,KAAKxa,GAAKA,EAAE,iBAAmB2Z,CAAc,EACxFe,EAAiBD,GAAa,KAAK,cAAcA,EAAU,EAAI,UAC3DC,IAAmBC,EAAgB,CAErC,GADA3e,GAAQ,WAAY,sCAAsC2d,CAAc,uBAAuBgB,CAAc,EAAE,EAC3G,CAACtI,GAAS,QAAU,CAACuH,EAAS,CAEhC,MAAMpH,EADMiC,EAAgB,QAAQ6C,CAAQ,GACtB,mBAAmB,MAAQ,OACjD0C,EAAS,CAAE,KAAM,UAAW,QAAS,GAAGxH,CAAQ,sBAAuB,CACzE,CACA,MAAO,CAAE,QAAS,GAAM,QAAS,CAAE,OAAQmH,EAAgB,SAAArC,EAAU,YAAavQ,EAAU,OAAQ,WAAW,CACjH,CACF,CAEA,MAAM6T,EAAYzb,aAAiBgF,IAAkBhF,EAAM,iBAAoBA,GAAO,YAAc,KACpG,OAAA8a,GAAc,YAAY,EAAI,EACzB5H,GAAS,QAAQ2H,EAAS,CAAE,KAAM,QAAS,QAAS7a,EAAM,SAAW,kBAAmB,EACtF,CAAE,QAAS,GAAO,MAAOyb,EAAW,UAAYzb,EAAM,QAAS,QAAS,CAAE,OAAQwa,EAAgB,SAAArC,EAAU,YAAavQ,EAAU,OAAQ,WAAW,CAC/J,SACEnB,EAAgB,WAAW,qBAAqB+T,CAAc,CAChE,CACF,CAEA,MAAM,UAAUA,EAAwBtb,EAAqBgU,EAAyD,CACpH,KAAM,CAAE,kBAAA0H,CAAA,EAAsBnU,EAAgB,WACxC,CAAE,SAAAoU,CAAA,EAAapW,GAAc,WACnCmW,EAAkBJ,EAAgBtb,CAAW,EAE7C,MAAM9D,EAAQqL,EAAgB,WACxBiV,EAAYtgB,EAAM,WAAW,KAAK0L,GAAKA,EAAE,cAAgB5H,CAAW,EAC1E,GAAI,CAACwc,EAAW,MAAO,CAAE,QAAS,GAAO,MAAO,iBAAkB,QAAS,CAAE,OAAQlB,EAAgB,SAAU,EAAG,YAAatb,EAAa,OAAQ,QAAQ,EAE5J,MAAMwI,EAAOtM,EAAM,kBAAkB,KAAKyF,GAAKA,EAAE,iBAAmB2Z,CAAc,EAClF,GAAI9S,IAC0BtM,EAAM,mBAAmB8D,CAAW,GAAK,IAAI,KAAK2B,GAAKA,EAAE,iBAAmB2Z,CAAc,EAEpH,OAAA9d,GAAS,WAAY,QAAQgL,EAAK,QAAQ,2BAA2BxI,CAAW,sBAAsB,EAC/F,CAAE,QAAS,GAAM,QAAS,CAAE,OAAQsb,EAAgB,SAAU9S,EAAK,SAAU,YAAaxI,EAAa,OAAQ,QAAQ,EAKlI,MAAMD,GADa,MAAM0W,GAAe,yBACL,gBAAkB+F,EAAU,eAG/D,GAAIhU,EAAM,CACR,MAAMwM,EAAUoB,EAAgB,QAAQ5N,EAAK,QAAQ,EACrD,GAAIwM,GAAS,WAAW,eAAgB,CAEtC,MAAMyH,GADmBvgB,EAAM,qBAAqB8D,CAAW,GAAK,IAClC,KAAK2B,GACzByU,EAAgB,QAAQzU,EAAE,QAAQ,GAClC,WAAW,iBAAmBqT,EAAQ,WAAW,gBAAkBrT,EAAE,iBAAmB2Z,GAAkB3Z,EAAE,aAAe6G,EAAK,UAC7I,EAED,GAAIiU,EAAU,CACZ9e,GAAQ,WAAY,0CAA0C8e,EAAS,cAAc,aAAanB,CAAc,EAAE,EAElH,MAAMoB,EAAU,IAAI,IAAqB,CAACpB,EAAgBmB,EAAS,cAAe,CAAC,EAC7EE,EAAc,KAAK,oBAAoBF,EAAS,WAAYzc,EAAa0c,EAASF,EAAU,SAAS,EAE3G,GAAIG,EAAa,CACf,MAAMC,EAAM,KAAK,cAAcD,CAAW,EAC1C,GAAIC,IAAQ5c,EAAa,CACvB,MAAMyb,EAAUR,GAAkB,CAAC0B,EAAY,eAAiBrB,CAAc,EAAG,EAAGtb,CAAW,EACzF6c,EAAM,MAAM,KAAK,SAASF,EAAaC,EAAK5c,EAAayb,EAAS,CAAE,OAAQ,GAAM,EACxF,GAAI,CAACoB,EAAI,QACP,OAAAhf,GAAS,WAAY,8BAA8B8e,EAAY,cAAc,yBAAyBE,EAAI,KAAK,EAAE,EAC1GA,CAEX,CACA,MAAMC,EAAW,MAAM,KAAK,UAAUH,EAAY,eAAiB3c,EAAa,CAAE,OAAQ,GAAM,EAC3F8c,EAAS,SACZjf,GAAS,WAAY,+BAA+B8e,EAAY,cAAc,KAAKG,EAAS,KAAK,EAAE,CAGvG,MACEjf,GAAS,WAAY,yDAAyD4e,EAAS,UAAU,EAAE,CAGvG,CACF,CACF,CAEA,GAAI,CAIF,GAHAhG,GAAe,iBAAiB,CAAE,WAAY6E,EAAgB,SAAUtb,EAAa,SAAUA,EAAa,QAAS,GAAM,EAC3H,MAAMgH,GAAU,KAAKnH,GAAc,UAAU,UAAW,CAAE,OAAQyb,EAAgB,YAAAtb,EAAa,eAAAD,CAAA,EAAkB,EAAI,EAEjH,CAACiU,GAAS,OAAQ,CACpB,MAAMgB,EAAUoB,EAAgB,QAAQ7O,EAAgB,WAAW,cAAc+T,CAAc,GAAG,UAAY,CAAC,EAC/GK,EAAS,CAAE,KAAM,UAAW,QAAS,GAAG3G,GAAS,mBAAmB,MAAQ,MAAM,YAAa,SAAU,IAAM,CACjH,CACA,MAAO,CAAE,QAAS,GAAM,QAAS,CAAE,OAAQsG,EAAgB,SAAU,EAAG,YAAatb,EAAa,OAAQ,QAAQ,CACpH,OAASc,EAAY,CACnB,MAAM8F,EAAY9F,GAAO,UAGzB,IAAKA,GAAO,aAAe,KAAOA,GAAO,aAAe,MAAQ,CAACkT,GAAS,QAGpE,CAACA,GAAS,OACZ,OAAArW,GAAQ,WAAY,6BAA6B2d,CAAc,oBAAoB,EACnF,MAAM,IAAI,QAAQ9W,GAAK,WAAWA,EAAG,GAAI,CAAC,EACnC,KAAK,UAAU8W,EAAgBtb,EAAa,CAAE,GAAGgU,EAAS,OAAQ,GAAM,EAKnF,GAAIlT,GAAO,aAAe,KAAOA,GAAO,mBAAoB,CAC1DtD,GAAS,WAAY,6BAA6B8d,CAAc,8BAA8B,EAC9F,MAAM,IAAI,QAAQ9W,GAAK,WAAWA,EAAG,IAAI,CAAC,EAC1C,MAAMoX,GAAc,YAAY,EAAI,EAEpC,IAAImB,EAAkBxV,EAAgB,WAAW,cAAc+T,CAAc,EAC7E,GAAIyB,GAAiB,WAAY,CAE/B,GADApf,GAAQ,WAAY,8BAA8B2d,CAAc,aAAatb,CAAW,EAAE,EACtF,CAACgU,GAAS,OAAQ,CACpB,MAAMG,EAAWiC,EAAgB,QAAQ2G,EAAgB,UAAY,CAAC,GAAK,OAC3EpB,EAAS,CAAE,KAAM,UAAW,QAAS,GAAGxH,CAAQ,YAAa,CAC/D,CACA,MAAO,CAAE,QAAS,GAAM,QAAS,CAAE,OAAQmH,EAAgB,SAAU,EAAG,YAAatb,EAAa,OAAQ,QAAQ,CACpH,CAMA,GAHA,MAAM,IAAI,QAAQwE,GAAK,WAAWA,EAAG,GAAI,CAAC,EAC1C,MAAMoX,GAAc,YAAY,EAAI,EACpCmB,EAAkBxV,EAAgB,WAAW,cAAc+T,CAAc,EACrEyB,GAAiB,WAAY,CAE/B,GADApf,GAAQ,WAAY,sCAAsC2d,CAAc,aAAatb,CAAW,EAAE,EAC9F,CAACgU,GAAS,OAAQ,CACpB,MAAMG,EAAWiC,EAAgB,QAAQ2G,EAAgB,UAAY,CAAC,GAAK,OAC3EpB,EAAS,CAAE,KAAM,UAAW,QAAS,GAAGxH,CAAQ,YAAa,CAC/D,CACA,MAAO,CAAE,QAAS,GAAM,QAAS,CAAE,OAAQmH,EAAgB,SAAU,EAAG,YAAatb,EAAa,OAAQ,QAAQ,CACpH,CACF,CAEA,OAAI4G,IAAcnD,GAAmB,qBAAuB3C,GAAO,aAAe,OAChF,MAAM8a,GAAc,YAAY,EAAI,EACZrU,EAAgB,WAAW,cAAc+T,CAAc,GAC1D,YAAmB,CAAE,QAAS,GAAM,QAAS,CAAE,OAAQA,EAAgB,SAAU,EAAG,YAAatb,EAAa,OAAQ,QAAQ,GAEhJgU,GAAS,QAAQ2H,EAAS,CAAE,KAAM,QAAS,QAAS7a,EAAM,SAAW,eAAgB,EACnF,CAAE,QAAS,GAAO,MAAOA,EAAM,QAAS,QAAS,CAAE,OAAQwa,EAAgB,SAAU,EAAG,YAAatb,EAAa,OAAQ,QAAQ,EAC3I,SACEuH,EAAgB,WAAW,qBAAqB+T,CAAc,CAChE,CACF,CAEA,MAAM,cAAcA,EAAwBrC,EAAkBsC,EAAkBvb,EAAqByb,EAAsBzH,EAAyD,CAElL,MAAMxL,EADQjB,EAAgB,WACX,kBAAkB,KAAK5F,GAAKA,EAAE,iBAAmB2Z,CAAc,EAClF,OAAK9S,EACE,KAAK,SAASA,EAAM,KAAK,cAAcA,CAAI,EAAG+S,EAAU,QAAUvb,EAAayb,EAASzH,CAAO,EADpF,CAAE,QAAS,GAAO,MAAO,YAAa,QAAS,CAAE,OAAQsH,EAAgB,SAAArC,EAAU,YAAasC,EAAU,QAAUvb,EAAa,OAAQ,WAAW,CAExK,CAEA,MAAM,gBAAgBA,EAAqBgd,EAAqE,CAC9G,MAAM7V,EAAa,MAAMsP,GAAe,uBAClCwG,EAAc7G,EAAgB,+BACpC,GAAI,CAACjP,GAAc,CAAC8V,QAAoB,CAAE,QAAS,GAAO,MAAO,gBACjE,GAAI,CACF,aAAMjW,GAAU,KAAKnH,GAAc,UAAU,gBAAiB,CAC5D,aAAAmd,EACA,YAAAhd,EACA,eAAgBmH,EAAW,eAC3B,UAAW8V,EAAY,UACvB,SAAUA,EAAY,SACtB,SAAUA,EAAY,UACrB,EAAI,EACA,CAAE,QAAS,GACpB,OAASrX,EAAQ,CAAE,MAAO,CAAE,QAAS,GAAO,MAAOA,EAAE,QAAW,CAClE,CAEA,MAAM,gBAAgB5F,EAAqBic,EAA6C,CACtF,MAAM/f,EAAQqL,EAAgB,WACxBkU,EAAUR,GAAkB,GAAI,CAAC,EACjCiC,EAAa,KAAK,wBAAwBjB,EAAYjc,EAAayb,EAASvf,CAAK,EACvF,OAAIghB,EAAW,OAAS,EAAU,KAAK,SAASA,EAAW,CAAC,EAAGld,EAAa,QAASyb,EAAS,CAAE,OAAQ,GAAM,EACvG,CAAE,QAAS,GAAO,MAAO,gBAAiB,QAAS,CAAE,OAAQ,GAAI,SAAU,EAAG,YAAa,QAAS,OAAQ,WAAW,CAChI,CAEA,MAAM,yBAAyBH,EAAwBtE,EAAmChX,EAAqBmd,EAAgD,CAE7J,MAAM5T,EADQhC,EAAgB,WACP,cAAc+T,CAAc,EACnD,SAAW,CAACvD,EAAKnL,CAAI,IAAK,OAAO,QAAQoK,CAAS,EAAG,CACnD,MAAM7N,EAAc,SAAS4O,CAAG,EAChC,GAAIxO,GAAU,SAAS,KAAKG,GAAKA,EAAE,cAAgBP,CAAW,GAAG,WAAayD,EAC9E,GAAI,CACF,MAAM,KAAK,qBAAqB0O,EAAgB1O,EAAMzD,EAAanJ,EAAa,CAAE,OAAQ,GAAM,EAChG,MAAM,IAAI,QAAQwE,GAAK,WAAWA,EAAG,GAAG,CAAC,CAC3C,OAASoB,EAAQ,EACXA,EAAE,aAAe,KAAOA,EAAE,YAAc,KAC1C,MAAMgW,GAAc,YAAY,EAAI,EACpC,MAAM,IAAI,QAAQpX,GAAK,WAAWA,EAAG,GAAI,CAAC,EAE9C,CACF,CACA,MAAMoX,GAAc,YAAY,EAAI,CACtC,CAEA,MAAM,WAAWwB,EAA2Bpd,EAAqBqd,EAAa,EAAGrJ,EAAqI,CACpN,GAAIoJ,EAAgB,SAAW,EAAG,MAAO,CAAE,QAAS,GAAM,UAAW,GAAI,QAAS,EAAC,EACnF,GAAIC,EAAa,EAAG,MAAO,CAAE,QAAS,GAAO,UAAWD,EAAiB,QAAS,EAAC,EAEnF,MAAMlhB,EAAQqL,EAAgB,WACxBiV,EAAYtgB,EAAM,WAAW,KAAK0L,GAAKA,EAAE,cAAgB5H,CAAW,EAGpEsd,EAAkBphB,EAAM,mBAAmB8D,CAAW,GAAK,GAC3Dud,EAAcH,EAAgB,OAAO/Z,GAAM,CAACia,EAAgB,KAAKE,GAAMA,EAAG,iBAAmBna,CAAE,CAAC,EAEtG,GAAIka,EAAY,SAAW,EACzB,OAAA/f,GAAS,WAAY,qDAAqDwC,CAAW,sBAAsB,EACpG,CAAE,QAAS,GAAM,UAAW,GAAI,QAAS,EAAC,EAInD,MAAMD,GADa,MAAM0W,GAAe,yBACL,gBAAkB+F,GAAW,eAEhE,GAAI,CACF,MAAMhX,EAAW,MAAMwB,GAAU,KAC/BnH,GAAc,UAAU,WACxB,CAAE,QAAS0d,EAAa,YAAAvd,EAAa,eAAAD,CAAA,EACrC,IAGIwP,EAAkC,GAClCkO,EAAsB,GAC5B,IAAIC,EAAa,GAWjB,OATAlY,EAAS,aAAa,QAAQhB,GAAK,CACjC+K,EAAQ/K,EAAE,cAAc,EAAIA,EAAE,YAC1BA,EAAE,cAAgB,EAAGiS,GAAe,iBAAiB,CAAE,WAAYjS,EAAE,eAAgB,SAAUxE,EAAa,SAAUA,EAAa,QAAS,GAAM,GAEpJyd,EAAU,KAAKjZ,EAAE,cAAc,GAC3BA,EAAE,cAAgB,MAAQA,EAAE,cAAgB,QAAMkZ,EAAa,IAEvE,CAAC,EAEGD,EAAU,OAAS,GAAKJ,EAAa,GAAK,CAACK,GAC7C,MAAM,IAAI,QAAQlZ,GAAK,WAAWA,EAAG,GAAI,CAAC,EAC1C,MAAMoX,GAAc,YAAY,EAAI,EAC7B,KAAK,WAAW6B,EAAWzd,EAAaqd,EAAa,EAAGrJ,CAAO,GAGjE,CAAE,QAASyJ,EAAU,SAAW,EAAG,MAAOC,EAAa,iBAAmB,OAAW,UAAAD,EAAW,QAAAlO,CAAA,CACzG,OAASzO,EAAY,CACnB,GAAIA,GAAO,aAAe,KAAOA,GAAO,mBAAoB,CAC1DtD,GAAS,WAAY,kCAAkCwC,CAAW,8BAA8B,EAChG,MAAM,IAAI,QAAQwE,GAAK,WAAWA,EAAG,IAAI,CAAC,EAC1C,MAAMoX,GAAc,YAAY,EAAI,EAGpC,MAAM+B,EADcpW,EAAgB,WACA,mBAAmBvH,CAAW,GAAK,GACjEuP,EAAkC,GAClCkO,EAAsB,GAa5B,GAXAL,EAAgB,QAAQ/Z,GAAM,CACTsa,EAAgB,KAAKH,GAAMA,EAAG,iBAAmBna,CAAE,GAEpEkM,EAAQlM,CAAE,EAAI,EACdoT,GAAe,iBAAiB,CAAE,WAAYpT,EAAI,SAAUrD,EAAa,SAAUA,EAAa,QAAS,GAAM,IAE/Gyd,EAAU,KAAKpa,CAAE,EACjBkM,EAAQlM,CAAE,EAAI,EAElB,CAAC,EAEGoa,EAAU,OAASL,EAAgB,OACrC,OAAAzf,GAAQ,WAAY,oDAAoDqC,CAAW,KAAKod,EAAgB,OAASK,EAAU,MAAM,kBAAkB,EAC5I,CAAE,QAASA,EAAU,SAAW,EAAG,UAAAA,EAAW,QAAAlO,CAAA,CAEzD,CAEA,MAAO,CAAE,QAAS,GAAO,MAAOzO,EAAM,QAAS,UAAWsc,EAAiB,QAAS,EAAC,CACvF,CACF,CAEA,MAAM,WAAWQ,EAAyB5d,EAAqB8N,EAAuD+P,EAAe,GAAO7J,EAA+J,CACzS,OAAOwG,GAAY,SAAY,CAC7B,MAAMnb,EAAQkI,EAAgB,WAC1BlI,EAAM,sBAAwBW,GAAaX,EAAM,qBAAqBW,CAAW,EAErF,MAAM4b,GAAc,YAAY,EAAI,EACpC,MAAM1f,EAAQqL,EAAgB,WACxBuW,EAAM5hB,EAAM,kBACZ6hB,EAAoB,GAEpBC,EAAiB,CAACC,EAAyBC,EAAe7V,KAA6C,CAC3G,MAAMuE,EAAOoO,GAAciD,CAAe,GAAKA,EACzCf,GAAaY,EAAI,OAAOnc,IAAKA,GAAE,WAAaiL,CAAI,EAGhDuR,GAAOjB,GAAW,KAAKvb,IAAK,KAAK,cAAcA,EAAC,IAAM0G,EAAO,EACnE,GAAI8V,GAAM,OAAOA,GAGjB,MAAMC,GAAelB,GAAW,CAAC,EACjC,GAAIkB,IAGE,GADkBA,GAAa,eAAiB,KAAO,GACxC,OAAOA,EAI9B,EAEMC,EAAc,CAACzR,EAAcK,IAAiB,CAClD,MAAMzE,GAAOwV,EAAepR,EAAMK,EAAMjN,CAAW,EACnD,OAAKwI,IAAMuV,EAAQ,KAAK9Q,GAAQL,EAAK,UAAU,EACxCpE,EACT,EAEM8V,EAAUV,EAAS,aAAeS,EAAYT,EAAS,aAAa,KAAMA,EAAS,aAAa,MAAQ,EAAE,EAAI,OAC9GW,EAAUX,EAAS,YAAcS,EAAYT,EAAS,YAAY,KAAMA,EAAS,YAAY,MAAQ,EAAE,EAAI,OAE3GpB,EAAYtgB,EAAM,WAAW,KAAK0L,GAAKA,EAAE,cAAgB5H,CAAW,EACpEwe,EAAc,CAAC,GAAItiB,EAAM,qBAAqB8D,CAAW,GAAK,GAAK,GAAI9D,EAAM,mBAAmB8D,CAAW,GAAK,EAAG,EAGzH,IAAI6W,EACJ,MAAM4H,EAAiBb,EAAS,eAChC,GAAIa,GAAgB,aAAc,CAChC,MAAM7R,EAAOoO,GAAcyD,EAAe,YAAY,GAAKA,EAAe,aAC1E5H,EAAW2H,EAAY,KAAK7c,GAAKA,EAAE,WAAaiL,CAAI,CACtD,CAGI,CAACiK,GAAY+G,EAAS,UACxB/G,EAAW,KAAK,iBAAiB+G,EAAS,QAASY,EAAahC,GAAW,SAAS,GAGjF3F,GACHkH,EAAQ,KAAK,aAAaH,EAAS,OAAO,GAAG,EAG3CG,EAAQ,OAAS,GAAK,CAAC/J,GAAS,QAClCzO,GAAc,WAAW,SAAS,CAChC,KAAM,UACN,QAAS,+BAA+BwY,EAAQ,KAAK,IAAI,CAAC,oCAC1D,SAAU,IACX,EAGH,MAAMW,EAA6B,GAC/BJ,GAAW,KAAK,oBAAoBA,EAASte,CAAW,GAAG0e,EAAY,KAAKJ,CAAO,EACnFC,GAAW,KAAK,oBAAoBA,EAASve,CAAW,GAAG0e,EAAY,KAAKH,CAAO,EACnF1H,GAAY,KAAK,oBAAoBA,EAAU7W,CAAW,GAAG0e,EAAY,KAAK7H,CAAQ,GAEzF+G,EAAS,OAAS,IAAI,QAAQe,GAAM,CACnC,MAAMhd,EAAI0c,EAAYM,EAAG,KAAMA,EAAG,MAAQ,EAAE,EACxChd,GAAK,KAAK,oBAAoBA,EAAG3B,CAAW,GAC9C0e,EAAY,KAAK/c,CAAC,CAEtB,CAAC,EAED,MAAM8Z,EAAUR,GAAkByD,EAAY,IAAI/c,GAAKA,EAAE,cAAe,EAAE,OAAO,OAAO,EAAG,EAAG3B,CAAW,EACpG8N,IAAYA,EAAa,IAAM,CAAE,GAEtC,IAAI8Q,EAA8B,GAClC,MAAMC,EAAiD,GACvD,IAAIC,EAAkB,GACtB,MAAM9U,GAAmB,GACzB,IAAI+U,EAAgB,GAEpB,GAAI,CACFjR,EAAW,0BAA2B,EAAE,EACxC,MAAMkR,EAAgBN,EAAY,OAAO/c,KAAMA,GAAE,eAAiB,KAAO,GAAK,KAAK,cAAcA,EAAC,IAAM3B,CAAW,EACnH,UAAWwI,MAAQwW,EACjB,GAAI,CACF,MAAMvI,GAAe,qBAAqB,KAAK,cAAcjO,EAAI,EAAGA,GAAK,cAAe,CAC1F,OAAS5C,EAAG,CACV/H,GAAS,WAAY,6BAA6B2K,GAAK,QAAQ,GAAI5C,CAAC,CACtE,CAGFgZ,EAAe,MAAM,KAAK,uBAAuB5e,EAAase,EAASC,EAAS9C,CAAO,EACvF,MAAMG,GAAc,YAAY,EAAI,EAEpC9N,EAAW,iBAAkB,EAAE,EAC/B,UAAWnM,MAAK+c,EAAa,CAC3B,MAAM9B,EAAM,KAAK,cAAcjb,EAAC,EAChC,GAAIib,IAAQ5c,EAAa,CACvB,IAAI6c,GAAM,MAAM,KAAK,SAASlb,GAAGib,EAAK5c,EAAayb,EAAS,CAAE,OAAQ,GAAM,EAC5E,GAAI,CAACoB,GAAI,UACP,MAAMjB,GAAc,YAAY,EAAI,EACpCiB,GAAM,MAAM,KAAK,SAASlb,GAAG,KAAK,cAAcA,EAAC,EAAG3B,EAAayb,EAAS,CAAE,OAAQ,GAAM,EACtF,CAACoB,GAAI,SAAS,CAChB,MAAMlK,GAAMyD,EAAgB,QAAQzU,GAAE,QAAQ,EAC9Ckd,EAAa,KAAK,CAAE,KAAMld,GAAE,SAAU,KAAMgR,IAAK,mBAAmB,MAAQhR,GAAE,SAAS,WAAY,CACrG,CAEJ,CACF,CAEA,GAAIkc,EAAc,MAAO,CAAE,QAAS,GAAM,QAAApC,EAAS,QAAAsC,EAAS,OAAQ,GAAI,SAAU,EAAC,EAEnFjQ,EAAW,qBAAsB,EAAE,EAGnCiR,EAAM,MAAM,KAAK,IAAI,IAAIH,EAAa,OAAOF,CAAW,EAAE,IAAI/c,IAAKA,GAAE,cAAe,CAAC,CAAC,EACtF,MAAMmb,EAAW,MAAM,KAAK,WAAWiC,EAAK/e,EAAa,EAAG,CAAE,OAAQ,GAAM,EAS5E,GARI8c,EAAS,QAAU,mBAAkBgC,EAAkB,IAE1DhC,EAAiB,WAAW,QAASmC,IAAgB,CACpD,MAAMzW,EAAOtM,EAAM,cAAc+iB,EAAG,EACpCjV,GAAO,KAAKxB,GAAM,UAAY4N,EAAgB,QAAQ5N,EAAK,QAAQ,GAAG,kBAAkB,MAAQyW,EAAU,CAC5G,CAAC,EAGGpI,GAAY,CAAC+G,EAAS,iBACxB,GAAI,EACuB1hB,EAAM,mBAAmB8D,CAAW,GAAK,IAAI,KAAK2B,GAAKA,EAAE,aAAezB,EAAc,QAAQ,GAClG,iBAAmB2W,EAAS,iBAC/C/I,EAAW,wBAAyB,EAAE,EACtC,MAAM,KAAK,UAAU+I,EAAS,eAAiB7W,EAAa,CAAE,OAAQ,GAAM,EAE5E,MAAM,IAAI,QAAQwE,GAAK,WAAWA,EAAG,GAAI,CAAC,EAC1C,MAAMoX,GAAc,YAAY,EAAI,EAExC,MAAQ,CACNkD,EAAkB,GAClBjhB,GAAS,WAAY,2BAA2B,CAClD,CAEJ,OAAS+H,EAAG,CACV/H,GAAS,WAAY,mDAAoD+H,CAAC,CAC5E,CAEA,MAAMsZ,EAAe,CAAC,GAAG,IAAI,IAAI,CAAC,GAAGlV,GAAQ,GAAG6U,EAAa,IAAIM,GAAKA,EAAE,IAAI,CAAC,CAAC,CAAC,EACzEC,EAAmBF,EAAa,OAAS,EAG/C,GAAI,CAACtB,EAAS,oBAAqB,CAEjC,GAAI/G,GAAY+G,EAAS,eAAgB,CACvC9P,EAAW,0BAA2B,EAAE,EACxC,GAAI,CACF,MAAM,KAAK,2BAA2B+I,EAAU+G,EAAS,eAAgB5d,EAAc0J,GAAcoE,EAAYpE,EAAG,EAAE,EAAG,CAAE,OAAQ,GAAM,CAC3I,OAAS9D,EAAG,CACV/H,GAAS,WAAY,oCAAoC+H,CAAC,EAAE,CAC9D,CACF,CAGA,GAAIgY,EAAS,WAAW,OAAQ,CAC9B9P,EAAW,yBAA0B,EAAE,EACvC,GAAI,CACF,MAAM,KAAK,eAAe9N,EAAa4d,EAAS,UAAYlU,GAAcoE,EAAYpE,EAAG,EAAE,EAAG,CAAE,OAAQ,GAAM,CAChH,OAAS9D,EAAG,CACV/H,GAAS,WAAY,+BAA+B+H,CAAC,EAAE,CACzD,CACF,CACF,CAEA,GAAI,CAACoO,GAAS,OAAQ,CACpB,IAAIqL,EAAM,GAAGzB,EAAS,IAAI,0BACtB0B,EAA6C,UAE7CR,GACFO,EAAM,GAAGzB,EAAS,IAAI,0CACtB0B,EAAY,YACHF,GAAoBrB,EAAQ,OAAS,KAC9CsB,EAAM,GAAGzB,EAAS,IAAI,6CACtB0B,EAAY,WAGd/Z,GAAc,WAAW,SAAS,CAAE,KAAM+Z,EAAW,QAASD,EAAK,CACrE,CAEA,MAAO,CAAE,QAAS,CAACP,GAAmB,CAACM,EAAkB,QAAA3D,EAAS,QAAAsC,EAAS,OAAQmB,EAAc,SAAUH,CAAA,CAC7G,CAAC,EAAE,MAAMvb,IACP3F,GAAS,WAAY,mBAAoB2F,CAAG,EACrC,CAAE,QAAS,GAAO,MAAOA,EAAI,QAAS,QAAS,GAAI,OAAQ,GAAI,SAAU,EAAC,EAClF,CACH,CAaA,MAAM,SAASgF,EAAmBqT,EAAkBnT,EAAkB+S,EAAuBzH,EAA0E,CACrK,MAAMtK,EAAI+R,GAAWR,GAAkB,CAACzS,EAAK,cAAe,CAAC,EAC7D,IAAItM,EAAQqL,EAAgB,WAC5B,MAAMgY,EAAQvL,GAAS,OAAS,GAG1BwL,EAAWtjB,EAAM,cAAcsM,EAAK,cAAe,GAAG,SACtDsT,GAAiBD,IAAa,QAChC3f,EAAM,eAAe,OAAOyF,GAAKA,EAAE,WAAa6G,EAAK,UAAY,KAAK,oBAAoB7G,CAAC,IAAM,KAAK,oBAAoB6G,CAAI,CAAC,EAC/H,CAAC,GAAItM,EAAM,mBAAmB2f,CAAQ,GAAK,GAAK,GAAI3f,EAAM,qBAAqB2f,CAAQ,GAAK,EAAG,EAC9F,OAAOla,GAAKA,EAAE,WAAa6G,EAAK,UAAY7G,EAAE,aAAe6G,EAAK,UAAU,GAC/E,OAAS,EACLiX,EAAkBD,IAAa,QAAa1D,EAAiB0D,EAAW,OAG9E,GAAI3D,IAAanT,EACf,OAAI6W,EAAc,KAAK,UAAU/W,EAAK,eAAiBE,EAAUsL,CAAO,EACjE,CAAE,QAAS,GAAM,QAAS,CAAE,OAAQxL,EAAK,eAAiB,SAAUA,EAAK,SAAU,YAAaE,EAAU,OAAQ,WAAW,EAGtI,MAAMgX,EAAgB7D,IAAa,QAC7B8D,EAAgBjX,IAAa,QAQnC,GAPqB,CAACgX,GAAiB,CAACC,EAOtB,CAGhB,IAD4BzjB,EAAM,mBAAmB2f,CAAQ,GAAK,IAAI,KAAKla,GAAKA,EAAE,iBAAmB6G,EAAK,cAAc,EAChG,CAItB,MAAMoX,EADUxJ,EAAgB,QAAQ5N,EAAK,QAAQ,GACvB,WAAa,EAI3C,GAFA7K,GAAQ,WAAY,kCAAkC6K,EAAK,QAAQ,cAAcqT,CAAQ,YAAY+D,CAAY,GAAG,EAEhH,CADc,MAAMnJ,GAAe,qBAAqBoF,EAAUrT,EAAK,eAAiBoX,EAAclW,CAAC,EAEzG,OAAA7L,GAAS,WAAY,oBAAoB2K,EAAK,QAAQ,YAAY,EAC3D,CAAE,QAAS,GAAO,MAAO,0BAA2B,QAAS,CAAE,OAAQA,EAAK,eAAiB,SAAUA,EAAK,SAAU,YAAaE,EAAU,OAAQ,WAAW,EAEzK,MAAM,IAAI,QAAQlE,GAAK,WAAWA,EAAG,GAAG,CAAC,EACzCtI,EAAQqL,EAAgB,UAC1B,CAGA5J,GAAQ,WAAY,gDAAgD6K,EAAK,QAAQ,EAAE,EACnF,MAAMqX,EAAa,CAAE,GAAI,QAAS,QAAS,GAAM,MAAO3jB,EAAM,gBAC9D,GAAI,CAAE,MAAM,KAAK,qBAAqBsM,EAAMqX,EAAY,EAAGnW,CAAC,EAC1D,MAAO,CAAE,QAAS,GAAO,MAAO,oBAAqB,QAAS,CAAE,OAAQlB,EAAK,eAAiB,SAAUA,EAAK,SAAU,YAAaE,EAAU,OAAQ,WAAW,EAInK/K,GAAQ,WAAY,8BAA8B6K,EAAK,QAAQ,WAAW,EAC1E,MAAMsX,EAAa,MAAM,KAAK,YAAYtX,EAAMqT,EAAU,QAAS,GAAOnS,EAAG,CAAE,OAAQ,GAAM,EAC7F,GAAI,CAACoW,EAAW,QAAS,OAAOA,EAGhC,MAAM,IAAI,QAAQtb,GAAK,WAAWA,EAAG,GAAG,CAAC,EACzCtI,EAAQqL,EAAgB,WAGxB5J,GAAQ,WAAY,oEAAoE6K,EAAK,QAAQ,EAAE,EACvG,MAAMuX,EAAa7jB,EAAM,WAAW,KAAM0L,GAAWA,EAAE,cAAgBc,CAAQ,EAC/E,GAAIqX,EAAY,CAEd,MAAMC,EAAc,CAAE,GAAGD,EAAY,GAAIrX,CAAA,EAEzC,GAAI,CADU,MAAM,KAAK,oBAAoB6W,EAAOS,EAAaxX,EAAM,EAAGkB,CAAC,EAEzE,MAAO,CAAE,QAAS,GAAO,MAAO,qCAAsC,QAAS,CAAE,OAAQlB,EAAK,eAAiB,SAAUA,EAAK,SAAU,YAAaE,EAAU,OAAQ,WAAW,CAEtL,CAGA/K,GAAQ,WAAY,8BAA8B6K,EAAK,QAAQ,kBAAkBE,CAAQ,EAAE,EAC3F,MAAMuX,EAAc,MAAM,KAAK,YAAYzX,EAAM,QAASE,EAAU6W,EAAO7V,EAAGsK,CAAO,EACrF,GAAI,CAACiM,EAAY,QAAS,OAAOA,EAGjC/jB,EAAQqL,EAAgB,WACxB,MAAM2Y,IAAiBhkB,EAAM,mBAAmBwM,CAAQ,GAAK,IAAI,KAAK/G,GAAKA,EAAE,iBAAmB6G,EAAK,cAAc,EACnH,OAAI+W,GAAS,CAACW,IACZviB,GAAQ,WAAY,uCAAuC6K,EAAK,QAAQ,EAAE,EACnE,KAAK,UAAUA,EAAK,eAAiBE,EAAUsL,CAAO,IAG/D,KAAK,qBAAqBxL,EAAME,EAAU+W,EAAgBvjB,CAAK,EACxD+jB,EACT,CAOA,GAAI,CAACP,IACyBxjB,EAAM,mBAAmB2f,CAAQ,GAAK,IAAI,KAAKla,GAAKA,EAAE,iBAAmB6G,EAAK,cAAc,EAChG,CAGtB,MAAMoX,EADUxJ,EAAgB,QAAQ5N,EAAK,QAAQ,GACvB,WAAa,EAI3C,GAFA7K,GAAQ,WAAY,2BAA2B6K,EAAK,QAAQ,cAAcqT,CAAQ,YAAY+D,CAAY,GAAG,EAEzG,CADc,MAAMnJ,GAAe,qBAAqBoF,EAAUrT,EAAK,eAAiBoX,EAAclW,CAAC,EAEzG,MAAO,CAAE,QAAS,GAAO,MAAO,0BAA2B,QAAS,CAAE,OAAQlB,EAAK,eAAiB,SAAUA,EAAK,SAAU,YAAaE,EAAU,OAAQ,WAAW,EAEzK,MAAM,IAAI,QAAQlE,GAAK,WAAWA,EAAG,GAAG,CAAC,EACzCtI,EAAQqL,EAAgB,UAC1B,CAKF,MAAMwY,EAAaJ,EAAgB,KAAOzjB,EAAM,WAAW,KAAM0L,GAAWA,EAAE,cAAgBc,CAAQ,EAChGrJ,EAAQsgB,EACV,CAAE,GAAI,QAAS,QAAS,GAAM,MAAOzjB,EAAM,gBAC3C6jB,EAAa,CAAE,GAAGA,EAAY,GAAIrX,GAAa,KAEnD,GAAIrJ,GAGE,CADU,MAAM,KAAK,oBAAoBkgB,GAAS,CAACI,EAAetgB,EAAOmJ,EAAM,EAAGkB,CAAC,EAErF,MAAO,CAAE,QAAS,GAAO,MAAO,qBAAsB,QAAS,CAAE,OAAQlB,EAAK,eAAiB,SAAUA,EAAK,SAAU,YAAaE,EAAU,OAAQ,WAAW,EAKtK,MAAMmU,EAAM,MAAM,KAAK,YAAYrU,EAAMqT,EAAUnT,EAAU6W,GAAS,CAACI,EAAejW,EAAGsK,CAAO,EAEhG,YAAK,qBAAqBxL,EAAME,EAAU+W,EAAgBvjB,CAAK,EACxD2gB,CACT,CASA,MAAc,oBACZ0C,EACAlgB,EACAmJ,EACA2X,EACA1E,EACkB,CAClB,MAAM9I,EAAMyD,EAAgB,QAAQ5N,EAAK,QAAQ,EAEjD,OAAI+W,GAAS,CAAClgB,EAAM,SAEdsT,GAAK,WAAW,gBAEd,CADa,MAAM,KAAK,eAAenK,EAAMnJ,EAAOoc,CAAO,GAE7D5d,GAAS,WAAY,uBAAuB2K,EAAK,QAAQ,OAAOnJ,EAAM,IAAMA,EAAM,WAAW,EAAE,EACxF,IAMN,KAAK,qBAAqBmJ,EAAMnJ,EAAO8gB,EAAQ1E,CAAO,CAC/D,CAOA,MAAc,eAAejT,EAAmBnJ,EAAYoc,EAAwC,CAClG,MAAM9I,EAAMyD,EAAgB,QAAQ5N,EAAK,QAAQ,EACjD,GAAI,CAACmK,GAAK,WAAW,eAAgB,MAAO,GAE5C,MAAMtK,EAAUhJ,EAAM,IAAMA,EAAM,YAE5B+gB,EADQ7Y,EAAgB,WACN,mBAAmBc,CAAO,GAAK,GACjD6G,EAAQyD,EAAI,UAAU,eAE5BnV,GAAS,WAAY,oDAAoD0R,CAAK,OAAO7G,CAAO,EAAE,EAG9F,MAAMgY,EAAcD,EAAU,KAAKze,GACpByU,EAAgB,QAAQzU,EAAE,QAAQ,GAClC,WAAW,iBAAmBuN,GAASvN,EAAE,aAAe6G,EAAK,UAC3E,EAED,OAAK6X,GAKL1iB,GAAQ,WAAY,oCAAoC0iB,EAAY,QAAQ,cAAcA,EAAY,UAAU,iBAAiB,EAG/G,MAAM5J,GAAe,qBAAqBpO,EAASgY,EAAY,eAAiB,GAAM5E,CAAO,GAM/G9d,GAAQ,WAAY,0CAA0C0iB,EAAY,QAAQ,EAAE,EAC7E,KALLxiB,GAAS,WAAY,uDAAuDwiB,EAAY,QAAQ,EAAE,EAC3F,MAVP7iB,GAAS,WAAY,mCAAmC,EACjD,GAcX,CAOA,MAAc,YACZgL,EACAqT,EACAnT,EACA6W,EACA9D,EACAzH,EACyB,CACzB,MAAMuH,EAAU7S,IAAa,QACvB1I,EAAcub,EAAUM,EAAWnT,EAInCmU,EAAM,MAAM,KAAK,aACrBrU,EAAK,eACLA,EAAK,SACL+S,EACAvb,EACA,EACAyb,EACA,CAAE,GAAGzH,EAAS,OAAQ,GAAM,eAAgB,GAAK,EAGnD,GAAI,CAAC6I,EAAI,QACP,OAAK7I,GAAS,QACZzO,GAAc,WAAW,SAAS,CAAE,KAAM,QAAS,QAASsX,EAAI,OAAS,kBAAmB,EAEvFA,EAIT,GAAI0C,GAAS,CAAChE,EAAS,CACrB,MAAMuB,EAAW,MAAM,KAAK,UAAUtU,EAAK,eAAiBE,EAAU,CAAE,OAAQ,GAAM,EACtF,OAAKoU,EAAS,SAEP9I,GAAS,QACZzO,GAAc,WAAW,SAAS,CAAE,KAAM,UAAW,QAAS,8BAA+B,EAG1FuX,CACT,CAEA,GAAI,CAAC9I,GAAS,OAAQ,CACpB,MAAMgB,EAAUoB,EAAgB,QAAQ5N,EAAK,QAAQ,EACrDjD,GAAc,WAAW,SAAS,CAAE,KAAM,UAAW,QAAS,GAAGyP,GAAS,mBAAmB,MAAQ,MAAM,SAAU,SAAU,IAAM,CACvI,CAEA,OAAO6H,CACT,CAKQ,qBAAqBrU,EAAmBE,EAAkB+W,EAAqCvjB,EAAkB,CACvH,GAAIujB,IAAmB,OAAW,CAChC,MAAMa,EAAY,OAAO,KAAKpkB,EAAM,oBAAoB,EAAE,CAAC,EACrDqkB,EAAkB7X,IAAa,QAAU4X,EAAY5X,EACvD6X,IACF/iB,GAAS,WAAY,6CAA6CgL,EAAK,QAAQ,OAAOiX,CAAc,EAAE,EACtG,KAAK,iBAAiBjX,EAAK,eAAiB+X,EAAiBd,CAAc,EAAE,MAAM,IAAM,CAAE,CAAC,EAEhG,CACF,CAOA,MAAc,qBACZjX,EACAnJ,EACA8gB,EACA1E,EACAzH,EAAoE,CAAE,SAAU,IAC9D,CAClB,KAAM,CAAE,SAAAwM,EAAU,WAAAC,EAAa,EAAG,MAAAC,EAAQ,GAAM1M,EAGhD,GAAI0M,EAAQ,GACV,OAAA7iB,GAAS,WAAY,wDAAwD2K,EAAK,QAAQ,EAAE,EACrF,GAIT,MAAMtM,EAAQqL,EAAgB,WACxBoZ,EAAa,CAAC,QAAS,SAAU,SAAS,EAC1CC,EAAS,CACb,GAAG1kB,EAAM,WAAW,IAAK0L,IAAY,CAAE,GAAGA,EAAG,GAAIA,EAAE,YAAa,KAAM+Y,EAAW/Y,EAAE,SAAS,GAAK,YAAa,EAC9G,CAAE,KAAM,QAAS,GAAI,QAAS,QAAS,GAAM,MAAO1L,EAAM,eAAe,EAGrE+f,EAAa,KAAK,oBAAoBzT,CAAI,EAG1CqY,EAA4C,GAClDA,EAAkBxhB,EAAM,EAAE,EAAI8gB,EAG9B,MAAMtE,EAAW,KAAK,cAAcrT,EAAMtM,CAAK,EAC3C2f,IAAa,SAAW,CAACxc,EAAM,SAAWwc,IAAaxc,EAAM,KAC/DwhB,EAAkB,MAAQV,GAI5B,MAAMW,EAAsC,GAC5C,UAAWpX,KAAKkX,EACd,GAAIC,EAAkBnX,EAAE,EAAE,EAAG,CAC3B,MAAMqX,EAAO,KAAK,iBAAiB9E,EAAYvS,EAAE,GAAIxN,EAAOuf,CAAO,EACnEqF,EAAYpX,EAAE,EAAE,EAAI,KAAK,IAAI,EAAGmX,EAAkBnX,EAAE,EAAE,EAAIqX,CAAI,EAC9DvjB,GAAS,WAAY,mBAAmBkM,EAAE,IAAI,KAAKA,EAAE,EAAE,WAAWqX,CAAI,cAAcF,EAAkBnX,EAAE,EAAE,CAAC,iBAAiBoX,EAAYpX,EAAE,EAAE,CAAC,EAAE,CACjJ,CAGF,GAAI,OAAO,OAAOoX,CAAW,EAAE,MAAME,GAAKA,IAAM,CAAC,EAC/C,MAAO,GAGT,MAAMC,EAAyB,OAAO,QAAQH,CAAW,EAAE,UAAU,OAAO,CAAC,CAACI,EAAGC,CAAG,IAAOA,EAAiB,CAAC,EACvG,CAACC,CAAiB,EAAIH,EAAuB,CAAC,GAAK,GACzD,GAAI,CAACG,EAAmB,MAAO,GAE/B,MAAMC,EAAcT,EAAO,KAAKlX,GAAKA,EAAE,KAAO0X,CAAiB,EACzDE,EAAuB,CAC3B,iBAAkBrF,EAClB,SAAAuE,EACA,UAAW,CAAC9W,EAAG/H,IAAM,CACnB,IAAIof,GAAO,KAAK,iBAAiB,KAAK,oBAAoBpf,CAAC,EAAG+H,EAAE,GAAIxN,EAAOuf,CAAO,EAElF,OAAI/R,EAAE,KAAOrK,EAAM,IAAM,KAAK,oBAAoBsC,CAAC,IAAMsa,IACvD8E,IAAQZ,GAEH,KAAK,IAAI,EAAGY,EAAI,CACzB,GAGFpjB,GAAQ,WAAY,mBAAmB0jB,GAAa,MAAQD,CAAiB,QAAQ5Y,EAAK,QAAQ,kBAAmBsY,CAAW,EAChI,MAAMS,EAAS,KAAK,oBAAoBF,EAAa7Y,EAAM8Y,EAASplB,EAAOuf,CAAO,EAClF,GAAI,CAAC8F,EAAO,MAAQ,CAACA,EAAO,OAC1B,OAAA1jB,GAAS,WAAY,4CAA4Coe,CAAU,OAAOoF,GAAa,MAAQD,CAAiB,wCAAwC,KAAK,wBAAwBnF,EAAYmF,EAAmB3F,EAASvf,CAAK,EAAE,MAAM,EAAE,EAC7O,GAGT,GAAI,CACFyB,GAAQ,WAAY,gBAAgB4jB,EAAO,KAAK,QAAQ,SAASF,GAAa,MAAQD,CAAiB,OAAOG,EAAO,OAAO,MAAQA,EAAO,OAAO,EAAE,gBAAgB,EACpK,MAAM1E,EAAM,MAAM,KAAK,SAAS0E,EAAO,KAAMH,EAAmBG,EAAO,OAAO,GAAI9F,EAAS,CAAE,OAAQ,GAAM,EAE3G,GAAI,CAACoB,EAAI,QACP,MAAM,IAAI,MAAM,sBAAsBA,EAAI,KAAK,EAAE,EAInD,aAAM,IAAI,QAAQrY,GAAK,WAAWA,EAAG,EAAE,CAAC,EAGjC,KAAK,qBAAqBgE,EAAMnJ,EAAO8gB,EAAQ1E,EAAS,CAAE,SAAA+E,EAAU,WAAY,EAAG,MAAOE,EAAQ,EAAG,CAC9G,MAAY,CACV,OAAID,EAAa,GACf9iB,GAAQ,WAAY,yBAAyB4jB,EAAO,KAAK,QAAQ,4BAA4B,EAC7Ff,EAAS,KAAKe,EAAO,IAAI,EAClB,KAAK,qBAAqB/Y,EAAMnJ,EAAO8gB,EAAQ1E,EAAS,CAAE,SAAA+E,EAAU,WAAYC,EAAa,EAAG,MAAAC,CAAA,CAAO,GAEzG,EACT,CACF,CAEQ,oBAAoBW,EAAkBG,EAA6BC,EAAuBvlB,EAAYuf,EAA4D,CACxK,MAAMyB,EAAa,KAAK,wBAAwB,KAAK,oBAAoBsE,CAAc,EAAGH,EAAY,GAAI5F,EAASvf,CAAK,EACxH,GAAI,CAACghB,EAAW,OAAQ,MAAO,GAG/B,MAAM1U,EADS,KAAK,wBAAwB0U,EAAYmE,EAAanlB,CAAK,EACtD,CAAC,EAWfmU,EAPS,CACb,GAAGnU,EAAM,WACN,KAAK,CAAC2U,EAAQ5E,IAAW,IAAI,KAAK4E,EAAE,cAAc,EAAE,UAAY,IAAI,KAAK5E,EAAE,cAAc,EAAE,SAAS,EACpG,IAAKrE,IAAY,CAAE,GAAGA,EAAG,GAAIA,EAAE,aAAc,EAChD,CAAE,KAAM,QAAS,GAAI,QAAS,QAAS,GAAM,MAAO1L,EAAM,eAAe,EAGrD,QAAUwN,EAAE,KAAO2X,EAAY,IAAM,KAAK,iBAAiB,KAAK,oBAAoB7Y,CAAI,EAAGkB,EAAE,GAAIxN,EAAOuf,CAAO,EAAI,CAAC,EAC1I,MAAO,CAAE,KAAAjT,EAAM,OAAA6H,CAAA,CACjB,CAEQ,wBAAwB6M,EAA2BmE,EAAkBnlB,EAA2B,CACtG,MAAM4P,EAAS5P,EAAM,QAAU,GACzBwlB,EAAe,IAAI,IAAI5V,EAAO,QAASG,GAAW,CACtDA,EAAE,eAAe,eAAgBA,EAAE,cAAc,eAAgBA,EAAE,aAAa,eAChFA,EAAE,QAAQ,eAAgBA,EAAE,WAAW,eAAgBA,EAAE,YAAY,eACrEA,EAAE,UAAU,eAAgBA,EAAE,YAAY,eAC3C,EAAE,OAAO,OAAO,CAAC,EAElB,OAAOiR,EAAW,KAAK,CAACrM,EAAG5E,IAAM,CAE/B,MAAM0V,EAAWD,EAAa,IAAI7Q,EAAE,cAAe,EAAI,EAAI,EACrD+Q,EAAWF,EAAa,IAAIzV,EAAE,cAAe,EAAI,EAAI,EAC3D,GAAI0V,IAAaC,EAAU,OAAOD,EAAWC,EAG7C,MAAMC,GAAS3lB,EAAM,mBAAmBmlB,EAAY,EAAE,GAAK,IAAI,KAAMzb,GAAWA,EAAE,iBAAmBiL,EAAE,cAAc,EAC/GiR,GAAS5lB,EAAM,mBAAmBmlB,EAAY,EAAE,GAAK,IAAI,KAAMzb,GAAWA,EAAE,iBAAmBqG,EAAE,cAAc,EACrH,GAAI4V,IAAUC,EAAO,OAAOD,EAAQ,EAAI,GAGxC,MAAME,EAAQlR,EAAE,UAAY,EACtBmR,EAAQ/V,EAAE,UAAY,EAC5B,GAAI8V,IAAUC,EAAO,OAAOD,EAAQC,EAGpC,MAAMC,EAAK/lB,EAAM,cAAc2U,EAAE,cAAe,GAAG,OAAS,EACtDqR,EAAKhmB,EAAM,cAAc+P,EAAE,cAAe,GAAG,OAAS,EAC5D,OAAIgW,IAAOC,EAAWD,EAAKC,EAEpB,CACT,CAAC,CACH,CAEQ,iBAAiBjG,EAAoBjc,EAA+B9D,EAAYuf,EAA+B,CACrH,MAAM0G,EAAe1G,GAAS,eAAezb,CAAW,IAAIic,CAAU,GAAK,EAE3E,GAAIjc,IAAgB,QAAS,CAO3B,GALwB,CAACE,EAAc,gBAAiBA,EAAc,eAAgBA,EAAc,cACpGA,EAAc,OAAQA,EAAc,UAAWA,EAAc,YAC7DA,EAAc,UAAWA,EAAc,YAAaA,EAAc,MAClEA,EAAc,QAASA,EAAc,OAAO,SAAS+b,CAAU,EAE1C,CACnB,MAAMmG,EAAelmB,EAAM,eAAe,OAAQyF,GAAW,CAC3D,MAAM0gB,EAAS,KAAK,oBAAoB1gB,CAAC,EACzC,MAAO,CAAC,CAACzB,EAAc,YAAaA,EAAc,aAAa,EAAE,SAASmiB,CAAM,CAClF,CAAC,EAAE,OACH,OAAO,KAAK,IAAI,EAAGtH,IAAwBqH,EAAeD,EAAa,CACzE,CAEA,GAAIlG,IAAe/b,EAAc,YAAa,CAC5C,MAAMoiB,EAAQpmB,EAAM,eAAe,OAAQyF,GAAW,KAAK,oBAAoBA,CAAC,IAAMzB,EAAc,WAAW,EAAE,OACjH,OAAO,KAAK,IAAI,EAAG,IAAMoiB,EAAQH,EAAa,CAChD,CAEA,GAAIlG,IAAe/b,EAAc,cAAe,CAC9C,MAAMoiB,EAAQpmB,EAAM,eAAe,OAAQyF,GAAW,KAAK,oBAAoBA,CAAC,IAAMzB,EAAc,aAAa,EAAE,OACnH,OAAO,KAAK,IAAI,EAAG,IAAMoiB,EAAQH,EAAa,CAChD,CAEA,MAAO,EACT,CAIA,MAAMG,GADgBpmB,EAAM,qBAAqB8D,CAAW,GAAK,IACrC,OAAQ2B,GAAW,KAAK,oBAAoBA,CAAC,IAAMsa,CAAU,EAAE,OAC3F,IAAI8E,GAAQjG,GAAkBmB,CAAU,GAAK,KAAOqG,EAAQH,GAG5D,OAAItH,GAAc,IAAIoB,CAAU,GAAKA,IAAe/b,EAAc,eAChE6gB,GAAQ,GAGH,KAAK,IAAI,EAAGA,CAAI,CACzB,CAEQ,wBAAwB9E,EAAoBjc,EAA+Byb,EAAsBvf,EAA2B,CAClI,MAAMqmB,EAAUviB,IAAgB,QAC1Bwd,EAAK+E,EAAU,GAAMrmB,EAAM,mBAAmB8D,CAAW,GAAK,GAC9DwiB,EAAMD,EAAU,GAAMrmB,EAAM,qBAAqB8D,CAAW,GAAK,GACjE8d,EAAMyE,EAAUrmB,EAAM,eAAiB,CAAC,GAAGsmB,EAAK,GAAGhF,CAAE,EAErDiF,EAAW3E,EAAI,OAAQnc,GAAW,CACtC,MAAM0gB,EAAS,KAAK,oBAAoB1gB,CAAC,EAGzC,GAAI4gB,EAAS,CACX,MAAMG,EAAarL,GAAc,CAAC,CAACnX,EAAc,YAAaA,EAAc,aAAa,EAAE,SAASmX,CAAC,EAGrG,GAFIqL,EAAUzG,CAAU,GAAK,CAACyG,EAAUL,CAAM,GAC1CpG,IAAe/b,EAAc,aAAemiB,IAAWniB,EAAc,aACrE+b,IAAe/b,EAAc,eAAiBmiB,IAAWniB,EAAc,cAAe,MAAO,EACnG,SAEMmiB,IAAWpG,EAAY,MAAO,GAOpC,MAHI,EAAAR,EAAQ,cAAc,IAAI9Z,EAAE,cAAe,GAG3C,CAAC4gB,GAAW5gB,EAAE,WAAa,EAGjC,CAAC,EAED,OAAI8gB,EAAS,SAAW,GAAK3E,EAAI,OAAS,GACxCngB,GAAQ,WAAY,0BAA0BqC,CAAW,eAAeic,CAAU,0BAA0B6B,EAAI,MAAM,eAAerC,EAAQ,cAAc,IAAI,EAAE,EAG5JgH,EAAS,KAAK,CAAC5R,EAAQ5E,IAAW,CACvC,MAAM4V,EAAQrE,EAAG,KAAM5X,GAAWA,EAAE,iBAAmBiL,EAAE,cAAc,EAAGiR,EAAQtE,EAAG,KAAM5X,GAAWA,EAAE,iBAAmBqG,EAAE,cAAc,EAC3I,OAAI4V,IAAUC,EAAcD,EAAQ,EAAI,GACpChR,EAAE,WAAa5E,EAAE,UAAkB4E,EAAE,UAAY,IAAM5E,EAAE,UAAY,IACjE/P,EAAM,cAAc2U,EAAE,cAAe,GAAG,OAAS,IAAM3U,EAAM,cAAc+P,EAAE,cAAe,GAAG,OAAS,EAClH,CAAC,CACH,CAEA,MAAM,sBAAsBjM,EAAqB2iB,EAA+C,CAG9F,MAAMC,GAFQrb,EAAgB,WACR,qBAAqBvH,CAAW,GAAK,IACjC,OAAQwd,GAAY,CAC5C,MAAMnN,EAASsS,EAAa,KAAM/W,GAAWA,EAAE,aAAe4R,EAAG,UAAU,EAC3E,GAAI,CAACnN,EAAQ,MAAO,GACpB,MAAMwS,EAAOzM,EAAgB,QAAQ/F,EAAO,QAAQ,EAAGyS,EAAO1M,EAAgB,QAAQoH,EAAG,QAAQ,EACjG,OAAOqF,GAAM,WAAa,GAAKC,GAAM,WAAa,CACpD,CAAC,EACD,UAAW,KAAKF,EAAW,MAAMnM,GAAe,qBAAqBzW,EAAa,EAAE,eAAiB,EAAI,EACzG,MAAO,EACT,CAEA,MAAc,uBAAuBA,EAAqBse,EAAcC,EAAc9C,EAA8C,CAClI,MAAMsH,EAAsB,GACtB7mB,EAAQqL,EAAgB,WACxBiV,EAAYtgB,EAAM,WAAW,KAAK0L,GAAKA,EAAE,cAAgB5H,CAAW,EACpEgjB,EAAmB9mB,EAAM,qBAAqB8D,CAAW,GAAK,GAC9DijB,EAAgB,MAAOC,GAAsB,CACjD,GAAI,CAACA,EAAc,OACnB,MAAMC,EAAY/M,EAAgB,QAAQ8M,EAAa,QAAQ,EACzDzG,EAAWuG,EAAiB,KAAKrhB,GACzByU,EAAgB,QAAQzU,EAAE,QAAQ,GAClC,WAAW,iBAAmBwhB,GAAW,WAAW,gBAAkBxhB,EAAE,iBAAmBuhB,EAAa,cACrH,EACD,GAAIzG,EAAU,CACZ,MAAM2G,EAAM,KAAK,oBAAoB3G,EAAS,WAAYzc,EAAayb,EAAQ,cAAee,GAAW,SAAS,EAClH,GAAI4G,EAAK,CACP,MAAMxG,EAAM,KAAK,cAAcwG,EAAKlnB,CAAK,EACrC0gB,IAAQ5c,GAAa,MAAM,KAAK,SAASojB,EAAKxG,EAAK5c,EAAayb,EAAS,CAAE,OAAQ,GAAM,EAC7F,MAAM,KAAK,UAAU2H,EAAI,eAAiBpjB,EAAa,CAAE,OAAQ,GAAM,EACvE+iB,EAAK,KAAKK,CAAG,EAAG3H,EAAQ,cAAc,IAAI2H,EAAI,cAAe,CAC/D,CACF,CACF,EACA,aAAMH,EAAc3E,CAAO,EAAG,MAAM2E,EAAc1E,CAAO,EAClDwE,CACT,CAEQ,qBACNva,EACAxI,EACAqjB,MAAuC,IACvCjU,EACAkU,EAAgB,GACS,CACzB,MAAMpnB,EAAQqL,EAAgB,WACxBuW,EAAM,CACV,GAAG5hB,EAAM,eACT,GAAG,OAAO,QAAQA,EAAM,oBAAoB,EAAE,QAAQ,CAAC,CAACglB,EAAGtS,CAAK,IAAMA,CAAK,GAGvEsO,EAAaY,EAAI,OAAQnc,GAAW,CACxC,MAAM0gB,EAAS,KAAK,oBAAoB1gB,CAAC,EACnCgR,EAAMyD,EAAgB,QAAQzU,EAAE,QAAQ,EACxC4hB,GAAcrnB,EAAM,mBAAmB,KAAK,cAAcyF,EAAGzF,CAAK,CAAC,GAAK,IAAI,KAAM0J,GAAWA,EAAE,iBAAmBjE,EAAE,cAAc,EAExI,OACE0gB,IAAW7Z,EAAK,YAChB,CAAC+a,GACD,CAACF,EAAW,IAAI1hB,EAAE,cAAe,IAChCA,EAAE,eAAiB,KAAO,IAC1B,CAAC2hB,GAAiB3Q,GAAK,WAAa,KACpCvD,IAAc,QAAauD,GAAK,YAAcvD,GAAauD,GAAK,YAAc,EAEnF,CAAC,EAED,GAAIuK,EAAW,SAAW,EAAG,CAC3Bvf,GAAQ,WAAY,kDAAkD6K,EAAK,UAAU,aAAasV,EAAI,MAAM,0BAA0BwF,CAAa,EAAE,EACrJ,MACF,CAEA,OAAOpG,EAAW,KAAK,CAACrM,EAAG5E,IAAM,CAE/B,MAAMuX,EAAOH,EAAW,IAAIxS,EAAE,cAAe,EAAI,EAAI,EAC/C4S,EAAOJ,EAAW,IAAIpX,EAAE,cAAe,EAAI,EAAI,EACrD,GAAIuX,IAASC,EAAM,OAAOD,EAAOC,EAGjC,MAAM1B,EAAQlR,EAAE,UAAY,EAAGmR,EAAQ/V,EAAE,UAAY,EACrD,GAAI8V,IAAUC,EACZ,OAAID,IAAU,EAAU,EACpBC,IAAU,EAAU,GACjBA,EAAQD,EAGjB,MAAM2B,EAAO,KAAK,cAAc7S,EAAG3U,CAAK,EAClCynB,EAAO,KAAK,cAAc1X,EAAG/P,CAAK,EAClCmY,EAASuI,GAAgBA,IAAQ5c,EAAc,EAAK4c,IAAQ,QAAU,EAAI,EAChF,GAAIvI,EAAMqP,CAAI,IAAMrP,EAAMsP,CAAI,EAAG,OAAOtP,EAAMqP,CAAI,EAAIrP,EAAMsP,CAAI,EAEhE,MAAM1B,EAAK/lB,EAAM,cAAc2U,EAAE,cAAe,GAAG,OAAS,EAE5D,OADW3U,EAAM,cAAc+P,EAAE,cAAe,GAAG,OAAS,GAChDgW,CACd,CAAC,EAAE,CAAC,CACN,CAEA,oBAAoBhG,EAAoBjc,EAAqB4jB,MAA+C,IAAOxU,EAAoBkU,EAAgB,GAA+B,CACpL,OAAO,KAAK,qBAAqB,CAAE,WAAArH,CAAA,EAA6Bjc,EAAa4jB,EAAoBxU,EAAWkU,CAAa,CAC3H,CAGQ,iBAAiBnJ,EAAiBqI,EAAoBpT,EAA6C,CACzG,GAAI,CAAC+K,EAAS,OACd,MAAM0J,EAAU1J,EAAQ,cAClB2J,EAAiB3jB,GAAmB0jB,EAAQ,aAAgD,EAElG,OAAOrB,EAAI,KAAK7gB,GAAK,CACnB,GAAIA,EAAE,aAAezB,EAAc,SAAU,MAAO,GACpD,MAAMyS,EAAMyD,EAAgB,QAAQzU,EAAE,QAAQ,EAC9C,MAAI,CAACgR,GAAQvD,IAAc,QAAauD,EAAI,YAAcvD,GAAauD,EAAI,YAAc,EAAW,GAGhGmR,GAAmBnR,EAAY,wBAA0BmR,EAAuB,IAGtEnR,EAAI,mBAAmB,MAAQ,IAAI,cACrC,SAASkR,CAAO,CAC9B,CAAC,CACH,CAEA,MAAM,eAAe7jB,EAAqBsW,EAAgBxI,EAAiBkG,EAA+C,CAAE,MAAMsG,GAAW,eAAeta,EAAasW,EAAMxI,EAAYkG,CAAO,CAAG,CACrM,MAAM,2BAA2B6C,EAAuB9R,EAAa/E,EAAqB8N,EAAiBkG,EAA+C,CAAE,MAAMsG,GAAW,2BAA2BzD,EAAU9R,EAAQ/E,EAAa8N,EAAYkG,CAAO,CAAG,CAC7P,MAAM,iBAAiB+P,EAAgB/jB,EAAqB9D,EAAkC,CAC5F,MAAM8nB,EAAOzc,EAAgB,WAAW,WAAW,KAAKK,GAAKA,EAAE,cAAgB5H,CAAW,GAAKuH,EAAgB,WAAW,WAAW,CAAC,EACtI,GAAI,CAACyc,EAAM,MAAO,GAElB,MAAMjkB,GADa,MAAM0W,GAAe,yBACL,gBAAkBuN,EAAK,eAC1D,GAAI,CAAE,aAAMhd,GAAU,KAAKnH,GAAc,UAAU,aAAc,CAAE,MAAA3D,EAAO,OAAA6nB,EAAQ,YAAaC,EAAK,YAAa,eAAAjkB,CAAA,EAAkB,EAAI,EAAU,EAAM,MAAQ,CAAE,MAAO,EAAO,CACjL,CACA,MAAM,qBAAqBgkB,EAAgB3a,EAAkBD,EAAqBnJ,EAAqBmd,EAAgF,CACrL,MAAMjhB,EAAQqL,EAAgB,WACxByc,EAAO9nB,EAAM,WAAW,KAAK0L,GAAKA,EAAE,cAAgB5H,CAAW,EACrE,GAAI,CAACgkB,EAAM,MAAO,CAAE,QAAS,IAK7B,GAFiB9nB,EAAM,cAAc6nB,CAAM,GACX,SAAS,KAAMra,GAAWA,EAAE,cAAgBP,CAAW,GACpE,WAAaC,EAC9B,OAAA5L,GAAS,WAAY,UAAU2L,CAAW,qBAAqBC,CAAQ,qBAAqB,EACrF,CAAE,QAAS,IAIpB,MAAMrJ,GADa,MAAM0W,GAAe,yBACL,gBAAkBuN,EAAK,eAG1DvN,GAAe,sBAAsBsN,EAAQ5a,EAAaC,CAAQ,EAElE,GAAI,CACF,MAAM5D,EAAW,MAAMwB,GAAU,KAAUnH,GAAc,UAAU,qBAAsB,CAAE,OAAAkkB,EAAQ,KAAM,CAAE,aAAc3a,EAAU,YAAAD,EAAa,gBAAiB,GAAK,YAAAnJ,EAAa,eAAAD,CAAA,EAAkB,EAAI,EAGzM,OAAIyF,GACFiR,GAAe,qBAAqBsN,EAAQve,CAAQ,EAG/C,CAAE,QAAS,GACpB,OAASI,EAAQ,CAEf,GAAIA,GAAG,aAAe,KAAOA,GAAG,mBAAoB,CAClDpI,GAAS,WAAY,mCAAmC4L,CAAQ,8BAA8B,EAC9F,MAAM,IAAI,QAAQ5E,GAAK,WAAWA,EAAG,IAAI,CAAC,EAC1C,MAAMoX,GAAc,YAAY,EAAI,EAEpC,IAAIO,EAAc5U,EAAgB,WAC9B0c,EAAiB9H,EAAY,cAAc4H,CAAM,EACjDG,EAAeD,GAAgB,SAAS,KAAMva,GAAWA,EAAE,cAAgBP,CAAW,EAE1F,GAAI+a,GAAc,WAAa9a,EAC7B,OAAAzL,GAAQ,WAAY,0CAA0CyL,CAAQ,YAAY2a,CAAM,EAAE,EACnF,CAAE,QAAS,IASpB,GALA,MAAM,IAAI,QAAQvf,GAAK,WAAWA,EAAG,GAAI,CAAC,EAC1C,MAAMoX,GAAc,YAAY,EAAI,EACpCO,EAAc5U,EAAgB,WAC9B0c,EAAiB9H,EAAY,cAAc4H,CAAM,EACjDG,EAAeD,GAAgB,SAAS,KAAMva,GAAWA,EAAE,cAAgBP,CAAW,EAClF+a,GAAc,WAAa9a,EAC7B,OAAAzL,GAAQ,WAAY,kDAAkDyL,CAAQ,YAAY2a,CAAM,EAAE,EAC3F,CAAE,QAAS,GAEtB,CAGA,MAAM3d,EAAOR,GAAG,WAAaA,GAAG,oBAC1Bue,EAAc/d,IAAS,MAAQA,IAAS,MAAQA,IAAS,MAAQA,IAAS,KAEhF,OAAI+d,GAAe/d,IAAS,KAC1B5I,GAAS,WAAY,2BAA2B4I,CAAI,aAAa2d,CAAM,YAAY5a,CAAW,GAAGgb,EAAc,cAAgB,EAAE,EAAE,EAC1Hve,GAAG,aAAe,IAE3BpI,GAAS,WAAY,qCAAqCumB,CAAM,YAAY5a,CAAW,KAAKvD,EAAE,OAAO,EAAE,EAEvG/H,GAAS,WAAY,+BAA+BkmB,CAAM,YAAY5a,CAAW,IAAKvD,CAAC,EAGlF,CAAE,QAAS,GAAO,KAAMue,CAAA,CACjC,CACF,CAEQ,oBAAoB3b,EAA2B,CACrD,OAAIqS,GAAc,IAAIrS,EAAK,UAAU,EAAUA,EAAK,WAC7C4N,EAAgB,QAAQ5N,EAAK,QAAQ,GAAG,WAAW,gBAAkBA,EAAK,UACnF,CAEA,cAAcA,EAAmBtM,EAAqB,CACpD,MAAMwN,EAAIxN,GAASqL,EAAgB,WACnC,GAAImC,EAAE,gBAAgB,KAAM/H,GAAWA,EAAE,iBAAmB6G,EAAK,cAAc,EAAG,MAAO,QACzF,SAAW,CAACK,EAAQ+F,CAAK,IAAK,OAAO,QAAQlF,EAAE,oBAAoB,EACjE,GAAKkF,EAAgB,KAAKjN,GAAKA,EAAE,iBAAmB6G,EAAK,cAAc,EAAG,OAAOK,EAEnF,SAAW,CAACA,EAAQ+F,CAAK,IAAK,OAAO,QAAQlF,EAAE,kBAAkB,EAC/D,GAAKkF,EAAgB,KAAKjN,GAAKA,EAAE,iBAAmB6G,EAAK,cAAc,EAAG,OAAOK,EAEnF,MAAO,EACT,CAKA,oBAAoBL,EAAmBxI,EAA8B,CAEnE,MAAMwc,EADQjV,EAAgB,WACN,WAAW,KAAK,GAAK,EAAE,cAAgBvH,CAAW,EAC1E,GAAI,CAACwc,EAAW,MAAO,GAEvB,MAAM7J,EAAMyD,EAAgB,QAAQ5N,EAAK,QAAQ,EAUjD,MATI,GAACmK,GAGD,CAACA,EAAI,YAAc,CAACA,EAAI,WAAW,YAEjC,CAACkI,GAAc,IAAIrS,EAAK,UAAU,GAIpC,CAAC,KAAK,kBAAkBmK,EAAI,UAAW6J,EAAU,SAAS,EAOhE,CAEQ,kBAAkB4H,EAAmBC,EAAiC,CAC5E,OACED,IAAc,GACdC,IAAmB,GACnBD,IAAcC,CAElB,CACF,CAEO,MAAMzN,GAAkB,IAAIyE,GCn6C7BiJ,OAAsB,QAE5B,SAASC,GAAsB3V,EAAsBmF,EAA8C,CACjG,IAAI5J,EAASma,GAAgB,IAAIvQ,CAAQ,EACzC,GAAI5J,EAAQ,OAAOA,EACnB,MAAMqa,MAAe,IACrB,UAAWhc,KAAQoG,EACZ4V,EAAS,IAAIhc,EAAK,UAAU,GAAGgc,EAAS,IAAIhc,EAAK,WAAY,EAAE,EACpEgc,EAAS,IAAIhc,EAAK,UAAU,EAAG,KAAKA,CAAI,EAE1C,OAAA8b,GAAgB,IAAIvQ,EAAUyQ,CAAQ,EAC/BA,CACT,CAEA,MAAMC,EAAe,CACX,kBAAmC,KACnC,gBAA2C,KAC3C,oBAAsB,EAE9B,kBAAkBplB,EAAiC4c,EAAmC,CACpF,OAAOsI,GAAsBllB,EAAM,MAAOA,CAAK,EAAE,IAAI4c,CAAU,GAAK,EACtE,CAEO,iBAAiBve,EAAiI,CACvJ,MAAM2B,EAAQkI,EAAgB,WACxB,CAAE,qBAAAmd,EAAsB,mBAAAC,EAAoB,eAAAC,CAAA,EAAmBvlB,EACrE,IAAImJ,EAA2B,KAC/B,MAAMqc,EAAW,CAAC,GAAGD,CAAc,EAC7BE,EAAQ,CAAE,GAAGJ,CAAA,EACbK,EAAQ,CAAE,GAAGJ,CAAA,EAEbK,EAAiBC,GAAwB,CAC7C,MAAMlN,EAAMkN,EAAK,aAAetjB,EAAE,iBAAmBjE,EAAK,UAAU,EACpE,OAAIqa,IAAQ,IAAMvP,EAAO,CAAE,GAAGyc,EAAKlN,CAAG,GAAKkN,EAAK,OAAOlN,EAAK,CAAC,EAAU,IAChE,EACT,EAEA,GAAI,CAACiN,EAAcH,CAAQ,EAAG,CAC5B,UAAWxhB,KAAM,OAAO,KAAKyhB,CAAK,EAAG,CACnC,MAAMG,EAAO,CAAC,GAAIH,EAAMzhB,CAAE,GAAK,EAAG,EAClC,GAAI2hB,EAAcC,CAAI,EAAG,CAAEH,EAAMzhB,CAAE,EAAI4hB,EAAM,KAAO,CACtD,CACA,GAAI,CAACzc,EACH,UAAWnF,KAAM,OAAO,KAAK0hB,CAAK,EAAG,CACnC,MAAME,EAAO,CAAC,GAAIF,EAAM1hB,CAAE,GAAK,EAAG,EAClC,GAAI2hB,EAAcC,CAAI,EAAG,CAAEF,EAAM1hB,CAAE,EAAI4hB,EAAM,KAAO,CACtD,CAEJ,CAEA,GAAKzc,EAGL,IAFI9K,EAAK,cAAcA,EAAK,aAAa8K,CAAI,EAEzC9K,EAAK,WAAa,QACpBmnB,EAAS,KAAKrc,CAAI,UAEd9K,EAAK,QAAS,CAChB,MAAMwnB,EAAQ,CAAC,GAAIH,EAAMrnB,EAAK,QAAQ,GAAK,EAAG,EAExCwR,EADUkH,EAAgB,QAAS5N,EAAqB,QAAQ,GAC/C,WAAW,eAC5B2c,EAAUD,EAAM,aAAevjB,EAAE,aAAgB6G,EAAqB,UAAU,EACtF,GAAI2c,IAAY,GAAI,CAClB,MAAMC,EAAMF,EAAM,OAAOC,EAAS,CAAC,EAAE,CAAC,EACtCL,EAAMpnB,EAAK,QAAQ,EAAI,CAAC,GAAIonB,EAAMpnB,EAAK,QAAQ,GAAK,GAAK0nB,CAAG,CAC9D,CACA,GAAIlW,EAAO,CACT,MAAMmW,EAAOH,EAAM,UAAUvjB,GAAKyU,EAAgB,QAAQzU,EAAE,QAAQ,GAAG,WAAW,iBAAmBuN,CAAK,EAC1G,GAAImW,IAAS,GAAI,CACf,MAAMC,EAAQJ,EAAM,OAAOG,EAAM,CAAC,EAAE,CAAC,EACrCP,EAAMpnB,EAAK,QAAQ,EAAI,CAAC,GAAIonB,EAAMpnB,EAAK,QAAQ,GAAK,GAAK4nB,CAAK,CAChE,CACF,CACAJ,EAAM,KAAK1c,CAAI,EACfuc,EAAMrnB,EAAK,QAAQ,EAAIwnB,CACzB,MACEJ,EAAMpnB,EAAK,QAAQ,EAAI,CAAC,GAAIonB,EAAMpnB,EAAK,QAAQ,GAAK,GAAK8K,CAAI,EAIjEjB,EAAgB,SAAS,CACvB,eAAgBsd,EAChB,qBAAsBC,EACtB,mBAAoBC,EACpB,wBAAyB,IAAI,OAAO,cACpC,YAAa,KAAK,KAAI,CACvB,EACH,CAKO,qBAAqBtc,EAAoB8c,EAAa,CAC3D,MAAMrpB,EAAQqL,EAAgB,WACxBie,EAAWD,EAAO,KACxB,GAAI,CAACC,EAAU,OAMf,MAAMC,EAAe,CAAE,GAAGvpB,EAAM,eAChC,GAAIupB,EAAahd,CAAU,EAAG,CAC5B,MAAMid,EAAOF,EACPG,EAAkBF,EAAahd,CAAU,EAAE,QACjDgd,EAAahd,CAAU,EAAI,CACzB,GAAGgd,EAAahd,CAAU,EAC1B,MAAOid,EAAK,aAAa,MACzB,WAAYA,EAAK,WACjB,WAAYA,EAAK,WAEjB,QAASC,CAAA,CAEb,CAGA,MAAMC,EAAgBX,GAAwB,CAC5C,MAAMlN,EAAMkN,EAAK,UAAUtjB,GAAKA,EAAE,iBAAmB8G,CAAU,EAC/D,OAAIsP,IAAQ,IACVkN,EAAKlN,CAAG,EAAI,CAAE,GAAGkN,EAAKlN,CAAG,EAAG,GAAGyN,EAAU,SAAUpP,EAAgB,QAAQoP,EAAS,QAAQ,GAAG,WAAW,UAAY,GAC/G,IAEF,EACT,EAEMX,EAAW,CAAC,GAAG3oB,EAAM,cAAc,EACnC4oB,EAAQ,CAAE,GAAG5oB,EAAM,sBACnB6oB,EAAQ,CAAE,GAAG7oB,EAAM,oBAEzB,IAAI2pB,EAAQD,EAAaf,CAAQ,EACjC,GAAI,CAACgB,EACH,UAAWxiB,KAAM,OAAO,KAAKyhB,CAAK,EAAG,CACnC,MAAMG,EAAO,CAAC,GAAIH,EAAMzhB,CAAE,GAAK,EAAG,EAClC,GAAIuiB,EAAaX,CAAI,EAAG,CAAEH,EAAMzhB,CAAE,EAAI4hB,EAAMY,EAAQ,GAAM,KAAO,CACnE,CAEF,GAAI,CAACA,EACH,UAAWxiB,KAAM,OAAO,KAAK0hB,CAAK,EAAG,CACnC,MAAME,EAAO,CAAC,GAAIF,EAAM1hB,CAAE,GAAK,EAAG,EAClC,GAAIuiB,EAAaX,CAAI,EAAG,CAAEF,EAAM1hB,CAAE,EAAI4hB,EAAMY,EAAQ,GAAM,KAAO,CACnE,CAGFte,EAAgB,SAAS,CACvB,cAAeke,EACf,eAAgBZ,EAChB,qBAAsBC,EACtB,mBAAoBC,EACpB,YAAa,KAAK,KAAI,CACvB,CACH,CAEA,MAAM,sBAA+C,CACnD,GAAI,KAAK,kBAAmB,OAAO,KAAK,kBACxC,MAAMe,EAAU,MAAM,KAAK,aAC3B,GAAI,CAACA,GAAS,YAAY,KAAM,OAAO,KACvC,MAAMC,EAAQ,OAAO,OAAOD,EAAQ,WAAW,IAAI,EAAE,KAAK,CAAC,EAAG7Z,IAAM,IAAI,KAAKA,EAAE,cAAc,EAAE,UAAY,IAAI,KAAK,EAAE,cAAc,EAAE,SAAS,EAC/I,OAAQ,KAAK,kBAAoB8Z,EAAM,CAAC,GAAG,aAAe,IAC5D,CAEA,MAAM,YAAqD,CAEzD,GAAI,CADW,MAAMlnB,GAAG,gBACX,OAAO,KACpB,MAAMsI,EAAa,MAAM,KAAK,uBAC9B,GAAI,CAACA,EAAY,OAAO,KACxB,GAAI,CACF,MAAMlH,EAAa,CAAC,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KAAM,KAAM,IAAI,EACrG,OAAO,MAAM+G,GAAU,QAAgC,aAAaG,EAAW,cAAc,YAAYA,EAAW,YAAY,gBAAgBlH,EAAW,KAAK,GAAG,CAAC,GAAI,CAAE,aAAc,GAAM,CAChM,MAAQ,CAAE,OAAO,IAAM,CACzB,CAEA,MAAM,sBAAyD,CAC7D,GAAI,KAAK,iBAAmB,KAAK,MAAQ,KAAK,oBAAsB,IAAQ,OAAO,KAAK,gBACxF,GAAI,CACF,MAAM+lB,EAAO,MAAMhf,GAAU,QAAa,sCAAuC,CAAE,aAAc,GAAM,EACjGif,EAAUD,EAAK,mBAAmB,KAAMhF,GAAWA,EAAE,eAAiBgF,EAAK,mBAAmB,GAAKA,EAAK,mBAAmB,CAAC,EAClI,YAAK,oBAAsB,KAAK,MACxB,KAAK,gBAAkB,CAAE,aAAcC,EAAQ,aAAc,eAAgBA,EAAQ,eAAgB,YAAaA,EAAQ,YAAa,wBAAyBD,EAAK,eAAe,+BAAiCC,EAAQ,YAAa,4BAA6BD,EAAK,eAAe,mCAAqC,EAC1U,MAAQ,CAAE,OAAO,IAAM,CACzB,CAEA,MAAM,aAAsC,CAC1C,MAAME,EAAM,MAAM,KAAK,uBACvB,GAAI,CAACA,EAAK,OAAO,KACjB,GAAI,CAEF,OADa,MAAMlf,GAAU,IAAS,iBAAiBkf,EAAI,cAAc,IAAIA,EAAI,YAAY,QAAS,EAAI,IAC7F,UAAU,CAAC,GAAG,OAAO,MAAQ,IAC5C,MAAQ,CAAE,OAAO,IAAM,CACzB,CAEA,eAAeJ,EAAiC,CAC9C,MAAMpB,EAAsD,GACtDC,EAAoD,GACpDwB,EAAqC,GAEvCL,EAAQ,sBAAsB,MAAM,OAAO,QAAQA,EAAQ,qBAAqB,IAAI,EAAE,QAAQ,CAAC,CAACziB,EAAI+iB,CAAC,IAAM1B,EAAqBrhB,CAAE,EAAI+iB,EAAE,MAAM,IAAIzkB,IAAM,CAAE,GAAGA,EAAG,SAAUyU,EAAgB,QAAQzU,EAAE,QAAQ,GAAG,WAAW,UAAY,GAAI,CAAC,EAC3OmkB,EAAQ,oBAAoB,MAAM,OAAO,QAAQA,EAAQ,mBAAmB,IAAI,EAAE,QAAQ,CAAC,CAACziB,EAAI+iB,CAAC,IAAMzB,EAAmBthB,CAAE,EAAI+iB,EAAE,MAAM,IAAIzkB,IAAM,CAAE,GAAGA,EAAG,SAAUyU,EAAgB,QAAQzU,EAAE,QAAQ,GAAG,WAAW,UAAY,GAAI,CAAC,EACzO,MAAMijB,GAAkBkB,EAAQ,kBAAkB,MAAM,OAAS,IAAI,IAAInkB,IAAM,CAAE,GAAGA,EAAG,SAAUyU,EAAgB,QAAQzU,EAAE,QAAQ,GAAG,WAAW,UAAY,GAAI,EAE7JmkB,EAAQ,gBAAgB,WAAW,MACrC,OAAO,QAAQA,EAAQ,eAAe,UAAU,IAAI,EAAE,QAAQ,CAAC,CAACziB,EAAIqiB,CAAI,IAAM,CAC5ES,EAAc9iB,CAAE,EAAI,CAClB,MAAOqiB,EAAK,aAAa,MAAO,WAAYA,EAAK,WAAY,WAAYA,EAAK,WAAY,SAAUA,EAAK,SAAU,SAAUA,EAAK,SAClI,OAAQ,CAAE,GAAGA,EAAK,OAAQ,WAAYI,EAAQ,eAAe,SAAS,OAAOziB,CAAE,GAAG,QAAQ,KAAMqG,GAAWA,EAAE,WAAa,UAAU,GAAK,IACzI,SAAUoc,EAAQ,eAAe,SAAS,OAAOziB,CAAE,GAAG,SAAW,IAAI,IAAI,CAACqG,EAAQqO,KAAiB,CAAE,GAAGrO,EAAG,YAAaqO,EAAK,SAAU3B,EAAgB,QAAQ1M,EAAE,UAAY,CAAC,EAAG,SAAU0M,EAAgB,QAAQ1M,EAAE,UAAY,CAAC,GAAI,EACtO,WAAYoc,EAAQ,eAAe,YAAY,OAAOziB,CAAE,GAAG,YAAc,EAAC,CAE9E,CAAC,EAGCyiB,EAAQ,gBAAgB,OAAO,MACjC,OAAO,QAAQA,EAAQ,eAAe,MAAM,IAAI,EAAE,QAAQ,CAAC,CAACziB,EAAIgjB,CAAE,IAAM,CACjEF,EAAc9iB,CAAE,IAAG8iB,EAAc9iB,CAAE,EAAI,CAAE,QAAS,EAAC,GACxD,MAAMqG,EAAS,CAAE,MAAO,GACxB,OAAO,OAAO2c,EAAG,KAAK,EAAE,QAAS/U,GAAc,CACzCA,EAAK,WAAalR,GAAY,WAAUsJ,EAAE,SAAW4H,EAAK,OAC1DA,EAAK,WAAalR,GAAY,aAAYsJ,EAAE,WAAa4H,EAAK,OAC9DA,EAAK,WAAalR,GAAY,WAAUsJ,EAAE,SAAW4H,EAAK,OAC1DA,EAAK,WAAalR,GAAY,aAAYsJ,EAAE,WAAa4H,EAAK,OAC9DA,EAAK,WAAalR,GAAY,YAAWsJ,EAAE,UAAY4H,EAAK,OAC5DA,EAAK,WAAalR,GAAY,WAAUsJ,EAAE,SAAW4H,EAAK,MAChE,CAAC,EACD6U,EAAc9iB,CAAE,EAAE,MAAQqG,CAC5B,CAAC,EAGH,MAAM4c,EAAc,OAAO,KAAKR,EAAQ,uBAAuB,MAAQ,EAAE,EAAE,CAAC,EAGtElT,EAAQkT,EAAQ,sBAAsB,KACtCS,EAAoB3T,GAAO,YAAc,EACzC4T,EAAyB5T,GAAO,8BAAgC,GAChE6T,EAA8B7T,GAAO,mCAAqC,GAI1E8T,EAAe9T,GAAO,mBAAqB,GAC3C+T,EAAwBD,EAAa,CAAC,GAAK,EAC3CE,EAAoBF,EAAa,CAAC,GAAK,EAE7C,MAAO,CACL,qBAAAhC,EAAsB,mBAAAC,EAAoB,eAAAC,EAAgB,cAAAuB,EAC1D,iBAAkBG,GAAcR,EAAQ,sBAAsB,KAAKQ,CAAW,GAAG,aAAa,WAAW,GAAG,OAAS,EACrH,wBAAyBR,EAAQ,wBACjC,kBAAAS,EACA,uBAAAC,EACA,4BAAAC,EACA,kBAAAG,EACA,sBAAAD,CAAA,CAEJ,CAEA,MAAM,eAAerL,EAAqD,CAGxE,MAAM/R,EADQhC,EAAgB,WACP,cAAc+T,CAAc,EACnD,GAAI/R,GAAU,SAAS,OACrB,MAAO,CAAE,QAASA,EAAS,SAG7B,MAAM2c,EAAM,MAAM,KAAK,uBACvB,GAAI,CAACA,EAAK,MAAO,CAAE,QAAS,EAAC,EAC7B,GAAI,CAEF,MAAO,CAAE,SADI,MAAMlf,GAAU,QAAa,aAAakf,EAAI,cAAc,YAAYA,EAAI,YAAY,SAAS5K,CAAc,mBAAoB,CAAE,aAAc,GAAM,GAC/I,SAAS,MAAM,SAAW,EAAC,CACpD,MAAQ,CAAE,MAAO,CAAE,QAAS,EAAC,CAAK,CACpC,CAKA,sBAAsB7S,EAAoBU,EAAqBC,EAAkB,CAC/E,MAAM6D,EAAOmJ,EAAgB,QAAQhN,CAAQ,EACvCyd,EAAOzQ,EAAgB,QAAQhN,CAAQ,EAC7C7B,EAAgB,WAAW,iBAAiBkB,EAAYU,EAAaC,EAAU6D,EAAM4Z,CAAI,CAC3F,CAEA,MAAM,qBAAqB7mB,EAAqBsb,EAAwBgI,EAAgB,GAAO7H,EAAiC,CAC9Hje,GAAS,WAAY,8BAA8BwC,CAAW,SAASsb,CAAc,kBAAkBgI,CAAa,EAAE,EACtH,MAAMpnB,EAAQqL,EAAgB,WAExBiB,EADYtM,EAAM,kBACD,KAAKyF,GAAKA,EAAE,iBAAmB2Z,CAAc,EACpE,GAAI,CAAC9S,EACH,OAAAhL,GAAS,WAAY,mEAAmE,EACjF,GAKT,GAAI,EADatB,EAAM,qBAAqB8D,CAAW,GAAK,IAC9C,QAAU2B,EAAE,iBAAmB2Z,CAAc,EACzD,OAAA9d,GAAS,WAAY,8CAA8CwC,CAAW,kBAAkB,EACzF,GAGTxC,GAAS,WAAY,8BAA8BgL,EAAK,QAAQ,mBAAmBxI,CAAW,0BAA0B,EAExH,MAAMoR,EAAS5I,EAAK,WACdwb,EAAO9nB,EAAM,WAAW,KAAK0L,GAAKA,EAAE,cAAgB5H,CAAW,EAG/D8mB,EAAgB5qB,EAAM,qBAAqB8D,CAAW,GAAK,GACjE,IAAIojB,EAAM0D,EAAc,KAAKnlB,GAAK,CAGhC,GAFIA,EAAE,aAAeyP,GACjBzP,EAAE,iBAAmB2Z,GACrBG,GAAS,eAAe,IAAI9Z,EAAE,cAAc,EAAG,MAAO,GAC1D,MAAMgR,EAAMyD,EAAgB,QAAQzU,EAAE,QAAQ,EAE9C,MADI,EAAA2hB,GAAiB3Q,GAAK,WAAa,GACnCqR,GAAM,YAAc,QAAarR,GAAK,YAAc,GAAKA,GAAK,YAAcqR,EAAK,UAEvF,CAAC,EAQD,GALKZ,IACH5lB,GAAS,WAAY,mEAAmE,EACxF4lB,EAAMxM,GAAgB,oBAAoBxF,EAAQpR,EAAa,IAAI,IAAI,CAACsb,EAAgB,GAAIG,GAAS,eAAiB,EAAG,CAAC,EAAGuI,GAAM,UAAWV,CAAa,GAGzJ,CAACF,EACH,OAAAvlB,GAAS,WAAY,oEAAoEuT,CAAM,iBAAiBpR,CAAW,EAAE,EACtH,GAGTxC,GAAS,WAAY,2CAA2C4lB,EAAI,QAAQ,KAAKA,EAAI,cAAc,GAAG,EAEtG,MAAM2D,EAAUnQ,GAAwB,cAAcwM,CAAG,EAGzD,GAAI2D,IAAW/mB,EAAa,CAC1BrC,GAAQ,WAAY,sBAAsBylB,EAAI,cAAc,SAAS2D,CAAM,OAAO/mB,CAAW,EAAE,EAM/F,MAAM0J,EAAI+R,GAAWR,GAAkB,CAACmI,EAAI,eAAiB9H,CAAc,EAAG,EAAGtb,CAAW,EAU5F,GATA0J,EAAE,cAAc,IAAI4R,CAAc,EAClC5R,EAAE,cAAc,IAAI0Z,EAAI,cAAe,EAGlB0D,EAAc,UAAYnlB,EAAE,aAAeyP,CAAM,EAAE,QACvD,GAIc,EAAG,CAEhC,MAAM4V,EAAeF,EAAc,OAAOnlB,GACxCA,EAAE,aAAeyP,GACjBzP,EAAE,iBAAmB2Z,GACrB,CAAC5R,EAAE,cAAc,IAAI/H,EAAE,cAAe,GAGxC,GAAIqlB,EAAa,OAAS,EAAG,CAE3BA,EAAa,KAAK,CAACnW,GAAG5E,IAAM,CAC1B,MAAM8V,EAAQlR,GAAE,UAAY,EAAGmR,EAAQ/V,EAAE,UAAY,EACrD,GAAI8V,IAAUC,EAAO,OAAOD,EAAQC,EACpC,MAAMC,EAAK/lB,EAAM,cAAc2U,GAAE,cAAe,GAAG,OAAS,EACtDqR,EAAKhmB,EAAM,cAAc+P,EAAE,cAAe,GAAG,OAAS,EAC5D,OAAOgW,EAAKC,CACd,CAAC,EAED,MAAM3G,EAAUyL,EAAa,CAAC,EAC9BrpB,GAAQ,WAAY,oCAAoC4d,EAAQ,cAAc,yBAAyB,EACvG,MAAM0L,EAAW,MAAMrQ,GAAgB,SAAS2E,EAASvb,EAAa,QAAS0J,EAAG,CAAE,OAAQ,GAAM,EAClG,GAAI,CAACud,EAAS,QACZ,OAAAppB,GAAS,WAAY,gDAAgDopB,EAAS,KAAK,EAAE,EAC9E,EAEX,KACE,QAAAppB,GAAS,WAAY,4DAA4DuT,CAAM,EAAE,EAClF,EAEX,CAEA,MAAM8V,EAAQ,MAAMtQ,GAAgB,SAASwM,EAAK2D,EAAQ/mB,EAAa0J,EAAG,CAAE,OAAQ,GAAM,EAC1F,GAAI,CAACwd,EAAM,QACT,OAAArpB,GAAS,WAAY,mCAAmCulB,EAAI,cAAc,OAAOpjB,CAAW,KAAKknB,EAAM,KAAK,EAAE,EACvG,GAOT,GAHA,MAAMtL,GAAc,YAAY,EAAI,EAEpCwH,EADiB7b,EAAgB,WAClB,kBAAkB,QAAU5F,EAAE,iBAAmByhB,GAAK,cAAc,EAC/E,CAACA,EACH,OAAAvlB,GAAS,WAAY,oBAAoByd,CAAc,iCAAiC,EACjF,EAEX,CAGA9d,GAAS,WAAY,+CAA+C4lB,EAAI,cAAc,6BAA6B,EACnH,KAAK,iBAAiB,CACpB,WAAYA,EAAI,eAChB,SAAUpjB,EACV,SAAUA,EACV,QAAS,GACV,EAED,MAAM4C,EAAS,MAAM,KAAK,kBAAkB5C,EAAaojB,EAAI,cAAe,EAC5E,OAAA5lB,GAAS,WAAY,oDAAoDoF,CAAM,EAAE,EAC1EA,CACT,CAGA,MAAM,kBAAkB5C,EAAqBsb,EAA0C,CACrF9d,GAAS,WAAY,2BAA2BwC,CAAW,SAASsb,CAAc,EAAE,EACpF,MAAM4K,EAAM,MAAM,KAAK,uBACvB,GAAI,CAACA,EACH,OAAAroB,GAAS,WAAY,wCAAwC,EACtD,GAET,GAAI,CACF,aAAMmJ,GAAU,KAAK,qCAAsC,CACzD,OAAQsU,EACR,YAAAtb,EACA,eAAgBkmB,EAAI,gBACnB,EAAI,EACP1oB,GAAS,WAAY,uCAAuC,EACrD,EACT,OAASoI,EAAQ,CACf,OAAA/H,GAAS,WAAY,qCAAsC+H,CAAC,EACrD,EACT,CACF,CAEA,MAAM,aAAaqT,EAAkBqC,EAAwBC,EAAkBvb,EAAuC,CACpH,MAAMkmB,EAAM,MAAM,KAAK,uBACvB,GAAI,CAACA,EAAK,MAAO,GACjB,GAAI,CACF,aAAMlf,GAAU,KAAK,wCAAyC,CAC5D,kBAAmBiS,EACnB,UAAW,EACX,gBAAiBsC,EACjB,OAAQD,EACR,YAAAtb,EACA,eAAgBkmB,EAAI,gBACnB,EAAI,EACA,EACT,MAAQ,CACN,MAAO,EACT,CACF,CACF,CAEO,MAAMzP,GAAiB,IAAIgO,GAElC,MAAM0C,EAAc,CACV,YAAuC,KACvC,UAAY,GACZ,mBAA2D,KAC3D,iBAAmB,GAE3B,MAAM,YAAYC,EAAQ,GAAOjiB,EAAa,EAAqB,CACjE,OAAI,KAAK,YACHiiB,GAAS,MAAM,KAAK,YAAoB,KAAK,YAAY,GAAMjiB,CAAU,GACtE,KAAK,aAEd,KAAK,UAAY,GACjBoC,EAAgB,WAAW,WAAW,EAAI,EAC1C,KAAK,aAAe,SAAY,CAC9B,GAAI,CACF,MAAMgM,EAAI,MAAMkD,GAAe,aAC/B,GAAI,CAAClD,EAAG,MAAO,GACf,MAAMlU,EAAQkI,EAAgB,WACxB4X,EAAI1I,GAAe,eAAelD,CAAC,EAC7BlU,EAAM,eAAe8f,CAAC,IACtB3X,GAAqB,iBAAmBrC,IAAe,GACjE,WAAW,IAAM,KAAK,YAAY,GAAO,CAAC,EAAG,GAAI,EAGnD,MAAMkiB,EAAsB9T,EAAE,SAAS,MAAM,qBAAuB,EAC9D+T,EAAgB/T,EAAE,SAAS,MAAM,eAAiB,EAExDhM,EAAgB,SAAS,CACvB,oBAAA8f,EACA,cAAAC,CAAA,CACD,EAEDjoB,EAAM,cAAckU,EAAE,WAAW,KAAO,OAAO,OAAOA,EAAE,WAAW,IAAI,EACpE,KAAK,CAAC1C,EAAG5E,IAAM,IAAI,KAAKA,EAAE,cAAc,EAAE,UAAY,IAAI,KAAK4E,EAAE,cAAc,EAAE,SAAS,EAC1F,IAAIjJ,IAAM,CACT,GAAGA,EACH,aAAcyf,EACd,WAAYlI,EAAE,kBAAoB,GAClC,EAAW,EAAE,EAEjB,MAAMoI,EAAehgB,EAAgB,WACjCggB,EAAa,qBAAuB,CAACA,EAAa,WAAW,KAAK3f,GAAKA,EAAE,cAAgB2f,EAAa,mBAAmB,IAC3H3pB,GAAQ,UAAW,wEAAwE,EAC3F2pB,EAAa,qBAAqBA,EAAa,WAAW,CAAC,GAAG,aAAe,IAAI,GAGnF,KAAM,CAAE,aAAAC,CAAA,EAAiBvc,GAAiB,WAC1C,OAAIuc,GAAgB,CAACJ,GAASjiB,IAAe,GAC3C,KAAK,kBAGA,EACT,OAASrE,EAAO,CACd,OAAIA,aAAiBgF,IAAkBhF,EAAM,YAAc2C,GAAmB,gBAC5E,QAAQ,KAAK,2DAA2D,EAEnE,EACT,SACE,KAAK,UAAY,GACjB8D,EAAgB,WAAW,WAAW,EAAK,EAC3C,KAAK,YAAc,IACrB,CACF,KACO,KAAK,YACd,CAKA,MAAc,iBAAiC,CAC7C,MAAMlI,EAAQkI,EAAgB,WACxBwe,EAAQ1mB,EAAM,WAEpB,UAAW2kB,KAAQ+B,EAAO,CAExB,MAAM5U,EAAU,CAAC,WAAY,WAAY,UAAW,WAAY,WAAY,SAAU,SAAU,UAAU,EAC1G,UAAW8K,KAAc9K,EACTsF,GAAe,kBAAkB,CAAE,MAAO,CAAC,GAAGpX,EAAM,qBAAqB2kB,EAAK,WAAW,GAAK,GAAI,GAAG3kB,EAAM,mBAAmB2kB,EAAK,WAAW,GAAK,EAAE,GAAK/H,CAAU,EAAE,QAGvK,IACX,QAAQ,IAAI,oBAAoBA,CAAU,sBAAsB+H,EAAK,WAAW,2BAA2B,EAC3G,MAAMpN,GAAgB,gBAAgBoN,EAAK,YAAa/H,CAAU,EAGxE,CACF,CAEO,iBAAiBwL,EAAa,IAAa,CAChD,GAAI,KAAK,iBAAkB,OAC3B,KAAK,iBAAmB,GACxB,MAAMC,EAAoB,IAAM,CACzB,SAAS,OACT,KAAK,gBAAgB,EAAI,EADR,KAAK,yBAE7B,EACA,SAAS,iBAAiB,mBAAoBA,CAAiB,EAC/D,OAAO,iBAAiB,SAAU,IAAM,KAAK,yBAAyB,EACtE,KAAK,oBAAoBD,CAAU,CACrC,CAEQ,oBAAoBA,EAA0B,CACpD,KAAK,gBAAgB,EAAI,EACpB,KAAK,mBACV,KAAK,mBAAqB,WAAW,SAAY,CAC/C,MAAM1hB,EAAgBC,GAAa,WAAW,cAC1C,CAAC,SAAS,QAAUuB,EAAgB,WAAW,gBAAgB,OAAS,GAAK,CAACxB,GAChF,MAAM,KAAK,cAEb,KAAK,oBAAoB0hB,CAAU,CACrC,EAAGA,CAAU,EACf,CAEO,yBAAgC,CACjC,KAAK,oBAAoB,aAAa,KAAK,kBAAkB,EACjE,KAAK,cACL,KAAK,oBAAoB,GAAK,CAChC,CAEO,gBAAgBE,EAAO,GAAa,CACrC,KAAK,qBAAsB,aAAa,KAAK,kBAAkB,EAAG,KAAK,mBAAqB,MAC3FA,IAAM,KAAK,iBAAmB,GACrC,CAEA,IAAI,SAAU,CAAE,OAAO,KAAK,SAAW,CACzC,CAEO,MAAM/L,GAAgB,IAAIuL,oIC5nB1B,SAASS,GAAaxZ,EAA8C,CACvE,GAAKA,EAGL,IAAIA,EAAK,SAAS,wBAAwB,GAElCA,EAAK,WAAW,wBAAwB,EAAG,CAI3C,GADkBA,EAAK,QAAQ,QAAS,EAAE,EAC1B,GAAI,CAEhB,MAAMyZ,EAAYzZ,EAAK,QAAQ,SAAS,EACxC,GAAIyZ,EAAY,GACZ,MAAO,yBAAyBzZ,EAAK,UAAUyZ,CAAS,CAAC,EAEjE,CACA,OAAOzZ,CACX,CAIJ,OAAIA,EAAK,WAAW,GAAG,EACZ,yBAAyBA,CAAI,GAInCA,EAAK,WAAW,MAAM,EAKpBA,EAJI,0BAA0BA,CAAI,GAK7C,CC3BA,MAAM0Z,EAAmB,CACb,gBAAkB,EAClB,eAAgC,KAChC,aAAe,GAGN,6BAA+B,IAAS,IACxC,8BAAgC,GAAK,IACrC,mBAAqB,IAAS,IAExC,MAAO,CAGV,SAAS,iBAAiB,mBAAoB,IAAM,KAAK,wBAAwB,EAGjF,OAAO,iBAAiB,SAAU,IAAM,KAAK,cAAc,EAG3D,KAAK,iBAGL,KAAK,SACT,CAEQ,wBAAyB,CAC7B,GAAI,SAAS,OACT,KAAK,oBACF,CACH,KAAK,iBAEL,MAAMC,EAAuB,KAAK,MAAQ,KAAK,gBAE3CA,EAAuB,KAAK,6BAC5B,KAAK,QAAQ,EAAI,EACVA,EAAuB,KAAK,+BACnC,KAAK,QAAQ,EAAK,CAE1B,CACJ,CAEQ,cAAe,CACnB,KAAK,QAAQ,EAAI,CACrB,CAEQ,gBAAiB,CACrB,KAAK,gBACL,KAAK,eAAiB,OAAO,YAAY,IAAM,CAC3C,KAAK,QAAQ,EAAK,CACtB,EAAG,KAAK,kBAAkB,CAC9B,CAEQ,eAAgB,CAChB,KAAK,iBACL,cAAc,KAAK,cAAc,EACjC,KAAK,eAAiB,KAE9B,CAEA,MAAa,QAAQC,EAAO,GAAM,CAC9B,GAAI,KAAK,aAAc,OAEvB,MAAM3oB,EAAQkI,EAAgB,WAC9B,GAAIlI,EAAM,YACN,OAIJ,MAAM4oB,EAAYjiB,GAAa,WAC/B,GAAI,CAACiiB,EAAU,iBAAmB,CAAC5oB,EAAM,WAAW,OAAQ,CACxD,KAAK,aAAe,GACpB,MACJ,CAKA,GAHI,GAACA,EAAM,gBAEW4oB,EAAU,eAKhC,MAAK,aAAe,GAEpB,GAAI,CACA,GAAID,EAAM,CACN,MAAMlC,EAAU,MAAMrP,GAAe,aACrC,GAAIqP,EAAS,CACT,MAAMoC,EAAYzR,GAAe,eAAeqP,CAAO,EACvDzmB,EAAM,eAAe6oB,CAAS,EAG1BpC,EAAQ,YAAY,MACpBzmB,EAAM,cAAc,OAAO,OAAOymB,EAAQ,WAAW,IAAI,CAAQ,EAGrE,KAAK,gBAAkB,KAAK,KAChC,CACJ,KAAO,CAEH,MAAMA,EAAU,MAAMrP,GAAe,aACrC,GAAIqP,EAAS,CACT,MAAMoC,EAAYzR,GAAe,eAAeqP,CAAO,EACvDzmB,EAAM,eAAe6oB,CAAS,EAG1BpC,EAAQ,YAAY,MACpBzmB,EAAM,cAAc,OAAO,OAAOymB,EAAQ,WAAW,IAAI,CAAQ,CAGzE,CACJ,CACJ,MAAY,CACZ,SACI,KAAK,aAAe,EACxB,EACJ,CAMA,MAAa,sBAAuB,CAGhC,MAAM,IAAI,QAAQvnB,GAAW,WAAWA,EAAS,GAAG,CAAC,EACrD,KAAK,QAAQ,EAAK,CACtB,CACJ,CAEO,MAAM4pB,GAAc,IAAIL,GCnIxB,SAASM,IAAiB,CAC/B,KAAM,CAAE,OAAAC,EAAQ,YAAAC,CAAA,EAAgB/iB,GAAA,EAEhC,OAAI8iB,EAAO,SAAW,EAAU,WAG7B,OAAI,UAAU,kBACZ,SAAAA,EAAO,IAAK3c,GACX6c,OAAC,OAEC,UAAW,gBAAgB7c,EAAM,IAAI,GACrC,KAAK,QACL,MAAO,CAAE,aAAc,GAAGA,EAAM,UAAY,GAAI,MAEhD,UAAA8c,MAAC,OAAI,UAAU,yBAAyB,QACvC,OAAI,UAAU,cAAe,SAAAC,GAAQ/c,EAAM,IAAI,EAAE,EAClD6c,OAAC,OAAI,UAAU,iBACZ,UAAA7c,EAAM,OAAS,SAAW8c,MAAC,OAAI,UAAU,qBAAqB,yBAAa,EAC3E9c,EAAM,OAAS,iBAAc,OAAI,UAAU,qBAAqB,6BAAiB,EACjFA,EAAM,OAAS,eAAY,OAAI,UAAU,qBAAqB,2BAAe,EAC7EA,EAAM,OAAS,cAAW,OAAI,UAAU,qBAAqB,uBAAW,EACxEA,EAAM,OAAS,gBAAa,OAAI,UAAU,qBAAqB,yBAAa,EAC7E8c,MAAC,KAAE,UAAU,iBAAkB,WAAM,QAAQ,GAC/C,EACAA,MAAC,UACC,UAAU,eACV,QAAS,IAAMF,EAAY5c,EAAM,EAAE,EACnC,aAAW,UAEX,SAAA8c,MAAC,OACC,MAAM,KACN,OAAO,KACP,QAAQ,YACR,KAAK,OACL,OAAO,eACP,YAAY,IAEZ,SAAAA,MAAC,QAAK,EAAE,uBAAuB,GACjC,EACF,GA9BK9c,EAAM,GAgCd,EACH,CAEJ,CAEA,SAAS+c,GAAQ7T,EAAc,CAC7B,OAAQA,EAAA,CACN,IAAK,UACH,OACE4T,MAAC,OACC,MAAM,KACN,OAAO,KACP,QAAQ,YACR,KAAK,OACL,OAAO,eACP,YAAY,IAEZ,SAAAA,MAAC,QAAK,EAAE,kBAAkB,IAGhC,IAAK,QACH,OACED,OAAC,OACC,MAAM,KACN,OAAO,KACP,QAAQ,YACR,KAAK,OACL,OAAO,eACP,YAAY,IAEZ,UAAAC,MAAC,UAAO,GAAG,KAAK,GAAG,KAAK,EAAE,KAAK,EAC/BA,MAAC,QAAK,EAAE,qBAAqB,KAGnC,IAAK,UACH,OACED,OAAC,OACC,MAAM,KACN,OAAO,KACP,QAAQ,YACR,KAAK,OACL,OAAO,eACP,YAAY,IAEZ,UAAAC,MAAC,QAAK,EAAE,oBAAoB,EAC5BA,MAAC,QAAK,EAAE,sFAAsF,KAGpG,IAAK,QACH,OACED,OAAC,OACC,MAAM,KACN,OAAO,KACP,QAAQ,YACR,KAAK,OAEL,UAAAC,MAAC,UAAO,GAAG,KAAK,GAAG,KAAK,EAAE,KAAK,KAAK,UAAU,EAC9CA,MAAC,QAAK,EAAE,oBAAoB,KAAK,OAAO,OAAO,QAAQ,YAAY,MAAM,cAAc,QAAQ,KAGrG,IAAK,OACH,OACED,OAAC,OAAI,MAAM,KAAK,OAAO,KAAK,QAAQ,YAAY,KAAK,OAAO,OAAO,UAAU,YAAY,MACvF,UAAAC,MAAC,QAAK,EAAE,IAAI,EAAE,KAAK,MAAM,KAAK,OAAO,KAAK,GAAG,IAAI,GAAG,IAAI,EACxDA,MAAC,QAAK,EAAE,yBAAyB,GACnC,EAEJ,IAAK,SACH,OACED,OAAC,OAAI,MAAM,KAAK,OAAO,KAAK,QAAQ,YAAY,KAAK,OAAO,OAAO,UAAU,YAAY,MACvF,UAAAC,MAAC,QAAK,EAAE,IAAI,EAAE,KAAK,MAAM,KAAK,OAAO,KAAK,GAAG,IAAI,GAAG,IAAI,EACxDA,MAAC,QAAK,EAAE,wBAAwB,GAClC,EAGJ,QACE,OACED,OAAC,OACC,MAAM,KACN,OAAO,KACP,QAAQ,YACR,KAAK,OACL,OAAO,eACP,YAAY,IAEZ,UAAAC,MAAC,UAAO,GAAG,KAAK,GAAG,KAAK,EAAE,KAAK,EAC/BA,MAAC,QAAK,EAAE,qBAAqB,IAC/B,CAGR,CAGO,SAASE,IAAW,CACzB,MAAM/M,EAAWpW,GAAerJ,GAAUA,EAAM,QAAQ,EAExD,MAAO,CACL,QAAUyK,GAAoBgV,EAAS,CAAE,KAAM,UAAW,QAAAhV,EAAS,EACnE,MAAQA,GAAoBgV,EAAS,CAAE,KAAM,QAAS,QAAAhV,EAAS,EAC/D,QAAUA,GAAoBgV,EAAS,CAAE,KAAM,UAAW,QAAAhV,EAAS,EACnE,KAAOA,GAAoBgV,EAAS,CAAE,KAAM,OAAQ,QAAAhV,EAAS,EAC7D,MAAQA,GAAoBgV,EAAS,CAAE,KAAM,QAAS,QAAAhV,EAAS,EAEnE,CC3IO,SAASgiB,GACdC,EACA3M,EACyB,CACzB,OAAO2M,EAAU,KAAMpgB,GAASA,EAAK,aAAeyT,CAAU,CAChE,CAYO,SAAS4M,GAAmBD,EAAuC,CACxE,MAAM/R,EAAW8R,GAAgBC,EAAW1oB,EAAc,QAAQ,EAClE,OAAK2W,EACEiS,GAAWjS,EAAS,QAAQ,EADb,MAExB,CAKO,SAASiS,GAAWlc,EAA2B,CACpD,MAAM+F,EAAMyD,EAAgB,QAAQxJ,CAAI,EACxC,GAAI,CAAC+F,EAAK,MAAO,OAWjB,MAAMwH,EATyC,CAC7C,EAAG,MACH,EAAG,QACH,EAAG,OACH,EAAG,SACH,EAAG,SACH,EAAG,aAGqBxH,EAAI,mBAAqB,CAAC,EAGpD,GAAI,CAACwH,EAAS,CACZ,MAAMlN,EAAO0F,EAAI,mBAAmB,MAAM,eAAiB,GAE3D,GAAI,gBAAgB,KAAK1F,CAAI,EAAG,MAAO,YACvC,GAAI,YAAY,KAAKA,CAAI,EAAG,MAAO,QACnC,GAAI,WAAW,KAAKA,CAAI,EAAG,MAAO,OAClC,GAAI,UAAU,KAAKA,CAAI,EAAG,MAAO,MACjC,GAAI,aAAa,KAAKA,CAAI,EAAG,MAAO,SACpC,GAAI,aAAa,KAAKA,CAAI,EAAG,MAAO,QACtC,CAEA,OAAOkN,GAAW,MACpB,CAKO,SAAS4O,GACdH,EACAzC,EACY,CACZ,MAAM9U,EAAoB,CACxB,SAAU,EACV,WAAY,EACZ,SAAU,EACV,WAAY,EACZ,UAAW,EACX,SAAU,EACV,MAAO,GAGH2X,EAAe,CACnB9oB,EAAc,OACdA,EAAc,UACdA,EAAc,YACdA,EAAc,UACdA,EAAc,aAGhB,OAAA0oB,EACG,OAAQpgB,GAASwgB,EAAa,SAASxgB,EAAK,UAAU,CAAC,EACvD,QAASA,GAAS,CACjB,GAAI,CAACA,EAAK,eAAgB,OAC1B,MAAMe,EAAW4c,EAAc3d,EAAK,cAAc,EAC7Ce,GAAU,QAEf8H,EAAM,UAAY9H,EAAS,MAAM,UAAY,EAC7C8H,EAAM,YAAc9H,EAAS,MAAM,YAAc,EACjD8H,EAAM,UAAY9H,EAAS,MAAM,UAAY,EAC7C8H,EAAM,YAAc9H,EAAS,MAAM,YAAc,EACjD8H,EAAM,WAAa9H,EAAS,MAAM,WAAa,EAC/C8H,EAAM,UAAY9H,EAAS,MAAM,UAAY,EAC/C,CAAC,EAEH8H,EAAM,MACJA,EAAM,SACNA,EAAM,WACNA,EAAM,SACNA,EAAM,WACNA,EAAM,UACNA,EAAM,SAEDA,CACT,CAqCO,SAAS4X,GAAazgB,EAA2B,CACtD,MAAMsL,EAAWtL,EAAK,SACtB,OAAIsL,IAAa,EAAU,SACvBA,IAAa,EAAU,YACvBA,IAAa,EAAU,OACvBA,IAAa,EAAU,WACpB,QACT,CCxJO,SAASoV,GAAU,CAAE,KAAAC,GAAwB,CAChD,GAAI,CAACA,GAAQA,GAAQ,EAAG,OAAO,KAG/B,MAAMC,EAAQ,KAAK,IAAID,EAAM,CAAC,EAE9B,aACK,OAAI,UAAW,0BAA0BC,CAAK,GAC1C,eAAM,KAAK,CAAE,OAAQ,EAAG,EAAE,IAAI,CAAClI,EAAGvf,IAC/B6mB,MAAC,OAEG,UAAW,oBAAoB7mB,EAAIynB,EAAQ,SAAW,UAAU,GAChE,QAAQ,YACR,KAAK,eAEL,SAAAZ,MAAC,QAAK,EAAE,+FAA+F,GALlG7mB,CAAA,CAOZ,EACL,CAER,CCYA,MAAM0nB,GAAiBC,gBAAyC,IAAI,EAE7D,SAASC,GAAgB,CAAE,SAAAC,GAA2C,CACzE,KAAM,CAACC,EAASC,CAAU,EAAIC,WAAuB,CAAE,KAAM,KAAM,SAAU,KAAM,EAC7E,CAACC,EAAUC,CAAW,EAAIF,WAAS,CAAE,EAAG,EAAG,EAAG,EAAG,EACjD,CAACG,EAASC,CAAU,EAAIJ,WAAS,EAAK,EACtCK,EAAaC,SAAuB,IAAI,EACxCC,EAAiBD,SAAY,IAAI,EACjCE,EAASF,SAAY,IAAI,EACzBG,EAAkBH,SAAO,CAAE,EAAG,EAAG,EAAG,EAAG,EACvCI,EAAeJ,SAAO,EAAK,EAC3BK,EAAWL,SAAO,EAAK,EAG7BM,YAAU,IAAM,CACZF,EAAa,QAAU,CAAC,CAACZ,EAAQ,UACjCa,EAAS,QAAU,CAAC,CAACb,EAAQ,KACjC,EAAG,CAACA,EAAQ,UAAWA,EAAQ,KAAK,CAAC,EAErCc,YAAU,IAAM,CACZ,MAAMC,EAAmB5kB,GAAkB,CACnC,CAACkkB,GAAWO,EAAa,SAAWC,EAAS,UAGjDF,EAAgB,QAAU,CAAE,EAAGxkB,EAAE,QAAS,EAAGA,EAAE,SAG3CukB,EAAO,SACP,qBAAqBA,EAAO,OAAO,EAIvCA,EAAO,QAAU,sBAAsB,IAAM,CACzCN,EAAY,CAAE,EAAGO,EAAgB,QAAQ,EAAG,EAAGA,EAAgB,QAAQ,EAAG,CAC9E,CAAC,EACL,EAEA,cAAO,iBAAiB,YAAaI,EAAiB,CAAE,QAAS,GAAM,EAChE,IAAM,CACT,OAAO,oBAAoB,YAAaA,CAAe,EACnDL,EAAO,SACP,qBAAqBA,EAAO,OAAO,CAE3C,CACJ,EAAG,CAACL,EAASL,CAAO,CAAC,EAErB,MAAMgB,EAAcC,cAAY,CAC5BliB,EACAe,EACAohB,EACAC,EACAC,GACAC,EACAC,EACAC,EACAC,EACAC,EACAC,KACC,CAEGjB,EAAe,UACf,aAAaA,EAAe,OAAO,EACnCA,EAAe,QAAU,MAI7BG,EAAa,QAAU,CAAC,CAACO,EACzBN,EAAS,QAAU,CAAC,CAACS,EAGrBrB,EAAW0B,GACHA,EAAK,MAAM,iBAAmB5iB,EAAK,gBAAkB4iB,EAAK,kBAAoBT,GAAmBS,EAAK,YAAcR,GAAaQ,EAAK,QAAUL,GAASK,EAAK,eAAe,IAAMJ,GAAe,GAAKI,EAAK,eAAe,IAAMJ,GAAe,GAAKI,EAAK,YAAcH,EACjQG,EAEJ,CAAE,KAAA5iB,EAAM,SAAUe,GAAY,KAAM,gBAAAohB,EAAiB,UAAAC,EAAW,WAAAC,GAAY,QAAAC,EAAS,MAAAC,EAAO,cAAAC,EAAe,UAAAC,EAAW,aAAAC,EAAc,oBAAAC,EAAA,CAC9I,EACDpB,EAAW,EAAI,CACnB,EAAG,EAAE,EAECsB,EAAcX,cAAY,IAAM,CAElCR,EAAe,QAAU,OAAO,WAAW,IAAM,CAC7CH,EAAW,EAAK,EAEhB,WAAW,IAAM,CACbL,EAAW,CAAE,KAAM,KAAM,SAAU,KAAM,CAC7C,EAAG,EAAE,CACT,EAAG,EAAE,CACT,EAAG,EAAE,EAEC4B,EAAmBZ,cAAY,IAAM,CACvChB,MAAoB,CAAE,GAAG0B,EAAM,iBAAkB,IAAO,CAC5D,EAAG,EAAE,EAoECG,GAjEkB,IAAM,CAE1B,GAAI9B,EAAQ,MAAO,CACf,GAAIA,EAAQ,cAAe,CACvB,MAAM+B,EAAQxB,EAAW,SAAS,aAAe,EAC3CyB,GAASzB,EAAW,SAAS,cAAgB,EACnD,IAAI0B,EAAIjC,EAAQ,cAAc,EAG1BkC,GAAIlC,EAAQ,cAAc,EAAKgC,GAAS,EAAK,GAEjD,MAAMG,GAAe,IAGrB,OAAIF,EAAIF,EAAQ,OAAO,WAAa,KAChCE,EAAI,OAAO,WAAaF,EAAQ,IAIhCG,GAAIF,GAAS,OAAO,YAAc,KAClCE,GAAI,OAAO,YAAcF,GAAS,IAItCC,EAAI,KAAK,IAAI,GAAIA,CAAC,EAClBC,GAAI,KAAK,IAAIC,GAAcD,EAAC,EAErB,CAAE,EAAAD,EAAG,EAAAC,GAChB,CAGA,MAAO,CAAE,EAFI,GAEK,EADL,GACQ,CACzB,CAEA,GAAI,CAAC3B,EAAW,SAAW,CAACF,EACxB,MAAO,CAAE,EAAGF,EAAS,EAAI,GAAI,EAAG,KAGpC,MAAMiC,EAAW,GACXC,EAAW,IACXN,EAAQxB,EAAW,QAAQ,YAC3ByB,EAASzB,EAAW,QAAQ,aAC5B4B,GAAe,IAErB,IAAIF,EAAI9B,EAAS,EAAIiC,EAEjBF,EAAI,KAAK,IAAIC,GAAchC,EAAS,EAAIkC,CAAQ,EAGpD,OAAIJ,EAAIF,EAAQ,OAAO,WAAa,KAChCE,EAAI9B,EAAS,EAAI4B,EAAQK,GAIzBF,EAAIF,EAAS,OAAO,YAAc,MAClCE,EAAI,OAAO,YAAcF,EAAS,KAItCC,EAAI,KAAK,IAAI,GAAI,KAAK,IAAIA,EAAG,OAAO,WAAaF,EAAQ,EAAE,CAAC,EAC5DG,EAAI,KAAK,IAAIC,GAAcD,CAAC,EAErB,CAAE,EAAAD,EAAG,EAAAC,CAAA,CAChB,GAEY,EAENI,EAA+B,CACjC,SAAU,QACV,KAAM,GAAGR,EAAI,CAAC,KACd,IAAK,GAAGA,EAAI,CAAC,KACb,cAAgB9B,EAAQ,WAAaA,EAAQ,MAAS,OAAS,OAC/D,OAASA,EAAQ,WAAaA,EAAQ,MAAS,IAAM,MACrD,QAASK,GAAWL,EAAQ,KAAO,EAAI,EAEvC,WAAaA,EAAQ,OAASA,EAAQ,cAChC,yBACA,mEAGV,OACIlB,OAACc,GAAe,SAAf,CAAwB,MAAO,CAAE,YAAAoB,EAAa,YAAAY,EAAa,iBAAAC,CAAA,EACvD,UAAA9B,EACAwC,sBACI,OAAI,IAAKhC,EAAY,MAAO+B,EACxB,WAAQ,MACLvD,MAACyD,GAAA,CACG,KAAMxC,EAAQ,KACd,SAAUA,EAAQ,SAClB,gBAAiBA,EAAQ,gBACzB,UAAWA,EAAQ,UACnB,WAAYA,EAAQ,WACpB,QAASA,EAAQ,QACjB,yBAA0BA,EAAQ,iBAClC,YAAa,GACb,OAAQ,GACR,UAAWA,EAAQ,UACnB,aAAcA,EAAQ,aACtB,oBAAqBA,EAAQ,sBAGzC,EACA,SAAS,KACb,EACJ,CAER,CAEO,SAASyC,IAAa,CACzB,MAAM5K,EAAU6K,aAAW9C,EAAc,EACzC,GAAI,CAAC/H,EACD,MAAM,IAAI,MAAM,gDAAgD,EAEpE,OAAOA,CACX,CClPO,MAAM8K,GAAiB,CAE5B,QAAS,CACP,cAAe,UACf,cAAe,WACf,UAAW,WACX,SAAU,WACV,SAAU,WACV,QAAS,WACT,gBAAiB,WACjB,UAAW,WACX,qBAAsB,WACtB,QAAS,WACT,eAAgB,UAChB,eAAgB,WAChB,uBAAwB,WACxB,QAAS,WACT,cAAe,WACf,WAAY,WACZ,SAAU,WACV,YAAa,WACb,gBAAiB,WACjB,YAAa,WACb,eAAgB,WAChB,OAAQ,WACR,YAAa,UACb,aAAc,WACd,UAAW,WACX,eAAgB,WAChB,YAAa,WACb,mBAAoB,WACpB,aAAc,SACd,mBAAoB,UACpB,2BAA4B,WAC5B,kBAAmB,WACnB,SAAU,WACV,cAAe,WACf,MAAO,WACP,aAAc,WACd,eAAgB,WAChB,MAAO,WACP,gBAAiB,WACjB,iBAAkB,WAClB,eAAgB,WAChB,cAAe,WACf,iBAAkB,UAClB,WAAY,UACZ,YAAa,WACb,YAAa,WACb,oBAAqB,WACrB,4BAA6B,WAC7B,sBAAuB,WACvB,gBAAiB,WACjB,YAAa,WACb,UAAW,WACX,WAAY,WACZ,UAAW,YAIb,OAAQ,CACN,cAAe,UACf,SAAU,WACV,iBAAkB,WAClB,WAAY,WACZ,aAAc,WACd,YAAa,WACb,UAAW,WACX,sBAAuB,WACvB,eAAgB,WAChB,cAAe,UACf,YAAa,WACb,SAAU,WACV,QAAS,WACT,oBAAqB,UACrB,eAAgB,SAChB,YAAa,WACb,SAAU,WACV,cAAe,WACf,eAAgB,WAChB,WAAY,WACZ,mBAAoB,WACpB,OAAQ,UACR,YAAa,WACb,eAAgB,WAChB,eAAgB,WAChB,UAAW,WACX,cAAe,WACf,gBAAiB,SACjB,mBAAoB,UACpB,WAAY,WACZ,eAAgB,WAChB,gBAAiB,WACjB,WAAY,WACZ,QAAS,WACT,SAAU,WACV,SAAU,WACV,QAAS,WACT,aAAc,WACd,kBAAmB,WACnB,iBAAkB,UAClB,cAAe,UACf,WAAY,WACZ,eAAgB,WAChB,WAAY,WACZ,aAAc,WACd,SAAU,WACV,cAAe,WACf,SAAU,WACV,gBAAiB,WACjB,eAAgB,WAChB,YAAa,WACb,aAAc,WACd,SAAU,YAIZ,MAAO,CACL,QAAS,WACT,YAAa,WACb,OAAQ,WACR,MAAO,WACP,aAAc,WACd,oBAAqB,UACrB,eAAgB,SAChB,iBAAkB,WAClB,YAAa,WACb,eAAgB,WAChB,YAAa,WACb,cAAe,WACf,OAAQ,WACR,iBAAkB,WAClB,kBAAmB,WACnB,oBAAqB,WACrB,SAAU,WACV,WAAY,WACZ,aAAc,WACd,gBAAiB,UACjB,iBAAkB,WAClB,YAAa,WACb,eAAgB,WAChB,MAAO,WACP,eAAgB,WAChB,oBAAqB,WACrB,4BAA6B,WAC7B,WAAY,WACZ,eAAgB,WAChB,UAAW,WACX,eAAgB,WAChB,WAAY,WACZ,kBAAmB,WACnB,iBAAkB,WAClB,YAAa,WACb,UAAW,WAEf,EAGaC,GAAqB,CAChC,qBAAsB,WACtB,eAAgB,WAChB,UAAW,WACX,cAAe,WACf,aAAc,UACd,cAAe,WACf,WAAY,WACZ,sBAAuB,WACvB,gBAAiB,WACjB,oBAAqB,WACrB,4BAA6B,WAC7B,mBAAoB,WACpB,aAAc,WACd,gBAAiB,WACjB,iBAAkB,WAClB,qBAAsB,WACtB,sBAAuB,WACvB,iBAAkB,WAClB,YAAa,WACb,eAAgB,WAChB,aAAc,WACd,aAAc,WACd,iBAAkB,WAClB,sBAAuB,WACvB,eAAgB,WAChB,mBAAoB,WACpB,gBAAiB,WACjB,cAAe,WACf,0BAA2B,WAC3B,aAAc,WACd,kBAAmB,WACnB,eAAgB,WAChB,2BAA4B,WAC5B,eAAgB,WAChB,mBAAoB,WACpB,cAAe,WACf,oBAAqB,WACrB,WAAY,WACZ,WAAY,WACZ,aAAc,WACd,kBAAmB,WACnB,eAAgB,WAChB,aAAc,WACd,4BAA6B,WAC7B,gBAAiB,WACjB,mBAAoB,WACpB,SAAU,UACZ,EAGaC,GAAsB,CACjC,WAAY,WACZ,eAAgB,WAChB,eAAgB,WAChB,iBAAkB,WAClB,cAAe,WACf,YAAa,WACb,aAAc,WACd,oBAAqB,WACrB,mBAAoB,WACpB,eAAgB,WAChB,UAAW,WACX,UAAW,WACX,cAAe,WACf,kBAAmB,WACnB,iBAAkB,WAClB,YAAa,WACb,mBAAoB,WACpB,cAAe,WACf,kBAAmB,WACnB,gBAAiB,WACjB,YAAa,WACb,gBAAiB,WACjB,eAAgB,WAChB,wBAAyB,WACzB,iBAAkB,WAClB,WAAY,WACZ,WAAY,WACZ,eAAgB,WAChB,YAAa,WACb,sBAAuB,WACvB,YAAa,WACb,eAAgB,WAChB,WAAY,WACZ,eAAgB,WAChB,uBAAwB,WACxB,kBAAmB,WACnB,aAAc,WACd,aAAc,WACd,mBAAoB,WACpB,kBAAmB,WACnB,UAAW,WACX,YAAa,WACb,eAAgB,WAChB,sBAAuB,WACvB,iBAAkB,WAClB,eAAgB,WAChB,eAAgB,WAChB,aAAc,WACd,OAAQ,UACV,EAGaC,GAAuB,CAClC,UAAW,WACX,gBAAiB,WACjB,gBAAiB,WACjB,wBAAyB,WACzB,uBAAwB,WACxB,WAAY,WACZ,cAAe,WACf,eAAgB,WAChB,kBAAmB,WACnB,iBAAkB,WAClB,kBAAmB,WACnB,YAAa,WACb,eAAgB,WAChB,qBAAsB,WACtB,eAAgB,WAChB,gBAAiB,WACjB,mBAAoB,WACpB,eAAgB,WAChB,kBAAmB,WACnB,kBAAmB,WACnB,yBAA0B,WAC1B,YAAa,WACb,cAAe,WACf,aAAc,WACd,iBAAkB,WAClB,gBAAiB,WACjB,kBAAmB,WACnB,iBAAkB,WAClB,gBAAiB,WACjB,aAAc,WACd,iBAAkB,WAClB,iBAAkB,WAClB,uBAAwB,WACxB,UAAW,WACX,eAAgB,WAChB,KAAM,WACN,kBAAmB,WACnB,mBAAoB,WACpB,WAAY,WACZ,SAAU,WACV,mBAAoB,WACpB,aAAc,WACd,iBAAkB,WAClB,qBAAsB,WACtB,cAAe,WACf,wBAAyB,WACzB,kBAAmB,WACnB,OAAQ,UACV,EAGaC,EAAkB,CAC7B,KAAM,CACJ,MAAO,CACL,MAAO,CACL,aAAc,WACd,gBAAiB,WACjB,iBAAkB,YAEpB,QAAS,CACP,QAAS,WACT,sBAAuB,WACvB,kBAAmB,WACnB,YAAa,YAEf,SAAU,CACR,WAAY,WACZ,SAAU,WACV,OAAQ,WACR,WAAY,WACZ,QAAS,WACT,SAAU,WACV,MAAO,YAET,MAAO,CACL,aAAc,WACd,YAAa,YAEf,gBAAiB,CACf,mBAAoB,WACpB,gBAAiB,YAEnB,MAAO,CACL,UAAW,WACX,YAAa,WACb,cAAe,WACjB,EAEF,OAAQ,CACN,MAAO,CACL,gBAAiB,WACjB,0BAA2B,WAC3B,oBAAqB,YAEvB,QAAS,CACP,gBAAiB,UACjB,eAAgB,UAChB,oBAAqB,UACrB,aAAc,WAEhB,SAAU,CACR,QAAS,WACT,SAAU,WACV,OAAQ,WACR,WAAY,WACZ,SAAU,WACV,MAAO,WACP,WAAY,YAEd,MAAO,CACL,WAAY,YAEd,gBAAiB,CACf,gBAAiB,WACjB,eAAgB,YAElB,MAAO,CACL,UAAW,SACX,YAAa,SACb,YAAa,SACb,MAAO,EACT,EAEF,QAAS,CACP,MAAO,CACL,iBAAkB,WAClB,oBAAqB,WACrB,UAAW,YAEb,QAAS,CACP,iBAAkB,WAClB,cAAe,WACf,sBAAuB,YAEzB,SAAU,CACR,OAAQ,WACR,WAAY,WACZ,QAAS,WACT,SAAU,WACV,WAAY,WACZ,MAAO,WACP,SAAU,YAEZ,MAAO,CACL,mBAAoB,YAEtB,gBAAiB,CACf,aAAc,WACd,gBAAiB,YAEnB,MAAO,CACL,YAAa,WACb,aAAc,WACd,eAAgB,WAChB,MAAO,WACT,EAEF,UAAW,CACT,iBAAkB,WAClB,iBAAkB,WAClB,oBAAqB,WACrB,gBAAiB,WACjB,kBAAmB,WACnB,kBAAmB,WACnB,iBAAkB,WAClB,iBAAkB,WAClB,oBAAqB,WACrB,oBAAqB,WACrB,iBAAkB,WAClB,oBAAqB,WACrB,kBAAmB,WACnB,mBAAoB,WACpB,kBAAmB,WACnB,kBAAmB,WACrB,EAGF,MAAO,CACL,MAAO,CACL,MAAO,CACL,cAAe,WACf,aAAc,YAEhB,QAAS,CACP,aAAc,WACd,eAAgB,WAChB,aAAc,YAEhB,SAAU,CACR,SAAU,WACV,OAAQ,WACR,WAAY,WACZ,SAAU,WACV,MAAO,WACP,MAAO,WACP,SAAU,WACV,QAAS,YAEX,MAAO,CACL,gBAAiB,UACjB,cAAe,WAEjB,gBAAiB,CACf,mBAAoB,WACpB,gBAAiB,YAEnB,MAAO,CACL,UAAW,WACX,YAAa,WACb,cAAe,WACjB,EAEF,OAAQ,CACN,MAAO,CACL,oBAAqB,UACrB,oBAAqB,UACrB,cAAe,WAEjB,QAAS,CACP,cAAe,WACf,aAAc,WACd,iBAAkB,YAEpB,SAAU,CACR,WAAY,WACZ,SAAU,WACV,MAAO,WACP,MAAO,WACP,SAAU,WACV,QAAS,WACT,SAAU,WACV,OAAQ,YAEV,MAAO,CACL,YAAa,WACb,wBAAyB,WACzB,kBAAmB,WACnB,0BAA2B,YAE7B,gBAAiB,CACf,gBAAiB,WACjB,eAAgB,WAChB,eAAgB,YAElB,MAAO,CACL,UAAW,WACX,YAAa,WACb,YAAa,WACf,EAEF,QAAS,CACP,MAAO,CACL,SAAU,WACV,iBAAkB,WAClB,cAAe,YAEjB,QAAS,CACP,WAAY,SACZ,YAAa,SACb,eAAgB,SAChB,QAAS,UAEX,SAAU,CACR,QAAS,WACT,MAAO,WACP,SAAU,WACV,MAAO,WACP,OAAQ,WACR,WAAY,WACZ,SAAU,WACV,SAAU,YAEZ,MAAO,CACL,iBAAkB,WAClB,eAAgB,YAElB,gBAAiB,CACf,aAAc,WACd,gBAAiB,WACjB,aAAc,YAEhB,MAAO,CACL,YAAa,WACb,aAAc,WACd,eAAgB,WAClB,EAEF,UAAW,CACT,oBAAqB,UACrB,iBAAkB,WAClB,cAAe,UACf,iBAAkB,WAClB,kBAAmB,UACnB,qBAAsB,UACtB,eAAgB,UAChB,kBAAmB,UACnB,iBAAkB,UAClB,mBAAoB,UACpB,oBAAqB,UACrB,gBAAiB,UACjB,kBAAmB,WACnB,eAAgB,WAChB,gBAAiB,WACjB,eAAgB,WAClB,EAGF,IAAK,CACH,MAAO,CACL,MAAO,CACL,eAAgB,UAChB,aAAc,WAEhB,QAAS,CACP,iBAAkB,WAClB,WAAY,WACZ,SAAU,YAEZ,SAAU,CACR,MAAO,WACP,MAAO,WACP,KAAM,UACN,UAAW,WACX,UAAW,WACX,KAAM,WACN,QAAS,YAEX,MAAO,CACL,eAAgB,WAChB,eAAgB,WAChB,YAAa,YAEf,gBAAiB,CACf,mBAAoB,UACpB,gBAAiB,UACjB,SAAU,YAEZ,MAAO,CACL,UAAW,WACX,YAAa,WACb,cAAe,WACjB,EAEF,OAAQ,CACN,MAAO,CACL,UAAW,WACX,gBAAiB,WACjB,YAAa,YAEf,QAAS,CACP,WAAY,WACZ,eAAgB,WAChB,eAAgB,WAChB,UAAW,YAEb,SAAU,CACR,KAAM,UACN,KAAM,WACN,MAAO,WACP,QAAS,WACT,MAAO,WACP,UAAW,WACX,UAAW,YAEb,MAAO,CACL,iBAAkB,WAClB,kBAAmB,YAErB,gBAAiB,CACf,gBAAiB,WACjB,eAAgB,YAElB,MAAO,CACL,UAAW,SACX,YAAa,SACb,YAAa,SACb,MAAO,SACT,EAEF,QAAS,CACP,MAAO,CACL,YAAa,WACb,YAAa,YAEf,QAAS,CACP,SAAU,WACV,mBAAoB,WACpB,gBAAiB,YAEnB,SAAU,CACR,MAAO,WACP,MAAO,WACP,QAAS,WACT,UAAW,WACX,UAAW,WACX,KAAM,UACN,KAAM,YAER,MAAO,CACL,gBAAiB,WACjB,eAAgB,YAElB,gBAAiB,CACf,aAAc,WACd,gBAAiB,YAEnB,MAAO,CACL,YAAa,WACb,aAAc,WACd,eAAgB,WAChB,MAAO,WACT,EAEF,UAAW,CACT,eAAgB,WAChB,cAAe,WACf,mBAAoB,WACpB,eAAgB,WAChB,mBAAoB,WACpB,mBAAoB,WACpB,eAAgB,WAChB,oBAAqB,WACrB,eAAgB,WAChB,kBAAmB,WACnB,oBAAqB,WACrB,kBAAmB,WACnB,iBAAkB,WAClB,mBAAoB,WACpB,kBAAmB,WACnB,kBAAmB,WACrB,EAGF,OAAQ,CACN,MAAO,CACL,MAAO,CACL,cAAe,YAEjB,QAAS,CACP,UAAW,WACX,iBAAkB,WAClB,kBAAmB,WACnB,cAAe,YAEjB,SAAU,CACR,QAAS,QACT,UAAW,QACX,SAAU,SAEZ,MAAO,CACL,cAAe,YAEjB,gBAAiB,CACf,mBAAoB,WACpB,gBAAiB,YAEnB,MAAO,CACL,UAAW,UACX,YAAa,UACb,cAAe,UACjB,EAEF,OAAQ,CACN,MAAO,CACL,mBAAoB,YAEtB,QAAS,CACP,YAAa,WACb,eAAgB,WAChB,aAAc,WACd,gBAAiB,YAEnB,SAAU,CACR,QAAS,QACT,UAAW,QACX,SAAU,SAEZ,MAAO,CACL,gBAAiB,YAEnB,gBAAiB,CACf,gBAAiB,WACjB,eAAgB,YAElB,MAAO,CACL,UAAW,WACX,YAAa,WACb,YAAa,WACf,EAEF,QAAS,CACP,MAAO,CACL,cAAe,YAEjB,QAAS,CACP,eAAgB,UAChB,cAAe,WACf,WAAY,UACZ,gBAAiB,YAEnB,SAAU,CACR,QAAS,QACT,UAAW,QACX,SAAU,SAEZ,MAAO,CACL,gBAAiB,YAEnB,gBAAiB,CACf,aAAc,WACd,gBAAiB,YAEnB,MAAO,CACL,YAAa,UACb,aAAc,UACd,eAAgB,UAClB,EAEF,UAAW,CACT,mBAAoB,WACpB,oBAAqB,WACrB,sBAAuB,WACvB,mBAAoB,WACpB,iBAAkB,WAClB,kBAAmB,WACnB,kBAAmB,UACnB,mBAAoB,UACpB,qBAAsB,UACtB,mBAAoB,UACpB,sBAAuB,WACvB,mBAAoB,WACpB,kBAAmB,WACnB,gBAAiB,WACjB,oBAAqB,WACrB,iBAAkB,WACpB,EAGF,OAAQ,CACN,MAAO,CACL,MAAO,CACL,UAAW,YAEb,QAAS,CACP,cAAe,UACf,aAAc,UACd,cAAe,UACf,gBAAiB,WAEnB,SAAU,CACR,QAAS,WACT,WAAY,WACZ,QAAS,YAEX,MAAO,CACL,eAAgB,YAElB,gBAAiB,CACf,mBAAoB,UACpB,gBAAiB,WAEnB,MAAO,CACL,UAAW,WACX,YAAa,WACb,cAAe,WACjB,EAEF,OAAQ,CACN,MAAO,CACL,WAAY,YAEd,QAAS,CACP,eAAgB,WAChB,YAAa,WACb,iBAAkB,WAClB,mBAAoB,YAEtB,SAAU,CACR,QAAS,WACT,WAAY,WACZ,QAAS,YAEX,MAAO,CACL,eAAgB,YAElB,gBAAiB,CACf,gBAAiB,WACjB,eAAgB,YAElB,MAAO,CACL,UAAW,WACX,YAAa,WACb,YAAa,WACf,EAEF,QAAS,CACP,MAAO,CACL,YAAa,YAEf,QAAS,CACP,aAAc,UACd,oBAAqB,UACrB,aAAc,UACd,UAAW,WAEb,SAAU,CACR,WAAY,WACZ,QAAS,WACT,QAAS,YAEX,MAAO,CACL,cAAe,YAEjB,gBAAiB,CACf,aAAc,UACd,gBAAiB,WAEnB,MAAO,CACL,YAAa,WACb,aAAc,WACd,eAAgB,WAClB,EAEF,UAAW,CACT,eAAgB,WAChB,eAAgB,WAChB,iBAAkB,WAClB,mBAAoB,WACpB,kBAAmB,WACnB,iBAAkB,WAClB,kBAAmB,WACnB,wBAAyB,WACzB,sBAAuB,WACvB,oBAAqB,WACrB,oBAAqB,WACrB,kBAAmB,WACnB,qBAAsB,WACtB,qBAAsB,WACxB,EAGF,UAAW,CACT,MAAO,CACL,cAAe,WACf,MAAO,CACL,iBAAkB,WAClB,cAAe,WACf,aAAc,WACd,UAAW,WACX,cAAe,YAEjB,QAAS,CACP,SAAU,WACV,YAAa,WACb,aAAc,WACd,aAAc,WACd,cAAe,YAEjB,MAAO,CACL,aAAc,WACd,YAAa,WACb,eAAgB,WAChB,cAAe,WACf,cAAe,YAEjB,SAAU,CACR,QAAS,UACT,QAAS,WACT,SAAU,WACV,MAAO,WACP,WAAY,WAEZ,SAAU,WACV,MAAO,WACP,QAAS,WACT,OAAQ,WACR,SAAU,WACV,WAAY,WACZ,MAAO,WACP,KAAM,UACN,UAAW,WACX,UAAW,WACX,KAAM,WAEN,OAAQ,WACR,WAAY,WACZ,SAAU,WACV,MAAO,WACP,MAAO,WACP,SAAU,WACV,QAAS,YAEX,gBAAiB,CACf,mBAAoB,WACpB,gBAAiB,WACjB,SAAU,YAEZ,MAAO,CACL,UAAW,UACX,YAAa,UACb,cAAe,UACjB,EAEF,OAAQ,CACN,cAAe,WACf,MAAO,CACL,YAAa,WACb,oBAAqB,WACrB,mBAAoB,WACpB,WAAY,WACZ,SAAU,WACV,oBAAqB,YAEvB,QAAS,CACP,oBAAqB,WACrB,iBAAkB,WAClB,eAAgB,WAChB,iBAAkB,WAClB,UAAW,YAEb,MAAO,CACL,iBAAkB,WAClB,eAAgB,WAChB,gBAAiB,WACjB,WAAY,WACZ,YAAa,YAEf,SAAU,CACR,SAAU,UACV,MAAO,WACP,UAAW,WACX,QAAS,WACT,QAAS,WAET,SAAU,WACV,MAAO,WACP,QAAS,WACT,OAAQ,WACR,WAAY,WACZ,WAAY,WAEZ,OAAQ,WACR,WAAY,WACZ,SAAU,WACV,MAAO,WACP,SAAU,WACV,SAAU,WACV,QAAS,WAET,MAAO,WACP,MAAO,WACP,KAAM,UACN,UAAW,WACX,UAAW,WACX,KAAM,WAEN,QAAS,QACT,QAAS,WACT,WAAY,YAEd,gBAAiB,CACf,gBAAiB,WACjB,eAAgB,WAChB,eAAgB,WAChB,qBAAsB,YAExB,MAAO,CACL,UAAW,WACX,YAAa,WACb,YAAa,WACb,MAAO,WACT,EAEF,QAAS,CACP,cAAe,WACf,MAAO,CACL,cAAe,WACf,YAAa,WACb,cAAe,WACf,oBAAqB,WACrB,YAAa,YAEf,QAAS,CACP,cAAe,UACf,cAAe,UACf,QAAS,UACT,gBAAiB,UACjB,aAAc,WAEhB,MAAO,CACL,iBAAkB,WAClB,gBAAiB,WACjB,cAAe,WACf,mBAAoB,WACpB,gBAAiB,YAEnB,SAAU,CACR,MAAO,WACP,QAAS,WACT,SAAU,WACV,WAAY,WACZ,OAAQ,YAEV,gBAAiB,CACf,aAAc,WACd,gBAAiB,WACjB,aAAc,YAEhB,MAAO,CACL,YAAa,WACb,aAAc,WACd,eAAgB,WAChB,MAAO,WACT,EAEF,UAAW,CACT,cAAe,WACf,cAAe,WACf,oBAAqB,WACrB,cAAe,UACf,iBAAkB,UAClB,iBAAkB,WAClB,mBAAoB,UACpB,iBAAkB,WAClB,iBAAkB,UAClB,kBAAmB,UACnB,iBAAkB,UAClB,kBAAmB,SACnB,kBAAmB,WACnB,mBAAoB,UACpB,oBAAqB,WACrB,eAAgB,WAChB,eAAgB,UAChB,iBAAkB,WAClB,iBAAkB,UAClB,kBAAmB,WACnB,mBAAoB,UACtB,CAEJ,EAGaC,GAAe,CAwB1B,aAAc,UAShB,EAIaC,GAAmD,CAE9D,UAAW,UACX,WAAY,UACZ,SAAU,UACV,WAAY,UACZ,WAAY,UAGZ,WAAY,WACZ,UAAW,WACX,WAAY,WACZ,WAAY,WACZ,WAAY,WAGZ,WAAY,WACZ,WAAY,WACZ,WAAY,WACZ,WAAY,WACZ,UAAW,UACb,EAI+D,OAAO,QAAQA,EAAwB,EAAE,OAAO,CAACxS,EAAK,CAACyS,EAAKC,CAAK,KAC9H1S,EAAI0S,CAAK,EAAI,OAAOD,CAAG,EAChBzS,GACN,EAA4B,ECvoCxB,SAAS2S,GAAa,CAAE,KAAAjgB,EAAM,SAAArD,EAAU,QAAAujB,EAAS,aAAAC,EAAc,aAAAC,EAAc,UAAAxa,GAAgC,CAChH,MAAMG,EAAMsa,UAAQ,IAAM7W,EAAgB,QAAQxJ,CAAI,EAAG,CAACA,CAAI,CAAC,EAE/D,GAAI,CAAC+F,EAAK,OAAO6V,MAAC,OAAI,UAAU,uCAAuC,EAEvE,MAAM0E,EAAUva,EAAI,mBAAmB,KAAOiV,GAAajV,EAAI,kBAAkB,IAAI,EAAI,GACnFmB,EAAWnB,EAAI,WAAW,UAAY,EACtCwa,EAAYrZ,IAAa,EAAI,SAAWA,IAAa,EAAI,YAAcA,IAAa,EAAI,OAAS,SAGjGsZ,EAAsBxF,GAAajV,EAAI,gBAAgB,EACvD0a,EAAmBzF,GAAajV,EAAI,aAAa,EACjD2a,EAAsB1F,GAAajV,EAAI,gBAAgB,EAGvD4a,EAAoB5a,EAAI,cACxB6a,EAAoB7a,EAAI,sBACxB8a,EAAqB,CAACD,GAAqB,CAAC,CAACD,GAAsBrgB,GAAgByF,EAAI,SAAS,cAAc,EAC9G+a,EAAe9F,GAAa4F,GAAqBD,CAAiB,EAGlEI,EAAe,CAAC,EAAEpkB,GAAU,OAAUA,EAAS,MAAQ,GACvDqkB,EAAY,CAAC,EAAErkB,GAAU,OAAUA,EAAS,MAAQ,GACpDskB,EAAa,CAAC,EAAED,GAAarkB,GAAU,UAAYA,EAAS,UAAY,GACxEukB,EAAWnb,EAAI,WAAa,EAElC,OACI4V,OAAC,OACG,UAAW,kCAAkC4E,CAAS,IAAIQ,EAAe,6BAA+B,EAAE,IAAInb,GAAa,EAAE,GAC7H,QAAAsa,EACA,aAAAC,EACA,aAAAC,EAGE,WAAAK,GAAoBD,GAAuBE,IACzC/E,OAAC,OAAI,UAAU,yBACV,UAAA8E,GAAoB7E,MAAC,OAAI,IAAK6E,EAAkB,UAAU,+BAA+B,IAAI,GAAG,MAAO,CAAE,OAAQ,EAAE,CAAG,EACtHD,GAAuB5E,MAAC,OAAI,IAAK4E,EAAqB,UAAU,+BAA+B,IAAI,GAAG,MAAO,CAAE,OAAQ,EAAE,CAAG,EAC5HE,GAAuB9E,MAAC,OAAI,IAAK8E,EAAqB,UAAU,+BAA+B,IAAI,GAAG,MAAO,CAAE,OAAQ,EAAE,CAAG,GACjI,EAIJ/E,OAAC,OAAI,UAAU,uBACX,UAAAC,MAAC,OAAI,IAAK0E,EAAS,IAAKva,EAAI,mBAAmB,KAAM,UAAU,sBAAsB,EAGpF+a,GACGlF,MAAC,OACG,IAAKkF,EACL,UAAW,6BAA6BD,EAAoB,oCAAsC,qCAAqC,GACvI,IAAI,MAKT9a,EAAI,WAAa,GAAOA,EAAI,WAAa,GAAKmB,IAAa,IAC1D0U,MAACU,GAAA,CAAU,KAAM3f,GAAU,UAAY,EAAG,EAI7CukB,IAAaF,GAAaC,IACvBtF,OAAC,OAAI,UAAU,yBACV,UAAAqF,SAAc,OAAI,IAAKhG,GAAa,qDAAqD,EAAG,IAAI,UAAU,EAC1GiG,SAAe,OAAI,IAAKjG,GAAa,sDAAsD,EAAG,IAAI,WAAW,GAClH,GAER,EAGCre,GAAU,MAAQ,GACfif,MAAC,OAAI,UAAU,wBACX,SAAAA,MAAC,QAAK,UAAU,8BAA+B,SAAAjf,EAAS,MAAM,EAClE,IAIhB,CCnEA,MAAMwkB,GAAkD,CACpD,WAAY,SACZ,WAAY,OACZ,SAAU,QACV,SAAU,OACV,WAAY,WAChB,EAYaC,GAAephB,GAAiB,CACzC,MAAM+F,EAAMyD,EAAgB,QAAQxJ,CAAI,EACxC,GAAI,CAAC+F,EAAK,MAAO,QAEjB,MAAM1F,GAAQ0F,EAAI,mBAAmB,MAAQ,IAAI,cAC3Csb,GAAWtb,EAAI,MAAM,wBAA0B,IAAI,cACnD/B,GAAe+B,EAAI,mBAAmB,aAAe,IAAI,cACzDub,GAAYvb,EAAI,qBAAuB,IAAI,cAGjD,OAAI1F,EAAK,SAAS,YAAY,GAAKA,EAAK,SAAS,UAAU,GACvDA,EAAK,SAAS,cAAc,GAAKA,EAAK,SAAS,gBAAgB,GAC/DA,EAAK,SAAS,QAAQ,GAAK2D,EAAY,SAAS,cAAc,GAC9D3D,EAAK,SAAS,YAAY,GAAKghB,EAAQ,SAAS,YAAY,GAC5DhhB,EAAK,SAAS,YAAY,GAAKA,EAAK,SAAS,gBAAgB,EACtD,SAIPA,EAAK,SAAS,UAAU,GAAKA,EAAK,SAAS,OAAO,GAClDA,EAAK,SAAS,kBAAkB,GAAKA,EAAK,SAAS,UAAU,GAC7DA,EAAK,SAAS,cAAc,GAAKA,EAAK,SAAS,iBAAiB,EACzD,QAIPA,EAAK,SAAS,YAAY,GAAKA,EAAK,SAAS,SAAS,GACtDA,EAAK,SAAS,WAAW,GAAKA,EAAK,SAAS,QAAQ,GACpDA,EAAK,SAAS,uBAAuB,GAAKA,EAAK,SAAS,aAAa,GACrEA,EAAK,SAAS,mBAAmB,EAC1B,UAIPA,EAAK,SAAS,WAAW,GAAKA,EAAK,SAAS,OAAO,GACnDA,EAAK,SAAS,iBAAiB,GAAKA,EAAK,SAAS,UAAU,GAC5DA,EAAK,SAAS,QAAQ,GAAKA,EAAK,SAAS,gBAAgB,EAClD,QAIPA,EAAK,SAAS,UAAU,GAAKA,EAAK,SAAS,OAAO,GAClDA,EAAK,SAAS,SAAS,GAAKA,EAAK,SAAS,QAAQ,GAClDA,EAAK,SAAS,cAAc,EACrB,QAIPA,EAAK,SAAS,QAAQ,GAAKA,EAAK,SAAS,WAAW,GACpDA,EAAK,SAAS,WAAW,GAAKA,EAAK,SAAS,SAAS,GACrDA,EAAK,SAAS,OAAO,GAAKA,EAAK,SAAS,WAAW,GACnDA,EAAK,SAAS,aAAa,GAAKihB,EAAS,SAAS,QAAQ,GAC1DA,EAAS,SAAS,WAAW,GAAKjhB,EAAK,SAAS,KAAK,GACrDA,EAAK,SAAS,QAAQ,GAAKA,EAAK,SAAS,QAAQ,GACjDA,EAAK,SAAS,UAAU,EACjB,SAGJ,OACX,EASO,SAASkhB,GAAeC,EAI7B,CACE,IAAIC,EAA0B,KAC1BC,EAA+B,KACnC,MAAMC,EAAmB,GAKzB,OAFqB,MAAM,KAAK,IAAI,IAAIH,CAAS,CAAC,EAErC,QAAQxhB,GAAQ,CACzB,MAAM+F,EAAMyD,EAAgB,QAAQxJ,CAAI,EACxC,GAAI,CAAC+F,EAAK,OAEV,MAAM8E,GAAO9E,EAAI,MAAM,wBAA0B,IAAI,cAC/C1F,GAAQ0F,EAAI,mBAAmB,MAAQ,IAAI,cAC3Cub,GAAYvb,EAAI,qBAAuB,IAAI,cAG9B8E,EAAI,SAAS,QAAQ,GAAKA,EAAI,SAAS,YAAY,GAAKA,EAAI,SAAS,UAAU,GAC9FA,EAAI,SAAS,OAAO,GAAKyW,EAAS,SAAS,QAAQ,GAAKA,EAAS,SAAS,UAAU,IAIpFzW,EAAI,SAAS,aAAa,GAAK,CAACA,EAAI,SAAS,UAAU,EAClD4W,EACAE,EAAO,KAAK3hB,CAAI,EADNyhB,EAAWzhB,EAIrB6K,EAAI,SAAS,UAAU,GAAKxK,EAAK,SAAS,SAAS,GAAKwK,EAAI,SAAS,QAAQ,EAC7E6W,EACAC,EAAO,KAAK3hB,CAAI,EADD0hB,EAAgB1hB,EAKpC2hB,EAAO,KAAK3hB,CAAI,EAExB,CAAC,EAGD2hB,EAAO,KAAK,CAAC1d,EAAG5E,IAAM,CAClB,MAAMuiB,EAASpY,EAAgB,QAAQvF,CAAC,GAAW,mBAAmB,MAAM,eAAiB,GACvF4d,EAASrY,EAAgB,QAAQnK,CAAC,GAAW,mBAAmB,MAAM,eAAiB,GAC7F,OAAOuiB,EAAM,cAAcC,CAAK,CACpC,CAAC,EAEM,CAAE,SAAAJ,EAAU,cAAAC,EAAe,OAAAC,CAAA,CACtC,CAMO,SAASG,GACZzkB,EACA0kB,EACqF,CACrF,MAAMC,EAAiC,CACnC,OAAQ,GACR,KAAM,GACN,MAAO,GACP,KAAM,GACN,UAAW,GACX,QAAS,EAAC,EAGRC,EAAuB,CACzB,OAAQ,GACR,KAAM,GACN,MAAO,GACP,KAAM,GACN,UAAW,GACX,QAAS,EAAC,EAGRC,EAA8B,CAChC,OAAQ,GACR,MAAO,GACP,QAAS,GACT,MAAO,GACP,MAAO,GACP,OAAQ,GACR,MAAO,EAAC,EAINC,MAAiB,IACnB9kB,EAAQ,YAAY,MACpBA,EAAQ,WAAW,KAAK,QAAQoN,GAAK0X,EAAW,IAAI1X,GAAI0X,EAAW,IAAI1X,CAAC,GAAK,GAAK,CAAC,CAAC,EAGxF,MAAM2X,MAAoB,IAGpBC,EAAwC,CAC1C,OAAQ,EACR,KAAM,EACN,MAAO,EACP,KAAM,EACN,UAAW,GAGTC,EAAW,CAACtiB,EAAcP,EAAclD,IAAyB,CACnE6lB,EAAc,IAAIpiB,GAAOoiB,EAAc,IAAIpiB,CAAI,GAAK,GAAK,CAAC,EAC1D,MAAM+F,EAAMyD,EAAgB,QAAQxJ,CAAI,EAClCqhB,GAAWtb,GAAK,MAAM,wBAA0B,IAAI,cACpDub,GAAYvb,GAAK,qBAAuB,IAAI,cAE5Cwc,EAAWlB,EAAQ,SAAS,QAAQ,GAAKC,EAAS,SAAS,QAAQ,GAAK/kB,IAAgB,EACxFimB,EAAanB,EAAQ,SAAS,UAAU,GAAKA,EAAQ,SAAS,YAAY,GAAKA,EAAQ,SAAS,OAAO,GAAKC,EAAS,SAAS,UAAU,GAAK/kB,IAAgB,EAE7JkmB,EACFpB,EAAQ,SAAS,cAAc,GAC/BA,EAAQ,SAAS,aAAa,GAC9BA,EAAQ,SAAS,YAAY,EAajC,GAVI,EAAAA,EAAQ,SAAS,WAAW,GAC5BA,EAAQ,SAAS,SAAS,GAC1BA,EAAQ,SAAS,WAAW,GAC5BA,EAAQ,SAAS,QAAQ,GACzBA,EAAQ,SAAS,gBAAgB,GACjCC,EAAS,SAAS,UAAU,GAC5BA,EAAS,SAAS,QAAQ,GAC1Bvb,GAAK,oBAAoB,SAAS,UAAU,GAC5CA,GAAK,oBAAoB,SAAS,SAAS,GAI/C,IAAKwc,GAAYC,IAAe,CAACC,EAAe,CAC5C,MAAMC,EAAYV,EAAuBviB,CAAI,EACzCijB,IACIH,IAAmB,OAASviB,EACvBwiB,MAAqB,SAAWxiB,GAEjD,KAAO,CACFiiB,EAAkBxiB,CAAI,GAAG,KAAKO,CAAI,EAC/BqiB,EAAc5iB,CAAI,IAAM,QACxB4iB,EAAc5iB,CAAI,IAGtB,MAAMkjB,EAAQvB,GAAYphB,CAAI,EAC9BkiB,EAAWS,CAA8B,EAAE,KAAK3iB,CAAI,CACxD,CACJ,EAGM4iB,EAAiB5iB,GAAiB,CACpC,MAAM+F,EAAMyD,EAAgB,QAAQxJ,CAAI,EACxC,GAAI,CAAC+F,EAAK,MAAO,GACjB,MAAMsb,GAAWtb,EAAI,MAAM,wBAA0B,IAAI,cACnDub,GAAYvb,EAAI,qBAAuB,IAAI,cAC3C1F,GAAQ0F,EAAI,mBAAmB,MAAQA,GAAK,MAAQ,IAAI,cAG9D,OAAIsb,EAAQ,SAAS,QAAQ,GAAKA,EAAQ,SAAS,YAAY,GAAKA,EAAQ,SAAS,UAAU,GAC3FA,EAAQ,SAAS,OAAO,GAAKC,EAAS,SAAS,QAAQ,GAAKA,EAAS,SAAS,UAAU,EACjF,GAIPD,EAAQ,SAAS,aAAa,GAAKA,EAAQ,SAAS,UAAU,GAC9DhhB,EAAK,SAAS,YAAY,GAAKA,EAAK,SAAS,UAAU,GACvDA,EAAK,SAAS,YAAY,GAAKA,EAAK,SAAS,UAAU,GACvDA,EAAK,SAAS,WAAW,GAAKA,EAAK,SAAS,UAAU,GACtDA,IAAS,aAAeA,IAAS,oBACjCA,EAAK,SAAS,KAAK,GAAKA,EAAK,SAAS,QAAQ,GAK9CghB,EAAQ,SAAS,UAAU,GAAKA,EAAQ,SAAS,UAAU,EAAU,IAGrEA,EAAQ,SAAS,MAAM,GAAKA,EAAQ,SAAS,QAAQ,GACrDA,EAAQ,SAAS,MAAM,GAAKA,EAAQ,SAAS,WAAW,GACxDA,EAAQ,SAAS,OAAO,GAAKA,EAAQ,SAAS,OAAO,GAAKA,EAAQ,SAAS,MAAM,GACjFA,EAAQ,SAAS,MAAM,GAAKA,EAAQ,SAAS,OAAO,GACpDA,EAAQ,SAAS,OAAO,GAAKA,EAAQ,SAAS,OAAO,GAAKA,EAAQ,SAAS,MAAM,GAAKA,EAAQ,SAAS,MAAM,EACtG,GAIf,EAEMwB,EAA+B,GAyBrC,GAtBA,OAAO,QAAQd,CAAK,EAAE,QAAQ,CAAC,CAACtiB,EAAM7D,CAAI,IAAM,CACxCA,GAAQA,EAAK,iBACb,OAAO,QAAQA,EAAK,eAAe,EAAE,QAAQ,CAAC,CAACknB,EAAQ9iB,CAAI,IAAM,CAC7D,MAAMoM,EAAU,OAAOpM,CAAI,EACrBmL,EAAM,SAAS2X,CAAM,EAC3B,GAAI1W,GAAWA,IAAY,WAAY,CACnC,MAAMrG,EAAMyD,EAAgB,QAAQ4C,CAAO,EACvCrG,IAAQA,EAAI,WAAa,GAAKA,EAAI,WAAa,IAAMA,EAAI,WAAa,IAAMA,EAAI,WAAa,IAAMA,EAAI,MAAM,0BACzG6c,EAAcxW,CAAO,GACrByW,EAAmB,KAAKzW,CAAO,EAE/BgW,EAAc,IAAIhW,GAAUgW,EAAc,IAAIhW,CAAO,GAAK,GAAK,CAAC,GAEhEkW,EAASlW,EAAS3M,EAAM0L,CAAG,EAGvC,CACJ,CAAC,CAET,CAAC,EAGG9N,EAAQ,YAAY,aACpB,SAAW,CAAC0lB,EAAWrZ,CAAI,IAAK,OAAO,QAAQrM,EAAQ,WAAW,YAAY,EAAG,CAC7E,MAAMgS,EAAa,SAAS0T,CAAS,EAC/BtjB,EAAO0hB,GAAe9R,CAAU,EAClC,MAAM,QAAQ3F,CAAI,GAClBA,EAAK,QAAQ1J,GAAQ,CACb4iB,EAAc5iB,CAAI,GAClB6iB,EAAmB,KAAK7iB,CAAI,EAC5BoiB,EAAc,IAAIpiB,GAAOoiB,EAAc,IAAIpiB,CAAI,GAAK,GAAK,CAAC,GAE1DsiB,EAAStiB,EAAMP,GAAQ,SAAS,CAExC,CAAC,CAET,CAIJ,MAAMujB,EAAa,CAAC,SAAU,OAAQ,QAAS,OAAQ,WAAW,EAClE,OAAAH,EAAmB,QAAQ7iB,GAAQ,CAE/B,IAAIijB,EAAW,UACXC,EAAU,IAEd,UAAWC,KAAYH,EACdjB,EAAMoB,CAAQ,GAGfd,EAAcc,CAAQ,EAAID,IAC1BA,EAAUb,EAAcc,CAAQ,EAChCF,EAAWE,GAKlBlB,EAAkBgB,CAAQ,GAAG,KAAKjjB,CAAI,EACnCqiB,EAAcY,CAAQ,IAAM,UAAyBA,CAAQ,IACjE,MAAMN,EAAQvB,GAAYphB,CAAI,EAC9BkiB,EAAWS,CAA8B,EAAE,KAAK3iB,CAAI,CACxD,CAAC,EAGDmiB,EAAW,QAAQ,CAACiB,EAAMpjB,IAAS,CAC/B,MAAMqjB,EAAUjB,EAAc,IAAIpiB,CAAI,GAAK,EACrCsjB,EAAYF,EAAOC,EAEzB,GAAIC,GAAa,EAAG,OAEpB,MAAMvd,EAAMyD,EAAgB,QAAQxJ,CAAI,EACxC,GAAI,CAAC+F,EAAK,CACN,QAAShR,EAAI,EAAGA,EAAIuuB,EAAWvuB,IAAKutB,EAAStiB,EAAM,SAAS,EAC5D,MACJ,CAEA,IAAIujB,EAAa,UACjB,GAAI,CAACX,EAAc5iB,CAAI,EAAG,CACtB,MAAMqhB,GAAWtb,EAAI,MAAM,wBAA0B,IAAI,cACrDsb,EAAQ,SAAS,MAAM,GAAKA,EAAQ,SAAS,QAAQ,EAAGkC,EAAa,SAChElC,EAAQ,SAAS,MAAM,GAAKA,EAAQ,SAAS,WAAW,EAAGkC,EAAa,OACxElC,EAAQ,SAAS,OAAO,GAAKA,EAAQ,SAAS,OAAO,GAAKA,EAAQ,SAAS,MAAM,EAAGkC,EAAa,QACjGlC,EAAQ,SAAS,MAAM,GAAKA,EAAQ,SAAS,OAAO,EAAGkC,EAAa,QACpElC,EAAQ,SAAS,OAAO,GAAKA,EAAQ,SAAS,OAAO,GAAKA,EAAQ,SAAS,MAAM,KAAGkC,EAAa,YAC9G,CAEA,GAAIA,IAAe,UACf,QAASxuB,EAAI,EAAGA,EAAIuuB,EAAWvuB,IAAKutB,EAAStiB,EAAMujB,CAAU,MAE7D,SAASxuB,EAAI,EAAGA,EAAIuuB,EAAWvuB,IAAK,CAChC,IAAIkuB,EAAW,UACXC,EAAU,IAEd,UAAWC,KAAYH,EACdjB,EAAMoB,CAAQ,GACfd,EAAcc,CAAQ,EAAID,IAC1BA,EAAUb,EAAcc,CAAQ,EAChCF,EAAWE,GAGnBb,EAAStiB,EAAMijB,CAAQ,CAC3B,CAER,CAAC,EAEM,CAAE,UAAAhB,EAAW,eAAAD,EAAgB,WAAAE,CAAA,CACxC,CCjWA,IAAIsB,GAAuB,KAEpB,SAASC,IAA0B,CACtC,OAAO,KAAK,UAAUD,GAAiB,KAAM,CAAC,CAClD,CAGA,MAAME,GAAwB,WAQ9B,SAASC,GACLC,EACkC,CAClC,MAAMC,EAAmD,GAGnDC,EAA2B,GACjC,IAAIC,EAAyB,GACzBC,EAAiB,GAErB,UAAW5X,KAAWwX,EACdxX,IAAYsX,IACZM,EAAiB,GACbD,EAAa,OAAS,IACtBD,EAAa,KAAK,CAAC,GAAGC,CAAY,CAAC,EACnCA,EAAe,KAGnBA,EAAa,KAAK3X,CAAO,EAWjC,GANI2X,EAAa,OAAS,GACtBD,EAAa,KAAK,CAAC,GAAGC,CAAY,CAAC,EAKnC,CAACC,GAAkBF,EAAa,QAAU,EAC1C,MAAO,GAIX,MAAM1H,EAAe,CACjB9oB,EAAc,OACdA,EAAc,UACdA,EAAc,YACdA,EAAc,UACdA,EAAc,aAIlB,QAASyB,EAAI,EAAGA,EAAI+uB,EAAa,QAAU/uB,EAAIqnB,EAAa,OAAQrnB,IAAK,CACrE,MAAMsa,EAAa+M,EAAarnB,CAAC,EAC3B2U,EAAOoa,EAAa/uB,CAAC,EAEvB2U,EAAK,OAAS,IACdma,EAAaxU,CAAU,EAAI3F,EAEnC,CAGA,OAAOma,CACX,CAOA,eAAsBI,GAAiBxrB,EAA+C,CAClF,GAAI,CAIA,MAAMyrB,EAAoBzrB,EAAI,MAAM,qBAAqB,EACzD,GAAIyrB,EAAmB,CACnB,MAAMC,EAAcD,EAAkB,CAAC,EACjCE,EAAO,mBAAmBD,CAAW,EAErC9mB,EAAU,KAAK,MAAM+mB,CAAI,EAG/B,GAAI,CAAC/mB,EAAQ,MAAQA,EAAQ,YAAc,QAAa,CAACA,EAAQ,SAC7D,MAAM,IAAI,MAAM,yCAAyC,EAI7D,GAAIA,EAAQ,YAAY,MAAQA,EAAQ,WAAW,KAAK,OAAS,EAAG,CAChE,MAAMgnB,EAAaV,GAA6BtmB,EAAQ,WAAW,IAAI,EACvE,GAAI,CAACA,EAAQ,WAAW,aACpBA,EAAQ,WAAW,aAAegnB,MAElC,UAAW,CAAChV,EAAY3F,CAAI,IAAK,OAAO,QAAQ2a,CAAU,EAAG,CACzD,MAAM7f,EAAS,SAAS6K,CAAU,EAC5BiV,EAAWjnB,EAAQ,WAAW,aAAamH,CAAM,GAAK,GAC5DnH,EAAQ,WAAW,aAAamH,CAAM,EAAI,CAAC,GAAG8f,EAAU,GAAG5a,CAAI,CACnE,CAER,CAEA,OAAOrM,CACX,CAKA,GADyB5E,EAAI,MAAM,gGAAgG,EAE/H,MAAM,IAAI,MACN;AAAA;AAAA;AAAA;AAAA,uDAUR,MAAM8rB,EAAc9rB,EAAI,MAAM,uBAAuB,EACrD,GAAI8rB,EAAa,CACb,MAAMC,EAAUD,EAAY,CAAC,EAC7B,QAAQ,IAAI,sCAAuCC,CAAO,EAI1D,MAAMC,EAAW,0BAA0BD,CAAO,GAElD,QAAQ,IAAI,iDAAkDA,CAAO,EACrE,MAAM5rB,EAAW,MAAM,MAAM6rB,CAAQ,EAErC,GAAI,CAAC7rB,EAAS,GAAI,CAEd,MAAM8rB,EAAY,MAAM9rB,EAAS,OACjC,cAAQ,MAAM,sCAAuC8rB,CAAS,EACxD,IAAI,MAAM,6CAA6C9rB,EAAS,MAAM,IAAI,CACpF,CAEA,MAAM+rB,EAAe,MAAM/rB,EAAS,OACpC,IAAIrH,EACJ,GAAI,CACAA,EAAO,KAAK,MAAMozB,CAAY,CAClC,MAAY,CACR,cAAQ,MAAM,oDAAqDA,CAAY,EACzE,IAAI,MAAM,kEAAkE,CACtF,CAKA,GAHAnB,GAAkBjyB,EAClB,QAAQ,IAAI,kCAAmC,KAAK,UAAUA,EAAM,KAAM,CAAC,CAAC,EAExE,CAACA,EAAK,QACN,MAAM,IAAI,MAAM,mCAAmC,EAIvD,MAAM8L,EAAU9L,EAAK,QACrB,GAAI8L,EAAQ,YAAY,MAAQA,EAAQ,WAAW,KAAK,OAAS,EAAG,CAChE,MAAMgnB,EAAaV,GAA6BtmB,EAAQ,WAAW,IAAI,EAGvE,GAAI,CAACA,EAAQ,WAAW,aACpBA,EAAQ,WAAW,aAAegnB,MAElC,UAAW,CAAChV,EAAY3F,CAAI,IAAK,OAAO,QAAQ2a,CAAU,EAAG,CACzD,MAAM7f,EAAS,SAAS6K,CAAU,EAC5BiV,EAAWjnB,EAAQ,WAAW,aAAamH,CAAM,GAAK,GAC5DnH,EAAQ,WAAW,aAAamH,CAAM,EAAI,CAAC,GAAG8f,EAAU,GAAG5a,CAAI,CACnE,CAGJ,QAAQ,IAAI,qDAAsDrM,EAAQ,WAAW,YAAY,CACrG,CAEA,eAAQ,IAAI,kDAAmD9L,EAAK,QAAQ,IAAI,EACzE8L,CACX,CAKA,MAAMunB,EAAQnsB,EAAI,MAAM,gCAAgC,EACxD,GAAI,CAACmsB,EACD,MAAInsB,EAAI,SAAS,UAAU,EACjB,IAAI,MAAM,uFAAuF,EAErG,IAAI,MAAM,yDAAyD,EAI7E,MAAMzD,EAAS4vB,EAAM,CAAC,EAAE,QAAQ,KAAM,GAAG,EAAE,QAAQ,KAAM,GAAG,EACtDC,EAAe,KAAK7vB,CAAM,EAG1BH,EAAQ,IAAI,WAAWgwB,EAAa,MAAM,EAChD,QAAS9vB,EAAI,EAAGA,EAAI8vB,EAAa,OAAQ9vB,IACrCF,EAAME,CAAC,EAAI8vB,EAAa,WAAW9vB,CAAC,EAIxC,IAAI+vB,EAGJ,GAAIjwB,EAAM,CAAC,IAAM,IAAQA,EAAM,CAAC,IAAM,IAGlCiwB,EADqBC,GAAK,OAAOlwB,EAAO,CAAE,GAAI,SAAU,UAInDA,EAAM,CAAC,IAAM,IAGlBiwB,EADqBC,GAAK,QAAQlwB,EAAO,CAAE,GAAI,SAAU,MAKzD,IAAI,CAEAiwB,EADqBC,GAAK,WAAWlwB,EAAO,CAAE,GAAI,SAAU,CAEhE,MAAY,CAERiwB,EAAUD,CACd,CAIJ,MAAMG,EAAUF,EAAQ,QAAQ,OAAQ,EAAE,EAE1C,IAAIznB,EAGJ,GAAI2nB,EAAQ,SAAS,IAAM,GAAK,CAACA,EAAQ,WAAW,GAAG,GAAK,CAACA,EAAQ,WAAW,GAAG,EAAG,CAElF,MAAMC,EAAUD,EAAQ,QAAQ,IAAM,EAChC3kB,EAAO2kB,EAAQ,UAAU,EAAGC,CAAO,EACnCziB,EAAYwiB,EAAQ,WAAWC,EAAU,CAAC,EAG1CC,EAAiBF,EAAQ,QAAQ,IAAQC,EAAU,CAAC,EAOpDE,GANeD,EAAiB,EAChCF,EAAQ,UAAUC,EAAU,EAAGC,CAAc,EAC7CF,EAAQ,UAAUC,EAAU,CAAC,GAGJ,MAAM,GAAG,EAAE,UAAYte,CAAC,EAC5B,IAAIye,GAAW,CACtC,MAAMC,EAAQD,EAAQ,MAAM,GAAG,EACzBplB,EAAO,SAASqlB,EAAM,CAAC,EAAG,EAAE,EAC5BC,EAA0C,GAGhD,QAASvwB,GAAI,EAAGA,GAAIswB,EAAM,OAAQtwB,KAAK,CACnC,KAAM,CAAC+tB,EAAQyC,CAAO,EAAIF,EAAMtwB,EAAC,EAAE,MAAM,GAAG,EACxC+tB,GAAUyC,IACVD,EAAgB,SAASxC,EAAQ,EAAE,CAAC,EAAI,SAASyC,EAAS,EAAE,EAEpE,CAEA,MAAO,CAAE,KAAAvlB,EAAM,gBAAAslB,CAAA,CACnB,CAAC,EAGD,IAAIE,EACJ,GAAIN,EAAiB,EAAG,CACpB,MAAMO,EAAeT,EAAQ,UAAUE,EAAiB,CAAC,EACzDM,EAAa,CACT,KAAM,GACN,aAAc,GACd,gBAAiB,QAIrB,MAAME,EAAoC,GACzBD,EAAa,MAAM,GAAG,EAC9B,QAAQE,GAAO,CACpB,GAAIA,EAAI,SAAS,GAAG,EAAG,CACnB,MAAMN,GAAQM,EAAI,MAAM,GAAG,EACrBpzB,EAAM8yB,GAAM,CAAC,EACbO,EAAMP,GAAM,MAAM,CAAC,EAAE,KAAK,GAAG,EAC/B9yB,GAAOqzB,IAAKF,EAAUnzB,CAAG,EAAIqzB,EACrC,CACJ,CAAC,EAGGF,EAAU,IACVF,EAAW,KAAOE,EAAU,EAAE,MAAM,GAAG,EAAE,IAAIjb,GAAK,SAASA,EAAG,EAAE,CAAC,GAIjEib,EAAU,GACKA,EAAU,EAAE,MAAM,GAAG,EAC7B,QAAQG,IAAS,CACpB,MAAMR,EAAQQ,GAAM,MAAM,GAAG,EAC7B,GAAIR,EAAM,SAAW,EAAG,CACpB,MAAMhW,EAAa,SAASgW,EAAM,CAAC,EAAG,EAAE,EAClC3b,EAAO2b,EAAM,CAAC,EAAE,MAAM,GAAG,EAAE,IAAI5a,GAAK,SAASA,EAAG,EAAE,CAAC,EACzD+a,EAAW,aAAanW,CAAU,EAAI3F,CAC1C,CACJ,CAAC,EAIDgc,EAAU,IACVF,EAAW,gBAAkB,SAASE,EAAU,EAAG,EAAE,GAIrDA,EAAU,IACVF,EAAW,cAAgBE,EAAU,EAAE,MAAM,GAAG,EAAE,IAAIjb,GAAK,SAASA,EAAG,EAAE,CAAC,EAElF,CAEApN,EAAU,CACN,GAAI,YAAY,KAAK,KAAK,GAC1B,KAAAgD,EACA,UAAAmC,EACA,SAAA2iB,EACA,WAAAK,EACA,OAAQ,YAEhB,KAAO,CAEH,MAAMM,EAAS,KAAK,MAAMd,CAAO,EAGjC,GAAI,MAAM,QAAQc,CAAM,GAAK,OAAOA,EAAO,CAAC,GAAM,UAAY,OAAOA,EAAO,CAAC,GAAM,SAAU,CAEzF,MAAMzlB,EAAOylB,EAAO,CAAC,EACftjB,EAAYsjB,EAAO,CAAC,EAG1B,IAAIC,EAAYD,EAAO,QAAQ,KAAM,CAAC,EAClCC,IAAc,KAAIA,EAAYD,EAAO,QAIzC,MAAMX,EADYW,EAAO,MAAM,EAAGC,CAAS,EAChB,IAAKnqB,GAAc,CAC1C,GAAI,OAAOA,GAAS,SAChB,MAAO,CAAE,KAAMA,EAAM,gBAAiB,EAAC,EAC3C,GAAW,MAAM,QAAQA,CAAI,EAAG,CAC5B,MAAMoE,EAAOpE,EAAK,CAAC,EACb0pB,EAA0C,GAEhD,QAASvwB,EAAI,EAAGA,EAAI6G,EAAK,OAAQ7G,GAAK,EAClCuwB,EAAgB1pB,EAAK7G,CAAC,CAAC,EAAI6G,EAAK7G,EAAI,CAAC,EAEzC,MAAO,CAAE,KAAAiL,EAAM,gBAAAslB,CAAA,CACnB,CACA,MAAO,CAAE,KAAM1pB,EAAM,gBAAiB,EAAC,CAC3C,CAAC,EAGD,IAAI4pB,EACJ,GAAIO,EAAYD,EAAO,OAAS,EAAG,CAC/B,MAAME,EAAaF,EAAO,MAAMC,EAAY,CAAC,EAC7CP,EAAa,CACT,KAAM,MAAM,QAAQQ,EAAW,CAAC,CAAC,EAAIA,EAAW,CAAC,EAAI,GACrD,aAAc,OAAOA,EAAW,CAAC,GAAM,UAAY,CAAC,MAAM,QAAQA,EAAW,CAAC,CAAC,EAAIA,EAAW,CAAC,EAAI,GACnG,gBAAiB,OAAOA,EAAW,CAAC,GAAM,SAAWA,EAAW,CAAC,EAAI,OACrE,cAAe,MAAM,QAAQA,EAAW,CAAC,CAAC,EAAIA,EAAW,CAAC,EAAI,EAAC,CAEvE,CAEA3oB,EAAU,CACN,GAAI,YAAY,KAAK,KAAK,GAC1B,KAAAgD,EACA,UAAAmC,EACA,SAAA2iB,EACA,WAAAK,CAAA,CAER,MAAW,MAAM,QAAQM,CAAM,GAAKA,EAAO,QAAU,GAAK,CAACA,EAAO,CAAC,EAAE,eAAe,QAAQ,EAExFzoB,EAAU,CACN,GAAI,YAAY,KAAK,KAAK,GAC1B,KAAMyoB,EAAO,CAAC,EACd,UAAWA,EAAO,CAAC,EACnB,SAAUA,EAAO,CAAC,EAAE,IAAKlqB,GAAc,CACnC,GAAI,MAAM,QAAQA,CAAI,EAAG,CACrB,MAAMoE,EAAOpE,EAAK,CAAC,EACbqqB,EAAcrqB,EAAK,CAAC,EACpB0pB,EAA0C,GAEhD,GAAIW,EACA,QAASlxB,EAAI,EAAGA,EAAIkxB,EAAY,OAAQlxB,GAAK,EACzCuwB,EAAgBW,EAAYlxB,CAAC,CAAC,EAAIkxB,EAAYlxB,EAAI,CAAC,EAI3D,MAAO,CAAE,KAAAiL,EAAM,gBAAiB,OAAO,KAAKslB,CAAe,EAAE,OAAS,EAAIA,EAAkB,EAAC,CACjG,CACA,MAAO,CAAE,KAAM1pB,EAAM,gBAAiB,EAAC,CAC3C,CAAC,EACD,WAAYkqB,EAAO,CAAC,EAAI,CACpB,KAAMA,EAAO,CAAC,EAAE,GAAK,GACrB,aAAcA,EAAO,CAAC,EAAE,IAAM,GAC9B,gBAAiBA,EAAO,CAAC,EAAE,GAC3B,cAAeA,EAAO,CAAC,EAAE,IAAM,EAAC,EAChC,QAEDA,EAAO,IAAM,QAAaA,EAAO,IAAM,QAAaA,EAAO,IAAM,OAExEzoB,EAAU,CACN,GAAI,YAAY,KAAK,KAAK,GAC1B,KAAMyoB,EAAO,EACb,UAAWA,EAAO,EAClB,SAAUA,EAAO,EAAE,IAAKlqB,IAAe,CACnC,KAAMA,EAAK,EACX,gBAAiBA,EAAK,GAAK,EAAC,EAC9B,EACF,WAAYkqB,EAAO,EAAI,CACnB,KAAMA,EAAO,EAAE,GAAK,GACpB,aAAcA,EAAO,EAAE,IAAM,GAC7B,gBAAiBA,EAAO,EAAE,GAC1B,cAAeA,EAAO,EAAE,IAAM,EAAC,EAC/B,QAIRzoB,EAAUyoB,CAElB,CAGA,GAAI,CAACzoB,EAAQ,MAAQA,EAAQ,YAAc,QAAa,CAACA,EAAQ,SAC7D,MAAM,IAAI,MAAM,yCAAyC,EAI7D,OAAIA,GAAW,CAACA,EAAQ,SACpBA,EAAQ,OAAS,OAGdA,CACX,OAASnJ,EAAO,CACZ,MAAIA,aAAiB,MACXA,EAEJ,IAAI,MAAM,8BAA8B,CAClD,CACJ,CAMO,SAASgyB,GAAsB7oB,EAAmC,CACrE,GAAI,CAIA,IAAIvI,EAAS,GAGb,MAAMqxB,EAAY9oB,EAAQ,KAAK,UAAU,EAAG,EAAE,EAoB9C,GAnBAvI,GAAUqxB,EAAY,KAGtBrxB,GAAU,OAAO,aAAauI,EAAQ,SAAS,EAG/CA,EAAQ,SAAS,QAAQ,CAACzB,EAAM7G,IAAM,CAC9BA,EAAI,IAAGD,GAAU,KACrBA,GAAU8G,EAAK,KAAK,SAAS,EAAE,EAE/B,MAAMoR,EAAUpR,EAAK,gBACjBoR,GAAW,OAAO,KAAKA,CAAO,EAAE,OAAS,GACzC,OAAO,QAAQA,CAAO,EAAE,QAAQ,CAAC,CAAC7B,EAAKnL,CAAI,IAAM,CAC7ClL,GAAU,IAAM,SAASqW,CAAG,EAAE,SAAS,EAAE,EAAI,IAAOnL,EAAgB,SAAS,EAAE,CACnF,CAAC,CAET,CAAC,EAGG3C,EAAQ,aAEHA,EAAQ,WAAW,MAAQA,EAAQ,WAAW,KAAK,OAAS,GAC5DA,EAAQ,WAAW,cAAgB,OAAO,KAAKA,EAAQ,WAAW,YAAY,EAAE,OAAS,GAC1FA,EAAQ,WAAW,iBAER,CAQX,GAPAvI,GAAU,IAGNuI,EAAQ,WAAW,MAAQA,EAAQ,WAAW,KAAK,OAAS,IAC5DvI,GAAU,MAAMuI,EAAQ,WAAW,KAAK,IAAI+W,GAAKA,EAAE,SAAS,EAAE,CAAC,EAAE,KAAK,GAAG,CAAC,IAG1E/W,EAAQ,WAAW,cAAgB,OAAO,KAAKA,EAAQ,WAAW,YAAY,EAAE,OAAS,EAAG,CAC5F,MAAM+oB,EAAgB,OAAO,QAAQ/oB,EAAQ,WAAW,YAAY,EAC/D,IAAI,CAAC,CAACmH,EAAQkF,CAAI,IAAM,CACrB,MAAM2c,EAAW,SAAS7hB,CAAM,EAAE,SAAS,EAAE,EACvC8hB,EAAU5c,EAAkB,IAAI0K,GAAKA,EAAE,SAAS,EAAE,CAAC,EAAE,KAAK,GAAG,EACnE,MAAO,GAAGiS,CAAQ,IAAIC,CAAM,EAChC,CAAC,EACLxxB,GAAU,MAAMsxB,EAAc,KAAK,GAAG,CAAC,EAC3C,CAEI/oB,EAAQ,WAAW,kBACnBvI,GAAU,MAAMuI,EAAQ,WAAW,gBAAgB,SAAS,EAAE,CAAC,IAG/DA,EAAQ,WAAW,eAAiBA,EAAQ,WAAW,cAAc,OAAS,IAC9EvI,GAAU,MAAMuI,EAAQ,WAAW,cAAc,IAAIsJ,GAAKA,EAAE,SAAS,EAAE,CAAC,EAAE,KAAK,GAAG,CAAC,GAE3F,CAIJ,MAAMpV,EADU,IAAI,cACC,OAAOuD,CAAM,EAG5ByxB,EAAaxB,GAAK,QAAQxzB,EAAM,CAAE,MAAO,EAAG,WAAY,GAAI,EAG5DyD,EAAS,KAAK,OAAO,aAAa,GAAGuxB,CAAU,CAAC,EACjD,QAAQ,MAAO,GAAG,EAClB,QAAQ,MAAO,GAAG,EAClB,QAAQ,KAAM,EAAE,EAGrB,MAAO,GADQ,OAAO,OAAW,IAAc,OAAO,SAAS,OAAS,0BACxD,YAAYvxB,CAAM,EACtC,OAASd,EAAO,CACZ,MAAMA,CACV,CACJ,CAMO,SAASsyB,GAA0BnpB,EAAmC,CACzE,GAAI,CACA,MAAMopB,EAAe,CACjB,GAAIppB,EAAQ,GACZ,KAAMA,EAAQ,KACd,UAAWA,EAAQ,UACnB,SAAUA,EAAQ,SAClB,WAAYA,EAAQ,YAAc,GAClC,WAAYA,EAAQ,WACpB,MAAOA,EAAQ,MACf,eAAgB,EAChB,KAAM,KACN,OAAQ,aAGN+mB,EAAO,KAAK,UAAUqC,CAAY,EAGxC,MAAO,uDAFS,mBAAmBrC,CAAI,CAE8B,EACzE,OAASlwB,EAAO,CACZ,MAAMA,CACV,CACJ,CA2MO,SAASwyB,GAAuBrpB,EAA0C,CAG7E,MAAMspB,EAAetpB,EAAQ,SAAS,KAAKtI,GAAK,CAC5C,MAAMgR,EAAMyD,EAAgB,QAAQzU,EAAE,IAAI,EAE1C,OAAOgR,GAAK,WAAa,IAAMA,GAAK,WAAW,iBAAmBzS,EAAc,QACpF,CAAC,EAGD,IAAIszB,EAAiB,QACrB,GAAID,EAAc,CACd,MAAME,EAASrd,EAAgB,QAAQmd,EAAa,IAAI,EAClDlkB,EAAaokB,GAAQ,YAAY,eAAiBA,GAAQ,mBAAqB,EAUrFD,EAT8C,CAC1C,EAAG,UACH,EAAG,MACH,EAAG,QACH,EAAG,OACH,EAAG,SACH,EAAG,SACH,EAAG,aAEwBnkB,CAAU,GAAK,OAClD,CAEA,MAAMqkB,EAAezpB,EAAQ,SAAS,KAAKtI,GAAK,CAC5C,MAAMgR,EAAMyD,EAAgB,QAAQzU,EAAE,IAAI,EAC1C,OAAOgR,GAAK,WAAa,GAAKA,EAAI,WAAa,CACnD,CAAC,EAEKghB,EAAc1pB,EAAQ,SAAS,KAAKtI,GAAK,CAC3C,MAAMgR,EAAMyD,EAAgB,QAAQzU,EAAE,IAAI,EAC1C,OAAOgR,GAAK,WAAa,GAAKA,EAAI,WAAa,CACnD,CAAC,EAGK8L,EAAkD,CACpD,aAAc8U,GAAc,KAC5B,UAAW,EACX,QAAS,GACT,UAAW,GACX,YAAa,EACb,UAAW,EACX,iBAAkB,GAGtB,GAAIA,GAAgBA,EAAa,gBAAiB,CAC9C,MAAME,EAASrd,EAAgB,QAAQmd,EAAa,IAAI,EACxD,GAAIE,GAAUA,EAAO,QAAS,CAC1B,MAAMG,EAAqBrxB,IACVkxB,EAAO,QAAQ,kBAAoBA,EAAO,QAAQ,aAClD,KAAM7rB,GAAWA,EAAE,cAAc,SAASrF,CAAK,CAAC,GAAG,mBAGpE,SAAW,CAACsxB,EAAUzqB,CAAQ,IAAK,OAAO,QAAQmqB,EAAa,eAAe,EAAG,CAC7E,MAAMhxB,EAAQ,SAASsxB,CAAQ,EACzBjnB,EAAOxD,EACP0qB,EAAUF,EAAkBrxB,CAAK,EACjCkW,EAAUrC,EAAgB,QAAQxJ,CAAI,EAE5C,GAAIknB,IAAYzzB,GAAuB,MAAOoe,EAAe,UAAY7R,UAChEknB,IAAYzzB,GAAuB,WACxC,GAAIoY,EAAS,CACT,MAAMpV,EAAMoV,EAAgB,MAAM,wBAA0B,GACxDpV,EAAG,SAAS,iBAAiB,IAAkB,iBAAmBuJ,EAC7DvJ,EAAG,SAAS,UAAU,IAAkB,YAAcuJ,EACtDvJ,EAAG,SAAS,OAAO,IAAkB,UAAYuJ,EACjD6L,EAAQ,WAAa,KAAIgG,EAAe,UAAY7R,EACjE,UAEKknB,IAAYzzB,GAAuB,QAASoe,EAAe,SAAS,KAAK7R,CAAI,UAC7EknB,IAAYzzB,GAAuB,UAAWoe,EAAe,WAAW,KAAK7R,CAAI,UAEjF6L,EAAS,CACd,MAAMpV,EAAMoV,EAAgB,MAAM,wBAA0B,GACxDpV,EAAG,SAAS,SAAS,EAAGob,EAAe,SAAS,KAAK7R,CAAI,EACpDvJ,EAAG,SAAS,WAAW,EAAGob,EAAe,WAAW,KAAK7R,CAAI,EAC7DvJ,EAAG,SAAS,OAAO,MAAkB,UAAYuJ,EAC9D,CACJ,CACJ,CACJ,CAGA,MAAMgC,EAAgC,GACtC,UAAWpG,KAAQyB,EAAQ,SAAU,CAEjC,GAAIzB,EAAK,OAASkrB,GAAc,MAAQlrB,EAAK,OAASmrB,GAAa,MAAQnrB,EAAK,OAAS+qB,GAAc,KAAM,SAE7G,MAAM5gB,EAAMyD,EAAgB,QAAQ5N,EAAK,IAAI,EACzCmK,EACA/D,EAAM,KAAK,CAAE,KAAMpG,EAAK,KAAM,KAAMmK,EAAI,KAAM,gBAAiBnK,EAAK,gBAAiB,EAErFoG,EAAM,KAAK,CAAE,KAAMpG,EAAK,KAAM,KAAM,UAAW,gBAAiBA,EAAK,gBAAiB,CAE9F,CAEA,MAAO,CACH,GAAIyB,EAAQ,IAAM,YAAY,KAAK,KAAK,GACxC,KAAMA,EAAQ,MAAQ,mBACtB,QAASupB,EACT,cAAevpB,EAAQ,UACvB,aAAc,CACV,KAAMypB,GAAc,MAAQ,EAC5B,KAAM,UACN,KAAM,GAEV,YAAa,CACT,KAAMC,GAAa,MAAQ,EAC3B,KAAM,UACN,KAAM,GAEV,eAAAlV,EACA,UAAWxU,EAAQ,YAAY,MAAQ,GACvC,cAAeA,EAAQ,YAAY,eAAiB,GACpD,MAAA2E,EACA,UAAW,6BACX,WAAY,eAEpB,CAKO,SAASmlB,GAA+B3wB,EAAwC,CACnF,MAAM2uB,EAA0B,GAI1BiC,EAA+C,CAEjD,QAAS,WACT,UAAW,WACX,SAAU,WACV,WAAY,UACZ,WAAY,UACZ,cAAe,WAEf,QAAS,WACT,UAAW,WACX,SAAU,WACV,WAAY,UACZ,WAAY,WACZ,cAAe,WAEf,QAAS,WACT,UAAW,WACX,SAAU,WACV,WAAY,WACZ,WAAY,WACZ,cAAe,YAIf5wB,EAAM,cAAc,MAAQA,EAAM,aAAa,KAAO,GACtD2uB,EAAS,KAAK,CACV,KAAM3uB,EAAM,aAAa,KACzB,gBAAkBA,EAAM,aAAqB,iBAAmB,EAAC,CACpE,EAIDA,EAAM,aAAa,MAAQA,EAAM,YAAY,KAAO,GACpD2uB,EAAS,KAAK,CACV,KAAM3uB,EAAM,YAAY,KACxB,gBAAiBA,EAAM,YAAY,iBAAmB,EAAC,CAC1D,EAIDA,EAAM,OACNA,EAAM,MAAM,QAAQoF,GAAQupB,EAAS,KAAK,CAAE,KAAMvpB,EAAK,KAAM,gBAAiBA,EAAK,iBAAmB,EAAC,CAAG,CAAC,EAI/G,MAAMyrB,EAAa,OAAO7wB,EAAM,SAAY,SACtCA,EAAM,QAAQ,OAAO,CAAC,EAAE,cAAgBA,EAAM,QAAQ,MAAM,CAAC,EAAE,cAC/D,OAAOA,EAAM,OAAO,EACpB8wB,EAAoB,GAAG9wB,EAAM,aAAa,IAAI6wB,CAAU,GACxDE,EAAe/wB,EAAM,gBAAgB,cAAgB4wB,EAAqBE,CAAiB,GAAK,EAEtG,GAAIC,EAAc,CACd,MAAMC,EAA4C,GAC5CX,EAASrd,EAAgB,QAAQ+d,CAAY,EAEnD,GAAIV,GAAQ,SAAS,iBAAkB,CACnC,MAAMlc,EAAeC,GACVA,EAAe,QAAQH,GAAK,CAC/B,MAAMI,EAAMgc,EAAO,QAAQ,iBAAiB,KAAM7rB,GAAWA,EAAE,qBAAuByP,CAAC,EACvF,OAAOI,EAAMA,EAAI,cAAgB,EACrC,CAAC,EAAE,KAAK,CAAC5G,EAAG5E,IAAM4E,EAAI5E,CAAC,EAGrB0M,EAAgBpB,EAAY,CAC9BlX,GAAuB,QACvBA,GAAuB,cACvBA,GAAuB,iBACvBA,GAAuB,gBAC1B,EAEKuY,EAAkBrB,EAAY,CAChClX,GAAuB,UACvBA,GAAuB,gBACvBA,GAAuB,mBACvBA,GAAuB,kBAC1B,EAEKg0B,EAAe9c,EAAY,CAAClX,GAAuB,KAAK,CAAC,EAG3D+C,EAAM,gBAAgB,WAAaixB,EAAa,OAAS,IACzDD,EAAkBC,EAAa,CAAC,CAAC,EAAIjxB,EAAM,eAAe,WAI1DA,EAAM,gBAAgB,SACtBA,EAAM,eAAe,QAAQ,QAAQ,CAACwJ,EAAMjL,IAAM,CAC1CiL,GAAQjL,EAAIgX,EAAc,WAA0BA,EAAchX,CAAC,CAAC,EAAIiL,EAChF,CAAC,EAIDxJ,EAAM,gBAAgB,WACtBA,EAAM,eAAe,UAAU,QAAQ,CAACwJ,EAAMjL,IAAM,CAC5CiL,GAAQjL,EAAIiX,EAAgB,WAA0BA,EAAgBjX,CAAC,CAAC,EAAIiL,EACpF,CAAC,EAKL,MAAMwL,EAAiBb,EAAY,CAC/BlX,GAAuB,UACvBA,GAAuB,gBAC1B,EAEyB,CACtB+C,EAAM,gBAAgB,iBACtBA,EAAM,gBAAgB,UACtBA,EAAM,gBAAgB,aACxB,OAAO,OAAO,EAEE,QAAQkxB,GAAe,CACrC,MAAM7b,EAAUrC,EAAgB,QAAQke,CAAW,EACnD,GAAI,CAAC7b,EAAS,OAGd,MAAMF,EAAcH,EAAe,KAAKjP,GAAe,CAEnD,GAAIirB,EAAkBjrB,CAAW,EAAG,MAAO,GAG3C,MAAMorB,EAAcd,EAAO,QAAQ,cAActqB,CAAW,EAC5D,GAAI,CAACorB,EAAa,MAAO,GAEzB,MAAM/b,EAAapC,EAAgB,iBAAiB,8BAA+Bme,EAAY,cAAc,EAC7G,OAAK/b,GAAY,cAEVA,EAAW,cAAc,KAAME,GAAWA,EAAE,eAAiBD,EAAQ,MAAM,gBAAgB,EAF3D,EAG3C,CAAC,EAEGF,IAAgB,SAChB6b,EAAkB7b,CAAW,EAAI+b,EAEzC,CAAC,CAEL,MAEQlxB,EAAM,gBAAgB,cAA6B,CAAC,EAAIA,EAAM,eAAe,WAG7EA,EAAM,gBAAgB,UAAU,CAAC,IAAGgxB,EAAkB,CAAC,EAAIhxB,EAAM,eAAe,QAAQ,CAAC,GACzFA,EAAM,gBAAgB,UAAU,CAAC,IAAGgxB,EAAkB,CAAC,EAAIhxB,EAAM,eAAe,QAAQ,CAAC,GAG7FA,EAAM,gBAAgB,WAAW,QAAQ,CAACwJ,EAAMjL,IAAM,CAC9CiL,IAAMwnB,EAAkB,GAAKzyB,CAAC,EAAIiL,EAC1C,CAAC,EAGGxJ,EAAM,gBAAgB,gBAA+B,EAAE,EAAIA,EAAM,eAAe,aAChFA,EAAM,gBAAgB,cAA6B,EAAE,EAAIA,EAAM,eAAe,WAC9EA,EAAM,gBAAgB,qBAAoC,EAAE,EAAIA,EAAM,eAAe,kBAG7F2uB,EAAS,KAAK,CACV,KAAMoC,EACN,gBAAiBC,CAAA,CACpB,CACL,CAEA,MAAO,CACH,GAAIhxB,EAAM,GACV,KAAMA,EAAM,KACZ,UAAWA,EAAM,cACjB,SAAA2uB,EACA,WAAY,CACR,KAAM3uB,EAAM,UACZ,gBAAiBA,EAAM,aAAa,KACpC,cAAeA,EAAM,cAEzB,CAER,CAMA,eAAeoxB,GAAoBvqB,EAA4C,CAC3E,GAAI,CAEA,MAAMwqB,EAAa,KAAK,UAAUxqB,CAAO,EAEnC9L,EADU,IAAI,cACC,OAAOs2B,CAAU,EAGtC,GAAI,OAAO,kBAAsB,IAAa,CAE1C,MAAMC,EADS,IAAI,KAAK,CAACv2B,CAAI,CAAC,EAAE,SACA,YAAY,IAAI,kBAAkB,MAAM,CAAC,EACnEw2B,EAAiB,MAAM,IAAI,SAASD,CAAgB,EAAE,OACtDE,EAAiB,IAAI,WAAW,MAAMD,EAAe,aAAa,EAMxE,MAAO,YAHQ,KAAK,OAAO,aAAa,GAAGC,CAAc,CAAC,EACnC,QAAQ,MAAO,GAAG,EAAE,QAAQ,MAAO,GAAG,EAAE,QAAQ,KAAM,EAAE,CAErD,EAC9B,KAKI,OAAO,YAHQ,KAAKH,CAAU,EACP,QAAQ,MAAO,GAAG,EAAE,QAAQ,MAAO,GAAG,EAAE,QAAQ,KAAM,EAAE,CAErD,EAElC,MAAgB,CACZ,MAAM,IAAI,MAAM,iCAAiC,CACrD,CACJ,CAKA,eAAeI,IAAmC,CAC9C,GAAI,CAMA,MAAM,IAAI,MAAM,kFAAkF,CAKtG,OAAS/zB,EAAY,CACjB,MAAMA,CACV,CACJ,CAEO,MAAMg0B,GAAqB,CAC9B,iBAAAjE,GACA,sBAAAiC,GACA,0BAAAM,GACA,oBAAAoB,GACA,gBAAAK,GACA,gBAAAxE,GACA,cAAA0E,GACA,uBAAAzB,GACA,+BAAAS,EACJ,EAEO,SAASgB,GAAc/D,EAA+B,CACzD,MAAMgE,EAA+B,GAGrC,OAAIhE,EAAK,MAAQA,EAAK,SAClBgE,EAAS,KAAKhE,CAAwB,EAGjCA,EAAK,UAAY,MAAM,QAAQA,EAAK,QAAQ,GACjDA,EAAK,SAAS,QAAS1b,GAAe,CAC9BA,EAAM,SACN0f,EAAS,KAAK1f,EAAM,OAA2B,CAEvD,CAAC,EAGE0f,CACX,CC5pCA,MAAMC,GAA6C,GASnD,SAASC,GAAmB/gB,EAAsC,CAC9D,MAAMghB,EAAahhB,EAAS,cAAc,OACpC9U,EAAQkI,EAAgB,WACxB,CAAE,mBAAAod,EAAoB,qBAAAD,EAAsB,eAAAE,CAAA,EAAmBvlB,EAE/D+1B,MAAgB,IAEtB,UAAWxM,KAAa,OAAO,OAAOjE,CAAkB,EACpD,UAAWnc,KAAQogB,EACfwM,EAAU,IAAI5sB,EAAK,QAAQ,EAInC,UAAW6sB,KAAa,OAAO,OAAO3Q,CAAoB,EACtD,UAAWlc,KAAQ6sB,EACfD,EAAU,IAAI5sB,EAAK,QAAQ,EAInC,UAAWA,KAAQoc,EACfwQ,EAAU,IAAI5sB,EAAK,QAAQ,EAG/B,UAAWoE,KAAQwoB,EAEf,GADYhf,EAAgB,QAAQxJ,CAAI,GAC/B,mBAAmB,MAAM,gBAAkBuoB,EAChD,OAAOvoB,CAKnB,CAGA,SAAS0oB,GAAqBroB,EAAcmC,EAA4B+K,EAAgC,CACpG,GAAI,CAAClN,EAAM,OAAO,KAKlB,IAAIsoB,EAAgD,MAChDnmB,IAAc,GAAKA,IAAc,WAASmmB,EAAS,UACnDnmB,IAAc,GAAKA,IAAc,YAAUmmB,EAAS,WACpDnmB,IAAc,GAAKA,IAAc,aAAWmmB,EAAS,WAGzD,MAAMC,EAASrb,EAAQ,cACvB,GAAI,CAACob,GAAU,CAAC/I,EAAgBgJ,CAAM,EAAG,OAAO,KAKhD,MAAMC,EAAgB1iB,GACXA,EAAI,cACN,QAAQ,QAAS,EAAE,EACnB,QAAQ,cAAe,EAAE,EACzB,OACA,QAAQ,KAAM,GAAG,EACjB,cAIT,GAAIyiB,IAAW,YAAa,CACxB,MAAME,EAAelJ,EAAgB,UAAU+I,CAAM,EACrD,GAAI,CAACG,EAAc,OAAO,KAuB1B,MAAM7P,GArBa8P,GAA4B,CAE3C,MAAMvhB,EAAYqhB,EAAaxoB,CAAI,EAGnC,GAAI,OAAO0oB,GAAQ,SAAU,CACzB,GAAIA,EAAIvhB,CAAS,EAAG,OAAOuhB,EAAIvhB,CAAS,EAGxC,UAAWjV,KAAOw2B,EAAK,CACnB,MAAMnD,EAAMmD,EAAIx2B,CAAG,EACnB,GAAI,OAAOqzB,GAAQ,UACf,GAAIrzB,IAAQiV,EAAW,OAAOoe,UACvB,OAAOA,GAAQ,UAElBA,EAAIpe,CAAS,EAAG,OAAOoe,EAAIpe,CAAS,CAEhD,CACJ,CACA,OAAO,IACX,GACwBshB,CAAY,EACpC,GAAI7P,EAAO,OAAOA,EAIlB,GAAI2G,EAAgB,UAAU,UAAW,CACrC,MAAMpY,EAAYqhB,EAAaxoB,CAAI,EACnC,GAAKuf,EAAgB,UAAU,UAAkBpY,CAAS,EACtD,OAAQoY,EAAgB,UAAU,UAAkBpY,CAAS,CAErE,CACA,OAAO,IACX,CAGA,MAAMwhB,EAAOpJ,EACPqJ,EAASD,EAAKJ,CAAM,IAAID,CAAM,EAEpC,GAAIM,EAAQ,CACR,MAAMzhB,EAAYqhB,EAAaxoB,CAAI,EAGnC,GAAI4oB,EAAO,QAAQzhB,CAAS,EAAG,OAAOyhB,EAAO,MAAMzhB,CAAS,EAC5D,GAAIyhB,EAAO,QAAQzhB,CAAS,EAAG,OAAOyhB,EAAO,MAAMzhB,CAAS,EAC5D,GAAIyhB,EAAO,QAAQzhB,CAAS,EAAG,OAAOyhB,EAAO,MAAMzhB,CAAS,EAC5D,GAAIyhB,EAAO,WAAWzhB,CAAS,EAAG,OAAOyhB,EAAO,SAASzhB,CAAS,EAClE,GAAIyhB,EAAO,kBAAkBzhB,CAAS,EAAG,OAAOyhB,EAAO,gBAAgBzhB,CAAS,EAGhF,GAAIyhB,EAAO,UAAUzhB,CAAS,EAAG,OAAOyhB,EAAO,QAAQzhB,CAAS,EAGhE,GAAIwhB,EAAKJ,CAAM,GAAG,YAAYphB,CAAS,EAAG,OAAOwhB,EAAKJ,CAAM,EAAE,UAAUphB,CAAS,CACrF,CAEA,OAAO,IACX,CAGA,SAAS0hB,GAAsB7oB,EAAc8oB,EAAwE,CACjH,GAAI,CAAC9oB,EAAM,OAAO,KAElB,MAAM8G,EAAW,GAAGgiB,CAAU,IAAI9oB,EAAK,aAAa,GACpD,GAAIgoB,GAAmBlhB,CAAQ,EAC3B,OAAOkhB,GAAmBlhB,CAAQ,EAGtC,MAAMiiB,EAAY/oB,EAAK,cAAc,OAC/B5N,EAAQkI,EAAgB,WACxB,CAAE,mBAAAod,EAAoB,cAAAwB,CAAA,EAAkB9mB,EAG9C,UAAWupB,KAAa,OAAO,OAAOjE,CAAkB,EACpD,UAAWnc,KAAQogB,EAAW,CAC1B,MAAMrf,EAAWf,EAAK,eAAiB2d,EAAc3d,EAAK,cAAc,EAAI,KAC5E,GAAIe,GAAU,QACV,UAAW8J,KAAU9J,EAAS,QAAS,CACnC,GAAI,CAAC8J,EAAO,SAAU,SACtB,MAAMoF,EAAUrC,EAAgB,QAAQ/C,EAAO,QAAQ,EACvD,GAAI,CAACoF,GAAS,mBAAmB,KAAM,SAEvC,MAAMpP,EAAWoP,EAAQ,kBAAkB,KAAK,cAC1C/I,EAAW+I,EAAQ,MAAM,wBAAwB,eAAiB,GAExE,GAAIpP,IAAa2sB,GAAa3sB,EAAS,SAAS2sB,CAAS,GAAKA,EAAU,SAAS3sB,CAAQ,EAAG,CACxF,IAAI4sB,EAAU,GACd,OAAQF,EAAA,CACJ,IAAK,QACDE,EAAUvmB,EAAS,SAAS,OAAO,EACnC,MACJ,IAAK,UACDumB,EAAUvmB,EAAS,SAAS,SAAS,GAAKA,EAAS,SAAS,OAAO,GAC/DA,EAAS,SAAS,iBAAiB,GAAKA,EAAS,SAAS,UAAU,EACxE,MACJ,IAAK,SACDumB,EAAUvmB,EAAS,SAAS,SAAS,EACrC,MACJ,IAAK,WACDumB,EAAUvmB,EAAS,SAAS,WAAW,GAAKA,EAAS,SAAS,QAAQ,EACtE,MAGR,GAAIumB,EACA,OAAAhB,GAAmBlhB,CAAQ,EAAIV,EAAO,SAC/BA,EAAO,QAEtB,CACJ,CAER,CAGJ,OAAO,IACX,CAGA,MAAM2gB,GAA+C,CACjD,QAAS,WAAY,UAAW,WAAY,SAAU,WACtD,WAAY,UAAW,WAAY,UAAW,cAAe,WAC7D,QAAS,WAAY,UAAW,WAAY,SAAU,WACtD,WAAY,UAAW,WAAY,WAAY,cAAe,WAC9D,QAAS,WAAY,UAAW,WAAY,SAAU,WACtD,WAAY,WAAY,WAAY,WAAY,cAAe,UACnE,EAEO,SAASkC,GAAoB,CAAE,QAAAC,EAAS,QAAAC,EAAS,QAAAtL,GAAqC,CACzF,MAAMnK,EAAa,CAAC,QAAS,SAAU,SAAS,EAC1C,CAAE,QAAAhX,EAAS,MAAO0sB,CAAA,EAAc3N,GAAA,EAChC,CAAC4N,EAAYC,CAAa,EAAI5M,WAAwB,IAAI,EAC1D,CAAC6M,EAAYC,CAAa,EAAI9M,WAAS,EAAK,EAC5C,CAAC+M,EAAaC,CAAc,EAAIhN,WAAwB,IAAI,EAC5D,CAACiN,EAAiBC,CAAkB,EAAIlN,WAAwB,IAAI,EACpE,CAACmN,EAAUC,CAAW,EAAIpN,WAAS,CAAE,EAAG,EAAG,EAAG,EAAG,EAEjDa,EAAmB5kB,GAAwB,CAC7C,KAAM,CAAE,QAAAoxB,EAAS,QAAAC,CAAA,EAAYrxB,EACvB,CAAE,WAAAsxB,GAAY,YAAAC,CAAA,EAAgB,OAC9BzL,GAAKsL,EAAUE,GAAc,GAC7BvL,GAAKsL,EAAUE,EAAe,GACpCJ,EAAY,CAAE,EAAArL,GAAG,EAAAC,GAAG,CACxB,EAEM,CAAE,SAAUyL,CAAA,EAAmBtsB,GAAA,EAI/B,CAACusB,EAAWC,CAAY,EAAI3N,WA0B/B,CACC,UAAW,EAAG,UAAW,GAAI,UAAW,GACxC,YAAa,EAAG,YAAa,GAAI,YAAa,GAC9C,UAAW,EAAG,UAAW,GAAI,UAAW,GACxC,iBAAkB,EAAG,iBAAkB,GAAI,iBAAkB,GAC7D,SAAU,EAAG,SAAU,GAAI,SAAU,GACrC,QAAS,GACT,UAAW,GACX,WAAY,EAAG,WAAY,GAC3B,UAAW,EAAG,UAAW,GAC5B,EAGK4N,EAAgC7M,cAAY,IAAqB,CACnE,MAAMuJ,EAAckC,EAAQ,QAAwB,OAAO,CAAC,EAAE,cAAiBA,EAAQ,QAAwB,MAAM,CAAC,EAAE,cAClHjC,EAAoB,GAAGiC,EAAQ,SAAS,IAAIlC,CAAU,GACtDE,EAAeH,GAAqBE,CAAiB,GAAK,EAEhE,MAAO,CACH,GAAI,WAAW,KAAK,KAAK,GACzB,KAAMiC,EAAQ,UACd,QAASA,EAAQ,QAAQ,cACzB,cAAeA,EAAQ,UACvB,aAAc,CACV,KAAMkB,EAAU,YAAc,EAC9B,KAAMlB,EAAQ,OACd,KAAM,GAEV,YAAa,CACT,KAAMkB,EAAU,WAAa,EAC7B,KAAMlB,EAAQ,MACd,KAAM,GAEV,eAAgB,CACZ,aAAAhC,EACA,UAAWkD,EAAU,UACrB,QAASA,EAAU,QAAQ,IAAIxmB,IAAKA,GAAE,IAAI,EAAE,OAAOwG,IAAKA,GAAI,CAAC,EAC7D,UAAWggB,EAAU,UAAU,IAAIlY,IAAKA,GAAE,IAAI,EAAE,OAAO9H,IAAKA,GAAI,CAAC,EACjE,YAAaggB,EAAU,YACvB,UAAWA,EAAU,UACrB,iBAAkBA,EAAU,kBAEhC,UAAW,GACX,cAAe,GACf,MAAO,GACP,UAAWlB,EAAQ,YACnB,WAAY,eAEpB,EAAG,CAACA,EAASkB,CAAS,CAAC,EAGjBG,EAAiB9M,cAAY,SAAY,CAC3C,GAAI,CACA,MAAM9M,EAAW2Z,EAAA,EACXE,EAAY1D,GAA+BnW,CAAQ,EACnD8Z,EAAO,MAAM5C,GAAmB,sBAAsB2C,CAAS,EACrE,MAAM,UAAU,UAAU,UAAUC,CAAI,EACxC/tB,EAAQ,qCAAqC,CACjD,MAAY,CACR0sB,EAAU,yBAAyB,CACvC,CACJ,EAAG,CAACkB,EAA+B5tB,EAAS0sB,CAAS,CAAC,EAEhDsB,EAAiBjN,cAAY,IAAM,CACrC,GAAI,CACA,MAAM9M,EAAW2Z,EAAA,EACXE,EAAY1D,GAA+BnW,CAAQ,EACnD8Z,EAAO5C,GAAmB,0BAA0B2C,CAAS,EACnE,UAAU,UAAU,UAAUC,CAAI,EAClC/tB,EAAQ,+BAA+B,CAC3C,MAAY,CACR0sB,EAAU,6BAA6B,CAC3C,CACJ,EAAG,CAACkB,EAA+B5tB,EAAS0sB,CAAS,CAAC,EAGtD9L,YAAU,IAAM,CACZ,MAAMqN,EAAiBhyB,GAAqB,CACpCA,EAAE,IAAI,gBAAkB,KAAK6wB,EAAcoB,IAAK,CAACA,EAAC,EAClDjyB,EAAE,IAAI,gBAAkB,KAAOklB,IAC/BA,EAAQqL,CAAO,EAEf9rB,GAAW,WAAW,sBAAsB,SAAS,GAErDzE,EAAE,IAAI,gBAAkB,KAAK4xB,EAAA,EAC7B5xB,EAAE,IAAI,gBAAkB,KAAK+xB,EAAA,EAC7B/xB,EAAE,MAAQ,UAAUwwB,EAAA,CAC5B,EAEM0B,EAAoBlyB,GAAkB,CACxCA,EAAE,iBACFwwB,EAAA,CACJ,EAEA,cAAO,iBAAiB,UAAWwB,CAAa,EAChD,OAAO,iBAAiB,cAAeE,CAAgB,EAEhD,IAAM,CACT,OAAO,oBAAoB,UAAWF,CAAa,EACnD,OAAO,oBAAoB,cAAeE,CAAgB,CAC9D,CACJ,EAAG,CAAC1B,EAAStL,EAASqL,EAASqB,EAAgBG,CAAc,CAAC,EAG9DpN,YAAU,IAAM,CACZ,GAAI,CAAC6M,EAAgB,OAErB,eAAeW,GAAgB,CAC3B,MAAM55B,EAAyB,CAC3B,UAAW,EAAG,UAAW,GAAI,UAAW,GACxC,YAAa,EAAG,YAAa,GAAI,YAAa,GAC9C,UAAW,EAAG,UAAW,GAAI,UAAW,GACxC,iBAAkB,EAAG,iBAAkB,GAAI,iBAAkB,GAC7D,SAAU,EAAG,SAAU,GAAI,SAAU,GACrC,QAAS,GACT,UAAW,GACX,WAAY,EAAG,WAAY,GAC3B,UAAW,EAAG,UAAW,IAIvB+W,EAAaihB,EAAQ,OAASjB,GAAmBiB,EAAQ,MAAM,EAAI,OACnE6B,GAAY7B,EAAQ,MAAQjB,GAAmBiB,EAAQ,KAAK,EAAI,OAEtE,GAAIjhB,EAAY,CACZ/W,EAAK,WAAa+W,EAClB/W,EAAK,WAAaiY,EAAgB,QAAQlB,CAAU,GAAK,GACzD,MAAM+iB,GAAY7hB,EAAgB,QAAQlB,CAAU,EAChD+iB,IAAW,YAAY1B,EAAc0B,GAAU,UAAU,CACjE,CAEA,GAAID,KACA75B,EAAK,UAAY65B,GACjB75B,EAAK,UAAYiY,EAAgB,QAAQ4hB,EAAS,GAAK,GACnD,CAAC1B,GAAY,CACb,MAAM4B,GAAW9hB,EAAgB,QAAQ4hB,EAAS,EAC9CE,IAAU,YAAY3B,EAAc2B,GAAS,UAAU,CAC/D,CAIJ,MAAMC,EAAY7C,GAAqBa,EAAQ,MAAOA,EAAQ,UAAWA,EAAQ,OAAO,GAAKL,GAAsBK,EAAQ,MAAO,OAAO,EACrIgC,IACAh6B,EAAK,UAAYg6B,EACjBh6B,EAAK,UAAYiY,EAAgB,QAAQ+hB,CAAS,GAAK,GACvDh6B,EAAK,UAAYg4B,EAAQ,OAI7B,MAAMiC,GAAc9C,GAAqBa,EAAQ,QAASA,EAAQ,UAAWA,EAAQ,OAAO,GAAKL,GAAsBK,EAAQ,QAAS,SAAS,EAC7IiC,KACAj6B,EAAK,YAAci6B,GACnBj6B,EAAK,YAAciY,EAAgB,QAAQgiB,EAAW,GAAK,GAC3Dj6B,EAAK,YAAcg4B,EAAQ,SAI/B,MAAMkC,GAAY/C,GAAqBa,EAAQ,MAAOA,EAAQ,UAAWA,EAAQ,OAAO,GAAKL,GAAsBK,EAAQ,MAAO,SAAS,EACvIkC,KACAl6B,EAAK,UAAYk6B,GACjBl6B,EAAK,UAAYiY,EAAgB,QAAQiiB,EAAS,GAAK,GACvDl6B,EAAK,UAAYg4B,EAAQ,OAI7B,MAAMmC,GAAmBhD,GAAqBa,EAAQ,aAAcA,EAAQ,UAAWA,EAAQ,OAAO,GAAKL,GAAsBK,EAAQ,aAAc,SAAS,EAC5JmC,KACAn6B,EAAK,iBAAmBm6B,GACxBn6B,EAAK,iBAAmBiY,EAAgB,QAAQkiB,EAAgB,GAAK,GACrEn6B,EAAK,iBAAmBg4B,EAAQ,cAIpC,MAAMoC,GAAWjD,GAAqBa,EAAQ,KAAMA,EAAQ,UAAWA,EAAQ,OAAO,GAAKL,GAAsBK,EAAQ,KAAM,SAAS,EAQxI,GAPIoC,KACAp6B,EAAK,SAAWo6B,GAChBp6B,EAAK,SAAWiY,EAAgB,QAAQmiB,EAAQ,GAAK,GACrDp6B,EAAK,SAAWg4B,EAAQ,MAIxBA,EAAQ,QAAQ,gBAAkB,cAClCh4B,EAAK,kBAAoBiY,EAAgB,QAAQ,UAAU,GAAK,GAC5D+f,EAAQ,qBAAqB,CAC7B,MAAMqC,GAAY1C,GAAsBK,EAAQ,oBAAqB,SAAS,EAC1EqC,KACAr6B,EAAK,wBAA0Bq6B,GAC/Br6B,EAAK,wBAA0BiY,EAAgB,QAAQoiB,EAAS,GAAK,GACrEr6B,EAAK,wBAA0Bg4B,EAAQ,oBAE/C,CAIJ,UAAWsC,MAActC,EAAQ,QAAS,CACtC,MAAM3gB,GAAa8f,GAAqBmD,GAAYtC,EAAQ,UAAWA,EAAQ,OAAO,GAAKL,GAAsB2C,GAAY,QAAQ,EACrI,GAAIjjB,GAAY,CACZ,MAAMqR,GAAOzQ,EAAgB,QAAQZ,EAAU,GAAK,GACpDrX,EAAK,QAAQ,KAAK,CAAE,KAAMqX,GAAY,KAAAqR,GAAM,KAAM4R,GAAY,CAClE,CACJ,CAGA,UAAWC,MAAgBvC,EAAQ,UAAW,CAC1C,MAAMwC,GAAerD,GAAqBoD,GAAcvC,EAAQ,UAAWA,EAAQ,OAAO,GAAKL,GAAsB4C,GAAc,UAAU,EAC7I,GAAIC,GAAc,CACd,MAAM9R,GAAOzQ,EAAgB,QAAQuiB,EAAY,GAAK,GACtDx6B,EAAK,UAAU,KAAK,CAAE,KAAMw6B,GAAc,KAAA9R,GAAM,KAAM6R,GAAc,CACxE,CACJ,CAEApB,EAAan5B,CAAI,CACrB,CAEA45B,EAAA,CACJ,EAAG,CAAC5B,EAASiB,CAAc,CAAC,EAI5B,KAAM,CAAE,kBAAAwB,EAAA,EAmCG,CAAE,kBAlCiB,CAACC,EAAoBC,EAAgB,KAAMC,GAAc,OAAS,CACxF,KAAM,CAAE,SAAA1K,EAAU,cAAAC,GAAe,OAAAC,EAAA,EAAWJ,GAAe0K,CAAQ,EAE7DG,GAAqBpsB,IAAwB,CAC/C,MAAM+F,GAAM/F,GAAOwJ,EAAgB,QAAQxJ,EAAI,EAAI,KACnD,OAAK+F,GAGD6V,MAAC,OAAe,UAAU,uBAAuB,aAAc,IAAMqO,EAAmBjqB,EAAI,EAAG,aAAc,IAAMiqB,EAAmB,IAAI,EACtI,SAAArO,MAAC,OAAI,IAAKZ,GAAcjV,GAAY,mBAAmB,MAAQ,EAAE,EAAG,IAAI,GAAG,GADrE/F,EAEV,EALa4b,MAAC,OAAI,UAAU,uCAAuC,CAO3E,EAEMyQ,GAAgBrsB,IAAiB,CACnC,MAAM+F,GAAMyD,EAAgB,QAAQxJ,EAAI,EACxC,OAAK+F,GAED6V,MAAC,OAAe,UAAU,UAAU,aAAc,IAAMqO,EAAmBjqB,EAAI,EAAG,aAAc,IAAMiqB,EAAmB,IAAI,EACzH,SAAArO,MAAC,OAAI,IAAKZ,GAAcjV,GAAY,mBAAmB,MAAQ,EAAE,EAAG,IAAI,GAAG,GADrE/F,EAEV,EAJa,IAMrB,EAEA,OACI2b,OAAC,OAAI,UAAU,sBACV,UAAAyQ,GAAkBD,IAAQ,IAAI,EAC9BC,GAAkBF,GAAU,IAAI,EAChCzK,GAAY4K,GAAa5K,CAAQ,EACjCC,IAAiB2K,GAAa3K,EAAa,EAC3CC,GAAO,IAAKlX,IAAM4hB,GAAa5hB,EAAC,CAAC,GACtC,CAER,CACSuhB,EAIPM,EAAmBtsB,GAAwB,CAC7C+pB,EAAe/pB,CAAI,CACvB,EAEMuN,EAAWgc,EAAQ,QAAwB,cAGjD,OAAOnK,gBACHzD,OAAC,OACG,UAAW,gDAAgDpO,CAAO,GAClE,YAAaqQ,EACb,MAAO,CACH,eAAgBsM,EAAS,EACzB,eAAgBA,EAAS,GAI7B,UAAAvO,OAAC,OAAI,UAAU,4BACX,UAAAC,MAAC,OAAI,UAAU,iCAAiC,EAC/C8N,SACI,OAAI,IAAKA,EAAY,UAAU,oCAAoC,IAAI,GAAG,EAE/E9N,MAAC,OAAI,UAAU,kCAAkC,GACrD,QAGC,OAAI,UAAU,gCACX,SAAAD,OAAC,OAAI,UAAU,qCACX,UAAAC,MAAC,MAAG,UAAU,8BAA+B,SAAA2N,EAAQ,UAAU,EAC/D5N,OAAC,OAAI,UAAU,kCACX,UAAAC,MAAC,QAAK,UAAW,gCAAgCrO,CAAO,GAAK,WAAQ,QAAQ,SAC5E,QAAM,UAAAwG,EAAWwV,EAAQ,SAAS,EAAE,MAAIA,EAAQ,cAAa,GAClE,GACJ,EACJ,EAGA5N,OAAC,OAAI,UAAU,iCAEX,UAAAC,MAAC,OAAI,UAAU,qCACV,SAAA6O,EAAU,WACP7O,MAAC,OACG,UAAU,mBACV,aAAc,IAAM0Q,EAAgB7B,EAAU,SAAS,EACvD,aAAc,IAAM6B,EAAgB,IAAI,EAExC,eAAC,OAAI,IAAK7B,EAAU,UAAW,IAAKA,EAAU,UAAW,IAGrE,EAGA9O,OAAC,OAAI,UAAU,wBACX,UAAAA,OAAC,OAAI,UAAU,iCAEX,UAAAA,OAAC,OAAI,UAAU,iCACX,UAAAC,MAAC,OAAI,UAAU,+BAA+B,uBAAW,EACzDD,OAAC,OAAI,UAAU,uBACV,UAAA8O,EAAU,kBACP7O,MAAC,OACG,UAAW,uBAAuBrO,CAAO,GACzC,aAAc,IAAM+e,EAAgB7B,EAAU,gBAAgB,EAC9D,aAAc,IAAM6B,EAAgB,IAAI,EAExC,eAAC,OAAI,IAAK7B,EAAU,iBAAkB,IAAKA,EAAU,iBAAkB,IAG9EA,EAAU,UACP7O,MAAC,OACG,UAAW,uBAAuBrO,CAAO,GACzC,aAAc,IAAM+e,EAAgB7B,EAAU,QAAQ,EACtD,aAAc,IAAM6B,EAAgB,IAAI,EAExC,eAAC,OAAI,IAAK7B,EAAU,SAAU,IAAKA,EAAU,SAAU,IAG9DA,EAAU,aACP7O,MAAC,OACG,UAAW,uBAAuBrO,CAAO,GACzC,aAAc,IAAM+e,EAAgB7B,EAAU,WAAW,EACzD,aAAc,IAAM6B,EAAgB,IAAI,EAExC,eAAC,OAAI,IAAK7B,EAAU,YAAa,IAAKA,EAAU,YAAa,IAGpEA,EAAU,WACP7O,MAAC,OACG,UAAW,uBAAuBrO,CAAO,GACzC,aAAc,IAAM+e,EAAgB7B,EAAU,SAAS,EACvD,aAAc,IAAM6B,EAAgB,IAAI,EAExC,eAAC,OAAI,IAAK7B,EAAU,UAAW,IAAKA,EAAU,UAAW,GAC7D,EAER,GACJ,EAGA9O,OAAC,OAAI,UAAU,+BACX,UAAAC,MAAC,OAAI,UAAU,+BAA+B,qBAAS,EACvDD,OAAC,OAAI,UAAU,uBACV,UAAA8O,EAAU,QAAQ,IAAI,CAAC8B,EAAax3B,IACjC6mB,MAAC,OAEG,UAAW,uBAAuBrO,CAAO,GACzC,aAAc,IAAM+e,EAAgBC,EAAO,IAAI,EAC/C,aAAc,IAAMD,EAAgB,IAAI,EAExC,eAAC,OAAI,IAAKC,EAAO,KAAM,IAAKA,EAAO,KAAM,GALpCx3B,CAAA,CAOZ,EAEA01B,EAAU,mBACP7O,MAAC,OACG,UAAU,gCACV,aAAc,IAAM0Q,EAAgB,UAAU,EAC9C,aAAc,IAAMA,EAAgB,IAAI,EAExC,eAAC,OAAI,IAAK7B,EAAU,kBAAmB,IAAI,gBAAgB,GAC/D,EAER,GACJ,GACJ,QAEC,OAAI,UAAU,oCAEX,SAAA9O,OAAC,OAAI,UAAU,iCACX,UAAAC,MAAC,OAAI,UAAU,+BAA+B,uBAAW,EACzDA,MAAC,OAAI,UAAU,wCACV,WAAU,UAAU,IAAI,CAAC4Q,EAAez3B,IACrC6mB,MAAC,OAEG,UAAW,4CAA4CrO,CAAO,GAC9D,aAAc,IAAM+e,EAAgBE,EAAS,IAAI,EACjD,aAAc,IAAMF,EAAgB,IAAI,EAExC,eAAC,OAAI,IAAKE,EAAS,KAAM,IAAKA,EAAS,KAAM,GALxCz3B,CAAA,CAOZ,EACL,GACJ,EACJ,QAGC,OAAI,UAAU,kCACX,SAAA4mB,OAAC,OAAI,UAAU,4BACX,UAAAC,MAAC,OAAI,UAAU,+BAA+B,4BAAgB,EAC9DD,OAAC,OAAI,UAAU,8CAEV,UAAA8O,EAAU,YACP9O,OAAC,OACG,UAAU,uBACV,aAAc,IAAMsO,EAAmBQ,EAAU,YAAc,IAAI,EACnE,aAAc,IAAMR,EAAmB,IAAI,EAE3C,UAAArO,MAACqE,GAAA,CACG,KAAMwK,EAAU,YAAc,EAC9B,SAAU,CAAE,MAAO,EAAE,GAEzB7O,MAAC,OAAI,UAAU,iBACX,SAAAA,MAAC,QAAK,UAAU,6BAA8B,SAAA2N,EAAQ,OAAO,EACjE,KAKPkB,EAAU,UAAY,GACnB9O,OAAC,OACG,UAAU,uBACV,aAAc,IAAMsO,EAAmBQ,EAAU,WAAa,IAAI,EAClE,aAAc,IAAMR,EAAmB,IAAI,EAE3C,UAAArO,MAACqE,GAAA,CACG,KAAMwK,EAAU,WAAa,EAC7B,SAAU,CAAE,MAAO,EAAE,GAEzB9O,OAAC,OAAI,UAAU,iBACX,UAAAC,MAAC,QAAK,UAAU,6BAA8B,SAAA2N,EAAQ,MAAM,EAC1DA,EAAgB,WAAcA,EAAgB,UAAU,OAAS,GAAKyC,GAAmBzC,EAAgB,SAAS,GACxH,IACJ,EAER,GACJ,EACJ,GACJ,GACJ,SAGC,OAAI,UAAW,qCAAqCK,EAAa,0CAA4C,EAAE,GAC5G,UAAAhO,MAAC,OAAI,UAAU,qBACX,SAAAA,MAAC,MAAG,UAAU,oBAAoB,0BAAc,EACpD,EACAA,MAAC,OAAI,UAAU,sBACV,WAAQ,YACb,GACJ,GAIEkO,GAAeE,IACbpO,MAACyD,GAAA,CAAY,KAAM,CAAE,KAAOyK,GAAeE,EAAkB,CAAG,KAGxE,SAAS,KAEjB,CCltBA,MAAMyC,GAAyC,CAC3C,MAAO,UACP,IAAK,UACL,KAAM,UACN,OAAQ,UACR,OAAQ,UACR,UAAW,UACX,QAAS,SACb,EA4CO,SAASC,GAAW,CACvB,YAAAC,EACA,eAAAC,EACA,aAAAC,EACA,gBAAAC,EACA,eAAAC,EACA,uBAAAC,EACA,cAAAzT,EACA,YAAA0T,EACA,kBAAAC,EACA,YAAAC,EACA,WAAAC,EACA,QAAA5D,EACA,UAAA6D,EAAY,GACZ,oBAAAC,EACA,cAAAC,EACA,kBAAAC,CACJ,EAAoB,CAChB,KAAM,CAACC,EAAeC,CAAgB,EAAI3Q,WAAyG,IAAI,EAEjJ,CAAC4Q,EAAcC,CAAe,EAAI7Q,WAAyG,IAAI,EAC/I,CAAC8Q,EAAOC,CAAQ,EAAI/Q,WAAyB,EAAE,EAC/C,CAACgR,EAAmBC,EAAoB,EAAIjR,WAAS,CAAC,EACtD,CAACkR,EAAcC,CAAe,EAAInR,WAAS,CAAC,EAC5C,CAACoR,EAAkBC,CAAmB,EAAIrR,WAAkC,IAAI,EAGtFY,YAAU,IAAM,CACR6P,GAAqBA,EAAoB,GACzCa,GAAA,CAER,EAAG,CAACb,CAAiB,CAAC,EACtB,MAAMc,EAASjR,SAAsB,IAAI,EAEnCkR,GAAiBlR,SAA4B,IAAI,EACjDmR,EAAkBnR,SAAuG,IAAI,EAC7HoR,GAAyBpR,SAAOiQ,CAAmB,EACnDoB,GAAoBrR,SAA8B,IAAI,EACtDsR,GAAmBtR,SAA8B,IAAI,EAGrDuR,GAAcnB,GACdI,EAAM,QAAU/hB,EAAE,QAAQ,YAAc2hB,EAAc,WAAa3hB,EAAE,aAAe2hB,EAAc,UAAU,GAAK,KAIjHoB,GAAalB,GACbE,EAAM,QAAU/hB,EAAE,QAAQ,YAAc6hB,EAAa,WAAa7hB,EAAE,aAAe6hB,EAAa,UAAU,GAAK,KAGrHhQ,YAAU,IAAM,CACZ4Q,GAAe,QAAUK,EAC7B,EAAG,CAACA,EAAW,CAAC,EAEhBjR,YAAU,IAAM,CACZ6Q,EAAgB,QAAUb,CAC9B,EAAG,CAACA,CAAY,CAAC,EAGjBhQ,YAAU,IACC,IAAM,CACL+Q,GAAkB,SAClB,aAAaA,GAAkB,OAAO,EAEtCC,GAAiB,SACjB,aAAaA,GAAiB,OAAO,CAE7C,EACD,EAAE,EAGLhR,YAAU,IAAM,CACZ8Q,GAAuB,QAAUnB,CACrC,EAAG,CAACA,CAAmB,CAAC,EAGxB,MAAMwB,GAAiBzR,SAAgB,EAAK,EAE5CM,YAAU,IAAM,CACZ,GAAI4P,EAAe,CAEf,MAAMwB,EAAOlB,EAAM,KAAK/hB,IACnBA,GAAE,aAAa,KAAK,iBAAmByhB,GACvCzhB,GAAE,cAAc,KAAK,iBAAmByhB,CAAA,EAG7C,GAAIwB,EAAM,CAEFL,GAAkB,UAClB,aAAaA,GAAkB,OAAO,EACtCA,GAAkB,QAAU,MAGhC,MAAMM,GAAS,CAAE,UAAWD,EAAK,QAAQ,UAAW,WAAYA,EAAK,WAAY,YAAaA,EAAK,cAE/FtB,GAAe,YAAcuB,GAAO,WAAavB,GAAe,aAAeuB,GAAO,YAAcvB,GAAe,cAAgBuB,GAAO,cAC1ItB,EAAiBsB,EAAM,EAEtBF,GAAe,UAChBA,GAAe,QAAU,GACzB5B,IAAoB,EAAI,EAExBC,IAAc,CACV,gBAAiB4B,EAAK,aAAa,KAAK,gBAAkB,KAC1D,iBAAkBA,EAAK,cAAc,KAAK,gBAAkB,KAC/D,EAET,CACJ,CAIJ,EAAG,CAACxB,EAAeM,EAAOJ,EAAeP,EAAmBC,CAAW,CAAC,EAGxExP,YAAU,IAAM,CACZ,GAAI,CAAC0P,EAAW,CACZa,EAAgB,CAAC,EACjB,MACJ,CAEA,MAAMe,EAAY,YAAY,MACxBC,GAAW,IAEXC,GAAW93B,IAAgB,CAC7B,MAAM+3B,GAAU/3B,GAAM43B,EAChBrtB,GAAW,EAAI,KAAK,IAAIwtB,GAAUF,GAAU,CAAC,EAEnDhB,EAAgBtsB,GAAWA,EAAQ,EAC/BA,GAAW,GAAG,sBAAsButB,EAAO,CACnD,EAEA,sBAAsBA,EAAO,CACjC,EAAG,CAAC9B,CAAS,CAAC,EAId1P,YAAU,IAAM,CACZ,GAAI,CAACiP,GAAkB,CAACD,EAAY,QAAUU,EAAW,CACrDS,EAAS,EAAE,EACX,MACJ,CAEA,IAAIuB,EACJ,MAAMC,GAAuB,CAAE,QAAS,IAElCC,GAAc,IAAM,CACtB,MAAMC,GAAkBf,GAAuB,QACzCgB,GAA2B,GAGjC,IAAIC,GAAiB9C,EAAe,EAChC+C,GAAiB/C,EAAe,EAChCgD,GAAqBhD,EAAe,OAAS,EAEjD,GAAIC,EAAc,CACd,MAAMgD,GAAa/C,EAAgB,GAAI,WAAY,OAAWD,CAAY,EACtEgD,KACAH,GAAiBG,GAAW,EAC5BF,GAAiBE,GAAW,EAC5BD,GAAqBC,GAAW,MAExC,CAEA,MAAMC,GAA6G,GAC7GC,GAAmBlD,GAAc,SAAS,UAAU,EAI1D,IAAImD,GAAgB,GACpB,GAAInD,GAAgBkD,GAAkB,CAClC,MAAMnL,GAAQiI,EAAa,MAAM,gBAAgB,EACjD,GAAIjI,GAAO,CACP,MAAM5kB,GAAO,SAAS4kB,GAAM,CAAC,CAAC,EA2B9BoL,GAxBiD,CAE7C,WAAY,QACZ,UAAW,OACX,UAAW,MACX,WAAY,SACZ,WAAY,SACZ,WAAY,YAEZ,WAAY,QACZ,UAAW,OACX,WAAY,MACZ,WAAY,SACZ,WAAY,SACZ,WAAY,YAEZ,WAAY,QACZ,WAAY,OACZ,WAAY,MACZ,WAAY,SACZ,UAAW,SACX,WAAY,YACZ,WAAY,aAEiBhwB,EAAI,GAAK,EAC9C,CACJ,CAQA,GAPI,CAACgwB,IAAiBrD,EAAY,OAAS,IAGvCqD,GAAgBrD,EAAY,CAAC,EAAE,QAAQ,eAIvC6C,IAAmBA,GAAgB,OAAS,EAAG,CAC/C,IAAIS,GAAS,EAEb,UAAWC,MAAQvD,EAAa,CAC5B,MAAMpf,GAAU2iB,GAAK,QAAQ,cACzBJ,GAASviB,EAAO,IAAM,SACtBuiB,GAASviB,EAAO,EAAIuf,EAAgB,GAAGvf,EAAO,YAAa,UAAU,GAEzE,MAAM4iB,GAAML,GAASviB,EAAO,EACtB6iB,GAAcD,IAAK,SAAWtD,EAC9BwD,GAAeN,IAAoB,CAACK,GACpCE,GAAYD,GAAeF,IAAK,EAAI,OACpCI,GAAYF,GAAeF,IAAK,EAAI,OAG1C,GAAID,GAAK,aAAeD,GAAST,GAAgB,OAAQ,CACrD,MAAMgB,GAAYhB,GAAgBS,IAAQ,EAC1CR,GAAS,KAAK,CACV,QAASC,GACT,QAASC,GACT,YAAaC,GACb,KAAMU,GACN,KAAMC,GACN,SAAUJ,IAAK,MACf,WAAYA,IAAK,QACjB,QAASK,GAAU,QACnB,QAASA,GAAU,QACnB,YAAaA,GAAU,YACvB,cAAeA,GAAU,cACzB,oBAAqBA,GAAU,cAC/B,aAAcA,GAAU,aACxB,QAASR,IAAiBE,GAAK,QAC/B,QAASA,GAAK,QACd,YAAaA,GAAK,YAClB,aAAcA,GAAK,aACnB,WAAY,QACf,CACL,CAGA,GAAIA,GAAK,cAAgBD,GAAST,GAAgB,OAAQ,CACtD,MAAMgB,GAAYhB,GAAgBS,IAAQ,EAC1CR,GAAS,KAAK,CACV,QAASC,GACT,QAASC,GACT,YAAaC,GACb,KAAMU,GACN,KAAMC,GACN,SAAUJ,IAAK,MACf,WAAYA,IAAK,QACjB,QAASK,GAAU,QACnB,QAASA,GAAU,QACnB,YAAaA,GAAU,YACvB,cAAeA,GAAU,cACzB,oBAAqBA,GAAU,cAC/B,aAAcA,GAAU,aACxB,QAASR,IAAiBE,GAAK,QAC/B,QAASA,GAAK,QACd,YAAaA,GAAK,YAClB,aAAcA,GAAK,aACnB,WAAY,SACf,CACL,CACJ,CACJ,KAEI,WAAWA,MAAQvD,EAAa,CAC5B,MAAMpf,GAAU2iB,GAAK,QAAQ,cACzBJ,GAASviB,EAAO,IAAM,SACtBuiB,GAASviB,EAAO,EAAIuf,EAAgB,GAAGvf,EAAO,YAAa,UAAU,GAEzE,MAAM4iB,GAAML,GAASviB,EAAO,EACtB6iB,GAAcD,IAAK,SAAWtD,EAC9BwD,GAAeN,IAAoB,CAACK,GACpCE,GAAYD,GAAeF,IAAK,EAAI,OACpCI,GAAYF,GAAeF,IAAK,EAAI,OAE1C,IAAIM,GAAW,KACXC,GAAY,KAEZR,GAAK,cACLO,GAAW3D,EACPoD,GAAK,QAAQ,MACbA,GAAK,YAAY,SACjBA,GAAK,YAAY,YACjBA,GAAK,YAAY,KAAK,iBAI1BA,GAAK,eACLQ,GAAY5D,EACRoD,GAAK,QAAQ,OACbA,GAAK,aAAa,SAClBA,GAAK,aAAa,YAClBA,GAAK,aAAa,KAAK,iBAI/B,MAAMS,GAAgB,CAAC1gB,GAAUjI,KAA6B,CACrDiI,IACLwf,GAAS,KAAK,CACV,QAASC,GACT,QAASC,GACT,YAAaC,GACb,KAAMU,GACN,KAAMC,GACN,SAAUJ,IAAK,MACf,WAAYA,IAAK,QACjB,QAASlgB,GAAI,EACb,QAASA,GAAI,EACb,YAAaA,GAAI,MACjB,cAAeA,GAAI,QACnB,oBAAqBA,GAAI,QACzB,aAAc,KAAK,IAAI,EAAG,GAAKA,GAAI,KAAK,EACxC,QAASigB,GAAK,QACd,QAASA,GAAK,QACd,YAAaA,GAAK,YAClB,aAAcA,GAAK,aACnB,WAAYloB,EAAA,CACf,CACL,EAEA2oB,GAAcF,GAAU,OAAO,EAC/BE,GAAcD,GAAW,QAAQ,EAIjC,MAAME,GAAYnD,GAAe,YAAcyC,GAAK,QAAQ,UACtDtd,GAAW+a,GAAc,YAAcuC,GAAK,QAAQ,UAE1D,GAAIU,IAAahe,GAAU,CACvB,MAAMie,GAAY,CACd,CAAE,KAAMX,GAAK,QAAQ,MAAO,KAAM,SAClC,CAAE,KAAMA,GAAK,QAAQ,QAAS,KAAM,WACpC,CAAE,KAAMA,GAAK,QAAQ,MAAO,KAAM,SAClC,CAAE,KAAMA,GAAK,QAAQ,aAAc,KAAM,gBACzC,IAAIA,GAAK,QAAQ,SAAW,IAAI,IAAIjsB,KAAM,CAAE,KAAMA,GAAG,KAAM,UAAW,EACtE,IAAIisB,GAAK,QAAQ,WAAa,IAAI,IAAI3d,KAAM,CAAE,KAAMA,GAAG,KAAM,YAAa,GAG9E,UAAW9G,MAAWolB,GAAW,CAC7B,GAAI,CAACplB,GAAQ,KAAM,SACnB,MAAMqlB,GAAahE,EAAgBrhB,GAAQ,KAAM,UAAU,EACvDqlB,IACArB,GAAS,KAAK,CACV,QAASC,GACT,QAASC,GACT,YAAaC,GACb,KAAMU,GACN,KAAMC,GACN,SAAUJ,IAAK,MACf,WAAYA,IAAK,QACjB,QAASW,GAAW,EACpB,QAASA,GAAW,EACpB,YAAaA,GAAW,MAAQ,GAChC,cAAeA,GAAW,QAC1B,oBAAqBA,GAAW,QAChC,aAAc,KAAK,IAAI,EAAG,GAAKA,GAAW,KAAK,EAC/C,QAASZ,GAAK,QACd,QAASA,GAAK,QACd,YAAaA,GAAK,YAClB,aAAcA,GAAK,aACnB,WAAY,UACZ,YAAazkB,GAAQ,KACxB,CAET,CACJ,CACJ,CAIJ,MAAMslB,GAAmB,KAAK,UAAUtB,GAAS,IAAI3jB,KAAM,CACvD,GAAI,KAAK,MAAMA,GAAE,OAAO,EACxB,GAAI,KAAK,MAAMA,GAAE,OAAO,EACxB,GAAIA,GAAE,YAAY,QAAQ,CAAC,EAC3B,GAAIA,GAAE,cAAc,QAAQ,CAAC,GAC/B,CAAC,EAECilB,KAAqBzB,GAAqB,UAC1CA,GAAqB,QAAUyB,GAC/BjD,EAAS2B,EAAQ,GAGrBJ,EAAM,sBAAsBE,EAAW,CAC3C,EAGA,OAAAF,EAAM,sBAAsBE,EAAW,EAChC,IAAM,qBAAqBF,CAAG,CACzC,EAAG,CAAC1C,EAAaC,EAAgBC,EAAcC,EAAiBO,CAAS,CAAC,EAG1E1P,YAAU,IAAM,CACZ,GAAI,CAACgP,EAAY,OAAQ,OACzB,MAAMsC,EAAY,YAAY,MACxBC,GAAW,IACXC,GAAW93B,IAAgB,CAC7B,MAAMuK,GAAW,KAAK,KAAKvK,GAAM43B,GAAaC,GAAU,CAAC,EACzDlB,GAAqBpsB,EAAQ,EACzBA,GAAW,GAAG,sBAAsButB,EAAO,CACnD,EACA,sBAAsBA,EAAO,CACjC,EAAG,CAACxC,CAAW,CAAC,EAGhB,MAAMqE,GAAclT,cAAY,CAACiR,EAAoBntB,GAAmB,IAAc,CAClF,KAAM,CAAE,QAAAqvB,GAAS,QAAAC,GAAS,QAAAC,GAAS,QAAAC,GAAS,YAAAC,IAAgBtC,EAEtDuC,GAAKH,GAAUF,GACfM,GAAKH,GAAUF,GACfxpB,GAAO,KAAK,KAAK4pB,GAAKA,GAAKC,GAAKA,EAAE,EAIlCC,GAAkB,KAAK,IAAI9pB,GAAO,IAAM,GAAG,EAC3C+pB,GAAS,KAAK,IAAI,GAAID,EAAe,EAAIH,GAEzCK,GAAOT,GAAUK,GAAK,IACtBK,GAAOT,GAAUK,GAAK,IAAOE,GAC7BG,GAAOX,GAAUK,GAAK,IACtBO,GAAOX,GAAUK,GAAK,IAAOE,GAG7BK,GAAOb,GAAUK,GAAK1vB,GACtBmwB,GAAOb,GAAUK,GAAK3vB,GAE5B,OAAIA,GAAW,EAEJ,KAAKqvB,EAAO,IAAIC,EAAO,MAAMQ,EAAI,IAAIC,EAAI,IAAIG,EAAI,IAAIC,EAAI,GAG7D,KAAKd,EAAO,IAAIC,EAAO,MAAMQ,EAAI,IAAIC,EAAI,IAAIC,EAAI,IAAIC,EAAI,IAAIV,EAAO,IAAIC,EAAO,EAC1F,EAAG,EAAE,EAGCY,GAAuBlU,cAAaiR,GAAuB,CAO7D,GALIL,GAAkB,UAClB,aAAaA,GAAkB,OAAO,EACtCA,GAAkB,QAAU,MAG5B,CAACF,EAAgB,QAAS,CAK1B,GAHmBD,GAAe,SAAS,QAAQ,YAAcQ,EAAK,QAAQ,WAC1ER,GAAe,SAAS,aAAeQ,EAAK,WAEhC,OAGZJ,GAAiB,SACjB,aAAaA,GAAiB,OAAO,EAGzCA,GAAiB,QAAU,WAAW,IAAM,CACxCjB,EAAiB,CAAE,UAAWqB,EAAK,QAAQ,UAAW,WAAYA,EAAK,WAAY,EACnF7B,IAAoB,EAAI,EAExBC,IAAc,CACV,gBAAiB4B,EAAK,aAAa,KAAK,gBAAkB,KAC1D,iBAAkBA,EAAK,cAAc,KAAK,gBAAkB,KAC/D,EACDJ,GAAiB,QAAU,IAC/B,EAAG,GAAG,CACV,CACJ,EAAG,CAACzB,EAAmBC,CAAW,CAAC,EAE7B8E,GAAuBnU,cAAY,IAAM,CACtC0Q,EAAgB,UAEbG,GAAiB,UACjB,aAAaA,GAAiB,OAAO,EACrCA,GAAiB,QAAU,MAI/BD,GAAkB,QAAU,WAAW,IAAM,CACzChB,EAAiB,IAAI,EACrBR,IAAoB,EAAK,EACzBC,IAAc,IAAI,EAClBuB,GAAkB,QAAU,IAChC,EAAG,GAAG,EAEd,EAAG,CAACxB,EAAmBC,CAAW,CAAC,EAE7B+E,GAA0BpU,cAAY,IAAM,CAEzC0Q,EAAgB,UAEbE,GAAkB,SAClB,aAAaA,GAAkB,OAAO,EAE1CA,GAAkB,QAAU,WAAW,IAAM,CACzChB,EAAiB,IAAI,EACrBR,IAAoB,EAAK,EACzBC,IAAc,IAAI,EAClBuB,GAAkB,QAAU,IAChC,EAAG,GAAG,EAEd,EAAG,CAACxB,EAAmBC,CAAW,CAAC,EAE7BgF,GAA0BrU,cAAY,IAAM,CAE1C4Q,GAAkB,UAClB,aAAaA,GAAkB,OAAO,EACtCA,GAAkB,QAAU,MAGhC,MAAM0D,EAAavD,IAAcN,GAAe,QAC5C6D,IACA1E,EAAiB,CAAE,UAAW0E,EAAW,QAAQ,UAAW,WAAYA,EAAW,WAAY,EAG/FjF,IAAc,CACV,gBAAiBiF,EAAW,aAAa,KAAK,gBAAkB,KAChE,iBAAkBA,EAAW,cAAc,KAAK,gBAAkB,KACrE,GAELlF,IAAoB,EAAI,CAC5B,EAAG,CAACA,EAAmBC,EAAa0B,EAAU,CAAC,EAGzCwD,GAAqBvU,cAAaiR,GAAuB,CAC3Dn+B,GAAS,aAAc,mBAAmBm+B,EAAK,UAAU,GAAIA,CAAI,EACjE,MAAMC,GAAS,CAAE,UAAWD,EAAK,QAAQ,UAAW,WAAYA,EAAK,YAIrE,GAHwBP,EAAgB,SAAS,YAAcQ,GAAO,WAClER,EAAgB,SAAS,aAAeQ,GAAO,WAI/CpB,EAAgB,IAAI,EACpBF,EAAiB,IAAI,EACrBR,IAAoB,EAAK,EACzBC,IAAc,IAAI,EAClBC,IAAa,IAAI,MACd,CAEHQ,EAAgBoB,EAAM,EACtBtB,EAAiBsB,EAAM,EACvB9B,IAAoB,EAAI,EAExBC,IAAc,CACV,gBAAiB4B,EAAK,aAAa,KAAK,gBAAkB,KAC1D,iBAAkBA,EAAK,cAAc,KAAK,gBAAkB,KAC/D,EAED,MAAMrgB,GAAiBqgB,EAAK,aAAe,QACrCA,EAAK,aAAa,KAAK,eACvBA,EAAK,cAAc,KAAK,eAC9Bn+B,GAAS,aAAc,uBAAuB8d,EAAc,EAAE,EAC9D0e,IAAa1e,IAAkB,IAAI,CACvC,CACJ,EAAG,CAACwe,EAAmBC,EAAaC,CAAU,CAAC,EAGzCkF,GAAwBxU,cAAY,IAAM,CACxC0Q,EAAgB,UAChBZ,EAAgB,IAAI,EACpBF,EAAiB,IAAI,EACrBR,IAAoB,EAAK,EACzBC,IAAc,IAAI,EAClBC,IAAa,IAAI,EAEzB,EAAG,CAACF,EAAmBC,EAAaC,CAAU,CAAC,EAEzCmF,GAAqBzU,cAAayL,GAA8B,CAClE6E,EAAoB7E,CAAO,EAC3BmE,EAAiB,IAAI,EACrBR,IAAoB,EAAK,EACrBF,GACAA,EAAuB,GAAMzD,CAAO,CAE5C,EAAG,CAAC2D,EAAmBF,CAAsB,CAAC,EAExCqB,GAAqBvQ,cAAY,IAAM,CACzCsQ,EAAoB,IAAI,EACpBpB,GACAA,EAAuB,GAAO,IAAI,CAE1C,EAAG,CAACA,CAAsB,CAAC,EAErBwF,GAAuB1U,cAAaiR,GAA8B,CACpE,GAAI,CAACA,EAAM,OAAO,KAClB,MAAM0D,GAAY,gBAAgB1D,EAAK,QAAQ,SAAS,IAAIA,EAAK,QAAQ,KAAK,IAAIA,EAAK,QAAQ,MAAM,GAErG,OACInT,MAAC,OAAI,UAAU,gCAAgC,aAAcuW,GAAyB,aAAcD,GAChG,SAAAvW,OAAC,OAAI,UAAU,sCACV,UAAAoT,EAAK,aAAa,MACfnT,MAAC,OAAI,UAAU,qCACX,SAAAA,MAACyD,GAAA,CAEG,KAAM0P,EAAK,YAAY,KACvB,SAAUA,EAAK,YAAY,KAAK,eAAiBxV,EAAcwV,EAAK,YAAY,KAAK,cAAc,EAAI,OACvG,OAAM,GACN,YAAa,GACb,gBAAiB,GACjB,iBAAiB,kBACjB,QAAS,IAAMwD,GAAmBxD,EAAK,OAAO,EAC9C,oBAAqB,IARhB,GAAG0D,EAAS,UAUzB,EAEH1D,EAAK,cAAc,MAChBnT,MAAC,OAAI,UAAU,qCACX,SAAAA,MAACyD,GAAA,CAEG,KAAM0P,EAAK,aAAa,KACxB,SAAUA,EAAK,aAAa,KAAK,eAAiBxV,EAAcwV,EAAK,aAAa,KAAK,cAAc,EAAI,OACzG,OAAM,GACN,YAAa,GACb,gBAAiB,GACjB,QAAS,IAAMwD,GAAmBxD,EAAK,OAAO,EAC9C,oBAAqB,IAPhB,GAAG0D,EAAS,UAQrB,CACJ,GAER,EACJ,CAER,EAAG,CAACN,GAAyBD,GAAyB3Y,EAAegZ,EAAkB,CAAC,EAGlFG,GAAkB5U,cAAaiR,GAAuB,CAExDsD,GAAmBtD,CAAI,EAEnB9B,GACAA,EAAY8B,EAAK,OAAO,CAEhC,EAAG,CAAC9B,EAAaoF,EAAkB,CAAC,EA0BpC,GAvBA1U,YAAU,IAAM,CACZ,MAAMqN,EAAiBhyB,IAAqB,CACxC,GAAIA,GAAE,MAAQ,SAAU,CAEpB,GAAIw1B,EAAgB,QAAS,CACzBZ,EAAgB,IAAI,EACpBF,EAAiB,IAAI,EACrBR,IAAoB,EAAK,EACzBC,IAAc,IAAI,EAClBC,IAAa,IAAI,EACjB,MACJ,CAEI5D,GACAA,EAAA,CAER,CACJ,EAEA,cAAO,iBAAiB,UAAWwB,CAAa,EACzC,IAAM,OAAO,oBAAoB,UAAWA,CAAa,CACpE,EAAG,CAACxB,EAAS0D,EAAmBC,EAAaC,CAAU,CAAC,EAEpD,CAACS,EAAM,OACP,OAAO,KAIX,MAAM8E,GAAiB9E,EAAM,OAAO,CAACvgB,EAAKyhB,MACjCzhB,EAAIyhB,GAAK,OAAO,IACjBzhB,EAAIyhB,GAAK,OAAO,EAAI,IAExBzhB,EAAIyhB,GAAK,OAAO,EAAE,KAAKA,EAAI,EACpBzhB,GACR,EAAoC,EAGjCslB,GAAgB/D,IAAcD,GAEpC,OACIjT,OAAC,OAAI,UAAU,cAAc,QAAS2W,GAClC,UAAA3W,OAAC,OACG,IAAK2S,EACL,UAAU,mBACV,MAAO,CAAE,MAAO,OAAQ,OAAQ,OAAQ,SAAU,WAAY,IAAK,EAAG,KAAM,EAAG,cAAe,QAE9F,UAAA3S,OAAC,QAEG,UAAAA,OAAC,UAAO,GAAG,aAAa,EAAE,QAAQ,EAAE,QAAQ,MAAM,OAAO,OAAO,OAC5D,UAAAC,MAAC,kBAAe,aAAa,IAAI,OAAO,QAAQ,EAChDA,MAAC,kBAAe,aAAa,IAAI,OAAO,QAAQ,EAChDA,MAAC,iBAAc,GAAG,QAAQ,KAAK,SAAS,OAAO;AAAA;AAAA;AAAA;AAAA,uCAIhC,OAAO,aAAa,SAClC,WACG,UAAAA,MAAC,eAAY,GAAG,aAAa,EAC7BA,MAAC,eAAY,GAAG,QAAQ,EACxBA,MAAC,eAAY,GAAG,gBAAgB,GACpC,GACJ,EAGAD,OAAC,UAAO,GAAG,WAAW,EAAE,QAAQ,EAAE,QAAQ,MAAM,OAAO,OAAO,OAC1D,UAAAC,MAAC,gBAAa,KAAK,eAAe,cAAc,IAAI,WAAW,IAAI,OAAO,QAAQ,KAAK,IAAI,EAC3FA,MAAC,qBAAkB,GAAG,gBAAgB,IAAI,QAAQ,MAAM,MAAM,OAAO,eAAe,QACnF,kBAAe,GAAG,eAAe,aAAa,IAAI,OAAO,OAAO,EACjEA,MAAC,iBAAc,GAAG,OAAO,KAAK,SAAS,OAAO;AAAA;AAAA;AAAA;AAAA,uCAI/B,OAAO,WAAW,SAChC,WACG,UAAAA,MAAC,eAAY,GAAG,WAAW,EAC3BA,MAAC,eAAY,GAAG,gBAAgB,GACpC,GACJ,EAGAD,OAAC,UAAO,GAAG,YAAY,EAAE,OAAO,EAAE,OAAO,MAAM,OAAO,OAAO,OACzD,UAAAC,MAAC,kBAAe,aAAa,IAAI,OAAO,OAAO,SAC9C,WACG,UAAAA,MAAC,eAAY,GAAG,OAAO,EACvBA,MAAC,eAAY,GAAG,gBAAgB,GACpC,GACJ,EAGAD,OAAC,UAAO,GAAG,cAAc,EAAE,OAAO,EAAE,OAAO,MAAM,OAAO,OAAO,OAC3D,UAAAC,MAAC,kBAAe,aAAa,IAAI,OAAO,QAAQ,EAChDA,MAAC,kBAAe,aAAa,IAAI,OAAO,QAAQ,EAChDA,MAAC,iBAAc,GAAG,QAAQ,KAAK,SAAS,OAAO;AAAA;AAAA;AAAA;AAAA,uCAIhC,OAAO,UAAU,SAC/B,WACG,UAAAA,MAAC,eAAY,GAAG,UAAU,EAC1BA,MAAC,eAAY,GAAG,QAAQ,EACxBA,MAAC,eAAY,GAAG,gBAAgB,GACpC,GACJ,EAGAD,OAAC,UAAO,GAAG,cAAc,EAAE,OAAO,EAAE,OAAO,MAAM,OAAO,OAAO,OAC3D,UAAAC,MAAC,kBAAe,aAAa,IAAI,OAAO,OAAO,SAC9C,WACG,UAAAA,MAAC,eAAY,GAAG,OAAO,EACvBA,MAAC,eAAY,GAAG,gBAAgB,GACpC,GACJ,EAGAD,OAAC,UAAO,GAAG,iBAAiB,EAAE,QAAQ,EAAE,QAAQ,MAAM,OAAO,OAAO,OAChE,UAAAC,MAAC,kBAAe,aAAa,IAAI,OAAO,QAAQ,EAChDA,MAAC,kBAAe,aAAa,KAAK,OAAO,QAAQ,EACjDA,MAAC,iBAAc,GAAG,QAAQ,KAAK,SAAS,OAAO;AAAA;AAAA;AAAA;AAAA,uCAIhC,OAAO,WAAW,EACjCA,MAAC,iBAAc,GAAG,QAAQ,KAAK,SAAS,OAAO;AAAA;AAAA;AAAA;AAAA,yCAI9B,OAAO,cAAc,SACrC,WACG,UAAAA,MAAC,eAAY,GAAG,cAAc,EAC9BA,MAAC,eAAY,GAAG,WAAW,EAC3BA,MAAC,eAAY,GAAG,gBAAgB,GACpC,GACJ,EAEAD,OAAC,kBAAe,GAAG,qBAAqB,GAAG,KAAK,GAAG,KAAK,GAAG,OAAO,GAAG,KACjE,UAAAC,MAAC,QAAK,OAAO,KAAK,UAAU,UAAU,EACtCA,MAAC,QAAK,OAAO,OAAO,UAAU,UAAU,GAC5C,EAGC,OAAO,QAAQ+W,EAAc,EAAE,IAAI,CAAC,CAACplB,EAASslB,EAAc,IACzDA,GAAe,IAAI,CAAC9D,GAAMp5B,KAAU,CAChC,MAAMm9B,GAAS,QAAQvlB,CAAO,IAAI5X,EAAK,GAEjCo9B,GAAShE,GAAK,OAAS,QAAaA,GAAK,OAAS,OAClDiE,GAAKD,GAAShE,GAAK,KAAQA,GAAK,QAChCkE,GAAKF,GAAShE,GAAK,KAAQA,GAAK,QAChCmE,GAAKnE,GAAK,QACVoE,GAAKpE,GAAK,QACVqE,GAAY3G,GAAelf,CAAO,GAAK,OACvC8lB,GAAYD,GAElB,OACIzX,OAAC,kBAEG,GAAImX,GACJ,cAAc,iBACd,GAAIE,GAAI,GAAIC,GACZ,GAAIC,GAAI,GAAIC,GAGZ,UAAAvX,MAAC,QAAK,OAAO,KAAK,UAAWwX,GAAW,YAAa,EAAG,QACvD,QAAK,OAAO,MAAM,UAAWA,GAAW,YAAa,GAAK,QAC1D,QAAK,OAAO,OAAO,UAAAC,GAAsB,YAAa,GAAK,IATvDP,EAAA,CAYjB,CAAC,EACL,EACJ,EAGC,OAAO,KAAKrG,EAAc,EAAE,IAAIlf,GAAW,CACxC,MAAMslB,GAAiBhF,EAAM,OAAO/hB,IAAKA,GAAE,UAAYyB,CAAO,EAC9D,GAAIslB,GAAe,SAAW,EAAG,OAAO,KAExC,MAAMS,GAAYT,GAAe,CAAC,EAC5BE,GAASO,GAAU,OAAS,QAAaA,GAAU,OAAS,OAE5DrC,GAAUqC,GAAU,QACpBpC,GAAUoC,GAAU,QACpBC,GAAcD,GAAU,YACxBE,GAAOF,GAAU,MAAQrC,GACzBwC,GAAOH,GAAU,MAAQpC,GACzBwC,GAAWJ,GAAU,UAAYC,GACjCI,GAAaL,GAAU,YAAc,EAE3C,cACK,KAEI,UAAAP,UACI,KAAE,MAAO,CAAE,QAASY,EAAA,EAChB,cACL,EAIHd,GAAe,IAAI,CAAC9D,GAAMp5B,KAAU,CAIjC,MAAMi+B,GAFgB,KAAK,IAAI,EAAG7F,EAAoBF,EAAM,QAAUl4B,GAAQ,EAAE,EAE3Cs4B,EAC/B2C,GAAYhC,KAAgBG,GAE5B8E,GAAiBjF,KAAgB,KAGjCkF,GAAiBf,GAASS,GAAOvC,GACjC8C,GAAiBhB,GAASU,GAAOvC,GACjC8C,GAAqBjB,GAASW,GAAWH,GAI/C,IAAIU,GAAUlF,GAAK,oBAAsBd,EACzC,OAAI4F,IAAkB,CAACjD,KACnBqD,IAAW,UAIV,KAAgE,MAAO,CAAE,QAAAA,EAAA,EAEpE,cAAM,CACJ,MAAMC,GAAWlD,GAAY,CACzB,GAAGjC,GACH,QAAS+E,GACT,QAASC,GACT,YAAaC,EAAA,EACd,CAAC,EAEJ,OACIrY,OAAAwY,WAAA,CAII,UAAAvY,MAAC,UACG,GAAImT,GAAK,QACT,GAAIA,GAAK,QACT,EAAG,KAAK,IAAI,EAAG,GAAKA,GAAK,WAAW,EACpC,KAAK,cACL,MAAO,CAAE,OAAQ,UAAW,cAAe,QAC3C,eAAgB,IAAMiD,GAAqBjD,EAAI,EAC/C,eAAgBkD,GAChB,QAAUj5B,IAAM,CACZA,GAAE,kBACF05B,GAAgB3D,EAAI,CACxB,IAIH6E,KAAiB,IAAM,IAAM,CAC1B,MAAMQ,GAAYxD,GAAY,IAAM,GAC9ByD,GAAc,CAAC,EAAE5G,GAAiBE,GAClC2G,GAAmB1D,IAAcjD,GAAc,YAAcoB,GAAK,QAAQ,WAAapB,GAAc,aAAeoB,GAAK,WAE/H,IAAIwF,GAAc3D,GAAY,GAAM,GAKpC,OAJIyD,IAAe,CAACC,KAChBC,IAAe,KAGXxF,GAAK,SACT,IAAK,QACD,OACIpT,OAAAwY,WAAA,CACI,UAAAvY,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,EAAG,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,EAChK3Y,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,EAAG,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,QAC/J,QAAK,EAAGL,GAAU,OAAO,UAAU,YAAaE,GAAW,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAa,MAAO,CAAE,cAAe,OAAO,CAAG,GAC1J,EAER,IAAK,MACD,OACI5Y,OAAAwY,WAAA,CACI,UAAAvY,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,IAAK,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,EAClK3Y,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,IAAK,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,QACjK,QAAK,EAAGL,GAAU,OAAO,UAAU,YAAaE,GAAW,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAa,MAAO,CAAE,cAAe,OAAO,CAAG,GAC1J,EAER,IAAK,SACD,OACI5Y,OAAAwY,WAAA,CACI,UAAAvY,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,EAAG,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,EAChK3Y,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,IAAK,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,QACjK,QAAK,EAAGL,GAAU,OAAO,UAAU,YAAaE,GAAY,GAAK,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAa,MAAO,CAAE,cAAe,OAAO,CAAG,GAChK,EAER,IAAK,OACD,OACI5Y,OAAAwY,WAAA,CACI,UAAAvY,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,EAAG,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,EAChK3Y,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,EAAG,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,QAC/J,QAAK,EAAGL,GAAU,OAAO,UAAU,YAAaE,GAAW,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAa,MAAO,CAAE,cAAe,OAAO,CAAG,GAC1J,EAER,IAAK,YACD,OACI5Y,OAAAwY,WAAA,CACI,UAAAvY,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,EAAG,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,EAChK3Y,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,EAAG,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,EAChK3Y,MAAC,QAAK,EAAGsY,GAAU,OAAO,UAAU,YAAaE,GAAY,IAAK,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,QAAU,QACjK,QAAK,EAAGL,GAAU,OAAO,UAAU,YAAaE,GAAW,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAa,MAAO,CAAE,cAAe,OAAO,CAAG,GAC1J,EAER,QACI,OACI5Y,OAAAwY,WAAA,CACI,UAAAvY,MAAC,QAAK,EAAGsY,GAAU,OAAQzH,GAAesC,GAAK,OAAO,EAAG,YAAaqF,GAAY,EAAG,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAc,GAAK,MAAO,CAAE,cAAe,OAAO,CAAG,EACrL3Y,MAAC,QAAK,EAAGsY,GAAU,OAAQzH,GAAesC,GAAK,OAAO,EAAG,YAAaqF,GAAW,KAAK,OAAO,cAAc,QAAQ,QAASG,GAAa,MAAO,CAAE,cAAe,OAAO,CAAG,GAC/K,EAGhB,IAAG,EACP,CAER,IAAG,EA7FC,GAAGxF,GAAK,QAAQ,SAAS,IAAIA,GAAK,UAAU,IAAIp5B,EAAK,EAgG7D,CAER,CAAC,IAjIG,iBAAiB4X,CAAO,EAkIhC,CAER,CAAC,KAIJqlB,KAAkB,IAAM,CAErB,IAAI4B,EACJ,GAAI3F,GAAY,CAEZ,IAAI4F,GAAO7B,GAAc,QACrB8B,GAAO9B,GAAc,QAAU,GAGnC,MAAM+B,GAAgB,IAClBD,GAAOC,GAAgB,EAAI,MAAKD,GAAO,IAAMC,GAAgB,GAC7DD,GAAOC,GAAgB,EAAI,OAAO,YAAc,KAAID,GAAO,OAAO,YAAc,GAAKC,GAAgB,GAEzGH,EAAe,CACX,KAAM,GAAGC,EAAI,KACb,IAAK,GAAGC,EAAI,KACZ,OAAQ,OACR,UAAW,oCAEnB,MAEIF,EAAe,CACX,KAAM,MACN,OAAQ,OACR,IAAK,QAIb,OACI5Y,MAAC,OACG,UAAW,gFAAgFgX,GAAc,OAAO,GAAG/D,GAAa,iDAAmD,EAAE,GACrL,MAAO2F,EACP,QAAUx7B,IAAMA,GAAE,kBAClB,aAAc,IAAM,CAEZ01B,GAAkB,UAClB,aAAaA,GAAkB,OAAO,EACtCA,GAAkB,QAAU,KAEpC,EACA,aAAcuD,GAEb,YAAqBW,EAAa,GAG/C,KAICzE,GACGvS,MAAC0N,GAAA,CACG,QAAS6E,EACT,QAASE,GACT,QAAU9E,GAAY,CAClB8E,GAAA,EAEItB,GACAA,EAAexD,CAAO,CAE9B,GACJ,EAER,CAER,CC1jCA,MAAMqL,OAAsB,IAK5B,SAASC,GAAqBC,EAAsB,CAChD,OAAOA,EACF,cACA,OACA,QAAQ,SAAU,EAAE,EACpB,QAAQ,eAAgB,EAAE,EAC1B,QAAQ,OAAQ,GAAG,CAC5B,CAKA,SAASC,GAAextB,EAAsC,CAC1D,MAAMghB,EAAasM,GAAqBttB,CAAQ,EAGhD,GAAIqtB,GAAgB,IAAIrM,CAAU,EAC9B,OAAOqM,GAAgB,IAAIrM,CAAU,EAIzC,MAAM91B,EAAQkI,EAAgB,WACxB,CAAE,mBAAAod,EAAoB,qBAAAD,EAAsB,eAAAE,CAAA,EAAmBvlB,EAG/DuiC,MAAe,IAErB,UAAWhZ,KAAa,OAAO,OAAOjE,CAAkB,EACpD,UAAWnc,KAAQogB,EAAW,CAC1B,MAAMjW,EAAMyD,EAAgB,QAAQ5N,EAAK,QAAQ,EAC7CmK,GAAK,mBAAmB,MACxBivB,EAAS,IAAIp5B,EAAK,SAAUi5B,GAAqB9uB,EAAI,kBAAkB,IAAI,CAAC,CAEpF,CAGJ,UAAW0iB,KAAa,OAAO,OAAO3Q,CAAoB,EACtD,UAAWlc,KAAQ6sB,EAAW,CAC1B,MAAM1iB,EAAMyD,EAAgB,QAAQ5N,EAAK,QAAQ,EAC7CmK,GAAK,mBAAmB,MACxBivB,EAAS,IAAIp5B,EAAK,SAAUi5B,GAAqB9uB,EAAI,kBAAkB,IAAI,CAAC,CAEpF,CAGJ,UAAWnK,KAAQoc,EAAgB,CAC/B,MAAMjS,EAAMyD,EAAgB,QAAQ5N,EAAK,QAAQ,EAC7CmK,GAAK,mBAAmB,MACxBivB,EAAS,IAAIp5B,EAAK,SAAUi5B,GAAqB9uB,EAAI,kBAAkB,IAAI,CAAC,CAEpF,CAGA,SAAW,CAAC/F,EAAMK,CAAI,IAAK20B,EAAS,UAChC,GAAI30B,IAASkoB,EACT,OAAAqM,GAAgB,IAAIrM,EAAYvoB,CAAI,EAC7BA,EAKf,SAAW,CAACA,EAAMK,CAAI,IAAK20B,EAAS,UAChC,GAAI30B,EAAK,WAAWkoB,CAAU,EAC1B,OAAAqM,GAAgB,IAAIrM,EAAYvoB,CAAI,EAC7BA,EAKf,GAAIuoB,EAAW,QAAU,GACrB,SAAW,CAACvoB,EAAMK,CAAI,IAAK20B,EAAS,UAGhC,GAFc30B,EAAK,MAAM,KAAK,EACR,QAAa40B,EAAK,WAAW1M,CAAU,CAAC,EAE1D,OAAAqM,GAAgB,IAAIrM,EAAYvoB,CAAI,EAC7BA,EAMnB,GAAIuoB,EAAW,QAAU,GACrB,SAAW,CAACvoB,EAAMK,CAAI,IAAK20B,EAAS,UAChC,GAAI30B,EAAK,SAASkoB,CAAU,EACxB,OAAAqM,GAAgB,IAAIrM,EAAYvoB,CAAI,EAC7BA,EAMvB,CAMA,eAAsBk1B,GAAe7oB,EAAoD,CACrF,MAAM5Z,EAAQkI,EAAgB,WACxB,CAAE,qBAAAmd,EAAsB,mBAAAC,EAAoB,eAAAC,EAAgB,oBAAAmd,GAAwB1iC,EAEpFsT,EAAMyD,EAAgB,QAAQ6C,CAAQ,EAC5C,GAAI,CAACtG,EAAK,OAAO,KAGjB,GAAIovB,EAAqB,CACrB,MAAMvkB,EAAKmH,EAAmBod,CAAmB,GAAK,GAChDvf,EAAMkC,EAAqBqd,CAAmB,GAAK,GAEnDC,EAAUxkB,EAAG,KAAK7b,GAAKA,EAAE,WAAasX,CAAQ,EACpD,GAAI+oB,EAAS,MAAO,CAAE,KAAMA,EAAS,WAAYrvB,EAAK,SAAU,WAAY,YAAaovB,CAAA,EAEzF,MAAME,EAAWzf,EAAI,KAAK7gB,GAAKA,EAAE,WAAasX,CAAQ,EACtD,GAAIgpB,EAAU,MAAO,CAAE,KAAMA,EAAU,WAAYtvB,EAAK,SAAU,YAAa,YAAaovB,CAAA,CAChG,CAGA,SAAW,CAACl5B,EAAQ+f,CAAS,IAAK,OAAO,QAAQjE,CAAkB,EAAG,CAClE,GAAI9b,IAAWk5B,EAAqB,SACpC,MAAMlc,EAAQ+C,EAAU,KAAKpgB,GAAQA,EAAK,WAAayQ,CAAQ,EAC/D,GAAI4M,EAAO,MAAO,CAAE,KAAMA,EAAO,WAAYlT,EAAK,SAAU,WAAY,YAAa9J,CAAA,CACzF,CAEA,SAAW,CAACA,EAAQwsB,CAAS,IAAK,OAAO,QAAQ3Q,CAAoB,EAAG,CACpE,GAAI7b,IAAWk5B,EAAqB,SACpC,MAAMlc,EAAQwP,EAAU,KAAK7sB,GAAQA,EAAK,WAAayQ,CAAQ,EAC/D,GAAI4M,EAAO,MAAO,CAAE,KAAMA,EAAO,WAAYlT,EAAK,SAAU,YAAa,YAAa9J,CAAA,CAC1F,CAGA,MAAMq5B,EAAYtd,EAAe,KAAKpc,GAAQA,EAAK,WAAayQ,CAAQ,EACxE,OAAIipB,EAAkB,CAAE,KAAMA,EAAW,WAAYvvB,EAAK,SAAU,SAE7D,IACX,CAKA,eAAsBwvB,GAAehuB,EAAoD,CACrF,MAAMmE,EAAaqpB,GAAextB,CAAQ,EAC1C,OAAKmE,EAKEwpB,GAAexpB,CAAU,EAJrB,IAKf,CAKA,eAAsB8pB,GAAmBjuB,EAA+C,CACpF,MAAM9U,EAAQkI,EAAgB,WACxB,CAAE,qBAAAmd,EAAsB,mBAAAC,EAAoB,eAAAC,CAAA,EAAmBvlB,EAC/DkQ,EAA8B,GAE9B+I,EAAaqpB,GAAextB,CAAQ,EAC1C,GAAI,CAACmE,EAAY,OAAO/I,EAExB,MAAMoD,EAAMyD,EAAgB,QAAQkC,CAAU,EAC9C,GAAI,CAAC3F,EAAK,OAAOpD,EAGjB,SAAW,CAAC1G,EAAQ+f,CAAS,IAAK,OAAO,QAAQjE,CAAkB,EAC/D,UAAWnc,KAAQogB,EACXpgB,EAAK,WAAa8P,GAClB/I,EAAQ,KAAK,CAAE,KAAA/G,EAAM,WAAYmK,EAAK,SAAU,WAAY,YAAa9J,EAAQ,EAM7F,SAAW,CAACA,EAAQwsB,CAAS,IAAK,OAAO,QAAQ3Q,CAAoB,EACjE,UAAWlc,KAAQ6sB,EACX7sB,EAAK,WAAa8P,GAClB/I,EAAQ,KAAK,CAAE,KAAA/G,EAAM,WAAYmK,EAAK,SAAU,YAAa,YAAa9J,EAAQ,EAM9F,UAAWL,KAAQoc,EACXpc,EAAK,WAAa8P,GAClB/I,EAAQ,KAAK,CAAE,KAAA/G,EAAM,WAAYmK,EAAK,SAAU,QAAS,EAIjE,OAAOpD,CACX,CAKA,eAAsB8yB,GAClBC,EACAC,EAAmC,QACR,CAC3B,MAAMljC,EAAQkI,EAAgB,WACxB,CAAE,qBAAAmd,EAAsB,mBAAAC,EAAoB,eAAAC,CAAA,EAAmBvlB,EAC/DkQ,EAA8B,GAE9BizB,EAAc,CAACh6B,EAAmBi6B,EAA8C55B,IAAoB,CACtG,MAAM8J,EAAMyD,EAAgB,QAAQ5N,EAAK,QAAQ,EAKjD,GAJI,CAACmK,GAIDA,EAAI,WAAW,WAAa,EAAG,OAInC,MAAM+vB,EAAeH,IAAiB,QAAU,EAAI,EAChD5vB,EAAI,WAAa+vB,IAIjB/vB,EAAI,YAAc,GAAKA,EAAI,YAAc2vB,GAE7C/yB,EAAQ,KAAK,CAAE,KAAA/G,EAAM,WAAYmK,EAAK,SAAA8vB,EAAU,YAAa55B,EAAQ,EACzE,EAGA,SAAW,CAACA,EAAQ+f,CAAS,IAAK,OAAO,QAAQjE,CAAkB,EAC/DiE,EAAU,QAAQpgB,GAAQg6B,EAAYh6B,EAAM,WAAYK,CAAM,CAAC,EAInE,SAAW,CAACA,EAAQwsB,CAAS,IAAK,OAAO,QAAQ3Q,CAAoB,EACjE2Q,EAAU,QAAQ7sB,GAAQg6B,EAAYh6B,EAAM,YAAaK,CAAM,CAAC,EAIpE,OAAA+b,EAAe,QAAQpc,GAAQg6B,EAAYh6B,EAAM,OAAO,CAAC,EAElD+G,CACX,CAKA,eAAsBozB,GAAQxuB,EAAoC,CAE9D,OADe,MAAMguB,GAAehuB,CAAQ,IAC1B,IACtB,CAKO,SAASyuB,IAA6B,CACzCpB,GAAgB,OACpB,CAKO,SAASqB,GAAuB1uB,EAAsC,CACzE,MAAM9U,EAAQkI,EAAgB,WACxB,CAAE,qBAAAmd,EAAsB,mBAAAC,EAAoB,eAAAC,CAAA,EAAmBvlB,EAC/DkQ,EAA8B,GAE9B+I,EAAaqpB,GAAextB,CAAQ,EAC1C,GAAI,CAACmE,EAAY,OAAO/I,EAExB,MAAMoD,EAAMyD,EAAgB,QAAQkC,CAAU,EAC9C,GAAI,CAAC3F,EAAK,OAAOpD,EAGjB,SAAW,CAAC1G,EAAQ+f,CAAS,IAAK,OAAO,QAAQjE,CAAkB,EAC/D,UAAWnc,KAAQogB,EACXpgB,EAAK,WAAa8P,GAClB/I,EAAQ,KAAK,CAAE,KAAA/G,EAAM,WAAYmK,EAAK,SAAU,WAAY,YAAa9J,EAAQ,EAM7F,SAAW,CAACA,EAAQwsB,CAAS,IAAK,OAAO,QAAQ3Q,CAAoB,EACjE,UAAWlc,KAAQ6sB,EACX7sB,EAAK,WAAa8P,GAClB/I,EAAQ,KAAK,CAAE,KAAA/G,EAAM,WAAYmK,EAAK,SAAU,YAAa,YAAa9J,EAAQ,EAM9F,UAAWL,KAAQoc,EACXpc,EAAK,WAAa8P,GAClB/I,EAAQ,KAAK,CAAE,KAAA/G,EAAM,WAAYmK,EAAK,SAAU,QAAS,EAIjE,OAAOpD,CACX,CAEO,MAAMuzB,GAAoB,CAC7B,eAAAhB,GACA,eAAAK,GACA,mBAAAC,GACA,uBAAAS,GACA,uBAAAR,GACA,QAAAM,GACA,qBAAAC,EACJ,ECzTaG,GAA2C,CAEtD,CACE,GAAI,2BACJ,KAAM,iBACN,QAASvjC,EAAY,MACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM4sB,GAAmB,iBACzB,KAAM,mBACN,KAAM1sB,EAAS,OAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,QAC5B,KAAM,WAGR,oBAAqBI,EAAgB,MAAM,QAAQ,SAAS,MAC5D,aAAc,CACZ,UAAWA,EAAgB,MAAM,MAAM,MAAM,cAC7C,UAAW,gBACX,aAAc,CACZA,EAAgB,MAAM,MAAM,QAAQ,aACpCA,EAAgB,MAAM,MAAM,QAAQ,gBAEtC,YAAa,CAAC,eAAgB,gBAAgB,EAC9C,eAAgB,CACdA,EAAgB,MAAM,UAAU,gBAChCA,EAAgB,MAAM,UAAU,kBAChCA,EAAgB,MAAM,UAAU,eAChCA,EAAgB,MAAM,UAAU,mBAElC,cAAe,CAAC,kBAAmB,oBAAqB,iBAAkB,mBAAmB,EAC7F,YAAaA,EAAgB,MAAM,MAAM,SAAS,SAClD,YAAa,mBACb,UAAWA,EAAgB,MAAM,MAAM,MAAM,gBAC7C,UAAW,kBACX,iBAAkBA,EAAgB,MAAM,MAAM,gBAAgB,gBAC9D,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,MAAM,MAAM,UAC5C,SAAU,aAEZ,WAAY,CACV,SAAUC,GAAa,aACvB,SAAU,eACV,YAAa,CAAC,MAAO,cAAe,aAAa,GAEnD,gBACE,gKACF,UACE,2HACF,WAAY7sB,EAAW,SACvB,KAAM,CAAC,gBAAiB,eAAgB,gBAAiB,WAAW,GACnE,CACD,GAAI,6BACJ,KAAM,oBACN,QAASJ,EAAY,IACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,YAC7B,YAAa,CACX,KAAM4sB,GAAmB,4BACzB,KAAM,8BACN,KAAM1sB,EAAS,OAEjB,aAAc,CACZ,KAAMysB,GAAe,MAAM,YAC3B,KAAM,eAER,aAAc,CACZ,UAAWI,EAAgB,IAAI,MAAM,MAAM,aAC3C,UAAW,eACX,aAAc,CACZA,EAAgB,IAAI,MAAM,QAAQ,iBAClCA,EAAgB,IAAI,MAAM,QAAQ,UAEpC,YAAa,CAAC,mBAAoB,UAAU,EAC5C,eAAgB,CACdA,EAAgB,IAAI,UAAU,mBAC9BA,EAAgB,IAAI,UAAU,eAC9BA,EAAgB,IAAI,UAAU,cAC9BA,EAAgB,IAAI,UAAU,mBAEhC,cAAe,CAAC,qBAAsB,iBAAkB,gBAAiB,mBAAmB,EAC5F,YAAaA,EAAgB,IAAI,MAAM,SAAS,MAChD,YAAa,gBACb,UAAWA,EAAgB,IAAI,MAAM,MAAM,YAC3C,UAAW,cACX,iBAAkBA,EAAgB,IAAI,MAAM,gBAAgB,SAC5D,iBAAkB,WAClB,SAAUA,EAAgB,IAAI,MAAM,MAAM,UAC1C,SAAU,aAEZ,gBACE,iJACF,UACE,wFACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,WAAY,eAAgB,UAAW,QAAQ,GACrD,CACD,GAAI,0BACJ,KAAM,eACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM6sB,GAAoB,aAC1B,KAAM,iBACN,KAAM3sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,QAC5B,KAAM,WAGR,oBAAqBI,EAAgB,MAAM,QAAQ,SAAS,MAC5D,aAAc,CACZ,UAAWA,EAAgB,MAAM,OAAO,MAAM,cAC9C,UAAW,gBACX,aAAc,CACZA,EAAgB,MAAM,OAAO,QAAQ,cACrCA,EAAgB,MAAM,OAAO,QAAQ,cAEvC,YAAa,CAAC,iBAAkB,cAAc,EAC9C,eAAgB,CACdA,EAAgB,MAAM,UAAU,iBAChCA,EAAgB,MAAM,UAAU,gBAChCA,EAAgB,MAAM,UAAU,eAChCA,EAAgB,MAAM,UAAU,eAElC,cAAe,CAAC,mBAAoB,kBAAmB,iBAAkB,eAAe,EACxF,UAAWA,EAAgB,MAAM,OAAO,MAAM,YAC9C,UAAW,cACX,YAAaA,EAAgB,MAAM,OAAO,SAAS,SACnD,YAAa,mBACb,iBAAkBA,EAAgB,MAAM,OAAO,gBAAgB,gBAC/D,iBAAkB,mBAClB,SAAUA,EAAgB,MAAM,OAAO,MAAM,YAC7C,SAAU,eAEZ,WAAY,CACV,SAAUC,GAAa,aACvB,SAAU,eACV,YAAa,CAAC,cAAe,KAAK,GAEpC,gBACE,iHACF,UACE,0GACF,WAAY7sB,EAAW,aACvB,KAAM,CAAC,eAAgB,WAAY,YAAa,KAAK,GACpD,CACD,GAAI,yBACJ,KAAM,kBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM8sB,GAAqB,kBAC3B,KAAM,oBACN,KAAM5sB,EAAS,OAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,QAC5B,KAAM,WAGR,oBAAqBI,EAAgB,MAAM,QAAQ,SAAS,MAC5D,aAAc,CACZ,UAAWA,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,aAAc,CACZA,EAAgB,MAAM,QAAQ,QAAQ,eACtCA,EAAgB,MAAM,QAAQ,QAAQ,aAExC,YAAa,CAAC,iBAAkB,aAAa,EAC7C,eAAgB,CACdA,EAAgB,MAAM,UAAU,iBAChCA,EAAgB,MAAM,UAAU,gBAChCA,EAAgB,MAAM,UAAU,eAChCA,EAAgB,MAAM,UAAU,mBAElC,cAAe,CAAC,mBAAoB,kBAAmB,iBAAkB,mBAAmB,EAC5F,YAAaA,EAAgB,MAAM,QAAQ,SAAS,OACpD,YAAa,iBACb,UAAWA,EAAgB,MAAM,QAAQ,MAAM,eAC/C,UAAW,iBACX,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,gBAChE,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBACE,6IACF,UACE,wGACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,WAAY,eAAgB,UAAW,QAAQ,GACrD,CACD,GAAI,yBACJ,KAAM,eACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM4sB,GAAmB,YACzB,KAAM,cACN,KAAM1sB,EAAS,OAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,cAC7B,KAAM,iBAER,aAAc,CACZ,UAAWI,EAAgB,OAAO,MAAM,MAAM,cAC9C,UAAW,gBACX,aAAc,CACZA,EAAgB,OAAO,MAAM,QAAQ,iBACrCA,EAAgB,OAAO,MAAM,QAAQ,mBAEvC,YAAa,CAAC,mBAAoB,mBAAmB,EACrD,eAAgB,CACdA,EAAgB,OAAO,UAAU,kBACjCA,EAAgB,OAAO,UAAU,kBACjCA,EAAgB,OAAO,UAAU,gBACjCA,EAAgB,OAAO,UAAU,uBAEnC,cAAe,CAAC,oBAAqB,oBAAqB,kBAAmB,uBAAuB,EACpG,UAAWA,EAAgB,OAAO,MAAM,MAAM,cAC9C,UAAW,gBACX,YAAaA,EAAgB,OAAO,MAAM,SAAS,QACnD,YAAa,kBACb,iBAAkBA,EAAgB,OAAO,MAAM,gBAAgB,mBAC/D,iBAAkB,qBAClB,SAAUA,EAAgB,OAAO,MAAM,MAAM,UAC7C,SAAU,aAEZ,UACE,4GACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,YAAa,gBAAiB,cAAc,EACnD,gBAAiB,6GAEnB,CACE,GAAI,uBACJ,KAAM,eACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,UAC7B,YAAa,CACX,KAAM4sB,GAAmB,aACzB,KAAM,eACN,KAAM1sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,YAC5B,KAAM,eAER,aAAc,CACZ,UAAWI,EAAgB,OAAO,MAAM,MAAM,UAC9C,UAAW,YACX,aAAc,CACZA,EAAgB,OAAO,MAAM,QAAQ,aACrCA,EAAgB,OAAO,MAAM,QAAQ,eAEvC,YAAa,CAAC,eAAgB,eAAe,EAC7C,eAAgB,CACdA,EAAgB,OAAO,UAAU,kBACjCA,EAAgB,OAAO,UAAU,eACjCA,EAAgB,OAAO,UAAU,qBACjCA,EAAgB,OAAO,UAAU,sBAEnC,cAAe,CAAC,oBAAqB,iBAAkB,uBAAwB,sBAAsB,EACrG,UAAWA,EAAgB,OAAO,MAAM,MAAM,eAC9C,UAAW,iBACX,YAAaA,EAAgB,OAAO,MAAM,SAAS,QACnD,YAAa,kBACb,iBAAkBA,EAAgB,OAAO,MAAM,gBAAgB,gBAC/D,iBAAkB,kBAClB,SAAUA,EAAgB,OAAO,MAAM,MAAM,UAC7C,SAAU,aAEZ,UACE,8GACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,gBAAiB,UAAW,YAAY,EAC/C,gBAAiB,+GAInB,CACE,GAAI,qBACJ,KAAM,eACN,QAASJ,EAAY,IACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM6sB,GAAoB,aAC1B,KAAM,gBACN,KAAM3sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,WAC5B,KAAM,cAER,aAAc,CACZ,UAAWI,EAAgB,IAAI,OAAO,MAAM,gBAC5C,UAAW,kBACX,aAAc,CACZA,EAAgB,IAAI,OAAO,QAAQ,WACnCA,EAAgB,IAAI,OAAO,QAAQ,gBAErC,YAAa,CAAC,aAAc,gBAAgB,EAC5C,eAAgB,CACdA,EAAgB,IAAI,UAAU,eAC9BA,EAAgB,IAAI,UAAU,cAC9BA,EAAgB,IAAI,UAAU,mBAC9BA,EAAgB,IAAI,UAAU,mBAEhC,cAAe,CAAC,iBAAkB,gBAAiB,qBAAsB,mBAAmB,EAC5F,YAAaA,EAAgB,IAAI,OAAO,SAAS,KACjD,YAAa,eACb,UAAWA,EAAgB,IAAI,OAAO,MAAM,iBAC5C,UAAW,mBACX,iBAAkBA,EAAgB,IAAI,OAAO,gBAAgB,eAC7D,iBAAkB,kBAClB,SAAUA,EAAgB,IAAI,OAAO,MAAM,YAC3C,SAAU,eAEZ,UACE,4FACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,eAAgB,WAAY,MAAM,EACzC,gBAAiB,6FAEnB,CACE,GAAI,uBACJ,KAAM,aACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,YAC7B,YAAa,CACX,KAAM6sB,GAAoB,eAC1B,KAAM,iBACN,KAAM3sB,EAAS,QAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,YAC5B,KAAM,eAER,aAAc,CACZ,UAAWI,EAAgB,OAAO,OAAO,MAAM,mBAC/C,UAAW,qBACX,aAAc,CACZA,EAAgB,OAAO,OAAO,QAAQ,gBACtCA,EAAgB,OAAO,OAAO,QAAQ,gBAExC,YAAa,CAAC,kBAAmB,gBAAgB,EACjD,eAAgB,CACdA,EAAgB,OAAO,UAAU,mBACjCA,EAAgB,OAAO,UAAU,sBACjCA,EAAgB,OAAO,UAAU,mBACjCA,EAAgB,OAAO,UAAU,mBAEnC,cAAe,CAAC,qBAAsB,wBAAyB,qBAAsB,mBAAmB,EACxG,UAAWA,EAAgB,OAAO,OAAO,MAAM,gBAC/C,UAAW,kBACX,YAAaA,EAAgB,OAAO,OAAO,SAAS,UACpD,YAAa,oBACb,iBAAkBA,EAAgB,OAAO,OAAO,gBAAgB,gBAChE,iBAAkB,mBAClB,SAAUA,EAAgB,OAAO,OAAO,MAAM,YAC9C,SAAU,eAEZ,UACE,6GACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,MAAO,eAAgB,UAAU,EACxC,gBAAiB,8GAEnB,CACE,GAAI,4BACJ,KAAM,eACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,UAC7B,YAAa,CACX,KAAM6sB,GAAoB,mBAC1B,KAAM,uBACN,KAAM3sB,EAAS,QAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,kBAC7B,KAAM,qBAER,aAAc,CACZ,UAAWI,EAAgB,OAAO,OAAO,MAAM,WAC/C,UAAW,aACX,aAAc,CACZA,EAAgB,OAAO,OAAO,QAAQ,YACtCA,EAAgB,OAAO,OAAO,QAAQ,oBAExC,YAAa,CAAC,cAAe,oBAAoB,EACjD,eAAgB,CACdA,EAAgB,OAAO,UAAU,kBACjCA,EAAgB,OAAO,UAAU,qBACjCA,EAAgB,OAAO,UAAU,iBACjCA,EAAgB,OAAO,UAAU,gBAEnC,cAAe,CAAC,oBAAqB,uBAAwB,mBAAoB,gBAAgB,EACjG,YAAaA,EAAgB,OAAO,OAAO,SAAS,QACpD,YAAa,UACb,UAAWA,EAAgB,OAAO,OAAO,MAAM,eAC/C,UAAW,iBACX,iBAAkBA,EAAgB,OAAO,OAAO,gBAAgB,gBAChE,iBAAkB,mBAClB,SAAUA,EAAgB,OAAO,OAAO,MAAM,YAC9C,SAAU,eAEZ,UACE,qGACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,WAAY,gBAAiB,SAAS,EAC7C,gBAAiB,sGAInB,CACE,GAAI,oBACJ,KAAM,eACN,QAASJ,EAAY,IACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM8sB,GAAqB,kBAC3B,KAAM,oBACN,KAAM5sB,EAAS,QAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,WAC5B,KAAM,cAER,aAAc,CACZ,UAAWI,EAAgB,IAAI,QAAQ,MAAM,YAC7C,UAAW,cACX,aAAc,CACZA,EAAgB,IAAI,QAAQ,QAAQ,mBACpCA,EAAgB,IAAI,QAAQ,QAAQ,iBAEtC,YAAa,CAAC,qBAAsB,iBAAiB,EACrD,eAAgB,CACdA,EAAgB,IAAI,UAAU,cAC9BA,EAAgB,IAAI,UAAU,mBAC9BA,EAAgB,IAAI,UAAU,mBAC9BA,EAAgB,IAAI,UAAU,gBAEhC,cAAe,CAAC,gBAAiB,qBAAsB,qBAAsB,gBAAgB,EAC7F,YAAaA,EAAgB,IAAI,QAAQ,SAAS,MAClD,YAAa,gBACb,UAAWA,EAAgB,IAAI,QAAQ,MAAM,gBAC7C,UAAW,kBACX,iBAAkBA,EAAgB,IAAI,QAAQ,gBAAgB,aAC9D,iBAAkB,eAClB,SAAUA,EAAgB,IAAI,QAAQ,MAAM,YAC5C,SAAU,eAEZ,UACE,0GACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,eAAgB,YAAa,gBAAgB,EACpD,gBAAiB,2GAEnB,CACE,GAAI,4BACJ,KAAM,eACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,UAC7B,YAAa,CACX,KAAM8sB,GAAqB,wBAC3B,KAAM,0BACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,cAC7B,KAAM,iBAER,aAAc,CACZ,UAAWI,EAAgB,OAAO,QAAQ,MAAM,cAChD,UAAW,iBACX,aAAc,CACZA,EAAgB,OAAO,QAAQ,QAAQ,gBACvCA,EAAgB,OAAO,QAAQ,QAAQ,eAEzC,YAAa,CAAC,kBAAmB,eAAe,EAChD,eAAgB,CACdA,EAAgB,OAAO,UAAU,gBACjCA,EAAgB,OAAO,UAAU,kBACjCA,EAAgB,OAAO,UAAU,oBACjCA,EAAgB,OAAO,UAAU,uBAEnC,cAAe,CAAC,kBAAmB,oBAAqB,sBAAuB,uBAAuB,EACtG,YAAaA,EAAgB,OAAO,QAAQ,SAAS,SACrD,YAAa,mBACb,UAAWA,EAAgB,OAAO,QAAQ,MAAM,gBAChD,UAAW,kBACX,iBAAkBA,EAAgB,OAAO,QAAQ,gBAAgB,aACjE,iBAAkB,eAClB,SAAUA,EAAgB,OAAO,QAAQ,MAAM,YAC/C,SAAU,eAEZ,UACE,qHACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,eAAgB,eAAgB,SAAS,EAChD,gBAAiB,sHAInB,CACE,GAAI,+BACJ,KAAM,sBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM4sB,GAAmB,kBACzB,KAAM,oBACN,KAAM1sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,eAC7B,KAAM,kBAER,aAAc,CACZ,UAAWI,EAAgB,UAAU,MAAM,MAAM,iBACjD,UAAW,mBACX,aAAc,CACZA,EAAgB,UAAU,MAAM,QAAQ,aACxCA,EAAgB,UAAU,MAAM,QAAQ,UAE1C,YAAa,CAAC,eAAgB,UAAU,EACxC,eAAgB,CACdA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,oBACpCA,EAAgB,UAAU,UAAU,kBAEtC,cAAe,CAAC,gBAAiB,gBAAiB,sBAAuB,kBAAkB,EAC3F,YAAaA,EAAgB,UAAU,MAAM,SAAS,SACtD,YAAa,mBACb,UAAWA,EAAgB,UAAU,MAAM,MAAM,eACjD,UAAW,iBACX,iBAAkBA,EAAgB,UAAU,MAAM,gBAAgB,SAClE,iBAAkB,WAClB,SAAUA,EAAgB,UAAU,MAAM,MAAM,UAChD,SAAU,aAEZ,gBACE,gIACF,UACE,2GACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,eAAgB,cAAe,YAAa,WAAW,GAEhE,CACE,GAAI,4BACJ,KAAM,qBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM6sB,GAAoB,mBAC1B,KAAM,sBACN,KAAM3sB,EAAS,OAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,mBAC7B,KAAM,sBAER,aAAc,CACZ,UAAWI,EAAgB,UAAU,OAAO,MAAM,YAClD,UAAW,eACX,aAAc,CACZA,EAAgB,UAAU,OAAO,QAAQ,oBACzCA,EAAgB,UAAU,OAAO,QAAQ,kBAE3C,YAAa,CAAC,sBAAuB,kBAAkB,EACvD,eAAgB,CACdA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,oBACpCA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,eAEtC,cAAe,CAAC,gBAAiB,sBAAuB,gBAAiB,eAAe,EACxF,YAAaA,EAAgB,UAAU,OAAO,SAAS,UACvD,YAAa,oBACb,UAAWA,EAAgB,UAAU,OAAO,MAAM,WAClD,UAAW,aACX,iBAAkBA,EAAgB,UAAU,OAAO,gBAAgB,eACnE,iBAAkB,kBAClB,SAAUA,EAAgB,UAAU,OAAO,MAAM,YACjD,SAAU,eAEZ,gBACE,6GACF,UACE,4GACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,eAAgB,WAAY,gBAAiB,WAAW,GAEjE,CACE,GAAI,8BACJ,KAAM,gBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM8sB,GAAqB,WAC3B,KAAM,aACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,QAC5B,KAAM,WAGR,oBAAqBI,EAAgB,MAAM,QAAQ,SAAS,MAC5D,aAAc,CACZ,UAAWA,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,aAAc,CACZA,EAAgB,MAAM,QAAQ,QAAQ,eACtCA,EAAgB,MAAM,QAAQ,QAAQ,YAExC,YAAa,CAAC,iBAAkB,YAAY,EAC5C,eAAgB,CACdA,EAAgB,MAAM,UAAU,kBAChCA,EAAgB,MAAM,UAAU,eAChCA,EAAgB,MAAM,UAAU,kBAChCA,EAAgB,MAAM,UAAU,iBAElC,cAAe,CAAC,oBAAqB,iBAAkB,oBAAqB,iBAAiB,EAC7F,YAAaA,EAAgB,MAAM,QAAQ,SAAS,MACpD,YAAa,gBACb,UAAWA,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,aAChE,iBAAkB,eAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBACE,4HACF,UACE,kFACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,eAAgB,WAAY,YAAa,OAAO,GAGzD,CACE,GAAI,uBACJ,KAAM,gBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,UAC7B,YAAa,CACX,KAAM4sB,GAAmB,mBACzB,KAAM,qBACN,KAAM1sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,OAC5B,KAAM,UAER,aAAc,CACZ,UAAWI,EAAgB,MAAM,MAAM,MAAM,aAC7C,UAAW,eACX,aAAc,CACZA,EAAgB,MAAM,MAAM,QAAQ,aACpCA,EAAgB,MAAM,MAAM,QAAQ,gBAEtC,YAAa,CAAC,eAAgB,gBAAgB,EAC9C,eAAgB,CACdA,EAAgB,MAAM,UAAU,kBAChCA,EAAgB,MAAM,UAAU,eAChCA,EAAgB,MAAM,UAAU,cAChCA,EAAgB,MAAM,UAAU,kBAElC,cAAe,CAAC,oBAAqB,iBAAkB,gBAAiB,kBAAkB,EAC1F,YAAaA,EAAgB,MAAM,MAAM,SAAS,OAClD,YAAa,iBACb,UAAWA,EAAgB,MAAM,MAAM,MAAM,gBAC7C,UAAW,kBACX,iBAAkBA,EAAgB,MAAM,MAAM,gBAAgB,gBAC9D,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,MAAM,MAAM,UAC5C,SAAU,aAEZ,gBACE,8GACF,UACE,oGACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,eAAgB,WAAY,YAAa,OAAO,GAEzD,CACE,GAAI,uBACJ,KAAM,aACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM6sB,GAAoB,kBAC1B,KAAM,oBACN,KAAM3sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,gBAC5B,KAAM,mBAER,aAAc,CACZ,UAAWI,EAAgB,MAAM,OAAO,MAAM,cAC9C,UAAW,gBACX,aAAc,CACZA,EAAgB,MAAM,OAAO,QAAQ,cACrCA,EAAgB,MAAM,OAAO,QAAQ,kBAEvC,YAAa,CAAC,iBAAkB,kBAAkB,EAClD,eAAgB,CACdA,EAAgB,MAAM,UAAU,oBAChCA,EAAgB,MAAM,UAAU,eAChCA,EAAgB,MAAM,UAAU,gBAChCA,EAAgB,MAAM,UAAU,mBAElC,cAAe,CAAC,sBAAuB,iBAAkB,kBAAmB,mBAAmB,EAC/F,YAAaA,EAAgB,MAAM,OAAO,SAAS,SACnD,YAAa,mBACb,UAAWA,EAAgB,MAAM,OAAO,MAAM,YAC9C,UAAW,cACX,iBAAkBA,EAAgB,MAAM,OAAO,gBAAgB,eAC/D,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,OAAO,MAAM,YAC7C,SAAU,eAEZ,gBACE,8GACF,UACE,sHACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,aAAc,YAAa,eAAgB,OAAO,GAE3D,CACE,GAAI,wBACJ,KAAM,qBACN,QAASJ,EAAY,KACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM8sB,GAAqB,iBAC3B,KAAM,mBACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,eAC5B,KAAM,kBAER,aAAc,CACZ,UAAWI,EAAgB,KAAK,QAAQ,MAAM,UAC9C,UAAW,YACX,aAAc,CACZA,EAAgB,KAAK,QAAQ,QAAQ,iBACrCA,EAAgB,KAAK,QAAQ,QAAQ,eAEvC,YAAa,CAAC,mBAAoB,eAAe,EACjD,eAAgB,CACdA,EAAgB,KAAK,UAAU,oBAC/BA,EAAgB,KAAK,UAAU,kBAC/BA,EAAgB,KAAK,UAAU,oBAC/BA,EAAgB,KAAK,UAAU,oBAEjC,cAAe,CAAC,sBAAuB,oBAAqB,sBAAuB,oBAAoB,EACvG,YAAaA,EAAgB,KAAK,QAAQ,SAAS,QACnD,YAAa,kBACb,UAAWA,EAAgB,KAAK,QAAQ,MAAM,mBAC9C,UAAW,qBACX,iBAAkBA,EAAgB,KAAK,QAAQ,gBAAgB,gBAC/D,iBAAkB,kBAClB,SAAUA,EAAgB,KAAK,QAAQ,MAAM,YAC7C,SAAU,eAEZ,gBACE,+GACF,UACE,kHACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,eAAgB,eAAgB,SAAU,MAAM,GAEzD,CACE,GAAI,wBACJ,KAAM,kBACN,QAASJ,EAAY,KACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM6sB,GAAoB,mBAC1B,KAAM,sBACN,KAAM3sB,EAAS,OAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,YAC7B,KAAM,eAER,aAAc,CACZ,UAAWI,EAAgB,KAAK,OAAO,MAAM,oBAC7C,UAAW,uBACX,aAAc,CACZA,EAAgB,KAAK,OAAO,QAAQ,eACpCA,EAAgB,KAAK,OAAO,QAAQ,iBAEtC,YAAa,CAAC,iBAAkB,iBAAiB,EACjD,eAAgB,CACdA,EAAgB,KAAK,UAAU,kBAC/BA,EAAgB,KAAK,UAAU,oBAC/BA,EAAgB,KAAK,UAAU,mBAC/BA,EAAgB,KAAK,UAAU,qBAEjC,cAAe,CAAC,oBAAqB,sBAAuB,qBAAsB,qBAAqB,EACvG,YAAaA,EAAgB,KAAK,OAAO,SAAS,OAClD,YAAa,iBACb,UAAWA,EAAgB,KAAK,OAAO,MAAM,WAC7C,UAAW,aACX,iBAAkBA,EAAgB,KAAK,OAAO,gBAAgB,eAC9D,iBAAkB,kBAClB,SAAUA,EAAgB,KAAK,OAAO,MAAM,YAC5C,SAAU,eAEZ,gBACE,+GACF,UACE,2FACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,eAAgB,WAAY,eAAgB,MAAM,GAE3D,CACE,GAAI,yBACJ,KAAM,cACN,QAASJ,EAAY,IACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM4sB,GAAmB,aACzB,KAAM,eACN,KAAM1sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,WAC5B,KAAM,cAER,aAAc,CACZ,UAAWI,EAAgB,IAAI,MAAM,MAAM,eAC3C,UAAW,iBACX,aAAc,CACZA,EAAgB,IAAI,MAAM,QAAQ,iBAClCA,EAAgB,IAAI,MAAM,QAAQ,YAEpC,YAAa,CAAC,mBAAoB,YAAY,EAC9C,eAAgB,CACdA,EAAgB,IAAI,UAAU,eAC9BA,EAAgB,IAAI,UAAU,cAC9BA,EAAgB,IAAI,UAAU,kBAC9BA,EAAgB,IAAI,UAAU,mBAEhC,cAAe,CAAC,iBAAkB,gBAAiB,oBAAqB,mBAAmB,EAC3F,YAAaA,EAAgB,IAAI,MAAM,SAAS,MAChD,YAAa,gBACb,UAAWA,EAAgB,IAAI,MAAM,MAAM,YAC3C,UAAW,cACX,iBAAkBA,EAAgB,IAAI,MAAM,gBAAgB,SAC5D,iBAAkB,WAClB,SAAUA,EAAgB,IAAI,MAAM,MAAM,UAC1C,SAAU,aAEZ,gBACE,gHACF,UACE,+HACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,MAAO,WAAY,aAAc,YAAY,GAEtD,CACE,GAAI,2BACJ,KAAM,eACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM8sB,GAAqB,WAC3B,KAAM,aACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,YAC7B,KAAM,eAGR,oBAAqBI,EAAgB,MAAM,QAAQ,SAAS,MAC5D,aAAc,CACZ,UAAWA,EAAgB,MAAM,QAAQ,MAAM,SAC/C,UAAW,WACX,aAAc,CACZA,EAAgB,MAAM,QAAQ,QAAQ,WACtCA,EAAgB,MAAM,QAAQ,QAAQ,gBAExC,YAAa,CAAC,aAAc,gBAAgB,EAC5C,eAAgB,CACdA,EAAgB,MAAM,UAAU,eAChCA,EAAgB,MAAM,UAAU,cAChCA,EAAgB,MAAM,UAAU,iBAChCA,EAAgB,MAAM,UAAU,mBAElC,cAAe,CAAC,iBAAkB,gBAAiB,mBAAoB,mBAAmB,EAC1F,YAAaA,EAAgB,MAAM,QAAQ,SAAS,MACpD,YAAa,gBACb,UAAWA,EAAgB,MAAM,QAAQ,MAAM,eAC/C,UAAW,iBACX,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,aAChE,iBAAkB,eAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBACE,mGACF,UACE,8GACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,eAAgB,WAAY,YAAa,OAAO,GAGzD,CACE,GAAI,sBACJ,KAAM,qBACN,QAASJ,EAAY,IACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM6sB,GAAoB,eAC1B,KAAM,kBACN,KAAM3sB,EAAS,QAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,YAC7B,KAAM,eAGR,oBAAqBI,EAAgB,MAAM,QAAQ,SAAS,MAC5D,aAAc,CACZ,UAAWA,EAAgB,IAAI,OAAO,MAAM,gBAC5C,UAAW,kBACX,aAAc,CACZA,EAAgB,IAAI,OAAO,QAAQ,eACnCA,EAAgB,IAAI,OAAO,QAAQ,YAErC,YAAa,CAAC,iBAAkB,YAAY,EAC5C,eAAgB,CACdA,EAAgB,IAAI,UAAU,oBAC9BA,EAAgB,IAAI,UAAU,eAC9BA,EAAgB,IAAI,UAAU,kBAC9BA,EAAgB,IAAI,UAAU,oBAEhC,cAAe,CAAC,sBAAuB,iBAAkB,oBAAqB,oBAAoB,EAClG,YAAaA,EAAgB,IAAI,OAAO,SAAS,MACjD,YAAa,gBACb,UAAWA,EAAgB,IAAI,OAAO,MAAM,iBAC5C,UAAW,mBACX,iBAAkBA,EAAgB,IAAI,OAAO,gBAAgB,eAC7D,iBAAkB,iBAClB,SAAUA,EAAgB,IAAI,OAAO,MAAM,YAC3C,SAAU,eAEZ,gBACE,2HACF,UACE,wEACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,MAAO,eAAgB,QAAS,SAAS,GAGlD,CACE,GAAI,mCACJ,KAAM,qBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM8sB,GAAqB,eAC3B,KAAM,iBACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,aAC7B,KAAM,gBAER,aAAc,CACZ,UAAWI,EAAgB,UAAU,QAAQ,MAAM,YACnD,UAAW,cACX,aAAc,CACZA,EAAgB,UAAU,QAAQ,QAAQ,cAC1CA,EAAgB,UAAU,QAAQ,QAAQ,eAE5C,YAAa,CAAC,gBAAiB,eAAe,EAC9C,eAAgB,CACdA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,oBACpCA,EAAgB,UAAU,UAAU,kBAEtC,cAAe,CAAC,gBAAiB,gBAAiB,sBAAuB,kBAAkB,EAC3F,YAAaA,EAAgB,UAAU,QAAQ,SAAS,MACxD,YAAa,gBACb,UAAWA,EAAgB,UAAU,QAAQ,MAAM,cACnD,UAAW,gBACX,iBAAkBA,EAAgB,UAAU,QAAQ,gBAAgB,aACpE,iBAAkB,eAClB,SAAUA,EAAgB,UAAU,QAAQ,MAAM,YAClD,SAAU,eAEZ,gBACE,yJACF,UACE,iJACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,YAAa,eAAgB,iBAAkB,SAAS,GAEjE,CACE,GAAI,4BACJ,KAAM,sBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM4sB,GAAmB,qBACzB,KAAM,uBACN,KAAM1sB,EAAS,OAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,eAC5B,KAAM,kBAER,aAAc,CACZ,UAAWI,EAAgB,UAAU,MAAM,MAAM,iBACjD,UAAW,mBACX,aAAc,CACZA,EAAgB,UAAU,MAAM,QAAQ,SACxCA,EAAgB,UAAU,MAAM,QAAQ,cAE1C,YAAa,CAAC,WAAY,cAAc,EACxC,eAAgB,CACdA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,oBACpCA,EAAgB,UAAU,UAAU,eAEtC,cAAe,CAAC,gBAAiB,gBAAiB,sBAAuB,eAAe,EACxF,YAAaA,EAAgB,UAAU,MAAM,SAAS,QACtD,YAAa,kBACb,UAAWA,EAAgB,UAAU,MAAM,MAAM,aACjD,UAAW,eACX,iBAAkBA,EAAgB,UAAU,MAAM,gBAAgB,SAClE,iBAAkB,WAClB,SAAUA,EAAgB,UAAU,MAAM,MAAM,UAChD,SAAU,aAEZ,gBACE,uHACF,UACE,mFACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,YAAa,UAAW,QAAS,OAAO,GAEjD,CACE,GAAI,yBACJ,KAAM,eACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM6sB,GAAoB,gBAC1B,KAAM,mBACN,KAAM3sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,YAC7B,KAAM,eAGR,oBAAqBI,EAAgB,MAAM,QAAQ,SAAS,MAC5D,aAAc,CACZ,UAAWA,EAAgB,UAAU,OAAO,MAAM,mBAClD,UAAW,qBACX,aAAc,CACZA,EAAgB,UAAU,OAAO,QAAQ,oBACzCA,EAAgB,UAAU,OAAO,QAAQ,gBAE3C,YAAa,CAAC,sBAAuB,gBAAgB,EACrD,eAAgB,CACdA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,oBACpCA,EAAgB,UAAU,UAAU,eAEtC,cAAe,CAAC,gBAAiB,gBAAiB,sBAAuB,eAAe,EACxF,YAAaA,EAAgB,UAAU,OAAO,SAAS,QACvD,YAAa,kBACb,UAAWA,EAAgB,UAAU,OAAO,MAAM,iBAClD,UAAW,mBACX,iBAAkBA,EAAgB,UAAU,OAAO,gBAAgB,eACnE,iBAAkB,iBAClB,SAAUA,EAAgB,UAAU,OAAO,MAAM,YACjD,SAAU,eAEZ,gBACE,kHACF,UACE,6EACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,YAAa,QAAS,QAAS,UAAU,GAElD,CACE,GAAI,iCACJ,KAAM,eACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM8sB,GAAqB,SAC3B,KAAM,WACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,YAC7B,KAAM,eAGR,mBAAoBI,EAAgB,UAAU,QAAQ,QAAQ,aAC9D,aAAc,CACZ,UAAWA,EAAgB,UAAU,QAAQ,MAAM,YACnD,UAAW,cACX,aAAc,CACZA,EAAgB,UAAU,QAAQ,QAAQ,aAC1CA,EAAgB,UAAU,QAAQ,QAAQ,eAE5C,YAAa,CAAC,gBAAiB,eAAe,EAC9C,eAAgB,CACdA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,iBACpCA,EAAgB,UAAU,UAAU,iBACpCA,EAAgB,UAAU,UAAU,oBACpCA,EAAgB,UAAU,UAAU,kBAEtC,cAAe,CAAC,gBAAiB,mBAAoB,mBAAoB,sBAAuB,kBAAkB,EAClH,YAAaA,EAAgB,UAAU,QAAQ,SAAS,WACxD,YAAa,qBACb,UAAWA,EAAgB,UAAU,QAAQ,MAAM,cACnD,UAAW,gBACX,iBAAkBA,EAAgB,UAAU,QAAQ,gBAAgB,aACpE,iBAAkB,eAClB,SAAUA,EAAgB,UAAU,QAAQ,MAAM,YAClD,SAAU,eAEZ,gBACE,qGACF,UACE,iGACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,YAAa,cAAe,UAAW,SAAS,GAEzD,CACE,GAAI,0BACJ,KAAM,oBACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,UAC7B,YAAa,CACX,KAAM8sB,GAAqB,SAC3B,KAAM,WACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,kBAC7B,KAAM,qBAER,mBAAoBI,EAAgB,OAAO,QAAQ,QAAQ,aAC3D,aAAc,CACZ,UAAWA,EAAgB,OAAO,QAAQ,MAAM,YAChD,UAAW,cACX,aAAc,CACZA,EAAgB,OAAO,QAAQ,QAAQ,aACvCA,EAAgB,OAAO,QAAQ,QAAQ,cAEzC,YAAa,CAAC,gBAAiB,cAAc,EAC7C,eAAgB,CACdA,EAAgB,OAAO,UAAU,oBACjCA,EAAgB,OAAO,UAAU,qBACjCA,EAAgB,OAAO,UAAU,kBACjCA,EAAgB,OAAO,UAAU,mBAEnC,cAAe,CAAC,sBAAuB,uBAAwB,oBAAqB,mBAAmB,EACvG,YAAaA,EAAgB,OAAO,QAAQ,SAAS,WACrD,YAAa,qBACb,UAAWA,EAAgB,OAAO,QAAQ,MAAM,cAChD,UAAW,gBACX,iBAAkBA,EAAgB,OAAO,QAAQ,gBAAgB,aACjE,iBAAkB,eAClB,SAAUA,EAAgB,OAAO,QAAQ,MAAM,YAC/C,SAAU,eAEZ,gBACE,qHACF,UACE,6GACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,SAAU,WAAY,UAAW,SAAS,GAEnD,CACE,GAAI,sBACJ,KAAM,oBACN,QAASJ,EAAY,IACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM8sB,GAAqB,eAC3B,KAAM,iBACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,WAC5B,KAAM,cAER,aAAc,CACZ,UAAWI,EAAgB,IAAI,QAAQ,MAAM,YAC7C,UAAW,cACX,aAAc,CACZA,EAAgB,IAAI,QAAQ,QAAQ,SACpCA,EAAgB,IAAI,QAAQ,QAAQ,oBAEtC,YAAa,CAAC,WAAY,oBAAoB,EAC9C,eAAgB,CACdA,EAAgB,IAAI,UAAU,mBAC9BA,EAAgB,IAAI,UAAU,eAC9BA,EAAgB,IAAI,UAAU,iBAC9BA,EAAgB,IAAI,UAAU,oBAEhC,cAAe,CAAC,qBAAsB,iBAAkB,mBAAoB,oBAAoB,EAChG,YAAaA,EAAgB,IAAI,QAAQ,SAAS,MAClD,YAAa,gBACb,UAAWA,EAAgB,IAAI,QAAQ,MAAM,gBAC7C,UAAW,kBACX,iBAAkBA,EAAgB,IAAI,QAAQ,gBAAgB,aAC9D,iBAAkB,eAClB,SAAUA,EAAgB,IAAI,QAAQ,MAAM,YAC5C,SAAU,eAEZ,gBACE,2HACF,UACE,oHACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,MAAO,cAAe,QAAS,OAAO,GAE/C,CACE,GAAI,2BACJ,KAAM,gBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM8sB,GAAqB,cAC3B,KAAM,iBACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,cAC5B,KAAM,iBAER,aAAc,CACZ,UAAWI,EAAgB,UAAU,QAAQ,MAAM,YACnD,UAAW,cACX,aAAc,CACZA,EAAgB,UAAU,QAAQ,QAAQ,gBAC1CA,EAAgB,UAAU,QAAQ,QAAQ,eAE5C,YAAa,CAAC,kBAAmB,eAAe,EAChD,eAAgB,CACdA,EAAgB,UAAU,UAAU,oBACpCA,EAAgB,UAAU,UAAU,iBACpCA,EAAgB,UAAU,UAAU,iBACpCA,EAAgB,UAAU,UAAU,kBAEtC,cAAe,CAAC,sBAAuB,mBAAoB,mBAAoB,kBAAkB,EACjG,YAAaA,EAAgB,UAAU,QAAQ,SAAS,MACxD,YAAa,gBACb,UAAWA,EAAgB,UAAU,QAAQ,MAAM,cACnD,UAAW,gBACX,iBAAkBA,EAAgB,UAAU,QAAQ,gBAAgB,aACpE,iBAAkB,eAClB,SAAUA,EAAgB,UAAU,QAAQ,MAAM,YAClD,SAAU,eAEZ,gBACE,kHACF,UACE,kEACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,YAAa,QAAS,YAAa,SAAS,GAErD,CACE,GAAI,kCACJ,KAAM,gBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM8sB,GAAqB,cAC3B,KAAM,iBACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,YAC7B,KAAM,eAGR,oBAAqBI,EAAgB,MAAM,QAAQ,SAAS,MAC5D,aAAc,CACZ,UAAWA,EAAgB,UAAU,QAAQ,MAAM,oBACnD,UAAW,YACX,aAAc,CACZA,EAAgB,UAAU,QAAQ,QAAQ,QAC1CA,EAAgB,UAAU,QAAQ,QAAQ,eAE5C,YAAa,CAAC,UAAW,eAAe,EACxC,eAAgB,CACdA,EAAgB,UAAU,UAAU,iBACpCA,EAAgB,UAAU,UAAU,mBACpCA,EAAgB,UAAU,UAAU,oBACpCA,EAAgB,UAAU,UAAU,kBAEtC,cAAe,CAAC,mBAAoB,qBAAsB,sBAAuB,kBAAkB,EACnG,YAAaA,EAAgB,UAAU,QAAQ,SAAS,OACxD,YAAa,iBACb,UAAWA,EAAgB,UAAU,QAAQ,MAAM,cACnD,UAAW,gBACX,iBAAkBA,EAAgB,UAAU,QAAQ,gBAAgB,aACpE,iBAAkB,eAClB,SAAUA,EAAgB,UAAU,QAAQ,MAAM,YAClD,SAAU,eAEZ,gBACE,uGACF,UACE,mHACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,YAAa,QAAS,eAAgB,eAAgB,WAAW,GAE1E,CACE,GAAI,0BACJ,KAAM,sBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM8sB,GAAqB,eAC3B,KAAM,kBACN,KAAM5sB,EAAS,QAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,SAC5B,KAAM,YAER,aAAc,CACZ,UAAWI,EAAgB,UAAU,QAAQ,MAAM,cACnD,UAAW,gBACX,aAAc,CACZA,EAAgB,UAAU,QAAQ,QAAQ,QAC1CA,EAAgB,UAAU,QAAQ,QAAQ,eAE5C,YAAa,CAAC,UAAW,eAAe,EACxC,eAAgB,CACdA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,iBACpCA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,qBAEtC,cAAe,CAAC,gBAAiB,mBAAoB,gBAAiB,qBAAqB,EAC3F,YAAaA,EAAgB,UAAU,QAAQ,SAAS,QACxD,YAAa,kBACb,UAAWA,EAAgB,UAAU,QAAQ,MAAM,iBACnD,UAAW,mBACX,iBAAkBA,EAAgB,UAAU,QAAQ,gBAAgB,aACpE,iBAAkB,eAClB,SAAUA,EAAgB,UAAU,QAAQ,MAAM,YAClD,SAAU,eAEZ,gBACE,6FACF,UACE,0FACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,YAAa,UAAW,UAAW,UAAU,GAEtD,CACE,GAAI,oCACJ,KAAM,gBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM4sB,GAAmB,WACzB,KAAM,aACN,KAAM1sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,aAC7B,KAAM,gBAER,aAAc,CACZ,UAAWI,EAAgB,UAAU,MAAM,MAAM,iBACjD,UAAW,mBACX,aAAc,CACZA,EAAgB,UAAU,MAAM,QAAQ,aACxCA,EAAgB,UAAU,MAAM,QAAQ,UAE1C,YAAa,CAAC,eAAgB,UAAU,EACxC,eAAgB,CACdA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,oBACpCA,EAAgB,UAAU,UAAU,iBACpCA,EAAgB,UAAU,UAAU,kBAEtC,cAAe,CAAC,gBAAiB,sBAAuB,mBAAoB,kBAAkB,EAC9F,YAAaA,EAAgB,UAAU,MAAM,SAAS,QACtD,YAAa,kBACb,UAAWA,EAAgB,UAAU,MAAM,MAAM,eACjD,UAAW,iBACX,iBAAkBA,EAAgB,UAAU,MAAM,gBAAgB,SAClE,iBAAkB,WAClB,SAAUA,EAAgB,UAAU,MAAM,MAAM,UAChD,SAAU,aAEZ,gBACE,sIACF,UACE,iIACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,YAAa,QAAS,OAAQ,cAAc,GAErD,CACE,GAAI,yBACJ,KAAM,oBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM6sB,GAAoB,kBAC1B,KAAM,oBACN,KAAM3sB,EAAS,OAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,SAC5B,KAAM,YAER,aAAc,CACZ,UAAWI,EAAgB,UAAU,OAAO,MAAM,YAClD,UAAW,eACX,aAAc,CACZA,EAAgB,UAAU,OAAO,QAAQ,UACzCA,EAAgB,UAAU,OAAO,QAAQ,qBAE3C,YAAa,CAAC,YAAa,qBAAqB,EAChD,eAAgB,CACdA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,oBACpCA,EAAgB,UAAU,UAAU,kBAEtC,cAAe,CAAC,gBAAiB,gBAAiB,sBAAuB,kBAAkB,EAC3F,YAAaA,EAAgB,UAAU,OAAO,SAAS,QACvD,YAAa,kBACb,UAAWA,EAAgB,UAAU,OAAO,MAAM,iBAClD,UAAW,mBACX,iBAAkBA,EAAgB,UAAU,OAAO,gBAAgB,eACnE,iBAAkB,iBAClB,SAAUA,EAAgB,UAAU,OAAO,MAAM,YACjD,SAAU,eAEZ,gBACE,sGACF,UACE,sGACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,YAAa,WAAY,YAAa,UAAU,GACtD,CACD,GAAI,6BACJ,KAAM,yBACN,QAASJ,EAAY,KACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM6sB,GAAoB,mBAC1B,KAAM,sBACN,KAAM3sB,EAAS,OAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,cAC5B,KAAM,iBAER,aAAc,CACZ,UAAWI,EAAgB,KAAK,OAAO,MAAM,oBAC7C,UAAW,uBACX,aAAc,CACZA,EAAgB,KAAK,OAAO,QAAQ,oBACpCA,EAAgB,KAAK,OAAO,QAAQ,gBAEtC,YAAa,CAAC,sBAAuB,gBAAgB,EACrD,eAAgB,CACdA,EAAgB,KAAK,UAAU,oBAC/BA,EAAgB,KAAK,UAAU,mBAC/BA,EAAgB,KAAK,UAAU,oBAC/BA,EAAgB,KAAK,UAAU,mBAEjC,cAAe,CAAC,sBAAuB,qBAAsB,sBAAuB,mBAAmB,EACvG,UAAWA,EAAgB,KAAK,OAAO,MAAM,WAC7C,UAAW,aACX,YAAaA,EAAgB,KAAK,OAAO,SAAS,OAClD,YAAa,iBACb,iBAAkBA,EAAgB,KAAK,OAAO,gBAAgB,gBAC9D,iBAAkB,mBAClB,SAAUA,EAAgB,KAAK,OAAO,MAAM,YAC5C,SAAU,eAEZ,gBACE,2IACF,UACE,kIACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,OAAQ,WAAY,eAAgB,WAAW,GAExD,CACE,GAAI,6BACJ,KAAM,cACN,QAASJ,EAAY,QACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM6sB,GAAoB,YAC1B,KAAM,cACN,KAAM3sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,YAC7B,KAAM,eAER,aAAc,CACZ,UAAWI,EAAgB,MAAM,OAAO,MAAM,oBAC9C,UAAW,uBACX,aAAc,CACZA,EAAgB,MAAM,OAAO,QAAQ,aACrCA,EAAgB,MAAM,OAAO,QAAQ,eAEvC,YAAa,CAAC,eAAgB,gBAAgB,EAC9C,eAAgB,CACdA,EAAgB,MAAM,UAAU,iBAChCA,EAAgB,MAAM,UAAU,gBAChCA,EAAgB,MAAM,UAAU,kBAChCA,EAAgB,MAAM,UAAU,gBAElC,cAAe,CAAC,mBAAoB,kBAAmB,oBAAqB,gBAAgB,EAC5F,UAAWA,EAAgB,MAAM,OAAO,MAAM,wBAC9C,UAAW,0BACX,YAAaA,EAAgB,MAAM,OAAO,SAAS,QACnD,YAAa,kBACb,iBAAkBA,EAAgB,MAAM,OAAO,gBAAgB,gBAC/D,iBAAkB,mBAClB,SAAUA,EAAgB,MAAM,OAAO,MAAM,YAC7C,SAAU,eAEZ,gBACE,sJACF,UACE,mIACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,UAAW,cAAe,WAAY,cAAc,GAC1D,CACD,GAAI,8BACJ,KAAM,wBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CACX,KAAM6sB,GAAoB,oBAC1B,KAAM,sBACN,KAAM3sB,EAAS,QAEjB,aAAc,CACZ,KAAMysB,GAAe,MAAM,oBAC3B,KAAM,uBAER,aAAc,CACZ,UAAWI,EAAgB,MAAM,OAAO,MAAM,oBAC9C,UAAW,uBACX,aAAc,CACZA,EAAgB,MAAM,OAAO,QAAQ,aACrCA,EAAgB,MAAM,OAAO,QAAQ,eAEvC,YAAa,CAAC,eAAgB,gBAAgB,EAC9C,eAAgB,CACdA,EAAgB,MAAM,UAAU,iBAChCA,EAAgB,MAAM,UAAU,gBAChCA,EAAgB,MAAM,UAAU,kBAChCA,EAAgB,MAAM,UAAU,gBAElC,cAAe,CAAC,mBAAoB,kBAAmB,oBAAqB,gBAAgB,EAC5F,UAAWA,EAAgB,MAAM,OAAO,MAAM,wBAC9C,UAAW,0BACX,YAAaA,EAAgB,MAAM,OAAO,SAAS,QACnD,YAAa,kBACb,iBAAkBA,EAAgB,MAAM,OAAO,gBAAgB,gBAC/D,iBAAkB,mBAClB,SAAUA,EAAgB,MAAM,OAAO,MAAM,YAC7C,SAAU,eAEZ,gBACE,2GACF,UACE,+HACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,QAAS,WAAY,eAAgB,WAAW,GACtD,CACD,GAAI,gCACJ,KAAM,uBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,YAC7B,YAAa,CACX,KAAM8sB,GAAqB,uBAC3B,KAAM,yBACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,OAC7B,KAAM,UAER,aAAc,CACZ,UAAWI,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,aAAc,CACZA,EAAgB,MAAM,QAAQ,QAAQ,eACtCA,EAAgB,MAAM,QAAQ,QAAQ,SAExC,YAAa,CAAC,iBAAkB,SAAS,EACzC,eAAgB,CACdA,EAAgB,MAAM,UAAU,qBAChCA,EAAgB,MAAM,UAAU,eAChCA,EAAgB,MAAM,UAAU,gBAChCA,EAAgB,MAAM,UAAU,mBAElC,cAAe,CAAC,uBAAwB,iBAAkB,kBAAmB,mBAAmB,EAChG,UAAWA,EAAgB,MAAM,QAAQ,MAAM,eAC/C,UAAW,iBACX,YAAaA,EAAgB,MAAM,QAAQ,SAAS,QACpD,YAAa,kBACb,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,aAChE,iBAAkB,eAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBACE,2HACF,UACE,mHACF,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,UAAW,eAAgB,QAAQ,GAClD,CACD,GAAI,8BACJ,KAAM,sBACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,UAC7B,YAAa,CACX,KAAM8sB,GAAqB,cAC3B,KAAM,gBACN,KAAM5sB,EAAS,MAEjB,aAAc,CACZ,KAAMysB,GAAe,QAAQ,aAC7B,KAAM,gBAER,aAAc,CACZ,UAAWI,EAAgB,OAAO,QAAQ,MAAM,YAChD,UAAW,cACX,aAAc,CACZA,EAAgB,OAAO,QAAQ,QAAQ,oBACvCA,EAAgB,OAAO,QAAQ,QAAQ,WAEzC,YAAa,CAAC,sBAAuB,YAAY,EACjD,eAAgB,CACdA,EAAgB,OAAO,UAAU,qBACjCA,EAAgB,OAAO,UAAU,oBACjCA,EAAgB,OAAO,UAAU,eACjCA,EAAgB,OAAO,UAAU,sBAEnC,cAAe,CAAC,uBAAwB,sBAAuB,iBAAkB,sBAAsB,EACvG,UAAWA,EAAgB,OAAO,QAAQ,MAAM,cAChD,UAAW,gBACX,YAAaA,EAAgB,OAAO,QAAQ,SAAS,QACrD,YAAa,kBACb,iBAAkBA,EAAgB,OAAO,QAAQ,gBAAgB,aACjE,iBAAkB,eAClB,SAAUA,EAAgB,KAAK,QAAQ,MAAM,YAC7C,SAAU,eAEZ,gBACE,8GACF,UACE,mIACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,SAAU,SAAU,YAAa,gBAAgB,GACvD,CACD,GAAI,iCACJ,KAAM,qBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CACX,KAAM8sB,GAAqB,aAC3B,KAAM,gBACN,KAAM5sB,EAAS,QAEjB,aAAc,CACZ,KAAMysB,GAAe,OAAO,eAC5B,KAAM,kBAER,aAAc,CACZ,UAAWI,EAAgB,UAAU,QAAQ,MAAM,oBACnD,UAAW,YACX,aAAc,CACZA,EAAgB,UAAU,QAAQ,QAAQ,cAC1CA,EAAgB,UAAU,QAAQ,QAAQ,SAE5C,YAAa,CAAC,gBAAiB,SAAS,EACxC,eAAgB,CACdA,EAAgB,UAAU,UAAU,cACpCA,EAAgB,UAAU,UAAU,iBACpCA,EAAgB,UAAU,UAAU,iBACpCA,EAAgB,UAAU,UAAU,qBAEtC,cAAe,CAAC,gBAAiB,mBAAoB,mBAAoB,qBAAqB,EAC9F,UAAWA,EAAgB,UAAU,QAAQ,MAAM,mBACnD,UAAW,qBACX,YAAaA,EAAgB,UAAU,QAAQ,SAAS,OACxD,YAAa,iBACb,iBAAkBA,EAAgB,UAAU,QAAQ,gBAAgB,aACpE,iBAAkB,eAClB,SAAUA,EAAgB,UAAU,QAAQ,MAAM,YAClD,SAAU,eAEZ,gBACE,6IACF,UACE,2HACF,WAAY5sB,EAAW,SACvB,KAAM,CAAC,YAAa,eAAgB,eAAgB,SAAS,GAE/D,CACE,GAAI,4BACJ,KAAM,kBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,YAC7B,YAAa,CAAE,KAAM8sB,GAAqB,YAAa,KAAM,cAAe,KAAM5sB,EAAS,QAC3F,aAAc,CAAE,KAAMysB,GAAe,OAAO,gBAAiB,KAAM,oBACnE,aAAc,CACZ,UAAWI,EAAgB,MAAM,QAAQ,MAAM,SAC/C,UAAW,WACX,aAAc,CAACA,EAAgB,MAAM,QAAQ,QAAQ,eAAgBA,EAAgB,MAAM,QAAQ,QAAQ,UAAU,EACrH,YAAa,CAAC,iBAAkB,YAAY,EAC5C,eAAgB,CAACA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,cAAeA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,mBAAmB,EACtN,cAAe,CAAC,iBAAkB,gBAAiB,oBAAqB,qBAAqB,EAC7F,UAAWA,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,YAAaA,EAAgB,MAAM,QAAQ,SAAS,MACpD,YAAa,gBACb,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,aAChE,iBAAkB,eAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBAAiB,yGACjB,UAAW,qHACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,SAAU,WAAY,SAAS,GAEjD,CACE,GAAI,0BACJ,KAAM,mBACN,QAASJ,EAAY,KACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM8sB,GAAqB,WAAY,KAAM,aAAc,KAAM5sB,EAAS,MACzF,aAAc,CAAE,KAAMysB,GAAe,OAAO,eAAgB,KAAM,kBAClE,aAAc,CACZ,UAAWI,EAAgB,KAAK,QAAQ,MAAM,iBAC9C,UAAW,oBACX,aAAc,CAACA,EAAgB,KAAK,QAAQ,QAAQ,sBAAuBA,EAAgB,KAAK,QAAQ,QAAQ,aAAa,EAC7H,YAAa,CAAC,wBAAyB,eAAe,EACtD,eAAgB,CAACA,EAAgB,KAAK,UAAU,oBAAqBA,EAAgB,KAAK,UAAU,kBAAmBA,EAAgB,KAAK,UAAU,mBAAoBA,EAAgB,KAAK,UAAU,mBAAmB,EAC5N,cAAe,CAAC,sBAAuB,oBAAqB,qBAAsB,qBAAqB,EACvG,UAAWA,EAAgB,KAAK,QAAQ,MAAM,mBAC9C,UAAW,qBACX,YAAaA,EAAgB,KAAK,QAAQ,SAAS,OACnD,YAAa,iBACb,iBAAkBA,EAAgB,KAAK,QAAQ,gBAAgB,aAC/D,iBAAkB,eAClB,SAAUA,EAAgB,KAAK,QAAQ,MAAM,YAC7C,SAAU,eAEZ,gBAAiB,gGACjB,UAAW,mHACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,OAAQ,YAAa,UAAW,SAAS,GAElD,CACE,GAAI,4BACJ,KAAM,sBACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,UAC7B,YAAa,CAAE,KAAM4sB,GAAmB,aAAc,KAAM,eAAgB,KAAM1sB,EAAS,MAC3F,aAAc,CAAE,KAAMysB,GAAe,QAAQ,YAAa,KAAM,eAChE,aAAc,CACZ,UAAWI,EAAgB,OAAO,MAAM,MAAM,UAC9C,UAAW,YACX,aAAc,CAACA,EAAgB,OAAO,MAAM,QAAQ,aAAcA,EAAgB,OAAO,MAAM,QAAQ,aAAa,EACpH,YAAa,CAAC,gBAAiB,eAAe,EAC9C,eAAgB,CAACA,EAAgB,OAAO,UAAU,eAAgBA,EAAgB,OAAO,UAAU,qBAAsBA,EAAgB,OAAO,UAAU,kBAAmBA,EAAgB,OAAO,UAAU,oBAAoB,EAClO,cAAe,CAAC,iBAAkB,uBAAwB,oBAAqB,sBAAsB,EACrG,UAAWA,EAAgB,OAAO,MAAM,MAAM,eAC9C,UAAW,iBACX,YAAaA,EAAgB,OAAO,MAAM,SAAS,QACnD,YAAa,kBACb,iBAAkBA,EAAgB,OAAO,MAAM,gBAAgB,gBAC/D,iBAAkB,kBAClB,SAAUA,EAAgB,OAAO,MAAM,MAAM,YAC7C,SAAU,eAEZ,gBAAiB,4GACjB,UAAW,gGACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,SAAU,UAAW,QAAS,SAAS,GAEhD,CACE,GAAI,4BACJ,KAAM,gBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM4sB,GAAmB,mBAAoB,KAAM,qBAAsB,KAAM1sB,EAAS,MACvG,aAAc,CAAE,KAAMysB,GAAe,MAAM,eAAgB,KAAM,mBACjE,aAAc,CACZ,UAAWI,EAAgB,MAAM,MAAM,MAAM,aAC7C,UAAW,eACX,aAAc,CAACA,EAAgB,MAAM,MAAM,QAAQ,aAAcA,EAAgB,MAAM,MAAM,QAAQ,cAAc,EACnH,YAAa,CAAC,eAAgB,gBAAgB,EAC9C,eAAgB,CAACA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,cAAeA,EAAgB,MAAM,UAAU,gBAAgB,EACnN,cAAe,CAAC,iBAAkB,oBAAqB,gBAAiB,kBAAkB,EAC1F,UAAWA,EAAgB,MAAM,MAAM,MAAM,gBAC7C,UAAW,kBACX,YAAaA,EAAgB,MAAM,MAAM,SAAS,SAClD,YAAa,mBACb,iBAAkBA,EAAgB,MAAM,MAAM,gBAAgB,gBAC9D,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,MAAM,MAAM,YAC5C,SAAU,eAEZ,gBAAiB,0HACjB,UAAW,+FACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,eAAgB,QAAS,MAAM,GAEjD,CACE,GAAI,gCACJ,KAAM,iBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM6sB,GAAoB,aAAc,KAAM,iBAAkB,KAAM3sB,EAAS,MAC9F,aAAc,CAAE,KAAMysB,GAAe,OAAO,QAAS,KAAM,WAC3D,aAAc,CACZ,UAAWI,EAAgB,MAAM,OAAO,MAAM,cAC9C,UAAW,gBACX,aAAc,CAACA,EAAgB,MAAM,OAAO,QAAQ,cAAeA,EAAgB,MAAM,OAAO,QAAQ,YAAY,EACpH,YAAa,CAAC,iBAAkB,cAAc,EAC9C,eAAgB,CAACA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,cAAeA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,gBAAgB,EACnN,cAAe,CAAC,iBAAkB,gBAAiB,oBAAqB,kBAAkB,EAC1F,UAAWA,EAAgB,MAAM,OAAO,MAAM,0BAC9C,UAAW,4BACX,YAAaA,EAAgB,MAAM,OAAO,SAAS,QACnD,YAAa,kBACb,iBAAkBA,EAAgB,MAAM,OAAO,gBAAgB,eAC/D,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,OAAO,MAAM,YAC7C,SAAU,eAEZ,gBAAiB,+FACjB,UAAW,iHACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,WAAY,SAAU,WAAW,GAEnD,CACE,GAAI,yBACJ,KAAM,sBACN,QAASJ,EAAY,KACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,YAC7B,YAAa,CAAE,KAAM6sB,GAAoB,WAAY,KAAM,aAAc,KAAM3sB,EAAS,OACxF,aAAc,CAAE,KAAMysB,GAAe,OAAO,YAAa,KAAM,eAC/D,aAAc,CACZ,UAAWI,EAAgB,KAAK,OAAO,MAAM,oBAC7C,UAAW,uBACX,aAAc,CAACA,EAAgB,KAAK,OAAO,QAAQ,gBAAiBA,EAAgB,KAAK,OAAO,QAAQ,cAAc,EACtH,YAAa,CAAC,kBAAmB,gBAAgB,EACjD,eAAgB,CAACA,EAAgB,KAAK,UAAU,kBAAmBA,EAAgB,KAAK,UAAU,mBAAoBA,EAAgB,KAAK,UAAU,oBAAqBA,EAAgB,KAAK,UAAU,eAAe,EACxN,cAAe,CAAC,oBAAqB,qBAAsB,sBAAuB,iBAAiB,EACnG,UAAWA,EAAgB,KAAK,OAAO,MAAM,WAC7C,UAAW,aACX,YAAaA,EAAgB,KAAK,OAAO,SAAS,OAClD,YAAa,iBACb,iBAAkBA,EAAgB,KAAK,OAAO,gBAAgB,eAC9D,iBAAkB,kBAClB,SAAUA,EAAgB,KAAK,OAAO,MAAM,YAC5C,SAAU,eAEZ,gBAAiB,+HACjB,UAAW,wHACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,OAAQ,eAAgB,SAAU,SAAS,GAEpD,CACE,GAAI,gCACJ,KAAM,kBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM8sB,GAAqB,cAAe,KAAM,gBAAiB,KAAM5sB,EAAS,QAC/F,aAAc,CAAE,KAAMysB,GAAe,OAAO,SAAU,KAAM,YAC5D,aAAc,CACZ,UAAWI,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,aAAc,CAACA,EAAgB,MAAM,QAAQ,QAAQ,eAAgBA,EAAgB,MAAM,QAAQ,QAAQ,OAAO,EAClH,YAAa,CAAC,iBAAkB,SAAS,EACzC,eAAgB,CAACA,EAAgB,MAAM,UAAU,qBAAsBA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,gBAAiBA,EAAgB,MAAM,UAAU,iBAAiB,EACzN,cAAe,CAAC,uBAAwB,iBAAkB,kBAAmB,mBAAmB,EAChG,UAAWA,EAAgB,MAAM,QAAQ,MAAM,eAC/C,UAAW,iBACX,YAAaA,EAAgB,MAAM,QAAQ,SAAS,QACpD,YAAa,kBACb,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,aAChE,iBAAkB,eAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBAAiB,oFACjB,UAAW,4GACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,UAAW,aAAc,SAAS,GAEpD,CACE,GAAI,+BACJ,KAAM,oBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM4sB,GAAmB,iBAAkB,KAAM,mBAAoB,KAAM1sB,EAAS,QACnG,aAAc,CAAE,KAAMysB,GAAe,OAAO,QAAS,KAAM,WAC3D,aAAc,CACZ,UAAWI,EAAgB,MAAM,MAAM,MAAM,cAC7C,UAAW,gBACX,aAAc,CAACA,EAAgB,MAAM,MAAM,QAAQ,aAAcA,EAAgB,MAAM,MAAM,QAAQ,cAAc,EACnH,YAAa,CAAC,eAAgB,gBAAgB,EAC9C,eAAgB,CAACA,EAAgB,MAAM,UAAU,gBAAiBA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,iBAAkBA,EAAgB,MAAM,UAAU,oBAAoB,EAC3N,cAAe,CAAC,kBAAmB,oBAAqB,mBAAoB,sBAAsB,EAClG,UAAWA,EAAgB,MAAM,MAAM,MAAM,gBAC7C,UAAW,kBACX,YAAaA,EAAgB,MAAM,MAAM,SAAS,SAClD,YAAa,mBACb,iBAAkBA,EAAgB,MAAM,MAAM,gBAAgB,gBAC9D,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,MAAM,MAAM,YAC5C,SAAU,eAEZ,gBAAiB,mIACjB,UAAW,qIACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,QAAS,WAAY,UAAW,OAAO,GAEhD,CACE,GAAI,4BACJ,KAAM,kBACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM4sB,GAAmB,sBAAuB,KAAM,wBAAyB,KAAM1sB,EAAS,QAC7G,aAAc,CAAE,KAAMysB,GAAe,QAAQ,iBAAkB,KAAM,oBACrE,aAAc,CACZ,UAAWI,EAAgB,OAAO,MAAM,MAAM,cAC9C,UAAW,gBACX,aAAc,CAACA,EAAgB,OAAO,MAAM,QAAQ,cAAeA,EAAgB,OAAO,MAAM,QAAQ,gBAAgB,EACxH,YAAa,CAAC,gBAAiB,kBAAkB,EACjD,eAAgB,CAACA,EAAgB,OAAO,UAAU,kBAAmBA,EAAgB,OAAO,UAAU,kBAAmBA,EAAgB,OAAO,UAAU,sBAAuBA,EAAgB,OAAO,UAAU,gBAAgB,EAClO,cAAe,CAAC,oBAAqB,oBAAqB,wBAAyB,kBAAkB,EACrG,UAAWA,EAAgB,OAAO,MAAM,MAAM,cAC9C,UAAW,gBACX,YAAaA,EAAgB,OAAO,MAAM,SAAS,QACnD,YAAa,kBACb,iBAAkBA,EAAgB,OAAO,MAAM,gBAAgB,gBAC/D,iBAAkB,kBAClB,SAAUA,EAAgB,OAAO,MAAM,MAAM,YAC7C,SAAU,eAEZ,gBAAiB,8GACjB,UAAW,+IACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,SAAU,YAAa,QAAS,QAAQ,GAEjD,CACE,GAAI,8BACJ,KAAM,aACN,QAASJ,EAAY,QACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM6sB,GAAoB,iBAAkB,KAAM,qBAAsB,KAAM3sB,EAAS,MACtG,aAAc,CAAE,KAAMysB,GAAe,OAAO,SAAU,KAAM,YAC5D,aAAc,CACZ,UAAWI,EAAgB,IAAI,OAAO,MAAM,gBAC5C,UAAW,kBACX,aAAc,CAACA,EAAgB,IAAI,OAAO,QAAQ,WAAYA,EAAgB,IAAI,OAAO,QAAQ,SAAS,EAC1G,YAAa,CAAC,aAAc,WAAW,EACvC,eAAgB,CAACA,EAAgB,IAAI,UAAU,eAAgBA,EAAgB,IAAI,UAAU,cAAeA,EAAgB,IAAI,UAAU,oBAAqBA,EAAgB,IAAI,UAAU,kBAAkB,EAC/M,cAAe,CAAC,iBAAkB,gBAAiB,sBAAuB,oBAAoB,EAC9F,UAAWA,EAAgB,IAAI,OAAO,MAAM,iBAC5C,UAAW,mBACX,YAAaA,EAAgB,IAAI,OAAO,SAAS,MACjD,YAAa,gBACb,iBAAkBA,EAAgB,IAAI,OAAO,gBAAgB,eAC7D,iBAAkB,kBAClB,SAAUA,EAAgB,IAAI,OAAO,MAAM,YAC3C,SAAU,eAEZ,gBAAiB,mJACjB,UAAW,+GACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,UAAW,QAAS,aAAc,QAAQ,GAEnD,CACE,GAAI,mCACJ,KAAM,mBACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM8sB,GAAqB,kBAAmB,KAAM,oBAAqB,KAAM5sB,EAAS,MACvG,aAAc,CAAE,KAAMysB,GAAe,QAAQ,cAAe,KAAM,kBAClE,aAAc,CACZ,UAAWI,EAAgB,OAAO,QAAQ,MAAM,cAChD,UAAW,iBACX,aAAc,CAACA,EAAgB,OAAO,QAAQ,QAAQ,cAAeA,EAAgB,OAAO,QAAQ,QAAQ,cAAc,EAC1H,YAAa,CAAC,gBAAiB,gBAAgB,EAC/C,eAAgB,CAACA,EAAgB,OAAO,UAAU,mBAAoBA,EAAgB,OAAO,UAAU,mBAAoBA,EAAgB,OAAO,UAAU,sBAAuBA,EAAgB,OAAO,UAAU,gBAAgB,EACpO,cAAe,CAAC,qBAAsB,qBAAsB,wBAAyB,kBAAkB,EACvG,UAAWA,EAAgB,OAAO,QAAQ,MAAM,gBAChD,UAAW,kBACX,YAAaA,EAAgB,OAAO,QAAQ,SAAS,SACrD,YAAa,mBACb,iBAAkBA,EAAgB,OAAO,QAAQ,gBAAgB,aACjE,iBAAkB,eAClB,SAAUA,EAAgB,OAAO,QAAQ,MAAM,YAC/C,SAAU,eAEZ,gBAAiB,mIACjB,UAAW,2GACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,SAAU,SAAU,UAAW,eAAe,GAEvD,CACE,GAAI,mCACJ,KAAM,sBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,YAC7B,YAAa,CAAE,KAAM8sB,GAAqB,WAAY,KAAM,aAAc,KAAM5sB,EAAS,MACzF,aAAc,CAAE,KAAMysB,GAAe,OAAO,cAAe,KAAM,iBACjE,aAAc,CACZ,UAAWI,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,aAAc,CAACA,EAAgB,MAAM,QAAQ,QAAQ,eAAgBA,EAAgB,MAAM,QAAQ,QAAQ,UAAU,EACrH,YAAa,CAAC,iBAAkB,YAAY,EAC5C,eAAgB,CAACA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,cAAeA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,eAAe,EAClN,cAAe,CAAC,iBAAkB,gBAAiB,oBAAqB,iBAAiB,EACzF,UAAWA,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,YAAaA,EAAgB,MAAM,QAAQ,SAAS,MACpD,YAAa,gBACb,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,aAChE,iBAAkB,eAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBAAiB,2HACjB,UAAW,oIACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,aAAc,UAAW,UAAU,GAErD,CACE,GAAI,6BACJ,KAAM,mBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,YAC7B,YAAa,CAAE,KAAM8sB,GAAqB,YAAa,KAAM,cAAe,KAAM5sB,EAAS,QAC3F,aAAc,CAAE,KAAMysB,GAAe,OAAO,cAAe,KAAM,iBACjE,aAAc,CACZ,UAAWI,EAAgB,MAAM,QAAQ,MAAM,cAC/C,UAAW,gBACX,aAAc,CAACA,EAAgB,MAAM,QAAQ,QAAQ,QAASA,EAAgB,MAAM,QAAQ,QAAQ,cAAc,EAClH,YAAa,CAAC,UAAW,gBAAgB,EACzC,eAAgB,CAACA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,cAAeA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,iBAAiB,EACpN,cAAe,CAAC,iBAAkB,gBAAiB,oBAAqB,mBAAmB,EAC3F,UAAWA,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,YAAaA,EAAgB,MAAM,QAAQ,SAAS,MACpD,YAAa,gBACb,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,aAChE,iBAAkB,eAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBAAiB,iJACjB,UAAW,sHACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,QAAS,SAAU,UAAW,WAAW,GAElD,CACE,GAAI,iCACJ,KAAM,mBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CAAE,KAAM8sB,GAAqB,kBAAmB,KAAM,oBAAqB,KAAM5sB,EAAS,OACvG,aAAc,CAAE,KAAMysB,GAAe,OAAO,cAAe,KAAM,iBACjE,aAAc,CACZ,UAAWI,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,aAAc,CAACA,EAAgB,MAAM,QAAQ,QAAQ,eAAgBA,EAAgB,MAAM,QAAQ,QAAQ,OAAO,EAClH,YAAa,CAAC,iBAAkB,SAAS,EACzC,eAAgB,CACdA,EAAgB,MAAM,UAAU,eAChCA,EAAgB,MAAM,UAAU,cAChCA,EAAgB,MAAM,UAAU,kBAChCA,EAAgB,MAAM,UAAU,kBAElC,cAAe,CAAC,iBAAkB,gBAAiB,oBAAqB,kBAAkB,EAC1F,UAAWA,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,YAAaA,EAAgB,MAAM,QAAQ,SAAS,OACpD,YAAa,iBACb,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,gBAChE,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBAAiB,2KACjB,UAAW,4IACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,WAAY,UAAW,eAAe,GAExD,CACE,GAAI,+BACJ,KAAM,sBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,YAC7B,YAAa,CAAE,KAAM6sB,GAAoB,aAAc,KAAM,iBAAkB,KAAM3sB,EAAS,MAC9F,aAAc,CAAE,KAAMysB,GAAe,OAAO,cAAe,KAAM,iBACjE,aAAc,CACZ,UAAWI,EAAgB,MAAM,OAAO,MAAM,cAC9C,UAAW,gBACX,aAAc,CAACA,EAAgB,MAAM,OAAO,QAAQ,cAAeA,EAAgB,MAAM,OAAO,QAAQ,YAAY,EACpH,YAAa,CAAC,iBAAmB,cAAc,EAC/C,eAAgB,CAACA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,cAAeA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,gBAAgB,EACnN,cAAe,CAAC,iBAAkB,gBAAiB,oBAAqB,kBAAkB,EAC1F,UAAWA,EAAgB,MAAM,OAAO,MAAM,0BAC9C,UAAW,4BACX,YAAaA,EAAgB,MAAM,OAAO,SAAS,MACnD,YAAa,gBACb,iBAAkBA,EAAgB,MAAM,OAAO,gBAAgB,eAC/D,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,OAAO,MAAM,YAC7C,SAAU,eAEZ,gBAAiB,uIACjB,UAAW,wGACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,YAAa,SAAU,YAAY,GAErD,CACE,GAAI,6BACJ,KAAM,mBACN,QAASJ,EAAY,IACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CAAE,KAAM8sB,GAAqB,eAAgB,KAAM,iBAAkB,KAAM5sB,EAAS,MACjG,aAAc,CACZ,UAAW6sB,EAAgB,IAAI,QAAQ,MAAM,YAC7C,UAAW,cACX,aAAc,CAACA,EAAgB,IAAI,QAAQ,QAAQ,SAAUA,EAAgB,IAAI,QAAQ,QAAQ,kBAAkB,EACnH,YAAa,CAAC,WAAY,oBAAoB,EAC9C,eAAgB,CAACA,EAAgB,IAAI,UAAU,eAAgBA,EAAgB,IAAI,UAAU,cAAeA,EAAgB,IAAI,UAAU,oBAAqBA,EAAgB,IAAI,UAAU,kBAAkB,EAC/M,cAAe,CAAC,iBAAkB,gBAAiB,sBAAuB,oBAAoB,EAC9F,UAAWA,EAAgB,IAAI,QAAQ,MAAM,eAC7C,UAAW,iBACX,YAAaA,EAAgB,IAAI,QAAQ,SAAS,MAClD,YAAa,gBACb,iBAAkBA,EAAgB,IAAI,QAAQ,gBAAgB,aAC9D,iBAAkB,eAClB,SAAUA,EAAgB,IAAI,QAAQ,MAAM,YAC5C,SAAU,eAEZ,gBAAiB,mIACjB,UAAW,4HACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,WAAY,iBAAkB,UAAW,KAAK,GAEvD,CACE,GAAI,mCACJ,KAAM,oBACN,QAASJ,EAAY,UACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM8sB,GAAqB,eAAgB,KAAM,iBAAkB,KAAM5sB,EAAS,MACjG,aAAc,CACZ,UAAW6sB,EAAgB,UAAU,QAAQ,MAAM,cACnD,UAAW,gBACX,aAAc,CAACA,EAAgB,UAAU,QAAQ,QAAQ,cAAeA,EAAgB,UAAU,QAAQ,QAAQ,aAAa,EAC/H,YAAa,CAAC,gBAAiB,eAAe,EAC9C,eAAgB,CAACA,EAAgB,UAAU,UAAU,cAAeA,EAAgB,UAAU,UAAU,cAAeA,EAAgB,UAAU,UAAU,oBAAqBA,EAAgB,UAAU,UAAU,gBAAgB,EACpO,cAAe,CAAC,gBAAiB,gBAAiB,sBAAuB,kBAAkB,EAC3F,UAAWA,EAAgB,UAAU,QAAQ,MAAM,cACnD,UAAW,gBACX,YAAaA,EAAgB,UAAU,QAAQ,SAAS,MACxD,YAAa,gBACb,iBAAkBA,EAAgB,UAAU,QAAQ,gBAAgB,aACpE,iBAAkB,eAClB,SAAUA,EAAgB,UAAU,QAAQ,MAAM,YAClD,SAAU,eAEZ,gBAAiB,+IACjB,UAAW,8GACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,YAAa,UAAW,UAAW,SAAS,GAGrD,CACE,GAAI,iCACJ,KAAM,qBACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM4sB,GAAmB,aAAc,KAAM,eAAgB,KAAM1sB,EAAS,MAC3F,aAAc,CAAE,KAAMysB,GAAe,MAAM,kBAAmB,KAAM,qBACpE,aAAc,CACZ,UAAWI,EAAgB,OAAO,MAAM,MAAM,UAC9C,UAAW,YACX,aAAc,CAACA,EAAgB,OAAO,MAAM,QAAQ,cAAeA,EAAgB,OAAO,MAAM,QAAQ,aAAa,EACrH,YAAa,CAAC,gBAAiB,eAAe,EAC9C,eAAgB,CAACA,EAAgB,OAAO,UAAU,kBAAmBA,EAAgB,OAAO,UAAU,eAAgBA,EAAgB,OAAO,UAAU,qBAAsBA,EAAgB,OAAO,UAAU,oBAAoB,EAClO,cAAe,CAAC,oBAAqB,iBAAkB,uBAAwB,sBAAsB,EACrG,UAAWA,EAAgB,OAAO,MAAM,MAAM,eAC9C,UAAW,iBACX,YAAaA,EAAgB,OAAO,MAAM,SAAS,QACnD,YAAa,kBACb,iBAAkBA,EAAgB,OAAO,MAAM,gBAAgB,mBAC/D,iBAAkB,qBAClB,SAAUA,EAAgB,OAAO,MAAM,MAAM,YAC7C,SAAU,eAEZ,gBAAiB,2HACjB,UAAW,iIACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,SAAU,OAAQ,QAAS,SAAS,GAK7C,CACE,GAAI,iCACJ,KAAM,mBACN,QAASJ,EAAY,IACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,SAC7B,YAAa,CAAE,KAAM8sB,GAAqB,eAAgB,KAAM,iBAAkB,KAAM5sB,EAAS,MACjG,aAAc,CAAE,KAAMysB,GAAe,OAAO,WAAY,KAAM,cAC9D,aAAc,CACZ,UAAWI,EAAgB,IAAI,QAAQ,MAAM,YAC7C,UAAW,cACX,aAAc,CAACA,EAAgB,IAAI,QAAQ,QAAQ,SAAUA,EAAgB,IAAI,QAAQ,QAAQ,kBAAkB,EACnH,YAAa,CAAC,WAAY,oBAAoB,EAC9C,eAAgB,CAACA,EAAgB,IAAI,UAAU,cAAeA,EAAgB,IAAI,UAAU,eAAgBA,EAAgB,IAAI,UAAU,mBAAoBA,EAAgB,IAAI,UAAU,iBAAiB,EAC7M,cAAe,CAAC,gBAAiB,iBAAkB,qBAAsB,mBAAmB,EAC5F,UAAWA,EAAgB,IAAI,QAAQ,MAAM,gBAC7C,UAAW,kBACX,YAAaA,EAAgB,IAAI,QAAQ,SAAS,MAClD,YAAa,gBACb,iBAAkBA,EAAgB,IAAI,QAAQ,gBAAgB,aAC9D,iBAAkB,eAClB,SAAUA,EAAgB,IAAI,QAAQ,MAAM,YAC5C,SAAU,eAEZ,gBAAiB,4IACjB,UAAW,qGACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,UAAW,MAAO,QAAS,aAAc,YAAY,GAG9D,CACE,GAAI,iCACJ,KAAM,iBACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM4sB,GAAmB,WAAY,KAAM,aAAc,KAAM1sB,EAAS,MACvF,aAAc,CAAE,KAAMysB,GAAe,MAAM,WAAY,KAAM,cAC7D,aAAc,CACZ,UAAWI,EAAgB,OAAO,MAAM,MAAM,UAC9C,UAAW,YACX,aAAc,CAACA,EAAgB,OAAO,MAAM,QAAQ,cAAeA,EAAgB,OAAO,MAAM,QAAQ,aAAa,EACrH,YAAa,CAAC,gBAAiB,eAAe,EAC9C,eAAgB,CAACA,EAAgB,OAAO,UAAU,kBAAmBA,EAAgB,OAAO,UAAU,eAAgBA,EAAgB,OAAO,UAAU,qBAAsBA,EAAgB,OAAO,UAAU,oBAAoB,EAClO,cAAe,CAAC,oBAAqB,iBAAkB,uBAAwB,sBAAsB,EACrG,UAAWA,EAAgB,OAAO,MAAM,MAAM,eAC9C,UAAW,iBACX,YAAaA,EAAgB,OAAO,MAAM,SAAS,QACnD,YAAa,kBACb,iBAAkBA,EAAgB,OAAO,MAAM,gBAAgB,mBAC/D,iBAAkB,qBAClB,SAAUA,EAAgB,OAAO,MAAM,MAAM,YAC7C,SAAU,eAEZ,gBAAiB,6HACjB,UAAW,oHACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,OAAQ,QAAS,QAAS,aAAc,QAAQ,GAEzD,CACE,GAAI,mCACJ,KAAM,mBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM8sB,GAAqB,eAAgB,KAAM,iBAAkB,KAAM5sB,EAAS,OACjG,aAAc,CAAE,KAAMysB,GAAe,QAAQ,mBAAoB,KAAM,sBACvE,aAAc,CACZ,UAAWI,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,aAAc,CAACA,EAAgB,MAAM,QAAQ,QAAQ,eAAgBA,EAAgB,MAAM,QAAQ,QAAQ,OAAO,EAClH,YAAa,CAAC,iBAAkB,SAAS,EACzC,eAAgB,CAACA,EAAgB,MAAM,UAAU,qBAAsBA,EAAgB,MAAM,UAAU,iBAAkBA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,cAAc,EAC1N,cAAe,CAAC,uBAAwB,mBAAoB,oBAAqB,gBAAgB,EACjG,UAAWA,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,YAAaA,EAAgB,MAAM,QAAQ,SAAS,MACpD,YAAa,gBACb,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,aAChE,iBAAkB,eAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBAAiB,4IACjB,UAAW,+GACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,UAAW,QAAS,YAAa,OAAQ,SAAS,GAE3D,CACE,GAAI,mCACJ,KAAM,kBACN,QAASJ,EAAY,KACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM6sB,GAAoB,iBAAkB,KAAM,mBAAoB,KAAM3sB,EAAS,QACpG,aAAc,CAAE,KAAMysB,GAAe,MAAM,YAAa,KAAM,eAC9D,aAAc,CACZ,UAAWI,EAAgB,KAAK,OAAO,MAAM,oBAC7C,UAAW,uBACX,aAAc,CAACA,EAAgB,KAAK,OAAO,QAAQ,eAAgBA,EAAgB,KAAK,OAAO,QAAQ,mBAAmB,EAC1H,YAAa,CAAC,iBAAkB,qBAAqB,EACrD,eAAgB,CAACA,EAAgB,KAAK,UAAU,kBAAmBA,EAAgB,KAAK,UAAU,mBAAoBA,EAAgB,KAAK,UAAU,oBAAqBA,EAAgB,KAAK,UAAU,gBAAgB,EACzN,cAAe,CAAC,oBAAqB,qBAAsB,sBAAuB,kBAAkB,EACpG,UAAWA,EAAgB,KAAK,OAAO,MAAM,WAC7C,UAAW,aACX,YAAaA,EAAgB,KAAK,OAAO,SAAS,OAClD,YAAa,iBACb,iBAAkBA,EAAgB,KAAK,OAAO,gBAAgB,eAC9D,iBAAkB,kBAClB,SAAUA,EAAgB,KAAK,OAAO,MAAM,YAC5C,SAAU,eAEZ,gBAAiB,6IACjB,UAAW,2GACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,SAAU,OAAQ,UAAW,QAAS,cAAc,GAE7D,CACE,GAAI,+BACJ,KAAM,kBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM4sB,GAAmB,mBAAoB,KAAM,qBAAsB,KAAM1sB,EAAS,MACvG,aAAc,CAAE,KAAMysB,GAAe,OAAO,QAAS,KAAM,WAC3D,aAAc,CACZ,UAAWI,EAAgB,MAAM,MAAM,MAAM,aAC7C,UAAW,eACX,aAAc,CAACA,EAAgB,MAAM,MAAM,QAAQ,eAAgBA,EAAgB,MAAM,MAAM,QAAQ,YAAY,EACnH,YAAa,CAAC,iBAAkB,cAAc,EAC9C,eAAgB,CAACA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,oBAAqBA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,eAAe,EACxN,cAAe,CAAC,iBAAkB,mBAAoB,oBAAqB,iBAAiB,EAC5F,UAAWA,EAAgB,MAAM,MAAM,MAAM,gBAC7C,UAAW,kBACX,YAAaA,EAAgB,MAAM,MAAM,SAAS,SAClD,YAAa,mBACb,iBAAkBA,EAAgB,MAAM,MAAM,gBAAgB,gBAC9D,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,MAAM,MAAM,YAC5C,SAAU,eAEZ,gBAAiB,yIACjB,UAAW,mFACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,QAAS,aAAc,UAAW,KAAK,GAUzD,CACE,GAAI,kCACJ,KAAM,wBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM6sB,GAAoB,aAAc,KAAM,iBAAkB,KAAM3sB,EAAS,MAC9F,aAAc,CAAE,KAAMysB,GAAe,OAAO,SAAU,KAAM,YAC5D,aAAc,CACZ,UAAWI,EAAgB,MAAM,OAAO,MAAM,cAC9C,UAAW,gBACX,aAAc,CAACA,EAAgB,MAAM,OAAO,QAAQ,cAAeA,EAAgB,MAAM,OAAO,QAAQ,gBAAgB,EACxH,YAAa,CAAC,iBAAmB,kBAAkB,EACnD,eAAgB,CAACA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,cAAeA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,gBAAgB,EACnN,cAAe,CAAC,iBAAkB,gBAAiB,oBAAqB,kBAAkB,EAC1F,UAAWA,EAAgB,MAAM,OAAO,MAAM,0BAC9C,UAAW,4BACX,YAAaA,EAAgB,MAAM,OAAO,SAAS,SACnD,YAAa,mBACb,iBAAkBA,EAAgB,MAAM,OAAO,gBAAgB,eAC/D,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,OAAO,MAAM,YAC7C,SAAU,eAEZ,gBAAiB,mJACjB,UAAW,oGACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,MAAO,YAAa,SAAU,SAAS,GAEzD,CACE,GAAI,8BACJ,KAAM,sBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM8sB,GAAqB,aAAc,KAAM,eAAgB,KAAM5sB,EAAS,MAC7F,aAAc,CAAE,KAAMysB,GAAe,OAAO,SAAU,KAAM,YAC5D,aAAc,CACZ,UAAWI,EAAgB,MAAM,QAAQ,MAAM,cAC/C,UAAW,gBACX,aAAc,CAACA,EAAgB,MAAM,QAAQ,QAAQ,eAAgBA,EAAgB,MAAM,QAAQ,QAAQ,WAAW,EACtH,YAAa,CAAC,iBAAkB,aAAa,EAC7C,eAAgB,CAACA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,gBAAiBA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,gBAAgB,EACrN,cAAe,CAAC,oBAAqB,kBAAmB,iBAAkB,kBAAkB,EAC5F,UAAWA,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,YAAaA,EAAgB,MAAM,QAAQ,SAAS,MACpD,YAAa,gBACb,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,aAChE,iBAAkB,eAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBAAiB,uHACjB,UAAW,yGACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,QAAS,MAAO,SAAU,UAAW,cAAc,GAI5D,CACE,GAAI,4BACJ,KAAM,cACN,QAASJ,EAAY,IACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM4sB,GAAmB,gBAAiB,KAAM,kBAAmB,KAAM1sB,EAAS,OACjG,aAAc,CAAE,KAAMysB,GAAe,OAAO,WAAY,KAAM,cAC9D,aAAc,CACZ,UAAWI,EAAgB,IAAI,MAAM,MAAM,aAC3C,UAAW,eACX,aAAc,CAACA,EAAgB,IAAI,MAAM,QAAQ,SAAUA,EAAgB,IAAI,MAAM,QAAQ,gBAAgB,EAC7G,YAAa,CAAC,WAAY,kBAAkB,EAC5C,eAAgB,CAACA,EAAgB,IAAI,UAAU,oBAAqBA,EAAgB,IAAI,UAAU,eAAgBA,EAAgB,IAAI,UAAU,kBAAmBA,EAAgB,IAAI,UAAU,kBAAkB,EACnN,cAAe,CAAC,sBAAuB,iBAAkB,oBAAqB,oBAAoB,EAClG,UAAWA,EAAgB,IAAI,MAAM,MAAM,eAC3C,UAAW,iBACX,YAAaA,EAAgB,IAAI,MAAM,SAAS,MAChD,YAAa,gBACb,iBAAkBA,EAAgB,IAAI,MAAM,gBAAgB,SAC5D,iBAAkB,WAClB,SAAUA,EAAgB,IAAI,MAAM,MAAM,YAC1C,SAAU,eAEZ,gBAAiB,qIACjB,UAAW,oGACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,MAAO,QAAS,UAAW,WAAY,MAAM,GAItD,CACE,GAAI,gCACJ,KAAM,gBACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM8sB,GAAqB,eAAgB,KAAM,iBAAkB,KAAM5sB,EAAS,QACjG,aAAc,CAAE,KAAMysB,GAAe,QAAQ,YAAa,KAAM,eAChE,aAAc,CACZ,UAAWI,EAAgB,OAAO,QAAQ,MAAM,YAChD,UAAW,cACX,aAAc,CAACA,EAAgB,OAAO,QAAQ,QAAQ,aAAcA,EAAgB,OAAO,QAAQ,QAAQ,mBAAmB,EAC9H,YAAa,CAAC,eAAgB,qBAAqB,EACnD,eAAgB,CAACA,EAAgB,OAAO,UAAU,eAAgBA,EAAgB,OAAO,UAAU,iBAAkBA,EAAgB,OAAO,UAAU,qBAAsBA,EAAgB,OAAO,UAAU,oBAAoB,EACjO,cAAe,CAAC,iBAAkB,mBAAoB,uBAAwB,sBAAsB,EACpG,UAAWA,EAAgB,OAAO,QAAQ,MAAM,cAChD,UAAW,gBACX,YAAaA,EAAgB,OAAO,QAAQ,SAAS,QACrD,YAAa,kBACb,iBAAkBA,EAAgB,OAAO,QAAQ,gBAAgB,aACjE,iBAAkB,eAClB,SAAUA,EAAgB,OAAO,QAAQ,MAAM,YAC/C,SAAU,eAEZ,gBAAiB,oIACjB,UAAW,iGACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,SAAU,UAAW,UAAW,UAAW,SAAS,GAI7D,CACE,GAAI,4BACJ,KAAM,YACN,QAASJ,EAAY,KACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM6sB,GAAoB,eAAgB,KAAM,kBAAmB,KAAM3sB,EAAS,MACjG,aAAc,CAAE,KAAMysB,GAAe,OAAO,eAAgB,KAAM,kBAClE,aAAc,CACZ,UAAWI,EAAgB,KAAK,OAAO,MAAM,0BAC7C,UAAW,iBACX,aAAc,CAACA,EAAgB,KAAK,OAAO,QAAQ,oBAAqBA,EAAgB,KAAK,OAAO,QAAQ,cAAc,EAC1H,YAAa,CAAC,sBAAuB,gBAAgB,EACrD,eAAgB,CAACA,EAAgB,KAAK,UAAU,kBAAmBA,EAAgB,KAAK,UAAU,oBAAqBA,EAAgB,KAAK,UAAU,mBAAoBA,EAAgB,KAAK,UAAU,gBAAgB,EACzN,cAAe,CAAC,oBAAqB,sBAAuB,qBAAsB,kBAAkB,EACpG,UAAWA,EAAgB,KAAK,OAAO,MAAM,WAC7C,UAAW,aACX,YAAaA,EAAgB,KAAK,OAAO,SAAS,OAClD,YAAa,iBACb,iBAAkBA,EAAgB,KAAK,OAAO,gBAAgB,gBAC9D,iBAAkB,mBAClB,SAAUA,EAAgB,KAAK,OAAO,MAAM,YAC5C,SAAU,eAEZ,gBAAiB,0JACjB,UAAW,oGACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,OAAQ,SAAU,cAAe,aAAc,SAAS,GAIjE,CACE,GAAI,wBACJ,KAAM,uBACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM8sB,GAAqB,SAAU,KAAM,WAAY,KAAM5sB,EAAS,MACrF,aAAc,CAAE,KAAMysB,GAAe,MAAM,kBAAmB,KAAM,qBACpE,aAAc,CACZ,UAAWI,EAAgB,OAAO,QAAQ,MAAM,YAChD,UAAW,cACX,aAAc,CAACA,EAAgB,OAAO,QAAQ,QAAQ,aAAcA,EAAgB,OAAO,QAAQ,QAAQ,YAAY,EACvH,YAAa,CAAC,gBAAkB,cAAc,EAC9C,eAAgB,CAACA,EAAgB,OAAO,UAAU,oBAAqBA,EAAgB,OAAO,UAAU,kBAAmBA,EAAgB,OAAO,UAAU,qBAAsBA,EAAgB,OAAO,UAAU,iBAAiB,EACpO,cAAe,CAAC,sBAAuB,oBAAqB,uBAAwB,mBAAmB,EACvG,UAAWA,EAAgB,OAAO,QAAQ,MAAM,cAChD,UAAW,gBACX,YAAaA,EAAgB,OAAO,QAAQ,SAAS,WACrD,YAAa,qBACb,iBAAkBA,EAAgB,OAAO,QAAQ,gBAAgB,aACjE,iBAAkB,eAClB,SAAUA,EAAgB,OAAO,QAAQ,MAAM,YAC/C,SAAU,eAEZ,gBAAiB,+HACjB,UAAW,oFACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,SAAU,UAAW,cAAe,WAAY,KAAK,GAI9D,CACE,GAAI,+BACJ,KAAM,0BACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM4sB,GAAmB,mBAAoB,KAAM,qBAAsB,KAAM1sB,EAAS,MACvG,aAAc,CAAE,KAAMysB,GAAe,MAAM,iBAAkB,KAAM,oBACnE,aAAc,CACZ,UAAWI,EAAgB,MAAM,MAAM,MAAM,aAC7C,UAAW,eACX,aAAc,CAACA,EAAgB,MAAM,MAAM,QAAQ,eAAgBA,EAAgB,MAAM,MAAM,QAAQ,YAAY,EACnH,YAAa,CAAC,iBAAkB,cAAc,EAC9C,eAAgB,CAACA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,cAAeA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,gBAAgB,EACnN,cAAe,CAAC,iBAAkB,gBAAiB,oBAAqB,kBAAkB,EAC1F,UAAWA,EAAgB,MAAM,MAAM,MAAM,gBAC7C,UAAW,kBACX,YAAaA,EAAgB,MAAM,MAAM,SAAS,SAClD,YAAa,mBACb,iBAAkBA,EAAgB,MAAM,MAAM,gBAAgB,gBAC9D,iBAAkB,kBAClB,SAAUA,EAAgB,MAAM,MAAM,MAAM,YAC5C,SAAU,eAEZ,gBAAiB,2JACjB,UAAW,6GACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,QAAS,MAAO,UAAW,UAAU,GAIvD,CACE,GAAI,4BACJ,KAAM,iBACN,QAASJ,EAAY,IACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM6sB,GAAoB,eAAgB,KAAM,iBAAkB,KAAM3sB,EAAS,QAChG,aAAc,CAAE,KAAMysB,GAAe,OAAO,eAAgB,KAAM,kBAClE,aAAc,CACZ,UAAWI,EAAgB,OAAO,OAAO,MAAM,mBAC/C,UAAW,qBACX,aAAc,CAACA,EAAgB,OAAO,OAAO,QAAQ,eAAgBA,EAAgB,OAAO,OAAO,QAAQ,eAAe,EAC1H,YAAa,CAAC,kBAAoB,iBAAiB,EACnD,eAAgB,CAACA,EAAgB,OAAO,UAAU,mBAAoBA,EAAgB,OAAO,UAAU,mBAAoBA,EAAgB,OAAO,UAAU,oBAAqBA,EAAgB,OAAO,UAAU,qBAAqB,EACvO,cAAe,CAAC,qBAAsB,qBAAsB,sBAAuB,uBAAuB,EAC1G,UAAWA,EAAgB,OAAO,OAAO,MAAM,gBAC/C,UAAW,kBACX,YAAaA,EAAgB,OAAO,OAAO,SAAS,UACpD,YAAa,oBACb,iBAAkBA,EAAgB,OAAO,OAAO,gBAAgB,gBAChE,iBAAkB,mBAClB,SAAUA,EAAgB,OAAO,OAAO,MAAM,YAC9C,SAAU,eAEZ,gBAAiB,0IACjB,UAAW,qHACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,SAAU,MAAO,SAAU,SAAU,QAAQ,GAItD,CACE,GAAI,8BACJ,KAAM,oBACN,QAASJ,EAAY,KACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM6sB,GAAoB,mBAAoB,KAAM,sBAAuB,KAAM3sB,EAAS,OACzG,aAAc,CAAE,KAAMysB,GAAe,OAAO,gBAAiB,KAAM,mBACnE,aAAc,CACZ,UAAWI,EAAgB,KAAK,OAAO,MAAM,oBAC7C,UAAW,uBACX,aAAc,CAACA,EAAgB,KAAK,OAAO,QAAQ,oBAAqBA,EAAgB,KAAK,OAAO,QAAQ,cAAc,EAC1H,YAAa,CAAC,sBAAuB,gBAAgB,EACrD,eAAgB,CAACA,EAAgB,KAAK,UAAU,kBAAmBA,EAAgB,KAAK,UAAU,mBAAoBA,EAAgB,KAAK,UAAU,oBAAqBA,EAAgB,KAAK,UAAU,mBAAmB,EAC5N,cAAe,CAAC,oBAAqB,qBAAsB,sBAAuB,qBAAqB,EACvG,UAAWA,EAAgB,KAAK,OAAO,MAAM,WAC7C,UAAW,aACX,YAAaA,EAAgB,KAAK,OAAO,SAAS,OAClD,YAAa,iBACb,iBAAkBA,EAAgB,KAAK,OAAO,gBAAgB,eAC9D,iBAAkB,kBAClB,SAAUA,EAAgB,KAAK,OAAO,MAAM,YAC5C,SAAU,eAEZ,gBAAiB,+JACjB,UAAW,oGACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,OAAQ,SAAU,WAAY,eAAgB,OAAO,GAI9D,CACE,GAAI,uBACJ,KAAM,qBACN,QAASJ,EAAY,OACrB,cAAeE,EAAc,OAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM6sB,GAAoB,OAAQ,KAAM,SAAU,KAAM3sB,EAAS,OAChF,aAAc,CAAE,KAAMysB,GAAe,QAAQ,cAAe,KAAM,iBAClE,aAAc,CACZ,UAAWI,EAAgB,OAAO,OAAO,MAAM,WAC/C,UAAW,aACX,aAAc,CAACA,EAAgB,OAAO,OAAO,QAAQ,mBAAoBA,EAAgB,OAAO,OAAO,QAAQ,gBAAgB,EAC/H,YAAa,CAAC,qBAAsB,kBAAkB,EACtD,eAAgB,CAACA,EAAgB,OAAO,UAAU,qBAAsBA,EAAgB,OAAO,UAAU,kBAAmBA,EAAgB,OAAO,UAAU,wBAAyBA,EAAgB,OAAO,UAAU,mBAAmB,EAC1O,cAAe,CAAC,uBAAwB,oBAAqB,0BAA2B,qBAAqB,EAC7G,UAAWA,EAAgB,OAAO,OAAO,MAAM,eAC/C,UAAW,iBACX,YAAaA,EAAgB,OAAO,OAAO,SAAS,QACpD,YAAa,UACb,iBAAkBA,EAAgB,OAAO,OAAO,gBAAgB,gBAChE,iBAAkB,mBAClB,SAAUA,EAAgB,OAAO,OAAO,MAAM,YAC9C,SAAU,eAEZ,gBAAiB,2JACjB,UAAW,qGACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,SAAU,SAAU,SAAU,QAAS,QAAQ,GAIxD,CACE,GAAI,uBACJ,KAAM,mBACN,QAASJ,EAAY,MACrB,cAAeE,EAAc,QAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM8sB,GAAqB,OAAQ,KAAM,SAAU,KAAM5sB,EAAS,MACjF,aAAc,CAAE,KAAMysB,GAAe,OAAO,QAAS,KAAM,WAC3D,aAAc,CACZ,UAAWI,EAAgB,MAAM,QAAQ,MAAM,cAC/C,UAAW,gBACX,aAAc,CAACA,EAAgB,MAAM,QAAQ,QAAQ,QAASA,EAAgB,MAAM,QAAQ,QAAQ,cAAc,EAClH,YAAa,CAAC,UAAW,gBAAgB,EACzC,eAAgB,CAACA,EAAgB,MAAM,UAAU,eAAgBA,EAAgB,MAAM,UAAU,cAAeA,EAAgB,MAAM,UAAU,kBAAmBA,EAAgB,MAAM,UAAU,oBAAoB,EACvN,cAAe,CAAC,iBAAkB,gBAAiB,oBAAqB,sBAAsB,EAC9F,UAAWA,EAAgB,MAAM,QAAQ,MAAM,iBAC/C,UAAW,mBACX,YAAaA,EAAgB,MAAM,QAAQ,SAAS,MACpD,YAAa,gBACb,iBAAkBA,EAAgB,MAAM,QAAQ,gBAAgB,aAChE,iBAAkB,eAClB,SAAUA,EAAgB,MAAM,QAAQ,MAAM,YAC9C,SAAU,eAEZ,gBAAiB,oIACjB,UAAW,+FACX,WAAY5sB,EAAW,aACvB,KAAM,CAAC,QAAS,UAAW,UAAW,aAAc,UAAU,GAIhE,CACE,GAAI,4BACJ,KAAM,gBACN,QAASJ,EAAY,KACrB,cAAeE,EAAc,MAC7B,kBAAmBD,EAAU,WAC7B,YAAa,CAAE,KAAM4sB,GAAmB,eAAgB,KAAM,iBAAkB,KAAM1sB,EAAS,MAC/F,aAAc,CAAE,KAAMysB,GAAe,OAAO,WAAY,KAAM,cAC9D,aAAc,CACZ,UAAWI,EAAgB,KAAK,MAAM,MAAM,aAC5C,UAAW,eACX,aAAc,CAACA,EAAgB,KAAK,MAAM,QAAQ,QAASA,EAAgB,KAAK,MAAM,QAAQ,iBAAiB,EAC/G,YAAa,CAAC,UAAW,mBAAmB,EAC5C,eAAgB,CAACA,EAAgB,KAAK,UAAU,iBAAkBA,EAAgB,KAAK,UAAU,kBAAmBA,EAAgB,KAAK,UAAU,oBAAqBA,EAAgB,KAAK,UAAU,gBAAgB,EACvN,cAAe,CAAC,mBAAoB,oBAAqB,sBAAuB,kBAAkB,EAClG,UAAWA,EAAgB,KAAK,MAAM,MAAM,YAC5C,UAAW,cACX,YAAaA,EAAgB,KAAK,MAAM,SAAS,OACjD,YAAa,iBACb,iBAAkBA,EAAgB,KAAK,MAAM,gBAAgB,mBAC7D,iBAAkB,qBAClB,SAAUA,EAAgB,KAAK,MAAM,MAAM,cAC3C,SAAU,iBAEZ,gBAAiB,+HACjB,UAAW,kGACX,WAAY5sB,EAAW,SACvB,KAAM,CAAC,OAAQ,QAAS,OAAQ,UAAW,YAAY,EAE3D,uHCvuFMojC,GAQA,CACJ,MAAO,CACL,EAAG,CACD,MAAO,gBAAiB,aAAc,qBAAsB,KAAM,cAAe,MAAO,kBAAmB,QAAS,mBACpH,QAAS,CAAC,eAAgB,gBAAgB,EAAG,UAAW,CAAC,mBAAoB,oBAAqB,iBAAiB,GAErH,EAAG,CACD,MAAO,uBAAwB,aAAc,mBAAqB,KAAM,cAAe,MAAO,cAAe,QAAS,mBACtH,QAAS,CAAC,iBAAmB,cAAc,EAAG,UAAW,CAAC,mBAAoB,oBAAqB,kBAAkB,GAEvH,EAAG,CACD,MAAO,mBAAoB,aAAc,eAAgB,KAAM,cAAe,MAAO,iBAAkB,QAAS,gBAChH,QAAS,CAAC,iBAAkB,YAAY,EAAG,UAAW,CAAC,iBAAkB,gBAAiB,iBAAiB,EAC7G,EAEF,IAAK,CACH,EAAG,CACD,MAAO,eAAgB,aAAc,WAAY,KAAM,gBAAiB,MAAO,cAAe,QAAS,gBACvG,QAAS,CAAC,mBAAoB,UAAU,EAAG,UAAW,CAAC,iBAAkB,qBAAsB,qBAAqB,GAEtH,EAAG,CACD,MAAO,kBAAmB,aAAc,kBAAoB,KAAM,cAAe,MAAO,mBAAoB,QAAS,gBACrH,QAAS,CAAC,aAAc,gBAAgB,EAAG,UAAW,CAAC,iBAAkB,gBAAiB,qBAAqB,GAEjH,EAAG,CACD,MAAO,cAAe,aAAc,eAAgB,KAAM,cAAe,MAAO,kBAAmB,QAAS,gBAC5G,QAAS,CAAC,qBAAsB,UAAU,EAAG,UAAW,CAAC,iBAAkB,mBAAoB,oBAAoB,EACrH,EAEF,KAAM,CACJ,EAAG,CACD,MAAO,mBAAoB,aAAc,qBAAsB,KAAM,cAAe,MAAO,eAAgB,QAAS,iBACpH,QAAS,CAAC,UAAW,uBAAuB,EAAG,UAAW,CAAC,sBAAuB,qBAAsB,qBAAqB,GAE/H,EAAG,CACD,MAAO,uBAAwB,aAAc,kBAAoB,KAAM,cAAe,MAAO,aAAc,QAAS,iBACpH,QAAS,CAAC,iBAAkB,qBAAqB,EAAG,UAAW,CAAC,sBAAuB,qBAAsB,qBAAqB,GAEpI,EAAG,CACD,MAAO,uBAAwB,aAAc,eAAgB,KAAM,cAAe,MAAO,qBAAsB,QAAS,iBACxH,QAAS,CAAC,gBAAiB,uBAAuB,EAAG,UAAW,CAAC,sBAAuB,qBAAsB,kBAAkB,EAClI,EAEF,OAAQ,CACN,EAAG,CACD,MAAO,gBAAiB,aAAc,qBAAsB,KAAM,YAAa,MAAO,gBAAiB,QAAS,kBAChH,QAAS,CAAC,mBAAoB,eAAe,EAAG,UAAW,CAAC,oBAAqB,kBAAmB,mBAAmB,GAEzH,EAAG,CACD,MAAO,qBAAsB,aAAc,mBAAqB,KAAM,cAAe,MAAO,kBAAmB,QAAS,oBACxH,QAAS,CAAC,kBAAmB,cAAc,EAAG,UAAW,CAAC,oBAAqB,qBAAsB,mBAAmB,GAE1H,EAAG,CACD,MAAO,iBAAmB,aAAc,eAAgB,KAAM,cAAe,MAAO,kBAAmB,QAAS,mBAChH,QAAS,CAAC,iBAAkB,eAAe,EAAG,UAAW,CAAC,qBAAsB,wBAAyB,mBAAmB,EAC9H,EAEF,OAAQ,CACN,EAAG,CACD,MAAO,YAAa,aAAc,qBAAsB,KAAM,cAAe,MAAO,iBAAkB,QAAS,kBAC/G,QAAS,CAAC,gBAAiB,eAAe,EAAG,UAAW,CAAC,oBAAqB,uBAAwB,gBAAgB,GAExH,EAAG,CACD,MAAO,aAAc,aAAc,kBAAoB,KAAM,cAAe,MAAO,iBAAkB,QAAS,UAC9G,QAAS,CAAC,eAAiB,oBAAoB,EAAG,UAAW,CAAC,oBAAqB,uBAAwB,kBAAkB,GAE/H,EAAG,CACD,MAAO,cAAe,aAAc,eAAgB,KAAM,cAAe,MAAO,gBAAiB,QAAS,qBAC1G,QAAS,CAAC,YAAa,cAAc,EAAG,UAAW,CAAC,oBAAqB,sBAAuB,sBAAsB,EACxH,EAEF,UAAW,CACT,EAAG,CACD,MAAO,mBAAoB,aAAc,WAAY,KAAM,cAAe,MAAO,cAAe,QAAS,kBACzG,QAAS,CAAC,WAAY,cAAc,EAAG,UAAW,CAAC,gBAAiB,gBAAiB,qBAAqB,GAE5G,EAAG,CACD,MAAO,qBAAsB,aAAc,kBAAoB,KAAM,cAAe,MAAO,mBAAoB,QAAS,UACxH,QAAS,CAAC,sBAAuB,iBAAkB,EAAG,UAAW,CAAC,gBAAiB,gBAAiB,qBAAqB,GAE3H,EAAG,CACD,MAAO,gBAAiB,aAAc,eAAgB,KAAM,cAAe,MAAO,gBAAiB,QAAS,iBAC5G,QAAS,CAAC,gBAAiB,SAAS,EAAG,UAAW,CAAC,gBAAiB,gBAAiB,qBAAqB,EAC5G,CAEJ,EAGMC,GAAwC,CAE5C,SAAY,CAAC,QAAS,eAAgB,aAAc,kBAAmB,SAAS,EAChF,eAAgB,CAAC,iBAAkB,iBAAkB,EACrD,WAAc,CAAC,UAAU,EACzB,SAAY,CAAC,WAAY,iBAAmB,WAAW,EACvD,cAAe,CAAC,mBAAqB,gBAAiB,kBAAoB,mBAAoB,EAC9F,kBAAoB,CAAC,qBAAsB,SAAU,qBAAsB,gBAAgB,EAC3F,WAAc,CAAC,UAAW,mBAAqB,gBAAiB,qBAAuB,aAAa,EACpG,WAAc,CAAC,iBAAmB,mBAAoB,gBAAiB,uBAAwB,YAAY,EAE3G,WAAc,CAAC,iBAAkB,cAAe,mBAAoB,wBAAyB,cAAc,EAC3G,UAAa,CAAC,iBAAkB,cAAe,eAAgB,wBAAyB,gBAAiB,mBAAoB,UAAU,EACvI,oBAAqB,CAAC,cAAe,UAAW,iBAAkB,EAGlE,cAAe,CAAC,cAAe,UAAW,gBAAiB,UAAW,gBAAiB,WAAY,aAAa,EAChH,WAAc,CAAC,aAAc,cAAe,qBAAuB,gBAAiB,qBAAuB,aAAa,EACxH,UAAa,CAAC,aAAc,WAAY,oBAAsB,eAAiB,kBAAkB,EACjG,QAAW,CAAC,UAAW,mBAAqB,gBAAiB,iBAAkB,EAC/E,WAAc,CAAC,cAAe,aAAc,UAAU,EACtD,iBAAkB,CAAC,kBAAmB,cAAe,UAAW,cAAe,kBAAkB,EACjG,cAAe,CAAC,aAAc,aAAc,sBAAuB,aAAa,EAChF,YAAe,CAAC,oBAAqB,gBAAiB,gBAAiB,aAAa,EACpF,aAAc,CAAC,kBAAmB,sBAAuB,aAAc,UAAU,EACjF,sBAAuB,CAAC,YAAY,EAGpC,iBAAkB,CAAC,iBAAkB,YAAa,gBAAiB,cAAe,iBAAkB,iBAAkB,WAAW,EACjI,WAAc,CAAC,aAAc,cAAe,cAAe,iBAAkB,gBAAgB,EAC7F,eAAgB,CAAC,cAAe,oBAAqB,eAAe,EACpE,SAAY,CAAC,kBAAoB,UAAW,mBAAoB,EAChE,eAAgB,CAAC,mBAAoB,iBAAmB,gBAAiB,YAAY,EACrF,eAAgB,CAAC,iBAAkB,aAAc,eAAgB,iBAAkB,OAAO,EAC1F,aAAgB,CAAC,WAAY,aAAc,cAAe,cAAc,EACxE,kBAAmB,CAAC,uBAAwB,iBAAkB,UAAW,iBAAiB,EAC1F,sBAAuB,CAAC,aAAa,EAGrC,iBAAkB,CAAC,qBAAsB,WAAY,aAAc,eAAe,EAClF,iBAAkB,CAAC,aAAc,aAAc,gBAAiB,WAAW,EAC3E,mBAAoB,CAAC,cAAe,iBAAkB,aAAa,EACnE,SAAY,CAAC,UAAW,oBAAqB,eAAe,EAC5D,YAAe,CAAC,cAAe,gBAAiB,SAAS,EACzD,6BAA8B,CAAC,aAAa,EAI5C,MAAS,CAAC,OAAO,EACjB,kBAAmB,CAAC,gBAAgB,EACpC,WAAc,CAAC,UAAU,EACzB,MAAS,CAAC,UAAU,EACpB,eAAgB,CAAC,UAAU,EAC3B,iBAAkB,CAAC,cAAc,EACjC,WAAY,CAAC,YAAY,EACzB,SAAY,CAAC,UAAU,EACvB,iBAAkB,CAAC,YAAa,YAAY,EAC5C,cAAe,CAAC,YAAa,YAAY,EACzC,cAAe,CAAC,cAAc,EAC9B,kBAAoB,CAAC,WAAY,mBAAmB,EACpD,mBAAqB,CAAC,cAAe,SAAS,EAC9C,aAAc,CAAC,qBAAqB,CACtC,EAIMC,GAAkD,CAEtD,oBAAqB,CAAC,OAAO,EAC7B,WAAc,CAAC,OAAO,EACtB,cAAe,CAAC,QAAS,WAAW,EACpC,mBAAoB,CAAC,OAAO,EAC5B,uBAAwB,CAAC,QAAS,WAAW,EAC7C,kBAAmB,CAAC,OAAO,EAC3B,qBAAsB,CAAC,QAAS,WAAW,EAC3C,wBAAyB,CAAC,OAAO,EACjC,aAAc,CAAC,OAAO,EACtB,iBAAkB,CAAC,OAAO,EAC1B,mBAAoB,CAAC,OAAO,EAC5B,sBAAuB,CAAC,QAAS,WAAW,EAC5C,iBAAmB,CAAC,QAAS,WAAW,EACxC,yBAA2B,CAAC,OAAO,EACnC,mBAAqB,CAAC,OAAO,EAC7B,iBAAkB,CAAC,QAAS,WAAW,EAGvC,yBAA0B,CAAC,OAAQ,WAAW,EAC9C,WAAc,CAAC,MAAM,EACrB,mBAAoB,CAAC,OAAQ,WAAW,EACxC,mBAAoB,CAAC,MAAM,EAC3B,mBAAoB,CAAC,MAAM,EAC3B,mBAAoB,CAAC,OAAQ,WAAW,EACxC,cAAe,CAAC,MAAM,EACtB,WAAc,CAAC,MAAM,EACrB,cAAe,CAAC,OAAQ,WAAW,EACnC,sBAAwB,CAAC,OAAQ,WAAW,EAC5C,mBAAoB,CAAC,MAAM,EAC3B,sBAAuB,CAAC,MAAM,EAC9B,eAAgB,CAAC,MAAM,EACvB,gBAAiB,CAAC,OAAQ,WAAW,EAGrC,oBAAqB,CAAC,MAAO,WAAW,EACxC,iBAAkB,CAAC,MAAO,WAAW,EACrC,iBAAkB,CAAC,MAAO,WAAW,EACrC,sBAAwB,CAAC,KAAK,EAC9B,mBAAoB,CAAC,MAAO,WAAW,EACvC,qBAAsB,CAAC,KAAK,EAC5B,cAAe,CAAC,KAAK,EACrB,mBAAqB,CAAC,MAAO,WAAW,EACxC,gBAAkB,CAAC,KAAK,EACxB,gBAAiB,CAAC,KAAK,EACvB,kBAAoB,CAAC,KAAK,EAC1B,8BAA+B,CAAC,KAAK,EACrC,6BAA8B,CAAC,MAAO,WAAW,EACjD,2BAA4B,CAAC,MAAO,WAAW,EAG/C,oBAAqB,CAAC,SAAU,WAAW,EAC3C,0BAA2B,CAAC,SAAU,WAAW,EACjD,iBAAkB,CAAC,SAAU,WAAW,EACxC,iBAAkB,CAAC,SAAU,WAAW,EACxC,cAAe,CAAC,QAAQ,EACxB,iBAAkB,CAAC,QAAQ,EAC3B,wBAAyB,CAAC,SAAU,WAAW,EAG/C,SAAY,CAAC,SAAU,WAAW,EAClC,YAAe,CAAC,SAAU,WAAW,EACrC,uBAAyB,CAAC,SAAU,WAAW,EAC/C,eAAgB,CAAC,SAAU,WAAW,EAGtC,UAAa,CAAC,WAAW,EACzB,aAAgB,CAAC,WAAW,EAC5B,SAAY,CAAC,WAAW,CAC1B,EAGMC,GAAsC,CAE1C,MAAS,QAAS,OAAU,QAAS,OAAU,QAAS,QAAW,QAAS,YAAe,QAC3F,QAAW,QAAS,KAAQ,QAAS,YAAe,QAAS,MAAS,QAAS,aAAgB,QAC/F,SAAY,QAAS,mBAAoB,QAAS,aAAc,QAAS,gBAAiB,QAC1F,gBAAiB,QAAS,eAAgB,QAG1C,KAAQ,OAAQ,SAAY,OAAQ,OAAU,OAAQ,SAAY,OAAQ,aAAgB,OAC1F,OAAU,OAAQ,WAAc,OAAQ,MAAS,OAAQ,KAAQ,OAAQ,SAAY,OACrF,cAAiB,OAAQ,YAAa,OAAQ,WAAc,OAAQ,kBAAmB,OACvF,eAAgB,OAAQ,mBAAoB,OAAQ,kBAAmB,OAGvE,IAAO,MAAO,KAAQ,MAAO,MAAS,MAAO,UAAa,MAAO,cAAe,MAChF,MAAS,MAAO,SAAY,MAAO,YAAe,MAAO,cAAe,MACxE,aAAgB,MAAO,iBAAkB,MAAO,kBAAmB,MAAO,YAAa,MACvF,eAAiB,MAGjB,OAAU,SAAU,KAAQ,SAAU,OAAU,SAAU,QAAW,SAAU,QAAW,SAC1F,QAAW,SAAU,aAAc,SAAU,UAAa,SAAU,iBAAmB,SACvF,gBAAiB,SAAU,qBAAsB,SAGjD,OAAU,SAAU,QAAW,SAAU,QAAW,SAAU,MAAS,SAAU,OAAU,SAC3F,aAAc,SAAU,WAAc,SAAU,OAAU,SAAU,UAAa,SACjF,YAAe,SAAU,UAAa,SAAU,WAAc,SAE9D,UAAa,YAAa,cAAiB,YAAa,MAAS,YAAa,YAAa,YAC3F,UAAa,YAAa,SAAY,YAAa,aAAgB,YAAa,WAAc,YAE9F,oBAAqB,QAAS,QAAW,MAAO,kBAAmB,SAAU,aAAc,SAC3F,UAAa,SAAU,cAAe,SAAU,iBAAkB,QAAS,gBAAiB,QAC5F,gBAAiB,SAAU,gBAAiB,OAAQ,QAAW,QAAS,gBAAiB,MACzF,WAAY,MAAO,oBAAqB,MAExC,eAAgB,YAAa,SAAY,YAAa,eAAgB,YACtE,SAAY,YAAa,OAAU,YAAa,SAAY,YAC5D,SAAY,YAAa,OAAU,YAAa,OAAU,YAC1D,QAAW,YAAa,oBAAqB,YAC7C,OAAU,YAAa,QAAW,YAAa,SAAY,YAC3D,QAAW,YAAa,MAAS,YAAa,MAAS,YACvD,QAAW,YAAa,UAAa,YAAa,UAAa,YAC/D,UAAa,WACf,EAEMC,GAA0C,CAE9C,kBAAmB,KACnB,gBAAiB,KACjB,uBAAwB,KACxB,mBAAqB,KACrB,WAAY,KACZ,YAAa,KACb,oBAAqB,KACrB,gBAAiB,KACjB,kBAAmB,KACnB,iBAAmB,KACnB,iBAAkB,KAClB,2BAA4B,KAC5B,mBAAoB,KACpB,yBAA0B,KAC1B,oBAAqB,KACrB,qBAAsB,KACtB,gBAAkB,KAGlB,cAAe,CAAC,OAAO,EACvB,kBAAoB,CAAC,QAAS,WAAW,EACzC,WAAc,CAAC,OAAO,EACtB,mBAAoB,CAAC,OAAO,EAC5B,oBAAqB,CAAC,OAAO,EAC7B,uBAAwB,CAAC,OAAO,EAChC,kBAAmB,CAAC,OAAO,EAG3B,gBAAkB,CAAC,OAAQ,WAAW,EACtC,yBAA0B,CAAC,MAAM,EACjC,WAAc,CAAC,OAAQ,WAAW,EAClC,mBAAoB,CAAC,MAAM,EAC3B,mBAAoB,CAAC,MAAM,EAC3B,mBAAoB,CAAC,MAAM,EAG3B,oBAAqB,CAAC,KAAK,EAC3B,iBAAkB,CAAC,KAAK,EACxB,iBAAkB,CAAC,MAAO,WAAW,EACrC,sBAAwB,CAAC,KAAK,EAC9B,mBAAoB,CAAC,MAAO,WAAW,EACvC,qBAAsB,CAAC,KAAK,EAG5B,0BAA2B,CAAC,QAAQ,EACpC,oBAAqB,CAAC,SAAU,WAAW,EAG3C,YAAe,CAAC,SAAU,WAAW,EACrC,SAAY,CAAC,SAAU,WAAW,EAGlC,UAAa,CAAC,WAAW,EAGzB,UAAa,KACb,oBAAqB,KACrB,iBAAkB,KAClB,aAAc,KACd,2BAA6B,KAC7B,WAAc,KACd,yBAA0B,KAC1B,sBAAwB,KACxB,mBAAoB,KACpB,YAAa,KACb,cAAe,KACf,YAAa,KACb,kBAAmB,KACnB,oBAAqB,KAGrB,sBAAuB,CAAC,OAAO,EAC/B,mBAAqB,CAAC,QAAS,WAAW,EAC1C,iBAAmB,CAAC,OAAO,EAC3B,oBAAqB,CAAC,OAAO,EAC7B,yBAA2B,CAAC,OAAO,EACnC,iBAAkB,CAAC,OAAO,EAG1B,mBAAoB,CAAC,OAAQ,WAAW,EACxC,iBAAmB,CAAC,MAAM,EAC1B,sBAAwB,CAAC,OAAQ,WAAW,EAC5C,WAAc,CAAC,MAAM,EACrB,cAAe,CAAC,MAAM,EACtB,cAAe,CAAC,MAAM,EAGtB,gBAAiB,CAAC,KAAK,EACvB,mBAAqB,CAAC,KAAK,EAC3B,gBAAkB,CAAC,KAAK,EACxB,cAAe,CAAC,KAAK,EACrB,kBAAoB,CAAC,KAAK,EAG1B,iBAAkB,CAAC,QAAQ,EAC3B,iBAAkB,CAAC,SAAU,WAAW,EAGxC,uBAAyB,CAAC,SAAU,WAAW,EAG/C,aAAgB,CAAC,WAAW,EAC5B,WAAc,CAAC,WAAW,EAG1B,gBAAiB,KACjB,iBAAkB,KAClB,WAAc,KACd,wBAAyB,KACzB,iBAAkB,KAClB,aAAgB,KAChB,uBAAwB,KACxB,WAAc,KACd,YAAa,KAGb,mBAAoB,CAAC,OAAO,EAC5B,qBAAsB,CAAC,OAAO,EAC9B,aAAc,CAAC,OAAO,EACtB,iBAAkB,CAAC,OAAO,EAC1B,mBAAoB,CAAC,OAAO,EAG5B,mBAAoB,CAAC,MAAM,EAC3B,sBAAuB,CAAC,MAAM,EAC9B,eAAgB,CAAC,MAAM,EACvB,gBAAiB,CAAC,OAAQ,WAAW,EAGrC,8BAA+B,CAAC,KAAK,EACrC,8BAA+B,CAAC,KAAK,EACrC,6BAA8B,CAAC,MAAO,WAAW,EACjD,kBAAmB,CAAC,KAAK,EAGzB,wBAAyB,CAAC,QAAQ,EAClC,cAAe,CAAC,QAAQ,EACxB,iBAAkB,CAAC,QAAQ,EAG3B,eAAgB,CAAC,SAAU,WAAW,EACtC,oBAAqB,CAAC,SAAU,WAAW,EAG3C,SAAY,CAAC,WAAW,CAC1B,EAEA,SAASC,GAAmB1wB,EAAoC,CAC9D,GAAI,CAACA,GAAK,kBAAmB,OAAO,KACpC,MAAM1F,EAAO0F,EAAI,kBAAkB,KAAK,cAGxC,SAAW,CAACxT,EAAKmkC,CAAU,IAAK,OAAO,QAAQF,EAAa,EAC1D,GAAIn2B,EAAK,SAAS9N,CAAG,GAAKA,EAAI,SAAS8N,CAAI,EAEzC,OAAOq2B,EAIX,MAAM5B,GAAQ/uB,EAAI,kBAAkB,YAAc,IAAMA,EAAI,kBAAkB,MAAM,cAE9E4wB,MAAe,IACrB,SAAW,CAACC,EAASrpB,CAAO,IAAK,OAAO,QAAQgpB,EAAW,EACrDzB,EAAK,SAAS8B,CAAO,GACvBD,EAAS,IAAIppB,CAAO,EAIxB,OAAIopB,EAAS,OAAS,EAAU,KAC5BA,EAAS,OAAS,EAAU,MAAM,KAAKA,CAAQ,EAAE,CAAC,EAC/C,MAAM,KAAKA,CAAQ,CAC5B,CAEA,SAASE,GAAW/5B,EAAW,CAC7B,OAAOA,EAAE,OAAO,CAAC,EAAE,cAAgBA,EAAE,MAAM,CAAC,CAC9C,CAKA,SAASg6B,GAAgBC,EAAYC,EAA6B,CAChE,MAAMhhC,EAAS,CAAC,GAAG+gC,CAAK,EAmBlBE,EAASD,IAAS,QAhBAl6B,GAAuB,CAC7C,IAAI2N,EAAI,OAAO3N,GAAM,SACjBA,EAAE,MAAM,EAAE,EAAE,OAAO,CAACmH,EAAG5E,KAAQ4E,GAAK,GAAKA,EAAK5E,EAAE,WAAW,CAAC,EAAG,CAAC,EAChEvC,EAKJ,OAAA2N,EAAI,KAAK,IAAIA,CAAC,GAAK,EAEZ,KACLA,EAAKA,EAAI,MAAS,YACVA,EAAI,GAAK,WAErB,GAEmDusB,CAAI,EAAI,KAAK,OAEhE,QAAS,EAAIhhC,EAAO,OAAS,EAAG,EAAI,EAAG,IAAK,CAC1C,MAAM4R,EAAI,KAAK,MAAMqvB,EAAA,GAAY,EAAI,EAAE,EACvC,CAACjhC,EAAO,CAAC,EAAGA,EAAO4R,CAAC,CAAC,EAAI,CAAC5R,EAAO4R,CAAC,EAAG5R,EAAO,CAAC,CAAC,CAChD,CACA,OAAOA,CACT,CAKA,eAAsBkhC,GAAsB10B,EAAuD,CAUjG,OAAO2zB,GAAoB,OAAOr5B,GAAKA,EAAE,gBAAkB0F,CAAS,EAAE,IAAIuD,IAAQ,CAChF,MAAO,IACP,UAAWA,EAAI,cACf,MAAOA,EAAI,YAAY,KACvB,OAAQA,EAAI,cAAc,MAAQ,GAClC,UAAWA,EAAI,KACf,YAAaA,EAAI,gBACjB,aAAcA,EAAI,QAClB,MAAOA,EAAI,aAAa,UACxB,aAAcA,EAAI,aAAa,iBAC/B,KAAMA,EAAI,aAAa,SACvB,MAAOA,EAAI,aAAa,UACxB,QAASA,EAAI,aAAa,YAC1B,QAASA,EAAI,aAAa,YAC1B,UAAWA,EAAI,aAAa,cAC5B,cAAeA,EAAI,aAAa,gBAAgB,QAAU,EAC1D,QAASA,EAAI,QAAQ,cACrB,WAAYA,CAAA,EACZ,CACJ,CAKA,eAAsBoxB,GACpBC,EACAC,EACA3B,EACAtuB,EAII,GAC0B,CAC9B,KAAM,CAAE,WAAAkwB,EAAa,IAAK,SAAAC,EAAW,EAAG,KAAAP,EAAO,GAAM5vB,EAG/ClM,EAAY,MAAMg8B,GAAsBxB,CAAa,EAC3D,GAAI,CAACx6B,EAAU,OAAQ,MAAO,GAG9B,MAAMs8B,EAAe,GAAGH,CAAgB,IAAIL,CAAI,GAIhD,IAAInhB,EAEJ,OAAQuhB,EAAA,CACN,IAAK,WAEH,MAAMK,EAAcJ,EAAiB,cAAc,MAAM,GAAG,EAAE,IAAIv6B,GAAKA,EAAE,MAAM,EACvD26B,EAAY,KAAK36B,GAAKA,IAAM,OAASA,IAAM,IAAMA,IAAM,SAAS,EAGtF+Y,EAAW3a,EAEX2a,EAAW3a,EAAU,OAAO4B,GAC1B26B,EAAY,SAAS36B,EAAE,OAAO,GAC9B26B,EAAY,KAAKC,GAAQ56B,EAAE,aAAa,cAAc,SAAS46B,CAAI,CAAC,GAGxE,MAEF,IAAK,QAEH,MAAMC,EAAcN,EAAiB,cACrCxhB,EAAW3a,EAAU,OAAO4B,GAC1BA,EAAE,MAAM,cAAc,SAAS66B,CAAW,GAC1CA,EAAY,SAAS76B,EAAE,MAAM,aAAa,GAE5C,MAEF,IAAK,SAEH,MAAM86B,EAAeP,EAAiB,cACtCxhB,EAAW3a,EAAU,OAAO4B,GAC1BA,EAAE,OAAO,cAAc,SAAS86B,CAAY,GAC5CA,EAAa,SAAS96B,EAAE,OAAO,aAAa,GAE9C,MAEF,QACE+Y,EAAW,EAAC,CAKhBA,EAAWA,EAAS,OAAO/Y,GAAKA,EAAE,OAASy6B,CAAQ,EAInD1hB,EAAS,KAAK,CAAC5R,EAAG5E,IAAMA,EAAE,MAAQ4E,EAAE,KAAK,EAIzC,IAAI4zB,EAAsC,GAC1C,MAAMC,MAAa,IAEnBjiB,EAAS,QAAQ/Y,GAAK,CACfg7B,EAAO,IAAIh7B,EAAE,KAAK,GAAGg7B,EAAO,IAAIh7B,EAAE,MAAO,EAAE,EAChDg7B,EAAO,IAAIh7B,EAAE,KAAK,EAAG,KAAKA,CAAC,CAC7B,CAAC,EAED,MAAMi7B,EAAe,MAAM,KAAKD,EAAO,MAAM,EAAE,KAAK,CAAC7zB,EAAG5E,IAAMA,EAAI4E,CAAC,EACnE,UAAWwD,KAASswB,EAAc,CAChC,MAAMlS,EAAQiS,EAAO,IAAIrwB,CAAK,EAExBuwB,EAAgBlB,GAAajR,EAAO,GAAG2R,CAAY,IAAI/vB,CAAK,EAAE,EACpEowB,EAAkB,CAAC,GAAGA,EAAiB,GAAGG,CAAa,CACzD,CAEAniB,EAAWgiB,EAAgB,MAAM,EAAGP,EAAa,CAAC,EAGlD,MAAM3K,EAAmC,GACnCsL,MAAuB,IAG7B,UAAW1O,KAAW1T,EAAU,CAC9B,GAAI8W,EAAY,QAAU2K,EAAY,MACtC,GAAI,CAAC/N,EAAQ,OAAS,CAACA,EAAQ,OAAQ,SAGvC,KAAM,CAAC2O,EAAaC,CAAY,EAAI,MAAM,QAAQ,IAAI,CACpDjC,GAAkB,eAAe3M,EAAQ,KAAK,EAC9C2M,GAAkB,eAAe3M,EAAQ,MAAM,EAChD,EAEG,CAAC2O,GAAe,CAACC,IAErBF,EAAiB,IAAIC,EAAY,KAAK,gBAAkB3O,EAAQ,KAAK,EAErEoD,EAAY,KAAK,CACf,QAAApD,EACA,WAAY6N,EACZ,YAAAc,EACA,aAAAC,EACA,QAAS5O,EAAQ,QAClB,EACH,CAGA,GAAIoD,EAAY,OAAS2K,EAAY,CACnC1mC,GAAS,iBAAkB,kBAAkB+7B,EAAY,MAAM,IAAI2K,CAAU,2BAA2B,EAExG,MAAMG,EAAcJ,EAAiB,cAAc,MAAM,GAAG,EAAE,IAAIv6B,GAAKA,EAAE,MAAM,EACzEs7B,EAAgBX,EAAY,KAAK36B,GAAKA,IAAM,OAASA,IAAM,IAAMA,IAAM,SAAS,EAGtF,IAAIu7B,EAAiB,MAAMnC,GAAkB,uBAAuBR,EAAe,OAAO,EACtF0C,IACFC,EAAiBvB,GAAauB,EAAgBb,CAAY,GAG5D,MAAMc,EAAmB,MAAMpC,GAAkB,uBAAuB,EAAU,QAAQ,EAE1F,UAAWnU,KAASsW,EAAgB,CAClC,GAAI1L,EAAY,QAAU2K,EAAY,MAEtC,MAAMiB,EAAYxW,EAAM,WAAW,kBAAkB,KAAK,cACpDyW,EAAkBzW,EAAM,KAAK,gBAAkBA,EAAM,KAAK,SAAS,WAGzE,GAAIqV,IAAe,SAAW,CAACrV,EAAM,WAAW,kBAAkB,KAAK,cAAc,SAASsV,EAAiB,aAAa,EAAG,SAG/H,IAAIoB,EAAWhC,GAAmB1U,EAAM,UAAU,EAC9C2W,GAA2B,GAG/B,MAAMC,EAAiBrC,GAAsBiC,CAAS,EAClDI,EACFD,GAAiBC,EACR,MAAM,QAAQF,CAAQ,EAC/BC,GAAiBD,EACRA,EAETC,GAAiB,CAACD,CAAkB,GAGpCC,GAAiB,CAAC,YAAa,QAAS,OAAQ,MAAO,SAAU,QAAQ,EACrEN,IACFM,GAAiB5B,GAAa4B,GAAgB,GAAGlB,CAAY,IAAIgB,CAAe,EAAE,IAItF,UAAWI,KAAMF,GAAgB,CAC/B,GAAI/L,EAAY,QAAU2K,EAAY,MAGtC,GAAIF,IAAe,YAAc,CAACgB,GAAiB,CAACX,EAAY,SAASmB,CAAE,EAAG,SAG9E,IAAItoB,EAAiC,GAGrC,SAAW,CAAC/d,EAAKsmC,EAAgB,IAAK,OAAO,QAAQxC,EAAW,EAC9D,GAAIkC,EAAU,SAAShmC,CAAG,EAAG,CAC3B,MAAM82B,EAAUiP,EAAiB,OAAOxsB,IAAK+sB,GAAiB,KAAKC,IAAMhtB,GAAE,WAAW,kBAAkB,KAAK,cAAc,SAASgtB,EAAE,CAAC,CAAC,EACxI,GAAIzP,EAAQ,OAAS,EAAG,CACtB/Y,EAAa+Y,EACb,KACF,CACF,CAKF,GAAI/Y,EAAW,SAAW,EAAG,CAC3B,MAAMyoB,EAAYhX,EAAM,WAAW,kBAAkB,YAAY,cAC3DiX,GAAcV,EAAiB,OAAOxsB,GAAK,CAC/C,MAAMmtB,GAAantB,EAAE,WAAW,kBAAkB,YAAY,cAC9D,OAAO,OAAO,KAAKyqB,EAAW,EAAE,KAAK2C,IACnC3C,GAAY2C,EAAI,IAAM,aAAeH,EAAU,SAASG,EAAI,GAAKD,GAAW,SAASC,EAAI,EAE7F,CAAC,EACGF,GAAY,OAAS,IAAG1oB,EAAa0oB,GAC3C,CAGA,GAAI5B,IAAe,SAAU,CAC3B,MAAM+B,EAAmB9B,EAAiB,cAEpC+B,EADed,EAAiB,KAAKxsB,IAAKA,GAAE,WAAW,kBAAkB,KAAK,cAAc,SAASqtB,CAAgB,CAAC,GACpF,WAAW,kBAAkB,YAAY,eAAiB,GAG5FE,GAAa/oB,EAAW,KAAKxE,IAAKA,GAAE,WAAW,kBAAkB,KAAK,cAAc,SAASqtB,CAAgB,CAAC,EAEpH,GAAIE,GACF/oB,EAAa,CAAC+oB,EAAU,MACnB,CAGL,MAAMC,GAAeV,EACf9yB,GAAwC,CAAE,IAAK,EAAG,MAAO,EAAG,KAAM,EAAG,OAAQ,EAAG,OAAQ,GAGxFyzB,GADyBjB,EAAiB,OAAOxsB,IAAKA,GAAE,WAAW,kBAAkB,KAAK,cAAc,SAASqtB,CAAgB,CAAC,EAC7F,KAAKrtB,IAAK,CAEnD,MAAM0tB,GAAgB,OAAO1tB,GAAE,WAAW,WAAW,cAAc,IAAM,OAAOxY,EAAc,eAAe,EACvGmmC,GAAkB,OAAO3tB,GAAE,WAAW,qBAAqB,IAAM,EACvE,GAAI0tB,IAAiBC,GAAiB,MAAO,GAG7C,MAAMC,GAAkB5zB,GAAcwzB,EAAY,GAAK,EACjDK,GAAmB,OAAO7tB,GAAE,WAAW,qBAAqB,EAElE,GAD6B6tB,KAAqBD,IAAmBC,KAAqB,EAChE,MAAO,GAGjC,MAAMC,GAAmB7X,EAAM,WAAW,kBAAkB,YAAY,cAIxE,OAH4B,OAAO,KAAKwU,EAAW,EAAE,SACnDqD,GAAiB,SAASriC,EAAC,GAAK6hC,EAAkB,SAAS7hC,EAAC,IAEhC6hC,EAAkB,SAASE,EAAY,CACvE,CAAC,EAED,GAAIC,GACFjpB,EAAa,CAACipB,EAAW,MAGzB,SAEJ,CACF,CAGA,GAAIjpB,EAAW,SAAW,EAAG,CAE3B,MAAMupB,GADwC,CAAE,IAAK,EAAG,MAAO,EAAG,KAAM,EAAG,OAAQ,EAAG,OAAQ,GAC3DjB,CAAE,EACjCiB,KACFvpB,EAAagoB,EAAiB,OAAOxsB,GAAK,OAAOA,EAAE,WAAW,qBAAqB,IAAM+tB,EAAY,GAEnGvpB,EAAW,SAAW,IACxBA,EAAagoB,EAAiB,OAAOxsB,GAAK,CACxC,MAAM9L,GAAO,OAAO8L,EAAE,WAAW,qBAAqB,EAChD9D,GAAO,OAAO8D,EAAE,WAAW,iBAAiB,EAClD,OAAO9L,KAAS,GAAKgI,KAAS,CAChC,CAAC,EAEDsI,EAAaA,EAAW,OAAOxE,GAAK,CAACA,EAAE,WAAW,kBAAkB,KAAK,cAAc,SAAS,cAAc,CAAC,EAEnH,CAEIwE,EAAW,SAAW,IAAGA,EAAagoB,GAG1C,IAAIwB,EAAsB,CAACxpB,EAAW,CAAC,CAAC,EAIxC,GAAI8mB,IAAe,SACjB0C,EAAsB,CAACxpB,EAAW,CAAC,CAAC,UAC3BA,EAAW,OAAS,EAAG,CAGhC,MAAMypB,MAAmB,IACzBzpB,EAAW,QAAQtV,IAAK,CACtB,MAAMgF,GAAOhF,GAAE,KAAK,SACpB,GAAI,CAAC++B,EAAa,IAAI/5B,EAAI,EACxB+5B,EAAa,IAAI/5B,GAAMhF,EAAC,MACnB,CAEL,MAAMspB,GAAWyV,EAAa,IAAI/5B,EAAI,EACnBhF,GAAE,WAAa,YAChBspB,GAAS,WAAa,YACtCyV,EAAa,IAAI/5B,GAAMhF,EAAC,CAE5B,CACF,CAAC,EAED,MAAMg/B,GAAmB,MAAM,KAAKD,EAAa,QAAQ,EAInDE,EAAqBnD,GAAakD,GAAkB,GAAGxC,CAAY,IAAIoB,CAAE,EAAE,EAC3E3yB,GAAQ,KAAK,IAAI,EAAGqxB,EAAa3K,EAAY,MAAM,EACzDmN,EAAsBG,EAAmB,MAAM,EAAGh0B,EAAK,CACzD,CAEA,UAAWi0B,KAAsBJ,EAAqB,CAEpD,MAAMK,GAAe,GAAG3B,CAAe,IAAI0B,EAAmB,KAAK,gBAAkBA,EAAmB,KAAK,QAAQ,IAAItB,CAAE,GAC3H,GAAIX,EAAiB,IAAIkC,EAAY,EAAG,SACxClC,EAAiB,IAAIkC,EAAY,EAEjC,MAAMC,EAAgBhE,GAAkBwC,CAAE,IAAIlD,CAAa,GAAKU,GAAkB,UAAaV,CAAa,EACtG2E,GAAczB,IAAO,YAErB0B,GAAiC,CACrC,MAAO,GACP,UAAW5E,EACX,MAAO3T,EAAM,WAAW,kBAAkB,KAC1C,OAAQmY,EAAmB,WAAW,kBAAkB,KACxD,UAAW,GAAGnY,EAAM,WAAW,kBAAkB,IAAI,IAAIsY,GAAc,QAAUxD,GAAW+B,CAAE,CAAC,GAC/F,YAAa7W,EAAM,WAAW,kBAAkB,aAAe,eAAeA,EAAM,WAAW,kBAAkB,IAAI,IACrH,aAAcsY,GAAc,YAAcxD,GAAW+B,CAAE,EACvD,QAASA,EACT,MAAOwB,GAAe,OAAS,gBAC/B,aAAcA,GAAe,cAAgB,gBAC7C,KAAMA,GAAe,MAAQ,cAC7B,MAAOA,GAAe,OAAS,gBAC/B,QAASA,GAAe,SAAW,UACnC,QAASA,GAAe,SAAW,GACnC,UAAWA,GAAe,WAAa,GACvC,cAAe,EACf,oBAAqBC,GAAc,gBAAkB,QAiBvD,GAZIA,KACFC,GAAa,QAAU,aAGzB3N,EAAY,KAAK,CACf,QAAS2N,GACT,WAAYlD,EACZ,YAAarV,EACb,aAAcmY,EACd,QAAStB,CAAA,CACV,EAEGjM,EAAY,QAAU2K,EAAY,KACxC,CACF,CACF,CACF,CAGA,OAAA3K,EAAY,KAAK,CAAC1oB,EAAG5E,IAAM,CACzB,MAAMk7B,EAAe,OAAOt2B,EAAE,OAAO,EAAE,gBAAkB,YACnDu2B,EAAe,OAAOn7B,EAAE,OAAO,EAAE,gBAAkB,YACzD,OAAIk7B,GAAgB,CAACC,EAAqB,GACtC,CAACD,GAAgBC,EAAqB,EACnC,CACT,CAAC,EAEM7N,CACT,CCj3BA,MAAM8N,GAAiB,CACnBnnC,EAAc,gBACdA,EAAc,eACdA,EAAc,aAClB,EAEMonC,GAAgB,CAClBpnC,EAAc,OACdA,EAAc,UACdA,EAAc,YACdA,EAAc,UACdA,EAAc,WAClB,EAEMqnC,GAA4C,CAC9C,EAAG,UACH,EAAG,MACH,EAAG,QACH,EAAG,OACH,EAAG,SACH,EAAG,QACP,EAEMlO,GAAyC,CAC3C,CAAC75B,EAAY,OAAO,EAAG,UACvB,CAACA,EAAY,GAAG,EAAG,UACnB,CAACA,EAAY,KAAK,EAAG,UACrB,CAACA,EAAY,IAAI,EAAG,UACpB,CAACA,EAAY,MAAM,EAAG,UACtB,CAACA,EAAY,MAAM,EAAG,UACtB,CAACA,EAAY,SAAS,EAAG,SAC7B,EA4BA,SAASgoC,GACLh/B,EACAi/B,EACAC,EACAC,EACAC,EACO,CACP,MAAM3uB,EAAWzQ,EAAK,UAAYA,EAAK,KACvC,GAAIyQ,IAAa,OAAW,MAAO,GAEnC,MAAMjE,EAAUoB,EAAgB,QAAQ6C,CAAQ,EAIhD,GAHI,CAACjE,GAGD0yB,GAAiBA,IAAkB,OACfE,EAAa3uB,CAAQ,EACzB,gBAAkByuB,EAAc,cAAe,MAAO,GAG1E,GAAIC,GAAeA,IAAgB,MAAO,CAMtC,MAAME,EALmC,CACrC,MAAS,EACT,OAAU,EACV,QAAW,GAEkBF,EAAY,aAAa,EAC1D,GAAIE,IAAoB,QAAa7yB,EAAQ,YAAc,GAAKA,EAAQ,YAAc6yB,EAClF,MAAO,EAEf,CAGA,GAAI,CAACJ,GAAe,CAACA,EAAY,OAAQ,MAAO,GAEhD,MAAMK,EADQL,EAAY,cAAc,OACpB,MAAM,KAAK,EAEzBtzB,EAAWa,EAAQ,mBAAmB,MAAM,eAAiB,GAC7DnB,EAAWmB,EAAQ,qBAAqB,eAAiB,GACzD+yB,EAAkB/yB,EAAQ,mBAAmB,aAAa,eAAiB,GAC3EgzB,EAAWhzB,EAAQ,WAAW,SAC9BizB,EAAcL,EAAa3uB,CAAQ,EAAE,cAG3C,OAAO6uB,EAAM,MAAMxD,GAAQ,CACvB,IAAI4D,EAAQ,GACRC,EAAa7D,EA4BjB,OA1BIA,EAAK,WAAW,KAAK,IACrB4D,EAAQ,GACRC,EAAa7D,EAAK,UAAU,CAAC,GAI7B6D,IAAe,UAAYnzB,EAAQ,WAAa,GAChDmzB,IAAe,SAAWnzB,EAAQ,WAAa,GAC/CmzB,IAAe,UAAYH,IAAa,GACxCG,IAAe,aAAeH,IAAa,GAC3CG,IAAe,QAAUH,IAAa,GACtCG,IAAe,YAAcH,IAAa,GAC1CG,IAAe,UAAYH,IAAa,GAGxCG,IAAe,WAAanzB,EAAQ,oBAAsB,GAC1DmzB,IAAe,QAAUnzB,EAAQ,oBAAsB,GAAKizB,IAAgB,QAC5EE,IAAe,UAAYnzB,EAAQ,oBAAsB,GAAKizB,IAAgB,UAC9EE,IAAe,SAAWnzB,EAAQ,oBAAsB,GAAKizB,IAAgB,SAC7EE,IAAe,WAAanzB,EAAQ,oBAAsB,GAAKizB,IAAgB,WAC/EE,IAAe,WAAanzB,EAAQ,oBAAsB,GAAKizB,IAAgB,WAC/EE,IAAe,aAAgBF,IAAgB,aAG/CE,IAAe,SAAWnzB,EAAQ,YAAc,GAChDmzB,IAAe,UAAYnzB,EAAQ,YAAc,GACjDmzB,IAAe,WAAanzB,EAAQ,YAAc,EAAU,GAG5DkzB,EAAc,GAGX/zB,EAAS,SAASg0B,CAAU,GAC/Bt0B,EAAS,SAASs0B,CAAU,GAC5BJ,EAAgB,SAASI,CAAU,CAC3C,CAAC,CACL,CAEO,SAASC,GAAc,CAC1B,YAAaC,EAAkB,GAC/B,cAAAX,EAAgB,MAChB,YAAAC,EAAc,MACd,qBAAAW,EAAuB,GACvB,uBAAAC,EACA,uBAAA3O,EACA,SAAAtuB,EAAW,MACX,cAAAk9B,EACA,YAAAC,EACA,kBAAArO,EACA,aAAAsO,CACJ,EAAwB,GAAI,CACxB,MAAMC,EAAiB1e,SAAOoe,CAAe,EACvCO,EAAc3e,SAAO3e,CAAQ,EAC7Bu9B,EAAmB5e,SAAOyd,CAAa,EACvCoB,EAAiB7e,SAAO0d,CAAW,EAGzCpd,YAAU,IAAM,CACZoe,EAAe,QAAUN,EACzBQ,EAAiB,QAAUnB,EAC3BoB,EAAe,QAAUnB,EACzBiB,EAAY,QAAUt9B,CAC1B,EAAG,CAAC+8B,EAAiBX,EAAeC,EAAar8B,CAAQ,CAAC,EAE1D,MAAMy9B,EAAY9e,SAAuB,IAAI,EACvC+e,EAAe/e,SAAuB,IAAI,EAC1Cgf,EAAYhf,SAA0B,IAAI,EAC1CoU,EAASpU,SAAO,CAAE,EAAG,EAAG,EAAG,EAAG,EAAG,KAAM,EACvCif,EAAajf,SAAO,EAAK,EACzBkf,EAAelf,SAAO,CAAE,EAAG,GAAI,EAAG,GAAI,EACtCmf,EAAenf,SAAO,CAAE,EAAG,GAAI,EAAG,GAAI,EACtCof,EAAqBpf,SAAO,EAAI,EAChCqf,GAAqBrf,SAAO,EAAI,EAChCsf,EAAqBtf,SAAO,EAAK,EAEjC,CAACzK,EAAUgqB,CAAW,EAAI7f,WAAS,EAAK,EACxC,CAAC8f,EAAaC,CAAc,EAAI/f,WAAqB,IAAI,EACzD,CAACggB,GAAKC,CAAM,EAAIjgB,WAAS,CAAC,EAC1B,CAACkgB,GAAeC,EAAgB,EAAIngB,WAAS,CAAC,EAG9C,CAACogB,GAAoBC,EAAqB,EAAIrgB,WAA8B,EAAE,EAC9E,CAACsgB,GAAkBC,EAAmB,EAAIvgB,WAA0D,IAAI,EACxG,CAACwgB,GAAqBC,EAAsB,EAAIzgB,WAAwB,IAAI,EAC5E,CAAC0gB,GAAeC,EAAgB,EAAI3gB,WAAS,EAAK,EAClD,CAAC4gB,GAAkBC,EAAmB,EAAI7gB,WAAS,EAAK,EAGxD,CAAC8gB,GAAsBC,EAAuB,EAAI/gB,WAAwB,IAAI,EAE9E,CAACghB,GAAoBC,EAAqB,EAAIjhB,WAAqF,IAAI,EACvI,CAACkhB,GAAsBC,EAAuB,EAAInhB,WAAS,EAAK,EAGhE,CAACohB,GAAkBC,CAAmB,EAAIrhB,WAAsB,IAAI,GAAK,EAMzEshB,GAAsBhe,UAAQ,IAAM,CACtC,MAAMlO,MAAU,IAChB,OAAIorB,IAAqBprB,EAAI,IAAIorB,EAAmB,EACpDJ,GAAmB,QAAQjN,GAAQ,CAC3BA,EAAK,aAAa,KAAK,kBAAoB,IAAIA,EAAK,YAAY,KAAK,cAAc,EACnFA,EAAK,cAAc,KAAK,kBAAoB,IAAIA,EAAK,aAAa,KAAK,cAAc,EAErFA,EAAK,SAAS/d,EAAI,IAAI,GAAG+d,EAAK,QAAQ,aAAa,WAAW,CACtE,CAAC,EACM/d,CACX,EAAG,CAACorB,GAAqBJ,EAAkB,CAAC,EAGtCmB,GAAqBxgB,cAAaja,GAC5BA,EAAK,IAAMw6B,GAAoB,IAAIx6B,EAAK,EAAE,GAAOA,EAAK,YAAcw6B,GAAoB,IAAIx6B,EAAK,UAAU,EACpH,CAACw6B,EAAmB,CAAC,EAElBE,GAAclhB,SAAOzK,CAAQ,EAC7B4rB,GAAgBnhB,SAAuB,IAAI,EAC3CohB,GAAaphB,SAAO,CAAE,MAAO,EAAG,OAAQ,EAAG,EAC3CqhB,GAAQrhB,SAAsB,IAAI,EAClCshB,GAAsBthB,SAAsB,IAAI,EAChDuhB,GAAcvhB,SAAoB,IAAI,GAAK,EAC3CwhB,GAAUxhB,SAA8B,IAAM,CAAE,CAAC,EACjDyhB,GAA4BzhB,SAAyC,IAAM,CAAE,CAAC,EAC9E0hB,GAAoB1hB,SAAO,EAAK,EAChC2hB,GAAkB3hB,SAAO,EAAI,EAC7B4hB,GAAc5hB,SAAO,EAAK,EAE1B,CAAC6hB,GAAmBC,EAAoB,EAAIpiB,WAAS,EAAK,EAE1DqiB,GAAoB/hB,SAAO,CAAC,EAC5BgiB,GAAahiB,SAAO,CAAC,EAGrB,CAAE,cAAAiiB,EAAA,EAAkBjhC,GAAA,EACpBkhC,GAAcliB,SAAO,CAAE,EAAG,EAAG,EAAG,EAAG,EACnCmiB,GAAaniB,SAAO,KAAK,SAAW,KAAK,GAAK,CAAC,EAE/CoiB,GAAsBpiB,SAA8B,IAAI,EACxDqiB,GAAsBriB,SAA8B,IAAI,EAExD,CAAE,aAAAsiB,GAAc,gBAAAC,EAAA,EAAoBniC,GAAA,EAGpCoiC,GAAmBxiB,SAAOogB,EAAa,EACvCqC,GAAwBziB,SAAO8f,EAAkB,EACjD4C,GAAyB1iB,SAAOkgB,EAAmB,EACnDyC,GAA0B3iB,SAAOqe,CAAoB,EACrDuE,GAAkB5iB,SAAOsiB,EAAY,EACrCO,GAAwB7iB,SAAO0gB,EAAkB,EACjDoC,GAA0B9iB,SAAO4gB,EAAoB,EAGrDmC,GAAsB/iB,SAAoD,CAAE,GAAI,KAAM,EAAG,GAAI,EAAG,GAAI,EAG1GM,YAAU,IAAM,CACZ4gB,GAAY,QAAU3rB,EACtBitB,GAAiB,QAAUpC,GAC3BqC,GAAsB,QAAU3C,GAChC4C,GAAuB,QAAUxC,GACjCyC,GAAwB,QAAUtE,EAClCuE,GAAgB,QAAUN,GAC1BO,GAAsB,QAAUnC,GAChCoC,GAAwB,QAAUlC,EACtC,EAAG,CAACrrB,EAAU6qB,GAAeN,GAAoBI,GAAqB7B,EAAsBiE,GAAc5B,GAAoBE,EAAoB,CAAC,EAEnJ,MAAMoC,GAAyBhjB,SAAsB,IAAI,EACnDijB,GAA0BxiB,cAAavQ,GAA2B,CAChE8yB,GAAuB,UAAY9yB,IACvC8yB,GAAuB,QAAU9yB,EAC7BouB,GACAA,EAAuBpuB,CAAO,EAEtC,EAAG,CAACouB,CAAsB,CAAC,EAErB4E,GAAeljB,SAAO,CAAE,EAAG,EAAG,EAAG,EAAG,EAAG,KAAM,EAC7CmjB,GAAanjB,SAAO,CAAE,EAAG,EAAG,EAAG,EAAG,EAClCojB,GAAiBpjB,SAAO,CAAE,EAAG,EAAG,EAAG,EAAG,EACtCqjB,GAAiBrjB,SAAO,CAAE,EAAG,EAAG,EAAG,EAAG,EAGtCsjB,GAAwBtjB,SAAO,CACjC,KAAM,EAAG,KAAM,EAAG,KAAM,EACxB,MAAO,EAAG,MAAO,EACjB,QAAS,EAAG,QAAS,EACrB,YAAa,IAChB,EAEKujB,GAAgBvjB,SAAiG,IAAI,EAGrHwjB,GAAkB/iB,cAAY,CAACqT,EAAiBC,EAAiB0P,EAAiB5R,EAAmB,MAEnG,MAAMiC,CAAO,GAAK,MAAMC,CAAO,GAAK,MAAM0P,CAAO,GACjD9vC,GAAQ,gBAAiB,+BAAgC,CAAE,QAAAmgC,EAAS,QAAAC,EAAS,QAAA0P,EAAS,EAC/E,MAIP,MAAMrP,EAAO,QAAQ,CAAC,GAAK,MAAMA,EAAO,QAAQ,CAAC,GAAK,MAAMA,EAAO,QAAQ,CAAC,KAC5EzgC,GAAQ,gBAAiB,mCAAmC,EAC5DygC,EAAO,QAAU,CAAE,EAAG,EAAG,EAAG,EAAG,EAAG,OAGtCmP,GAAc,QAAU,CACpB,OAAQ,GACR,UAAW,YAAY,MACvB,SAAA1R,EACA,MAAO,CAAE,GAAGuC,EAAO,SACnB,OAAQ,CAAE,EAAGN,EAAS,EAAGC,EAAS,EAAG0P,CAAA,CAAQ,EAEjDP,GAAa,QAAU,CAAE,EAAGpP,EAAS,EAAGC,EAAS,EAAG0P,CAAA,EAC7C,IACR,EAAE,EAICC,GAAkBjjB,cAAY,CAACgB,EAAWC,EAAWiiB,IAAc,CACrE,MAAMC,EAAON,GAAsB,QAGnC,GAAI,MAAMM,EAAK,IAAI,GAAK,MAAMA,EAAK,IAAI,GAAK,MAAMA,EAAK,IAAI,EACvD,OAAAjwC,GAAQ,gBAAiB,2CAA2C,EAC7D,CACH,OAAQ,EACR,OAAQ,EACR,QAASiwC,EAAK,SAAW,EACzB,QAASA,EAAK,SAAW,EACzB,MAAO,EACP,OAAQ,GAKhB,MAAMC,EAAM,CAACD,EAAK,MAAS,KAAK,GAAK,IAC/BE,GAAKF,EAAK,MAAQ,KAAK,GAAK,IAC5BG,EAAO,KAAK,IAAIF,CAAE,EAClBG,EAAO,KAAK,IAAIH,CAAE,EAClBI,EAAO,KAAK,IAAIH,EAAE,EAClBI,EAAO,KAAK,IAAIJ,EAAE,EAElBK,EAAM1iB,EAAIwiB,EAAON,EAAIO,EACrBE,EAAM,CAAC3iB,EAAIyiB,EAAOP,EAAIM,EACtBI,EAAM3iB,EAAIqiB,EAAOK,EAAMJ,EACvBM,EAAM5iB,EAAIsiB,EAAOI,EAAML,EAGvBQ,GAASJ,EAAMP,EAAK,KACpBY,GAASH,EAAMT,EAAK,KACpBa,GAASH,EAAMV,EAAK,KAEpBc,GAAQ,KAAK,IAAI,IAAM,KAAK,IAAI,GAAId,EAAK,YAAc,KAAK,IAAI,EAAGA,EAAK,YAAca,EAAM,CAAC,CAAC,EAG9FE,GAASJ,GAASG,GAClBE,GAASJ,GAASE,GAMlBG,GAAYJ,GAAUb,EAAK,YAAc,EAGzCkB,GAAiBD,GAAYH,GAAQ,EAE3C,MAAO,CACH,OAAAC,GACA,OAAAC,GACA,QAAShB,EAAK,QAAUe,GACxB,QAASf,EAAK,QAAUgB,GACxB,MAAOE,GACP,OAAAL,GACA,UAAAI,EAAA,CAER,EAAG,EAAE,EAGCnqB,GAAqBpd,EAAgBrL,GAASA,EAAM,kBAAkB,EACtEwoB,GAAuBnd,EAAgBrL,GAASA,EAAM,oBAAoB,EAC1E0oB,GAAiBrd,EAAgBrL,GAASA,EAAM,cAAc,EAC9DiqB,GAAgB5e,EAAgBrL,GAASA,EAAM,aAAa,EAC5D6lC,GAAsBx6B,EAAgBrL,GAASA,EAAM,mBAAmB,EACxE8yC,GAA0BznC,EAAgBrL,GAASA,EAAM,uBAAuB,EAChF8M,GAAYzB,EAAgBrL,GAASA,EAAM,SAAS,EAMpD,CAAE,aAAAkP,GAAc,gBAAAC,GAAiB,gBAAA4jC,GAAiB,gBAAA9jC,GAAiB,QAAA+jC,EAAA,EAAYjkC,GAAA,EAC/E,CAAE,SAAUmsB,EAAA,EAAmBtsB,GAAA,EAC/B,CAAE,YAAA2f,GAAa,YAAAY,GAAa,iBAAAC,EAAA,EAAqBY,GAAA,EAGjDijB,GAAUliB,UAAQ,IAAM,CAC1B,GAAI,CAAC+hB,GAAyB,MAAO,GACrC,GAAI,CACA,MAAMI,EAAa,IAAI,KAAKJ,EAAuB,EAInD,WAHgB,OACG,UAAYI,EAAW,UAE1B,IACpB,MAAY,CACR,MAAO,EACX,CACJ,EAAG,CAACJ,EAAuB,CAAC,EAGtBK,GAAyBplB,SAAO,EAAK,EAGrCqlB,GAAoBrlB,SAA2I,EAAE,EACjKslB,GAAWtlB,SAAoC,IAAI,GAAK,EAGxDulB,GAAW,IACXC,GAAe,IAGf3mB,GAAa4B,cAAa9d,GAA8B,CAC1D,GAAI,CAACwqB,GAAgB,OAAO53B,EAAY,QACxC,MAAMmT,EAAMyD,EAAgB,QAAQxJ,CAAI,EACxC,GAAI,CAAC+F,EAAK,OAAOnT,EAAY,QAG7B,GAAImT,EAAI,YAAY,gBAAkB,SAAUnT,EAAY,IAC5D,GAAImT,EAAI,YAAY,gBAAkB,SAAUnT,EAAY,MAC5D,GAAImT,EAAI,YAAY,gBAAkB,SAAUnT,EAAY,KAC5D,GAAImT,EAAI,YAAY,gBAAkB,SAAUnT,EAAY,OAC5D,GAAImT,EAAI,YAAY,gBAAkB,SAAUnT,EAAY,OAG5D,MAAM6P,EAAasD,EAAI,kBACvB,OAAItD,IAAe,EAAU7P,EAAY,IACrC6P,IAAe,EAAU7P,EAAY,MACrC6P,IAAe,EAAU7P,EAAY,KACrC6P,IAAe,EAAU7P,EAAY,OACrC6P,IAAe,EAAU7P,EAAY,QAE5BmT,EAAI,mBAAmB,MAAM,eAAiB,IAClD,SAAS,WAAW,EAAUnT,EAAY,UAC5CA,EAAY,OACvB,EAAG,CAAC43B,EAAc,CAAC,EAGbsY,GAAc9L,GAA0B,CAC1C,IAAIvsB,EAAI,OAAOusB,GAAS,SAClBA,EAAK,MAAM,EAAE,EAAE,OAAO,CAAC/yB,EAAG5E,KAAQ4E,GAAMA,GAAK,GAAKA,EAAK5E,EAAE,WAAW,CAAC,EAAU4E,EAAIA,GAAM,CAAC,EAC1F+yB,EACN,MAAMlY,EAAI,KAAK,IAAIrU,GAAG,EAAI,IAC1B,OAAOqU,EAAI,KAAK,MAAMA,CAAC,CAC3B,EAGM,CAAE,MAAAlb,GAAO,YAAAm/B,EAAA,EAAgB1iB,UAAQ,IAAM,CACzC,MAAM2iB,EAAiC,GACjCC,EAAqB9N,IAAuB,GAE5CnZ,EAAYjE,GAAmBkrB,CAAkB,GAAK,GACtDxa,EAAY3Q,GAAqBmrB,CAAkB,GAAK,GAGxDC,EAAmBlnB,EAAU,QAAUjnB,EAAE,aAAezB,EAAc,QAAQ,EAC9E6vC,GAAsB1a,EAAU,UAAY1zB,EAAE,aAAezB,EAAc,QAAQ,EACnE,CAAC4vC,EAAkB,GAAGC,EAAmB,EAAE,OAAO,OAAO,EAEjE,QAAQ,CAACC,EAAIj4B,IAAQ,CAC/B,MAAMwL,EAAaysB,EAAG,WAAaF,GAAkB,SAG/CG,EAAO1sB,EAAa,EAAKxL,EAAM,KAAQ,IACvCm4B,GAAU3sB,EAAa,EAAI,KAAK,IAAIxL,EAAM,GAAG,EAAI,IACjDo4B,GAAU5sB,EAAa,EAAI,KAAK,IAAIxL,EAAM,GAAG,EAAI,IAEvD63B,EAAe,KAAK,CAChB,GAAI,YAAYI,EAAG,QAAQ,IAAIj4B,CAAG,GAClC,KAAM,WACN,KAAMi4B,EAAG,SACT,WAAYA,EAAG,eACf,WAAY9vC,EAAc,SAC1B,QAAS4oB,GAAWknB,EAAG,QAAQ,EAC/B,EAAGE,GACH,EAAGC,GACH,EAAGF,EACH,WAAA1sB,EACA,QAAS,GACT,aAAcysB,EACd,SAAU,EACb,CACL,CAAC,EAGwB,CAAC,GAAGpnB,EAAW,GAAGyM,CAAS,EACnC,QAAS7sB,GAAS,CAC/B,GAAIA,EAAK,aAAetI,EAAc,SAAU,OAEhD,MAAM4tB,EAAWuZ,GAAe,SAAS7+B,EAAK,UAAU,EAClD4nC,EAAU9I,GAAc,SAAS9+B,EAAK,UAAU,EACtD,GAAI,CAACslB,GAAY,CAACsiB,EAAS,OAE3B,MAAM7sB,EAAaqF,EAAU,SAAUhjB,GAAE,iBAAmB4C,EAAK,cAAc,EACzE6nC,GAAe7nC,EAAK,eAAiB2d,GAAc3d,EAAK,cAAc,EAAI,OAC1EwM,GAAUoB,EAAgB,QAAQ5N,EAAK,QAAQ,EAC/C6G,GAAaghC,IAAc,YAAcr7B,IAAS,kBAClDs7B,GAAiBjhC,GAAak4B,GAAkBl4B,EAAU,EAAI,OAEpE,IAAIqc,GAAGC,GAAGiiB,GACV,GAAIrqB,EAAY,CACZ,MAAMgtB,IAAQziB,EAAWuZ,GAAiBC,IAAe,QAAQ9+B,EAAK,UAAU,EAChFkjB,GAAIoC,EAAW,CAAC0hB,GAAWA,GAC3B7jB,IAAK4kB,IAAQziB,EAAW,EAAI,IAAM2hB,GAClC7B,GAAI,CACR,KAAO,CAEH,MAAMhK,GAAOp7B,EAAK,gBAAkBA,EAAK,SAAS,WAElD,GAAK6C,GAQE,CACH,MAAMklC,IAAQziB,EAAWuZ,GAAiBC,IAAe,QAAQ9+B,EAAK,UAAU,EAC1EgoC,GAAQ1iB,EAAW,CAAC0hB,GAAW,IAAMA,GAAW,IAChDiB,GAAW,KAAQF,GAAO,KAC1BG,GAAWD,GAAW,KACtBE,GAAQjB,GAAW9L,GAAO,GAAG,EAC7BgN,GAAWlB,GAAW9L,GAAO,GAAG,EAChCiN,GAAWnB,GAAW9L,GAAO,GAAG,EACtCgK,GAAI6C,GAAYE,IAASD,GAAWD,IACpC/kB,GAAI8kB,IAAUI,GAAW,IAAO,IAChCjlB,IAAMklB,GAAW,IAAO,GAC5B,KAnBsB,CAClB,MAAMD,GAAWlB,GAAW9L,GAAO,KAAOqL,EAAe,EACnD4B,GAAWnB,GAAW9L,GAAO,KAAOqL,EAAe,EACnD6B,GAAWpB,GAAW9L,GAAO,KAAOqL,EAAe,EAEzDvjB,IADcoC,EAAW,CAAC0hB,GAAWA,KACvBoB,GAAW,IAAO,IAChCjlB,IAAMklB,GAAW,IAAO,IACxBjD,GAAI,KAAQkD,GAAW,GAC3B,CAYJ,CAEAlB,EAAe,KAAK,CAChB,GAAI,QAAQpnC,EAAK,gBAAkBA,EAAK,QAAQ,IAAIA,EAAK,UAAU,IAAI+a,EAAa,KAAO,KAAK,GAChG,KAAMuK,EAAW,SAAW,QAC5B,KAAMtlB,EAAK,SACX,WAAYA,EAAK,eACjB,WAAYA,EAAK,WACjB,QAASsgB,GAAWtgB,EAAK,QAAQ,EACjC,EAAAkjB,GAAG,EAAAC,GAAG,EAAAiiB,GACN,WAAArqB,EACA,QAAS,GACT,UAAW0F,GAAazgB,CAAI,EAC5B,MAAO6nC,IAAc,MACrB,cAAgBviB,GAAYwiB,GAAkB1oB,GAAaxR,EAAgB,kBAAkBk6B,EAAqB,GAAK,EAAE,EAAI,OAC7H,aAAct7B,GAAU4S,GAAa5S,GAAQ,uBAAyBA,GAAQ,aAAa,EAAI,OAC/F,kBAAmBA,GAAW,CAACA,GAAQ,uBAAyB,CAAC,CAACA,GAAQ,eAAkB9H,GAAgB8H,GAAQ,SAAS,cAAc,EAAI,GAC/I,aAAc,CAAC,EAAExM,EAAK,OAAUA,EAAK,MAAQ,GAC7C,UAAW,CAAC,EAAEA,EAAK,OAAUA,EAAK,MAAQ,GAC1C,WAAY,CAAC,CAAE6nC,IAAc,SAAS,KAAM3mC,IAAWA,GAAE,WAAa,UAAU,GAAM,CAAC,EAAElB,EAAK,OAAUA,EAAK,MAAQ,GAAM6nC,IAAc,UAAYA,GAAa,UAAY,GAC9K,KAAMA,IAAc,SACpB,aAAc7nC,EACd,SAAU+a,EAAa,EAAI,EAC3B,QAASqE,GAAaxR,EAAgB,QAAQ5N,EAAK,uBAAyBA,EAAK,QAAQ,GAAG,mBAAmB,MAAQ,EAAE,EAC5H,CACL,CAAC,EAGD,MAAMuoC,EAAkBnsB,GAAe,OAAOpc,GAAQ,CAElD,MAAMyT,EADU7F,EAAgB,QAAQ5N,EAAK,QAAQ,GACzB,WAAW,gBAAkB,EACzD,OAAO6+B,GAAe,SAASprB,CAAU,GAAKqrB,GAAc,SAASrrB,CAAU,CACnF,CAAC,EAEK+0B,EAAuL,GAC7L,OAAAD,EAAgB,QAASvoC,GAAS,CAE9B,MAAMyT,EADU7F,EAAgB,QAAQ5N,EAAK,QAAQ,GACzB,WAAW,gBAAkB,EACnDslB,EAAWuZ,GAAe,SAASprB,CAAU,EAC7Cm0B,GAAU9I,GAAc,SAASrrB,CAAU,EACjD,GAAI,CAAC6R,GAAY,CAACsiB,GAAS,OAE3B,IAAI1kB,GAAGC,GAAGiiB,GACV,MAAMhK,GAAOp7B,EAAK,gBAAkBA,EAAK,SAAS,WAElD,GAAK6C,GAOE,CACH,IAAI4lC,GAAY,EACZT,GAAQ,EACRU,GAAa,CAAE,IAAK,EAAG,IAAK,GAC5BpjB,GACA0iB,GAAQ,MACRS,GAAY5J,GAAe,QAAQprB,CAAU,EAC7Ci1B,GAAa,CAAE,IAAK,MAASD,GAAY,KAAO,IAAK,MAASA,GAAY,KAAQ,QAElFT,GAAQ,KACRS,GAAY3J,GAAc,QAAQrrB,CAAU,EAC5Ci1B,GAAa,CAAE,IAAK,MAASD,GAAY,KAAO,IAAK,MAASA,GAAY,KAAQ,OAEtF,MAAMN,GAAQjB,GAAW9L,GAAO,GAAG,EAC7BgN,GAAWlB,GAAW9L,GAAO,GAAG,EAChCiN,GAAWnB,GAAW9L,GAAO,GAAG,EACtCgK,GAAIsD,GAAW,IAAOP,IAASO,GAAW,IAAMA,GAAW,KAC3DxlB,GAAI8kB,IAAUI,GAAW,IAAO,KAChCjlB,IAAMklB,GAAW,IAAO,IAC5B,KA1BsB,CAClB,MAAMD,GAAWlB,GAAW9L,GAAO,KAAOqL,EAAe,EACnD4B,GAAWnB,GAAW9L,GAAO,KAAOqL,EAAe,EACnD6B,GAAWpB,GAAW9L,GAAO,KAAOqL,EAAe,EACzDvjB,IAAKklB,GAAW,IAAO,KACvBjlB,IAAKklB,GAAW,IAAO,IACvBjD,GAAI,KAASkD,GAAW,IAC5B,CAqBA,MAAM32B,GAAU2O,GAAWtgB,EAAK,QAAQ,EAClC2kB,GAAYlE,GAAazgB,CAAI,EAC7B2oC,GAAWhkB,KAAc,SAC/B,IAAIikB,GACA/lC,GACI8lC,GAAUC,GAAQ,UAAoBjkB,KAAc,YAAaikB,GAAQ,UAAgBA,GAAQ/X,GAAelf,EAAO,GAAK,OAEhIi3B,GAAQ/X,GAAelf,EAAO,GAAK,OAGvC62B,EAAiB,KAAK,CAClB,EAAAtlB,GAAG,EAAAC,GAAG,EAAAiiB,GACN,MAAAwD,GACA,aAAc,CAAC,EAAE5oC,EAAK,OAAUA,EAAK,MAAQ,GAC7C,UAAW,CAAC,EAAEA,EAAK,OAAUA,EAAK,MAAQ,GAC1C,SAAA2oC,GACA,aAAc3oC,EACd,WAAYA,EAAK,eACpB,CACL,CAAC,EAEM,CAAE,MAAOonC,EAAgB,YAAaoB,CAAA,CACjD,EAAG,CAACjP,GAAqBpd,GAAoBD,GAAsBE,GAAgBuB,GAAe2C,GAAYzd,GAAiB4jC,GAAiB7X,EAAc,CAAC,EAGzJia,GAAkBpkB,UAAQ,IAAM,CAClC,MAAMgJ,MAAc,IACpB,OAAAzlB,GAAM,QAAQC,GAAQ,CACd+2B,GAAmB/2B,EAAM43B,EAAiBX,EAAeC,EAAa7e,EAAU,GAChFmN,EAAQ,IAAIxlB,EAAK,EAAE,CAE3B,CAAC,EACMwlB,CACX,EAAG,CAACzlB,GAAO63B,EAAiBX,EAAeC,EAAa7e,EAAU,CAAC,EAE7DwoB,GAAsBrkB,UAAQ,IACzB0iB,GAAY,UACfnI,GAAmB+J,EAAG,aAAclJ,EAAiBX,EAAeC,EAAa7e,EAAU,GAEhG,CAAC6mB,GAAatH,EAAiBX,EAAeC,EAAa7e,EAAU,CAAC,EAKzEyB,YAAU,IAAM,CAQZ,GAPA/sB,GAAS,gBAAiB,uBAAwB,CAC9C,cAAAgrC,EACA,UAAW6G,GAAuB,QAClC,eAAAjY,GACA,WAAY5mB,GAAM,OACrB,EAEG,CAACg4B,GAAiB6G,GAAuB,SAAW,CAACjY,IAAkB5mB,GAAM,SAAW,EAAG,OAE/F,KAAM,CAAE,WAAAghC,EAAY,UAAArM,EAAW,QAAAhrB,CAAA,EAAYquB,EAC3C,GAAI,CAACgJ,GAAc,CAACrM,EAAW,OAG/BkK,GAAuB,QAAU,GAGjC,KAAM,CAAE,WAAA3nC,EAAY,oBAAqBmB,CAAA,EAAWtB,EAAgB,WAE9D+6B,EADc56B,EAAW,KAAKE,GAAKA,EAAE,cAAgBiB,CAAM,GAC9B,WAAa,EAG1C4oC,EAAuBjhC,GAAM,KAAKkhC,GAAKA,EAAE,OAAS,YAAcA,EAAE,UAAU,EAG5EC,EAAQ,WAAW,SAAY,CACjC,GAAI,CAEA,MAAM5b,EAAayb,EAAa,SAAW,QACrCrc,EAAaqc,GAAcrM,GAAa,GAE9C3nC,GAAS,gBAAiB,uBAAwB,CAAE,WAAAu4B,EAAY,WAAAZ,EAAY,cAAAmN,EAAe,EAE3F,MAAMx6B,EAAY,MAAMi8B,GACpBhO,EACAZ,EACAmN,EACA,CAAE,WAAYl3B,GAAc,KAAM6jC,EAAA,CAAgB,EAKtD,GAFAzxC,GAAS,gBAAiB,SAASsK,EAAU,MAAM,aAAc,CAAE,UAAAA,EAAW,qBAAA2pC,EAAsB,cAAerG,GAAc,QAAS,EAEtItjC,EAAU,OAAS,EAAG,CAMtB,GALAkiC,GAAsBliC,CAAS,EAC/BwiC,GAAiB,EAAI,EACrBE,GAAoB,EAAK,EAGrBiH,IACArH,GAAuBqH,EAAqB,EAAE,EAC9Cj0C,GAAS,gBAAiB,oBAAoBi0C,EAAqB,EAAE,EAAE,EAGnErG,GAAc,SAAS,CACvB,KAAM,CAAE,QAAAwG,EAAS,QAAAC,EAAS,MAAAlD,EAAA,EAAUhB,GAChC8D,EAAqB,EACrBA,EAAqB,EACrBA,EAAqB,GAEzBj0C,GAAS,gBAAiB,uBAAwB,CAAE,QAAAo0C,EAAS,QAAAC,EAAS,MAAAlD,GAAO,EAC7EzE,GAAoB,CAAE,EAAG0H,EAAS,EAAGC,EAAS,MAAAlD,GAAO,CACzD,CAIApG,GAA0BpuB,GAC1BouB,EAAuBpuB,CAAO,CAEtC,MACI3c,GAAS,gBAAiB,oDAAoD,CAEtF,OAASgG,EAAK,CACV3F,GAAS,gBAAiB,oCAAqC2F,CAAG,CACtE,CACJ,EAAG,GAAG,EAEN,MAAO,IAAM,aAAamuC,CAAK,CACnC,EAAG,CAACnJ,EAAepR,GAAgB5mB,GAAOpF,GAAc6jC,GAAiB1G,EAAwBoF,EAAe,CAAC,EAGjH,MAAMmE,GAAqB7nB,SAAOonB,EAAe,EAC3CU,GAAyB9nB,SAAOqnB,EAAmB,EAGnDU,GAAkB/kB,UAAQ,IAAM,CAClC,MAAMrE,EAAYjE,GAAmBod,IAAuB,EAAE,GAAK,GAC7D1M,EAAY3Q,GAAqBqd,IAAuB,EAAE,GAAK,GACrE,OAAO,IAAI,IAAI,CAAC,GAAGnZ,EAAW,GAAGyM,CAAS,EAAE,IAAI1zB,GAAKA,EAAE,QAAQ,CAAC,CACpE,EAAG,CAACgjB,GAAoBD,GAAsBqd,EAAmB,CAAC,EAE5DkQ,GAAiBhoB,SAAc,EAAE,EAEjCioB,GAAaxnB,cAAY,CAACynB,EAAgB,EAAGC,EAAgB,EAAGC,EAAoB,IAAM,CAC5F,MAAMC,EAASrJ,EAAU,QACzB,GAAI,CAACqJ,GAAU,CAAClH,GAAc,QAAS,OACvC,MAAMmH,EAAMD,EAAO,WAAW,IAAI,EAClC,GAAI,CAACC,EAAK,OAEV,KAAM,CAAE,MAAA/mB,GAAO,OAAAC,CAAA,EAAW4f,GAAW,QACrC,GAAI7f,KAAU,GAAKC,IAAW,EAAG,OAEjC8mB,EAAI,UAAU,EAAG,EAAG/mB,GAAOC,CAAM,EAEjC,MAAM+mB,EAAUhnB,GAAQ,EAClBinB,EAAUhnB,EAAS,EACnBinB,EAAc,IACdC,EAAOtU,EAAO,QAAQ,EAAIiP,GAAe,QAAQ,EACjDsF,EAAOvU,EAAO,QAAQ,EAAIiP,GAAe,QAAQ,EACjDuF,EAAOxU,EAAO,QAAQ,EAG5BkP,GAAsB,QAAU,CAC5B,KAAAoF,EAAM,KAAAC,EAAM,KAAAC,EACZ,MAAAV,EAAO,MAAAC,EACP,QAAAI,EAAS,QAAAC,EACT,YAAAC,CAAA,EAGJ,MAAMI,EAAuD,GAGvDhF,GAAM,CAACqE,EAAS,KAAK,GAAK,IAC1BpE,GAAKqE,EAAQ,KAAK,GAAK,IACvBpE,GAAO,KAAK,IAAIF,EAAE,EAClBG,GAAO,KAAK,IAAIH,EAAE,EAClBI,GAAO,KAAK,IAAIH,EAAE,EAClBI,GAAO,KAAK,IAAIJ,EAAE,EAExBgE,GAAuB,QAAQ,QAAQR,IAAM,CAKzC,GADI9H,GAAe8H,GAAG,aAAe9H,EAAY,YAC7CuI,GAAgB,IAAIT,GAAG,aAAa,QAAQ,EAAG,OAGnD,MAAMwB,GAAS7H,GAAmBqG,EAAE,EAC9Bv8B,GAAUoB,EAAgB,QAAQm7B,GAAG,aAAa,QAAQ,EAChE,GAAI,CAACwB,IAAU/9B,IAAW4zB,EAAY,UAAY,MAAO,CACrD,GAAIA,EAAY,UAAY,gBAExB,OACJ,GAAWA,EAAY,UAAY,iBAE/B,MAER,CAGA,MAAMoK,GAAgB,GAItB,IAAItnB,GAAI6lB,GAAG,EACP5lB,GAAI4lB,GAAG,EACP3D,GAAI2D,GAAG,EAGX,MAAMnD,GAAM1iB,GAAIwiB,GAAON,GAAIO,GACrBE,GAAM,CAAC3iB,GAAIyiB,GAAOP,GAAIM,GAGtBI,GAAM3iB,GAAIqiB,GAAOK,GAAMJ,GACvBM,GAAM5iB,GAAIsiB,GAAOI,GAAML,GAGvBQ,GAASJ,GAAMuE,EACflE,GAASH,GAAMsE,EACflE,GAASH,GAAMsE,EAKfI,GAAU9nC,KAAoB,MAAQ,KAAQA,KAAoB,SAAW,MAAS,KAC5F,GAAI,CAAC4nC,KAAWrE,GAAS,KAAOA,GAASuE,IAAU,OAEnD,MAAMtE,GAAQ+D,GAAeA,EAAchE,IACrCwE,GAAKV,EAAUhE,GAASG,GACxBwE,GAAKV,EAAUhE,GAASE,GAE9B,GAAIuE,GAAK,MAAQA,GAAK1nB,GAAQ,KAAO2nB,GAAK,MAAQA,GAAK1nB,EAAS,IAAK,OAErE,IAAI2nB,GAAO,KAAK,IAAI,GAAK,IAAMzE,EAAK,EAChC0E,GAAQ,KAAK,IAAI,EAAG,KAAK,IAAI,GAAK1E,GAAQ,GAAG,CAAC,EAGlD,GAAIlC,GAAiB,SAAWK,GAAsB,QAAS,CAC3D,MAAMwG,GAAiB/B,GAAG,aAAezE,GAAsB,QAAQ,gBACjEyG,GAAkBhC,GAAG,aAAezE,GAAsB,QAAQ,iBACpE,CAACwG,IAAkB,CAACC,KACpBF,IAAS,IAEjB,CAGA,GAAI1K,EAAe,SAAWqK,IAAiB,CAACD,GAAQ,CACpD,MAAMS,GAAQ,EAAI,KAAK,IAAInB,EAAY,GAAG,EAAI,IAC9Ce,IAAQI,GACRH,GAAQ,KAAK,IAAI,EAAGA,GAAQ,GAAG,CACnC,CAGA,GAAI9B,GAAG,cAAgByB,GAAe,CAClC,MAAMQ,GAAQ,EAAI,KAAK,IAAInB,EAAY,GAAG,EAAI,GAC9Ce,IAAQ,IAAMI,GACdH,GAAQ,KAAK,IAAI,EAAGA,GAAQ,IAAMG,EAAK,CAC3C,CAIA,MAAMC,GAAalC,GAAG,cAAiBlmC,IAAmBkmC,GAAG,SAC7DgB,EAAI,UAAYkB,GAAa,UAAYlC,GAAG,MAC5CgB,EAAI,YAAcc,IAASI,GAAa,GAAM,KAC9ClB,EAAI,YACJA,EAAI,IAAIW,GAAIC,GAAIC,GAAO,IAAK,EAAG,KAAK,GAAK,CAAC,EAC1Cb,EAAI,OAGJA,EAAI,UAAalnC,IAAmBkmC,GAAG,SAAY,UAAYA,GAAG,MAClEgB,EAAI,YAAc,KAAK,IAAI,EAAGc,GAAQ,GAAG,EACzCd,EAAI,YACJA,EAAI,IAAIW,GAAIC,GAAIC,GAAO,IAAK,EAAG,KAAK,GAAK,CAAC,EAC1Cb,EAAI,OAKAO,EAAmB,KAAK,CACpB,GAAAI,GACA,GAAAC,GACA,KAAMC,GAAO,EACb,KAAM7B,GAAG,aACT,WAAYA,GAAG,WACf,EAAGA,GAAG,EACN,EAAGA,GAAG,EACN,EAAGA,GAAG,EACN,QAAS,EACZ,CAET,CAAC,EAEDjC,GAAkB,QAAUwD,CAChC,EAAG,CAACrJ,EAAauI,GAAiB9G,GAAoBpiB,GAAYzd,GAAiBF,EAAe,CAAC,EAGnGof,YAAU,IAAM,CACZunB,GAAmB,QAAUT,GAC7BU,GAAuB,QAAUT,GACjCW,GAAe,QAAUtC,GACzBuC,GAAA,CACJ,EAAG,CAACb,GAAiBC,GAAqB3B,GAAauC,GAAYrI,EAAa,CAAC,EAEjF,MAAM6J,GAAkBhpB,cAAY,CAACipB,EAAYC,EAAYvB,EAAoB,IAAM,CAG/EtJ,EAAU,UACVA,EAAU,QAAQ,MAAM,UAAY,QAIxCmJ,GAAWyB,EAAIC,EAAIvB,CAAS,CAChC,EAAG,CAACH,EAAU,CAAC,EAGT2B,GAAkBnpB,cAAY,IAAM,CACtCltB,GAAS,gBAAiB,sBAAsB,EAEhD,MAAMs2C,EAAY,CAACt0B,GAAY,CAACiqB,GAAe,CAACY,IAAiB,CAACkB,GAAoB,QAChFwI,EAAsB,KAAK,IAAI1V,EAAO,QAAQ,CAAC,EAAI,GACrD,KAAK,IAAIA,EAAO,QAAQ,CAAC,EAAI,GAC7B,KAAK,IAAIA,EAAO,QAAQ,EAAK,KAAK,EAAI,EAEtCyV,GAAaC,IAMjBvK,EAAY,EAAK,EACjB2B,GAAY,QAAU,GACtBzB,EAAe,IAAI,EACnBre,GAAA,EACAkgB,GAAoB,QAAU,KAI9BX,GAAsB,IAAI,EAC1BkC,GAAsB,QAAU,KAE5BzC,IAAiB,CAACE,KAClBC,GAAoB,EAAI,EAEpBjC,GACAA,EAAuB,IAAI,GAKnCt9B,GAAiB,WAAW,kBAG5Bo+B,EAAmB,QAAU,GAC7BC,GAAmB,QAAU,GAG7B+D,GAAe,QAAU,CAAE,EAAG,EAAG,EAAG,GACpCC,GAAe,QAAU,CAAE,EAAG,EAAG,EAAG,GAIpCG,GAAgB,EAAG,EAAG,KAAM,GAAG,EAG3BpD,IAAiB,CAACE,IAClB,WAAW,IAAM,CAEbP,GAAsB,EAAE,EACxBE,GAAoB,IAAI,EACxBE,GAAuB,IAAI,EAC3BE,GAAiB,EAAK,EACtBE,GAAoB,EAAK,CAC7B,EAAG,GAAG,EAEd,EAAG,CAACnf,GAAagf,GAAeE,GAAkBhC,EAAwB/oB,EAAUiqB,EAAagE,EAAe,CAAC,EAG3GuG,GAAwBtpB,cAAY,IAAM,CACvC6f,IAED,sBAAsB,IAAM,CACxB0J,aAAU,IAAM,CACZzJ,GAAoB,EAAI,EACpBjC,GACAA,EAAuB,IAAI,CAEnC,CAAC,EAED,WAAW,IAAM,CACb0L,aAAU,IAAM,CACZjK,GAAsB,EAAE,EACxBE,GAAoB,IAAI,EACxBE,GAAuB,IAAI,EAC3BE,GAAiB,EAAK,EACtBE,GAAoB,EAAK,CAC7B,CAAC,CACL,EAAG,GAAG,CACV,CAAC,CAET,EAAG,CAACD,GAAkBhC,CAAsB,CAAC,EAGvC2L,GAAuBjqB,SAAO,CAAC,EACrCM,YAAU,IAAM,CACR6P,IAAsB,QAAaA,EAAoB8Z,GAAqB,UAC5EA,GAAqB,QAAU9Z,EAC/ByZ,GAAA,EAER,EAAG,CAACzZ,EAAmByZ,EAAe,CAAC,EAGvC,MAAMM,GAAwBzpB,cAAapP,GAAkC,CAEzE,GADA9d,GAAS,gBAAiB,wBAAwB8d,CAAc,EAAE,EAC9D,CAACA,EAAgB,CAEjBouB,EAAe,IAAI,EACnBF,EAAY,EAAK,EACjB2B,GAAY,QAAU,GACtB,MACJ,CAIA,IAAI16B,EAAOD,GAAM,KAAKkhC,GAAKA,EAAE,aAAep2B,GAAkBo2B,EAAE,KAAOp2B,CAAc,EACjFyiB,EAAiBC,EAAiB0P,EAClC0G,GAAiB,KAIrB,GAFA52C,GAAS,gBAAiB,eAAeiT,GAAM,EAAE,KAAKD,GAAM,MAAM,SAAS,EAEvEC,EAEAstB,EAAU,CAACttB,EAAK,EAChButB,EAAU,CAACvtB,EAAK,EAChBi9B,EAAU,CAACj9B,EAAK,EAAI,IACpB2jC,GAAY3jC,EACZjT,GAAS,gBAAiB,eAAeugC,CAAO,KAAKC,CAAO,KAAK0P,CAAO,EAAE,MACvE,CAEH,IAAIxL,EAAYoN,GAAkB,QAAQ,KAAKzX,GAAKA,EAAE,aAAevc,CAAc,EAOnF,GAJK4mB,IACDA,EAAY+P,GAAe,QAAQ,KAAMpa,GAAWA,EAAE,aAAevc,CAAc,GAGnF4mB,EAAW,CACXnE,EAAU,CAACmE,EAAU,EACrBlE,EAAU,CAACkE,EAAU,EACrBwL,EAAU,CAACxL,EAAU,EAAI,IAIzB,MAAM15B,EAAQ05B,EAAkB,MAASA,EAAkB,aAC3D,GAAI,CAAC15B,EAAM,CACP5K,GAAQ,gBAAiB,8BAA+BskC,CAAS,EACjE,MACJ,CACA,MAAMmO,EAAenO,EAAU,WAAa/b,GAAc+b,EAAU,UAAU,EAAI,OAC5EltB,EAAUoB,EAAgB,QAAQ5N,EAAK,QAAQ,EAC/C2R,EAAU2O,GAAWtgB,EAAK,QAAQ,EAClCslB,EAAW9Y,GAAS,WAAa,EACjC3F,EAAaghC,GAAc,YAAcr7B,GAAS,kBAClDs7B,EAAiBjhC,EAAak4B,GAAkBl4B,CAAU,EAAI,OAEpE+kC,GAAY,CACR,EAAGlS,EAAU,EACb,EAAGA,EAAU,EACb,EAAGA,EAAU,EACb,GAAI,SAASA,EAAU,YAAc15B,EAAK,QAAQ,GAClD,KAAMslB,EAAW,SAAW,QAC5B,KAAMtlB,EAAK,SACX,WAAY05B,EAAU,WACtB,WAAYltB,GAAS,WAAW,gBAAkB,EAClD,QAAAmF,EACA,WAAY,GACZ,QAAS,GACT,SAAU,EACV,UAAW8O,GAAazgB,CAAI,EAC5B,MAAO6nC,GAAc,MACrB,cAAgBviB,GAAYwiB,EAAkB1oB,GAAaxR,EAAgB,kBAAkBk6B,CAAqB,GAAK,EAAE,EAAI,OAC7H,aAAct7B,EAAU4S,GAAa5S,EAAQ,uBAAyBA,EAAQ,aAAa,EAAI,OAC/F,kBAAmBA,EAAW,CAACA,EAAQ,uBAAyB,CAAC,CAACA,EAAQ,eAAkB9H,GAAgB8H,EAAQ,SAAS,cAAc,EAAI,GAC/I,aAAc,CAAC,EAAExM,EAAK,OAAUA,EAAK,MAAQ,GAC7C,UAAW,CAAC,EAAEA,EAAK,OAAUA,EAAK,MAAQ,GAC1C,WAAY,CAAC,EAAEA,EAAK,OAAUA,EAAK,MAAQ,GAAM6nC,GAAc,UAAYA,EAAa,UAAY,GACpG,KAAMA,GAAc,SACpB,aAAc7nC,CAAA,CAEtB,KAEI,OAER,CAGA6kC,GAAe,QAAU,CAAE,EAAG,EAAG,EAAG,GAGpCI,GAAgB1P,EAASC,EAAS0P,EAAS,GAAG,EAI1C0G,KACA1K,EAAe0K,EAAS,EACxB5K,EAAY,EAAI,EAChB2B,GAAY,QAAU,GAE9B,EAAG,CAAC36B,GAAO2V,GAAe2C,GAAY2kB,EAAe,CAAC,EAGhD4G,GAAiBpqB,SAAY,IAAI,EAGvCM,YAAU,IAAM,CACZ8pB,GAAe,QAAU5K,CAC7B,EAAG,CAACA,CAAW,CAAC,EAGhB,MAAM6K,GAAqB5pB,cAAY,MAAO6pB,GAA8B,CACxE/2C,GAAS,gBAAiB,qBAAqB+2C,CAAiB,EAAE,EAGlE,MAAMC,EAAiBH,GAAe,QAEtC,GAAI,CAACG,GAAgB,YAAc,CAACA,GAAgB,aAAc,CAC9D32C,GAAS,gBAAiB,mCAAoC,CAC1D,YAAA4rC,EACA,eAAgB4K,GAAe,QAClC,EACD,MACJ,CAEA,MAAM7rC,EAAOgsC,EAAe,aACtBl5B,EAAiBk5B,EAAe,WAChCv7B,EAAWzQ,EAAK,SAEtBhL,GAAS,gBAAiB,oBAAqB,CAC3C,eAAA8d,EACA,SAAArC,EACA,kBAAAs7B,EACA,SAAUn+B,EAAgB,QAAQ6C,CAAQ,GAAG,mBAAmB,KACnE,EAED,GAAI,CAEA,MAAMwC,GAAUR,GAAkB,CAACK,CAAc,EAAG,EAAGi5B,CAAiB,EAGlEE,EAAY7vB,GAAe,KAAKiT,GAAKA,EAAE,iBAAmBvc,CAAc,EAC9E,IAAIo5B,EAGJ,UAAW7rC,KAAU6b,GACjB,GAAIA,GAAqB7b,CAAM,EAAE,QAAUlH,EAAE,iBAAmB2Z,CAAc,EAAG,CAC7Eo5B,EAAgB7rC,EAChB,KACJ,CAEJ,GAAI,CAAC6rC,GACD,UAAW7rC,KAAU8b,GACjB,GAAIA,GAAmB9b,CAAM,EAAE,QAAUlH,EAAE,iBAAmB2Z,CAAc,EAAG,CAC3Eo5B,EAAgB7rC,EAChB,KACJ,EAIR,MAAM0a,EAAamxB,EAAgB/vB,GAAmB+vB,CAAa,GAAG,KAAK9uC,GAAKA,EAAE,iBAAmB0V,CAAc,EAAI,GAEvH,GAAI,CAACm5B,GAAa,CAACC,EAAe,CAC9B72C,GAAS,gBAAiB,kDAAkD,EAC5E,MACJ,CAIA,GAAI0lB,GAAc,CAACkxB,EAAW,CAG1B,GAFAj3C,GAAS,gBAAiB,QAAQ8d,CAAc,+BAA+B,EAE3E,CADmB,MAAM7E,GAAe,qBAAqBi+B,EAAgBp5B,CAAc,EAC1E,CACjBzd,GAAS,gBAAiB,yCAAyC,EACnE,MAAM,2HAA2H,EACjI,MACJ,CAEAL,GAAS,gBAAiB,uCAAuC,EACjE,MAAMoe,GAAc,YAAY,EAAI,EAIpCpe,GAAS,gBAAiB,8BAA8B,EACxD,MAAM,IAAI,QAAQe,GAAW,WAAWA,EAAS,GAAI,CAAC,CAC1D,CAEA,GAAIg2C,IAAsB,QAAS,CAE/B/2C,GAAS,gBAAiB,+BAA+B,EAGzD,MAAMm3C,EAAkB/9B,GAAgB,cAAc0E,EAAgBrC,EAAU,GAAMy7B,EAAgBj5B,EAAO,EAG7Gw4B,aAAU,IAAM,CACZnK,GAAiB1e,GAAQA,EAAO,CAAC,CACrC,CAAC,EACD6oB,aAAU,IAAM,CACZnK,GAAiB1e,GAAQA,EAAO,CAAC,CACrC,CAAC,EAED5tB,GAAS,gBAAiB,wCAAwC,EAGlE,MAAMqf,EAAM,MAAM83B,EAClB,GAAI,CAAC93B,EAAI,QAAS,CACdhf,GAAS,gBAAiB,yBAA0Bgf,EAAI,KAAK,EAE7DtV,EAAgB,WAAW,qBAAqB+T,EAAgB,GAAO,EAAI,EAC3E,MACJ,CACA9d,GAAS,gBAAiB,2BAA2B,CACzD,SAEQi3C,EAEAj3C,GAAS,gBAAiB,yCAAyC,EACnE,MAAMoZ,GAAgB,cAAc0E,EAAgBrC,EAAU,GAAOs7B,EAAmB94B,EAAO,EAC/Fje,GAAS,gBAAiB,4CAA4C,EACtEy2C,aAAU,IAAM,CACZnK,GAAiB1e,GAAQA,EAAO,CAAC,CACrC,CAAC,MACE,CAEH5tB,GAAS,gBAAiB,+CAA+C,EAGzE,MAAMo3C,EAAO,MAAMh+B,GAAgB,cAAc0E,EAAgBrC,EAAU,GAAMy7B,EAAgBj5B,GAAS,CAAE,OAAQ,GAAM,EAC1H,GAAI,CAACm5B,EAAK,QAAS,CACf/2C,GAAS,gBAAiB,yBAA0B+2C,EAAK,KAAK,EAC9DrtC,EAAgB,WAAW,qBAAqB+T,EAAgB,GAAO,EAAI,EAC3E,MACJ,CAEA9d,GAAS,gBAAiB,+CAA+C,EACzEy2C,aAAU,IAAM,CACZnK,GAAiB1e,GAAQA,EAAO,CAAC,CACrC,CAAC,EAGD,MAAMypB,EAAO,MAAMj+B,GAAgB,cAAc0E,EAAgBrC,EAAU,GAAOs7B,EAAmB94B,EAAO,EAC5G,GAAI,CAACo5B,EAAK,QAAS,CACfh3C,GAAS,gBAAiB,yBAA0Bg3C,EAAK,KAAK,EAC9DttC,EAAgB,WAAW,qBAAqB+T,EAAgB,GAAO,EAAI,EAC3E,MACJ,CACA9d,GAAS,gBAAiB,oDAAoD,EAC9Ey2C,aAAU,IAAM,CACZnK,GAAiB1e,GAAQA,EAAO,CAAC,CACrC,CAAC,CACL,CAKJyoB,GAAA,EAGAr2C,GAAS,gBAAiB,yCAAyC,EACnE,MAAMoe,GAAc,YAAY,EAAI,EAIpCrU,EAAgB,WAAW,qBAAqB+T,CAAc,EAG9D0vB,EAAoB5f,GAAQ,CACxB,MAAMrf,EAAO,IAAI,IAAIqf,CAAI,EACzB,OAAArf,EAAK,IAAIuP,CAAc,EAChBvP,CACX,CAAC,EACD,WAAW,IAAM,CACbi/B,EAAoB5f,GAAQ,CACxB,MAAMrf,EAAO,IAAI,IAAIqf,CAAI,EACzB,OAAArf,EAAK,OAAOuP,CAAc,EACnBvP,CACX,CAAC,CACL,EAAG,IAAI,EAGPvO,GAAS,gBAAiB,wBAAwB,EAClDssC,GAAiB1e,GAAQA,EAAO,CAAC,EAGjC5tB,GAAS,gBAAiB,gBAAgB,EAC1Cq2C,GAAA,EAEAr2C,GAAS,gBAAiB,gCAAgC,CAE9D,OAASsD,GAAO,CACZjD,GAAS,gBAAiB,mBAAoBiD,EAAK,EAEnDyG,EAAgB,WAAW,qBAAqB+T,EAAgB,GAAO,EAAI,EAC3EwuB,GAAiB1e,GAAQA,EAAO,CAAC,CACrC,CACJ,EAAG,CAACqe,EAAa7kB,GAAgBmd,GAAqBpd,GAAoBkvB,EAAe,CAAC,EAEpFiB,GAAkBpqB,cAAY,MAAO6pB,GAA8B,CACrE,MAAMQ,EAAcV,GAAe,QACnC,GAAI,CAACU,GAAa,YAAc,CAACA,GAAa,aAAc,OAE5D,MAAMz5B,EAAiBy5B,EAAY,WAGnClB,GAAA,EAEA,GAAI,CAEA,MAAMY,EAAY7vB,GAAe,KAAKiT,GAAKA,EAAE,iBAAmBvc,CAAc,EAC9E,IAAI05B,EACJ,UAAWnsC,KAAU6b,GACjB,GAAIA,GAAqB7b,CAAM,EAAE,QAAUlH,EAAE,iBAAmB2Z,CAAc,EAAG,CAC7E05B,EAAoBnsC,EACpB,KACJ,CAEJ,GAAI,CAACmsC,GACD,UAAWnsC,KAAU8b,GACjB,GAAIA,GAAmB9b,CAAM,EAAE,QAAUlH,EAAE,iBAAmB2Z,CAAc,EAAG,CAC3E05B,EAAoBnsC,EACpB,KACJ,EAMR,MAAMgT,GAAW44B,EAAY,QAAUO,EACjCv5B,EAAUR,GAAkB,CAACK,CAAc,EAAG,EAAGi5B,CAAiB,EAExE/2C,GAAS,gBAAiB,mCAAmC8d,CAAc,SAASO,EAAQ,OAAO04B,CAAiB,EAAE,EAEtH,MAAMU,EAAe,MAAMr+B,GAAgB,SAASm+B,EAAY,aAAcl5B,GAAU04B,EAAmB94B,EAAS,CAAE,MAAO,GAAM,OAAQ,GAAM,EAGjJ,GAFAje,GAAS,gBAAiB,uBAAwBy3C,CAAY,EAE1DA,EAAa,UAAY,GAAO,CAQhC,GALA,MAAMr5B,GAAc,YAAY,EAAI,EAKhC,EAJgBrU,EAAgB,WACA,mBAAmBgtC,CAAiB,GAAK,IAClC,KAAK/2B,GAAMA,EAAG,iBAAmBlC,CAAc,EAItF,MAAM,IAAI,MAAM25B,EAAa,OAAS,cAAc,EAGxDz3C,GAAS,gBAAiB,uCAAuC8d,CAAc,EAAE,CACrF,CAGA,MAAMM,GAAc,YAAY,EAAI,EACpCrU,EAAgB,WAAW,qBAAqB+T,CAAc,EAC9D/T,EAAgB,WAAW,qBAAqB+T,EAAgB,EAAI,EAGpE0vB,EAAoB5f,GAAQ,CACxB,MAAMrf,EAAO,IAAI,IAAIqf,CAAI,EACzB,OAAArf,EAAK,IAAIuP,CAAc,EAChBvP,CACX,CAAC,EACD,WAAW,IAAM,CACbi/B,EAAoB5f,GAAQ,CACxB,MAAMrf,EAAO,IAAI,IAAIqf,CAAI,EACzB,OAAArf,EAAK,OAAOuP,CAAc,EACnBvP,CACX,CAAC,CACL,EAAG,IAAI,EAGP1B,GAAW,WAAW,sBAAsB,SAAS,EACrD,WAAW,IAAM9C,EAAgB,WAAW,wBAAwB+T,CAAc,EAAG,GAAI,CAE7F,OAASxa,EAAO,CACZjD,GAAS,gBAAiB,gBAAiBiD,CAAK,EAEhDyG,EAAgB,WAAW,qBAAqB+T,EAAgB,GAAO,EAAI,EAE3EwuB,GAAiB1e,GAAQA,EAAO,CAAC,CACrC,CACJ,EAAG,CAACxG,GAAgBF,GAAsBC,GAAoBkvB,GAAiBpG,EAAe,CAAC,EAEzFyH,GAAkBxqB,cAAaja,GAAc,CAG/C,GAAIg5B,GAAeA,EAAY,aAAeh5B,EAAK,YAAcg5B,EAAY,KAAOh5B,EAAK,GACrF,OAGJ,GAAI45B,GAAe,CAEXa,GAAmBz6B,CAAI,GAEvB0jC,GAAsB1jC,EAAK,YAAcA,EAAK,EAAE,EAEpD,MACJ,CAGA,GAAIA,EAAK,OAAS,YAAcA,EAAK,cAAc,aAAevQ,EAAc,SAAU,CACtF,MAAMsI,EAAOiI,EAAK,aAClB,GAAIjI,EAAM,CACN6B,GAAW,WAAW,eAAe,WAAY,CAAE,KAAM7B,EAAK,SAAU,eAAgBA,EAAK,eAAgB,EAE7GghC,EAAY,EAAK,EACjB2B,GAAY,QAAU,GACtBzB,EAAe,IAAI,EACnBre,GAAA,EACAkgB,GAAoB,QAAU,KAC9B,MACJ,CACJ,CAGA,MAAM4J,EAAiB1kC,EAAK,YAAcA,EAAK,GAC/C,GAAI+O,GAAYiqB,IAAgBA,EAAY,aAAe0L,GAAkB1L,EAAY,KAAO0L,GAAiB,CAE7G,GAAI1kC,EAAK,aAAc,CACnB,KAAM,CAAE,QAAAmhC,EAAS,QAAAC,EAAS,MAAAlD,CAAA,EAAUhB,GAAgBl9B,EAAK,EAAGA,EAAK,EAAGA,EAAK,CAAC,EACpEua,EAAgB,CAClB,EAAG4mB,EAAW,GAAKjD,EAAS,GAC5B,EAAGkD,CAAA,EAEPpnB,GACIha,EAAK,aACLA,EAAK,WAAa0V,GAAc1V,EAAK,UAAU,EAAI,OACnD,OACA,GACA6jC,GACAQ,GACA,GACA9pB,EACAva,EAAK,OAAS,YAGlB6a,GAAA,CACJ,CACA,MACJ,CAOA,GALAke,EAAY,EAAI,EAChB2B,GAAY,QAAU,GACtBzB,EAAej5B,CAAI,EAGfA,EAAK,aAAc,CAEnB,KAAM,CAAE,QAAAmhC,EAAS,QAAAC,CAAA,EAAYlE,GAAgBl9B,EAAK,EAAGA,EAAK,EAAGA,EAAK,CAAC,EAC7Dua,EAAgB,CAClB,EAAG4mB,EACH,EAAGC,CAAA,EAEPpnB,GAAYha,EAAK,aAAcA,EAAK,WAAa0V,GAAc1V,EAAK,UAAU,EAAI,OAAW,OAAW,GAAM6jC,GAAoBQ,GAAiB,GAAM9pB,EAAeva,EAAK,OAAS,WAAY,IAAM,CAAE,EAAG,EAAK,EAClN86B,GAAoB,QAAU4J,CAClC,CAKA,MAAMpX,EAAU,CAACttB,EAAK,EADD,EAEfutB,EAAU,CAACvtB,EAAK,EAChBi9B,GAAU,CAACj9B,EAAK,EAAI,IAG1B48B,GAAe,QAAU,CAAE,EAAG,EAAG,EAAG,GACpCC,GAAe,QAAU,CAAE,EAAG,EAAG,EAAG,GAGpCG,GAAgB1P,EAASC,EAAS0P,GAAS,GAAG,CAClD,EAAG,CAACrD,GAAehf,GAAa7L,EAAUiqB,EAAane,GAAkBnF,GAAemuB,GAAoB7pB,GAAagjB,EAAe,CAAC,EAGnI2H,GAAyB1qB,cAAY,CAAC2qB,EAAYC,IAAe,CAEnE,GADI,CAAClK,GAAc,SACfO,GAAkB,QAAS,OAI/B,GAAItB,IAAiB,CAAC7qB,EAAU,CACxB+rB,GAAoB,UACpBlgB,GAAA,EACAkgB,GAAoB,QAAU,MAElC,MACJ,CAEA,IAAIgK,EAA8B,KAC9BC,EAAiC,KACjCrR,EAAW,IACXsR,GAAsB,KAG1B,MAAMC,EAAiB,SAAS,iBAAiBL,EAAIC,CAAE,EACjDK,EAAgBD,GAAgB,QAAQ,cAAc,EAQ5D,GALiBA,GACbA,IAAmB1M,EAAa,SAChC0M,IAAmBzM,EAAU,SAC7B,CAAC0M,EAES,CAENpK,GAAoB,SAAW,CAAC/rB,IAChC6L,GAAA,EACAkgB,GAAoB,QAAU,MAElC,MACJ,CAEA,GAAIoK,EAAe,CACf,MAAMC,EAASD,EAAc,aAAa,cAAc,EAClDllC,EAAOD,GAAM,KAAKkhC,GAAKA,EAAE,KAAOkE,CAAM,EACxCnlC,IACA8kC,EAAcI,EACdH,EAAY/kC,EACZ0zB,EAAW,EAEnB,CAGA,GAAI,CAACqR,EAAW,CACZ,MAAMK,EAAOzK,GAAc,QACrByC,EAAON,GAAsB,QACnC,GAAIsI,EAAM,CACN,MAAMC,EAAOT,EAAKQ,EAAK,KAAOhI,EAAK,QAC7BkI,EAAOT,EAAKO,EAAK,IAAMhI,EAAK,QAEbr9B,GAAM,OAAOkhC,IAAKA,GAAE,SAAW,CAAC,EAGZ,IAAIjhC,IAAQ,CACjD,MAAMulC,GAAarI,GAAgBl9B,GAAK,EAAGA,GAAK,EAAGA,GAAK,CAAC,EACzD,MAAO,CAAE,KAAAA,GAAM,WAAAulC,EAAA,CACnB,CAAC,EAAE,OAAO,CAAC,CAAE,WAAAA,MAAiB,CAC1B,MAAM/C,GAAU9nC,KAAoB,MAAQ,MAAQA,KAAoB,SAAW,KAAS,MAC5F,OAAO6qC,GAAW,QAAU,KAAOA,GAAW,QAAU/C,EAC5D,CAAC,EAGuC,KAAK,CAACpiC,GAAG5E,KAAMA,GAAE,WAAW,OAAS4E,GAAE,WAAW,MAAM,EAEpF,QAAQ,CAAC,CAAE,KAAAJ,GAAM,WAAAulC,MAAiB,CAC1C,MAAMxQ,GAAK+J,GAAS,QAAQ,IAAI9+B,GAAK,EAAE,EAEvC,GADI,CAAC+0B,IACDA,GAAG,MAAM,UAAY,QAAUA,GAAG,MAAM,UAAY,IAAK,OAE7D,KAAM,CAAE,OAAAoJ,GAAQ,OAAAC,GAAQ,MAAAF,GAAO,OAAAD,IAAWsH,GAEpCC,GAAW,KAAK,KAAK,KAAK,IAAIH,EAAOlH,GAAQ,CAAC,EAAI,KAAK,IAAImH,EAAOlH,GAAQ,CAAC,CAAC,EAIlF,IAAIqH,GAHmB,GACgBvH,GAEP,IAMhC,GALIpD,GAAoB,UAAY96B,GAAK,KACrCylC,IAAa,KAEjBA,GAAY,KAAK,IAAI,GAAI,KAAK,IAAI,IAAKA,EAAS,CAAC,EAE7CD,GAAWC,GAAW,CACtB,MAAM7hC,GAAS4hC,GAAWC,GAAcxH,GAAS,IAC7Cr6B,GAAQ8vB,IACRA,EAAW9vB,GACXkhC,EAAc/P,GACdgQ,EAAY/kC,GAEpB,CACJ,CAAC,CACL,CACJ,CAGA,GAAI,CAAC+kC,GAAa5I,GAAwB,SAAWxB,GAAc,QAAS,CACxE,MAAMyK,EAAOzK,GAAc,QACrB0K,EAAOT,EAAKQ,EAAK,KACjBE,EAAOT,EAAKO,EAAK,IAEvB,IAAIM,EAAe,IACnB7G,GAAkB,QAAQ,QAAQzX,GAAK,CACnC,MAAMvjB,GAAO,KAAK,KAAK,KAAK,IAAIujB,EAAE,GAAKie,EAAM,CAAC,EAAI,KAAK,IAAIje,EAAE,GAAKke,EAAM,CAAC,CAAC,EACpEG,GAAY,KAAK,IAAI,GAAIre,EAAE,KAAO,EAAE,EAEtCvjB,GAAO4hC,IAAa5hC,GAAO6hC,IAC3BA,EAAe7hC,GACfmhC,GAAiB5d,EAEzB,CAAC,CACL,CAEA,GAAI0d,GAAgBC,EAA4B,CAC5C,MAAM/kC,EAAO+kC,EACPhtC,EAAOiI,EAAK,aACZhI,EAAagI,EAAK,WAExB,GAAI45B,GAAe,CAEf,MAAM3hC,EAAW6sC,EAAeC,EAA2B,YAAeA,EAA2B,GAAK,KACtG9sC,IAAa+hC,IACbC,GAAwBhiC,CAAQ,EAGhC6iC,GAAoB,UACpBlgB,GAAA,EACAkgB,GAAoB,QAAU,MAElC,MACJ,CAgBA,GAbIc,GAAoB,UACpB,aAAaA,GAAoB,OAAO,EACxCA,GAAoB,QAAU,MAI9Bd,GAAoB,UAAY96B,EAAK,IACjC67B,GAAoB,SAAWU,GAAoB,QAAQ,KAAOv8B,EAAK,KACvE,aAAa67B,GAAoB,OAAO,EACxCA,GAAoB,QAAU,MAIlC9sB,GAAYiqB,EAAa,CACzB,MAAM2M,EAAoBb,EAA4B,UAAU,SAAS,wBAAwB,EAC3Fc,EAAgB5tC,IAAeghC,EAAY,WACjD,GAAI,CAAC2M,GAAoB,CAACC,EACtB,MAER,CAEA,GAAI7tC,EAAM,CACN,MAAM62B,EAAY5uB,EAAK,GACjB,CAAE,QAAAmhC,EAAS,QAAAC,GAAS,MAAAlD,EAAA,EAAUhB,GAAgBl9B,EAAK,EAAGA,EAAK,EAAGA,EAAK,CAAC,EAG1E,GAAI,MAAMmhC,CAAO,GAAK,MAAMC,EAAO,GAAK,MAAMlD,EAAK,EAC/C,OAGJ,MAAM5Q,GAAU,KAAK,MAAM6T,CAAO,EAC5B5T,GAAU,KAAK,MAAM6T,EAAO,EAE5ByE,GAAa,KAAK,IAAIvY,GAAUiP,GAAoB,QAAQ,CAAC,EAAI,GAAK,KAAK,IAAIhP,GAAUgP,GAAoB,QAAQ,CAAC,EAAI,EAC1HuJ,GAAchL,GAAoB,UAAYlM,EAEpD,GAAIkX,IAAgB/2B,GAAY82B,GAE5B,GAAIC,IAAe,CAAC/2B,EAAU,CACtB8sB,GAAoB,SACpB,aAAaA,GAAoB,OAAO,EAI5C,MAAM5mC,GAAS+K,EAAK,OAAS,YAAcA,EAAK,WAAc,EAAKA,EAAK,OAAS,WAAa,GAAK,IACnG67B,GAAoB,QAAU,WAAW,IAAM,CAC3C,MAAMnyB,GAAU2O,GAAWtgB,EAAK,QAAQ,EAClCwiB,GAAgBxL,EAAW,CAAE,EAAGue,GAAS,EAAGC,IAAY,OAC9DvT,GAAYjiB,EAAMC,EAAa0d,GAAc1d,CAAU,EAAI,OAAW0R,GAAgBqF,EAAU80B,GAAoBQ,GAAiBt1B,EAAUwL,GAAeva,EAAK,OAAS,WAAY,IAAM,CAAE,EAAG,EAAK,EACxM86B,GAAoB,QAAUlM,EAC9B2N,GAAoB,QAAU,CAAE,GAAI3N,EAAW,EAAGtB,GAAS,EAAGC,EAAA,EAC9DsO,GAAoB,QAAU,IAClC,EAAG5mC,EAAK,CACZ,KAAO,CAEH,MAAMyU,GAAU2O,GAAWtgB,EAAK,QAAQ,EAClCwiB,GAAgBxL,EAAW,CAAE,EAAGue,GAAS,EAAGC,IAAY,OAC9DvT,GAAYjiB,EAAMC,EAAa0d,GAAc1d,CAAU,EAAI,OAAW0R,GAAgBqF,EAAU80B,GAAoBQ,GAAiBt1B,EAAUwL,GAAeva,EAAK,OAAS,WAAY,IAAM,CAAE,EAAG,EAAK,EAEnM67B,GAAoB,UACrBf,GAAoB,QAAUlM,EAC9B2N,GAAoB,QAAU,CAAE,GAAI3N,EAAW,EAAGtB,GAAS,EAAGC,EAAA,EAEtE,CAER,CACJ,SAAWyX,GAAgB,CACvB,MAAMe,EAAOf,GACPjtC,EAAOguC,EAAK,KACZ/tC,EAAa+tC,EAAK,WAExB,GAAInM,GAAe,OAEnB,GAAI7hC,EAAM,CACN,MAAM62B,EAAY52B,GAAc,QAAQD,EAAK,QAAQ,GAC/C,CAAE,QAAAopC,EAAS,QAAAC,GAAS,MAAAlD,EAAA,EAAUhB,GAAgB6I,EAAK,EAAGA,EAAK,EAAGA,EAAK,CAAC,EAG1E,GAAI,MAAM5E,CAAO,GAAK,MAAMC,EAAO,GAAK,MAAMlD,EAAK,EAC/C,OAGJ,MAAM5Q,GAAU,KAAK,MAAM6T,CAAO,EAC5B5T,GAAU,KAAK,MAAM6T,EAAO,EAE5ByE,GAAa,KAAK,IAAIvY,GAAUiP,GAAoB,QAAQ,CAAC,EAAI,GAAK,KAAK,IAAIhP,GAAUgP,GAAoB,QAAQ,CAAC,EAAI,EAGhI,GAFoBzB,GAAoB,UAAYlM,GAEhC7f,GAAY82B,GAAa,CACzC,MAAMn8B,GAAU2O,GAAWtgB,EAAK,QAAQ,EAClCwiB,GAAgBxL,EAAW,CAAE,EAAGue,GAAS,EAAGC,IAAY,OAC9DvT,GAAYjiB,EAAOC,GAAc0d,GAAc1d,CAAU,EAAK0d,GAAc1d,CAAU,EAAI,OAAW0R,GAAgBqF,EAAU80B,GAAoBQ,GAAiBt1B,EAAUwL,GAAewrB,EAAK,OAAS,WAAY,IAAM,CAAE,EAAG,EAAK,EACvOjL,GAAoB,QAAUlM,EAC9B2N,GAAoB,QAAU,CAAE,GAAI3N,EAAW,EAAGtB,GAAS,EAAGC,EAAA,CAClE,CACJ,CACJ,SAAWxe,GAAYiqB,EAAa,CAGhC,GAAIY,GAAe,CACXkB,GAAoB,UACpBlgB,GAAA,EACAkgB,GAAoB,QAAU,MAElC,MACJ,CAEA,MAAM/iC,EAAOihC,EAAY,aACzB,GAAIjhC,EAAM,CACN,MAAM62B,EAAYoK,EAAY,YAAcA,EAAY,GAClD,CAAE,QAAAmI,EAAS,QAAAC,EAAS,MAAAlD,CAAA,EAAUhB,GAAgBlE,EAAY,EAAGA,EAAY,EAAGA,EAAY,CAAC,EAG/F,GAAI,MAAMmI,CAAO,GAAK,MAAMC,CAAO,GAAK,MAAMlD,CAAK,EAC/C,OAGJ,MAAM5Q,GAAU,KAAK,MAAM6T,EAAW,GAAKjD,EAAS,EAAE,EAChD3Q,GAAU,KAAK,MAAM6T,CAAO,EAE5ByE,GAAa,KAAK,IAAIvY,GAAUiP,GAAoB,QAAQ,CAAC,EAAI,GAAK,KAAK,IAAIhP,GAAUgP,GAAoB,QAAQ,CAAC,EAAI,EAGhI,GAFoBzB,GAAoB,UAAYlM,GAEjCiX,GAAY,CAC3B,MAAMtrB,GAAgB,CAAE,EAAG+S,GAAS,EAAGC,EAAA,EACvCvT,GAAYjiB,EAAMihC,EAAY,WAAatjB,GAAcsjB,EAAY,UAAU,EAAI,OAAW,OAAW,GAAM6K,GAAoBQ,GAAiB,GAAM9pB,GAAe,GAAO,IAAM,CAAE,EAAG,EAAK,EAChMugB,GAAoB,QAAUlM,EAC9B2N,GAAoB,QAAU,CAAE,GAAI3N,EAAqB,EAAGtB,GAAS,EAAGC,EAAA,CAC5E,CACJ,CACJ,MAAWuN,GAAoB,UAEvBe,GAAoB,UACpB,aAAaA,GAAoB,OAAO,EACxCA,GAAoB,QAAU,MAI7BD,GAAoB,UACrBA,GAAoB,QAAU,WAAW,IAAM,CAC3ChhB,GAAA,EACAkgB,GAAoB,QAAU,KAC9ByB,GAAoB,QAAU,CAAE,GAAI,KAAM,EAAG,GAAI,EAAG,IACpDX,GAAoB,QAAU,IAClC,EAAG,GAAG,GAGlB,EAAG,CAAC7sB,EAAUiqB,EAAahf,GAAaY,GAAalF,GAAe2C,GAAYuhB,GAAe75B,GAAO8jC,GAAoB3G,GAAiBlD,GAAsBt/B,EAAe,CAAC,EAGjLof,YAAU,IACC,IAAM,CACL8hB,GAAoB,SACpB,aAAaA,GAAoB,OAAO,CAEhD,EACD,EAAE,EAGL9hB,YAAU,IAAM,CACZmhB,GAA0B,QAAU0J,EACxC,EAAG,CAACA,EAAsB,CAAC,EAG3B7qB,YAAU,IAAM,CACZmhB,GAA0B,QAAU0J,EACxC,EAAG,CAACA,EAAsB,CAAC,EAE3B,MAAMqB,GAAa/rB,cAAa9kB,GAAkB,CAC9C,MAAMyvC,EAAKzvC,EAAE,QACP0vC,EAAK1vC,EAAE,QAEb,GAAKwlC,GAAc,QAgBnB,IAbIiK,GAAMjK,GAAc,QAAQ,MAAQiK,GAAMjK,GAAc,QAAQ,OAChEkK,GAAMlK,GAAc,QAAQ,KAAOkK,GAAMlK,GAAc,QAAQ,SAC1DQ,GAAgB,UAASA,GAAgB,QAAU,KAMvDC,GAAY,SACbuJ,GAAuBC,EAAIC,CAAE,EAI7BpM,EAAW,SAAW,CAACiC,GAAY,SAAW,CAACqC,GAAc,SAAS,QAAU,CAACnE,EAAmB,SAEhGF,EAAa,QAAQ,IAAM,IAAMA,EAAa,QAAQ,IAAM,GAAI,CAChE,MAAMjL,EAAKmX,EAAKlM,EAAa,QAAQ,EAC/BhL,EAAKmX,EAAKnM,EAAa,QAAQ,EACrCgE,GAAa,QAAQ,GAAKjP,EAC1BiP,GAAa,QAAQ,GAAKhP,CAC9B,CAIJ,GAAIoL,EAAmB,SAAW,CAAC4B,GAAY,SAAW,CAACqC,GAAc,SAAS,QAC1ErE,EAAa,QAAQ,IAAM,IAAMA,EAAa,QAAQ,IAAM,GAAI,CAChE,MAAMjL,EAAKmX,EAAKlM,EAAa,QAAQ,EAC/BhL,EAAKmX,EAAKnM,EAAa,QAAQ,EAE/BuN,GAAsB,GAC5BtJ,GAAW,QAAQ,GAAKlP,EAAKwY,GAC7BtJ,GAAW,QAAQ,GAAKjP,EAAKuY,EAEjC,CAEJvN,EAAa,QAAU,CAAE,EAAGkM,EAAI,EAAGC,CAAA,EACvC,EAAG,CAACF,EAAsB,CAAC,EAErBuB,GAAcjsB,cAAa9kB,GAAkB,CAG/C,GADa,KAAK,KAAK,KAAK,IAAIA,EAAE,QAAUwjC,EAAa,QAAQ,EAAG,CAAC,EAAI,KAAK,IAAIxjC,EAAE,QAAUwjC,EAAa,QAAQ,EAAG,CAAC,CAAC,EAC7G,EAAG,OAId,MAAMwN,EAAWhxC,EAAE,OACb+vC,EAAgBiB,EAAS,QAAQ,cAAc,EAWrD,GAVI,EAAAjB,GAKaiB,GACbA,IAAa5N,EAAa,SAC1B4N,IAAa3N,EAAU,SACvB,CAAC0M,IAMDvK,GAAc,SAAW9C,EAAsB,CAC/C,MAAMwF,GAAKloC,EAAE,QAAUwlC,GAAc,QAAQ,KACvC2C,EAAKnoC,EAAE,QAAUwlC,GAAc,QAAQ,IAEvC/6B,EAASi/B,GAAkB,QAAQ,KAAKzX,GAC7B,KAAK,KAAK,KAAK,IAAIA,EAAE,GAAKiW,GAAI,CAAC,EAAI,KAAK,IAAIjW,EAAE,GAAKkW,EAAI,CAAC,CAAC,EACxD,KAAK,IAAI,GAAIlW,EAAE,KAAO,EAAE,CACzC,EAED,GAAIxnB,EAAQ,CACR,MAAM7H,EAAO6H,EAAO,KACdggC,EAAehgC,EAAO,WAAa8V,GAAc9V,EAAO,UAAU,EAAI,OACtE2E,EAAUoB,EAAgB,QAAQ5N,EAAK,QAAQ,EAC/C2R,EAAU2O,GAAWtgB,EAAK,QAAQ,EAClCslB,EAAW9Y,GAAS,WAAa,EACjC3F,EAAaghC,GAAc,YAAcr7B,GAAS,kBAClDs7B,GAAiBjhC,EAAak4B,GAAkBl4B,CAAU,EAAI,OAG9DoB,GAAY,CACd,EAAGJ,EAAO,EACV,EAAGA,EAAO,EACV,EAAGA,EAAO,EACV,GAAI,SAASA,EAAO,YAAc7H,EAAK,QAAQ,GAC/C,KAAMslB,EAAW,SAAW,QAC5B,KAAMtlB,EAAK,SACX,WAAY6H,EAAO,WACnB,WAAY2E,GAAS,WAAW,gBAAkB,EAClD,QAAAmF,EACA,WAAY,GACZ,QAAS,GACT,SAAU,EACV,UAAW8O,GAAazgB,CAAI,EAC5B,MAAO6nC,GAAc,MACrB,cAAgBviB,GAAYwiB,GAAkB1oB,GAAaxR,EAAgB,kBAAkBk6B,EAAqB,GAAK,EAAE,EAAI,OAC7H,aAAct7B,EAAU4S,GAAa5S,EAAQ,uBAAyBA,EAAQ,aAAa,EAAI,OAC/F,kBAAmBA,EAAW,CAACA,EAAQ,uBAAyB,CAAC,CAACA,EAAQ,eAAkB9H,GAAgB8H,EAAQ,SAAS,cAAc,EAAI,GAC/I,aAAc,CAAC,EAAExM,EAAK,OAAUA,EAAK,MAAQ,GAC7C,UAAW,CAAC,EAAEA,EAAK,OAAUA,EAAK,MAAQ,GAC1C,WAAY,CAAC,EAAEA,EAAK,OAAUA,EAAK,MAAQ,GAAM6nC,GAAc,UAAYA,EAAa,UAAY,GACpG,KAAMA,GAAc,SAEpB,aAAc7nC,EACd,QAASof,GAAaxR,EAAgB,QAAQ5N,EAAK,uBAAyBA,EAAK,QAAQ,GAAG,mBAAmB,MAAQ,EAAE,GAG7H0sC,GAAgBzkC,EAAI,CACxB,CACJ,CACJ,EAAG,CAACykC,GAAiBpsB,GAAYwf,EAAsBuL,GAAiB1tB,EAAa,CAAC,EAEhFyR,GAAgBlN,cAAa9kB,GAAqB,CACpD,GAAIA,EAAE,MAAQ,SAAU,CAEpB,GAAIkmC,GAAmB,CACnBC,GAAqB,EAAK,EAE1B8H,GAAA,EACA,MACJ,CAEAA,GAAA,EACApL,IAAA,EACA,MACJ,CAGI0C,GAAY,SAEhBK,GAAY,QAAQ,IAAI5lC,EAAE,IAAI,aAAa,CAC/C,EAAG,CAACiuC,GAAiBpL,EAAaqD,EAAiB,CAAC,EAGpDvhB,YAAU,IAAM,CACRme,IACAA,EAAa,QAAUmL,GAE/B,EAAG,CAACnL,EAAcmL,EAAe,CAAC,EAElC,MAAMgD,GAAcnsB,cAAa9kB,GAAqB,CAE9CulC,GAAY,SAEhBK,GAAY,QAAQ,OAAO5lC,EAAE,IAAI,aAAa,CAClD,EAAG,EAAE,EAECkxC,GAAapsB,cAAa9kB,GAAkB,CAC9C,GAAI,CAAAkmC,GAWJ,IARIzC,EAAmB,UACnBA,EAAmB,QAAU,IAE7BC,GAAmB,UACnBA,GAAmB,QAAU,IAI7B1jC,EAAE,SAAW,EAAG,CAChBA,EAAE,iBACF2jC,EAAmB,QAAU,GAC7B,MACJ,CAGI3jC,EAAE,SAAW,IACbsjC,EAAW,QAAU,GACrBE,EAAa,QAAU,CAAE,EAAGxjC,EAAE,QAAS,EAAGA,EAAE,UAEpD,EAAG,CAACkmC,EAAiB,CAAC,EAEhBiL,GAAWrsB,cAAa9kB,GAAmB,CAE7C,GAAIA,GAAG,SAAW,EAAG,CACjB2jC,EAAmB,QAAU,GAC7B,MACJ,CACAL,EAAW,QAAU,GACrBK,EAAmB,QAAU,EACjC,EAAG,EAAE,EAECyN,GAActsB,cAAa9kB,GAAwB,CAGrD,GAAI4Z,GAAYguB,GAAc,SAAS,QAAU1B,GAAmB,OAIpE,MAAMmL,EAAY5M,GAAgB,IAAM,IAClC6M,EAAQtxC,EAAE,OAAS,EAAI,CAACqxC,EAAYA,EAIpCE,EAAO,KAEbhK,GAAa,QAAQ,EAAI,KAAK,IAAIgK,EAAMhK,GAAa,QAAQ,EAAI+J,CAAK,CAG1E,EAAG,CAAC13B,EAAU6qB,GAAeyB,EAAiB,CAAC,EAIzCpS,GAAkBhP,cAAY,CAChCvW,EACAijC,EACAC,EACAzB,IACmF,CACnF,GAAI,CAACxK,GAAc,QAAS,OAAO,KAEnC,KAAM,CAAE,QAAAoH,EAAS,QAAAC,EAAA,EAAYlF,GAAsB,QAGnD,IAAIiI,EAOJ,GALII,IACAJ,EAAYhlC,GAAM,KAAKkhC,GAAKA,EAAE,KAAOkE,GAAUlE,EAAE,aAAekE,CAAM,GAItE,CAACJ,GAAarhC,EAAU,CACxB,MAAMghB,EAAahhB,EAAS,cAItBmjC,EAAgBniB,EAAW,MAAM,uDAAuD,EAC9F,GAAImiB,EAAe,CACf,MAAMC,EAAgBD,EAAc,CAAC,EAErC9B,EAAYhlC,GAAM,KAAKkhC,GACfA,EAAE,OAAS,YAAc,CAACA,EAAE,WAAmB,GAC5CA,EAAE,QAAQ,gBAAkB6F,CACtC,CACL,CAGK/B,IACDA,EAAYhlC,GAAM,KAAKkhC,GAAK,CACxB,GAAI,CAACA,EAAE,KAAM,MAAO,GAEpB,MAAMzkC,EADUmJ,EAAgB,QAAQs7B,EAAE,IAAI,GACxB,mBAAmB,MAAM,eAAiB,GAEhE,OAAOzkC,EAAK,SAASkoB,CAAU,GAAKA,EAAW,SAASloB,CAAI,CAChE,CAAC,EAET,CAEA,GAAIuoC,EAAW,CAGX,GADqBnL,IAAiBmL,EAAU,KAAOrL,GAGnD,MAAO,CACH,EAAGqI,EACH,EAAGC,GACH,MAAO,IACP,QAAS,EACT,OAAQ+C,EAAU,IAI1B,KAAM,CAAE,QAAA5D,EAAS,QAAAC,EAAS,MAAAlD,EAAO,OAAAD,EAAQ,UAAAI,CAAA,EAAcnB,GAAgB6H,EAAU,EAAGA,EAAU,EAAGA,EAAU,CAAC,EAG5G,GAAI,CAAC1G,EAAW,OAAO,KAGvB,IAAIjO,GAAU,EAGd,OAAI6N,EAAS,MACT7N,IAAW,KAAK,IAAI,EAAG,GAAK6N,EAAS,KAAO,GAAG,GAK/CA,EAAS,OACT7N,IAAW,KAAK,IAAI,EAAG,GAAK,KAAK,IAAI6N,CAAM,EAAI,KAAQ,GAAK,GAGzD,CACH,EAAGkD,EACH,EAAGC,EACH,MAAAlD,EACA,QAAA9N,GACA,OAAQ2U,EAAU,GAE1B,CAGA,IAAIgC,EAMJ,GAJI5B,IACA4B,EAAevF,GAAe,QAAQ,KAAKpa,GAAKA,EAAE,aAAe+d,CAAM,GAGvE,CAAC4B,GAAgBrjC,EAAU,CAC3B,MAAMghB,EAAahhB,EAAS,cAC5BqjC,EAAevF,GAAe,QAAQ,KAAKpa,GAAK,CAC5C,GAAI,CAACA,EAAE,cAAc,SAAU,MAAO,GAEtC,MAAM5qB,EADUmJ,EAAgB,QAAQyhB,EAAE,aAAa,QAAQ,GACzC,mBAAmB,MAAM,eAAiB,GAChE,OAAO5qB,EAAK,SAASkoB,CAAU,GAAKA,EAAW,SAASloB,CAAI,CAChE,CAAC,CACL,CAEA,GAAIuqC,EAAc,CACd,KAAM,CAAE,QAAA5F,EAAS,QAAAC,EAAS,MAAAlD,EAAO,OAAAD,EAAQ,UAAAI,CAAA,EAAcnB,GAAgB6J,EAAa,EAAGA,EAAa,EAAGA,EAAa,CAAC,EAGrH,GAAI,CAAC1I,EAAW,OAAO,KAGvB,IAAIjO,EAAU,EAEd,OAAI6N,EAAS,MACT7N,GAAW,KAAK,IAAI,EAAG,GAAK6N,EAAS,KAAO,GAAG,GAG/CA,EAAS,OACT7N,GAAW,KAAK,IAAI,EAAG,GAAK,KAAK,IAAI6N,CAAM,EAAI,KAAQ,GAAK,GAGzD,CACH,EAAGkD,EACHC,EACA,MAAAlD,EACA,QAAA9N,EACA,OAAQ2W,EAAa,WAE7B,CAEA,OAAO,IACX,EAAG,CAAChnC,GAAO65B,GAAeF,GAAqBc,GAAqB0C,EAAe,CAAC,EAG9E8J,GAAuB/sB,cAAY,MAAOja,EAAoB7K,IAAwB,CAUxF,GATAA,EAAE,iBACFA,EAAE,kBAGE6jC,GAEA,CAACh5B,EAAK,cAGNA,EAAK,OAAS,YAAcA,EAAK,YAAc,SAAU,OAG7D4a,GAAA,EACAkgB,GAAoB,QAAU,KAG9B,MAAM/iC,EAAOiI,EAAK,aACZuE,EAAUoB,EAAgB,QAAQ5N,EAAK,QAAQ,EACrD,GAAI,CAACwM,EAAS,OAGd,KAAM,CAAE,WAAAtN,EAAY,oBAAqBmB,EAAA,EAAWtB,EAAgB,WAE9D+6B,EADc56B,EAAW,KAAKE,IAAKA,GAAE,cAAgBiB,EAAM,GAC9B,WAAanJ,EAAc,MAG9D0qC,GAAuB35B,EAAK,EAAE,EAC9B65B,GAAiB,EAAI,EACrBE,GAAoB,EAAK,EAGzB,MAAMzM,EAAU,CAACttB,EAAK,EAChButB,EAAU,CAACvtB,EAAK,EAChBi9B,EAAU,CAACj9B,EAAK,EAAI,IAM1B,GAHAg9B,GAAgB1P,EAASC,EAAS0P,EAAS,GAAG,EAG1CtC,GAAc,QAAS,CACvB,KAAM,CAAE,QAAAwG,GAAS,QAAAC,GAAS,MAAAlD,EAAA,EAAUhB,GAAgBl9B,EAAK,EAAGA,EAAK,EAAGA,EAAK,CAAC,EAC1Ey5B,GAAoB,CAAE,EAAG0H,GAAS,EAAGC,GAAS,MAAAlD,GAAO,CACzD,CAGA,GAAIl+B,EAAK,OAAS,WAAY,CAC1B,MAAM0J,GAAU1J,EAAK,QACfinC,GAAcv9B,GAAQ,cAG5B+yB,GAAwB/yB,EAAO,EAG/B,GAAI,CACA,MAAMrS,GAAY,MAAMi8B,GACpB,WACA2T,GACApV,EACA,CAAE,WAAYl3B,GAAc,KAAM6jC,EAAA,CAAgB,EAEtDjF,GAAsB,MAAM,QAAQliC,EAAS,EAAIA,GAAY,EAAE,CACnE,OAAStE,GAAK,CACV3F,GAAS,gBAAiB,yCAA0C2F,EAAG,EACvEwmC,GAAsB,EAAE,CAC5B,CACA,MACJ,CAGA,MAAMlc,EAAWrd,EAAK,OAAS,SACzB2/B,EAAU3/B,EAAK,OAAS,QAC9B,GAAI,CAACqd,GAAY,CAACsiB,EAAS,OAG3B,MAAMj8B,EAAWa,EAAQ,mBAAmB,MAAQ,GACpD,GAAKb,EAGL,GAAI,CACA,MAAMrM,GAAY,MAAMi8B,GACpBjW,EAAW,SAAW,QACtB3Z,EACAmuB,EACA,CAAE,WAAYl3B,GAAc,KAAM6jC,EAAA,CAAgB,EAEtDjF,GAAsB,MAAM,QAAQliC,EAAS,EAAIA,GAAY,EAAE,EAG/D,MAAMqS,GAAU2O,GAAWtgB,EAAK,QAAQ,EACxC0kC,GAAwB/yB,EAAO,CACnC,OAAS3W,GAAK,CACV3F,GAAS,gBAAiB,4BAA6B2F,EAAG,EAC1DwmC,GAAsB,EAAE,CAC5B,CACJ,EAAG,CAAClhB,GAAYokB,GAAyB9hC,GAAc6jC,GAAiBtB,GAAiBF,EAAe,CAAC,EAGnGkK,GAAqBjtB,cAAY,MAAOyL,GAAiB,CAE3DmU,GAAiB,EAAK,EACtBN,GAAsB,EAAE,EAQxB6J,GAAA,EAEAr2C,GAAS,gBAAiB,+BAAgC24B,CAAO,EAGjE,MAAMyhB,MAAc,IAGdC,EAAiB,CAAC5qC,EAAc2H,IAClCpE,GAAM,KAAKkhC,GAAKA,EAAE,OAAS98B,GAAQ88B,EAAE,cAAc,mBAAmB,OAASzkC,CAAI,EAEjF0hB,EAAQkpB,EAAe1hB,EAAQ,MAAO,OAAO,EAC7C2hB,EAASD,EAAe1hB,EAAQ,OAAQ,QAAQ,EAElDxH,GAAO,YAAYipB,EAAQ,IAAIjpB,EAAM,UAAU,EAC/CmpB,GAAQ,YAAYF,EAAQ,IAAIE,EAAO,UAAU,EAGrD,MAAMjhC,GAAWrG,GAAM,KAAKkhC,GAAKA,EAAE,OAAS,YAAcA,EAAE,SAAS,gBAAkBvb,EAAQ,cAAc,aAAa,EA2B1H,GA1BItf,IAAU,YAAY+gC,EAAQ,IAAI/gC,GAAS,UAAU,EA0BrD8X,GAAO,YAAcmpB,GAAQ,WAAY,CACzC,MAAM93C,EAAc+hC,IAAuB,GAIrCiF,EAAqB,CACvB,GAAI,WAAW,KAAK,KAAK,GACzB,KAAM7Q,EAAQ,UACd,QAASA,EAAQ,QAAQ,cACzB,cAAeA,EAAQ,UAEvB,aAAc,CACV,KAAMA,EAAQ,OACd,KAAM2hB,GAAQ,cAAc,UAAY,EACxC,KAAM,GAEV,YAAa,CACT,KAAM3hB,EAAQ,MACd,KAAMxH,GAAO,cAAc,UAAY,EACvC,KAAM,GAEV,MAAO,GACP,UAAW,GACX,eAAgB,CAEZ,aAAc9X,IAAU,cAAc,UAAY,EAGtD,EAKAihC,EAAO,WAYX,GAAI,CAEAt6C,GAAS,gBAAiB,oCAAqCwpC,CAAa,EAI5E,KAAM,CAAE,QAAAr9B,EAAS,MAAA7I,CAAA,EAAU,MAAM8V,GAAgB,WAAWowB,EAAehnC,EAAa,OAAW,GAAO,CAAE,OAAQ,GAAO,EAEtH2J,GAGDnM,GAAS,gBAAiB,gBAAgB,EAE1C6M,GAAW,WAAW,sBAAsB,SAAS,EAGrD0hC,GAAqB,EAAK,EAC1BnB,GAAsB,IAAI,GAR1B/sC,GAAS,gBAAiB,gBAAiBiD,CAAK,CAUxD,OAAS0C,EAAK,CACV3F,GAAS,gBAAiB,gBAAiB2F,CAAG,CAClD,CACJ,CACJ,EAAG,CAACgN,GAAOuxB,GAAqB8R,EAAe,CAAC,EAG1CkE,GAAwBrtB,cAAastB,GAAqB,CACxDrM,GAAkB,UAAYqM,IAClCrM,GAAkB,QAAUqM,EACxBA,IACA3sB,GAAA,EACAkgB,GAAoB,QAAU,MAEtC,EAAG,CAAClgB,EAAW,CAAC,EAGV4sB,GAAkBvtB,cAAaiR,GAAqF,CACtHiP,GAAsBjP,CAAI,CAC9B,EAAG,EAAE,EAECuc,GAAaxtB,cAAY,IAAM,CACjC,GAAIse,EAAa,SAAWC,EAAU,QAAS,CAC3C,MAAM4M,EAAO7M,EAAa,QAAQ,wBAClCoC,GAAc,QAAUyK,EAExB,MAAMvD,EAASrJ,EAAU,QACnBkP,EAAM,OAAO,kBAAoB,EACvC7F,EAAO,MAAQuD,EAAK,MAAQsC,EAC5B7F,EAAO,OAASuD,EAAK,OAASsC,EAC9B9M,GAAW,QAAU,CAAE,MAAOwK,EAAK,MAAO,OAAQA,EAAK,QAEvD,MAAMtD,EAAMD,EAAO,WAAW,IAAI,EAC9BC,GAAKA,EAAI,MAAM4F,EAAKA,CAAG,CAC/B,CACJ,EAAG,EAAE,EAIL5tB,YAAU,IAAM,CACZ2tB,GAAA,CACJ,EAAG,CAACvzB,GAAoBD,GAAsBE,GAAgBoqB,GAAyBkJ,EAAU,CAAC,EAElG3tB,YAAU,IAAM,CAEZkhB,GAAQ,QAAWxnC,GAAgB,CAG/B,GAAI,CAACknC,GAAY,SAAW,CAACqC,GAAc,SAAS,OAAQ,CACxD,MAAM4K,EAAY3L,GAAiB,QAAU,GAAK,GAC5C4L,EAAW,SAAS,cAQtB,EAPaA,IACbA,EAAS,UAAY,SACrBA,EAAS,UAAY,YACpBA,EAAyB,qBAIb,CAACvM,IAAqB,CAACW,GAAiB,UACjDjB,GAAY,QAAQ,IAAI,GAAG,IAAG2B,GAAa,QAAQ,GAAKiL,GACxD5M,GAAY,QAAQ,IAAI,GAAG,IAAG2B,GAAa,QAAQ,GAAKiL,GACxD5M,GAAY,QAAQ,IAAI,GAAG,IAAG2B,GAAa,QAAQ,GAAKiL,GACxD5M,GAAY,QAAQ,IAAI,GAAG,IAAG2B,GAAa,QAAQ,GAAKiL,GAExD5M,GAAY,QAAQ,IAAI,GAAG,IAAG2B,GAAa,QAAQ,GAAKiL,GACxD5M,GAAY,QAAQ,IAAI,GAAG,IAAG2B,GAAa,QAAQ,GAAKiL,GAEpE,CAGA,GAAIlM,IAAiB,CAACf,GAAY,SAAW,CAACqC,GAAc,SAAS,QAAU,CAACf,GAAiB,QAAS,CAItGL,GAAW,SAAW,MAAcnoC,GAAO+nC,GAAkB,SAAW/nC,IAGxE,MAAMq0C,EAAS,KAAK,IAAIlM,GAAW,OAAO,EAAI,IAC1C,KAAK,IAAIA,GAAW,QAAU,EAAG,EAAI,IAAiB,GACpDmM,EAAS,KAAK,IAAInM,GAAW,QAAU,EAAG,EAAI,IAAiB,GACjE,KAAK,IAAIA,GAAW,QAAU,EAAG,EAAI,IAAiB,GAS1D,GANAD,GAAY,QAAQ,GAAKmM,EACzBnM,GAAY,QAAQ,GAAKoM,EACzBpL,GAAa,QAAQ,GAAKmL,EAC1BnL,GAAa,QAAQ,GAAKoL,EAGtBnN,GAAc,SAAWjC,EAAa,QAAQ,IAAM,GAAI,CACxD,MAAMqJ,EAAUpH,GAAc,QAAQ,KAAOA,GAAc,QAAQ,MAAQ,EACrEqH,EAAUrH,GAAc,QAAQ,IAAMA,GAAc,QAAQ,OAAS,EACrEoN,GAAerP,EAAa,QAAQ,EAAIqJ,IAAYpH,GAAc,QAAQ,MAAQ,GAClFqN,IAAetP,EAAa,QAAQ,EAAIsJ,IAAYrH,GAAc,QAAQ,OAAS,GAGnFsN,GAAmB,EACnBC,GAAgBF,GAAcC,GAC9BE,GAAgB,CAACJ,EAAcE,GAGrCtL,GAAW,QAAQ,IAAMuL,GAAgBvL,GAAW,QAAQ,GAAK,IACjEA,GAAW,QAAQ,IAAMwL,GAAgBxL,GAAW,QAAQ,GAAK,GACrE,CACJ,CAQA,GAAIhC,GAAc,SAAW,CAACD,GAAY,SAAW,CAACsB,GAAiB,SAAW,CAACnD,GAAmB,QAAS,CAC3G,MAAMkJ,EAAUpH,GAAc,QAAQ,KAAOA,GAAc,QAAQ,MAAQ,EACrEqH,EAAUrH,GAAc,QAAQ,IAAMA,GAAc,QAAQ,OAAS,EAS3E,GALAiC,GAAe,QAAQ,EAAI,EAAElE,EAAa,QAAQ,EAAIqJ,GAAW,IACjEnF,GAAe,QAAQ,EAAI,EAAElE,EAAa,QAAQ,EAAIsJ,GAAW,IAI7D7G,GAAgB,QAAS,CAGzB,KAAM,CAAE,KAAA7qB,EAAM,IAAA83B,EAAK,MAAArtB,EAAO,OAAAC,EAAA,EAAW2f,GAAc,QAC7CiK,GAAKlM,EAAa,QAAQ,EAC1BmM,GAAKnM,EAAa,QAAQ,EAG1B2P,GAAWzD,GAAKt0B,EAChBg4B,GAAah4B,EAAOyK,EAAS6pB,GAC7B2D,GAAU1D,GAAKuD,EACfI,GAAcJ,EAAMptB,GAAU6pB,GAG9B4D,GAAgB5kC,IAAiB,CACnC,MAAM6kC,GAAa,EAAK,KAAK,IAAI,EAAG7kC,EAAI,EAAI,IAC5C,OAAO6kC,GAAaA,EACxB,EAGIL,GAAW,KAAiBA,GAAW,MACvC3L,GAAa,QAAQ,GAAK,GAAc+L,GAAaJ,EAAQ,GAG7DC,GAAY,KAAiBA,GAAY,MACzC5L,GAAa,QAAQ,GAAK,GAAc+L,GAAaH,EAAS,GAG9DC,GAAU,KAAiBA,GAAU,MACrC7L,GAAa,QAAQ,GAAK,GAAc+L,GAAaF,EAAO,GAG5DC,GAAa,KAAiBA,GAAa,MAC3C9L,GAAa,QAAQ,GAAK,GAAc+L,GAAaD,EAAU,EAEvE,CACJ,MAAW9N,GAAY,SAAWsB,GAAiB,SAAWnD,GAAmB,WAE7E+D,GAAe,QAAU,CAAE,EAAG,EAAG,EAAG,GACpCC,GAAe,QAAU,CAAE,EAAG,EAAG,EAAG,IAQxC,GAAIE,GAAc,SAAS,OAAQ,CAC/B,KAAM,CAAE,UAAA3R,EAAW,SAAAC,EAAU,MAAAsd,EAAO,OAAA/oC,CAAA,EAAWm9B,GAAc,QAU7D,GAAI,EANA,OAAO3R,GAAc,UAAY,CAAC,MAAMA,CAAS,GACjD,OAAOC,GAAa,UAAY,CAAC,MAAMA,CAAQ,GAAKA,EAAW,GAC/Dsd,GAAS,OAAOA,EAAM,GAAM,UAAY,CAAC,MAAMA,EAAM,CAAC,GACtD/oC,GAAU,OAAOA,EAAO,GAAM,UAAY,CAAC,MAAMA,EAAO,CAAC,GAKzDzS,GAAQ,gBAAiB,0CAA2C4vC,GAAc,OAAO,EACzFA,GAAc,QAAQ,OAAS,OAE5B,CACH,MAAMxR,EAAU/3B,EAAM43B,EAChBrtB,EAAW,KAAK,IAAIwtB,EAAUF,EAAU,CAAC,EACzCud,GAAO,EAAI,KAAK,IAAI,EAAI7qC,EAAU,CAAC,EAEzC6vB,EAAO,QAAU,CACb,EAAG+a,EAAM,GAAK/oC,EAAO,EAAI+oC,EAAM,GAAKC,GACpC,EAAGD,EAAM,GAAK/oC,EAAO,EAAI+oC,EAAM,GAAKC,GACpC,EAAGD,EAAM,GAAK/oC,EAAO,EAAI+oC,EAAM,GAAKC,EAAA,EAGpC7qC,GAAY,IAEZ6vB,EAAO,QAAU,CAAE,GAAGhuB,CAAA,EACtB88B,GAAa,QAAU,CAAE,GAAG98B,CAAA,EAC5Bm9B,GAAc,QAAQ,OAAS,GAEvC,CACJ,KAAO,CAUH,MAAM8L,EAAOjb,EAAO,QAAQ,GAAK8O,GAAa,QAAQ,EAAI9O,EAAO,QAAQ,GAAK,IACxEkb,EAAOlb,EAAO,QAAQ,GAAK8O,GAAa,QAAQ,EAAI9O,EAAO,QAAQ,GAAK,IACxEmb,EAAOnb,EAAO,QAAQ,GAAK8O,GAAa,QAAQ,EAAI9O,EAAO,QAAQ,GAAK,IAE1E,CAAC,MAAMib,CAAI,GAAK,CAAC,MAAMC,CAAI,GAAK,CAAC,MAAMC,CAAI,GAC3Cnb,EAAO,QAAQ,EAAIib,EACnBjb,EAAO,QAAQ,EAAIkb,EACnBlb,EAAO,QAAQ,EAAImb,IAGnB57C,GAAQ,gBAAiB,wCAAyC,CAC9D,OAAQygC,EAAO,QACf,aAAc8O,GAAa,QAC9B,EACD9O,EAAO,QAAU,CAAE,EAAG,EAAG,EAAG,EAAG,EAAG,MAClC8O,GAAa,QAAU,CAAE,EAAG,EAAG,EAAG,EAAG,EAAG,OAI5C,MAAMjP,EAAK,KAAK,IAAIG,EAAO,QAAQ,EAAI8O,GAAa,QAAQ,CAAC,EACvDhP,EAAK,KAAK,IAAIE,EAAO,QAAQ,EAAI8O,GAAa,QAAQ,CAAC,EACvDsM,EAAK,KAAK,IAAIpb,EAAO,QAAQ,EAAI8O,GAAa,QAAQ,CAAC,EAKvDuM,GAJWxb,EAAKC,EAAKsb,EAIC,GAExBC,KAAa7N,GAAY,UACzBA,GAAY,QAAU6N,GAClBA,KAEAruB,GAAA,EACAkgB,GAAoB,QAAU,OAKtC+B,GAAe,QAAQ,IAAMD,GAAe,QAAQ,EAAIC,GAAe,QAAQ,GAAK,GACpFA,GAAe,QAAQ,IAAMD,GAAe,QAAQ,EAAIC,GAAe,QAAQ,GAAK,EACxF,CAGAoG,GAAgBtG,GAAW,QAAQ,EAAGA,GAAW,QAAQ,EAAGnpC,CAAG,EAG/D,MAAMi6B,EAAKG,EAAO,QAAQ,EACpBF,EAAKE,EAAO,QAAQ,EAK1B,IAAIsb,EAAkB,GACtB,GAAIvO,GAAc,SAAWjC,EAAa,QAAQ,GAAK,EAAG,CAGtD,MAAMyQ,EAASzQ,EAAa,QAAQ,EAAIiC,GAAc,QAAQ,IAC1DwO,EAAS,KAAOA,EAAS,MACzBD,EAAkB,GAE1B,CAIA,MAAME,EAAaxb,EAAO,QAAQ,EAAI,IAChCyb,GAAW,KAAK,IAAI5b,CAAE,EAAI,KAAO,KAAK,IAAIC,CAAE,EAAI,IAGhD4b,EAAa,CAACJ,IAAoBE,GAAcC,IAElDC,IAAelN,GAAgB,SAC/BL,GAAgBuN,CAAU,EAI9BvpC,GAAM,QAAQC,GAAQ,CAClB,MAAM+0B,EAAK+J,GAAS,QAAQ,IAAI9+B,EAAK,EAAE,EACvC,GAAI,CAAC+0B,EAAI,OAET,MAAM5a,EAAYypB,GAAe,UAC7BA,GAAe,QAAQ,KAAO5jC,EAAK,IAClC4jC,GAAe,QAAQ,YAAc5jC,EAAK,YAAc4jC,GAAe,QAAQ,aAAe5jC,EAAK,YAIxG,IAAIupC,EAAavpC,EAAK,EAAI4tB,EAAO,QAAQ,EACzC,MAAM9a,EAAa9S,EAAK,YAAcA,EAAK,OAAS,WAC9CsiC,EAAS7H,GAAmBz6B,CAAI,EAGhCuiC,EAAgBlB,GAAmB,QAAQ,IAAIrhC,EAAK,EAAE,EAG5D,IAAIwpC,GAAkB,GAClBrR,EAAY,UAAY,gBACxBqR,GAAkBxpC,EAAK,OAAS,WACzBm4B,EAAY,UAAY,mBAE/BqR,GAAkBxpC,EAAK,OAAS,UAAYA,EAAK,OAAS,SAG9D,MAAMypC,GAAclH,GAAiBiH,IAAoBlH,GAAUnoB,EAOnE,GAAI,EAFkBmoB,GAAUxvB,GAAey2B,GAD/B7uC,KAAoB,MAAQ,MAAQA,KAAoB,SAAW,MAAS,OACrB6uC,EAAa,KAEhE,CAChBxU,EAAG,MAAM,QAAU,OAGf+F,GAAoB,UAAY96B,EAAK,KACrC4a,GAAA,EACAkgB,GAAoB,QAAU,MAElC,MACJ,CAGA,GAAI,CAAC2O,GACD1U,EAAG,MAAM,QAAU,OACnBA,EAAG,MAAM,QAAU,IACnBA,EAAG,MAAM,cAAgB,OAEzBA,EAAG,UAAU,OAAO,yBAAyB,EAC7CA,EAAG,UAAU,IAAI,qBAAqB,EAClC+F,GAAoB,UAAY96B,EAAK,KACrC4a,GAAA,EACAkgB,GAAoB,QAAU,UAE/B,CAEH/F,EAAG,UAAU,OAAO,qBAAqB,EACrC/0B,EAAK,cAAc+0B,EAAG,UAAU,IAAI,yBAAyB,EAE7D5a,IACA4a,EAAG,UAAU,IAAI,sBAAsB,EACvCA,EAAG,MAAM,OAAS,QAItB,KAAM,CAAE,OAAAoJ,GAAQ,OAAAC,GAAQ,MAAAF,GAAO,OAAAD,GAAQ,UAAWyL,EAAA,EAAkBxM,GAAgBl9B,EAAK,EAAGA,EAAK,EAAGA,EAAK,CAAC,EAGpGq+B,GAAYqL,IAAkBvvB,GAAa8jB,GAAS,IAK1D,GAAIqE,GAAUtG,GAAiB,SACFh8B,EAAK,KAAOk8B,GAAuB,QAEtC,CAElB,MAAMyN,GAAgBjP,GAAY,SAAW2B,GAAsB,QAGnEtH,EAAG,MAAM,UAAY,wCACrBA,EAAG,MAAM,QAAU,QAEf4U,IAGA5U,EAAG,MAAM,OAAS,SAClBA,EAAG,MAAM,QAAU,MACnBA,EAAG,MAAM,cAAgB,SAGzBA,EAAG,MAAM,OAAS,QAClBA,EAAG,MAAM,QAAU,IACnBA,EAAG,MAAM,cAAgB,QAE7B,MACJ,CAIJ,IAAI3E,GAAU,EAGd,GAAKjW,EAcDiW,GAAU,UAZN6N,GAAS,MACT7N,IAAW,KAAK,IAAI,EAAG,GAAK6N,GAAS,KAAO,GAAG,GAI/CA,GAAS,KAAO,CAEhB,MAAM2L,GAAYlvC,KAAoB,MAAQ,KAAOA,KAAoB,SAAW,IAAQ,IACtFmvC,GAAYnvC,KAAoB,MAAQ,IAAOA,KAAoB,SAAW,IAAO,IAC3F01B,IAAW,KAAK,IAAI,EAAG,GAAK,KAAK,IAAI6N,EAAM,EAAI2L,IAAaC,EAAS,CACzE,CAQJ,GAFoBvN,GAAwB,QAE3B,CACb,MAAM/N,GAAa8N,GAAsB,QACnCyN,GAAwBvb,KAAevuB,EAAK,aAAeuuB,GAAW,iBAAmBvuB,EAAK,aAAeuuB,GAAW,kBAE9H,GAAIpU,GAAa2vB,GACb1Z,GAAU,MACP,CAGHA,GAAU,EACV2E,EAAG,MAAM,QAAU,OACnB,MACJ,CACJ,CAgBA,GAbAA,EAAG,MAAM,QAAU,QACnBA,EAAG,MAAM,QAAU3E,GAAQ,WAC3B2E,EAAG,MAAM,cAAgB3E,GAAU,IAAO,OAAS,OAKnD2E,EAAG,MAAM,UAAY,eAAeoJ,EAAM,OAAOC,EAAM,kBAAkBF,EAAK,IAI9EnJ,EAAG,MAAM,OAAS5a,EAAY,QAAU,KAAK,MAAM8jB,GAAS,GAAK,EAAE,WAE/D7N,GAAU,IAAM,CAChB2E,EAAG,MAAM,QAAU,OACf+F,GAAoB,UAAY96B,EAAK,KACrC4a,GAAA,EACAkgB,GAAoB,QAAU,MAElC,MACJ,CAEA,GAAIH,GAAc,QAAS,CAEvB,MAAMoP,GAAQpP,GAAc,QAAQ,MAAQ,EAAI,IAC1CqP,GAAQrP,GAAc,QAAQ,OAAS,EAAI,IAE7C,KAAK,IAAIwD,EAAM,EAAI4L,IAAS,KAAK,IAAI3L,EAAM,EAAI4L,IAAS,CAAC3L,IACzDtJ,EAAG,MAAM,QAAU,OAEf+F,GAAoB,UAAY96B,EAAK,KACrC4a,GAAA,EACAkgB,GAAoB,QAAU,OAGlC/F,EAAG,MAAM,QAAU,OAE3B,CACJ,CACJ,CAAC,EAKG2F,GAAY,SAAWkJ,GAAe,QACtC3I,GAA0B,QAAQ,GAAI,EAAE,EACjC,CAACxC,EAAW,SAAW0C,GAAgB,SAAWzC,EAAa,QAAQ,IAAM,GAEpFuC,GAA0B,QAAQvC,EAAa,QAAQ,EAAGA,EAAa,QAAQ,CAAC,EACzE,CAACgC,GAAY,SAAW,CAACS,GAAgB,SAAWL,GAAoB,UAE/ElgB,GAAA,EACAkgB,GAAoB,QAAU,MAIlCU,GAAW,UACPhoC,EAAM+nC,GAAkB,QAAU,MAClCpC,EAAO,KAAK,MAAOqC,GAAW,QAAU,KAAShoC,EAAM+nC,GAAkB,QAAQ,CAAC,EAClFA,GAAkB,QAAU/nC,EAC5BgoC,GAAW,QAAU,EAI7B,CACJ,EAAG,CAACz7B,GAAOkjC,GAAiBwE,GAAYjN,GAAqB5f,GAAasiB,GAAiBnB,EAAe,CAAC,EAE3G,MAAMkO,GAAmBzwB,SAAO2N,EAAa,EACvC+iB,GAAiB1wB,SAAO4sB,EAAW,EACnC+D,GAAiB3wB,SAAO0sB,EAAW,EACnCkE,GAAgB5wB,SAAO6sB,EAAU,EACjCgE,GAAc7wB,SAAO8sB,EAAQ,EAC7BgE,GAAgB9wB,SAAOwsB,EAAU,EAGvClsB,YAAU,IAAM,CACZmwB,GAAiB,QAAU9iB,GAC3B+iB,GAAe,QAAU9D,GACzB+D,GAAe,QAAUjE,GACzBkE,GAAc,QAAU/D,GACxBgE,GAAY,QAAU/D,GACtBgE,GAAc,QAAUtE,GAGxB/K,GAA0B,QAAU0J,EACxC,EAAG,CAACxd,GAAeif,GAAaF,GAAaG,GAAYC,GAAUN,GAAYrB,EAAsB,CAAC,EAEtG7qB,YAAU,IAAM,CACZ,MAAMywB,EAAc/2C,GAAgB,CAChCwnC,GAAQ,UAAUxnC,CAAG,EACrBqnC,GAAM,QAAU,sBAAsB0P,CAAU,CACpD,EAEA9C,GAAA,EACA5M,GAAM,QAAU,sBAAsB0P,CAAU,EAGhD,MAAMC,EAAUr1C,GAAkBi1C,GAAc,QAAQj1C,CAAC,EACnDs1C,EAAQt1C,GAAkBk1C,GAAY,QAAQl1C,CAAC,EAC/Cu1C,EAAUv1C,GAAkBm1C,GAAc,QAAQn1C,CAAC,EACnDknB,EAAWlnB,GAAkBg1C,GAAe,QAAQh1C,CAAC,EACrDw1C,GAAax1C,GAAqB80C,GAAiB,QAAQ90C,CAAC,EAC5Dy1C,EAAWz1C,GAAqB+0C,GAAe,QAAQ/0C,CAAC,EACxD01C,EAAW,IAAMpD,GAAA,EAEvB,cAAO,iBAAiB,YAAa+C,CAAM,EAC3C,OAAO,iBAAiB,UAAWC,CAAI,EACvC,OAAO,iBAAiB,YAAaC,EAAQ,CAAE,QAAS,GAAM,EAC9D,OAAO,iBAAiB,QAASruB,CAAO,EACxC,OAAO,iBAAiB,UAAWsuB,EAAS,EAC5C,OAAO,iBAAiB,QAASC,CAAO,EACxC,OAAO,iBAAiB,SAAUC,CAAQ,EAEnC,IAAM,CACLhQ,GAAM,SAAS,qBAAqBA,GAAM,OAAO,EACrD,OAAO,oBAAoB,YAAa2P,CAAM,EAC9C,OAAO,oBAAoB,UAAWC,CAAI,EAC1C,OAAO,oBAAoB,YAAaC,CAAM,EAC9C,OAAO,oBAAoB,QAASruB,CAAO,EAC3C,OAAO,oBAAoB,UAAWsuB,EAAS,EAC/C,OAAO,oBAAoB,QAASC,CAAO,EAC3C,OAAO,oBAAoB,SAAUC,CAAQ,CACjD,CACJ,EAAG,EAAE,EAIL/wB,YAAU,IAAM,CACZ,MAAMgxB,EAAS5Q,IAAsBnrB,GAAYiqB,EACjD,IAAIkI,EAEJ,OAAI4J,GACAzQ,GAAwB,EAAI,EAC5B,SAAS,gBAAgB,UAAU,IAAI,mBAAmB,GAG1D6G,EAAQ,WAAW,IAAM,CACrB7G,GAAwB,EAAK,EAC7B,SAAS,gBAAgB,UAAU,OAAO,mBAAmB,CACjE,EAAG,GAAG,EAGH,IAAM,CACL6G,gBAAoBA,CAAK,CACjC,CACJ,EAAG,CAAChH,GAAoBnrB,EAAUiqB,CAAW,CAAC,EAE9C,MAAM+R,GAAmB9wB,cAAY,IAAM,CAEvC8gB,GAAY,QAAQ,QACpBtC,EAAW,QAAU,GACrBE,EAAa,QAAU,CAAE,EAAG,GAAI,EAAG,IACnCD,EAAa,QAAU,CAAE,EAAG,GAAI,EAAG,IAG/BoC,GAAoB,SAAW,CAACJ,GAAY,UAC5C9f,GAAA,EACAkgB,GAAoB,QAAU,KAEtC,EAAG,CAAClgB,EAAW,CAAC,EAGhBd,mBAAU,IAAM,CACZ,MAAMkxB,EAA2B,IAAM,CACnC7P,GAAgB,QAAU,GAE1BzC,EAAa,QAAU,CAAE,EAAG,GAAI,EAAG,IAE/BoC,GAAoB,SAAW,CAACJ,GAAY,UAC5C9f,GAAA,EACAkgB,GAAoB,QAAU,KAEtC,EAEA,cAAO,iBAAiB,OAAQiQ,EAAgB,EAChD,SAAS,iBAAiB,aAAcC,CAAwB,EAEzD,IAAM,CACT,OAAO,oBAAoB,OAAQD,EAAgB,EACnD,SAAS,oBAAoB,aAAcC,CAAwB,CACvE,CACJ,EAAG,CAACD,GAAkBnwB,EAAW,CAAC,EAGlCwvB,GAAc,QAAU/D,GACxBgE,GAAY,QAAU/D,GACtBgE,GAAc,QAAUtE,GACxBmE,GAAe,QAAUjE,GACzB+D,GAAiB,QAAU9iB,GAC3B+iB,GAAe,QAAU9D,GAGrBtuB,OAAC,OACG,IAAKygB,EACL,UAAW,4BAA4BxpB,EAAW,yBAA2B,EAAE,IAAIqrB,GAAuB,eAAiB,EAAE,IAAIiB,GAAoB,mBAAqB,EAAE,GAC5K,QAASkL,GACT,aAAc,IAAM,CAAEpL,GAAgB,QAAU,EAAM,EACtD,aAAc,IAAM,CAAEA,GAAgB,QAAU,EAAO,EAIvD,UAAApjB,MAAC,OAAI,UAAW,oBAAoBsjB,GAAoB,2BAA6B,EAAE,GAAI,EAE3FtjB,MAAC,OAAI,UAAU,0BAA0B,EACzCA,MAAC,OAAI,UAAU,uBAAuB,EAEtCA,MAAC,UACG,IAAKygB,EACL,UAAU,0BAGd1gB,OAAC,OACG,IAAKwgB,EACL,UAAU,uBAMT,UAAAv4B,GAAM,OAAOkhC,GAAKA,EAAE,SAAW,GAAK,CAACxG,GAAmBwG,CAAC,CAAC,EAAE,IAAIjhC,GAAQ,CACrE,MAAM0c,EAAY1c,EAAK,UACjBkd,EAAeld,EAAK,aACpB8S,EAAa9S,EAAK,WAElBma,EAAY6e,GAAa,KAAOh5B,EAAK,IAAOg5B,GAAa,YAAch5B,EAAK,YAAcg5B,EAAY,aAAeh5B,EAAK,WAG1HuiC,GAAgBxL,GAAmB/2B,EAAMk4B,EAAe,QAASE,EAAiB,QAASC,EAAe,QAAShgB,EAAU,EAGnI,IAAImxB,EAAkB,GAClB3uC,IAAa,gBACb2uC,EAAkBxpC,EAAK,OAAS,WACzBnF,IAAa,mBAEpB2uC,EAAkBxpC,EAAK,OAAS,UAAYA,EAAK,OAAS,SAG9D,MAAMsiC,EAAS7H,GAAmBz6B,CAAI,EAChCypC,EAAclH,IAAiBiH,GAAoBlH,GAAUnoB,EAE7D8wB,EAAiBjrC,EAAK,WAAalJ,EAAgB,WAAW,gBAAgB,IAAIkJ,EAAK,UAAU,EAAI,GAI3G,IAAIkrC,EAAY,GAChB,KAAM,CAAE,oBAAA9xC,CAAA,EAAwBtC,EAAgB,WAC5CkJ,EAAK,YAAc5G,EAAoB,IAAI4G,EAAK,UAAU,GAAK,CAACA,EAAK,GAAG,WAAW,QAAQ,IAc3FkrC,EAAY,CAZqB,MAAM,KAAK9xC,CAAmB,EAAE,KAAKxG,IAAM,CACxE,GAAIA,KAAOoN,EAAK,WAAY,MAAO,GACnC,MAAMmrC,GAAYprC,GAAM,KAAKkhC,IAAKA,GAAE,aAAeruC,EAAE,EAIrD,MAHI,CAACu4C,IAGDnrC,EAAK,OAAS,SAAiB,GAC/BA,EAAK,OAAS,SAAWmrC,GAAU,OAAS,UAC5CnrC,EAAK,OAAS,aAAemrC,GAAU,OAAS,UAAYA,GAAU,OAAS,QAEvF,CAAC,GAOL,IAAIC,EAAa,YAAYprC,EAAK,OAAO,GAMzC,OAAIA,EAAK,OAAS,WAEdorC,EAAa,YAAYprC,EAAK,OAAO,GAC9BnF,IAAa,OAASA,IAAa,kBAAoB,CAACA,EAE/DuwC,EAAa,cAAc1uB,CAAS,GAGpC0uB,EAAa,YAAYprC,EAAK,OAAO,GAIrC8X,OAAC,OAEG,IAAMid,GAAO,CACLA,GACCA,EAAW,OAAS/0B,EAAK,aACzB+0B,EAAW,aAAe/0B,EAAK,WAChC8+B,GAAS,QAAQ,IAAI9+B,EAAK,GAAI+0B,CAAE,GAEhC+J,GAAS,QAAQ,OAAO9+B,EAAK,EAAE,CAEvC,EACA,UAAW,4BAA4BA,EAAK,IAAI,IAAIorC,CAAU,cAAcprC,EAAK,QAAQ,IAAI8S,EAAa,wBAA0B,EAAE,IAAIoK,GAAgBusB,EAAa,0BAA4B,EAAE,IAAKA,EAAqC,GAAxB,qBAA0B,IAAIwB,EAAiB,kBAAoB,EAAE,IAAIC,EAAY,mBAAqB,EAAE,IAAIlrC,EAAK,YAAcs6B,GAAiB,IAAIt6B,EAAK,UAAU,EAAI,iBAAmB,EAAE,IAAIma,EAAY,8CAAgD,EAAE,GACzd,MAAO,CAEH,QAASsvB,EAAa,QAAU,OAChC,QAAStvB,EAAY,EAAI,EACzB,WAAY,UACZ,cAAe,QAEnB,aAAc,IAAM,CAEhB,GAAI,CAACyf,IAAiB,CAAC7qB,GAAY/O,EAAK,eAAiB,CAACg5B,GAAeA,EAAY,aAAeh5B,EAAK,YAAa,CAElH,IAAIua,EACJ,GAAIxL,EAAU,CACV,KAAM,CAAE,QAAAoyB,GAAS,QAAAC,EAAA,EAAYlE,GAAgBl9B,EAAK,EAAGA,EAAK,EAAGA,EAAK,CAAC,EACnEua,EAAgB,CACZ,EAAG4mB,GACH,EAAGC,EAAA,CAEX,CACApnB,GAAYha,EAAK,aAAcA,EAAK,WAAa0V,GAAc1V,EAAK,UAAU,EAAI,OAAW,OAAW+O,EAAU80B,GAAoBQ,GAAiBt1B,EAAUwL,EAAeva,EAAK,OAAS,WAAY,IAAM,CAAE,EAAG,EAAK,EAC1N86B,GAAoB,QAAU96B,EAAK,EACvC,CACJ,EACA,aAAc,IAAM,CAEX+O,IACD6L,GAAA,EACAkgB,GAAoB,QAAU,KAEtC,EACA,QAAS,IAAM2J,GAAgBzkC,CAAI,EACnC,cAAgB7K,GAAM6xC,GAAqBhnC,EAAM7K,CAAC,EAElD,UAAA4iB,MAAC,OAAI,UAAU,yBAAyB,MAAO,CAAE,cAAe,QAC3D,SAAA4O,IAAkB3mB,EAAK,MACpB8X,OAAAwY,WAAA,CACI,UAAAvY,MAAC,OACG,IAAK/X,EAAK,SAAWmX,GAAaxR,EAAgB,QAAQ3F,EAAK,IAAI,GAAG,mBAAmB,MAAQ,EAAE,EACnG,IAAKA,EAAK,GACV,UAAU,oBACV,QAAQ,OACR,UAAW,KAEdA,EAAK,cACF+X,MAAC,OACG,IAAK/X,EAAK,aACV,UAAW,0BAA0BA,EAAK,kBAAoB,iCAAmC,kCAAkC,GACnI,IAAI,GACJ,UAAW,KAGlBA,EAAK,OAAS,YAAcA,EAAK,YAAc,UAAYA,EAAK,MAAQ,MAAQA,EAAK,KAAO,GACzF+X,MAAC,OAAI,UAAU,0BACX,eAACU,GAAA,CAAU,KAAMzY,EAAK,KAAM,EAChC,EAEHA,EAAK,OAAS,MAAQA,EAAK,MAAQ,GAChC8X,OAAC,OAAI,UAAU,qBACV,UAAA9X,EAAK,eACF+X,MAAC,OAAI,IAAK/X,EAAK,cAAe,UAAU,2BAA2B,IAAI,GAAG,UAAW,GAAO,EAEhG+X,MAAC,QAAK,UAAU,2BAA4B,WAAK,MAAM,GAC3D,EAEH/X,EAAK,OAAS,WAAaA,EAAK,WAAaA,EAAK,aAC/C+X,MAAC,OAAI,UAAU,4BACV,SAAA/X,EAAK,WACF+X,MAAC,OACG,IAAKZ,GAAa,sDAAsD,EACxE,UAAU,6BACV,IAAI,WACJ,UAAW,KAEfnX,EAAK,UACL+X,MAAC,OACG,IAAKZ,GAAa,qDAAqD,EACvE,UAAU,4BACV,IAAI,UACJ,UAAW,KAEf,KACR,GAER,EAER,EACAY,MAAC,OAAI,UAAU,mBAAmB,EAClCA,MAAC,OAAI,UAAU,oBAAoB,IAlG9B/X,EAAK,GAqGtB,CAAC,EAMAg5B,GAAe,CAACj5B,GAAM,QAAUkhC,EAAE,KAAOjI,EAAY,IAAOiI,EAAE,YAAcjI,EAAY,YAAciI,EAAE,aAAejI,EAAY,UAAW,GAAK,CAACyB,GAAmBzB,CAAW,IAAM,IAAM,CAC3L,KAAM,CAAE,OAAAmF,EAAQ,OAAAC,EAAQ,MAAAF,EAAO,UAAAG,CAAA,EAAcnB,GAAgBlE,EAAY,EAAGA,EAAY,EAAGA,EAAY,CAAC,EAExG,OAAKqF,EAGDvmB,OAAC,OACG,UAAW,wEAAwEkhB,EAAY,IAAI,aAAaA,EAAY,OAAO,eAAeA,EAAY,SAAS,gBAAgBA,EAAY,aAAe,0BAA4B,EAAE,GAChP,IAAMjE,GAAO,CACLA,IACCA,EAAW,OAASiE,EAAY,aAChCjE,EAAW,aAAeiE,EAAY,WAE/C,EACA,MAAO,CACH,UAAW,eAAemF,CAAM,OAAOC,CAAM,kBAAkBF,CAAK,IACpE,OAAQ,IACR,QAAS,QACT,QAAS,EACT,cAAe,QAEnB,aAAc,IAAM,CAChB,GAAI,CAACtE,IAAiB,CAAC7qB,GAAYiqB,EAAY,aAAc,CACzD,KAAM,CAAE,QAAAmI,EAAS,QAAAC,GAAS,MAAAlD,GAAUhB,GAAgBlE,EAAY,EAAGA,EAAY,EAAGA,EAAY,CAAC,EACzFze,EAAgB,CAClB,EAAG4mB,EAAW,GAAKjD,EAAS,GAC5B,EAAGkD,EAAA,EAEPpnB,GAAYgf,EAAY,aAAcA,EAAY,WAAatjB,GAAcsjB,EAAY,UAAU,EAAI,OAAW,OAAW,GAAM6K,GAAoBQ,GAAiB,GAAM9pB,EAAeye,EAAY,OAAS,WAAY,IAAM,CAAE,EAAG,EAAK,EAC9O8B,GAAoB,QAAU9B,EAAY,EAC9C,CACJ,EACA,aAAc,IAAM,CAChBpe,GAAA,EACAkgB,GAAoB,QAAU,IAClC,EAEA,UAAAhjB,OAAC,OAAI,UAAU,yBACX,UAAAC,MAAC,OACG,IAAKihB,EAAY,SAAW7hB,GAAaxR,EAAgB,QAAQqzB,EAAY,IAAI,GAAG,mBAAmB,MAAQ,EAAE,EACjH,IAAI,UACJ,UAAU,oBACV,UAAW,KAEdA,EAAY,cACTjhB,MAAC,OACG,IAAKihB,EAAY,aACjB,UAAW,0BAA0BA,EAAY,kBAAoB,iCAAmC,kCAAkC,GAC1I,IAAI,GACJ,UAAW,KAGlBA,EAAY,OAAS,YAAcA,EAAY,YAAc,UAAYA,EAAY,MAAQ,MAAQA,EAAY,KAAO,GACrHjhB,MAAC,OAAI,UAAU,0BACX,eAACU,GAAA,CAAU,KAAMugB,EAAY,KAAM,EACvC,EAEHA,EAAY,OAAS,MAAQA,EAAY,MAAQ,GAC9ClhB,OAAC,OAAI,UAAU,qBACV,UAAAkhB,EAAY,eACTjhB,MAAC,OAAI,IAAKihB,EAAY,cAAe,UAAU,2BAA2B,IAAI,GAAG,UAAW,GAAO,EAEvGjhB,MAAC,QAAK,UAAU,2BAA4B,WAAY,MAAM,GAClE,EAEHihB,EAAY,OAAS,WAAaA,EAAY,WAAaA,EAAY,aACpEjhB,MAAC,OAAI,UAAU,4BACV,SAAAihB,EAAY,WACTjhB,MAAC,OACG,IAAKZ,GAAa,sDAAsD,EACxE,UAAU,6BACV,IAAI,WACJ,UAAW,KAEf6hB,EAAY,UACZjhB,MAAC,OACG,IAAKZ,GAAa,qDAAqD,EACvE,UAAU,4BACV,IAAI,UACJ,UAAW,KAEf,KACR,GAER,EACAY,MAAC,OAAI,UAAU,mBAAmB,EAClCA,MAAC,OAAI,UAAU,oBAAoB,KAnFpB,IAsF3B,IAAG,IAON6hB,IACG7hB,MAAC,OAAI,UAAU,2BACV,SAAAhY,GAAM,OAAOkhC,GAAKxG,GAAmBwG,CAAC,CAAC,EAAE,IAAIjhC,GAAQ,CAClD,MAAM0c,EAAY1c,EAAK,UACjBkd,EAAeld,EAAK,aACpB8S,EAAa9S,EAAK,WAElB,CAAE,gBAAAxI,EAAiB,oBAAA4B,IAAwBtC,EAAgB,WAC3Dm0C,EAAiBjrC,EAAK,WAAaxI,EAAgB,IAAIwI,EAAK,UAAU,EAAI,GAC1EkrC,EAAYlrC,EAAK,WAAa5G,GAAoB,IAAI4G,EAAK,UAAU,EAAI,GAG/E,IAAIqrC,EAAc,EACdC,EAAc,QAClB,MAAM9a,EAAc4J,GACdjgB,EAAY6e,IAAgBA,EAAY,aAAeh5B,EAAK,YAAcg5B,EAAY,KAAOh5B,EAAK,IAExG,GAAIma,EACAkxB,EAAc,UACPnR,GAAoB,CAC3B,MAAM2I,EAAiB7iC,EAAK,aAAek6B,GAAmB,gBACxD4I,EAAkB9iC,EAAK,aAAek6B,GAAmB,iBAE3D2I,GAAkBC,EAClBuI,EAAc,GAIdC,EAAc,OACdD,EAAc,EAEtB,MAAW7a,IAEP6a,EAAc,IACVrrC,EAAK,OAAS,aAAYsrC,EAAc,SAGhD,OACIxzB,OAAC,OAEG,IAAMid,GAAO,CACLA,GACCA,EAAW,OAAS/0B,EAAK,aACzB+0B,EAAW,aAAe/0B,EAAK,WAChC8+B,GAAS,QAAQ,IAAI9+B,EAAK,GAAI+0B,CAAE,GAEhC+J,GAAS,QAAQ,OAAO9+B,EAAK,EAAE,CAEvC,EACA,UAAW,sCAAsCA,EAAK,IAAI,aAAaA,EAAK,OAAO,eAAe0c,CAAS,gBAAgB5J,EAAa,wBAA0B,EAAE,IAAIoK,EAAe,0BAA4B,EAAE,IAAI+tB,EAAiB,kBAAoB,EAAE,IAAIC,EAAY,mBAAqB,EAAE,IAAIlrC,EAAK,YAAcs6B,GAAiB,IAAIt6B,EAAK,UAAU,EAAI,iBAAmB,EAAE,IAAIma,EAAY,8CAAgD,EAAE,GAC7b,MAAO,CACH,QAASmxB,EACT,QAASD,EACT,cAAe,OACf,OAASJ,GAAkBC,GAAclrC,EAAK,YAAcs6B,GAAiB,IAAIt6B,EAAK,UAAU,EAAM,IAAU,QAEpH,QAAS,IAAMykC,GAAgBzkC,CAAI,EACnC,aAAc,IAAM,CAChBi6B,GAAwBj6B,EAAK,YAAcA,EAAK,EAAE,CACtD,EACA,aAAc,IAAM,CAChBi6B,GAAwB,IAAI,CAChC,EACA,cAAgB9kC,GAAM6xC,GAAqBhnC,EAAM7K,CAAC,EAElD,UAAA4iB,MAAC,OAAI,UAAU,yBACV,SAAA4O,IAAkB3mB,EAAK,MACpB8X,OAAAwY,WAAA,CACI,UAAAvY,MAAC,OACG,IAAK/X,EAAK,SAAWmX,GAAaxR,EAAgB,QAAQ3F,EAAK,IAAI,GAAG,mBAAmB,MAAQ,EAAE,EACnG,IAAKA,EAAK,GACV,UAAU,sBAEbA,EAAK,cACF+X,MAAC,OACG,IAAK/X,EAAK,aACV,UAAW,0BAA0BA,EAAK,kBAAoB,iCAAmC,kCAAkC,GACnI,IAAI,IACR,EAER,EAER,EACA+X,MAAC,OAAI,UAAU,mBAAmB,EAClCA,MAAC,OAAI,UAAU,oBAAoB,IA7C9B,OAAO/X,EAAK,EAAE,GAgD/B,CAAC,EAEL,EAIH45B,IAAiBN,GAAmB,OAAS,SACzC,OAAI,MAAO,CAAE,SAAU,WAAY,IAAK,EAAG,KAAM,EAAG,MAAO,OAAQ,OAAQ,OAAQ,OAAQ,WAAY,cAAe,QACnH,SAAAvhB,MAAC8Q,GAAA,CACG,YAAayQ,GACb,eAAgBE,GAChB,aAAcE,GACd,gBAAAzQ,GACA,cAAAvT,GACA,kBAAmB4xB,GACnB,YAAaE,GACb,WAAY9D,GACZ,QAASH,GACT,UAAWzJ,GACX,cAAeE,GACf,uBAAwB,CAACuR,EAAQ7lB,IAAY,CACzC4V,GAAqBiQ,CAAM,EAC3BpiB,IAAyBoiB,EAAQ7lB,CAAO,CAC5C,EACA,eAAgBwhB,GAChB,kBAAAvd,CAAA,GAER,EAGJ5R,MAAC,OACG,UAAU,oBACV,MAAO,CACH,QAAS+jB,GAAe,EAAI,EAC5B,cAAeA,GAAe,OAAS,OACvC,WAAY,yBAGhB,SAAAhkB,OAAC,OAAI,UAAU,wBACV,UAAA2mB,UACI,OAAI,UAAU,uBACX,SAAA3mB,OAAC,QAAK,UAAU,YAAa,UAAAohB,GAAI,QAAI,EACzC,EAEJphB,OAAC,OAAI,UAAU,iCACX,UAAAC,MAAC,MAAG,UAAU,uBAAuB,0BAAc,EACnDD,OAAC,UACG,UAAW,6BAA6Bvf,GAAY,aAAe,EAAE,IAAImmC,GAAU,WAAa,EAAE,GAClG,QAAUvpC,GAAM,CACZA,EAAE,kBACFgW,GAAc,YAAY,EAAI,CAClC,EACA,MAAOuzB,GAAU,+CAAiD,sBAClE,aAAW,SAEX,UAAA3mB,MAAC,OAAI,QAAQ,YAAY,KAAK,OAAO,OAAO,eAAe,YAAY,IAAI,cAAc,QAAQ,eAAe,QAC5G,eAAC,QAAK,EAAE,8EAA8E,EAC1F,EACC2mB,IACG3mB,MAAC,OAAI,UAAU,+BACX,SAAAD,OAAC,OAAI,QAAQ,YAAY,KAAK,OAAO,OAAO,UAAU,YAAY,IAAI,cAAc,QAAQ,eAAe,QACvG,UAAAC,MAAC,QAAK,EAAE,2FAA2F,EACnGA,MAAC,QAAK,GAAG,KAAK,GAAG,IAAI,GAAG,KAAK,GAAG,KAAK,EACrCA,MAAC,QAAK,GAAG,KAAK,GAAG,KAAK,GAAG,QAAQ,GAAG,KAAK,GAC7C,EACJ,IAER,EACJ,GACJ,GACJ,GAGZ","names":["createStoreImpl","createState","state","listeners","setState","partial","replace","nextState","previousState","listener","getState","api","initialState","createStore","identity","arg","useStore","selector","slice","React","createImpl","useBoundStore","create","getTimestamp","debugLog","tag","args","infoLog","warnLog","errorLog","successLog","logGroup","title","logGroupEnd","logTable","data","createLogger","promisifyRequest","request","resolve","reject","dbName","storeName","dbp","getDB","db","txMode","callback","defaultGetStoreFunc","defaultGetStore","get","key","customStore","store","set","value","ElementType","Expansion","GuardianClass","ItemSlot","Difficulty","BUNGIE_CONFIG","membershipId","membershipType","characterId","components","BUCKET_HASHES","DAMAGE_TYPE_HASHES","STAT_HASHES","SOCKET_CATEGORY_HASHES","ENCRYPTION_ALGORITHM","KEY_LENGTH","IV_LENGTH","SALT_LENGTH","ITERATIONS","TokenEncryptionService","keyMaterial","salt","error","plaintext","iv","ciphertext","encrypted","decrypted","entropy","combined","SALT_KEY","stored","buffer","bytes","binary","i","base64","tokenEncryption","DB_NAME","DB_VERSION","STORES","IndexedDBService","storeNames","event","oldVersion","newVersion","objectStore","index","transaction","indexName","tableName","version","result","accessTokenData","refreshTokenData","accessToken","refreshToken","tokens","encryptedAccessToken","encryptedRefreshToken","build","id","ttlMs","estimate","err","PlatformErrorCodes","AUTH_ERROR_CODES","THROTTLE_ERROR_CODES","RateLimitQueue","endpoint","requestFn","wrappedFn","sentinel","now","endpointKey","k","endpointLastTime","globalWait","endpointWait","waitTime","r","requestTime","nextPromise","BungieApiClient","requiresAuth","headers","newTokens","config","method","body","skipRetry","retryCount","effectiveSkipRetry","url","slowApiTimeout","useToastStore","response","isStateChanging","delay","retryAfter","e","apiError","BungieApiError","isMaintenance","useAuthStore","priority","verified","params","code","errorData","desc","currentTokens","newRefreshToken","handler","_data","message","errorCode","errorStatus","httpStatus","userMessage","bungieApi","auth","loading","membership","hardReset","__vitePreload","indexeddb_service","useProfileStore","SetInventoriesResult","saved","characters","currentId","c","firstId","synergies","incomingTimestamp","currentTimestamp","activeTransfers","inFlightTargets","mergeAndClear","incomingItems","storeId","currentLocalItems","finalItems","item","instanceId","targetId","localItem","finalCharInventories","charId","finalCharEquipment","finalVault","isLoading","isEquipping","updates","socketIndex","plugHash","plugName","plugIcon","instance","newSockets","sIdx","s","success","failure","successfulTransfers","failedTransfers","successful","failed","loadout","updated","cached","idbGet","useUIStore","tab","open","view","subView","hide","effect","introComplete","selectedSubclass","useManifestStore","isLoaded","loadingProgress","useSettingsStore","exp","performanceMode","maxSynergies","organizedGalaxy","viewMode","deviceMode","imageSize","ownedExpansions","toast","newToast","t","useSavedBuildsStore","builds","next","idbSet","b","useGeneratorStore","isSpinning","currentBuild","slot","CLARITY_BASE","CLARITY_DESCRIPTIONS_URL","CLARITY_VERSION_URL","ClarityService","liveVersion","cachedVersion","hash","clarityService","SEASON_MAP","getSeasonNameFromWatermark","watermarkPath","name","isLegacyVersion","log","EXTENDED_BREAKER_MAP","getBreakerEnum","REQUIRED_TABLES","CLASS_ABILITY_TO_DAMAGE_MAP","DAMAGE_HASH_TO_ENUM","ManifestService","manifestInfo","currentVersion","needsUpdate","availableTables","onProgress","componentPaths","completedTables","totalTables","tablePromises","_index","path","cacheBusters","lastError","buster","progress","_tableName","table","tableUrl","items","plugCategoryMap","lowerName","lowerType","plugCatId","categoryLabel","label","typeDisplay","classType","damageType","forced","results","damageTypes","categories","category","hashes","signedHash","perks","perkId","perk","signedPerk","record","records","query","exact","target","bestMatch","hasIcon","nodes","node","searchTerm","lowerSearch","description","a","iconPath","activities","activity","sets","setDef","buckets","bucket","stats","stat","modifiers","modifier","breakerType","CHAMP_ICONS","targetEnum","breakers","byHash","breaker","championType","breakerMap","rank","ranks","constants","rankDef","rankConstants","plate","backgrounds","className","classes","damageTypeMap","def","comms","limit","normalize","str","normalizedQuery","statsEn","rawItem","statDef","perkName","socket","plugItem","p","perkDef","activityDef","modifierDef","raw","forcedDamageType","itemType","tierType","cacheKey","options","cleanStr","cleanQuery","itemName","cleanName","score","dist","matrix","j","rest","enumValue","types","type","cls","plugSets","plugSet","itemDef","self","weaponHash","rawDef","pool","traitIndices","entry","plugSetHash","aspectHash","names","colors","icons","getFirstHash","nameHash","colorHash","iconHash","hashUnsigned","hashSigned","foundKey","fullDef","manifestService","ModService","mods","equippedArmor","armorWithSockets","profileService","assignments","aw","transferService","subclass","latestSubclass","currentSockets","overrides","FRAGMENT_SLOTS_STAT_HASH","getFragmentCapacity","aspectHashes","capacity","h","getDefaultAbilityHash","findIndices","categoryHashes","cat","handleShuffledSockets","socketIndices","desiredHashes","neededHashes","excessSockets","idx","currentHash","matchIdx","excess","defaultHash","abilityIndices","ability","targetHash","targetIndex","socketType","plugDef","w","aspectIndices","fragmentIndices","aspectsToUse","fragmentsToApply","sortedIndices","modHash","itemHash","modDef","socketTypeHash","modPlugCategory","unassigned","sortedItems","capacityA","cost","bestItemIdx","bestSocketIdx","armorItem","sockets","energyLeft","armorModSocketIdx","additionalModHashes","currentUsed","additionalCost","acc","element","difficulty","surgeHash","modService","_queue","queueAction","fn","headPromise","runPromise","wrappedPromise","EQUIP_BUCKETS","BUCKET_CAPACITIES","VAULT_TOTAL_CAPACITY","oldToNewItems","createMoveSession","involvedItemIds","maxRetries","ultimateTargetChar","TransferService","itemInstanceId","toVault","stackSize","session","addActiveTransfer","addToast","profileLoader","sourceId","hasDuplicates","overrideLockState","wasLocked","bucketHash","lockCharId","latestState","latestItem","actualLocation","targetLocation","isNoRoom","character","conflict","exclude","replacement","src","res","equipRes","currentInstance","loadoutIndex","identifiers","candidates","_options","itemInstanceIds","retryDepth","targetEquipment","filteredIds","eq","failedIds","restricted","latestEquipment","template","transferOnly","all","missing","getLoadoutItem","loadoutItemHash","_name","held","firstInRange","findOrTrack","exoticW","exoticA","targetItems","subclassConfig","itemsToMove","ti","replacements","moveFailures","equipRestricted","ids","itemsToDequip","fid","failureNames","f","hasMajorFailures","msg","toastType","equip","isLocked","lockResetState","sourceIsVault","targetIsVault","itemIsExotic","vaultStore","toVaultRes","targetChar","targetStore","toTargetRes","isNowEquipped","amount","currentEq","otherExotic","anyCharId","effectiveCharId","excludes","numRetries","depth","classNames","stores","storeReservations","movesNeeded","left","m","moveAsideSourceEntries","_","amt","moveAsideSourceId","sourceStore","context","choice","displacingItem","_context","buildItemIds","inBuildA","inBuildB","isEqA","isEqB","tierA","tierB","pA","pB","reservations","generalUsage","native","usage","isVault","inv","filtered","isGeneral","itemsToEquip","conflicts","tDef","eDef","reps","currentEquipment","checkConflict","targetExotic","targetDef","rep","exclusions","excludeExotic","isEquipped","invA","invB","srcA","srcB","excludeInstanceIds","elLower","damageTypeHash","itemId","char","latestInstance","latestSocket","isStopError","itemClass","characterClass","bucketMemoCache","memoizedItemsByBucket","byBucket","ProfileService","characterInventories","characterEquipment","vaultInventory","newVault","newCI","newCE","findAndRemove","list","curEq","slotIdx","old","cIdx","oldEx","change","itemData","newInstances","inst","existingSockets","updateInList","found","profile","chars","resp","primary","mem","itemInstances","d","sd","firstCharId","commendationScore","commendationNodeScores","commendationNodePercentages","scoreDetails","commendationsReceived","commendationsSent","icon","charInventory","source","movableItems","vaultRes","moved","ProfileLoader","force","currentGuardianRank","lifetimeScore","updatedStore","ghostFarming","intervalMs","visibilityHandler","soft","getBungieUrl","commonIdx","SyncManagerService","timeSinceLastRefresh","full","authStore","formatted","syncManager","ToastContainer","toasts","removeToast","jsxs","jsx","getIcon","useToast","getEquippedItem","equipment","getSubclassElement","getElement","calculateCharacterStats","armorBuckets","getTierClass","TierBadge","tier","count","TooltipContext","createContext","TooltipProvider","children","tooltip","setTooltip","useState","position","setPosition","visible","setVisible","tooltipRef","useRef","hideTimeoutRef","rafRef","lastPositionRef","isFocusedRef","isHudRef","useEffect","handleMouseMove","showTooltip","useCallback","overrideElement","isFocused","onTransfer","onEquip","isHud","fixedPosition","hideStats","onRightClick","hideSynergizeAction","prev","hideTooltip","openTransferMenu","pos","width","height","x","y","minTopMargin","paddingX","paddingY","computedStyle","createPortal","RichTooltip","useTooltip","useContext","EXOTIC_WEAPONS","EXOTIC_ARMOR_TITAN","EXOTIC_ARMOR_HUNTER","EXOTIC_ARMOR_WARLOCK","SUBCLASS_HASHES","WEAPON_PERKS","PRISMATIC_ASPECT_MAPPING","std","prism","RichItemIcon","onClick","onMouseEnter","onMouseLeave","useMemo","iconUrl","tierClass","secondarySpecialUrl","secondaryIconUrl","secondaryOverlayUrl","standardWatermark","featuredWatermark","isLegacyWatermark","watermarkUrl","isMasterwork","isCrafted","isEnhanced","isWeapon","BUCKET_TO_SLOT","classifyMod","plugCat","typeName","categorizeMods","modHashes","mainStat","secondaryStat","others","nameA","nameB","distributeLoadoutMods","armor","armorCosmetics","modGroups","themedMods","goalCounts","currentCounts","slotOccupancy","trackMod","isShader","isOrnament","isGameplayMod","cosmetic","theme","isModBalanced","pendingBalanceMods","idxStr","bucketStr","armorSlots","bestSlot","minMods","slotName","goal","current","remaining","targetSlot","lastRawResponse","getLastDebugRaw","DIM_EMPTY_SOCKET_HASH","parseModsArrayToModsByBucket","modsArray","modsByBucket","bucketGroups","currentGroup","foundSeparator","parseLoadoutLink","loadoutParamMatch","encodedJson","json","parsedMods","existing","dimApiMatch","shareId","proxyUrl","errorText","responseText","match","binaryString","decoded","pako","trimmed","nullIdx","paramMarkerIdx","equipped","itemStr","parts","socketOverrides","plugStr","parameters","paramSection","paramsMap","seg","val","group","parsed","nullIndex","paramsData","socketArray","generateExoEngineLink","shortName","bucketStrings","bucketId","modIds","compressed","generateDIMCompatibleLink","cleanLoadout","convertToBuildTemplate","subclassItem","derivedElement","subDef","exoticWeapon","exoticArmor","getSocketCategory","indexStr","catHash","convertBuildToLoadoutShareData","SUBCLASS_ITEM_HASHES","elementKey","subclassLookupKey","subclassHash","subclassOverrides","superIndices","abilityHash","socketEntry","generateLoadoutLink","jsonString","compressedStream","compressedBlob","compressedData","generateDIMLink","loadoutLinkService","importDIMJson","loadouts","ABILITY_HASH_CACHE","findItemHashByName","searchName","allHashes","inventory","getStaticAbilityHash","clsKey","eleKey","normalizeKey","prismaBranch","obj","root","branch","findAbilityHashByName","searchType","nameLower","matches","SynergyBuildOverlay","synergy","onClose","showError","screenshot","setScreenshot","isLoreOpen","setIsLoreOpen","hoveredHash","setHoveredHash","hoveredItemHash","setHoveredItemHash","mousePos","setMousePos","clientX","clientY","innerWidth","innerHeight","manifestLoaded","buildData","setBuildData","convertSynergyToBuildTemplate","handleShareExo","shareData","link","handleShareDIM","handleKeyDown","v","handleRightClick","loadBuildData","armorHash","weaponDef","armorDef","superHash","grenadeHash","meleeHash","classAbilityHash","jumpHash","transHash","aspectName","fragmentName","fragmentHash","renderCompactMods","slotMods","ornament","shader","renderCosmeticPod","renderModPod","handleIconHover","aspect","fragment","ELEMENT_COLORS","SynergyWeb","connections","sourcePosition","sourceNodeId","getItemPosition","onEquipSynergy","onSynergyOverlayChange","onWireClick","onWireHoverChange","onWireHover","onWireLock","isExiting","syncedWirePositions","hoveredNodeId","forceCloseTrigger","hoveredWireId","setHoveredWireId","lockedWireId","setLockedWireId","wires","setWires","animationProgress","setAnimationProgress","exitProgress","setExitProgress","confirmedSynergy","setConfirmedSynergy","handleCloseOverlay","svgRef","hoveredWireRef","lockedWireIdRef","syncedWirePositionsRef","wireHoverTimerRef","wireShowTimerRef","hoveredWire","lockedWire","lastHoveredRef","wire","wireId","startTime","duration","animate","elapsed","raf","lastPositionsJsonRef","updateWires","syncedPositions","newWires","currentSourceX","currentSourceY","currentSourceScale","liveSource","hubCache","isSourceSubclass","sourceElement","posIdx","conn","hub","isSourceHub","shouldUseHub","finalHubX","finalHubY","syncedPos","armorRes","weaponRes","processResult","isHovered","abilities","abilityRes","newPositionsJson","getWirePath","sourceX","sourceY","targetX","targetY","targetScale","dx","dy","curveComplexity","offset","cp1x","cp1y","cp2x","cp2y","endX","endY","handleWireMouseEnter","handleWireMouseLeave","handleTooltipMouseLeave","handleTooltipMouseEnter","activeWire","handleEndNodeClick","handleBackgroundClick","handleConfirmBuild","renderSynergyTooltip","tooltipId","handleWireClick","wiresByElement","displayedWire","elementalWires","gradId","hasHub","sx","sy","tx","ty","wireColor","stopColor","firstWire","sourceScale","hubX","hubY","hubScale","hubOpacity","wireProgress","anyWireHovered","segmentSourceX","segmentSourceY","segmentSourceScale","opacity","wirePath","Fragment","baseWidth","isIsolating","isThisWireActive","baseOpacity","tooltipStyle","posX","posY","tooltipHeight","nameToHashCache","normalizeForMatching","text","findHashByName","allItems","word","findItemByHash","selectedCharacterId","foundEq","foundInv","vaultItem","findItemByName","findAllItemsByName","findAllExoticsForClass","guardianClass","bucketChoice","processItem","location","expectedType","hasItem","clearItemSearchCache","findAllItemsByNameSync","itemSearchService","SYNERGY_DEFINITIONS","FALLBACK_DEFAULTS","COMBO_PAIRS","STRICT_ARMOR_ELEMENTS","KEYWORD_MAP","SPECIAL_CASES","getNaturalAffinity","affinities","detected","keyword","capitalize","shuffleArray","array","seed","random","loadSynergiesForClass","findSynergies","targetType","targetIdentifier","maxResults","minScore","combinedSeed","searchTerms","term","armorSearch","weaponSearch","shuffledResults","groups","sortedScores","shuffledGroup","processedExotics","armorResult","weaponResult","isBroadSearch","allExoticArmor","allExoticWeapons","armorName","armorInstanceId","affinity","targetElements","strictElements","el","preferredWeapons","pw","armorDesc","verbMatches","weaponDesc","verb","targetWeaponName","weaponDescription","comboMatch","armorElement","weaponMatch","isKineticSlot","isKineticDamage","armorDamageType","weaponDamageType","armorDescription","targetDamage","selectedWeaponItems","uniqueByHash","uniqueCandidates","shuffledCandidates","selectedWeaponItem","connectionId","buildTemplate","isPrismatic","adHocSynergy","isAPrismatic","isBPrismatic","WEAPON_BUCKETS","ARMOR_BUCKETS","DAMAGE_TYPE_NAMES","itemMatchesFilters","searchQuery","elementFilter","classFilter","getElementFn","targetClassType","terms","itemDescription","itemTier","itemElement","isTag","actualTerm","SynergyGalaxy","searchQueryProp","isVaultSearchVisible","onSynergyElementChange","synergyFilter","onResetView","resetViewRef","searchQueryRef","viewModeRef","elementFilterRef","classFilterRef","galaxyRef","containerRef","canvasRef","isDragging","lastMousePos","dragStartPos","isDraggingDisabled","isParallaxDisabled","isMiddleButtonDown","setIsLocked","focusedNode","setFocusedNode","fps","setFps","renderTrigger","setRenderTrigger","synergyConnections","setSynergyConnections","synergySourcePos","setSynergySourcePos","synergySourceNodeId","setSynergySourceNodeId","isSynergyMode","setIsSynergyMode","isSynergyExiting","setIsSynergyExiting","hoveredSynergyNodeId","setHoveredSynergyNodeId","hoveredSynergyWire","setHoveredSynergyWire","isIsolatingDebounced","setIsIsolatingDebounced","equippingItemIds","setEquippingItemIds","synchronizedNodeIds","isNodeSynchronized","isLockedRef","containerRect","canvasSize","rafId","activeTooltipNodeId","keysPressed","tickRef","updateTooltipDetectionRef","isWireHoveringRef","isMouseInBounds","isMovingRef","isSynergyMenuOpen","setIsSynergyMenuOpen","lastFpsUpdateTime","frameCount","immersiveMode","driftOffset","driftPhase","tooltipHideTimerRef","tooltipShowTimerRef","hideGlobalUI","setHideGlobalUI","isSynergyModeRef","synergyConnectionsRef","synergySourceNodeIdRef","isVaultSearchVisibleRef","hideGlobalUIRef","hoveredSynergyWireRef","isIsolatingDebouncedRef","lastTooltipStateRef","lastNotifiedElementRef","safeNotifyElementChange","targetOffset","targetTilt","targetParallax","parallaxOffset","projectionSnapshotRef","transitionRef","startTransition","targetZ","projectToScreen","z","snap","rx","ry","cosX","sinX","cosY","sinY","tx1","tz1","ty2","tz2","finalX","finalY","finalZ","scale","stageX","stageY","isVisible","effectiveScale","responseMintedTimestamp","randomVaultSeed","showFps","isStale","mintedDate","synergyFilterTriggered","projectedVaultRef","nodeRefs","COLUMN_X","COLUMN_Y_GAP","seedRandom","vaultPoints","generatedNodes","currentCharacterId","equippedSubclass","inventorySubclasses","sc","zPos","xOffset","yOffset","isArmor","itemInstance","damageTypeName","bIdx","baseX","depthMin","depthMax","zBias","xScatter","yScatter","zScatter","actualVaultGear","vaultPointsArray","slotIndex","depthRange","isExotic","color","filteredNodeIds","filteredVaultPoints","pt","weaponName","equippedSubclassNode","n","timer","screenX","screenY","filteredNodeIdsRef","filteredVaultPointsRef","inventoryHashes","vaultPointsRef","drawCanvas","tiltX","tiltY","timestamp","canvas","ctx","centerX","centerY","focalLength","offX","offY","offZ","nextProjectedVault","isSync","matchesSearch","farClip","px","py","size","alpha","isHoveredArmor","isHoveredWeapon","pulse","shouldGlow","updateTransform","tX","tY","handleResetView","isAtOrbit","isAtDefaultPosition","handleCloseSynergyWeb","flushSync","lastProcessedTrigger","handleSynergyWireLock","focusNode","focusedNodeRef","handleTransferItem","targetCharacterId","nodeToTransfer","isInVault","currentCharId","transferPromise","res1","res2","handleEquipItem","nodeToEquip","sourceCharacterId","equipSuccess","handleNodeClick","nodeInstanceId","updateTooltipDetection","mx","my","closestNode","foundNode","foundVaultStar","hoveredElement","hoveredNodeEl","nodeId","rect","relX","relY","projection","distance","hitRadius","minVaultDist","isFocusedDisplay","isFocusedNode","posChanged","nodeChanged","star","handleMove","rotationSensitivity","handleClick","targetEl","handleKeyUp","handleDown","handleUp","handleWheel","zoomSpeed","delta","minZ","_location","_characterId","subclassMatch","targetElement","foundVaultPt","handleTriggerSynergy","elementName","handleEquipSynergy","targets","findNodeByName","weapon","handleWireHoverChange","hovered","handleWireHover","updateRect","dpr","moveSpeed","activeEl","driftX","driftY","normalizedX","normalizedY","parallaxStrength","parallaxTiltX","parallaxTiltY","top","distLeft","distRight","distTop","distBottom","getIntensity","normalized","start","ease","newX","newY","newZ","dz","isMoving","isMouseInHeader","mouseY","isZoomedIn","isFarPan","shouldHide","effectiveZ","matchesViewMode","shouldShow","isNodeVisible","isInteracting","fadeStart","fadeRange","isPartOfActiveSynergy","halfW","halfH","handleKeyDownRef","handleKeyUpRef","handleClickRef","handleDownRef","handleUpRef","handleMoveRef","renderLoop","onDown","onUp","onMove","onKeyDown","onKeyUp","onResize","active","handleWindowBlur","handleDocumentMouseLeave","isTransferring","isSuccess","otherNode","colorClass","nodeOpacity","nodeDisplay","isOpen"],"ignoreList":[0,1,3],"sources":["../../../../node_modules/zustand/esm/vanilla.mjs","../../../../node_modules/zustand/esm/react.mjs","../../../../src/utils/logger.ts","../../../../node_modules/idb-keyval/dist/index.js","../../../../src/types/index.ts","../../../../src/config/bungie.config.ts","../../../../src/services/crypto/token-encryption.service.ts","../../../../src/services/db/indexeddb.service.ts","../../../../src/services/bungie/api-client.ts","../../../../src/store/index.ts","../../../../src/services/bungie/clarity.service.ts","../../../../src/utils/season-utils.ts","../../../../src/services/bungie/manifest.service.ts","../../../../src/services/bungie/mod.service.ts","../../../../src/utils/action-queue.ts","../../../../src/services/bungie/transfer.service.ts","../../../../src/services/bungie/profile.service.ts","../../../../src/utils/url-helper.ts","../../../../src/services/bungie/sync-manager.service.ts","../../../../src/components/common/Toast.tsx","../../../../src/utils/character-helpers.ts","../../../../src/components/builder/TierBadge.tsx","../../../../src/components/builder/TooltipManager.tsx","../../../../src/constants/item-hashes.ts","../../../../src/components/common/RichItemIcon.tsx","../../../../src/utils/loadout-mods.utils.ts","../../../../src/services/bungie/loadout-link.service.ts","../../../../src/components/synergy/SynergyBuildOverlay.tsx","../../../../src/components/builder/SynergyWeb.tsx","../../../../src/services/item-search.service.ts","../../../../src/constants/synergy-definitions.ts","../../../../src/services/synergy-matcher.service.ts","../../../../src/components/synergy/SynergyGalaxy.tsx"],"sourcesContent":["const createStoreImpl = (createState) => {\n  let state;\n  const listeners = /* @__PURE__ */ new Set();\n  const setState = (partial, replace) => {\n    const nextState = typeof partial === \"function\" ? partial(state) : partial;\n    if (!Object.is(nextState, state)) {\n      const previousState = state;\n      state = (replace != null ? replace : typeof nextState !== \"object\" || nextState === null) ? nextState : Object.assign({}, state, nextState);\n      listeners.forEach((listener) => listener(state, previousState));\n    }\n  };\n  const getState = () => state;\n  const getInitialState = () => initialState;\n  const subscribe = (listener) => {\n    listeners.add(listener);\n    return () => listeners.delete(listener);\n  };\n  const api = { setState, getState, getInitialState, subscribe };\n  const initialState = state = createState(setState, getState, api);\n  return api;\n};\nconst createStore = ((createState) => createState ? createStoreImpl(createState) : createStoreImpl);\n\nexport { createStore };\n","import React from 'react';\nimport { createStore } from 'zustand/vanilla';\n\nconst identity = (arg) => arg;\nfunction useStore(api, selector = identity) {\n  const slice = React.useSyncExternalStore(\n    api.subscribe,\n    React.useCallback(() => selector(api.getState()), [api, selector]),\n    React.useCallback(() => selector(api.getInitialState()), [api, selector])\n  );\n  React.useDebugValue(slice);\n  return slice;\n}\nconst createImpl = (createState) => {\n  const api = createStore(createState);\n  const useBoundStore = (selector) => useStore(api, selector);\n  Object.assign(useBoundStore, api);\n  return useBoundStore;\n};\nconst create = ((createState) => createState ? createImpl(createState) : createImpl);\n\nexport { create, useStore };\n","/**\n * Logger Utility - Maximum visibility for production troubleshooting\n */\n\nconst IS_PRODUCTION = import.meta.env.PROD;\n\n/** Format timestamp */\nfunction getTimestamp(): string {\n    return new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });\n}\n\n/** Debug logs - Only in dev or if explicitly enabled */\nexport function debugLog(tag: string, ...args: unknown[]): void {\n    if (IS_PRODUCTION && localStorage.getItem('_dbg') !== '1') return;\n    console.log(`[DEBUG][${tag}][${getTimestamp()}]`, ...args);\n}\n\n/** Info logs - ALWAYS TRANSPARENT */\nexport function infoLog(tag: string, ...args: unknown[]): void {\n    console.log(`[INFO][${tag}][${getTimestamp()}]`, ...args);\n}\n\n/** Warning logs - ALWAYS TRANSPARENT */\nexport function warnLog(tag: string, ...args: unknown[]): void {\n    console.warn(`[WARN][${tag}][${getTimestamp()}]`, ...args);\n}\n\n/** Error logs - ALWAYS TRANSPARENT */\nexport function errorLog(tag: string, ...args: unknown[]): void {\n    console.error(`[ERROR][${tag}][${getTimestamp()}]`, ...args);\n}\n\n/** Success logs - ALWAYS TRANSPARENT */\nexport function successLog(tag: string, ...args: unknown[]): void {\n    console.log(`[SUCCESS][${tag}][${getTimestamp()}]`, ...args);\n}\n\nexport function logGroup(title: string): void {\n    console.group(`[GROUP] ${title}`);\n}\n\nexport function logGroupEnd(): void {\n    console.groupEnd();\n}\n\nexport function logTable(tag: string, data: unknown): void {\n    console.log(`[TABLE][${tag}]`);\n    console.table(data);\n}\n\nexport function createLogger(tag: string) {\n    return {\n        debug: (...args: unknown[]) => debugLog(tag, ...args),\n        info: (...args: unknown[]) => infoLog(tag, ...args),\n        warn: (...args: unknown[]) => warnLog(tag, ...args),\n        error: (...args: unknown[]) => errorLog(tag, ...args),\n        success: (...args: unknown[]) => successLog(tag, ...args),\n        table: (data: unknown) => logTable(tag, data),\n        group: (title: string) => logGroup(`[${tag}] ${title}`),\n        groupEnd: () => logGroupEnd(),\n    };\n}\n\nexport function startTimer(label: string): () => number {\n    const start = performance.now();\n    return () => {\n        const duration = performance.now() - start;\n        debugLog('Timer', `${label}: ${duration.toFixed(2)}ms`);\n        return duration;\n    };\n}\n\nexport function timeOperation<T>(label: string, operation: () => T | Promise<T>): T | Promise<T> {\n    const timer = startTimer(label);\n    try {\n        const result = operation();\n        if (result instanceof Promise) {\n            return result.finally(() => timer()) as T;\n        }\n        timer();\n        return result;\n    } catch (error) {\n        timer();\n        throw error;\n    }\n}\n","function promisifyRequest(request) {\n    return new Promise((resolve, reject) => {\n        // @ts-ignore - file size hacks\n        request.oncomplete = request.onsuccess = () => resolve(request.result);\n        // @ts-ignore - file size hacks\n        request.onabort = request.onerror = () => reject(request.error);\n    });\n}\nfunction createStore(dbName, storeName) {\n    let dbp;\n    const getDB = () => {\n        if (dbp)\n            return dbp;\n        const request = indexedDB.open(dbName);\n        request.onupgradeneeded = () => request.result.createObjectStore(storeName);\n        dbp = promisifyRequest(request);\n        dbp.then((db) => {\n            // It seems like Safari sometimes likes to just close the connection.\n            // It's supposed to fire this event when that happens. Let's hope it does!\n            db.onclose = () => (dbp = undefined);\n        }, () => { });\n        return dbp;\n    };\n    return (txMode, callback) => getDB().then((db) => callback(db.transaction(storeName, txMode).objectStore(storeName)));\n}\nlet defaultGetStoreFunc;\nfunction defaultGetStore() {\n    if (!defaultGetStoreFunc) {\n        defaultGetStoreFunc = createStore('keyval-store', 'keyval');\n    }\n    return defaultGetStoreFunc;\n}\n/**\n * Get a value by its key.\n *\n * @param key\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction get(key, customStore = defaultGetStore()) {\n    return customStore('readonly', (store) => promisifyRequest(store.get(key)));\n}\n/**\n * Set a value with a key.\n *\n * @param key\n * @param value\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction set(key, value, customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => {\n        store.put(value, key);\n        return promisifyRequest(store.transaction);\n    });\n}\n/**\n * Set multiple values at once. This is faster than calling set() multiple times.\n * It's also atomic  if one of the pairs can't be added, none will be added.\n *\n * @param entries Array of entries, where each entry is an array of `[key, value]`.\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction setMany(entries, customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => {\n        entries.forEach((entry) => store.put(entry[1], entry[0]));\n        return promisifyRequest(store.transaction);\n    });\n}\n/**\n * Get multiple values by their keys\n *\n * @param keys\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction getMany(keys, customStore = defaultGetStore()) {\n    return customStore('readonly', (store) => Promise.all(keys.map((key) => promisifyRequest(store.get(key)))));\n}\n/**\n * Update a value. This lets you see the old value and update it as an atomic operation.\n *\n * @param key\n * @param updater A callback that takes the old value and returns a new value.\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction update(key, updater, customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => \n    // Need to create the promise manually.\n    // If I try to chain promises, the transaction closes in browsers\n    // that use a promise polyfill (IE10/11).\n    new Promise((resolve, reject) => {\n        store.get(key).onsuccess = function () {\n            try {\n                store.put(updater(this.result), key);\n                resolve(promisifyRequest(store.transaction));\n            }\n            catch (err) {\n                reject(err);\n            }\n        };\n    }));\n}\n/**\n * Delete a particular key from the store.\n *\n * @param key\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction del(key, customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => {\n        store.delete(key);\n        return promisifyRequest(store.transaction);\n    });\n}\n/**\n * Delete multiple keys at once.\n *\n * @param keys List of keys to delete.\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction delMany(keys, customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => {\n        keys.forEach((key) => store.delete(key));\n        return promisifyRequest(store.transaction);\n    });\n}\n/**\n * Clear all values in the store.\n *\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction clear(customStore = defaultGetStore()) {\n    return customStore('readwrite', (store) => {\n        store.clear();\n        return promisifyRequest(store.transaction);\n    });\n}\nfunction eachCursor(store, callback) {\n    store.openCursor().onsuccess = function () {\n        if (!this.result)\n            return;\n        callback(this.result);\n        this.result.continue();\n    };\n    return promisifyRequest(store.transaction);\n}\n/**\n * Get all keys in the store.\n *\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction keys(customStore = defaultGetStore()) {\n    return customStore('readonly', (store) => {\n        // Fast path for modern browsers\n        if (store.getAllKeys) {\n            return promisifyRequest(store.getAllKeys());\n        }\n        const items = [];\n        return eachCursor(store, (cursor) => items.push(cursor.key)).then(() => items);\n    });\n}\n/**\n * Get all values in the store.\n *\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction values(customStore = defaultGetStore()) {\n    return customStore('readonly', (store) => {\n        // Fast path for modern browsers\n        if (store.getAll) {\n            return promisifyRequest(store.getAll());\n        }\n        const items = [];\n        return eachCursor(store, (cursor) => items.push(cursor.value)).then(() => items);\n    });\n}\n/**\n * Get all entries in the store. Each entry is an array of `[key, value]`.\n *\n * @param customStore Method to get a custom store. Use with caution (see the docs).\n */\nfunction entries(customStore = defaultGetStore()) {\n    return customStore('readonly', (store) => {\n        // Fast path for modern browsers\n        // (although, hopefully we'll get a simpler path some day)\n        if (store.getAll && store.getAllKeys) {\n            return Promise.all([\n                promisifyRequest(store.getAllKeys()),\n                promisifyRequest(store.getAll()),\n            ]).then(([keys, values]) => keys.map((key, i) => [key, values[i]]));\n        }\n        const items = [];\n        return customStore('readonly', (store) => eachCursor(store, (cursor) => items.push([cursor.key, cursor.value])).then(() => items));\n    });\n}\n\nexport { clear, createStore, del, delMany, entries, get, getMany, keys, promisifyRequest, set, setMany, update, values };\n","// ExoEngine Type Definitions\r\n\r\n// ===== Enums =====\r\nexport const ElementType = {\r\n  Void: 'void',\r\n  Solar: 'solar',\r\n  Arc: 'arc',\r\n  Stasis: 'stasis',\r\n  Strand: 'strand',\r\n  Prismatic: 'prismatic',\r\n  Kinetic: 'kinetic',\r\n  Neutral: 'neutral',\r\n} as const;\r\nexport type ElementType = (typeof ElementType)[keyof typeof ElementType];\r\n\r\nexport const Expansion = {\r\n  BaseGame: 'base',\r\n  Forsaken: 'forsaken',\r\n  Shadowkeep: 'shadowkeep',\r\n  BeyondLight: 'beyond-light',\r\n  WitchQueen: 'witch-queen',\r\n  Lightfall: 'lightfall',\r\n  FinalShape: 'final-shape',\r\n  Anniversary30th: 'anniversary-30th',\r\n  Renegade: 'renegade',\r\n  EdgeOfFate: 'edge-of-fate',\r\n} as const;\r\nexport type Expansion = (typeof Expansion)[keyof typeof Expansion];\r\n\r\nexport const GuardianClass = {\r\n  Titan: 0,\r\n  Hunter: 1,\r\n  Warlock: 2,\r\n} as const;\r\nexport type GuardianClass = (typeof GuardianClass)[keyof typeof GuardianClass];\r\n\r\nexport const ItemSlot = {\r\n  Kinetic: 0,\r\n  Energy: 1,\r\n  Power: 2,\r\n  Helmet: 3,\r\n  Arms: 4,\r\n  Chest: 5,\r\n  Legs: 6,\r\n  ClassItem: 7,\r\n} as const;\r\nexport type ItemSlot = (typeof ItemSlot)[keyof typeof ItemSlot];\r\n\r\nexport const Difficulty = {\r\n  Beginner: 'beginner',\r\n  Intermediate: 'intermediate',\r\n  Advanced: 'advanced',\r\n} as const;\r\nexport type Difficulty = (typeof Difficulty)[keyof typeof Difficulty];\r\n\r\n// ===== Bungie API Types =====\r\nexport interface BungieCredentials {\r\n  apiKey: string;\r\n  clientId: string;\r\n  clientSecret?: string;\r\n}\r\n\r\nexport interface AuthTokens {\r\n  accessToken: string;\r\n  refreshToken: string;\r\n  expiresAt: number;\r\n  membershipId: string;\r\n}\r\n\r\nexport interface BungieMembership {\r\n  membershipId: string;\r\n  membershipType: number;\r\n  displayName: string;\r\n  bungieGlobalDisplayName: string;\r\n  bungieGlobalDisplayNameCode: number;\r\n}\r\n\r\nexport interface DestinyCharacter {\r\n  characterId: string;\r\n  membershipId: string;\r\n  membershipType: number;\r\n  classType: GuardianClass;\r\n  light: number;\r\n  emblemPath: string;\r\n  emblemBackgroundPath: string;\r\n  emblemHash: number;\r\n  raceType: number;\r\n  genderType: number;\r\n  dateLastPlayed: string;\r\n  guardianRank?: number;\r\n  seasonRank?: number;\r\n  commendationScore?: number;\r\n  stats?: Record<number, number>;\r\n}\r\n\r\n// ===== Item Types =====\r\nexport interface DestinyItem {\r\n  itemHash: number;\r\n  itemInstanceId?: string;\r\n  quantity: number;\r\n  bindStatus: number;\r\n  location: number;\r\n  bucketHash: number;\r\n  transferStatus: number;\r\n  lockable: boolean;\r\n  state: number;\r\n  overrideStyleItemHash?: number;\r\n  isExotic?: boolean; // DIM parity: quick check for unique items\r\n  tierType?: number;   // DIM parity: rarity tracking for move-aside\r\n}\r\n\r\nexport interface DisplayProperties {\r\n  name: string;\r\n  description: string;\r\n  icon: string;\r\n  hasIcon: boolean;\r\n}\r\n\r\nexport interface ItemDefinition {\r\n  hash: number;\r\n  displayProperties: DisplayProperties;\r\n  screenshot?: string;\r\n  itemType: number;\r\n  itemSubType: number;\r\n  classType: number;\r\n  equippable: boolean;\r\n  defaultDamageType?: number;\r\n  defaultDamageTypeHash?: number;\r\n\r\n  itemTypeDisplayName?: string;\r\n  sockets?: any;\r\n  itemCategoryHashes?: number[];\r\n  secondarySpecial?: string;\r\n  secondaryOverlay?: string;\r\n  secondaryIcon?: string;\r\n  tierType?: number;\r\n  isExotic?: boolean;\r\n\r\n  inventory?: {\r\n    tierType: number;\r\n    tierTypeName: string;\r\n    bucketTypeHash: number;\r\n    recoveryBucketTypeHash: number;\r\n    maxStackSize: number;\r\n    isInstanceItem: boolean;\r\n    nonTransferrable: boolean;\r\n    equippingLabel?: string;\r\n    equippable?: boolean;\r\n  };\r\n  equippingBlock?: {\r\n    uniqueLabel?: string;\r\n    uniqueLabelHash?: number;\r\n    equipmentSlotTypeHash?: number;\r\n    attributes?: number;\r\n    ammoType?: number;\r\n    displayStrings?: string[];\r\n  };\r\n  stats?: {\r\n    disablePrimaryStatDisplay: boolean;\r\n    statGroupHash: number;\r\n    stats: Record<number, {\r\n      statHash: number;\r\n      value: number;\r\n      minimum: number;\r\n      maximum: number;\r\n      displayMaximum: number;\r\n    }>;\r\n    hasAndDisplayHashes: number[];\r\n  };\r\n\r\n  plug?: {\r\n    plugCategoryIdentifier: string;\r\n    plugCategoryHash: number;\r\n    energyCapacity?: {\r\n      capacityValue: number;\r\n    };\r\n  };\r\n  itemTypeAndTierDisplayName?: string;\r\n  seasonLabel?: string;\r\n  iconWatermark?: string;\r\n  iconWatermarkShelved?: string;\r\n  quality?: {\r\n    currentVersion: number;\r\n    displayVersionWatermarkIcons: string[];\r\n  };\r\n\r\n  // Allow raw data pass-through\r\n  [key: string]: any;\r\n}\r\n\r\nexport interface ItemInstance {\r\n  itemHash?: number;\r\n  itemInstanceId?: string;\r\n  power?: number;\r\n  damageType?: number;\r\n  isEquipped?: boolean;\r\n  isLocked?: boolean;\r\n  canEquip?: boolean;\r\n  energy?: {\r\n    energyType: number;\r\n    energyCapacity: number;\r\n    energyUsed: number;\r\n    isArtifice: boolean; // DIM parity: support for +3 stat mods\r\n  };\r\n  sockets: Array<{\r\n    socketIndex: number;\r\n    plugHash?: number;\r\n    isEnabled?: boolean;\r\n    isVisible?: boolean;\r\n    plugName?: string;\r\n    plugIcon?: string;\r\n  }>;\r\n  stats?: ArmorStats;\r\n  tiers?: Record<string, number>;\r\n  gearTier?: number; // Weapon Tier (1-5) for enhanced perks\r\n}\r\n\r\nexport interface ItemStats {\r\n  mobility?: number;\r\n  resilience?: number;\r\n  recovery?: number;\r\n  discipline?: number;\r\n  intellect?: number;\r\n  strength?: number;\r\n  total: number;\r\n}\r\n\r\nexport interface ItemSockets {\r\n  sockets: Array<{\r\n    socketIndex: number;\r\n    plugHash?: number;\r\n    isEnabled?: boolean;\r\n    isVisible?: boolean;\r\n    plugName?: string;\r\n  }>;\r\n}\r\n\r\nexport interface DestinyArtifact {\r\n  artifactHash: number;\r\n  pointProgression: {\r\n    currentProgress: number;\r\n    nextLevelAt: number;\r\n    stepIndex: number;\r\n    progressToNextLevel: number;\r\n  };\r\n  pointsAcquired: number;\r\n  activeSeasonHash: number;\r\n}\r\n\r\nexport interface CharacterProgressions {\r\n  seasonalArtifact: {\r\n    artifactHash: number;\r\n    pointsUsed: number;\r\n    resetCount: number;\r\n    tiers: {\r\n      tierHash: number;\r\n      isUnlocked: boolean;\r\n      pointsToUnlock: number;\r\n      items: {\r\n        itemHash: number;\r\n        isActive: boolean;\r\n        isVisible: boolean;\r\n      }[];\r\n    }[];\r\n  };\r\n  progressions: Record<string, {\r\n    progressionHash: number;\r\n    dailyProgress: number;\r\n    dailyLimit: number;\r\n    weeklyProgress: number;\r\n    weeklyLimit: number;\r\n    currentProgress: number;\r\n    level: number;\r\n    levelCap: number;\r\n    stepIndex: number;\r\n    progressToNextLevel: number;\r\n    nextLevelAt: number;\r\n  }>;\r\n}\r\n\r\n// ===== Armor Stats =====\r\nexport interface ArmorStats {\r\n  mobility: number;\r\n  resilience: number;\r\n  recovery: number;\r\n  discipline: number;\r\n  intellect: number;\r\n  strength: number;\r\n  total: number;\r\n}\r\n\r\nexport const STAT_HASHES = {\r\n  MOBILITY: 2996146975,\r\n  RESILIENCE: 392767087,\r\n  RECOVERY: 1943323491,\r\n  DISCIPLINE: 1735777505,\r\n  INTELLECT: 144602215,\r\n  STRENGTH: 4244567218,\r\n};\r\n\r\n// ===== Synergy Types =====\r\nexport interface SynergyDefinition {\r\n  id: string;\r\n  name: string;\r\n  element: ElementType;\r\n  guardianClass: GuardianClass;\r\n  requiredExpansion?: Expansion;\r\n\r\n  // Strict Logic Constraints\r\n  requiredGrenadeHash?: number | number[];\r\n  requiredAspectHash?: number | number[];\r\n  requiredSubclassHash?: number;\r\n\r\n  // The core loop\r\n  exoticArmor: {\r\n    hash: number;\r\n    name: string;\r\n    slot: ItemSlot;\r\n  };\r\n\r\n  exoticWeapon?: {\r\n    hash: number;\r\n    name: string;\r\n  };\r\n\r\n  subclassNode: {\r\n    superHash?: number;\r\n    superName?: string;\r\n    aspectHashes: number[];\r\n    aspectNames: string[];\r\n    fragmentHashes?: number[];\r\n    fragmentNames?: string[];\r\n    grenadeHash?: number;\r\n    grenadeName?: string;\r\n    meleeHash?: number;\r\n    meleeName?: string;\r\n    classAbilityHash?: number;\r\n    classAbilityName?: string;\r\n    jumpHash?: number;\r\n    jumpName?: string;\r\n  };\r\n\r\n  weaponPerk?: {\r\n    perkHash: number;\r\n    perkName: string;\r\n    weaponTypes: string[];\r\n  };\r\n\r\n  recommendedWeapons?: Array<{\r\n    hash: number;\r\n    name: string;\r\n  }>;\r\n\r\n  // Metadata\r\n  loopDescription: string;\r\n  playstyle: string;\r\n  difficulty: Difficulty;\r\n  tags: string[];\r\n  armorMods?: number[];\r\n}\r\n\r\n// ===== Build Template Types =====\r\nexport interface BuildTemplate {\r\n  id: string;\r\n  name: string;\r\n  element: ElementType;\r\n  guardianClass: GuardianClass;\r\n  requiredExpansion?: Expansion;\r\n\r\n  exoticWeapon?: {\r\n    hash: number;\r\n    name: string;\r\n    slot: ItemSlot;\r\n    socketOverrides?: Record<number, number>;\r\n  };\r\n\r\n  exoticArmor?: {\r\n    hash: number;\r\n    name: string;\r\n    slot: ItemSlot;\r\n    socketOverrides?: Record<number, number>;\r\n  };\r\n\r\n  /** Specific legendary/other items to equip */\r\n  items?: {\r\n    hash: number;\r\n    name: string;\r\n    socketOverrides?: Record<number, number>;\r\n  }[];\r\n\r\n  subclassConfig?: {\r\n    subclassHash?: number;\r\n    superHash?: number;\r\n    aspects?: number[];\r\n    fragments?: number[];\r\n    grenadeHash?: number;\r\n    meleeHash?: number;\r\n    classAbilityHash?: number;\r\n    jumpHash?: number;\r\n    /** PC_SUPER mapping for non-standard super hashes */\r\n    superSocketIndex?: number;\r\n  };\r\n\r\n  /** General Armor Mods (DIM Compatibility) */\r\n  armorMods?: number[];\r\n\r\n  /** High-level Seasonal Artifact Perks (Those in the screenshot grid) */\r\n  artifactPerks?: number[];\r\n\r\n  /** Per-item socket overrides (Ornaments, Shaders, Weapon Perks) */\r\n  itemOverrides?: Record<string, Record<number, number>>; // itemId -> { socketIndex: plugHash }\r\n\r\n  playstyle: string;\r\n  difficulty: Difficulty;\r\n\r\n  /** Original DIM/External loadout data for full fidelity viewing */\r\n  originalLoadout?: any;\r\n\r\n  /** Source of the build (dim, exoengine, captured) */\r\n  source?: 'dim' | 'exoengine' | 'captured' | 'synergy';\r\n\r\n  /** Character stats at time of capture (Mobility, Resilience, etc.) */\r\n  stats?: ArmorStats;\r\n\r\n  /** Flag to skip subclass switching (Agent-batch mode) */\r\n  skipSubclassSwap?: boolean;\r\n\r\n  /** Flag to skip applying socket overrides (for testing/safety) */\r\n  skipSocketOverrides?: boolean;\r\n}\r\n\r\n// ===== Vault Guard Types =====\r\nexport interface VaultItemAnalysis {\r\n  item: DestinyItem;\r\n  definition: ItemDefinition;\r\n  stats?: ArmorStats;\r\n  flags: VaultFlag[];\r\n  synergyMatches: string[];\r\n  recommendation: 'keep' | 'consider' | 'dismantle';\r\n}\r\n\r\nexport interface VaultFlag {\r\n  type: 'high-stat' | 'spike' | 'double-spike' | 'synergy-enabler' | 'exotic' | 'masterworked';\r\n  description: string;\r\n  priority: number;\r\n}\r\n\r\n// ===== Transfer Types =====\r\nexport interface TransferRequest {\r\n  itemId: string;\r\n  itemHash: number;\r\n  fromCharacter?: string;\r\n  toCharacter: string;\r\n  stackSize?: number;\r\n  action: 'transfer' | 'equip';\r\n}\r\n\r\nexport interface TransferResult {\r\n  success: boolean;\r\n  request: TransferRequest;\r\n  error?: string;\r\n  errorCode?: number;\r\n}\r\n\r\n// ===== Manifest Types =====\r\nexport interface ManifestInfo {\r\n  version: string;\r\n  mobileWorldContentPaths: {\r\n    en: string;\r\n  };\r\n}\r\n\r\nexport interface ManifestData {\r\n  DestinyInventoryItemDefinition: Record<string, ItemDefinition>;\r\n  DestinyStatDefinition: Record<string, { hash: number; displayProperties: { name: string } }>;\r\n  DestinyClassDefinition: Record<string, { displayProperties: { name: string } }>;\r\n  DestinyDamageTypeDefinition: Record<string, { displayProperties: { name: string }; enumValue: number }>;\r\n  DestinySandboxPerkDefinition: Record<string, { displayProperties: { name: string; description: string; icon: string } }>;\r\n}\r\n\r\n// ===== UI State Types =====\r\nexport interface AppState {\r\n  isAuthenticated: boolean;\r\n  isLoading: boolean;\r\n  error: string | null;\r\n\r\n  // Auth\r\n  tokens: AuthTokens | null;\r\n  membership: BungieMembership | null;\r\n\r\n  // Profile\r\n  characters: DestinyCharacter[];\r\n  selectedCharacterId: string | null;\r\n\r\n  // Inventory\r\n  characterInventory: Record<string, DestinyItem[]>;\r\n  vaultInventory: DestinyItem[];\r\n  equippedItems: Record<string, DestinyItem[]>;\r\n\r\n  // Manifest\r\n  manifestVersion: string | null;\r\n  isManifestLoaded: boolean;\r\n}\r\n\r\n// ===== Saved Build Types =====\r\nexport interface SavedBuild {\r\n  id: string;\r\n  name: string;\r\n  template: BuildTemplate;\r\n  notes?: string;\r\n  createdAt: number;\r\n  lastModified: number;\r\n  lastEquipped?: number;\r\n  tags: string[];\r\n}\r\n\r\n// ===== Toast/Notification Types =====\r\nexport interface Toast {\r\n  id: string;\r\n  type: 'success' | 'error' | 'warning' | 'info' | 'alert' | 'lock' | 'unlock';\r\n  message: string;\r\n  duration?: number;\r\n}\r\n","// Bungie Configuration - DIM-Grade Constants\r\n// All hashes verified against DIM's d2-known-values.ts and generated-enums.ts\r\n\r\nexport const BUNGIE_CONFIG = {\r\n  // Production API credentials - loaded from environment variables\r\n  apiKey: import.meta.env.VITE_BUNGIE_API_KEY || 'cfada238bccc49dca0c61b18c276e466',\r\n  clientId: import.meta.env.VITE_BUNGIE_CLIENT_ID || '51502',\r\n  redirectUri: import.meta.env.VITE_REDIRECT_URI ||\r\n    (typeof window !== 'undefined'\r\n      ? `${window.location.origin}/auth/callback`\r\n      : 'https://exoengine.online/auth/callback'),\r\n\r\n  // Bungie API base URLs\r\n  // In DEV (npm run dev), use /Platform to leverage Vite proxy.\r\n  // In PROD (npm run build), use full URL to hit Bungie directly (requires CORS whitelist).\r\n  apiBase: import.meta.env.DEV ? '/Platform' : 'https://www.bungie.net/Platform',\r\n\r\n  authorizationUrl: 'https://www.bungie.net/en/OAuth/Authorize',\r\n\r\n  tokenUrl: '/token.php',\r\n\r\n  dimProxyUrl: '/dim-proxy.php',\r\n\r\n  bungieNetOrigin: 'https://www.bungie.net',\r\n\r\n  // API Endpoints\r\n  endpoints: {\r\n    manifest: '/Destiny2/Manifest/',\r\n    linkedProfiles: (membershipId: string) =>\r\n      `/Destiny2/-1/Profile/${membershipId}/LinkedProfiles/`,\r\n    profile: (membershipType: number, membershipId: string) =>\r\n      `/Destiny2/${membershipType}/Profile/${membershipId}/`,\r\n    character: (membershipType: number, membershipId: string, characterId: string) =>\r\n      `/Destiny2/${membershipType}/Profile/${membershipId}/Character/${characterId}/`,\r\n    transferItem: '/Destiny2/Actions/Items/TransferItem/',\r\n    equipItem: '/Destiny2/Actions/Items/EquipItem/',\r\n    equipItems: '/Destiny2/Actions/Items/EquipItems/',\r\n    pullFromPostmaster: '/Destiny2/Actions/Items/PullFromPostmaster/',\r\n    snapshotLoadout: '/Destiny2/Actions/Loadouts/SnapshotLoadout/',\r\n    insertSocketPlugFree: '/Destiny2/Actions/Items/InsertSocketPlugFree/',\r\n    setLockState: '/Destiny2/Actions/Items/SetLockState/',\r\n  },\r\n\r\n  // Component flags for GetProfile\r\n  // https://bungie-net.github.io/multi/schema_Destiny-DestinyComponentType.html\r\n  components: {\r\n    Profiles: 100,\r\n    VendorReceipts: 101,\r\n    ProfileInventories: 102,\r\n    ProfileCurrencies: 103,\r\n    ProfileProgression: 104,\r\n    PlatformSilver: 105,\r\n    Characters: 200,\r\n    CharacterInventories: 201,\r\n    CharacterProgressions: 202,\r\n    CharacterRenderData: 203,\r\n    CharacterActivities: 204,\r\n    CharacterEquipment: 205,\r\n    ItemInstances: 300,\r\n    ItemObjectives: 301,\r\n    ItemPerks: 302,\r\n    ItemRenderData: 303,\r\n    ItemStats: 304,\r\n    ItemSockets: 305,\r\n    ItemTalentGrids: 306,\r\n    ItemCommonData: 307,\r\n    ItemPlugStates: 308,\r\n    ItemPlugObjectives: 309,\r\n    ItemReusablePlugs: 310,\r\n    Vendors: 400,\r\n    VendorCategories: 401,\r\n    VendorSales: 402,\r\n    Kiosks: 500,\r\n    CurrencyLookups: 600,\r\n    PresentationNodes: 700,\r\n    Collectibles: 800,\r\n    Records: 900,\r\n    Transitory: 1000,\r\n    Metrics: 1100,\r\n    StringVariables: 1200,\r\n    Craftables: 1300,\r\n    CharacterLoadouts: 206,\r\n  },\r\n\r\n  // Standard profile component set for ExoEngine\r\n  standardProfileComponents: [\r\n    100, // Profiles\r\n    102, // ProfileInventories (Vault)\r\n    200, // Characters\r\n    201, // CharacterInventories\r\n    202, // CharacterProgressions\r\n    205, // CharacterEquipment\r\n    300, // ItemInstances\r\n    304, // ItemStats\r\n    305, // ItemSockets\r\n    310, // ItemReusablePlugs\r\n    103, // ProfilePlugSets\r\n    203, // CharacterPlugSets\r\n    1100, // Metrics\r\n    1400, // ProfileCommendations\r\n    1401, // CharacterCommendations\r\n  ],\r\n\r\n  // Check if API is configured\r\n  isConfigured(): boolean {\r\n    return !!(this.apiKey && this.clientId);\r\n  },\r\n\r\n  // Get component query string\r\n  getComponentsQuery(components: number[]): string {\r\n    return `components=${components.join(',')}`;\r\n  },\r\n};\r\n\r\n// Bucket hashes for item locations (verified against DIM BucketHashes)\r\nexport const BUCKET_HASHES = {\r\n  KINETIC_WEAPONS: 1498876634,\r\n  ENERGY_WEAPONS: 2465295065,\r\n  POWER_WEAPONS: 953998645,\r\n  HELMET: 3448274439,\r\n  GAUNTLETS: 3551918588,\r\n  CHEST_ARMOR: 14239492,\r\n  LEG_ARMOR: 20886954,\r\n  CLASS_ARMOR: 1585787867,\r\n  GHOST: 4023194814,\r\n  VEHICLE: 2025709351,\r\n  SHIPS: 284967655,\r\n  SUBCLASS: 3284755031,\r\n  VAULT: 138197802,\r\n  GENERAL: 138197802,\r\n  CONSUMABLES: 1469714392,\r\n  MODIFICATIONS: 3313201758,\r\n  EMBLEM: 4274335291,\r\n  EMOTES: 3054419239,\r\n  FINISHERS: 3683254069,\r\n  SEASONAL_ARTIFACT: 1506418338,\r\n  POSTMASTER: 215593132,\r\n};\r\n\r\n// Item tier types (verified against DIM TierType)\r\nexport const TIER_TYPES = {\r\n  UNKNOWN: 0,\r\n  CURRENCY: 1,\r\n  BASIC: 2,      // Common (white)\r\n  COMMON: 3,     // Uncommon (green)\r\n  RARE: 4,       // Rare (blue)\r\n  SUPERIOR: 5,   // Legendary (purple)\r\n  EXOTIC: 6,     // Exotic (gold)\r\n};\r\n\r\n// Damage type enum values\r\nexport const DAMAGE_TYPES = {\r\n  NONE: 0,\r\n  KINETIC: 1,\r\n  ARC: 2,\r\n  SOLAR: 3,\r\n  VOID: 4,\r\n  RAID: 5,\r\n  STASIS: 6,\r\n  STRAND: 7,\r\n};\r\n\r\n// Damage type hashes (for looking up by hash instead of enum)\r\nexport const DAMAGE_TYPE_HASHES = {\r\n  KINETIC: 3373582085,\r\n  ARC: 2303842570,\r\n  SOLAR: 1847020140,\r\n  VOID: 3454344768,\r\n  STASIS: 151347233,\r\n  STRAND: 3949783978,\r\n  PRISMATIC: 3373582059,\r\n};\r\n\r\n// Armor stat hashes (DIM verified - StatHashes)\r\nexport const STAT_HASHES = {\r\n  MOBILITY: 2996146975,\r\n  RESILIENCE: 392767087,\r\n  RECOVERY: 1943323491,\r\n  DISCIPLINE: 1735777505,\r\n  INTELLECT: 144602215,\r\n  STRENGTH: 4244567218,\r\n  // New Armor 3.0 stat names (same hashes, different names in API)\r\n  WEAPONS: 2996146975,    // Same as Mobility\r\n  HEALTH: 392767087,      // Same as Resilience\r\n  CLASS: 1943323491,      // Same as Recovery\r\n  GRENADE: 1735777505,    // Same as Discipline\r\n  SUPER: 144602215,       // Same as Intellect\r\n  MELEE: 4244567218,      // Same as Strength\r\n};\r\n\r\n// Weapon stat hashes (DIM verified - for Tactical Vault enhancement)\r\nexport const WEAPON_STAT_HASHES = {\r\n  IMPACT: 4043523819,\r\n  RANGE: 1240592695,\r\n  STABILITY: 155624089,\r\n  HANDLING: 943549884,\r\n  RELOAD_SPEED: 4188031367,\r\n  AIM_ASSISTANCE: 1345609583,\r\n  ZOOM: 3555269338,\r\n  AIRBORNE: 2714457168,\r\n  RECOIL_DIRECTION: 2715839340,\r\n  RPM: 4284893193,         // Rounds Per Minute\r\n  MAGAZINE: 3871231066,\r\n  DRAW_TIME: 447667954,\r\n  CHARGE_TIME: 2961396640,\r\n  BLAST_RADIUS: 3614673599,\r\n  VELOCITY: 2523465841,\r\n  SWING_SPEED: 2837207746,\r\n  GUARD_EFFICIENCY: 2762071195,\r\n  GUARD_RESISTANCE: 209426660,\r\n  GUARD_ENDURANCE: 3736848092,\r\n  CHARGE_RATE: 3022301683,\r\n  AMMO_CAPACITY: 925767036,\r\n  SHIELD_DURATION: 1842278586,\r\n  ACCURACY: 1591432999,\r\n};\r\n\r\n// Socket Category Hashes (DIM verified - for subclass configuration)\r\nexport const SOCKET_CATEGORY_HASHES = {\r\n  SUPER: 457473665,\r\n  ASPECTS: 2047681910,\r\n  ASPECTS_IKORA: 2140934067,\r\n  ASPECTS_STRANGER: 3400923910,\r\n  ASPECTS_NEOMUNA: 764703411,\r\n  FRAGMENTS: 271461480,\r\n  FRAGMENTS_IKORA: 1313488945,\r\n  FRAGMENTS_STRANGER: 2819965312,\r\n  FRAGMENTS_NEOMUNA: 193371309,\r\n  ABILITIES: 309722977,\r\n  ABILITIES_IKORA: 3218807805,\r\n  TRANSCENDENCE: 1905270138,\r\n  WEAPON_PERKS: 4241085061,\r\n  ARMOR_PERKS: 2518356196,\r\n  ARMOR_TIER: 760375309,\r\n  WEAPON_MODS: 2685412949,\r\n  ARMOR_MODS: 590099826,\r\n};\r\n\r\n// DIM-verified special item hashes\r\nexport const SPECIAL_ITEMS = {\r\n  DEFAULT_SHADER: 4248210736,\r\n  DEFAULT_GLOW: 3807544519,\r\n  DEFAULT_ORNAMENTS: [2931483505, 1959648454, 702981643, 3854296178],\r\n  EMPTY_SOCKET_HASHES: [2323986101, 2600899007, 1835369552, 3851138800, 791435474],\r\n  DEEPSIGHT_HARMONIZER: 2228452164,\r\n  SILVER: 3147280338,\r\n  ARTIFICE_PERK: 3727270518,\r\n};\r\n\r\n// Armor energy values (DIM verified)\r\nexport const ARMOR_ENERGY = {\r\n  MAX_CAPACITY: 10,\r\n  MAX_CAPACITY_TIER_5: 11,  // Edge of Fate Tier 5 armor\r\n  MASTERWORK_STAT_BONUS: 2,\r\n};\r\n\r\n// Vendor hashes (DIM verified)\r\nexport const VENDOR_HASHES = {\r\n  EVERVERSE: 3361454721,\r\n  BANSHEE: 672118013,\r\n  ADA_FORGE: 2917531897,\r\n  ADA_TRANSMOG: 350061650,\r\n  RAHOOL: 2255782930,\r\n  XUR: 2190858386,\r\n  VAULT: 1037843411,\r\n};\r\n\r\n// Guardian class types\r\nexport const CLASS_TYPES = {\r\n  TITAN: 0,\r\n  HUNTER: 1,\r\n  WARLOCK: 2,\r\n  UNKNOWN: 3,\r\n};\r\n\r\n// Breaker types (Champion mods)\r\nexport const BREAKER_TYPES = {\r\n  SHIELD_PIERCING: 485622768,  // Anti-Barrier\r\n  DISRUPTION: 2611060930,       // Overload\r\n  STAGGER: 3178805705,          // Unstoppable\r\n};\r\n\r\n// Item Categories (for filtering)\r\nexport const ITEM_CATEGORY_HASHES = {\r\n  WEAPON: 1,\r\n  ARMOR: 20,\r\n  AUTO_RIFLE: 5,\r\n  HAND_CANNON: 6,\r\n  PULSE_RIFLE: 7,\r\n  SCOUT_RIFLE: 8,\r\n  FUSION_RIFLE: 9,\r\n  SNIPER_RIFLE: 10,\r\n  SHOTGUN: 11,\r\n  MACHINE_GUN: 12,\r\n  ROCKET_LAUNCHER: 13,\r\n  SIDEARM: 14,\r\n  SWORD: 54,\r\n  GRENADE_LAUNCHER: 153950757,\r\n  LINEAR_FUSION_RIFLE: 1504945536,\r\n  TRACE_RIFLE: 2489664120,\r\n  BOW: 3317538576,\r\n  GLAIVE: 3871742104,\r\n  SUBMACHINE_GUN: 3954685534,\r\n};\r\n\r\n// Kill tracker objective hashes (DIM verified)\r\nexport const KILL_TRACKER_OBJECTIVES = {\r\n  PVP: [1501870536, 2439952408, 74070459, 890482414, 2109364169],\r\n  PVE: [90275515, 2579044636, 73837075, 3387796140],\r\n  GAMBIT: [345540971],\r\n};\r\n","/**\r\n * Token Encryption Service\r\n * Provides AES-GCM encryption for sensitive tokens stored in IndexedDB\r\n * Uses Web Crypto API for secure, browser-native cryptography\r\n */\r\n\r\nimport { errorLog, warnLog } from '../../utils/logger';\r\n\r\n// Encryption configuration\r\nconst ENCRYPTION_ALGORITHM = 'AES-GCM';\r\nconst KEY_LENGTH = 256; // AES-256\r\nconst IV_LENGTH = 12; // 96 bits for GCM\r\nconst SALT_LENGTH = 16; // 128 bits\r\nconst ITERATIONS = 100000; // PBKDF2 iterations\r\n\r\ninterface EncryptedData {\r\n    ciphertext: string; // Base64 encoded\r\n    iv: string; // Base64 encoded initialization vector\r\n    salt: string; // Base64 encoded salt\r\n}\r\n\r\nclass TokenEncryptionService {\r\n    private encryptionKey: CryptoKey | null = null;\r\n\r\n    /**\r\n     * Initialize encryption key from device-specific entropy\r\n     * Uses multiple entropy sources for key generation\r\n     */\r\n    async initialize(): Promise<void> {\r\n        if (this.encryptionKey) return;\r\n\r\n        try {\r\n            // Generate device-specific key material\r\n            const keyMaterial = await this.generateKeyMaterial();\r\n\r\n            // Derive encryption key using PBKDF2\r\n            const salt = await this.getOrCreateSalt();\r\n            this.encryptionKey = await crypto.subtle.deriveKey(\r\n                {\r\n                    name: 'PBKDF2',\r\n                    salt: salt as BufferSource,\r\n                    iterations: ITERATIONS,\r\n                    hash: 'SHA-256'\r\n                },\r\n                keyMaterial,\r\n                {\r\n                    name: ENCRYPTION_ALGORITHM,\r\n                    length: KEY_LENGTH\r\n                },\r\n                false, // Not extractable - key stays in memory\r\n                ['encrypt', 'decrypt']\r\n            );\r\n        } catch (error) {\r\n            errorLog('TokenEncryption', 'Init failed:', error);\r\n            throw new Error('Failed to initialize token encryption');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Encrypt sensitive data using AES-GCM\r\n     */\r\n    async encrypt(plaintext: string): Promise<EncryptedData> {\r\n        await this.initialize();\r\n\r\n        if (!this.encryptionKey) {\r\n            throw new Error('Encryption key not initialized');\r\n        }\r\n\r\n        try {\r\n            // Generate random IV\r\n            const iv = crypto.getRandomValues(new Uint8Array(IV_LENGTH));\r\n\r\n            // Convert plaintext to bytes\r\n            const encoder = new TextEncoder();\r\n            const data = encoder.encode(plaintext);\r\n\r\n            // Encrypt using AES-GCM\r\n            const ciphertext = await crypto.subtle.encrypt(\r\n                {\r\n                    name: ENCRYPTION_ALGORITHM,\r\n                    iv: iv\r\n                },\r\n                this.encryptionKey,\r\n                data\r\n            );\r\n\r\n            // Get salt for storage\r\n            const salt = await this.getOrCreateSalt();\r\n\r\n            return {\r\n                ciphertext: this.arrayBufferToBase64(ciphertext),\r\n                iv: this.arrayBufferToBase64(iv),\r\n                salt: this.arrayBufferToBase64(salt)\r\n            };\r\n        } catch (error) {\r\n            errorLog('TokenEncryption', 'Encrypt failed:', error);\r\n            throw new Error('Failed to encrypt data');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Decrypt encrypted data using AES-GCM\r\n     */\r\n    async decrypt(encrypted: EncryptedData): Promise<string> {\r\n        await this.initialize();\r\n\r\n        if (!this.encryptionKey) {\r\n            throw new Error('Encryption key not initialized');\r\n        }\r\n\r\n        try {\r\n            // Convert from base64\r\n            const ciphertext = this.base64ToArrayBuffer(encrypted.ciphertext);\r\n            const iv = this.base64ToArrayBuffer(encrypted.iv);\r\n\r\n            // Decrypt using AES-GCM\r\n            const decrypted = await crypto.subtle.decrypt(\r\n                {\r\n                    name: ENCRYPTION_ALGORITHM,\r\n                    iv: iv as BufferSource\r\n                },\r\n                this.encryptionKey,\r\n                ciphertext as BufferSource\r\n            );\r\n\r\n            // Convert back to string\r\n            const decoder = new TextDecoder();\r\n            return decoder.decode(decrypted);\r\n        } catch (error) {\r\n            errorLog('TokenEncryption', 'Decrypt failed:', error);\r\n            throw new Error('Failed to decrypt data');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Generate cryptographic key material from device entropy\r\n     */\r\n    private async generateKeyMaterial(): Promise<CryptoKey> {\r\n        // Collect entropy from multiple sources\r\n        const entropy = this.collectDeviceEntropy();\r\n\r\n        // Import as key material for PBKDF2\r\n        return crypto.subtle.importKey(\r\n            'raw',\r\n            entropy as BufferSource,\r\n            'PBKDF2',\r\n            false,\r\n            ['deriveKey']\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Collect device-specific entropy for key generation\r\n     * Uses multiple sources to create unique key per device/browser\r\n     * IMPORTANT: This must be deterministic - same device = same entropy\r\n     */\r\n    private collectDeviceEntropy(): Uint8Array {\r\n        const sources = [\r\n            // Browser fingerprint components (deterministic)\r\n            navigator.userAgent,\r\n            navigator.language,\r\n            navigator.hardwareConcurrency?.toString() || '',\r\n            screen.width?.toString() || '',\r\n            screen.height?.toString() || '',\r\n            screen.colorDepth?.toString() || '',\r\n            new Date().getTimezoneOffset().toString(),\r\n            // Add more stable fingerprinting\r\n            navigator.platform,\r\n            navigator.maxTouchPoints?.toString() || '0'\r\n        ];\r\n\r\n        // Combine all sources - NO RANDOM DATA!\r\n        // The salt provides randomness, key material must be deterministic\r\n        const combined = sources.join('|');\r\n        const encoder = new TextEncoder();\r\n        return encoder.encode(combined);\r\n    }\r\n\r\n    /**\r\n     * Get or create persistent salt for PBKDF2\r\n     */\r\n    private async getOrCreateSalt(): Promise<Uint8Array> {\r\n        const SALT_KEY = 'exo_encryption_salt';\r\n\r\n        try {\r\n            // Try to get existing salt from localStorage\r\n            const stored = localStorage.getItem(SALT_KEY);\r\n            if (stored) {\r\n                return this.base64ToArrayBuffer(stored);\r\n            }\r\n        } catch (e) {\r\n            // localStorage might be disabled\r\n        }\r\n\r\n        // Generate new salt\r\n        const salt = crypto.getRandomValues(new Uint8Array(SALT_LENGTH));\r\n\r\n        try {\r\n            // Store for future use\r\n            localStorage.setItem(SALT_KEY, this.arrayBufferToBase64(salt));\r\n        } catch (e) {\r\n            warnLog('TokenEncryption', 'Salt persist failed');\r\n        }\r\n\r\n        return salt;\r\n    }\r\n\r\n    /**\r\n     * Convert ArrayBuffer to Base64 string\r\n     */\r\n    private arrayBufferToBase64(buffer: ArrayBuffer | Uint8Array): string {\r\n        const bytes = buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer);\r\n        let binary = '';\r\n        for (let i = 0; i < bytes.byteLength; i++) {\r\n            binary += String.fromCharCode(bytes[i]);\r\n        }\r\n        return btoa(binary);\r\n    }\r\n\r\n    /**\r\n     * Convert Base64 string to Uint8Array\r\n     */\r\n    private base64ToArrayBuffer(base64: string): Uint8Array {\r\n        const binary = atob(base64);\r\n        const bytes = new Uint8Array(binary.length);\r\n        for (let i = 0; i < binary.length; i++) {\r\n            bytes[i] = binary.charCodeAt(i);\r\n        }\r\n        return bytes;\r\n    }\r\n\r\n    /**\r\n     * Clear encryption key from memory\r\n     * Call on logout to ensure key is not persisted\r\n     */\r\n    clearKey(): void {\r\n        this.encryptionKey = null;\r\n    }\r\n}\r\n\r\n// Export singleton instance\r\nexport const tokenEncryption = new TokenEncryptionService();\r\n","// IndexedDB Service for ExoEngine\r\n// Handles caching of manifest data, auth tokens, and saved builds\r\nimport type { SavedBuild } from '../../types';\r\nimport { tokenEncryption } from '../crypto/token-encryption.service';\r\nimport { infoLog, warnLog, errorLog, debugLog } from '../../utils/logger';\r\n\r\nconst DB_NAME = 'exoengine';\r\nconst DB_VERSION = 3;\r\n\r\ninterface StoreConfig {\r\n  name: string;\r\n  keyPath: string;\r\n  indexes?: Array<{ name: string; keyPath: string; options?: IDBIndexParameters }>;\r\n}\r\n\r\nconst STORES: StoreConfig[] = [\r\n  {\r\n    name: 'manifest',\r\n    keyPath: 'tableName',\r\n  },\r\n  {\r\n    name: 'manifestMeta',\r\n    keyPath: 'key',\r\n  },\r\n  {\r\n    name: 'auth',\r\n    keyPath: 'key',\r\n  },\r\n  {\r\n    name: 'savedBuilds',\r\n    keyPath: 'id',\r\n    indexes: [\r\n      { name: 'by-class', keyPath: 'template.guardianClass' },\r\n      { name: 'by-element', keyPath: 'template.element' },\r\n      { name: 'by-created', keyPath: 'createdAt' },\r\n    ],\r\n  },\r\n  {\r\n    name: 'settings',\r\n    keyPath: 'key',\r\n  },\r\n  {\r\n    name: 'cache',\r\n    keyPath: 'key',\r\n  },\r\n  {\r\n    name: 'clarity_descriptions',\r\n    keyPath: 'key',\r\n  },\r\n  {\r\n    name: 'clarity_version',\r\n    keyPath: 'key',\r\n  },\r\n];\r\n\r\nclass IndexedDBService {\r\n  private db: IDBDatabase | null = null;\r\n  private initPromise: Promise<void> | null = null;\r\n\r\n  async init(): Promise<void> {\r\n    if (this.db) return;\r\n    if (this.initPromise) return this.initPromise;\r\n\r\n    this.initPromise = new Promise((resolve, reject) => {\r\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\r\n\r\n      request.onerror = () => {\r\n        errorLog('IndexedDB', 'Failed to open database:', request.error);\r\n        reject(request.error);\r\n      };\r\n\r\n      request.onblocked = () => {\r\n        warnLog('IndexedDB', 'Database upgrade blocked! Close other tabs to permit upgrade.');\r\n        // We resolve anyway so the app doesn't hang, but the stores might be missing\r\n        // Alternatively, we could keep it pending, but that's risky for UX.\r\n      };\r\n\r\n      request.onsuccess = () => {\r\n        this.db = request.result;\r\n        const storeNames = Array.from(this.db.objectStoreNames);\r\n        debugLog('IndexedDB', `Database v${this.db.version} opened successfully. Stores:`, storeNames);\r\n        resolve();\r\n      };\r\n\r\n      request.onupgradeneeded = (event) => {\r\n        const db = (event.target as IDBOpenDBRequest).result;\r\n        const oldVersion = event.oldVersion;\r\n        const newVersion = event.newVersion;\r\n        infoLog('IndexedDB', `Upgrading database from v${oldVersion} to v${newVersion}`);\r\n\r\n        for (const store of STORES) {\r\n          if (!db.objectStoreNames.contains(store.name)) {\r\n            const objectStore = db.createObjectStore(store.name, {\r\n              keyPath: store.keyPath,\r\n            });\r\n\r\n            if (store.indexes) {\r\n              for (const index of store.indexes) {\r\n                objectStore.createIndex(index.name, index.keyPath, index.options);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      };\r\n    });\r\n\r\n    return this.initPromise;\r\n  }\r\n\r\n  private async getDB(): Promise<IDBDatabase> {\r\n    await this.init();\r\n    if (!this.db) throw new Error('Database not initialized');\r\n    return this.db;\r\n  }\r\n\r\n  // Generic CRUD operations\r\n  async get<T>(storeName: string, key: string): Promise<T | undefined> {\r\n    const db = await this.getDB();\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const transaction = db.transaction(storeName, 'readonly');\r\n      const store = transaction.objectStore(storeName);\r\n      const request = store.get(key);\r\n\r\n      request.onerror = () => reject(request.error);\r\n      request.onsuccess = () => resolve(request.result);\r\n    });\r\n  }\r\n\r\n  async set<T>(storeName: string, value: T): Promise<void> {\r\n    const db = await this.getDB();\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const transaction = db.transaction(storeName, 'readwrite');\r\n      const store = transaction.objectStore(storeName);\r\n      store.put(value);\r\n\r\n      transaction.oncomplete = () => resolve();\r\n      transaction.onerror = () => reject(transaction.error);\r\n    });\r\n  }\r\n\r\n  async delete(storeName: string, key: string): Promise<void> {\r\n    const db = await this.getDB();\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const transaction = db.transaction(storeName, 'readwrite');\r\n      const store = transaction.objectStore(storeName);\r\n      const request = store.delete(key);\r\n\r\n      request.onerror = () => reject(request.error);\r\n      request.onsuccess = () => resolve();\r\n    });\r\n  }\r\n\r\n  async getAll<T>(storeName: string): Promise<T[]> {\r\n    const db = await this.getDB();\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const transaction = db.transaction(storeName, 'readonly');\r\n      const store = transaction.objectStore(storeName);\r\n      const request = store.getAll();\r\n\r\n      request.onerror = () => reject(request.error);\r\n      request.onsuccess = () => resolve(request.result);\r\n    });\r\n  }\r\n\r\n  async clear(storeName: string): Promise<void> {\r\n    const db = await this.getDB();\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const transaction = db.transaction(storeName, 'readwrite');\r\n      const store = transaction.objectStore(storeName);\r\n      const request = store.clear();\r\n\r\n      request.onerror = () => reject(request.error);\r\n      request.onsuccess = () => resolve();\r\n    });\r\n  }\r\n\r\n  async getAllByIndex<T>(\r\n    storeName: string,\r\n    indexName: string,\r\n    value: IDBValidKey\r\n  ): Promise<T[]> {\r\n    const db = await this.getDB();\r\n\r\n    return new Promise((resolve, reject) => {\r\n      const transaction = db.transaction(storeName, 'readonly');\r\n      const store = transaction.objectStore(storeName);\r\n      const index = store.index(indexName);\r\n      const request = index.getAll(value);\r\n\r\n      request.onerror = () => reject(request.error);\r\n      request.onsuccess = () => resolve(request.result);\r\n    });\r\n  }\r\n\r\n  // Manifest-specific operations\r\n  async getManifestTable<T>(tableName: string): Promise<Record<string, T> | undefined> {\r\n    const result = await this.get<{ tableName: string; data: Record<string, T> }>(\r\n      'manifest',\r\n      tableName\r\n    );\r\n    return result?.data;\r\n  }\r\n\r\n  async setManifestTable<T>(tableName: string, data: Record<string, T>): Promise<void> {\r\n    await this.set('manifest', { tableName, data });\r\n  }\r\n\r\n  async getManifestVersion(): Promise<string | undefined> {\r\n    const result = await this.get<{ key: string; version: string }>(\r\n      'manifestMeta',\r\n      'version'\r\n    );\r\n    return result?.version;\r\n  }\r\n\r\n  async setManifestVersion(version: string): Promise<void> {\r\n    await this.set('manifestMeta', { key: 'version', version, updatedAt: Date.now() });\r\n  }\r\n\r\n  async clearManifest(): Promise<void> {\r\n    await this.clear('manifest');\r\n    await this.clear('manifestMeta');\r\n  }\r\n\r\n  // Auth-specific operations with encryption\r\n  async getAuthTokens(): Promise<{\r\n    accessToken: string;\r\n    refreshToken: string;\r\n    expiresAt: number;\r\n    membershipId: string;\r\n  } | undefined> {\r\n    const result = await this.get<any>('auth', 'tokens');\r\n\r\n    if (!result) return undefined;\r\n\r\n    // Token format validation (no logging for security)\r\n\r\n    // Check if tokens are in old plaintext format (backward compatibility)\r\n    if (result.accessToken && result.refreshToken) {\r\n      infoLog('IndexedDB', ' Migrating plaintext tokens to encrypted format');\r\n\r\n      try {\r\n        // Migrate to encrypted format\r\n        await this.setAuthTokens({\r\n          accessToken: result.accessToken,\r\n          refreshToken: result.refreshToken,\r\n          expiresAt: result.expiresAt,\r\n          membershipId: result.membershipId,\r\n        });\r\n\r\n        // Return the plaintext tokens for this session\r\n        return {\r\n          accessToken: result.accessToken,\r\n          refreshToken: result.refreshToken,\r\n          expiresAt: result.expiresAt,\r\n          membershipId: result.membershipId,\r\n        };\r\n      } catch (error) {\r\n        errorLog('IndexedDB', 'Failed to migrate tokens:', error);\r\n        // Clear corrupted tokens\r\n        await this.clearAuth();\r\n        return undefined;\r\n      }\r\n    }\r\n\r\n    // Handle encrypted format (new format)\r\n    if (result.encryptedAccessToken && result.encryptedRefreshToken) {\r\n      try {\r\n        // Decrypt tokens using AES-GCM\r\n        const accessTokenData = JSON.parse(result.encryptedAccessToken);\r\n        const refreshTokenData = JSON.parse(result.encryptedRefreshToken);\r\n\r\n        const accessToken = await tokenEncryption.decrypt(accessTokenData);\r\n        const refreshToken = await tokenEncryption.decrypt(refreshTokenData);\r\n\r\n        return {\r\n          accessToken,\r\n          refreshToken,\r\n          expiresAt: result.expiresAt,\r\n          membershipId: result.membershipId,\r\n        };\r\n      } catch (error) {\r\n        errorLog('IndexedDB', 'Failed to decrypt tokens:', error);\r\n        // Clear corrupted tokens\r\n        await this.clearAuth();\r\n        return undefined;\r\n      }\r\n    }\r\n\r\n    // Unknown format - clear and return undefined\r\n    warnLog('IndexedDB', ' Unknown token format, clearing auth');\r\n    await this.clearAuth();\r\n    return undefined;\r\n  }\r\n\r\n  async setAuthTokens(tokens: {\r\n    accessToken: string;\r\n    refreshToken: string;\r\n    expiresAt: number;\r\n    membershipId: string;\r\n  }): Promise<void> {\r\n    try {\r\n      // Encrypt tokens using AES-GCM\r\n      const encryptedAccessToken = await tokenEncryption.encrypt(tokens.accessToken);\r\n      const encryptedRefreshToken = await tokenEncryption.encrypt(tokens.refreshToken);\r\n\r\n      await this.set('auth', {\r\n        key: 'tokens',\r\n        encryptedAccessToken: JSON.stringify(encryptedAccessToken),\r\n        encryptedRefreshToken: JSON.stringify(encryptedRefreshToken),\r\n        expiresAt: tokens.expiresAt,\r\n        membershipId: tokens.membershipId,\r\n      });\r\n    } catch (error) {\r\n      errorLog('IndexedDB', 'Failed to encrypt tokens:', error);\r\n      throw new Error('Failed to store authentication tokens securely');\r\n    }\r\n  }\r\n\r\n  async clearAuth(): Promise<void> {\r\n    await this.clear('auth');\r\n    // Clear encryption key from memory\r\n    tokenEncryption.clearKey();\r\n  }\r\n\r\n  async saveOAuthState(state: string): Promise<void> {\r\n    await this.set('auth', { key: 'oauth_state', value: state, createdAt: Date.now() });\r\n  }\r\n\r\n  async getOAuthState(): Promise<string | undefined> {\r\n    const result = await this.get<{ key: string; value: string }>('auth', 'oauth_state');\r\n    return result?.value;\r\n  }\r\n\r\n  // Saved Builds operations\r\n  async getSavedBuilds(): Promise<SavedBuild[]> {\r\n    return this.getAll<SavedBuild>('savedBuilds');\r\n  }\r\n\r\n  async setSavedBuild(build: SavedBuild): Promise<void> {\r\n    await this.set('savedBuilds', build);\r\n  }\r\n\r\n  async deleteSavedBuild(id: string): Promise<void> {\r\n    await this.delete('savedBuilds', id);\r\n  }\r\n\r\n  // Clarity Community Descriptions operations\r\n  async getClarityVersion(): Promise<number | undefined> {\r\n    const result = await this.get<{ key: string; value: number }>('clarity_version', 'current');\r\n    return result?.value;\r\n  }\r\n\r\n  async setClarityVersion(version: number): Promise<void> {\r\n    await this.set('clarity_version', { key: 'current', value: version });\r\n  }\r\n\r\n  async getClarityDescriptions(): Promise<any | undefined> {\r\n    const result = await this.get<{ key: string; data: any }>('clarity_descriptions', 'all');\r\n    return result?.data;\r\n  }\r\n\r\n  async setClarityDescriptions(data: any): Promise<void> {\r\n    await this.set('clarity_descriptions', { key: 'all', data });\r\n  }\r\n\r\n  /**\r\n   * Generic get method\r\n   */\r\n\r\n  // Settings operations\r\n  async getSetting<T>(key: string): Promise<T | undefined> {\r\n    const result = await this.get<{ key: string; value: T }>('settings', key);\r\n    return result?.value;\r\n  }\r\n\r\n  async setSetting<T>(key: string, value: T): Promise<void> {\r\n    await this.set('settings', { key, value });\r\n  }\r\n\r\n  // Cache operations with TTL\r\n  async getCached<T>(key: string): Promise<T | undefined> {\r\n    const result = await this.get<{\r\n      key: string;\r\n      value: T;\r\n      expiresAt: number;\r\n    }>('cache', key);\r\n\r\n    if (!result) return undefined;\r\n    if (result.expiresAt < Date.now()) {\r\n      await this.delete('cache', key);\r\n      return undefined;\r\n    }\r\n\r\n    return result.value;\r\n  }\r\n\r\n  async setCached<T>(key: string, value: T, ttlMs: number): Promise<void> {\r\n    await this.set('cache', {\r\n      key,\r\n      value,\r\n      expiresAt: Date.now() + ttlMs,\r\n    });\r\n  }\r\n\r\n  // Database size estimation\r\n  async estimateSize(): Promise<{ usage: number; quota: number }> {\r\n    if ('storage' in navigator && 'estimate' in navigator.storage) {\r\n      const estimate = await navigator.storage.estimate();\r\n      return {\r\n        usage: estimate.usage || 0,\r\n        quota: estimate.quota || 0,\r\n      };\r\n    }\r\n    return { usage: 0, quota: 0 };\r\n  }\r\n\r\n  // Clear profile cache\r\n  async clearProfileCache(): Promise<void> {\r\n    await this.clear('cache');\r\n  }\r\n\r\n  // Full database clear\r\n  async clearAll(): Promise<void> {\r\n    const db = await this.getDB();\r\n    const storeNames = Array.from(db.objectStoreNames);\r\n\r\n    for (const storeName of storeNames) {\r\n      await this.clear(storeName);\r\n    }\r\n  }\r\n\r\n  // Close database connection (prevent corruption on PWA freeze)\r\n  async close(): Promise<void> {\r\n    if (this.db) {\r\n      this.db.close();\r\n      this.db = null;\r\n      this.initPromise = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Destructive: Deletes the entire IndexedDB database.\r\n   * Useful for \"Hard Reset\" scenarios.\r\n   */\r\n  async deleteDatabase(): Promise<void> {\r\n    await this.close();\r\n    return new Promise((resolve, reject) => {\r\n      const request = indexedDB.deleteDatabase(DB_NAME);\r\n      request.onerror = () => reject(request.error);\r\n      request.onsuccess = () => {\r\n        infoLog('IndexedDB', 'Database deleted successfully');\r\n        resolve();\r\n      };\r\n    });\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const db = new IndexedDBService();\r\n\r\n// Listen for PWA/Mobile freeze events (DIM parity)\r\nif (typeof window !== 'undefined') {\r\n  window.addEventListener('freeze', () => {\r\n    db.close().catch(err => errorLog('IndexedDB', 'Failed to close database:', err));\r\n  });\r\n}\r\n","// Bungie API Client - DIM-Grade Implementation\r\n// Handles all HTTP requests to the Bungie.net API with authentication, rate limiting, and resilience\r\n\r\nimport { BUNGIE_CONFIG } from '../../config/bungie.config';\r\nimport { db } from '../db/indexeddb.service';\r\nimport { debugLog, warnLog, errorLog, infoLog } from '../../utils/logger';\r\nimport { useAuthStore, useToastStore } from '../../store';\r\n\r\ninterface RequestConfig {\r\n  method?: 'GET' | 'POST';\r\n  body?: unknown;\r\n  requiresAuth?: boolean;\r\n  skipRetry?: boolean;\r\n  /** Priority level for rate limiting (lower = higher priority) */\r\n  priority?: number;\r\n}\r\n\r\ninterface ApiResponse<T> {\r\n  Response: T;\r\n  ErrorCode: number;\r\n  ThrottleSeconds: number;\r\n  ErrorStatus: string;\r\n  Message: string;\r\n  MessageData: Record<string, string>;\r\n}\r\n\r\n// DIM-Aligned Platform Error Codes\r\nexport const PlatformErrorCodes = {\r\n  Success: 1,\r\n  // Authentication Errors\r\n  AccessTokenHasExpired: 99,\r\n  WebAuthRequired: 1618,\r\n  WebAuthModuleAsyncFailed: 1619,\r\n  AuthorizationRecordRevoked: 1627,\r\n  AuthorizationRecordExpired: 1628,\r\n  AuthorizationCodeStale: 1629,\r\n  AuthorizationCodeInvalid: 1630,\r\n  // Throttle Errors\r\n  ThrottleLimitExceededMinutes: 31,\r\n  ThrottleLimitExceededMomentarily: 32,\r\n  ThrottleLimitExceededSeconds: 33,\r\n  DestinyThrottledByGameServer: 1672,\r\n  PerApplicationThrottleExceeded: 51,\r\n  PerApplicationAnonymousThrottleExceeded: 52,\r\n  PerApplicationAuthenticatedThrottleExceeded: 53,\r\n  PerUserThrottleExceeded: 54,\r\n  // Item Operation Errors\r\n  DestinyNoRoomInDestination: 1622,\r\n  DestinyItemNotFound: 1623,\r\n  DestinyUniquenessViolation: 1648,\r\n  DestinyItemUnequippable: 1642,\r\n  DestinyCannotPerformActionOnEquippedItem: 1641,\r\n  DestinyItemAlreadyEquipped: 1640,\r\n  ActionOnlyInGame: 1663,\r\n  DestinySocketActionNotAllowed: 1678,\r\n  DestinyCannotPerformActionAtThisLocation: 1618,\r\n  DestinyCharacterNotInTower: 1634,\r\n  // System Errors\r\n  SystemDisabled: 5,\r\n  DestinyUnexpectedError: 1,\r\n} as const;\r\n\r\n// Auth error codes that indicate we need to refresh or re-login\r\nconst AUTH_ERROR_CODES: Set<number> = new Set([\r\n  PlatformErrorCodes.AccessTokenHasExpired,\r\n  PlatformErrorCodes.WebAuthRequired,\r\n  PlatformErrorCodes.WebAuthModuleAsyncFailed,\r\n  PlatformErrorCodes.AuthorizationRecordRevoked,\r\n  PlatformErrorCodes.AuthorizationRecordExpired,\r\n  PlatformErrorCodes.AuthorizationCodeStale,\r\n  PlatformErrorCodes.AuthorizationCodeInvalid,\r\n]);\r\n\r\n// Throttle error codes for exponential backoff\r\nconst THROTTLE_ERROR_CODES: Set<number> = new Set([\r\n  PlatformErrorCodes.ThrottleLimitExceededMinutes,\r\n  PlatformErrorCodes.ThrottleLimitExceededMomentarily,\r\n  PlatformErrorCodes.ThrottleLimitExceededSeconds,\r\n  PlatformErrorCodes.DestinyThrottledByGameServer,\r\n  PlatformErrorCodes.PerApplicationThrottleExceeded,\r\n  PlatformErrorCodes.PerApplicationAnonymousThrottleExceeded,\r\n  PlatformErrorCodes.PerApplicationAuthenticatedThrottleExceeded,\r\n  PlatformErrorCodes.PerUserThrottleExceeded,\r\n]);\r\n\r\n// Enhanced Rate Limiter with priority queue and DIM-style timing\r\nclass RateLimitQueue {\r\n  private lastPromise: Promise<unknown> = Promise.resolve();\r\n  private lastRequestTimeByEndpoint: Map<string, number> = new Map();\r\n  private lastGlobalRequestTime = 0;\r\n  private depth = 0;\r\n\r\n  private readonly intervals: Record<string, number> = {\r\n    'TransferItem': 100,\r\n    'EquipItem': 100,\r\n    'EquipItems': 100,\r\n    'PullFromPostmaster': 100,\r\n    'InsertSocketPlug': 500,\r\n    'InsertSocketPlugFree': 500,\r\n    'SnapshotLoadout': 1000,\r\n    'SetLockState': 100,\r\n    'default': 50\r\n  };\r\n\r\n  private getInterval(endpoint: string): number {\r\n    for (const [key, value] of Object.entries(this.intervals)) {\r\n      if (endpoint.includes(key)) return value;\r\n    }\r\n    return this.intervals.default;\r\n  }\r\n\r\n  async add<T>(requestFn: () => Promise<T>, endpoint: string): Promise<T> {\r\n    this.depth++;\r\n    // DIM Standard: Ensure the next operation waits for the previous one completely\r\n    const wrappedFn = async (): Promise<T> => {\r\n      // 1. Device Reliability: Acquire screen wake lock if available\r\n      let sentinel: any = undefined;\r\n      if (typeof navigator !== 'undefined' && 'wakeLock' in navigator) {\r\n        try { sentinel = await (navigator as any).wakeLock.request('screen'); } catch { }\r\n      }\r\n\r\n      try {\r\n        // 2. DIM Throttling: Enforce settle intervals\r\n        const now = Date.now();\r\n        const endpointKey = Object.keys(this.intervals).find(k => endpoint.includes(k)) || 'default';\r\n        const endpointLastTime = this.lastRequestTimeByEndpoint.get(endpointKey) || 0;\r\n\r\n        // Global gap between ANY requests (DIM standard is 50ms)\r\n        const globalWait = Math.max(0, 50 - (now - this.lastGlobalRequestTime));\r\n        // Endpoint-specific gap (e.g. 100ms for moves, 500ms for sockets)\r\n        const endpointWait = Math.max(0, this.getInterval(endpoint) - (now - endpointLastTime));\r\n        const waitTime = Math.max(globalWait, endpointWait);\r\n\r\n        if (waitTime > 0) await new Promise(r => setTimeout(r, waitTime));\r\n\r\n        // 3. Execution\r\n        const result = await requestFn();\r\n\r\n        // 4. Update Timestamps\r\n        const requestTime = Date.now();\r\n        this.lastGlobalRequestTime = requestTime;\r\n        this.lastRequestTimeByEndpoint.set(endpointKey, requestTime);\r\n\r\n        return result;\r\n      } finally {\r\n        this.depth--;\r\n        // 5. Cleanup\r\n        if (sentinel) await sentinel.release();\r\n      }\r\n    };\r\n\r\n    // Chain the promise to the last one (Absolute Sequential Integrity)\r\n    const nextPromise = this.lastPromise.then(wrappedFn, wrappedFn);\r\n    this.lastPromise = nextPromise;\r\n    return nextPromise as Promise<T>;\r\n  }\r\n\r\n  getQueueDepth(): number {\r\n    return this.depth;\r\n  }\r\n}\r\n\r\nclass BungieApiClient {\r\n  private isRefreshing = false;\r\n  private refreshPromise: Promise<boolean> | null = null;\r\n  private limiter = new RateLimitQueue();\r\n  private onMaintenance: ((isMaintenance: boolean) => void) | null = null;\r\n\r\n  // Exponential backoff state (DIM-style with healing)\r\n  private timesThrottled = 0;\r\n  private lastThrottleTime = 0;\r\n  private readonly MAX_BACKOFF_MS = 5 * 60 * 1000; // 5 minutes max\r\n  private readonly THROTTLE_HEAL_INTERVAL = 30000; // Heal every 30 seconds of success\r\n\r\n  private async getHeaders(requiresAuth: boolean): Promise<HeadersInit> {\r\n    const headers: HeadersInit = {\r\n      'X-API-Key': BUNGIE_CONFIG.apiKey,\r\n      'Content-Type': 'application/json',\r\n    };\r\n\r\n    if (requiresAuth) {\r\n      const tokens = await db.getAuthTokens();\r\n      if (tokens) {\r\n        // Check token expiration with 60 second buffer\r\n        if (tokens.expiresAt < Date.now() + 60000) {\r\n          const refreshed = await this.refreshAccessToken();\r\n          if (refreshed) {\r\n            const newTokens = await db.getAuthTokens();\r\n            if (newTokens) {\r\n              headers['Authorization'] = `Bearer ${newTokens.accessToken}`;\r\n            }\r\n          }\r\n          headers['Authorization'] = `Bearer ${tokens.accessToken}`;\r\n        } else {\r\n          headers['Authorization'] = `Bearer ${tokens.accessToken}`;\r\n        }\r\n        // Auth header attached - no token logging for security\r\n      }\r\n    }\r\n\r\n    return headers;\r\n  }\r\n\r\n  private async applyThrottleBackoff(): Promise<void> {\r\n    // Heal throttle count over time (DIM pattern)\r\n    const timeSinceLastThrottle = Date.now() - this.lastThrottleTime;\r\n    if (timeSinceLastThrottle > this.THROTTLE_HEAL_INTERVAL && this.timesThrottled > 0) {\r\n      this.timesThrottled = Math.max(0, this.timesThrottled - 1);\r\n    }\r\n\r\n    if (this.timesThrottled > 0) {\r\n      // Exponential backoff: 500ms, 1s, 2s, 4s, 8s... up to 5 minutes\r\n      const waitTime = Math.min(this.MAX_BACKOFF_MS, Math.pow(2, this.timesThrottled) * 500);\r\n\r\n      await new Promise(resolve => setTimeout(resolve, waitTime));\r\n    }\r\n  }\r\n\r\n  async request<T>(\r\n    endpoint: string,\r\n    config: RequestConfig = {}\r\n  ): Promise<T> {\r\n    const { method = 'GET', body, requiresAuth = false, skipRetry = false } = config;\r\n\r\n    return this.limiter.add(async () => {\r\n      let retryCount = 0;\r\n      const effectiveSkipRetry = skipRetry || (config as any)._skipRetryInternal;\r\n\r\n      while (true) {\r\n        // Apply throttle backoff before each attempt\r\n        await this.applyThrottleBackoff();\r\n\r\n        const url = `${BUNGIE_CONFIG.apiBase}${endpoint}`;\r\n        const headers = await this.getHeaders(requiresAuth);\r\n\r\n        if (method === 'POST') {\r\n          infoLog('API', ` ${method} ${endpoint}`);\r\n        } else {\r\n          debugLog('API', ` ${method} ${endpoint}`);\r\n        }\r\n\r\n        const slowApiTimeout = setTimeout(() => {\r\n          useToastStore.getState().addToast({\r\n            type: 'warning',\r\n            message: 'Bungie API is slow. ExoEngine is still waiting for a response...',\r\n            duration: 10000\r\n          });\r\n        }, 15000);\r\n\r\n        try {\r\n          const response = await fetch(url, {\r\n            method,\r\n            headers,\r\n            body: body ? JSON.stringify(body) : undefined,\r\n            credentials: 'omit',\r\n          });\r\n          clearTimeout(slowApiTimeout);\r\n\r\n          // DIM Standard: Handle HTTP transient errors (502-526)\r\n          // Note: We DO NOT retry 500 errors for state-changing operations (Transfer, Socketing)\r\n          // because Bungie often returns 500 for legitimate game conditions (like full inventory)\r\n          // and retrying can cause race conditions or desync in our space-making logic.\r\n          const isStateChanging = endpoint.includes('TransferItem') ||\r\n            endpoint.includes('InsertSocketPlug') ||\r\n            endpoint.includes('EquipItem');\r\n\r\n          if (response.status >= 502 && response.status <= 526 && !effectiveSkipRetry && retryCount < 3) {\r\n            const delay = 1000 * Math.pow(2, retryCount);\r\n            warnLog('API', `Transient network error (${response.status}) at ${endpoint}. Retrying in ${delay}ms...`, { retryCount });\r\n            await new Promise(resolve => setTimeout(resolve, delay));\r\n            retryCount++;\r\n            continue;\r\n          }\r\n\r\n          // Handle HTTP 500 specially: Only retry if it's NOT a state-changing operation\r\n          // OR if it's a known transient Bungie error code (handled below in ErrorCode check)\r\n          if (response.status === 500 && !isStateChanging && !effectiveSkipRetry && retryCount < 2) {\r\n            const delay = 1000 * Math.pow(2, retryCount);\r\n            warnLog('API', `Server error (500) at ${endpoint}. Retrying in ${delay}ms...`, { retryCount });\r\n            await new Promise(resolve => setTimeout(resolve, delay));\r\n            retryCount++;\r\n            continue;\r\n          }\r\n\r\n          // Handle HTTP 429 (Rate Limited)\r\n          if (response.status === 429) {\r\n            const retryAfter = parseInt(response.headers.get('Retry-After') || '5', 10);\r\n            infoLog('API', `Rate limited (429). Retrying after ${retryAfter}s...`);\r\n            this.timesThrottled++;\r\n            this.lastThrottleTime = Date.now();\r\n            await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));\r\n            // Loop for retry if allowed\r\n            if (effectiveSkipRetry) throw new Error('Rate limited and skipRetry is set');\r\n            continue;\r\n          }\r\n\r\n          // DIM Standard: If response is not OK, we try to parse it as JSON first to get Bungie Error Codes\r\n          let data: ApiResponse<T>;\r\n          try {\r\n            data = await response.json();\r\n          } catch (e) {\r\n            // Non-JSON response (e.g. raw 500 error that wasn't caught above or Cloudflare error)\r\n            if (response.status >= 500) {\r\n              const apiError = new BungieApiError('Bungie server error', -1, 'HttpError', endpoint, response.status);\r\n              if (isStateChanging) {\r\n                apiError.isPotentialSuccess = true;\r\n              }\r\n              throw apiError;\r\n            }\r\n            throw e;\r\n          }\r\n\r\n          // Handle Bungie-specific errors\r\n          if (data.ErrorCode !== PlatformErrorCodes.Success) {\r\n            // DIM-grade: Identify transient vs hard failures\r\n            // Bungie Error 1 (UnexpectedError) and 1672 (DestinyThrottledByGameServer) are transient\r\n            // We allow retries for these even on state-changing operations if they come with a 500 status\r\n            const isTransientError = data.ErrorCode === PlatformErrorCodes.DestinyUnexpectedError ||\r\n              data.ErrorCode === PlatformErrorCodes.DestinyThrottledByGameServer;\r\n\r\n            if (isTransientError && !effectiveSkipRetry && retryCount < 3) {\r\n              const delay = 1000 * Math.pow(2, retryCount);\r\n              warnLog('API', `Transient Bungie error (${data.ErrorCode}) at ${endpoint}. Retrying in ${delay}ms...`, { retryCount });\r\n              await new Promise(resolve => setTimeout(resolve, delay));\r\n              retryCount++;\r\n              continue;\r\n            }\r\n\r\n            // Log full error details - use debugLog for transient errors to keep console clean\r\n            const logFn = response.status === 500 || data.ErrorCode === PlatformErrorCodes.DestinyItemNotFound ? debugLog : errorLog;\r\n            logFn('API', 'Full error response:', {\r\n              endpoint,\r\n              errorCode: data.ErrorCode,\r\n              errorStatus: data.ErrorStatus,\r\n              message: data.Message,\r\n              messageData: data.MessageData,\r\n              throttleSeconds: data.ThrottleSeconds\r\n            });\r\n\r\n            // Check for throttle errors - apply exponential backoff\r\n            if (THROTTLE_ERROR_CODES.has(data.ErrorCode)) {\r\n              this.timesThrottled++;\r\n              this.lastThrottleTime = Date.now();\r\n              const waitTime = data.ThrottleSeconds > 0 ? data.ThrottleSeconds * 1000 : 5000;\r\n              warnLog('API', `Bungie throttle (${data.ErrorCode}). Waiting ${waitTime}ms...`);\r\n              await new Promise(resolve => setTimeout(resolve, waitTime));\r\n              if (effectiveSkipRetry) throw new BungieApiError(data.Message, data.ErrorCode, data.ErrorStatus, endpoint, response.status);\r\n              continue; // Re-attempt after throttle wait\r\n            }\r\n\r\n            // Check for maintenance - trigger handler but do NOT clear auth\r\n            if (data.ErrorCode === PlatformErrorCodes.SystemDisabled) {\r\n              const { isMaintenance } = useAuthStore.getState();\r\n              if (!isMaintenance) {\r\n                warnLog('API', 'Bungie API Maintenance Detected (SystemDisabled)');\r\n                if (this.onMaintenance) this.onMaintenance(true);\r\n              }\r\n              // If we reached here, it's a hard Bungie error\r\n              throw new BungieApiError(data.Message, data.ErrorCode, data.ErrorStatus, endpoint, response.status);\r\n            }\r\n\r\n            // Check for auth errors - try refresh\r\n            if (AUTH_ERROR_CODES.has(data.ErrorCode) && !effectiveSkipRetry && requiresAuth) {\r\n\r\n              const refreshed = await this.refreshAccessToken();\r\n              if (refreshed) {\r\n                // If token refreshed, try one more time immediately\r\n                // We set a flag to avoid infinite loops\r\n                (config as any)._skipRetryInternal = true;\r\n                continue;\r\n              }\r\n            }\r\n\r\n            // Handle \"already contains plug\" as success\r\n            if (data.ErrorCode === 1671 || data.ErrorCode === 1679) {\r\n              return data.Response as T;\r\n            }\r\n\r\n            // Log specific error details for debugging\r\n            if (data.ErrorCode === PlatformErrorCodes.DestinyUniquenessViolation) {\r\n              errorLog('API', 'Uniqueness violation: Multiple exotics in equip request');\r\n            } else if (data.ErrorCode === PlatformErrorCodes.DestinyNoRoomInDestination) {\r\n              warnLog('API', 'No room in destination bucket');\r\n            }\r\n\r\n            throw new BungieApiError(\r\n              data.Message || 'Unknown Bungie API error',\r\n              data.ErrorCode,\r\n              data.ErrorStatus,\r\n              endpoint\r\n            );\r\n          }\r\n\r\n          // Success - heal throttle count quickly (DIM pattern)\r\n          if (this.timesThrottled > 0) {\r\n            this.timesThrottled = Math.floor(this.timesThrottled / 2);\r\n          }\r\n\r\n          return data.Response;\r\n        } catch (error) {\r\n          if (error instanceof BungieApiError) throw error;\r\n\r\n          // DIM-aligned: Check for TypeError (network failure)\r\n          // These should NOT trigger auth clearing - it's just a network hiccup\r\n          if (error instanceof TypeError && !effectiveSkipRetry && retryCount < 2) {\r\n            warnLog('API', 'Network failure, retrying...', { endpoint, retryCount });\r\n            await new Promise(resolve => setTimeout(resolve, 1000));\r\n            retryCount++;\r\n            continue;\r\n          }\r\n\r\n          // Handle other network/timeout errors\r\n          throw new BungieApiError(\r\n            error instanceof Error ? error.message : 'Request failed',\r\n            -1,\r\n            'NetworkError',\r\n            endpoint\r\n          );\r\n        }\r\n      }\r\n    }, endpoint);\r\n  }\r\n\r\n  async get<T>(endpoint: string, requiresAuth = false, priority = 5): Promise<T> {\r\n    return this.request<T>(endpoint, { method: 'GET', requiresAuth, priority });\r\n  }\r\n\r\n  async post<T>(endpoint: string, body: unknown, requiresAuth = false, priority = 5): Promise<T> {\r\n    return this.request<T>(endpoint, { method: 'POST', body, requiresAuth, priority });\r\n  }\r\n\r\n  // OAuth Authorization URL with state protection\r\n  async getAuthorizationUrl(): Promise<string> {\r\n    const state = crypto.randomUUID ? crypto.randomUUID() :\r\n      Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);\r\n\r\n    infoLog('Auth', 'Generating OAuth state', { state, origin: window.location.origin });\r\n\r\n    try {\r\n      await db.saveOAuthState(state);\r\n      // Double-check save succeeded\r\n      const verified = await db.getOAuthState();\r\n      if (verified === state) {\r\n        infoLog('Auth', 'OAuth state successfully persisted to DB', { state });\r\n      } else {\r\n        warnLog('Auth', 'OAuth state verification failed! Data was not found after save.', { expected: state, actual: verified });\r\n      }\r\n    } catch (err) {\r\n      errorLog('Auth', 'Failed to save OAuth state to DB!', err);\r\n    }\r\n\r\n    const params = new URLSearchParams({\r\n      client_id: BUNGIE_CONFIG.clientId,\r\n      response_type: 'code',\r\n      redirect_uri: BUNGIE_CONFIG.redirectUri,\r\n      state: state,\r\n      // CRITICAL: Request offline access to get a refresh token\r\n      // Without this, Bungie only returns a short-lived access token\r\n      access_type: 'offline'\r\n    });\r\n\r\n    return `${BUNGIE_CONFIG.authorizationUrl}?${params.toString()}`;\r\n  }\r\n\r\n  // Exchange authorization code for tokens\r\n  async exchangeCode(code: string): Promise<{\r\n    accessToken: string;\r\n    refreshToken: string;\r\n    expiresIn: number;\r\n    membershipId: string;\r\n  }> {\r\n    const body = new URLSearchParams({\r\n      grant_type: 'authorization_code',\r\n      code,\r\n      client_id: BUNGIE_CONFIG.clientId,\r\n      redirect_uri: BUNGIE_CONFIG.redirectUri,\r\n    });\r\n\r\n    const response = await fetch(BUNGIE_CONFIG.tokenUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/x-www-form-urlencoded',\r\n        'X-API-Key': BUNGIE_CONFIG.apiKey,\r\n      },\r\n      body: body.toString(),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const error = await response.text();\r\n      throw new BungieApiError(`Failed to exchange code: ${error}`, 0, 'AuthError', 'token');\r\n    }\r\n\r\n    const data = await response.json();\r\n\r\n    // Validate that we received a refresh token (required for long-term auth)\r\n    if (!data.refresh_token) {\r\n      warnLog('API', 'Initial auth did not include refresh_token - sessions will be short-lived');\r\n    }\r\n\r\n    const tokens = {\r\n      accessToken: data.access_token,\r\n      refreshToken: data.refresh_token || '',\r\n      expiresIn: data.expires_in,\r\n      membershipId: data.membership_id,\r\n    };\r\n\r\n    await db.setAuthTokens({\r\n      accessToken: tokens.accessToken,\r\n      refreshToken: tokens.refreshToken,\r\n      expiresAt: Date.now() + tokens.expiresIn * 1000,\r\n      membershipId: tokens.membershipId,\r\n    });\r\n\r\n    return tokens;\r\n  }\r\n\r\n  // Refresh access token with DIM-aligned resilience\r\n  async refreshAccessToken(): Promise<boolean> {\r\n    // Prevent concurrent refresh attempts (promise lock pattern)\r\n    if (this.isRefreshing) {\r\n      return this.refreshPromise || Promise.resolve(false);\r\n    }\r\n\r\n    this.isRefreshing = true;\r\n    this.refreshPromise = this.doRefreshToken();\r\n\r\n    try {\r\n      return await this.refreshPromise;\r\n    } finally {\r\n      this.isRefreshing = false;\r\n      this.refreshPromise = null;\r\n    }\r\n  }\r\n\r\n  private async doRefreshToken(): Promise<boolean> {\r\n    const tokens = await db.getAuthTokens();\r\n    if (!tokens?.refreshToken) {\r\n      errorLog('API', 'No refresh token available - User must re-authenticate');\r\n      // Force auth clear to ensure UI updates\r\n      await this.triggerAuthFailure();\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      const body = new URLSearchParams({\r\n        grant_type: 'refresh_token',\r\n        refresh_token: tokens.refreshToken,\r\n        client_id: BUNGIE_CONFIG.clientId,\r\n        redirect_uri: BUNGIE_CONFIG.redirectUri,\r\n      });\r\n\r\n      const response = await fetch(BUNGIE_CONFIG.tokenUrl, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/x-www-form-urlencoded',\r\n          'X-API-Key': BUNGIE_CONFIG.apiKey,\r\n        },\r\n        body: body.toString(),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        // Try to parse error response for more context\r\n        let errorData: any = null;\r\n        try {\r\n          errorData = await response.json();\r\n        } catch { }\r\n\r\n        // DIM-aligned: Check for specific refresh errors\r\n        if (errorData?.error === 'server_error') {\r\n          const desc = errorData.error_description;\r\n          if (desc === 'SystemDisabled') {\r\n            warnLog('API', 'Bungie API maintenance detected. Preserving tokens.');\r\n            throw new Error('Bungie API is under maintenance');\r\n          }\r\n          // Fatal refresh errors - must re-authenticate\r\n          if (['RefreshTokenNotYetValid', 'AccessTokenHasExpired', 'AuthorizationCodeInvalid',\r\n            'AuthorizationRecordExpired', 'AuthorizationRecordRevoked', 'AuthorizationCodeStale'].includes(desc)) {\r\n            errorLog('API', `Fatal refresh error: ${desc}. Clearing auth.`);\r\n            await this.triggerAuthFailure();\r\n            return false;\r\n          }\r\n        }\r\n\r\n        // Check HTTP status for auth failures\r\n        if (response.status === 401 || response.status === 403) {\r\n          errorLog('API', 'Refresh token rejected (401/403). Clearing auth.');\r\n          await this.triggerAuthFailure();\r\n          return false;\r\n        }\r\n\r\n        // DIM-CRITICAL: Transient server errors (502, 503, 504, 500) should NOT clear auth\r\n        // These are Bungie's fault, not ours - preserve tokens for retry\r\n        if (response.status >= 500) {\r\n          warnLog('API', `Bungie server error during refresh (${response.status}). Preserving tokens.`);\r\n          throw new Error(`Bungie API transient error: ${response.status}`);\r\n        }\r\n\r\n        // For other 4xx errors (except 401/403), log but don't clear immediately\r\n        errorLog('API', 'Token refresh failed with status:', response.status);\r\n        // Only clear auth on definitive client-side failures\r\n        if (response.status >= 400 && response.status < 500) {\r\n          await this.triggerAuthFailure();\r\n        }\r\n        return false;\r\n      }\r\n\r\n      const data = await response.json();\r\n\r\n      // DIM-CRITICAL: Bungie may NOT return a new refresh_token during refresh.\r\n      // We MUST preserve the existing refresh token if a new one isn't provided!\r\n      const currentTokens = await db.getAuthTokens();\r\n      const newRefreshToken = data.refresh_token || currentTokens?.refreshToken;\r\n\r\n      if (!newRefreshToken) {\r\n        errorLog('API', 'No refresh token available after refresh. Auth will fail.');\r\n      }\r\n\r\n      await db.setAuthTokens({\r\n        accessToken: data.access_token,\r\n        refreshToken: newRefreshToken || '',\r\n        expiresAt: Date.now() + data.expires_in * 1000,\r\n        membershipId: data.membership_id,\r\n      });\r\n\r\n      return true;\r\n    } catch (error) {\r\n      // DIM-CRITICAL: TypeError = network failure, do NOT clear auth\r\n      if (error instanceof TypeError) {\r\n        warnLog('API', 'Network error during token refresh. Preserving tokens for retry.', error);\r\n        throw error; // Re-throw but don't clear auth\r\n      }\r\n\r\n      // For other errors, log but don't necessarily clear\r\n      errorLog('API', 'Token refresh error:', error);\r\n\r\n      // Only clear auth for definitive auth failures, not transient errors\r\n      if (error instanceof Error && error.message.includes('maintenance')) {\r\n        throw error; // Don't clear auth during maintenance\r\n      }\r\n\r\n      await this.triggerAuthFailure();\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // Maintenance Handling\r\n  setMaintenanceHandler(handler: (isMaintenance: boolean) => void) {\r\n    this.onMaintenance = handler;\r\n  }\r\n\r\n  // Auth Failure Callback Handling\r\n  private onAuthFailure: (() => void) | null = null;\r\n\r\n  setAuthFailureHandler(handler: () => void) {\r\n    this.onAuthFailure = handler;\r\n  }\r\n\r\n  private async triggerAuthFailure() {\r\n    warnLog('API', 'Triggering global auth failure handler');\r\n    await db.clearAuth();\r\n    if (this.onAuthFailure) {\r\n      this.onAuthFailure();\r\n    }\r\n  }\r\n\r\n  // Check if user is authenticated\r\n  async isAuthenticated(): Promise<boolean> {\r\n    const tokens = await db.getAuthTokens();\r\n    if (!tokens) return false;\r\n\r\n    // If token is expired but we have refresh token, try to refresh\r\n    if (tokens.expiresAt < Date.now()) {\r\n      return this.refreshAccessToken();\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  // Logout\r\n  async logout(): Promise<void> {\r\n    await db.clearAuth();\r\n    this.timesThrottled = 0; // Reset throttle state\r\n  }\r\n\r\n  // Get current membership ID\r\n  async getMembershipId(): Promise<string | null> {\r\n    const tokens = await db.getAuthTokens();\r\n    return tokens?.membershipId || null;\r\n  }\r\n\r\n  // Get current throttle state (for UI feedback)\r\n  getThrottleState(): { level: number; queueDepth: number } {\r\n    return {\r\n      level: this.timesThrottled,\r\n      queueDepth: this.limiter.getQueueDepth()\r\n    };\r\n  }\r\n\r\n  // Cloud Sync: User Application Data (DIM Parity)\r\n  // NOTE: Bungie does not actually provide a public 'UserApplicationData' endpoint for 3rd parties.\r\n  // DIM uses its own backend for this. We'll return empty to prevent 404s.\r\n  async getUserApplicationData(): Promise<Record<string, any>> {\r\n    return {};\r\n  }\r\n\r\n  async setUserApplicationData(_data: Record<string, any>): Promise<boolean> {\r\n    // No-op to prevent 404s.\r\n    return true;\r\n  }\r\n}\r\n\r\n// Custom error class with enhanced context\r\nexport class BungieApiError extends Error {\r\n  public errorCode: number;\r\n  public errorStatus: string;\r\n  public endpoint: string;\r\n  public httpStatus: number;\r\n  public isPotentialSuccess: boolean = false;\r\n\r\n  constructor(message: string, errorCode: number, errorStatus: string, endpoint: string = '', httpStatus: number = 0) {\r\n    // DIM Standard: Professional, helpful error messages\r\n    let userMessage = message;\r\n    if (errorCode === PlatformErrorCodes.ActionOnlyInGame ||\r\n      errorCode === PlatformErrorCodes.DestinyCannotPerformActionAtThisLocation ||\r\n      errorCode === PlatformErrorCodes.DestinyCharacterNotInTower) {\r\n      userMessage = \"This action requires you to be logged into Destiny 2 and in Orbit or a Social Space. If you're in an activity or offline, please return to Orbit to continue.\";\r\n    } else if (errorCode === PlatformErrorCodes.DestinyNoRoomInDestination) {\r\n      userMessage = \"Not enough room in the destination bucket. Try moving some items aside first.\";\r\n    } else if (errorCode === PlatformErrorCodes.DestinyUniquenessViolation) {\r\n      userMessage = \"You can only equip one piece of exotic armor and one exotic weapon at a time.\";\r\n    } else if (errorCode === PlatformErrorCodes.ThrottleLimitExceededSeconds) {\r\n      userMessage = \"You're moving items too fast! Bungie is slowing us down. Waiting a few seconds...\";\r\n    } else if (errorCode === PlatformErrorCodes.SystemDisabled) {\r\n      userMessage = \"Bungie's servers are currently undergoing maintenance. Most API features are temporarily unavailable.\";\r\n    }\r\n\r\n    super(userMessage);\r\n    this.errorCode = errorCode;\r\n    this.errorStatus = errorStatus;\r\n    this.endpoint = endpoint;\r\n    this.httpStatus = httpStatus;\r\n    this.name = 'BungieApiError';\r\n\r\n    // DIM Standard: Log specific endpoint and error for precise tracing\r\n    debugLog('API', `Bungie Error [${errorCode}] at ${endpoint}: ${message}`);\r\n  }\r\n\r\n  // Helper to check if this is a specific error type\r\n  isNoRoomError(): boolean {\r\n    return this.errorCode === PlatformErrorCodes.DestinyNoRoomInDestination;\r\n  }\r\n\r\n  isAuthError(): boolean {\r\n    return AUTH_ERROR_CODES.has(this.errorCode);\r\n  }\r\n\r\n  isThrottleError(): boolean {\r\n    return THROTTLE_ERROR_CODES.has(this.errorCode) || this.errorCode === -1;\r\n  }\r\n\r\n  isNetworkError(): boolean {\r\n    return this.errorStatus === 'NetworkError';\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const bungieApi = new BungieApiClient();\r\n","// Zustand Store for ExoEngine\nimport { create } from 'zustand';\nimport { warnLog } from '../utils/logger';\nimport { get as idbGet, set as idbSet } from 'idb-keyval';\nimport type {\n  AuthTokens,\n  BungieMembership,\n  DestinyCharacter,\n  DestinyItem,\n  ItemInstance,\n  Toast,\n  SavedBuild,\n  DestinyArtifact,\n  CharacterProgressions,\n  BuildTemplate\n} from '../types';\nimport { Expansion } from '../types';\nimport { bungieApi } from '../services/bungie/api-client';\n\n// ===== Auth Store =====\ninterface AuthState {\n  isAuthenticated: boolean;\n  isLoading: boolean;\n  isMaintenance: boolean;\n  tokens: AuthTokens | null;\n  membership: BungieMembership | null;\n  setAuthenticated: (auth: boolean) => void;\n  setLoading: (loading: boolean) => void;\n  setMaintenance: (isMaintenance: boolean) => void;\n  setTokens: (tokens: AuthTokens | null) => void;\n  setMembership: (membership: BungieMembership | null) => void;\n  logout: (hardReset?: boolean) => Promise<void>;\n}\n\nexport const useAuthStore = create<AuthState>((set) => ({\n  isAuthenticated: false,\n  isLoading: true,\n  isMaintenance: false,\n  tokens: null,\n  membership: null,\n  setAuthenticated: (auth) => set({ isAuthenticated: auth }),\n  setLoading: (loading) => set({ isLoading: loading }),\n  setMaintenance: (isMaintenance) => set({ isMaintenance }),\n  setTokens: (tokens) => set({ tokens }),\n  setMembership: (membership) => set({ membership }),\n  logout: async (hardReset = false) => {\n    await bungieApi.logout();\n    if (hardReset) {\n      const { db } = await import('../services/db/indexeddb.service');\n      await db.deleteDatabase();\n      localStorage.clear();\n      sessionStorage.clear();\n    }\n    useProfileStore.getState().clear();\n    set({ isAuthenticated: false, tokens: null, membership: null, isMaintenance: false });\n    window.location.href = '/';\n  },\n}));\n\n// ===== Profile Store =====\nexport const SetInventoriesResult = {\n  ACCEPTED: 'ACCEPTED',\n  SKIPPED_IDENTICAL: 'SKIPPED_IDENTICAL',\n  DISCARDED_STALE: 'DISCARDED_STALE'\n} as const;\n\nexport type SetInventoriesResult = typeof SetInventoriesResult[keyof typeof SetInventoriesResult];\n\nexport interface SynergyMatch {\n  synergy: any;\n  matchType: 'exact' | 'partial' | 'potential';\n  matchedComponents: {\n    super: boolean;\n    exoticArmor: boolean;\n    exoticWeapon: boolean;\n    aspects: string[];\n    fragments: string[];\n  };\n  completeness: number;\n}\n\ninterface ProfileState {\n  characters: DestinyCharacter[];\n  selectedCharacterId: string | null;\n  characterInventories: Record<string, DestinyItem[]>;\n  characterEquipment: Record<string, DestinyItem[]>;\n  vaultInventory: DestinyItem[];\n  itemInstances: Record<string, ItemInstance>;\n  artifact: DestinyArtifact | null;\n  characterProgressions: Record<string, CharacterProgressions> | null;\n  isLoading: boolean;\n  isEquipping: boolean;\n  lastUpdated: number | null;\n  responseMintedTimestamp: string | null;\n  currentGuardianRank: number;\n  commendationScore: number;\n  commendationNodeScores: Record<string, number>;\n  commendationNodePercentages: Record<string, number>;\n  lifetimeScore: number;\n  activeSeasonRank: number;\n  artifactLevel: number;\n  artifactXP: { current: number; total: number };\n  powerBonusXP: { current: number; total: number };\n  commendationsSent: number;\n  commendationsReceived: number;\n  detectedSynergies: SynergyMatch[] | null;\n  activeTransfers: Set<string>;\n  inFlightTargets: Map<string, string>;\n  successfulTransfers: Set<string>;\n  failedTransfers: Set<string>;\n  profilePlugSets: Record<number, number[]> | null;\n  characterPlugSets: Record<string, Record<number, number[]>> | null;\n\n  setCharacters: (characters: DestinyCharacter[]) => void;\n  setSelectedCharacter: (id: string | null) => void;\n  setDetectedSynergies: (synergies: SynergyMatch[] | null) => void;\n  setInventories: (data: any) => SetInventoriesResult;\n  setLoading: (loading: boolean) => void;\n  setEquipping: (equipping: boolean) => void;\n  updateItemInstance: (instanceId: string, updates: Partial<ItemInstance>) => void;\n  updateItemSocket: (instanceId: string, socketIndex: number, plugHash: number, plugName?: string, plugIcon?: string) => void;\n  addActiveTransfer: (instanceId: string, targetId?: string) => void;\n  removeActiveTransfer: (instanceId: string, success?: boolean, failure?: boolean) => void;\n  clearSuccessfulTransfer: (instanceId: string) => void;\n  clearFailedTransfer: (instanceId: string) => void;\n  getSelectedCharacter: () => DestinyCharacter | undefined;\n  getAllInventory: () => DestinyItem[];\n  virtualLoadouts: Record<string, VirtualLoadout>;\n  saveVirtualLoadout: (loadout: VirtualLoadout) => void;\n  deleteVirtualLoadout: (id: string) => void;\n  clear: () => void;\n  hydrateFromCache: () => Promise<boolean>;\n}\n\nexport interface VirtualLoadout {\n  id: string;\n  name: string;\n  items: string[];\n  itemsData: { hash: number; name: string; instanceId?: string; slot?: string }[];\n  classType: number;\n  timestamp: number;\n  icon?: string;\n}\n\nexport const useProfileStore = create<ProfileState>((set, get) => ({\n  characters: [],\n  selectedCharacterId: localStorage.getItem('exo_selected_character'),\n  characterInventories: {},\n  characterEquipment: {},\n  vaultInventory: [],\n  itemInstances: {},\n  artifact: null,\n  characterProgressions: null,\n  isLoading: true,\n  isEquipping: false,\n  lastUpdated: null,\n  responseMintedTimestamp: null,\n  currentGuardianRank: 0,\n  commendationScore: 0,\n  commendationNodeScores: {},\n  commendationNodePercentages: {},\n  lifetimeScore: 0,\n  activeSeasonRank: 0,\n  artifactLevel: 0,\n  artifactXP: { current: 0, total: 1 },\n  powerBonusXP: { current: 0, total: 1 },\n  commendationsSent: 0,\n  commendationsReceived: 0,\n  detectedSynergies: null,\n  activeTransfers: new Set(),\n  inFlightTargets: new Map(),\n  successfulTransfers: new Set(),\n  failedTransfers: new Set(),\n  profilePlugSets: null,\n  characterPlugSets: null,\n  virtualLoadouts: (() => {\n    try {\n      const saved = localStorage.getItem('exo_virtual_loadouts');\n      return saved ? JSON.parse(saved) : {};\n    } catch (e) {\n      return {};\n    }\n  })(),\n\n  setCharacters: (characters) => {\n    const currentId = get().selectedCharacterId;\n    set({ characters });\n\n    // If we have an existing selection, verify it still exists in the new list\n    if (currentId && characters.some(c => c.characterId === currentId)) {\n      return;\n    }\n\n    // Only auto-select if we have no selection or the selected character is gone\n    if (characters.length > 0) {\n      const firstId = characters[0].characterId;\n      set({ selectedCharacterId: firstId });\n      localStorage.setItem('exo_selected_character', firstId);\n    }\n  },\n  setSelectedCharacter: (id) => {\n    set({ selectedCharacterId: id });\n    if (id) localStorage.setItem('exo_selected_character', id);\n    else localStorage.removeItem('exo_selected_character');\n  },\n  setDetectedSynergies: (synergies) => set({ detectedSynergies: synergies }),\n  setInventories: (data) => {\n    const state = get();\n    const incomingTimestamp = data.responseMintedTimestamp;\n    const currentTimestamp = state.responseMintedTimestamp;\n\n    // DIM STANDARD: Strict Timestamp Lockdown\n    if (incomingTimestamp && currentTimestamp && new Date(incomingTimestamp).getTime() <= new Date(currentTimestamp).getTime()) {\n      return SetInventoriesResult.DISCARDED_STALE;\n    }\n\n    const activeTransfers = new Set(state.activeTransfers);\n    const inFlightTargets = new Map(state.inFlightTargets);\n\n    // Helper to merge while ensuring exclusive positioning\n    const mergeAndClear = (incomingItems: DestinyItem[], storeId: string, currentLocalItems: DestinyItem[]) => {\n      // Phase 1: Filter out items that are currently in-flight to a DIFFERENT store\n      let filteredItems = incomingItems.filter(item => {\n        const instanceId = item.itemInstanceId;\n        if (!instanceId) return true;\n\n        if (activeTransfers.has(instanceId)) {\n          const targetId = inFlightTargets.get(instanceId);\n          // If this is NOT the target store, the item shouldn't be here (it's in-flight)\n          if (targetId !== storeId) return false;\n\n          // If this IS the target store, we'll handle it in Phase 2\n          return true;\n        }\n        return true;\n      });\n\n      // Phase 2: Ensure in-flight items for THIS store are present and protected\n      const finalItems = [...filteredItems];\n      for (const [instanceId, targetId] of inFlightTargets.entries()) {\n        if (targetId === storeId) {\n          const foundIndex = finalItems.findIndex(i => i.itemInstanceId === instanceId);\n\n          // If the item is already in the API response for this store, we've arrived!\n          if (foundIndex !== -1) {\n            activeTransfers.delete(instanceId);\n            inFlightTargets.delete(instanceId);\n          } else {\n            // Item hasn't reached API yet, inject the local version to maintain optimistic state\n            const localItem = currentLocalItems.find(i => i.itemInstanceId === instanceId);\n            if (localItem) finalItems.push(localItem);\n          }\n        }\n      }\n\n      return finalItems;\n    }; const finalCharInventories: Record<string, DestinyItem[]> = {};\n    Object.keys(data.characterInventories || {}).forEach(charId => {\n      finalCharInventories[charId] = mergeAndClear(data.characterInventories[charId], charId, state.characterInventories[charId] || []);\n    });\n    const finalCharEquipment: Record<string, DestinyItem[]> = {};\n    Object.keys(data.characterEquipment || {}).forEach(charId => {\n      finalCharEquipment[charId] = mergeAndClear(data.characterEquipment[charId], charId, state.characterEquipment[charId] || []);\n    });\n    const finalVault = mergeAndClear(data.vaultInventory, 'vault', state.vaultInventory);\n    set({\n      ...data,\n      characterInventories: finalCharInventories,\n      characterEquipment: finalCharEquipment,\n      vaultInventory: finalVault,\n      activeTransfers,\n      inFlightTargets,\n      responseMintedTimestamp: data.responseMintedTimestamp || state.responseMintedTimestamp,\n      profilePlugSets: data.profilePlugSets || state.profilePlugSets,\n      characterPlugSets: data.characterPlugSets || state.characterPlugSets,\n      lastUpdated: Date.now()\n    });\n    return SetInventoriesResult.ACCEPTED;\n  },\n  setLoading: (isLoading) => set({ isLoading }),\n  setEquipping: (isEquipping) => set({ isEquipping }),\n  updateItemInstance: (instanceId: string, updates: Partial<ItemInstance>) => set(state => ({\n    itemInstances: {\n      ...state.itemInstances,\n      [instanceId]: { ...state.itemInstances[instanceId], ...updates }\n    },\n    lastUpdated: Date.now()\n  })),\n  updateItemSocket: (instanceId: string, socketIndex: number, plugHash: number, plugName?: string, plugIcon?: string) => set(state => {\n    const instance = state.itemInstances[instanceId];\n    if (!instance || !instance.sockets) return state;\n\n    const newSockets = [...instance.sockets];\n    const sIdx = newSockets.findIndex(s => s.socketIndex === socketIndex);\n\n    if (sIdx !== -1) {\n      newSockets[sIdx] = {\n        ...newSockets[sIdx],\n        plugHash,\n        isEnabled: true,\n        plugName: plugName || newSockets[sIdx].plugName,\n        plugIcon: plugIcon || newSockets[sIdx].plugIcon\n      };\n    } else {\n      // If not found by index property, try array position\n      if (socketIndex < newSockets.length) {\n        newSockets[socketIndex] = {\n          ...newSockets[socketIndex],\n          plugHash,\n          isEnabled: true,\n          plugName: plugName || newSockets[socketIndex].plugName,\n          plugIcon: plugIcon || newSockets[socketIndex].plugIcon\n        };\n      }\n    }\n\n    return {\n      itemInstances: {\n        ...state.itemInstances,\n        [instanceId]: { ...instance, sockets: newSockets }\n      },\n      lastUpdated: Date.now()\n    };\n  }),\n  addActiveTransfer: (instanceId, targetId) => {\n    const activeTransfers = new Set(get().activeTransfers);\n    const inFlightTargets = new Map(get().inFlightTargets);\n    activeTransfers.add(instanceId);\n    if (targetId) inFlightTargets.set(instanceId, targetId);\n    set({ activeTransfers, inFlightTargets, lastUpdated: Date.now() });\n  },\n  removeActiveTransfer: (instanceId, success = false, failure = false) => {\n    const activeTransfers = new Set(get().activeTransfers);\n    const inFlightTargets = new Map(get().inFlightTargets);\n    const successfulTransfers = new Set(get().successfulTransfers);\n    const failedTransfers = new Set(get().failedTransfers);\n    if (success) {\n      successfulTransfers.add(instanceId);\n      failedTransfers.delete(instanceId);\n    } else if (failure) {\n      failedTransfers.add(instanceId);\n      activeTransfers.delete(instanceId);\n      inFlightTargets.delete(instanceId);\n    }\n    set({ activeTransfers, inFlightTargets, successfulTransfers, failedTransfers, lastUpdated: Date.now() });\n  },\n  clearSuccessfulTransfer: (instanceId) => set((state) => {\n    const successful = new Set(state.successfulTransfers);\n    successful.delete(instanceId);\n    return { successfulTransfers: successful };\n  }),\n  clearFailedTransfer: (instanceId) => set((state) => {\n    const failed = new Set(state.failedTransfers);\n    failed.delete(instanceId);\n    return { failedTransfers: failed };\n  }),\n  getSelectedCharacter: () => {\n    const state = get();\n    return state.characters.find(c => c.characterId === state.selectedCharacterId);\n  },\n  getAllInventory: () => {\n    const state = get();\n    return [...state.vaultInventory, ...Object.values(state.characterInventories).flat(), ...Object.values(state.characterEquipment).flat()];\n  },\n  saveVirtualLoadout: (loadout) => {\n    const updated = { ...get().virtualLoadouts, [loadout.id]: loadout };\n    localStorage.setItem('exo_virtual_loadouts', JSON.stringify(updated));\n    set({ virtualLoadouts: updated });\n  },\n  deleteVirtualLoadout: (id) => {\n    const updated = { ...get().virtualLoadouts };\n    delete updated[id];\n    localStorage.setItem('exo_virtual_loadouts', JSON.stringify(updated));\n    set({ virtualLoadouts: updated });\n  },\n  clear: () => {\n    localStorage.removeItem('exo_selected_character');\n    set({\n      characters: [], selectedCharacterId: null, characterInventories: {}, characterEquipment: {}, vaultInventory: [],\n      itemInstances: {}, artifact: null, characterProgressions: null, isLoading: false, isEquipping: false, lastUpdated: null,\n      responseMintedTimestamp: null, activeTransfers: new Set(), inFlightTargets: new Map(), successfulTransfers: new Set(), failedTransfers: new Set(), detectedSynergies: null,\n      profilePlugSets: null, characterPlugSets: null\n    });\n  },\n  hydrateFromCache: async () => {\n    try {\n      const cached = await idbGet<any>('exo_profile_cache');\n      if (cached) {\n        set({ ...cached, isLoading: false });\n        return true;\n      }\n    } catch (e) {\n      warnLog('ProfileStore', 'Failed to hydrate cache', e);\n    }\n    return false;\n  }\n}));\n\n// ===== UI Store =====\ninterface UIState {\n  currentTab: string;\n  sidebarOpen: boolean;\n  builderView: 'character' | 'subclass' | 'exotics' | 'generator';\n  builderSubView: any;\n  hideGlobalUI: boolean;\n  transmatEffect: 'none' | 'success' | 'failure';\n  introComplete: boolean;\n  globalTransmat: 'none' | 'success' | 'failure';\n  selectedSubclass: { hash: number; itemInstanceId?: string } | null;\n\n  setTab: (tab: string) => void;\n  setSidebarOpen: (open: boolean) => void;\n  setBuilderView: (view: 'character' | 'subclass' | 'exotics' | 'generator', subView?: any) => void;\n  setHideGlobalUI: (hide: boolean) => void;\n  triggerGlobalTransmat: (effect: 'success' | 'failure') => void;\n  setIntroComplete: (complete: boolean) => void;\n  setSelectedSubclass: (subclass: { hash: number; itemInstanceId?: string } | null) => void;\n}\n\nexport const useUIStore = create<UIState>((set) => ({\n  currentTab: 'galaxy',\n  sidebarOpen: false,\n  builderView: 'character',\n  builderSubView: null,\n  hideGlobalUI: false,\n  transmatEffect: 'none',\n  introComplete: true,\n  globalTransmat: 'none',\n  selectedSubclass: null,\n\n  setTab: (tab) => set({ currentTab: tab }),\n  setSidebarOpen: (open) => set({ sidebarOpen: open }),\n  setBuilderView: (view, subView = null) => set({ builderView: view, builderSubView: subView }),\n  setHideGlobalUI: (hide) => set({ hideGlobalUI: hide }),\n  triggerGlobalTransmat: (effect) => {\n    set({ transmatEffect: effect, globalTransmat: effect });\n    setTimeout(() => set({ transmatEffect: 'none', globalTransmat: 'none' }), 2500);\n  },\n  setIntroComplete: (introComplete) => set({ introComplete }),\n  setSelectedSubclass: (selectedSubclass) => set({ selectedSubclass })\n}));\n\n// ===== Manifest Store =====\ninterface ManifestState {\n  isLoaded: boolean;\n  isLoading: boolean;\n  loadingProgress: number;\n  error: string | null;\n  lastUpdated: number | null;\n  setLoaded: (loaded: boolean) => void;\n  setLoading: (loading: boolean) => void;\n  setProgress: (progress: number, table?: string) => void;\n  setError: (error: string | null) => void;\n}\n\nexport const useManifestStore = create<ManifestState>((set) => ({\n  isLoaded: false,\n  isLoading: false,\n  loadingProgress: 0,\n  error: null,\n  lastUpdated: null,\n  setLoaded: (isLoaded) => set({ isLoaded, lastUpdated: Date.now() }),\n  setLoading: (isLoading) => set({ isLoading }),\n  setProgress: (loadingProgress) => set({ loadingProgress }),\n  setError: (error) => set({ error })\n}));\n\n// ===== Settings Store =====\ninterface SettingsState {\n  performanceMode: 'low' | 'medium' | 'high';\n  maxSynergies: number;\n  organizedGalaxy: boolean;\n  randomVaultSeed: number;\n  customCursor: boolean;\n  viewMode: 'all' | 'exotics';\n  deviceMode: 'pc' | 'mobile';\n  imageSize: number;\n  ownedExpansions: Expansion[];\n  isExpansionOwned: (expansion: Expansion) => boolean;\n  ghostFarming: boolean;\n  showFps: boolean;\n  immersiveMode: boolean;\n  setPerformanceMode: (mode: 'high' | 'medium' | 'low') => void;\n  setMaxSynergies: (count: number) => void;\n  setOrganizedGalaxy: (organized: boolean) => void;\n  toggleOrganizedGalaxy: () => void;\n  rotateVaultSeed: () => void;\n  toggleCustomCursor: () => void;\n  setViewMode: (mode: 'all' | 'exotics') => void;\n  setDeviceMode: (mode: 'pc' | 'mobile') => void;\n  setImageSize: (size: number) => void;\n  setOwnedExpansions: (expansions: Expansion[]) => void;\n  toggleGhostFarming: () => void;\n  toggleShowFps: () => void;\n  toggleImmersiveMode: () => void;\n}\n\nexport const useSettingsStore = create<SettingsState>((set, get) => ({\n  performanceMode: 'high',\n  maxSynergies: 10,\n  organizedGalaxy: false,\n  randomVaultSeed: Math.random(),\n  customCursor: true,\n  viewMode: 'all',\n  deviceMode: 'pc',\n  imageSize: 84,\n  ownedExpansions: [],\n  isExpansionOwned: (exp) => get().ownedExpansions.includes(exp),\n  ghostFarming: false,\n  showFps: false,\n  immersiveMode: true, // Default ON for immersive space-drift feel\n\n  setPerformanceMode: (performanceMode) => set({ performanceMode }),\n  setMaxSynergies: (maxSynergies) => set({ maxSynergies }),\n  setOrganizedGalaxy: (organizedGalaxy) => set({ organizedGalaxy }),\n  toggleOrganizedGalaxy: () => set(state => ({ organizedGalaxy: !state.organizedGalaxy })),\n  rotateVaultSeed: () => set({ randomVaultSeed: Math.random() }),\n  toggleCustomCursor: () => set(state => ({ customCursor: !state.customCursor })),\n  setViewMode: (viewMode) => set({ viewMode }),\n  setDeviceMode: (deviceMode) => set({ deviceMode }),\n  setImageSize: (imageSize) => set({ imageSize }),\n  setOwnedExpansions: (ownedExpansions) => set({ ownedExpansions }),\n  toggleGhostFarming: () => set(state => ({ ghostFarming: !state.ghostFarming })),\n  toggleShowFps: () => set(state => ({ showFps: !state.showFps })),\n  toggleImmersiveMode: () => set(state => ({ immersiveMode: !state.immersiveMode }))\n}));\n\n// ===== Toast Store =====\ninterface ToastState {\n  toasts: Toast[];\n  addToast: (toast: Omit<Toast, 'id' | 'timestamp'>) => void;\n  removeToast: (id: string) => void;\n}\n\nexport const useToastStore = create<ToastState>((set) => ({\n  toasts: [],\n  addToast: (toast) => {\n    const id = Math.random().toString(36).substring(2, 9);\n    const newToast = { ...toast, id, timestamp: Date.now() };\n    set((state) => ({ toasts: [...state.toasts, newToast] }));\n    setTimeout(() => {\n      set((state) => ({ toasts: state.toasts.filter((t) => t.id !== id) }));\n    }, toast.duration || 5000);\n  },\n  removeToast: (id) => set((state) => ({ toasts: state.toasts.filter((t) => t.id !== id) })),\n}));\n\n// ===== Saved Builds Store =====\ninterface SavedBuildsState {\n  builds: SavedBuild[];\n  isLoading: boolean;\n  error: string | null;\n  loadBuilds: () => Promise<void>;\n  addBuild: (build: SavedBuild) => Promise<void>;\n  removeBuild: (id: string) => Promise<void>;\n  setLoading: (isLoading: boolean) => void;\n  setBuilds: (builds: SavedBuild[]) => void;\n}\n\nexport const useSavedBuildsStore = create<SavedBuildsState>((set) => ({\n  builds: [],\n  isLoading: false,\n  error: null,\n  loadBuilds: async () => {\n    set({ isLoading: true });\n    try {\n      const builds = await idbGet<SavedBuild[]>('exo_saved_builds') || [];\n      set({ builds, isLoading: false });\n    } catch (e) {\n      set({ error: 'Failed to load builds', isLoading: false });\n    }\n  },\n  addBuild: async (build) => {\n    set(state => {\n      const next = [...state.builds, build];\n      idbSet('exo_saved_builds', next);\n      return { builds: next };\n    });\n  },\n  removeBuild: async (id) => {\n    set(state => {\n      const next = state.builds.filter(b => b.id !== id);\n      idbSet('exo_saved_builds', next);\n      return { builds: next };\n    });\n  },\n  setLoading: (isLoading) => set({ isLoading }),\n  setBuilds: (builds) => set({ builds })\n}));\n\n// ===== Generator Store =====\ninterface GeneratorState {\n  isSpinning: boolean;\n  currentBuild: BuildTemplate | string | null;\n  lockedSlots: Record<string, boolean>;\n  setSpinning: (isSpinning: boolean) => void;\n  setCurrentBuild: (build: BuildTemplate | string | null) => void;\n  toggleLock: (slot: string) => void;\n}\n\nexport const useGeneratorStore = create<GeneratorState>((set) => ({\n  isSpinning: false,\n  currentBuild: null,\n  lockedSlots: {},\n  setSpinning: (isSpinning) => set({ isSpinning }),\n  setCurrentBuild: (currentBuild) => set({ currentBuild }),\n  toggleLock: (slot) => set(state => ({\n    lockedSlots: { ...state.lockedSlots, [slot]: !state.lockedSlots[slot] }\n  }))\n}));\n","/**\n * Clarity Service - DIM-Grade Community Descriptions\n * Fetches and manages detailed perk/mod data from the Clarity database.\n * Source: https://database-clarity.github.io/\n */\nimport { db } from '../db/indexeddb.service';\nimport { debugLog, errorLog, infoLog } from '../../utils/logger';\n\nconst CLARITY_BASE = 'https://database-clarity.github.io/';\nconst CLARITY_DESCRIPTIONS_URL = `${CLARITY_BASE}Live-Clarity-Database/descriptions/dim.json`;\nconst CLARITY_VERSION_URL = `${CLARITY_BASE}Live-Clarity-Database/versions.json`;\n\nexport interface ClarityDescription {\n  [hash: number]: {\n    name: string;\n    description: string;\n    stats?: any;\n  };\n}\n\nclass ClarityService {\n  private descriptions: ClarityDescription | null = null;\n  private isLoaded = false;\n\n  /**\n   * Load Clarity descriptions into memory, using IndexedDB cache if possible.\n   */\n  async load(): Promise<boolean> {\n    if (this.isLoaded) return true;\n\n    try {\n      // 1. Check Version\n      const versionResp = await fetch(CLARITY_VERSION_URL);\n      const versionData = await versionResp.json();\n      const liveVersion = versionData.descriptions; // DIM Standard: uses .descriptions field for versioning\n\n      // 2. Check Cache\n      const cachedVersion = await db.getClarityVersion();\n      let data = await db.getClarityDescriptions();\n\n      if (!data || cachedVersion !== liveVersion) {\n        infoLog('Clarity', `Update required: ${liveVersion} (Cached: ${cachedVersion || 'None'})`);\n        \n        const dataResp = await fetch(CLARITY_DESCRIPTIONS_URL);\n        data = await dataResp.json();\n        \n        await db.setClarityDescriptions(data!);\n        await db.setClarityVersion(liveVersion);\n      } else {\n        debugLog('Clarity', `Loading from cache (Version: ${cachedVersion})`);\n      }\n\n      this.descriptions = data;\n      this.isLoaded = true;\n      return true;\n    } catch (e) {\n      errorLog('Clarity', 'Failed to load community descriptions', e);\n      return false;\n    }\n  }\n\n  /**\n   * Get detailed community description for an item hash.\n   */\n  getDescription(hash: number): string | null {\n    if (!this.descriptions) return null;\n    const entry = this.descriptions[hash];\n    return entry?.description || null;\n  }\n\n  /**\n   * Get formatted rich data for an item (stats, durations, etc.)\n   */\n  getRichData(hash: number): any | null {\n    if (!this.descriptions) return null;\n    return this.descriptions[hash] || null;\n  }\n}\n\nexport const clarityService = new ClarityService();\n","/**\r\n * Utility to map Bungie Manifest watermark icons to readable Season names.\r\n * Watermarks are the most reliable way to identify the release version of an item.\r\n */\r\n\r\nconst SEASON_MAP: Record<string, string> = {\r\n    // Recent/Major Expansions\r\n    '6b6b779a1f11c8282b99596b42b9c5f6': 'Renegades', // Using the icon hash from AgentService\r\n    'fe76c7c25ce4af443213efc3444005b4': 'The Final Shape',\r\n    '9e46a74b0cc6c2d1b098f98ecbe1b99': 'Lightfall',\r\n    '2dd9659f80282b0f4a8e63a342468f7': 'The Witch Queen',\r\n    'e2254050d53c54fbbe2e9a2636a0fb4': 'Beyond Light',\r\n    '871790403': 'Shadowkeep',\r\n    '12ee68f23': 'Forsaken',\r\n\r\n    // Specific Seasons (Watermark hashes vary, using common identifiers)\r\n    // Season 20-23 (Lightfall Era)\r\n    'df01f93f77341fe742d4a5202ed7268': 'Season of the Wish', // S23\r\n    '22247f7149a468e2289fba8d6c1b3f6': 'Season of the Witch', // S22\r\n    '292435532': 'Season of the Deep', // S21\r\n    '342240502': 'Season of Defiance', // S20\r\n\r\n    // Prismatic Era / Renegades\r\n    'ac0090886cfa2b6389fba8d6c1b3f6': 'Episode: Echoes',\r\n    '90886cfa2b63': 'Episode: Revenant',\r\n    'renegade': 'Renegades Update'\r\n};\r\n\r\n/**\r\n * Gets the season name from a watermark icon path\r\n */\r\nexport function getSeasonNameFromWatermark(watermarkPath: string): string | undefined {\r\n    if (!watermarkPath) return undefined;\r\n\r\n    // Extract hash/identifier from path\r\n    const hash = watermarkPath.split('/').pop()?.split('.')[0];\r\n    if (!hash) return undefined;\r\n\r\n    // Check direct matches\r\n    if (SEASON_MAP[hash]) return SEASON_MAP[hash];\r\n\r\n    // Check substrings (Bungie sometimes varies file names slightly)\r\n    for (const [key, name] of Object.entries(SEASON_MAP)) {\r\n        if (hash.includes(key) || key.includes(hash)) {\r\n            return name;\r\n        }\r\n    }\r\n\r\n    return undefined;\r\n}\r\n\r\n/**\r\n * Fallback for version-based labeling if watermark is missing\r\n */\r\nexport function getSeasonNameFromVersion(version: number): string {\r\n    if (version >= 50) return 'The Final Shape';\r\n    if (version >= 40) return 'Lightfall';\r\n    if (version >= 30) return 'The Witch Queen';\r\n    if (version >= 20) return 'Beyond Light';\r\n    return 'Legacy';\r\n}\r\n\r\n/**\r\n * Determines if an item version is considered \"Legacy\" (Pre-Beyond Light / Version < 20).\r\n * Useful for determining which watermark style to apply.\r\n */\r\nexport function isLegacyVersion(version: number | undefined): boolean {\r\n    if (version === undefined) return false;\r\n    return version < 20;\r\n}\r\n\r\n","// Manifest Service\r\n// Downloads and caches the Destiny 2 manifest for item lookups\r\n\r\nimport { bungieApi } from './api-client';\r\nimport { db } from '../db/indexeddb.service';\r\nimport { clarityService } from './clarity.service';\r\nimport { BUNGIE_CONFIG } from '../../config/bungie.config';\r\nimport type { ItemDefinition } from '../../types';\r\nimport { getSeasonNameFromWatermark } from '../../utils/season-utils';\r\nimport { createLogger, infoLog, debugLog } from '../../utils/logger';\r\n\r\nconst log = createLogger('Manifest');\r\n\r\n// Extracted from DIM extended-breaker.json: Maps Modifier Hash -> Breaker Type Hash\r\nconst EXTENDED_BREAKER_MAP: Record<string, number> = {\r\n  \"17096506\": 3178805705, // Stagger\r\n  \"89619507\": 3178805705,\r\n  \"449318888\": 485622768, // Pierce\r\n  \"503025963\": 485622768,\r\n  \"511888814\": 2611060930, // Disrupt\r\n  \"1003391927\": 485622768,\r\n  \"1047932517\": 2611060930,\r\n  \"1203306857\": 3178805705,\r\n  \"1351987111\": 3178805705,\r\n  \"1443166262\": 485622768,\r\n  \"1685137410\": 3178805705,\r\n  \"1734844650\": 3178805705,\r\n  \"1955548646\": 485622768,\r\n  \"2110100341\": 3178805705,\r\n  \"2415768376\": 3178805705,\r\n  \"2474293653\": 485622768,\r\n  \"2687811401\": 2611060930,\r\n  \"2694576561\": 2611060930,\r\n  \"3118061004\": 2611060930,\r\n  \"3487253372\": 485622768,\r\n  \"3598649636\": 485622768,\r\n  \"4029987901\": 2611060930,\r\n  \"4268030601\": 485622768,\r\n  \"3497407670\": 3178805705 // Galvanized II -> Unstoppable (Stagger)\r\n};\r\n\r\n// Helper for enum conversion\r\nfunction getBreakerEnum(hash: number): number | undefined {\r\n  if (hash === 485622768) return 1; // Piercing/Barrier\r\n  if (hash === 2611060930) return 2; // Disrupt/Overload\r\n  if (hash === 3178805705) return 3; // Stagger/Unstoppable\r\n  return undefined;\r\n}\r\n\r\ninterface ManifestResponse {\r\n  version: string;\r\n  mobileWorldContentPaths: {\r\n    en: string;\r\n  };\r\n  jsonWorldContentPaths: {\r\n    en: string;\r\n  };\r\n  jsonWorldComponentContentPaths: {\r\n    en: {\r\n      DestinyInventoryItemDefinition: string;\r\n      DestinyInventoryBucketDefinition: string;\r\n      DestinyStatDefinition: string;\r\n      DestinyClassDefinition: string;\r\n      DestinyDamageTypeDefinition: string;\r\n      DestinyActivityModifierDefinition: string;\r\n      DestinyActivityDefinition: string;\r\n      DestinyBreakerTypeDefinition: string;\r\n      DestinySandboxPerkDefinition: string;\r\n      DestinySocketTypeDefinition: string;\r\n      DestinySocketCategoryDefinition: string;\r\n      DestinyPlugSetDefinition: string;\r\n      DestinyLoadoutNameDefinition: string;\r\n      DestinyLoadoutColorDefinition: string;\r\n      DestinyLoadoutIconDefinition: string;\r\n      DestinyGuardianRankDefinition: string;\r\n      DestinyGuardianRankConstantsDefinition: string;\r\n      DestinyEquipmentSetDefinition: string;\r\n      DestinySocialCommendationNodeDefinition: string;\r\n      DestinySocialCommendationDefinition: string;\r\n      DestinyRecordDefinition: string;\r\n      DestinyPresentationNodeDefinition: string;\r\n    };\r\n  };\r\n}\r\n\r\n// Tables we need for ExoEngine\r\nconst REQUIRED_TABLES = [\r\n  'DestinyInventoryItemDefinition',\r\n  'DestinyInventoryBucketDefinition',\r\n  'DestinyStatDefinition',\r\n  'DestinyClassDefinition',\r\n  'DestinyDamageTypeDefinition',\r\n  'DestinySandboxPerkDefinition',\r\n  'DestinySocketTypeDefinition',\r\n  'DestinySocketCategoryDefinition',\r\n  'DestinyPlugSetDefinition',\r\n  // Loadout identifier tables (required for SnapshotLoadout API)\r\n  'DestinyLoadoutNameDefinition',\r\n  'DestinyLoadoutColorDefinition',\r\n  'DestinyLoadoutIconDefinition',\r\n  // Activity tables (for Champion/modifier lookups)\r\n  'DestinyActivityModifierDefinition',\r\n  'DestinyActivityDefinition',\r\n  // Champion type icons\r\n  'DestinyBreakerTypeDefinition',\r\n  // Guardian Ranks (Renegades/Lightfall)\r\n  'DestinyGuardianRankDefinition',\r\n  'DestinyGuardianRankConstantsDefinition',\r\n  // Equipment Sets (Required for Set Bonus lookups)\r\n  'DestinyEquipmentSetDefinition',\r\n  // Commendations\r\n  'DestinySocialCommendationNodeDefinition',\r\n  'DestinySocialCommendationDefinition',\r\n  // Records (Triumphs) - Useful for DLC icons via Campaign records\r\n  'DestinyRecordDefinition',\r\n  // Presentation Nodes - Best source for UI categorization images (DLCs, Classes)\r\n  'DestinyPresentationNodeDefinition'\r\n] as const;\r\n\r\ntype TableName = (typeof REQUIRED_TABLES)[number];\r\n\r\n// Map of PlugCategoryHash to DamageType enum value\r\n// Used to fix incorrect default damage types for class abilities (e.g. Strand appearing as Stasis)\r\nconst CLASS_ABILITY_TO_DAMAGE_MAP: Record<number, number> = {\r\n  // Hunter\r\n  3956119552: 2, // Arc\r\n  3538316507: 3, // Solar\r\n  3673640204: 4, // Void\r\n  641408223: 6,  // Stasis\r\n  2552562702: 7, // Strand\r\n\r\n  // Titan\r\n  1281712906: 2, // Arc\r\n  1197336009: 3, // Solar\r\n  3366817658: 4, // Void\r\n  826897697: 6,  // Stasis\r\n  2480042224: 7, // Strand\r\n\r\n  // Warlock\r\n  1308084083: 2, // Arc\r\n  1662395848: 3, // Solar\r\n  3202031457: 4, // Void\r\n  1960796738: 6, // Stasis\r\n  2200902275: 7, // Strand\r\n  // Prismatic\r\n  1800170884: 8, // Prismatic\r\n};\r\n\r\nconst DAMAGE_HASH_TO_ENUM: Record<number, number> = {\r\n  3373582085: 1, // Kinetic\r\n  2303181850: 2, // Arc\r\n  1847026933: 3, // Solar\r\n  3454344768: 4, // Void\r\n  151347233: 6,  // Stasis\r\n  3949783978: 7, // Strand\r\n  1800170884: 8, // Prismatic\r\n};\r\n\r\nexport class ManifestService {\r\n  private manifestData: Partial<Record<TableName, Record<string, unknown>>> = {};\r\n  private discoveredAbilities: Record<number, Record<number, Record<string, number[]>>> = {}; // classType -> damageType -> category -> hashes\r\n  private searchCache: Record<string, any[]> = {};\r\n  private isLoading = false;\r\n  private loadPromise: Promise<void> | null = null;\r\n\r\n  // Check if we need to update the manifest\r\n  async checkForUpdate(): Promise<{ needsUpdate: boolean; version: string }> {\r\n    try {\r\n      const manifestInfo = await bungieApi.get<ManifestResponse>(\r\n        BUNGIE_CONFIG.endpoints.manifest\r\n      );\r\n\r\n      const currentVersion = await db.getManifestVersion();\r\n      let needsUpdate = !currentVersion || currentVersion !== manifestInfo.version;\r\n\r\n      if (!needsUpdate) {\r\n        infoLog('Manifest', `Cache check: Version ${currentVersion} matches Bungie. Checking tables...`);\r\n      }\r\n\r\n      // Even if version matches, check if any required tables are missing from IndexedDB\r\n      // This handles cases where we've added a new table to REQUIRED_TABLES\r\n      if (!needsUpdate) {\r\n        const availableTables = manifestInfo.jsonWorldComponentContentPaths.en;\r\n        for (const tableName of REQUIRED_TABLES) {\r\n          // Only check/require tables that are actually available in this manifest version\r\n          if (!availableTables[tableName]) continue;\r\n\r\n          const tableData = await db.getManifestTable(tableName);\r\n          if (!tableData) {\r\n            infoLog('Manifest', `Forcing update: Table ${tableName} is missing from cache.`);\r\n            needsUpdate = true;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (needsUpdate && currentVersion === manifestInfo.version) {\r\n        infoLog('Manifest', `Manifest version matches (${currentVersion || 'None'}), but required tables are missing from cache.`);\r\n      } else if (needsUpdate) {\r\n        infoLog('Manifest', `Manifest update required: ${manifestInfo.version} (Current: ${currentVersion || 'None'})`);\r\n      } else {\r\n        debugLog('Manifest', `Manifest is up to date (${currentVersion})`);\r\n      }\r\n\r\n      return {\r\n        needsUpdate,\r\n        version: manifestInfo.version,\r\n      };\r\n    } catch (error) {\r\n      log.error('Failed to check manifest version:', error);\r\n      return { needsUpdate: true, version: '' };\r\n    }\r\n  }\r\n\r\n  // Load manifest (from cache or download)\r\n  async load(\r\n    onProgress?: (table: string, progress: number) => void\r\n  ): Promise<void> {\r\n    if (this.loadPromise) {\r\n      return this.loadPromise;\r\n    }\r\n\r\n    this.loadPromise = this.doLoad(onProgress);\r\n\r\n    try {\r\n      await this.loadPromise;\r\n    } finally {\r\n      this.loadPromise = null;\r\n    }\r\n  }\r\n\r\n  private async doLoad(\r\n    onProgress?: (table: string, progress: number) => void\r\n  ): Promise<void> {\r\n    if (this.isLoading) return;\r\n    this.isLoading = true;\r\n\r\n    try {\r\n      const { needsUpdate, version } = await this.checkForUpdate();\r\n\r\n      if (needsUpdate) {\r\n        log.info('Downloading new manifest version:', version);\r\n        await this.downloadManifest(onProgress);\r\n      } else {\r\n        log.info('Loading manifest from cache');\r\n        await this.loadFromCache(onProgress);\r\n      }\r\n\r\n      // DIM Standard: Background fetch community perk descriptions\r\n      clarityService.load();\r\n    } finally {\r\n      this.isLoading = false;\r\n    }\r\n  }\r\n\r\n  public async createManifestDatabase(): Promise<void> {\r\n    await db.clearManifest();\r\n  }\r\n\r\n  public async downloadManifest(\r\n    onProgress?: (table: string, progress: number) => void\r\n  ): Promise<void> {\r\n    // Cross-tab concurrency control using WebLocks\r\n    // This prevents multiple browser tabs from hitting the Bungie API \r\n    // and updating IndexedDB simultaneously for the same manifest version.\r\n    if (!navigator.locks) {\r\n      // Fallback for older browsers (unlikely for ExoEngine users)\r\n      return this.doDownloadManifest(onProgress);\r\n    }\r\n\r\n    return navigator.locks.request('manifest_download', async () => {\r\n      // Re-check version inside the lock - another tab might have finished while we waited\r\n      const { needsUpdate } = await this.checkForUpdate();\r\n      if (!needsUpdate) {\r\n        log.info('Manifest already updated by another tab.');\r\n        await this.loadFromCache(onProgress);\r\n        return;\r\n      }\r\n\r\n      return this.doDownloadManifest(onProgress);\r\n    });\r\n  }\r\n\r\n  private async doDownloadManifest(\r\n    onProgress?: (table: string, progress: number) => void\r\n  ): Promise<void> {\r\n    const manifestInfo = await bungieApi.get<ManifestResponse>(\r\n      BUNGIE_CONFIG.endpoints.manifest\r\n    );\r\n\r\n    const componentPaths = manifestInfo.jsonWorldComponentContentPaths.en;\r\n\r\n    // Download tables in parallel (DIM Strategy)\r\n    let completedTables = 0;\r\n    const totalTables = REQUIRED_TABLES.length;\r\n\r\n    const tablePromises = REQUIRED_TABLES.map(async (tableName, _index) => {\r\n      const path = componentPaths[tableName];\r\n      if (!path) return;\r\n\r\n      const cacheBusters = [\r\n        `?v=${manifestInfo.version.replace(/[^a-zA-Z0-9]/g, '')}`,\r\n        `?cb=${Math.random().toString(36).substring(7)}`,\r\n        `?retry=${Date.now()}`\r\n      ];\r\n\r\n      let lastError: any = null;\r\n      let data: any = null;\r\n\r\n      // Aggressive cache-busting retry loop (Better than human/DIM)\r\n      for (const buster of cacheBusters) {\r\n        try {\r\n          const url = `${BUNGIE_CONFIG.bungieNetOrigin}${path}${buster}`;\r\n          const response = await fetch(url);\r\n\r\n          if (!response.ok) {\r\n            throw new Error(`Failed to download ${tableName} (Status: ${response.status})`);\r\n          }\r\n\r\n          data = await response.json();\r\n          if (data && typeof data === 'object') break; // Success\r\n        } catch (error) {\r\n          lastError = error;\r\n          log.warn(`Manifest retry for ${tableName} using ${buster}...`);\r\n        }\r\n      }\r\n\r\n      if (!data) {\r\n        throw lastError || new Error(`Failed to download ${tableName} after all retries.`);\r\n      }\r\n\r\n      // Prune data before storing (DIM Strategy)\r\n      data = this.trimTable(tableName, data);\r\n\r\n      // Store in IndexedDB\r\n      await db.setManifestTable(tableName, data as any);\r\n\r\n      // Keep in memory\r\n      this.manifestData[tableName] = data;\r\n\r\n      completedTables++;\r\n      const progress = (completedTables / totalTables) * 100;\r\n      onProgress?.(tableName, progress);\r\n\r\n      // Single consolidated log with progress counter\r\n      log.info(`Downloading manifest tables (${completedTables}/${totalTables}): ${tableName} (${Object.keys(data).length} entries)`);\r\n    });\r\n\r\n    try {\r\n      await Promise.all(tablePromises);\r\n\r\n      // Save version\r\n      await db.setManifestVersion(manifestInfo.version);\r\n      onProgress?.('Complete', 100);\r\n\r\n      // Summary log\r\n      log.success(`Manifest download complete: ${totalTables} tables loaded`);\r\n      this.discoverSubclassComponents();\r\n    } catch (error) {\r\n      log.error('Failed to download all manifest tables:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private trimTable(_tableName: TableName, table: Record<string, any>): Record<string, any> {\r\n    // DISABLE TRIMMING FOR DIAGNOSTICS\r\n    return table;\r\n  }\r\n\r\n  private async loadFromCache(\r\n    onProgress?: (table: string, progress: number) => void\r\n  ): Promise<void> {\r\n    const totalTables = REQUIRED_TABLES.length;\r\n    const manifestInfo = await bungieApi.get<ManifestResponse>(\r\n      BUNGIE_CONFIG.endpoints.manifest\r\n    );\r\n\r\n    for (let i = 0; i < REQUIRED_TABLES.length; i++) {\r\n      const tableName = REQUIRED_TABLES[i];\r\n      onProgress?.(tableName, (i / totalTables) * 100);\r\n\r\n      let data = await db.getManifestTable(tableName);\r\n\r\n      if (!data) {\r\n        // Table missing from cache, LAZY RECOVERY: Download only this table\r\n        log.warn(`Table ${tableName} missing from cache, fetching...`);\r\n        const tableUrl = manifestInfo.jsonWorldComponentContentPaths.en[tableName];\r\n        if (tableUrl) {\r\n          data = await bungieApi.get<Record<string, unknown>>(tableUrl, false);\r\n          await db.setManifestTable(tableName, data);\r\n        }\r\n      }\r\n\r\n      if (data) {\r\n        this.manifestData[tableName] = data;\r\n      }\r\n    }\r\n\r\n    onProgress?.('Complete', 100);\r\n    this.discoverSubclassComponents();\r\n  }\r\n\r\n  private discoverSubclassComponents(): void {\r\n    const items = this.manifestData.DestinyInventoryItemDefinition as Record<string, RawItemDefinition>;\r\n    if (!items) return;\r\n\r\n    // reset discovery\r\n    this.discoveredAbilities = {\r\n      0: {}, 1: {}, 2: {}, 3: {} // Titan, Hunter, Warlock, Neutral\r\n    };\r\n    this.searchCache = {};\r\n\r\n    // Use plugCategoryIdentifier strings for reliable detection\r\n    const plugCategoryMap: Record<string, string> = {\r\n      'supers': 'SUPER',\r\n      'super': 'SUPER',\r\n      'class_abilities': 'CLASS_ABILITIES',\r\n      'class_ability': 'CLASS_ABILITIES',\r\n      'melee': 'MELEE',\r\n      'grenades': 'GRENADES',\r\n      'grenade': 'GRENADES',\r\n      'movement': 'JUMP',\r\n      'jump': 'JUMP',\r\n      'aspects': 'ASPECTS',\r\n      'aspect': 'ASPECTS',\r\n      'stasis_aspects': 'ASPECTS',\r\n      'fragments': 'FRAGMENTS',\r\n      'fragment': 'FRAGMENTS',\r\n      'whisper': 'FRAGMENTS',\r\n      'stasis_fragments': 'FRAGMENTS',\r\n      // Prismatic-specific identifiers\r\n      'prismatic_aspects': 'ASPECTS',\r\n      'prismatic_fragments': 'PRISMATIC_FRAGMENTS',\r\n      'prismatic': 'PRISMATIC_FRAGMENTS'\r\n    };\r\n\r\n    for (const item of Object.values(items)) {\r\n      // Must have name and icon to be valid\r\n      if (!item.displayProperties?.name || item.displayProperties.name === 'Unknown' || !item.displayProperties.icon) {\r\n        continue;\r\n      }\r\n\r\n      // Skip \"Attributes\", Ornaments, Weapons (3), and Armor (2)\r\n      if (item.displayProperties.name === 'Attributes') continue;\r\n      if (item.itemSubType === 21 || item.displayProperties.name.includes('Ornament')) continue;\r\n      if (item.itemType === 2 || item.itemType === 3) continue;\r\n\r\n      // Skip internal items: Catalysts, Masterworks, Empty Sockets, Unfocused, and general noise\r\n      const lowerName = item.displayProperties.name.toLowerCase();\r\n      const lowerType = (item.itemTypeDisplayName || '').toLowerCase();\r\n      if (lowerName.includes('catalyst') || lowerType.includes('catalyst')) continue;\r\n      if (lowerName.includes('masterwork') || lowerType.includes('masterwork')) continue;\r\n      if (lowerName.includes('empty') || lowerName.includes('socket')) continue;\r\n      if (lowerName.includes('unfocused') || lowerName.includes('placeholder')) continue;\r\n      if (item.hash === 3696633656) continue; // Default plug hash\r\n\r\n      // Get plug category identifier if available\r\n      const plugCatId = (item as any).plug?.plugCategoryIdentifier?.toLowerCase() || '';\r\n\r\n      // Determine category from plugCategoryIdentifier\r\n      let categoryLabel: string | undefined;\r\n      for (const [key, label] of Object.entries(plugCategoryMap)) {\r\n        // Use regex for word boundaries to avoid matching \"grenade\" in \"grenade_launcher\"\r\n        const regex = new RegExp(`(^|[._])${key}([._]|$)`, 'i');\r\n        if (regex.test(plugCatId)) {\r\n          categoryLabel = label;\r\n          break;\r\n        }\r\n      }\r\n\r\n      // Special handling for Prismatic fragments (Facets)\r\n      if (item.displayProperties.name.startsWith('Facet of')) {\r\n        categoryLabel = 'PRISMATIC_FRAGMENTS';\r\n      }\r\n\r\n      // Also check itemTypeDisplayName for fragments/aspects\r\n      const typeDisplay = (item.itemTypeDisplayName || '').toLowerCase();\r\n      if (!categoryLabel) {\r\n        // Regex word boundary check \\b to avoid \"Grenade Launcher\" matching \"Grenade\"\r\n        if (/\\bsuper\\b/.test(typeDisplay)) categoryLabel = 'SUPER';\r\n        else if (/\\baspect\\b/.test(typeDisplay)) categoryLabel = 'ASPECTS';\r\n        else if (/\\bfragment\\b/.test(typeDisplay)) categoryLabel = 'FRAGMENTS';\r\n        else if (/\\bgrenade\\b/.test(typeDisplay)) {\r\n          // Double check it's not a launcher\r\n          if (!typeDisplay.includes('launcher')) categoryLabel = 'GRENADES';\r\n        }\r\n        else if (/\\bmelee\\b/.test(typeDisplay)) categoryLabel = 'MELEE';\r\n        else if (typeDisplay.includes('class ability')) categoryLabel = 'CLASS_ABILITIES';\r\n        else if (typeDisplay.includes('jump') || typeDisplay.includes('glide') || typeDisplay.includes('lift')) categoryLabel = 'JUMP';\r\n      }\r\n\r\n      if (!categoryLabel) continue;\r\n\r\n      const classType = item.classType ?? 3; // 3 = neutral/all classes\r\n\r\n      // Normalize Damage Type\r\n      let damageType = item.defaultDamageType || 0;\r\n      if (damageType > 100) {\r\n        damageType = DAMAGE_HASH_TO_ENUM[damageType] || 0;\r\n      }\r\n\r\n      // Fix for class abilities/jump/etc that might be Neutral in manifest but belong to an element\r\n      if (damageType === 0 && (item as any).plug?.plugCategoryHash) {\r\n        const forced = CLASS_ABILITY_TO_DAMAGE_MAP[(item as any).plug.plugCategoryHash];\r\n        if (forced !== undefined) damageType = forced;\r\n      }\r\n\r\n      // Robust Prismatic detection\r\n      const isPrismatic =\r\n        plugCatId.includes('prismatic') ||\r\n        categoryLabel === 'PRISMATIC_FRAGMENTS' ||\r\n        item.displayProperties.name.startsWith('Facet of') ||\r\n        (item.itemTypeDisplayName || '').toLowerCase().includes('prismatic');\r\n\r\n      if (isPrismatic) {\r\n        damageType = 8;\r\n        if (categoryLabel === 'FRAGMENTS') categoryLabel = 'PRISMATIC_FRAGMENTS';\r\n      }\r\n\r\n      if (!this.discoveredAbilities[classType]) this.discoveredAbilities[classType] = {};\r\n      if (!this.discoveredAbilities[classType][damageType]) this.discoveredAbilities[classType][damageType] = {};\r\n      if (!this.discoveredAbilities[classType][damageType][categoryLabel]) {\r\n        this.discoveredAbilities[classType][damageType][categoryLabel] = [];\r\n      }\r\n\r\n      this.discoveredAbilities[classType][damageType][categoryLabel].push(item.hash);\r\n    }\r\n    log.info('Subclass component discovery complete.');\r\n  }\r\n\r\n  getDiscoveredAbilities(classType: number, damageType: number): Record<string, number[]> {\r\n    return (this.discoveredAbilities[classType] && this.discoveredAbilities[classType][damageType]) || {};\r\n  }\r\n\r\n  /**\r\n   * Get all discovered subclass components for the toolbar\r\n   */\r\n  getAllSubclassComponents(): Array<{\r\n    name: string;\r\n    hash: number;\r\n    icon?: string;\r\n    category: string;\r\n    classType: number;\r\n    damageType: number;\r\n  }> {\r\n    const results: Array<{\r\n      name: string;\r\n      hash: number;\r\n      icon?: string;\r\n      category: string;\r\n      classType: number;\r\n      damageType: number;\r\n    }> = [];\r\n\r\n    for (const [classType, damageTypes] of Object.entries(this.discoveredAbilities)) {\r\n      for (const [damageType, categories] of Object.entries(damageTypes)) {\r\n        for (const [category, hashes] of Object.entries(categories)) {\r\n          hashes.forEach(hash => {\r\n            const item = this.getItem(hash);\r\n            if (item) {\r\n              results.push({\r\n                name: item.displayProperties.name,\r\n                hash: item.hash,\r\n                icon: item.displayProperties.icon,\r\n                category: category,\r\n                classType: Number(classType),\r\n                damageType: Number(damageType)\r\n              });\r\n            }\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    const items = this.manifestData.DestinyInventoryItemDefinition as Record<string, RawItemDefinition>;\r\n    if (items) {\r\n      for (const [hash, item] of Object.entries(items)) {\r\n        if (item.itemType === 16 && item.displayProperties?.name && item.displayProperties.icon) {\r\n          const lowerName = item.displayProperties.name.toLowerCase();\r\n          if (lowerName.includes('unfocused') || lowerName.includes('empty') || lowerName.includes('socket') || lowerName.includes('catalyst')) continue;\r\n\r\n          results.push({\r\n            name: item.displayProperties.name,\r\n            hash: Number(hash),\r\n            icon: item.displayProperties.icon, // Don't prepend, let getBungieUrl handle it\r\n            category: 'SUBCLASS',\r\n            classType: item.classType ?? 3,\r\n            damageType: (item.defaultDamageType && item.defaultDamageType > 100)\r\n              ? (DAMAGE_HASH_TO_ENUM[item.defaultDamageType] || 0)\r\n              : (item.defaultDamageType || 0)\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Final sort: By Element (DamageType) first, then Class, then Name\r\n    return results.sort((a, b) => {\r\n      // Sort by Element first (DamageType enum)\r\n      // We want to group by element so all Solar are together, etc.\r\n      // 1:Kinetic, 2:Arc, 3:Solar, 4:Void, 6:Stasis, 7:Strand, 8:Prismatic\r\n      if (a.damageType !== b.damageType) return a.damageType - b.damageType;\r\n\r\n      // Then sort by Class ID (Titan=0, Hunter=1, Warlock=2, Neutral=3)\r\n      if (a.classType !== b.classType) return a.classType - b.classType;\r\n\r\n      // Finally alphabetical by name\r\n      return a.name.localeCompare(b.name);\r\n    });\r\n  }\r\n\r\n\r\n  // Lookup methods\r\n  getItem(hash: number | string): ItemDefinition | undefined {\r\n    const items = this.manifestData.DestinyInventoryItemDefinition as Record<\r\n      string,\r\n      RawItemDefinition\r\n    >;\r\n\r\n    if (!items) return undefined;\r\n\r\n    // Try straight string (typically unsigned)\r\n    let item = items[String(hash)];\r\n\r\n    // If not found, try signed integer string (common Bungie API issue)\r\n    if (!item) {\r\n      const signedHash = Number(hash) | 0; // Force 32-bit signed\r\n      item = items[String(signedHash)];\r\n    }\r\n\r\n    if (!item) return undefined;\r\n\r\n    return this.transformItemDefinition(item);\r\n  }\r\n\r\n  // Get any icon - tries item definition first, then sandbox perks, then records\r\n  getIcon(hash: number | string): string | undefined {\r\n    const item = this.getItem(hash);\r\n    if (item?.displayProperties?.icon) return item.displayProperties.icon;\r\n\r\n    // Try sandbox perks (for abilities, mods, etc.)\r\n    const perks = this.manifestData.DestinySandboxPerkDefinition as Record<string, any>;\r\n    if (perks) {\r\n      const perkId = String(hash);\r\n      const perk = perks[perkId];\r\n      if (perk?.displayProperties?.icon) return perk.displayProperties.icon;\r\n\r\n      // Try signed hash\r\n      const signedHash = Number(hash) | 0;\r\n      const signedPerk = perks[String(signedHash)];\r\n      if (signedPerk?.displayProperties?.icon) return signedPerk.displayProperties.icon;\r\n    }\r\n\r\n    // Try records (Triumphs)\r\n    const record = this.getRecord(hash);\r\n    if (record?.icon) return record.icon;\r\n\r\n    return undefined;\r\n  }\r\n\r\n\r\n\r\n\r\n  // Get Record (Triumph) Definition\r\n  getRecord(hash: number | string): { name: string; description?: string; icon?: string; completionInfo?: any } | undefined {\r\n    const records = this.manifestData.DestinyRecordDefinition as Record<string, any> | undefined;\r\n    if (!records) return undefined;\r\n\r\n    let record = records[String(hash)];\r\n    if (!record) {\r\n      const signedHash = Number(hash) | 0;\r\n      record = records[String(signedHash)];\r\n    }\r\n\r\n    if (!record?.displayProperties) return undefined;\r\n\r\n    return {\r\n      name: record.displayProperties.name,\r\n      description: record.displayProperties.description,\r\n      icon: record.displayProperties.icon,\r\n      completionInfo: record.completionInfo\r\n    };\r\n  }\r\n\r\n  // Search for a Record by name\r\n  searchRecordByName(query: string, exact: boolean = false): { name: string; icon?: string; hash: number } | undefined {\r\n    const records = this.manifestData.DestinyRecordDefinition as Record<string, any> | undefined;\r\n    if (!records) return undefined;\r\n\r\n    const target = query.toLowerCase();\r\n\r\n    // We want to prioritize records that have icons\r\n    let bestMatch: { name: string; icon?: string; hash: number } | undefined = undefined;\r\n\r\n    for (const [hash, record] of Object.entries(records)) {\r\n      if (!record?.displayProperties?.name) continue;\r\n\r\n      const name = record.displayProperties.name.toLowerCase();\r\n      const hasIcon = !!record.displayProperties.icon;\r\n\r\n      if (exact) {\r\n        if (name === target) {\r\n          if (hasIcon) {\r\n            return {\r\n              name: record.displayProperties.name,\r\n              icon: record.displayProperties.icon,\r\n              hash: Number(hash)\r\n            };\r\n          }\r\n          if (!bestMatch) {\r\n            bestMatch = {\r\n              name: record.displayProperties.name,\r\n              icon: undefined,\r\n              hash: Number(hash)\r\n            };\r\n          }\r\n        }\r\n      } else {\r\n        if (name.includes(target)) {\r\n          if (hasIcon) {\r\n            if (!bestMatch || !bestMatch.icon) {\r\n              bestMatch = {\r\n                name: record.displayProperties.name,\r\n                icon: record.displayProperties.icon,\r\n                hash: Number(hash)\r\n              };\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return bestMatch;\r\n  }\r\n\r\n  // Get Presentation Node Definition\r\n  getPresentationNode(hash: number | string): { name: string; description?: string; icon?: string; originalIcon?: string; rootViewIcon?: string } | undefined {\r\n    const nodes = this.manifestData.DestinyPresentationNodeDefinition as Record<string, any> | undefined;\r\n    if (!nodes) return undefined;\r\n\r\n    let node = nodes[String(hash)];\r\n    if (!node) {\r\n      const signedHash = Number(hash) | 0;\r\n      node = nodes[String(signedHash)];\r\n    }\r\n\r\n    if (!node?.displayProperties) return undefined;\r\n\r\n    return {\r\n      name: node.displayProperties.name,\r\n      description: node.displayProperties.description,\r\n      icon: node.displayProperties.icon,\r\n      originalIcon: node.originalIcon,\r\n      rootViewIcon: node.rootViewIcon\r\n    };\r\n  }\r\n\r\n  // Search for presentation nodes containing a term and return all matches with icons\r\n  searchPresentationNodes(searchTerm: string): Array<{ hash: number; name: string; icon?: string; rootViewIcon?: string; originalIcon?: string; description?: string }> {\r\n    const nodes = this.manifestData.DestinyPresentationNodeDefinition as Record<string, any> | undefined;\r\n    if (!nodes) return [];\r\n\r\n    const results: Array<{ hash: number; name: string; icon?: string; rootViewIcon?: string; originalIcon?: string; description?: string }> = [];\r\n    const lowerSearch = searchTerm.toLowerCase();\r\n\r\n    for (const [hash, node] of Object.entries(nodes)) {\r\n      const name = node?.displayProperties?.name || '';\r\n      const description = node?.displayProperties?.description || '';\r\n\r\n      if (name.toLowerCase().includes(lowerSearch) || description.toLowerCase().includes(lowerSearch)) {\r\n        results.push({\r\n          hash: Number(hash),\r\n          name: name,\r\n          icon: node.displayProperties?.icon,\r\n          rootViewIcon: node.rootViewIcon,\r\n          originalIcon: node.originalIcon,\r\n          description: description\r\n        });\r\n      }\r\n    }\r\n\r\n    // Sort by: has rootViewIcon first, then has icon, then alphabetically\r\n    return results.sort((a, b) => {\r\n      if (a.rootViewIcon && !b.rootViewIcon) return -1;\r\n      if (!a.rootViewIcon && b.rootViewIcon) return 1;\r\n      if (a.icon && !b.icon) return -1;\r\n      if (!a.icon && b.icon) return 1;\r\n      return a.name.localeCompare(b.name);\r\n    });\r\n  }\r\n\r\n  // Search for a Presentation Node by name\r\n  searchPresentationNodeByName(query: string, exact: boolean = false): { name: string; icon?: string; hash: number } | undefined {\r\n    const nodes = this.manifestData.DestinyPresentationNodeDefinition as Record<string, any> | undefined;\r\n    if (!nodes) return undefined;\r\n\r\n    const target = query.toLowerCase();\r\n    let bestMatch: { name: string; icon?: string; hash: number } | undefined = undefined;\r\n\r\n    for (const [hash, node] of Object.entries(nodes)) {\r\n      if (!node?.displayProperties?.name) continue;\r\n      // Filter out empty nodes typically\r\n      if (node.displayProperties.name === '') continue;\r\n\r\n      const name = node.displayProperties.name.toLowerCase();\r\n      // Prefer icons that exist\r\n      const hasIcon = !!node.displayProperties.icon || !!node.originalIcon;\r\n      const iconPath = node.displayProperties.icon || node.originalIcon;\r\n\r\n      if (exact) {\r\n        if (name === target) {\r\n          if (hasIcon) {\r\n            return {\r\n              name: node.displayProperties.name,\r\n              icon: iconPath,\r\n              hash: Number(hash)\r\n            };\r\n          }\r\n          if (!bestMatch) bestMatch = { name: node.displayProperties.name, icon: undefined, hash: Number(hash) };\r\n        }\r\n      } else {\r\n        if (name.includes(target)) {\r\n          if (hasIcon) {\r\n            // Heuristic: Prefer exact match first, startswith second\r\n            if (!bestMatch || (name.startsWith(target) && !bestMatch.name.toLowerCase().startsWith(target))) {\r\n              bestMatch = {\r\n                name: node.displayProperties.name,\r\n                icon: iconPath,\r\n                hash: Number(hash)\r\n              };\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return bestMatch;\r\n  }\r\n\r\n  // Get activity definition\r\n  getActivity(hash: number | string): { name: string; description?: string; icon?: string; pgcrImage?: string } | undefined {\r\n    const activities = this.manifestData.DestinyActivityDefinition as Record<string, any> | undefined;\r\n    if (!activities) return undefined;\r\n\r\n    // Try straight lookup\r\n    let activity = activities[String(hash)];\r\n\r\n    // Try signed hash conversion\r\n    if (!activity) {\r\n      const signedHash = Number(hash) | 0;\r\n      activity = activities[String(signedHash)];\r\n    }\r\n\r\n    if (!activity?.displayProperties) return undefined;\r\n\r\n    return {\r\n      name: activity.displayProperties.name || '',\r\n      description: activity.displayProperties.description,\r\n      icon: activity.displayProperties.icon,\r\n      pgcrImage: activity.pgcrImage\r\n    };\r\n  }\r\n\r\n  // Get equipment set definition\r\n  getEquipmentSet(hash: number | string): any | undefined {\r\n    const sets = this.manifestData.DestinyEquipmentSetDefinition as Record<string, any> | undefined;\r\n    if (!sets) return undefined;\r\n\r\n    let setDef = sets[String(hash)];\r\n    if (!setDef) {\r\n      const signedHash = Number(hash) | 0;\r\n      setDef = sets[String(signedHash)];\r\n    }\r\n    return setDef;\r\n  }\r\n\r\n  // Get bucket definition (for weapon slots, armor slots, etc.)\r\n  getBucket(hash: number | string): { name: string; description?: string; icon?: string } | undefined {\r\n    const buckets = this.manifestData.DestinyInventoryBucketDefinition as Record<string, any> | undefined;\r\n    if (!buckets) return undefined;\r\n\r\n    // Try straight lookup\r\n    let bucket = buckets[String(hash)];\r\n    if (!bucket) {\r\n      const signedHash = Number(hash) | 0;\r\n      bucket = buckets[String(signedHash)];\r\n    }\r\n\r\n    if (!bucket?.displayProperties) return undefined;\r\n\r\n    return {\r\n      name: bucket.displayProperties.name || '',\r\n      description: bucket.displayProperties.description,\r\n      icon: bucket.displayProperties.icon\r\n    };\r\n  }\r\n\r\n  // Get stat definition (for icons/names)\r\n  getStat(hash: number | string): { name: string; description?: string; icon?: string } | undefined {\r\n    const stats = this.manifestData.DestinyStatDefinition as Record<string, any> | undefined;\r\n    if (!stats) return undefined;\r\n\r\n    // Try straight lookup\r\n    let stat = stats[String(hash)];\r\n    if (!stat) {\r\n      const signedHash = Number(hash) | 0;\r\n      stat = stats[String(signedHash)];\r\n    }\r\n\r\n    if (!stat?.displayProperties) return undefined;\r\n\r\n    return {\r\n      hash: stat.hash,\r\n      name: stat.displayProperties.name || '',\r\n      description: stat.displayProperties.description,\r\n      icon: stat.displayProperties.icon\r\n    } as any;\r\n  }\r\n\r\n  // Search for a stat definition by name (exact match, case-insensitive)\r\n  searchStatByName(name: string): { name: string; hash: number; icon?: string; description?: string } | undefined {\r\n    const stats = this.manifestData.DestinyStatDefinition as Record<string, any> | undefined;\r\n    if (!stats) return undefined;\r\n\r\n    const target = name.toLowerCase();\r\n    for (const [hash, stat] of Object.entries(stats)) {\r\n      if (stat?.displayProperties?.name?.toLowerCase() === target) {\r\n        return {\r\n          name: stat.displayProperties.name,\r\n          hash: Number(hash),\r\n          icon: stat.displayProperties.icon,\r\n          description: stat.displayProperties.description\r\n        };\r\n      }\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  // Search for an item definition by name (partial match supported)\r\n  searchItemByName(query: string, exact: boolean = false): ItemDefinition | undefined {\r\n    const items = this.manifestData.DestinyInventoryItemDefinition as Record<string, RawItemDefinition>;\r\n    if (!items) return undefined;\r\n\r\n    const target = query.toLowerCase();\r\n    for (const item of Object.values(items)) {\r\n      const name = item.displayProperties?.name?.toLowerCase();\r\n      if (!name) continue;\r\n\r\n      if (exact) {\r\n        if (name === target) return this.transformItemDefinition(item);\r\n      } else {\r\n        if (name.includes(target)) return this.transformItemDefinition(item);\r\n      }\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  // Get activity modifier definition\r\n  getActivityModifier(hash: number | string): { name: string; description?: string; icon?: string; breakerType?: number } | undefined {\r\n    const modifiers = this.manifestData.DestinyActivityModifierDefinition as Record<string, any> | undefined;\r\n    if (!modifiers) return undefined;\r\n\r\n    // Try straight lookup\r\n    let modifier = modifiers[String(hash)];\r\n\r\n    // Try signed hash conversion\r\n    if (!modifier) {\r\n      const signedHash = Number(hash) | 0;\r\n      modifier = modifiers[String(signedHash)];\r\n    }\r\n\r\n    if (!modifier?.displayProperties) return undefined;\r\n\r\n    let breakerType = modifier.breakerType;\r\n\r\n    // Fallback: Check EXTENDED_BREAKER_MAP if not found on definition\r\n    if (!breakerType && EXTENDED_BREAKER_MAP[String(hash)]) {\r\n      breakerType = getBreakerEnum(EXTENDED_BREAKER_MAP[String(hash)]);\r\n    }\r\n\r\n    // Also check signed hash\r\n    if (!breakerType) {\r\n      const signedHash = Number(hash) | 0;\r\n      if (EXTENDED_BREAKER_MAP[String(signedHash)]) {\r\n        breakerType = getBreakerEnum(EXTENDED_BREAKER_MAP[String(signedHash)]);\r\n      }\r\n    }\r\n\r\n    return {\r\n      name: modifier.displayProperties.name || '',\r\n      description: modifier.displayProperties.description,\r\n      icon: modifier.displayProperties.icon,\r\n      breakerType: breakerType\r\n    };\r\n  }\r\n\r\n  // Get breaker type (champion type) definition\r\n  // BreakerType enum: None=0, ShieldPiercing=1 (Barrier), Disruption=2 (Overload), Stagger=3 (Unstoppable)\r\n  getBreakerType(breakerType: number | string): { name: string; icon?: string } | undefined {\r\n    // Specific high-quality champion icons requested by user\r\n    const CHAMP_ICONS: Record<number, { name: string; icon: string }> = {\r\n      1: { name: 'Barrier', icon: '/common/destiny2_content/icons/2ee146c19b93b88d2c7857005fc9a8c3.png' },\r\n      2: { name: 'Overload', icon: '/common/destiny2_content/icons/f5b9dd270a544afaf2b9a726b1296501.png' },\r\n      3: { name: 'Unstoppable', icon: '/common/destiny2_content/icons/26bcfa0cf4e27a3dd15f690f7c4ba5a5.png' }\r\n    };\r\n\r\n    const targetEnum = Number(breakerType);\r\n    if (CHAMP_ICONS[targetEnum]) {\r\n      return CHAMP_ICONS[targetEnum];\r\n    }\r\n\r\n    const breakers = this.manifestData.DestinyBreakerTypeDefinition as Record<string, any> | undefined;\r\n    if (!breakers) return undefined;\r\n\r\n    // Fallback: Try treating it as a hash (direct lookup in BreakerType table)\r\n    const byHash = breakers[String(breakerType)];\r\n    if (byHash?.displayProperties) {\r\n      return {\r\n        name: byHash.displayProperties.name || '',\r\n        icon: byHash.displayProperties.icon\r\n      };\r\n    }\r\n\r\n    // Fallback: Find by enumValue in BreakerType table\r\n    for (const breaker of Object.values(breakers)) {\r\n      if (breaker?.enumValue === targetEnum) {\r\n        return {\r\n          name: breaker.displayProperties?.name || '',\r\n          icon: breaker.displayProperties?.icon\r\n        };\r\n      }\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  // Get champion icon URL by type name\r\n  getChampionIcon(championType: 'barrier' | 'overload' | 'unstoppable'): string | undefined {\r\n    // Map champion type to breaker enum value\r\n    const breakerMap: Record<string, number> = {\r\n      'barrier': 1, // ShieldPiercing\r\n      'overload': 2, // Disruption\r\n      'unstoppable': 3 // Stagger\r\n    };\r\n\r\n    const breakerType = this.getBreakerType(breakerMap[championType]);\r\n    return breakerType?.icon;\r\n  }\r\n\r\n  // Get Guardian Rank icon URLs\r\n  getGuardianRankIcon(rank: number): { background?: string; foreground?: string; icon?: string; plate?: string } | undefined {\r\n    const ranks = this.manifestData.DestinyGuardianRankDefinition as Record<string, any> | undefined;\r\n    const constants = this.manifestData.DestinyGuardianRankConstantsDefinition as Record<string, any> | undefined;\r\n    if (!ranks) return undefined;\r\n\r\n    const rankDef = Object.values(ranks).find(r => r.rankNumber === rank);\r\n    if (!rankDef) return undefined;\r\n\r\n    // Default plate from constants if available\r\n    // For Rank 7-11, they usually use the blue gradient or black plate\r\n    const rankConstants = constants ? Object.values(constants)[0] : null;\r\n    let plate: string | undefined = undefined;\r\n\r\n    if (rankConstants?.iconBackgrounds) {\r\n      const backgrounds = rankConstants.iconBackgrounds;\r\n      if (rank >= 7) {\r\n        plate = backgrounds.backgroundFilledBlueGradientBorderedImagePath;\r\n      } else {\r\n        plate = backgrounds.backgroundPlateBlackAlphaImagePath;\r\n      }\r\n    }\r\n\r\n    return {\r\n      background: rankDef.iconBackgroundPath ? `${BUNGIE_CONFIG.bungieNetOrigin}${rankDef.iconBackgroundPath}` : undefined,\r\n      foreground: rankDef.iconForegroundPath ? `${BUNGIE_CONFIG.bungieNetOrigin}${rankDef.iconForegroundPath}` : undefined,\r\n      icon: rankDef.displayProperties?.icon ? `${BUNGIE_CONFIG.bungieNetOrigin}${rankDef.displayProperties.icon}` : undefined,\r\n      plate: plate ? `${BUNGIE_CONFIG.bungieNetOrigin}${plate}` : undefined\r\n    };\r\n  }\r\n\r\n  // Get Class icon URL (High Quality - matching sidebar filters)\r\n  getClassIcon(classType: number): string | undefined {\r\n    const classNames: Record<number, string> = {\r\n      0: 'Titan',\r\n      1: 'Hunter',\r\n      2: 'Warlock'\r\n    };\r\n\r\n    const className = classNames[classType];\r\n    if (className) {\r\n      const node = this.searchPresentationNodeByName(className, true);\r\n      if (node?.icon) return node.icon;\r\n    }\r\n\r\n    // Fallback to Class Definition\r\n    const classes = this.manifestData.DestinyClassDefinition as Record<string, any> | undefined;\r\n    if (!classes) return undefined;\r\n\r\n    const classDef = Object.values(classes).find(c => c.classType === classType);\r\n    return classDef?.displayProperties?.icon;\r\n  }\r\n\r\n  // Get damage type icon URL by element name\r\n  getDamageTypeIcon(damageType: 'solar' | 'void' | 'arc' | 'stasis' | 'strand' | 'prismatic' | 'kinetic' | 'neutral'): string | undefined {\r\n    // Map damage type names to their enum values in DestinyDamageTypeDefinition\r\n    const damageTypeMap: Record<string, number> = {\r\n      'kinetic': 3373582085,  // Kinetic\r\n      'solar': 1847026933,    // Thermal/Solar\r\n      'arc': 2303181850,      // Arc\r\n      'void': 3454344768,     // Void\r\n      'stasis': 151347233,    // Stasis\r\n      'strand': 3949783978,   // Strand\r\n      'prismatic': 1800170884 // Prismatic\r\n    };\r\n    const damageTypes = this.manifestData.DestinyDamageTypeDefinition as Record<string, any> | undefined;\r\n    if (!damageTypes) return undefined;\r\n\r\n    const hash = damageTypeMap[damageType.toLowerCase()];\r\n    if (!hash) return undefined;\r\n\r\n    let def = damageTypes[String(hash)];\r\n\r\n    // Fallback: Check signed hash\r\n    if (!def) {\r\n      const signedHash = Number(hash) | 0;\r\n      def = damageTypes[String(signedHash)];\r\n    }\r\n\r\n    if (def?.displayProperties?.icon) {\r\n      return def.displayProperties.icon; // Don't prepend, let getBungieUrl handle it\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  // Get Commendation Node definition\r\n  getCommendationNode(hash: number | string): { name: string; icon?: string; color?: string; hash: number } | undefined {\r\n    const nodes = this.manifestData.DestinySocialCommendationNodeDefinition as Record<string, any> | undefined;\r\n    if (!nodes) return undefined;\r\n\r\n    let def = nodes[String(hash)];\r\n    if (!def) {\r\n      const signedHash = Number(hash) | 0;\r\n      def = nodes[String(signedHash)];\r\n    }\r\n\r\n    if (!def) return undefined;\r\n\r\n    return {\r\n      hash: def.hash,\r\n      name: def.displayProperties?.name || '',\r\n      icon: def.displayProperties?.icon ? `${BUNGIE_CONFIG.bungieNetOrigin}${def.displayProperties.icon}` : undefined,\r\n      color: def.color ? `rgb(${def.color.red}, ${def.color.green}, ${def.color.blue})` : undefined\r\n    };\r\n  }\r\n\r\n  // Get Commendation definition\r\n  getCommendation(hash: number | string): { name: string; description: string; icon?: string } | undefined {\r\n    const comms = this.manifestData.DestinySocialCommendationDefinition as Record<string, any> | undefined;\r\n    if (!comms) return undefined;\r\n\r\n    let def = comms[String(hash)];\r\n    if (!def) {\r\n      const signedHash = Number(hash) | 0;\r\n      def = comms[String(signedHash)];\r\n    }\r\n\r\n    if (!def) return undefined;\r\n\r\n    return {\r\n      name: def.displayProperties?.name || '',\r\n      description: def.displayProperties?.description || '',\r\n      icon: def.displayProperties?.icon ? `${BUNGIE_CONFIG.bungieNetOrigin}${def.displayProperties.icon}` : undefined\r\n    };\r\n  }\r\n\r\n  // Get Guardian Rank name\r\n  getGuardianRankName(rank: number): string | undefined {\r\n    const ranks = this.manifestData.DestinyGuardianRankDefinition as Record<string, any> | undefined;\r\n    if (!ranks) return undefined;\r\n\r\n    // Guardian Ranks are usually keyed by rank number in the manifest or have it in the def\r\n    const def = Object.values(ranks).find(r => r.rank === rank);\r\n    return def?.displayProperties?.name;\r\n  }\r\n\r\n  // Search activities in the manifest\r\n  searchActivities(query: string, limit = 10): any[] {\r\n    const activities = this.manifestData.DestinyActivityDefinition as Record<string, any> | undefined;\r\n    if (!activities) return [];\r\n\r\n    // Normalization helper\r\n    const normalize = (str: string) => str\r\n      .toLowerCase()\r\n      .normalize(\"NFD\")\r\n      .replace(/[\\u0300-\\u036f]/g, \"\")\r\n      .replace(/[^a-z0-9\\s]/g, '')\r\n      .trim();\r\n\r\n    const normalizedQuery = normalize(query);\r\n    const results: any[] = [];\r\n\r\n    for (const activity of Object.values(activities)) {\r\n      if (!activity?.displayProperties?.name) continue;\r\n\r\n      const normalizedName = normalize(activity.displayProperties.name);\r\n\r\n      if (normalizedName.includes(normalizedQuery)) {\r\n        results.push(activity);\r\n        if (results.length >= limit) break;\r\n      }\r\n    }\r\n\r\n    return results;\r\n  }\r\n\r\n  // Get name from any source\r\n  getName(hash: number | string): string | undefined {\r\n    const item = this.getItem(hash);\r\n    if (item?.displayProperties.name) return item.displayProperties.name;\r\n\r\n    const perk = this.getPerk(hash);\r\n    if (perk?.name) return perk.name;\r\n\r\n    return undefined;\r\n  }\r\n\r\n  // Get full definition for tooltips\r\n  getFullDefinition(hash: number | string): {\r\n    name: string;\r\n    type?: string;\r\n    description?: string;\r\n    flavorText?: string;\r\n    perkName?: string;\r\n    icon?: string;\r\n    stats?: Array<{ name: string; value: number | string }>;\r\n    element?: string;\r\n    breakerType?: number;\r\n  } | undefined {\r\n    // Try item first\r\n    const item = this.getItem(hash);\r\n    if (item) {\r\n      const statsEn: Array<{ name: string; value: number | string }> = [];\r\n\r\n      // Pull basic stats if available\r\n      const rawItem = (this.manifestData.DestinyInventoryItemDefinition as any)?.[String(hash)];\r\n\r\n      // Check for stats.stats (weapons/armor)\r\n      if (rawItem?.stats?.stats) {\r\n        Object.values(rawItem.stats.stats).forEach((stat: any) => {\r\n          const statDef = this.getStat(stat.statHash);\r\n          if (statDef) {\r\n            statsEn.push({\r\n              name: statDef.name,\r\n              value: stat.value\r\n            });\r\n          }\r\n        });\r\n      }\r\n\r\n      // Check for investmentStats (fragments/mods)\r\n      if (rawItem?.investmentStats && statsEn.length === 0) {\r\n        rawItem.investmentStats.forEach((stat: any) => {\r\n          const statDef = this.getStat(stat.statTypeHash);\r\n          // Only show non-zero stats or critical ones. For fragments, values can be negative.\r\n          if (statDef && stat.value !== 0) {\r\n            // Check if this stat is already added? (Unlikely if statsEn is empty)\r\n            statsEn.push({\r\n              name: statDef.name,\r\n              value: stat.value > 0 ? `+${stat.value}` : `${stat.value}`\r\n            });\r\n          }\r\n        });\r\n      }\r\n\r\n      let description = item.displayProperties.description;\r\n      let perkName: string | undefined = undefined;\r\n\r\n      // Extract Exotic Intrinsic Perk Description if available\r\n      if (rawItem?.sockets?.socketEntries && item.inventory?.tierType === 6) { // Only for exotics\r\n        // Look for the intrinsic perk socket. Usually the first socket or one with a specific plug.\r\n        for (const socket of rawItem.sockets.socketEntries) {\r\n          if (socket.singleInitialItemHash) {\r\n            const plugItem = (this.manifestData.DestinyInventoryItemDefinition as any)?.[String(socket.singleInitialItemHash)];\r\n            // Check for intrinsic/trait type\r\n            if (plugItem && plugItem.displayProperties?.description) {\r\n              const isIntrinsic = plugItem.itemTypeDisplayName === 'Intrinsic' ||\r\n                plugItem.itemTypeDisplayName === 'Trait' ||\r\n                plugItem.plug?.plugCategoryIdentifier?.includes('intrinsic');\r\n\r\n              if (isIntrinsic && plugItem.displayProperties.description.length > 20) {\r\n                description = plugItem.displayProperties.description;\r\n                perkName = plugItem.displayProperties.name;\r\n                break;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      // Fallback: Check perks if description is still empty (Common for Aspects/Fragments)\r\n      if (!description && rawItem?.perks?.length) {\r\n        for (const p of rawItem.perks) {\r\n          const perkDef = this.getPerk(p.perkHash);\r\n          if (perkDef?.description && perkDef.description.length > 20) {\r\n            description = perkDef.description;\r\n            perkName = perkDef.name;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Final fallback to item description\r\n      if (!description || description.length < 20) {\r\n        description = item.displayProperties.description || rawItem?.flavorText;\r\n      }\r\n\r\n      return {\r\n        name: item.displayProperties.name,\r\n        type: item.inventory?.tierTypeName || 'Item',\r\n        description: description,\r\n        flavorText: rawItem?.flavorText,\r\n        perkName: perkName,\r\n        icon: item.displayProperties.icon || item.screenshot,\r\n        stats: statsEn,\r\n        element: (item.defaultDamageType && this.getDamageType(item.defaultDamageType)?.name) || undefined\r\n      };\r\n    }\r\n\r\n    // Try activity definition (for milestones, portal activities, etc.)\r\n    const activityDef = this.getActivity(hash);\r\n    if (activityDef) {\r\n      return {\r\n        name: activityDef.name,\r\n        type: 'Activity',\r\n        description: activityDef.description,\r\n        icon: activityDef.pgcrImage || activityDef.icon\r\n      };\r\n    }\r\n\r\n    // Try activity modifier definition\r\n    const modifierDef = this.getActivityModifier(hash);\r\n    if (modifierDef) {\r\n      return {\r\n        name: modifierDef.name,\r\n        type: 'Modifier',\r\n        description: modifierDef.description,\r\n        icon: modifierDef.icon,\r\n        breakerType: modifierDef.breakerType\r\n      };\r\n    }\r\n\r\n    // Try perk/ability as fallback\r\n    const perk = this.getPerk(hash);\r\n    if (perk) {\r\n      return {\r\n        name: perk.name,\r\n        type: 'Ability/Perk',\r\n        description: perk.description,\r\n        icon: perk.icon\r\n      };\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  private transformItemDefinition(raw: RawItemDefinition): ItemDefinition {\r\n    // Fix for Strand/Stasis Class Abilities having wrong damage type\r\n    // These specific plug categories are known to return incorrect defaults (e.g. Stasis for Strand)\r\n    let damageType = raw.defaultDamageType;\r\n    if (raw.plug?.plugCategoryHash) {\r\n      const forcedDamageType = CLASS_ABILITY_TO_DAMAGE_MAP[raw.plug.plugCategoryHash];\r\n      if (forcedDamageType !== undefined) {\r\n        damageType = forcedDamageType;\r\n      }\r\n    }\r\n\r\n    if (raw.inventory?.tierType === 6) {\r\n      // Debug: Check equipping block for exotics\r\n      if (!raw.equippingBlock?.uniqueLabel) {\r\n        // console.warn(`Manifest: Exotic ${raw.hash} (${raw.displayProperties?.name}) missing uniqueLabel`, raw.equippingBlock);\r\n      }\r\n    }\r\n\r\n    return {\r\n      ...raw, // Pass through all raw data first\r\n      hash: raw.hash,\r\n      displayProperties: {\r\n        name: raw.displayProperties?.name || 'Unknown',\r\n        description: raw.displayProperties?.description || '',\r\n        icon: raw.displayProperties?.icon\r\n          ? `${BUNGIE_CONFIG.bungieNetOrigin}${raw.displayProperties.icon}`\r\n          : '',\r\n        hasIcon: !!raw.displayProperties?.icon,\r\n      },\r\n      screenshot: raw.screenshot\r\n        ? `${BUNGIE_CONFIG.bungieNetOrigin}${raw.screenshot}`\r\n        : undefined,\r\n      itemType: raw.itemType,\r\n      itemSubType: raw.itemSubType,\r\n      classType: raw.classType,\r\n      equippable: raw.equippable || false,\r\n      defaultDamageType: damageType,\r\n      defaultDamageTypeHash: raw.defaultDamageTypeHash,\r\n      tierType: raw.inventory?.tierType,\r\n      isExotic: raw.inventory?.tierType === 6,\r\n      itemTypeDisplayName: raw.itemTypeDisplayName,\r\n      itemTypeAndTierDisplayName: raw.itemTypeAndTierDisplayName,\r\n      sockets: raw.sockets,\r\n      itemCategoryHashes: raw.itemCategoryHashes,\r\n      plug: raw.plug,\r\n      inventory: raw.inventory ? {\r\n        tierType: raw.inventory.tierType || 0,\r\n        tierTypeName: raw.inventory.tierTypeName || '',\r\n        bucketTypeHash: raw.inventory.bucketTypeHash || 0,\r\n        recoveryBucketTypeHash: (raw.inventory as any).recoveryBucketTypeHash || 0,\r\n        maxStackSize: (raw.inventory as any).maxStackSize || 1,\r\n        isInstanceItem: (raw.inventory as any).isInstanceItem || false,\r\n        nonTransferrable: (raw.inventory as any).nonTransferrable || false,\r\n        equippingLabel: raw.equippingBlock?.uniqueLabel,\r\n        equippable: (raw.inventory as any).equippable || false,\r\n      } : undefined,\r\n      equippingBlock: raw.equippingBlock,\r\n      stats: raw.stats ? {\r\n        disablePrimaryStatDisplay: !!raw.stats.disablePrimaryStatDisplay,\r\n        statGroupHash: raw.stats.statGroupHash || 0,\r\n        stats: raw.stats.stats || {},\r\n        hasAndDisplayHashes: raw.stats.hasAndDisplayHashes || [],\r\n      } : undefined,\r\n      iconWatermark: raw.iconWatermark || raw.quality?.displayVersionWatermarkIcons?.[0],\r\n      secondarySpecial: raw.secondarySpecial\r\n        ? `${BUNGIE_CONFIG.bungieNetOrigin}${raw.secondarySpecial}`\r\n        : undefined,\r\n      secondaryOverlay: raw.secondaryOverlay\r\n        ? `${BUNGIE_CONFIG.bungieNetOrigin}${raw.secondaryOverlay}`\r\n        : undefined,\r\n      secondaryIcon: raw.secondaryIcon\r\n        ? `${BUNGIE_CONFIG.bungieNetOrigin}${raw.secondaryIcon}`\r\n        : undefined,\r\n      seasonLabel: getSeasonNameFromWatermark(raw.iconWatermark || raw.quality?.displayVersionWatermarkIcons?.[0] || ''),\r\n      iconWatermarkShelved: raw.iconWatermarkShelved || undefined,\r\n      quality: raw.quality ? {\r\n        currentVersion: (raw.quality as any).currentVersion || 0,\r\n        displayVersionWatermarkIcons: raw.quality.displayVersionWatermarkIcons || []\r\n      } : undefined,\r\n    };\r\n  }\r\n\r\n  getItems(hashes: (number | string)[]): ItemDefinition[] {\r\n    return hashes\r\n      .map((hash) => this.getItem(hash))\r\n      .filter((item): item is ItemDefinition => item !== undefined);\r\n  }\r\n\r\n  /**\r\n   * Search items by type and tier (e.g., exotic weapons, exotic armor)\r\n   * @param itemType - 2 for armor, 3 for weapon\r\n   * @param tierType - 6 for exotic, 5 for legendary\r\n   */\r\n  searchItemsByType(itemType: number, tierType: number): Array<{\r\n    name: string;\r\n    description: string;\r\n    hash: number;\r\n    icon?: string;\r\n    classType: number;\r\n    bucketHash: number;\r\n    damageType: number;\r\n    itemSubType: number;\r\n  }> {\r\n    const cacheKey = `type_${itemType}_tier_${tierType}`;\r\n    if (this.searchCache[cacheKey]) {\r\n      return this.searchCache[cacheKey];\r\n    }\r\n\r\n    const items = this.manifestData.DestinyInventoryItemDefinition as Record<string, RawItemDefinition>;\r\n    if (!items) return [];\r\n\r\n    const results: Array<{\r\n      name: string;\r\n      description: string;\r\n      hash: number;\r\n      icon?: string;\r\n      classType: number;\r\n      bucketHash: number;\r\n      damageType: number;\r\n      itemSubType: number;\r\n    }> = [];\r\n\r\n    for (const [hash, item] of Object.entries(items)) {\r\n      if (item.itemType === itemType && item.inventory?.tierType === tierType && item.displayProperties?.name) {\r\n        results.push({\r\n          name: item.displayProperties.name,\r\n          description: item.displayProperties.description || '',\r\n          hash: Number(hash),\r\n          icon: item.displayProperties.icon, // Don't prepend, let getBungieUrl handle it\r\n          classType: item.classType ?? 3, // Default to 3 (Unknown/All) if missing\r\n          bucketHash: item.inventory?.bucketTypeHash || 0,\r\n          damageType: item.defaultDamageType || 0,\r\n          itemSubType: item.itemSubType || 0\r\n        });\r\n      }\r\n    }\r\n\r\n    this.searchCache[cacheKey] = results;\r\n    return results;\r\n  }\r\n\r\n  searchItems(query: string, options?: SearchOptions & { fuzzy?: boolean }): ItemDefinition[] {\r\n    const items = this.manifestData.DestinyInventoryItemDefinition as Record<\r\n      string,\r\n      RawItemDefinition\r\n    >;\r\n\r\n    if (!items) return [];\r\n\r\n    const results: { item: ItemDefinition; score: number }[] = [];\r\n\r\n    // Helper to normalize strings for comparison\r\n    const cleanStr = (s: string) => s.toLowerCase().replace(/['.,!-\\s]/g, '');\r\n    const cleanQuery = cleanStr(query);\r\n\r\n    for (const item of Object.values(items)) {\r\n      // Filter by options\r\n      if (options?.tierType !== undefined && item.inventory?.tierType !== options.tierType) continue;\r\n      if (options?.classType !== undefined && item.classType !== options.classType) continue;\r\n      if (options?.itemType !== undefined && item.itemType !== options.itemType) continue;\r\n\r\n      const itemName = item.displayProperties?.name;\r\n      if (!itemName) continue;\r\n\r\n      const cleanName = cleanStr(itemName);\r\n      let score = -1; // -1 means no match\r\n\r\n      // 1. Exact Substring Match (Highest Priority)\r\n      if (cleanName.includes(cleanQuery)) {\r\n        // Shorter names that match are better (e.g. \"Ace\" matches \"Ace of Spades\" better than \"Place of Spades\")\r\n        score = 0 + (cleanName.length - cleanQuery.length) * 0.01;\r\n      }\r\n      // 2. Fuzzy Match (Levenshtein)\r\n      else if (options?.fuzzy) {\r\n        // Only run Levenshtein if lengths are somewhat close (optimization)\r\n        if (Math.abs(cleanName.length - cleanQuery.length) <= 3) {\r\n          const dist = this.levenshtein(cleanQuery, cleanName);\r\n          // Allow distance of 2 (handles \"guild\" vs \"guile\", \"grenades\" vs \"grenade\")\r\n          if (dist <= 2) {\r\n            score = dist;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (score !== -1) {\r\n        results.push({\r\n          item: this.transformItemDefinition(item),\r\n          score\r\n        });\r\n      }\r\n    }\r\n\r\n    // Sort by score (lower is better)\r\n    results.sort((a, b) => a.score - b.score);\r\n\r\n    // Apply limit\r\n    const limit = options?.limit ?? 10;\r\n    return results.slice(0, limit).map(r => r.item);\r\n  }\r\n\r\n  // Levenshtein Distance Helper\r\n  private levenshtein(a: string, b: string): number {\r\n    if (a.length === 0) return b.length;\r\n    if (b.length === 0) return a.length;\r\n\r\n    const matrix = [];\r\n    for (let i = 0; i <= b.length; i++) matrix[i] = [i];\r\n    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;\r\n\r\n    for (let i = 1; i <= b.length; i++) {\r\n      for (let j = 1; j <= a.length; j++) {\r\n        if (b.charAt(i - 1) === a.charAt(j - 1)) {\r\n          matrix[i][j] = matrix[i - 1][j - 1];\r\n        } else {\r\n          matrix[i][j] = Math.min(\r\n            matrix[i - 1][j - 1] + 1,\r\n            Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1)\r\n          );\r\n        }\r\n      }\r\n    }\r\n    return matrix[b.length][a.length];\r\n  }\r\n\r\n  // Get exotics by class\r\n  getExoticArmor(classType?: number): ItemDefinition[] {\r\n    const items = this.manifestData.DestinyInventoryItemDefinition as Record<\r\n      string,\r\n      RawItemDefinition\r\n    >;\r\n\r\n    if (!items) return [];\r\n\r\n    return Object.values(items)\r\n      .filter((item) => {\r\n        // Is exotic armor\r\n        if (item.inventory?.tierType !== 6) return false; // Exotic\r\n        if (item.itemType !== 2) return false; // Armor\r\n\r\n        // Class filter\r\n        if (classType !== undefined && item.classType !== classType) return false;\r\n\r\n        // Has an icon (real item, not placeholder)\r\n        if (!item.displayProperties?.icon) return false;\r\n\r\n        return true;\r\n      })\r\n      .map((item) => this.transformItemDefinition(item));\r\n  }\r\n\r\n  getExoticWeapons(): ItemDefinition[] {\r\n    const items = this.manifestData.DestinyInventoryItemDefinition as Record<\r\n      string,\r\n      RawItemDefinition\r\n    >;\r\n\r\n    if (!items) return [];\r\n\r\n    return Object.values(items)\r\n      .filter((item) => {\r\n        // Is exotic weapon\r\n        if (item.inventory?.tierType !== 6) return false; // Exotic\r\n        if (item.itemType !== 3) return false; // Weapon\r\n\r\n        // Has an icon\r\n        if (!item.displayProperties?.icon) return false;\r\n\r\n        return true;\r\n      })\r\n      .map((item) => this.transformItemDefinition(item));\r\n  }\r\n\r\n\r\n  getPerk(hash: number | string): { name: string; description: string; icon: string; hash: number } | undefined {\r\n    const perks = this.manifestData.DestinySandboxPerkDefinition as Record<\r\n      string,\r\n      { hash: number; displayProperties: { name: string; description: string; icon?: string } }\r\n    >;\r\n\r\n    if (!perks) return undefined;\r\n\r\n    const perk = perks[String(hash)];\r\n    if (!perk) return undefined;\r\n\r\n    return {\r\n      hash: perk.hash,\r\n      name: perk.displayProperties.name,\r\n      description: perk.displayProperties.description,\r\n      icon: perk.displayProperties.icon\r\n        ? `${BUNGIE_CONFIG.bungieNetOrigin}${perk.displayProperties.icon}`\r\n        : '',\r\n    };\r\n  }\r\n\r\n  // Search perks by name in the manifest\r\n  searchPerks(query: string, limit = 5): Array<{ name: string; description: string; hash: number; icon?: string }> {\r\n    const perks = this.manifestData.DestinySandboxPerkDefinition as Record<string, any> | undefined;\r\n    if (!perks) return [];\r\n\r\n    const normalize = (s: string) => s.toLowerCase().replace(/['.,!-\\s]/g, '');\r\n    const cleanQuery = normalize(query);\r\n    const results: Array<{ name: string; description: string; hash: number; icon?: string; score: number }> = [];\r\n\r\n    for (const perk of Object.values(perks)) {\r\n      if (!perk?.displayProperties?.name) continue;\r\n\r\n      const cleanName = normalize(perk.displayProperties.name);\r\n      if (cleanName.includes(cleanQuery)) {\r\n        results.push({\r\n          name: perk.displayProperties.name,\r\n          description: perk.displayProperties.description || '',\r\n          hash: perk.hash,\r\n          icon: perk.displayProperties.icon, // Don't prepend, let getBungieUrl handle it\r\n          score: cleanName.length - cleanQuery.length\r\n        });\r\n      }\r\n    }\r\n\r\n    return results\r\n      .sort((a, b) => a.score - b.score)\r\n      .slice(0, limit)\r\n      .map(({ score, ...rest }) => rest);\r\n  }\r\n\r\n  // Search legendary weapons by name\r\n  searchLegendaryWeapons(query: string, limit = 5): Array<{ name: string; hash: number; icon?: string }> {\r\n    const items = this.manifestData.DestinyInventoryItemDefinition as Record<string, any> | undefined;\r\n    if (!items) return [];\r\n\r\n    const normalize = (s: string) => s.toLowerCase().replace(/['.,!-\\s]/g, '');\r\n    const cleanQuery = normalize(query);\r\n    const results: Array<{ name: string; hash: number; icon?: string; score: number }> = [];\r\n\r\n    for (const item of Object.values(items)) {\r\n      if (item.itemType === 3 && item.inventory?.tierType === 5) {\r\n        if (!item.displayProperties?.name) continue;\r\n        const cleanName = normalize(item.displayProperties.name);\r\n        if (cleanName.includes(cleanQuery)) {\r\n          results.push({\r\n            name: item.displayProperties.name,\r\n            hash: item.hash,\r\n            icon: item.displayProperties.icon ? `${BUNGIE_CONFIG.bungieNetOrigin}${item.displayProperties.icon}` : undefined,\r\n            score: cleanName.length - cleanQuery.length\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    return results\r\n      .sort((a, b) => a.score - b.score)\r\n      .slice(0, limit)\r\n      .map(({ score, ...rest }) => rest);\r\n  }\r\n\r\n  getDamageType(enumValue: number): { name: string } | undefined {\r\n    const types = this.manifestData.DestinyDamageTypeDefinition as Record<\r\n      string,\r\n      { displayProperties: { name: string }; enumValue: number }\r\n    >;\r\n\r\n    if (!types) return undefined;\r\n\r\n    for (const type of Object.values(types)) {\r\n      if (type.enumValue === enumValue) {\r\n        return { name: type.displayProperties.name };\r\n      }\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  getClassName(classType: number): string {\r\n    const classes = this.manifestData.DestinyClassDefinition as Record<\r\n      string,\r\n      { classType: number; displayProperties: { name: string } }\r\n    >;\r\n\r\n    if (!classes) return 'Unknown';\r\n\r\n    for (const cls of Object.values(classes)) {\r\n      if (cls.classType === classType) {\r\n        return cls.displayProperties.name;\r\n      }\r\n    }\r\n\r\n    return 'Unknown';\r\n  }\r\n\r\n  getPlugSet(hash: number | string): Array<{ name: string; description: string; hash: number; icon?: string }> {\r\n    const plugSets = this.manifestData.DestinyPlugSetDefinition as Record<string, any> | undefined;\r\n    if (!plugSets) return [];\r\n\r\n    const plugSet = plugSets[String(hash)];\r\n    if (!plugSet?.reusablePlugItems) return [];\r\n\r\n    return plugSet.reusablePlugItems\r\n      .map((item: any) => {\r\n        const itemDef = this.getRawDefinition('DestinyInventoryItemDefinition', item.plugItemHash);\r\n        if (!itemDef) return null;\r\n\r\n        // Skip Shaders (10), Ornaments (26), Mementos, and other cosmetic types\r\n        if (itemDef.itemType === 10 || itemDef.itemType === 26) return null;\r\n\r\n        // Skip items that aren't actually perks/mods (usually itemType 19, 20 etc)\r\n        // Perks are often 18 or specific types. But filtering 10/26 covers the main report.\r\n\r\n        return {\r\n          name: itemDef.displayProperties?.name || 'Unknown Perk',\r\n          description: itemDef.displayProperties?.description || '',\r\n          hash: itemDef.hash,\r\n          icon: itemDef.displayProperties?.icon ? `${BUNGIE_CONFIG.bungieNetOrigin}${itemDef.displayProperties.icon}` : undefined\r\n        };\r\n      })\r\n      .filter((p: any) => p !== null && p.name !== 'Empty')\r\n      // De-duplicate by hash to handle redundant sockets/plugs\r\n      .filter((p: any, index: number, self: any[]) => index === self.findIndex((t: any) => t?.hash === p?.hash));\r\n  }\r\n\r\n  /**\r\n   * Get the full pool of potential perks for a weapon\r\n   */\r\n  getPerkPool(weaponHash: number): Array<{ column: number; perks: Array<{ name: string; description: string; hash: number; icon?: string }> }> {\r\n    const rawDef = this.getRawDefinition('DestinyInventoryItemDefinition', weaponHash);\r\n    if (!rawDef?.sockets?.socketEntries) return [];\r\n\r\n    const pool: any[] = [];\r\n\r\n    // Most Legendaries have perks in specific socket categories\r\n    // We'll iterate and find \"Trait\" sockets\r\n    // Find the \"Weapon Perks\" category sockets\r\n    const perkCategory = rawDef.sockets.socketCategories?.find(\r\n      (c: any) => c.socketCategoryHash === 4241085061 // \"Weapon Perks\" category\r\n    );\r\n\r\n    const traitIndices = perkCategory?.socketIndexes || [];\r\n\r\n    rawDef.sockets.socketEntries.forEach((entry: any, index: number) => {\r\n      // Prioritize sockets in the \"Weapon Perks\" category\r\n      if (traitIndices.length > 0 && !traitIndices.includes(index)) return;\r\n\r\n      const plugSetHash = entry.randomizedPlugSetHash || entry.reusablePlugSetHash;\r\n      if (plugSetHash) {\r\n        const perks = this.getPlugSet(plugSetHash);\r\n        if (perks.length > 0) {\r\n          pool.push({\r\n            column: index,\r\n            perks\r\n          });\r\n        }\r\n      }\r\n    });\r\n\r\n    return pool;\r\n  }\r\n  isLoaded(): boolean {\r\n    return REQUIRED_TABLES.every((table) => this.manifestData[table] !== undefined);\r\n  }\r\n\r\n  // Clear cached data\r\n  async clearCache(): Promise<void> {\r\n    await db.clearManifest();\r\n    this.manifestData = {};\r\n    this.searchCache = {};\r\n  }\r\n\r\n  getDefinition(tableName: TableName, hash: number | string): any {\r\n    return (this.manifestData[tableName] as Record<string, any>)?.[String(hash)];\r\n  }\r\n\r\n  // Alias for getDefinition\r\n  getRawDefinition(tableName: TableName, hash: number | string): any {\r\n    return this.getDefinition(tableName, hash);\r\n  }\r\n\r\n  // Gets the fragment capacity of an aspect item\r\n  getAspectCapacity(aspectHash: number): number {\r\n    const def = this.getRawDefinition('DestinyInventoryItemDefinition', aspectHash);\r\n    // DIM Strategy: Aspects have capacity in plug.energyCapacity.capacityValue\r\n    // If not found, try energy.capacityValue as fallback for older items\r\n    return def?.plug?.energyCapacity?.capacityValue ?? def?.energy?.capacityValue ?? 0;\r\n  }\r\n\r\n  // Get default loadout identifiers (first valid hash from each table)\r\n  // Required for SnapshotLoadout API - Bungie requires valid manifest hashes\r\n  getDefaultLoadoutIdentifiers(): { nameHash: number; colorHash: number; iconHash: number } | null {\r\n    const names = this.manifestData.DestinyLoadoutNameDefinition as Record<string, { hash: number; index?: number }>;\r\n    const colors = this.manifestData.DestinyLoadoutColorDefinition as Record<string, { hash: number; index?: number }>;\r\n    const icons = this.manifestData.DestinyLoadoutIconDefinition as Record<string, { hash: number; index?: number }>;\r\n\r\n    if (!names || !colors || !icons) {\r\n      return null;\r\n    }\r\n\r\n    // Get first non-redacted entry from each table, sorted by index if available\r\n    const getFirstHash = (table: Record<string, any>): number | null => {\r\n      const entries = Object.values(table)\r\n        .filter(e => !e.redacted)\r\n        .sort((a, b) => (a.index ?? 0) - (b.index ?? 0));\r\n      return entries[0]?.hash ?? null;\r\n    };\r\n\r\n    const nameHash = getFirstHash(names);\r\n    const colorHash = getFirstHash(colors);\r\n    const iconHash = getFirstHash(icons);\r\n\r\n    if (nameHash === null || colorHash === null || iconHash === null) {\r\n      return null;\r\n    }\r\n\r\n    return { nameHash, colorHash, iconHash };\r\n  }\r\n\r\n  // Diagnostic: Get item count\r\n  getItemCount(): number {\r\n    const items = this.manifestData.DestinyInventoryItemDefinition;\r\n    return items ? Object.keys(items).length : 0;\r\n  }\r\n\r\n  // Diagnostic: Get first few keys and hunt for Ace of Spades\r\n  getDebugInfo(): string {\r\n    const items = this.manifestData.DestinyInventoryItemDefinition;\r\n    if (!items) return \"No items loaded\";\r\n\r\n    // Check specific hashes\r\n    const hashUnsigned = \"4019651319\"; // Ace of Spades\r\n    const hashSigned = \"-275315977\";\r\n\r\n    let result = `Items: ${Object.keys(items).length}\\n`;\r\n\r\n    if (items[hashUnsigned]) result += `FOUND Unsigned: ${(items[hashUnsigned] as any).displayProperties?.name}\\n`;\r\n    else result += `MISSING Unsigned (${hashUnsigned})\\n`;\r\n\r\n    if (items[hashSigned]) result += `FOUND Signed: ${(items[hashSigned] as any).displayProperties?.name}\\n`;\r\n    else result += `MISSING Signed (${hashSigned})\\n`;\r\n\r\n    // Search by name\r\n    let foundKey = \"\";\r\n    for (const key in items) {\r\n      // Safe check for displayProperties\r\n      const def = items[key] as any;\r\n      if (def?.displayProperties?.name === \"Ace of Spades\") {\r\n        foundKey = key;\r\n        const fullDef = JSON.stringify(def).substring(0, 100);\r\n        result += `Found via SEARCH. Key: ${key} \\nDef Start: ${fullDef}...`;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (!foundKey) result += \"Could not find 'Ace of Spades' by name scan.\";\r\n\r\n    return result;\r\n  }\r\n}\r\n\r\n// Raw item definition from manifest\r\nexport interface RawItemDefinition {\r\n  hash: number;\r\n  displayProperties: {\r\n    name: string;\r\n    description: string;\r\n    icon?: string;\r\n  };\r\n  screenshot?: string;\r\n  itemType: number;\r\n  itemSubType: number;\r\n  classType: number;\r\n  itemCategoryHashes?: number[];\r\n  inventory?: {\r\n    tierType: number;\r\n    tierTypeName: string;\r\n    bucketTypeHash: number;\r\n  };\r\n  equippingBlock?: {\r\n    uniqueLabel?: string;\r\n    uniqueLabelHash?: number;\r\n    equipmentSlotTypeHash?: number;\r\n    attributes?: number;\r\n    ammoType?: number;\r\n    displayStrings?: string[];\r\n  };\r\n  equippable?: boolean;\r\n  defaultDamageType?: number;\r\n  defaultDamageTypeHash?: number;\r\n  itemTypeDisplayName?: string;\r\n  itemTypeAndTierDisplayName?: string;\r\n  sockets?: any; // Raw socket data for parsing categories\r\n  plug?: {\r\n    plugCategoryHash: number;\r\n    plugCategoryIdentifier: string;\r\n    energyCapacity?: {\r\n      capacityValue: number;\r\n    };\r\n  };\r\n  investmentStats?: Array<{\r\n    statTypeHash: number;\r\n    value: number;\r\n    isConditionallyActive: boolean;\r\n  }>;\r\n  iconWatermark?: string;\r\n  iconWatermarkShelved?: string;\r\n  quality?: {\r\n    displayVersionWatermarkIcons: string[];\r\n  };\r\n  stats?: {\r\n    disablePrimaryStatDisplay: boolean;\r\n    statGroupHash: number;\r\n    stats: Record<number, {\r\n      statHash: number;\r\n      value: number;\r\n      minimum: number;\r\n      maximum: number;\r\n      displayMaximum: number;\r\n    }>;\r\n    hasAndDisplayHashes: number[];\r\n  };\r\n  secondaryIcon?: string;\r\n  secondaryOverlay?: string;\r\n  secondarySpecial?: string;\r\n}\r\n\r\ninterface SearchOptions {\r\n  tierType?: number;\r\n  classType?: number;\r\n  itemType?: number;\r\n  limit?: number;\r\n}\r\n\r\n// Export singleton\r\nexport const manifestService = new ManifestService();\r\n\r\n","import { manifestService } from './manifest.service';\r\nimport { transferService } from './transfer.service';\r\nimport { profileService } from './profile.service';\r\nimport { infoLog } from '../../utils/logger';\r\nimport { BUCKET_HASHES, SOCKET_CATEGORY_HASHES } from '../../config/bungie.config';\r\nimport type { DestinyItem, ItemInstance, ItemSockets } from '../../types';\r\n\r\nexport interface ModAssignment {\r\n    itemInstanceId: string;\r\n    socketIndex: number;\r\n    modHash: number;\r\n}\r\n\r\nexport class ModService {\r\n\r\n    /**\r\n     * Applies a list of mods to the character's equipped armor.\r\n     */\r\n    async applyArmorMods(characterId: string, mods: number[], onProgress: any, options?: { silent?: boolean }): Promise<void> {\r\n        const state = (await import('../../store')).useProfileStore.getState();\r\n        const equippedArmor = (state.characterEquipment?.[characterId] || []).filter(i =>\r\n            [BUCKET_HASHES.HELMET, BUCKET_HASHES.GAUNTLETS, BUCKET_HASHES.CHEST_ARMOR, BUCKET_HASHES.LEG_ARMOR, BUCKET_HASHES.CLASS_ARMOR].includes(i.bucketHash)\r\n        );\r\n\r\n        if (equippedArmor.length === 0) return;\r\n\r\n        // Fetch sockets for all armor\r\n        const armorWithSockets = await Promise.all(equippedArmor.map(async item => ({\r\n            item,\r\n            instance: state.itemInstances[item.itemInstanceId!],\r\n            sockets: await profileService.getItemSockets(item.itemInstanceId!)\r\n        })));\r\n\r\n        // Fit mods into available energy/sockets\r\n        const { assignments } = this.fitMods(mods, armorWithSockets.filter(a => a.sockets && a.instance) as any);\r\n\r\n        for (let i = 0; i < assignments.length; i++) {\r\n            const a = assignments[i];\r\n\r\n            // DIM Parity: Skip if already plugged to avoid unnecessary API calls\r\n            const armorItem = armorWithSockets.find(aw => aw.item.itemInstanceId === a.itemInstanceId);\r\n            const currentSocket = armorItem?.sockets.sockets.find((s: any) => s.socketIndex === a.socketIndex);\r\n            if (currentSocket?.plugHash === a.modHash) {\r\n                continue;\r\n            }\r\n\r\n            onProgress(`Mod ${i + 1}/${assignments.length}`, 90 + (i / assignments.length) * 10);\r\n            const res = await transferService.insertSocketPlugFree(a.itemInstanceId, a.modHash, a.socketIndex, characterId, options);\r\n            if (res.stop) {\r\n                infoLog('Transfer', 'Stopping armor mod application due to location restriction');\r\n                break;\r\n            }\r\n\r\n            // DIM Parity: Socket actions are intensive. 500ms settle interval matches DIM rate limits.\r\n            await new Promise(r => setTimeout(r, 500));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Applies a subclass configuration (aspects, fragments, etc.)\r\n     */\r\n    async applySubclassConfiguration(subclass: DestinyItem, config: any, characterId: string, onProgress: any, options?: { silent?: boolean }): Promise<void> {\r\n        if (!config || !subclass.itemInstanceId) return;\r\n\r\n        onProgress('Configuring Subclass...', 85);\r\n\r\n        // DIM Standard: Re-fetch the subclass item from the LATEST state to ensure we have current sockets\r\n        const state = (await import('../../store')).useProfileStore.getState();\r\n        const latestSubclass = state.getAllInventory().find(i => i.itemInstanceId === subclass.itemInstanceId);\r\n        if (!latestSubclass || !latestSubclass.itemInstanceId) return;\r\n\r\n        const itemDef = manifestService.getRawDefinition('DestinyInventoryItemDefinition', latestSubclass.itemHash);\r\n        if (!itemDef?.sockets?.socketCategories || !itemDef.sockets.socketEntries) return;\r\n\r\n        // Fetch current sockets to implement \"Shuffled Sockets\" logic (DIM Standard)\r\n        const currentSockets = await profileService.getItemSockets(latestSubclass.itemInstanceId);\r\n        if (!currentSockets) return;\r\n\r\n        const overrides: Record<number, number> = {};\r\n\r\n        // DIM Parity: Fragment Capacity Stat\r\n        const FRAGMENT_SLOTS_STAT_HASH = 2855639344;\r\n\r\n        const getFragmentCapacity = (aspectHashes: number[]) => {\r\n            let capacity = 0;\r\n            aspectHashes.forEach(h => {\r\n                const def = manifestService.getRawDefinition('DestinyInventoryItemDefinition', h);\r\n                const stat = def?.investmentStats?.find((s: any) => s.statTypeHash === FRAGMENT_SLOTS_STAT_HASH);\r\n                if (stat) capacity += stat.value;\r\n            });\r\n            return capacity;\r\n        };\r\n\r\n        const getDefaultAbilityHash = (socketIndex: number) => {\r\n            const entry = itemDef.sockets.socketEntries[socketIndex];\r\n            if (entry?.singleInitialItemHash && entry.singleInitialItemHash !== 0) {\r\n                return entry.singleInitialItemHash;\r\n            }\r\n            // Fallback to first plug in reusable plug set if available\r\n            if (entry?.reusablePlugSetHash) {\r\n                const plugSet = manifestService.getRawDefinition('DestinyPlugSetDefinition', entry.reusablePlugSetHash);\r\n                return plugSet?.reusablePlugItems?.[0]?.plugItemHash || 0;\r\n            }\r\n            return 0;\r\n        };\r\n\r\n        // Helper to find socket indices for a category\r\n        const findIndices = (categoryHashes: number[]) => {\r\n            return categoryHashes.flatMap(h => {\r\n                const cat = itemDef.sockets.socketCategories.find((c: any) => c.socketCategoryHash === h);\r\n                return cat ? cat.socketIndexes : [];\r\n            }).sort((a, b) => a - b);\r\n        };\r\n\r\n        const handleShuffledSockets = (socketIndices: number[], desiredHashes: number[]) => {\r\n            const neededHashes = [...desiredHashes];\r\n            const excessSockets: { index: number, currentHash: number | undefined }[] = [];\r\n\r\n            if (!currentSockets.sockets) return;\r\n\r\n            // 1. Identify which desired hashes are already plugged somewhere in these sockets\r\n            socketIndices.forEach(idx => {\r\n                const socket = currentSockets.sockets[idx];\r\n                const currentHash = socket?.plugHash;\r\n\r\n                const matchIdx = neededHashes.indexOf(currentHash || 0);\r\n                if (matchIdx !== -1) {\r\n                    // Already plugged! Keep it and remove from needed list\r\n                    neededHashes.splice(matchIdx, 1);\r\n                } else {\r\n                    // This socket has something we don't want or is empty\r\n                    excessSockets.push({ index: idx, currentHash });\r\n                }\r\n            });\r\n\r\n            // 2. Plug the remaining needed hashes into the excess sockets, OR empty them\r\n            excessSockets.forEach((excess, i) => {\r\n                if (i < neededHashes.length) {\r\n                    // Only apply if it's actually different from what's there\r\n                    if (excess.currentHash !== neededHashes[i]) {\r\n                        overrides[excess.index] = neededHashes[i];\r\n                    }\r\n                } else {\r\n                    // DIM Parity: If no more hashes needed, ensure the socket is emptied\r\n                    // if it currently has something that isn't the default/empty plug.\r\n                    const defaultHash = getDefaultAbilityHash(excess.index);\r\n                    if (defaultHash && excess.currentHash !== defaultHash) {\r\n                        overrides[excess.index] = defaultHash;\r\n                    }\r\n                }\r\n            });\r\n        };\r\n\r\n        // --- 1. Super, Abilities & Jump (Dynamic Whitelist Detection) ---\r\n        const abilityIndices = findIndices([\r\n            SOCKET_CATEGORY_HASHES.SUPER,\r\n            SOCKET_CATEGORY_HASHES.ABILITIES,\r\n            SOCKET_CATEGORY_HASHES.ABILITIES_IKORA\r\n        ]);\r\n\r\n        const abilityMapping = [\r\n            { hash: config.superHash, name: 'supers' },\r\n            { hash: config.classAbilityHash, name: 'class_abilities' },\r\n            { hash: config.meleeHash, name: 'melee' },\r\n            { hash: config.grenadeHash, name: 'grenades' },\r\n            { hash: config.jumpHash || config.movementHash, name: 'movement' }\r\n        ];\r\n\r\n        abilityMapping.forEach((ability, i) => {\r\n            let targetHash = ability.hash;\r\n\r\n            // DIM Parity: Find indices for this specific ability\r\n            const targetIndex = abilityIndices.find(idx => {\r\n                if (overrides[idx]) return false;\r\n                const entry = itemDef.sockets.socketEntries[idx];\r\n                const socketType = manifestService.getRawDefinition('DestinySocketTypeDefinition', entry?.socketTypeHash);\r\n\r\n                // If we have a hash, check whitelist. If not, we'll pick a fallback later.\r\n                if (targetHash) {\r\n                    const plugDef = manifestService.getRawDefinition('DestinyInventoryItemDefinition', targetHash);\r\n                    return socketType?.plugWhitelist?.some((w: any) => w.categoryHash === plugDef?.plug?.plugCategoryHash);\r\n                }\r\n\r\n                // If no hash provided, this might be a candidate for default fallback\r\n                // (Only for choice sockets like Jumps/Grenades)\r\n                return i > 0; // Skip Super for generic fallback if missing\r\n            });\r\n\r\n            if (targetIndex !== undefined) {\r\n                if (!targetHash) {\r\n                    targetHash = getDefaultAbilityHash(targetIndex);\r\n                }\r\n\r\n                // DIM Parity: SKIP if already plugged to avoid unnecessary API calls and potential 500s\r\n                const currentSocket = currentSockets.sockets[targetIndex];\r\n                if (currentSocket?.plugHash === targetHash) {\r\n                    return;\r\n                }\r\n\r\n                if (targetHash) {\r\n                    overrides[targetIndex] = targetHash;\r\n                }\r\n            }\r\n        });\r\n\r\n        // --- 2. Aspects (Shuffled) ---\r\n        const aspectIndices = findIndices([\r\n            SOCKET_CATEGORY_HASHES.ASPECTS,\r\n            SOCKET_CATEGORY_HASHES.ASPECTS_IKORA,\r\n            SOCKET_CATEGORY_HASHES.ASPECTS_STRANGER,\r\n            SOCKET_CATEGORY_HASHES.ASPECTS_NEOMUNA\r\n        ]);\r\n        if (config.aspects && aspectIndices.length > 0) {\r\n            handleShuffledSockets(aspectIndices, config.aspects);\r\n        }\r\n\r\n        // --- 3. Fragments (Shuffled with Capacity Respect) ---\r\n        const fragmentIndices = findIndices([\r\n            SOCKET_CATEGORY_HASHES.FRAGMENTS,\r\n            SOCKET_CATEGORY_HASHES.FRAGMENTS_IKORA,\r\n            SOCKET_CATEGORY_HASHES.FRAGMENTS_STRANGER,\r\n            SOCKET_CATEGORY_HASHES.FRAGMENTS_NEOMUNA\r\n        ]);\r\n\r\n        if (fragmentIndices.length > 0) {\r\n            // DIM Parity: If config doesn't have aspects, fallback to currently equipped aspects for capacity check\r\n            let aspectsToUse = config.aspects;\r\n            if (!aspectsToUse || aspectsToUse.length === 0) {\r\n                const aspectIndices = findIndices([\r\n                    SOCKET_CATEGORY_HASHES.ASPECTS,\r\n                    SOCKET_CATEGORY_HASHES.ASPECTS_IKORA,\r\n                    SOCKET_CATEGORY_HASHES.ASPECTS_STRANGER,\r\n                    SOCKET_CATEGORY_HASHES.ASPECTS_NEOMUNA\r\n                ]);\r\n                if (currentSockets?.sockets) {\r\n                    aspectsToUse = aspectIndices\r\n                        .map(idx => currentSockets.sockets[idx]?.plugHash)\r\n                        .filter(Boolean) as number[];\r\n                }\r\n            }\r\n\r\n            const capacity = getFragmentCapacity(aspectsToUse || []);\r\n            const fragmentsToApply = (config.fragments || []).slice(0, capacity);\r\n            handleShuffledSockets(fragmentIndices.slice(0, capacity), fragmentsToApply);\r\n        }\r\n\r\n        // Only apply if we actually have work to do\r\n        if (Object.keys(overrides).length > 0) {\r\n            // DIM Parity: Sequentially apply subclass overrides to prevent 500 errors\r\n            const sortedIndices = Object.keys(overrides).map(Number).sort((a, b) => a - b);\r\n            for (const idx of sortedIndices) {\r\n                const res = await transferService.insertSocketPlugFree(subclass.itemInstanceId, overrides[idx], idx, characterId, options);\r\n                if (res.stop) {\r\n                    infoLog('Transfer', 'Stopping subclass configuration due to location restriction');\r\n                    break;\r\n                }\r\n                await new Promise(r => setTimeout(r, 500));\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Calculates the energy cost of a mod\r\n     */\r\n    getModEnergyCost(modHash: number): number {\r\n        const def = manifestService.getRawDefinition('DestinyInventoryItemDefinition', modHash);\r\n        return def?.plug?.energyCost?.energyCost || 0;\r\n    }\r\n\r\n    /**\r\n     * Checks if a mod can fit into a specific socket\r\n     */\r\n    canModFit(itemHash: number, modHash: number, socketIndex: number): boolean {\r\n        const itemDef = manifestService.getRawDefinition('DestinyInventoryItemDefinition', itemHash);\r\n        const modDef = manifestService.getRawDefinition('DestinyInventoryItemDefinition', modHash);\r\n\r\n        if (!itemDef || !modDef) return false;\r\n\r\n        // 1. Basic type check: Is it actually a mod?\r\n        const isActuallyMod = modDef.itemCategoryHashes?.includes(59); // Armor Mod Category\r\n        if (!isActuallyMod && modDef.itemType !== 19) return false; // Not a mod/plug\r\n\r\n        // 2. Socket check: Does the item have this socket index?\r\n        const entry = itemDef.sockets?.socketEntries?.[socketIndex];\r\n        if (!entry) return false;\r\n\r\n        // 3. Category check: Does the mod fit the socket category?\r\n        const socketTypeHash = entry.socketTypeHash;\r\n        const socketTypeDef = manifestService.getRawDefinition('DestinySocketTypeDefinition', socketTypeHash);\r\n\r\n        // DIM Strategy: Check plugWhitelist\r\n        const fitsWhitelist = socketTypeDef?.plugWhitelist?.some((w: any) =>\r\n            modDef.plug?.plugCategoryHash === w.categoryHash\r\n        );\r\n\r\n        if (fitsWhitelist) return true;\r\n\r\n        // Fallback: Check direct bucket/slot compatibility (e.g. Helmet mods on Helmet)\r\n        const modPlugCategory = modDef.plug?.plugCategoryHash;\r\n        // Map of PlugCategory to Bucket\r\n        const pchToBucket: Record<number, number> = {\r\n            136154068: BUCKET_HASHES.HELMET,\r\n            3190852654: BUCKET_HASHES.GAUNTLETS,\r\n            1599818818: BUCKET_HASHES.CHEST_ARMOR,\r\n            2595058479: BUCKET_HASHES.LEG_ARMOR,\r\n            4148197177: BUCKET_HASHES.CLASS_ARMOR,\r\n        };\r\n\r\n        if (pchToBucket[modPlugCategory] === itemDef.inventory?.bucketTypeHash) return true;\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Fits a list of general mods into a set of armor pieces (Permutation Logic)\r\n     * Ported logic from DIM's fitMostMods (simplified)\r\n     */\r\n    fitMods(\r\n        mods: number[],\r\n        items: { item: DestinyItem, instance: ItemInstance, sockets: ItemSockets }[]\r\n    ): { assignments: ModAssignment[], unassigned: number[] } {\r\n        const assignments: ModAssignment[] = [];\r\n        const unassigned: number[] = [...mods];\r\n\r\n        // Sort items by energy capacity available (Masterworked first)\r\n        const sortedItems = [...items].sort((a, b) => {\r\n            const capacityA = a.instance.energy?.energyCapacity || 0;\r\n            const capacityB = b.instance.energy?.energyCapacity || 0;\r\n            return capacityB - capacityA;\r\n        });\r\n\r\n        // 1. Assign Bucket-Specific Mods first (not handled here, assumed pre-filtered)\r\n\r\n        // 2. Assign General Mods (Permutation Check)\r\n        for (const modHash of mods) {\r\n            const cost = this.getModEnergyCost(modHash);\r\n\r\n            // Find best item to take this mod\r\n            let bestItemIdx = -1;\r\n            let bestSocketIdx = -1;\r\n\r\n            for (let i = 0; i < sortedItems.length; i++) {\r\n                const { item: armorItem, instance, sockets } = sortedItems[i];\r\n                const energyLeft = (instance.energy?.energyCapacity || 0) - (instance.energy?.energyUsed || 0);\r\n\r\n                if (instance?.energy && energyLeft >= cost) {\r\n                    // Find armor mod socket\r\n                    const armorModSocketIdx = sockets?.sockets?.findIndex(s =>\r\n                        s.isEnabled &&\r\n                        !assignments.some(a => a.itemInstanceId === armorItem.itemInstanceId && a.socketIndex === s.socketIndex)\r\n                    );\r\n\r\n                    if (armorModSocketIdx !== undefined && armorModSocketIdx !== -1) {\r\n                        bestItemIdx = i;\r\n                        bestSocketIdx = armorModSocketIdx;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (bestItemIdx !== -1) {\r\n                const item = sortedItems[bestItemIdx];\r\n                assignments.push({\r\n                    itemInstanceId: item.item.itemInstanceId!,\r\n                    socketIndex: item.sockets.sockets[bestSocketIdx].socketIndex,\r\n                    modHash\r\n                });\r\n                // Update temporary energy tracking\r\n                if (item.instance.energy) {\r\n                    item.instance.energy.energyUsed += cost;\r\n                }\r\n\r\n                // Remove from unassigned\r\n                const idx = unassigned.indexOf(modHash);\r\n                if (idx !== -1) unassigned.splice(idx, 1);\r\n            }\r\n        }\r\n\r\n        return { assignments, unassigned };\r\n    }\r\n\r\n    /**\r\n     * Validates if a total energy requirement is met for an item\r\n     */\r\n    isEnergyValid(instance: ItemInstance, additionalModHashes: number[]): boolean {\r\n        const currentUsed = instance.energy?.energyUsed || 0;\r\n        const capacity = instance.energy?.energyCapacity || 0;\r\n        const additionalCost = additionalModHashes.reduce((acc, hash) => acc + this.getModEnergyCost(hash), 0);\r\n\r\n        return (currentUsed + additionalCost) <= capacity;\r\n    }\r\n\r\n    /**\r\n     * Suggests a set of \"Meta\" armor mods based on the build's element and playstyle.\r\n     */\r\n    suggestMods(element: string, difficulty: string): number[] {\r\n        const mods: number[] = [];\r\n\r\n        // 1. Helmet: Harmonic Siphon (Essential for Orbs)\r\n        mods.push(3832366019);\r\n\r\n        // 2. Arms: defaults (Firepower/Heavy Handed logic is complex, skipping for MVP)\r\n        // Could add \"Grenade Kickstart\" if difficulty is hard?\r\n\r\n        // 3. Chest: Resistance (Harmonic Resistance is 168072143 - verifiable?)\r\n        // Let's rely on user to pick resist.\r\n\r\n        // 4. Legs: Weapon Surge (Damage) + Scavenger (Ammo)\r\n        const SURGE_MODS: Record<string, number> = {\r\n            'void': 3467460423,\r\n            'solar': 2319885414,\r\n            'arc': 1834163303,\r\n            'stasis': 2921714558,\r\n            'strand': 3112965625,\r\n            'prismatic': 3112965625, // Default to Strand for now (popular) or specific logic later\r\n        };\r\n\r\n        const surgeHash = SURGE_MODS[element.toLowerCase()];\r\n        if (surgeHash) {\r\n            mods.push(surgeHash); // 1x Surge\r\n            if (difficulty === 'advanced') mods.push(surgeHash); // 2x Surge for hard content\r\n        }\r\n\r\n        // Harmonic Scavenger\r\n        mods.push(877723168);\r\n\r\n        // 5. Class Item: Time Dilation (Longer Surge) + Reaper (Orbs) + Bomber (Grenade)\r\n        mods.push(1755737153); // Time Dilation\r\n        mods.push(40751621);   // Reaper\r\n        mods.push(4188291233); // Bomber\r\n\r\n        return mods;\r\n    }\r\n}\r\n\r\nexport const modService = new ModService();\r\n","import { infoLog } from './logger';\n\nconst _queue: Promise<unknown>[] = [];\n\n// A global queue of functions that will execute one after the other. The function must return a promise.\n// fn is either a blocking function or a function that returns a promise\nexport function queueAction<K>(fn: () => Promise<K>): Promise<K> {\n  const headPromise: Promise<unknown> = _queue.length ? _queue.at(-1)! : Promise.resolve();\n\n  // If available, run this task under a wake lock so the device doesn't sleep while the operation is running.\n  const runPromise = async () => {\n    let sentinel: WakeLockSentinel | undefined;\n    if ('wakeLock' in navigator) {\n      try {\n        sentinel = await (navigator as any).wakeLock.request('screen');\n      } catch (e) {\n        infoLog('wakelock', 'Could not acquire screen wake lock', e);\n      }\n    }\n    try {\n      return await fn();\n    } finally {\n      await sentinel?.release();\n    }\n  };\n\n  // Execute fn regardless of the result of the existing promise. We\n  // don't use finally here because finally can't modify the return value.\n  const wrappedPromise = headPromise.then(runPromise, runPromise).then(\n    (value) => {\n      _queue.shift();\n      return value;\n    },\n    (e) => {\n      _queue.shift();\n      throw e;\n    },\n  );\n  _queue.push(wrappedPromise);\n\n  return wrappedPromise;\n}\n\n// Wrap a function to produce a function that will be queued when invoked\nexport function queuedAction<T extends unknown[], K>(\n  fn: (...args: T) => Promise<K>,\n  context?: unknown,\n): (...args: T) => Promise<K> {\n  return (...args: T) => queueAction(() => fn.apply(context, args));\n}\n","import { infoLog, errorLog, debugLog } from '../../utils/logger';\n// Handles item transfers, equips, and build application with session tracking and intelligent move strategies\n\nimport { BUNGIE_CONFIG, BUCKET_HASHES, DAMAGE_TYPE_HASHES } from '../../config/bungie.config';\nimport { bungieApi, BungieApiError, PlatformErrorCodes } from './api-client';\nimport { manifestService } from './manifest.service';\nimport { profileService, profileLoader } from './profile.service';\nimport { modService } from './mod.service';\nimport { useProfileStore, useToastStore } from '../../store';\nimport type { BuildTemplate, DestinyItem, TransferResult } from '../../types';\nimport { queueAction } from '../../utils/action-queue';\n\n\n\n// Bucket hash to item slot mapping\nconst EQUIP_BUCKETS = new Set([\n  BUCKET_HASHES.KINETIC_WEAPONS,\n  BUCKET_HASHES.ENERGY_WEAPONS,\n  BUCKET_HASHES.POWER_WEAPONS,\n  BUCKET_HASHES.HELMET,\n  BUCKET_HASHES.GAUNTLETS,\n  BUCKET_HASHES.CHEST_ARMOR,\n  BUCKET_HASHES.LEG_ARMOR,\n  BUCKET_HASHES.CLASS_ARMOR,\n  BUCKET_HASHES.GHOST,\n  BUCKET_HASHES.SUBCLASS,\n]);\n\nconst BUCKET_CAPACITIES: Record<number, number> = {\n  [BUCKET_HASHES.KINETIC_WEAPONS]: 10,\n  [BUCKET_HASHES.ENERGY_WEAPONS]: 10,\n  [BUCKET_HASHES.POWER_WEAPONS]: 10,\n  [BUCKET_HASHES.HELMET]: 10,\n  [BUCKET_HASHES.GAUNTLETS]: 10,\n  [BUCKET_HASHES.CHEST_ARMOR]: 10,\n  [BUCKET_HASHES.LEG_ARMOR]: 10,\n  [BUCKET_HASHES.CLASS_ARMOR]: 10,\n  [BUCKET_HASHES.GHOST]: 10,\n  [BUCKET_HASHES.SUBCLASS]: 10,\n  [BUCKET_HASHES.CONSUMABLES]: 50,\n  [BUCKET_HASHES.MODIFICATIONS]: 50,\n};\n\nconst VAULT_TOTAL_CAPACITY = 1000;\n\n\n/**\n * DIM Parity: Legacy hash to current 3.0 subclass hash mappings\n */\nconst oldToNewItems: Record<number, number> = {\n  1334959255: 2328211300, // Arcstrider\n  2958378809: 2932390016, // Striker\n  1751782730: 3168997075, // Stormcaller\n  3635991036: 2240888816, // Gunslinger\n  3105935002: 2550323932, // Sunbreaker\n  3481861797: 3941205951, // Dawnblade\n  3225959819: 2453351420, // Nightstalker\n  3382391785: 2842471112, // Sentinel\n  3887892656: 2849050827, // Voidwalker\n};\n\nexport interface MoveSession {\n  bucketsFullOnCurrentStore: Set<number>;\n  bucketsFullInVault: Set<number>;\n  bucketsFullOnOtherStores: Map<string, Set<number>>;\n  involvedItems: Set<string | number>;\n  excludedItems: Set<string>;\n  aborted: boolean;\n  errors: string[];\n  retryCount: number;\n  maxRetries: number;\n  startTime: number;\n  ultimateTargetChar?: string;\n  cancelRequested?: boolean; // DIM parity: cancellation support\n  reservations: Record<string, Record<number, number>>;\n}\n\nexport interface MoveContext {\n  originalItemType: number;\n  excludes: any[];\n  spaceLeft: (store: any, item: DestinyItem) => number;\n}\n\nexport function createMoveSession(involvedItemIds: Array<string | number> = [], maxRetries = 5, ultimateTargetChar?: string): MoveSession {\n  return {\n    bucketsFullOnCurrentStore: new Set(),\n    bucketsFullInVault: new Set(),\n    bucketsFullOnOtherStores: new Map(),\n    involvedItems: new Set(involvedItemIds),\n    excludedItems: new Set(),\n    aborted: false,\n    errors: [],\n    retryCount: 0,\n    maxRetries,\n    startTime: Date.now(),\n    ultimateTargetChar,\n    reservations: {},\n  };\n}\n\nclass TransferService {\n\n  async transferItem(\n    itemInstanceId: string,\n    itemHash: number,\n    toVault: boolean,\n    characterId: string,\n    stackSize = 1,\n    session?: MoveSession,\n    options?: { silent?: boolean; skipSpaceCheck?: boolean }\n  ): Promise<TransferResult> {\n    if (!options?.silent) infoLog('Transfer', 'TransferItem Request', { itemInstanceId, toVault, characterId });\n    const { addActiveTransfer } = useProfileStore.getState();\n    const { addToast } = useToastStore.getState();\n\n    const targetId = toVault ? 'vault' : characterId;\n    addActiveTransfer(itemInstanceId, targetId);\n\n    const membership = await profileService.getPrimaryMembership();\n    if (!membership) return { success: false, error: 'No membership', request: { itemId: itemInstanceId, itemHash, toCharacter: targetId, action: 'transfer' } };\n\n    let state = useProfileStore.getState();\n    let item = state.getAllInventory().find(i => i.itemInstanceId === itemInstanceId);\n\n    if (!item) {\n      debugLog('Transfer', `transferItem: Item ${itemInstanceId} not found in local store. Re-fetching profile for consistency...`);\n      await profileLoader.loadProfile(true);\n      state = useProfileStore.getState();\n      item = state.getAllInventory().find(i => i.itemInstanceId === itemInstanceId);\n\n      if (!item) {\n        errorLog('Transfer', `transferItem: Item ${itemInstanceId} still not found after profile refresh.`);\n        return { success: false, error: 'ItemNotFound', request: { itemId: itemInstanceId, itemHash, toCharacter: targetId, action: 'transfer' } };\n      }\n    }\n\n    // DIM Parity: Work around Bungie lock state bug for duplicate hashes\n    // https://github.com/Bungie-net/api/issues/764#issuecomment-437614294\n    const sourceId = toVault ? characterId : 'vault';\n    const sourceItems = sourceId === 'vault' ? state.vaultInventory : (state.characterInventories[sourceId] || []);\n    const hasDuplicates = sourceItems.filter((i: any) => i.itemHash === item.itemHash).length > 1;\n    const overrideLockState = (item.lockable && hasDuplicates) ? ((item.state & 1) === 1) : undefined;\n    const wasLocked = (item.state & 1) === 1;\n\n    if (session) {\n      if (toVault && session.bucketsFullInVault.has(this.getNativeBucketHash(item))) return { success: false, error: 'Vault full', request: { itemId: itemInstanceId, itemHash, toCharacter: 'vault', action: 'transfer' } };\n    }\n\n    // DIM Parity: Proactive Space Check\n    // Before attempting transfer, check if destination has space. If not, try to make space immediately.\n    // This avoids the 500 error from Bungie when moving to full inventory.\n    // Skip if caller already handled space (e.g., moveToStore is called after ensureValidTransfer)\n    if (!toVault && !options?.skipSpaceCheck) {\n      const store = state.characters.find(c => c.characterId === characterId);\n      if (store) {\n        const bucketHash = this.getNativeBucketHash(item);\n        const space = this.getSpaceInBucket(bucketHash, characterId, state, session);\n\n        if (space <= 0) {\n          infoLog('Transfer', `Destination ${characterId} full for ${bucketHash}. Making space...`);\n          const movedAside = await this.ensureCanMoveToStore(item, store, 1, session || createMoveSession([itemInstanceId]));\n          if (!movedAside) {\n            return { success: false, error: 'NoSpace', request: { itemId: itemInstanceId, itemHash, toCharacter: characterId, action: 'transfer' } };\n          }\n          // Refresh state after making space\n          state = useProfileStore.getState();\n        }\n      }\n    }\n\n    try {\n      profileService.updateLocalStore({\n        instanceId: itemInstanceId,\n        sourceId: toVault ? characterId : 'vault',\n        targetId: toVault ? 'vault' : characterId,\n        isEquip: false\n      });\n\n      const endpoint = item.bucketHash === BUCKET_HASHES.POSTMASTER ? BUNGIE_CONFIG.endpoints.pullFromPostmaster : BUNGIE_CONFIG.endpoints.transferItem;\n      await bungieApi.post(endpoint, {\n        itemReferenceHash: itemHash,\n        stackSize,\n        transferToVault: toVault,\n        itemId: itemInstanceId,\n        characterId,\n        membershipType: membership.membershipType,\n      }, true);\n\n      if (overrideLockState !== undefined) {\n        // DIM Parity: Reset lock status asynchronously to work around Bungie bug\n        (async () => {\n          const lockCharId = toVault ? state.characters[0].characterId : characterId;\n          infoLog('Transfer', `Resetting lock status of ${item?.itemHash} to ${overrideLockState} to work around Bungie.net lock state bug`);\n          await this.setItemLockState(itemInstanceId, lockCharId, overrideLockState);\n        })();\n      } else if (wasLocked) {\n        const lockCharId = toVault ? state.characters[0].characterId : characterId;\n        await this.setItemLockState(itemInstanceId, lockCharId, true);\n      }\n\n      if (!options?.silent) {\n        const itemDef = manifestService.getItem(itemHash);\n        addToast({ type: 'success', message: `${itemDef?.displayProperties?.name || 'Item'} moved`, duration: 2000 });\n      }\n\n      return { success: true, request: { itemId: itemInstanceId, itemHash, toCharacter: targetId, action: 'transfer' } };\n    } catch (error: any) {\n      // DIM Parity: Retry on 500/504/1601 (ItemNotFound) errors with backoff\n      const isRetryable = error?.httpStatus === 500 || error?.httpStatus === 504 || error?.errorCode === 1601;\n\n      if (isRetryable && !options?.silent) {\n        if (!session || session.retryCount < 3) {\n          const waitTime = error?.errorCode === 1601 ? 2000 : 1000 * (session ? session.retryCount + 1 : 1);\n          infoLog('Transfer', `Retryable error (${error?.errorCode || error?.httpStatus}) during transfer of ${itemInstanceId}. Waiting ${waitTime}ms and retrying...`);\n\n          await new Promise(r => setTimeout(r, waitTime));\n          if (session) session.retryCount++;\n          return this.transferItem(itemInstanceId, itemHash, toVault, characterId, stackSize, session, options);\n        }\n      }\n\n      // DIM Parity: Handle ghost success for 500 errors\n      if (error?.httpStatus === 500 || error?.isPotentialSuccess) {\n        infoLog('Transfer', `500 error during transfer of ${itemInstanceId}. Verifying ghost success...`);\n        // Wait for eventual consistency\n        await new Promise(r => setTimeout(r, 1500));\n        await profileLoader.loadProfile(true);\n\n        let latestState = useProfileStore.getState();\n        let latestItem = latestState.getAllInventory().find(i => i.itemInstanceId === itemInstanceId);\n        let actualLocation = latestItem ? this.getItemSource(latestItem) : 'unknown';\n        const targetLocation = toVault ? 'vault' : characterId;\n\n        if (actualLocation === targetLocation) {\n          infoLog('Transfer', `Ghost success detected for ${itemInstanceId} manual transfer to ${targetLocation}`);\n          if (!options?.silent && !toVault) {\n            const def = manifestService.getItem(itemHash);\n            const itemName = def?.displayProperties?.name || 'Item';\n            addToast({ type: 'success', message: `${itemName} moved to character` });\n          }\n          return { success: true, request: { itemId: itemInstanceId, itemHash, toCharacter: targetId, action: 'transfer' } };\n        }\n\n        // Second check after another small delay if first failed\n        await new Promise(r => setTimeout(r, 1000));\n        await profileLoader.loadProfile(true);\n        latestState = useProfileStore.getState();\n        latestItem = latestState.getAllInventory().find(i => i.itemInstanceId === itemInstanceId);\n        actualLocation = latestItem ? this.getItemSource(latestItem) : 'unknown';\n        if (actualLocation === targetLocation) {\n          infoLog('Transfer', `Ghost success detected (retry) for ${itemInstanceId} manual transfer to ${targetLocation}`);\n          if (!options?.silent && !toVault) {\n            const def = manifestService.getItem(itemHash);\n            const itemName = def?.displayProperties?.name || 'Item';\n            addToast({ type: 'success', message: `${itemName} moved to character` });\n          }\n          return { success: true, request: { itemId: itemInstanceId, itemHash, toCharacter: targetId, action: 'transfer' } };\n        }\n      }\n\n      const isNoRoom = (error instanceof BungieApiError && error.isNoRoomError()) || error?.errorCode === 1622;\n      profileLoader.loadProfile(true);\n      if (!options?.silent) addToast({ type: 'error', message: error.message || 'Transfer failed' });\n      return { success: false, error: isNoRoom ? 'NoSpace' : error.message, request: { itemId: itemInstanceId, itemHash, toCharacter: targetId, action: 'transfer' } };\n    } finally {\n      useProfileStore.getState().removeActiveTransfer(itemInstanceId);\n    }\n  }\n\n  async equipItem(itemInstanceId: string, characterId: string, options?: { silent?: boolean }): Promise<TransferResult> {\n    const { addActiveTransfer } = useProfileStore.getState();\n    const { addToast } = useToastStore.getState();\n    addActiveTransfer(itemInstanceId, characterId);\n\n    const state = useProfileStore.getState();\n    const character = state.characters.find(c => c.characterId === characterId);\n    if (!character) return { success: false, error: 'Char not found', request: { itemId: itemInstanceId, itemHash: 0, toCharacter: characterId, action: 'equip' } };\n\n    const item = state.getAllInventory().find(i => i.itemInstanceId === itemInstanceId);\n    if (item) {\n      const isEquippedOnTarget = (state.characterEquipment[characterId] || []).some(i => i.itemInstanceId === itemInstanceId);\n      if (isEquippedOnTarget) {\n        debugLog('Transfer', `Item ${item.itemHash} is already equipped on ${characterId}. Skipping API call.`);\n        return { success: true, request: { itemId: itemInstanceId, itemHash: item.itemHash, toCharacter: characterId, action: 'equip' } };\n      }\n    }\n\n    const membership = await profileService.getPrimaryMembership();\n    const membershipType = membership?.membershipType ?? character.membershipType;\n\n    // Resolve exotic conflicts\n    if (item) {\n      const itemDef = manifestService.getItem(item.itemHash);\n      if (itemDef?.inventory?.equippingLabel) {\n        const currentEquipment = state.characterEquipment?.[characterId] || [];\n        const conflict = currentEquipment.find(i => {\n          const def = manifestService.getItem(i.itemHash);\n          return def?.inventory?.equippingLabel === itemDef.inventory?.equippingLabel && i.itemInstanceId !== itemInstanceId && i.bucketHash !== item.bucketHash;\n        });\n\n        if (conflict) {\n          infoLog('Transfer', `Resolving exotic conflict: Unequipping ${conflict.itemInstanceId} to equip ${itemInstanceId}`);\n          // DIM Parity: Exclude both the item being equipped AND the conflicting item from replacement search\n          const exclude = new Set<string | number>([itemInstanceId, conflict.itemInstanceId!]);\n          const replacement = this.findReplacementItem(conflict.bucketHash, characterId, exclude, character.classType);\n\n          if (replacement) {\n            const src = this.getItemSource(replacement);\n            if (src !== characterId) {\n              const session = createMoveSession([replacement.itemInstanceId!, itemInstanceId], 3, characterId);\n              const res = await this.moveItem(replacement, src, characterId, session, { silent: true });\n              if (!res.success) {\n                errorLog('Transfer', `Failed to move replacement ${replacement.itemInstanceId} for exotic conflict: ${res.error}`);\n                return res;\n              }\n            }\n            const equipRes = await this.equipItem(replacement.itemInstanceId!, characterId, { silent: true });\n            if (!equipRes.success) {\n              errorLog('Transfer', `Failed to equip replacement ${replacement.itemInstanceId}: ${equipRes.error}`);\n              // Don't fail the whole operation - Bungie might still allow the equip\n            }\n          } else {\n            errorLog('Transfer', `No replacement found for conflicting exotic in bucket ${conflict.bucketHash}`);\n            // DIM Parity: If no replacement found, the equip will likely fail - let Bungie handle it\n          }\n        }\n      }\n    }\n\n    try {\n      profileService.updateLocalStore({ instanceId: itemInstanceId, sourceId: characterId, targetId: characterId, isEquip: true });\n      await bungieApi.post(BUNGIE_CONFIG.endpoints.equipItem, { itemId: itemInstanceId, characterId, membershipType }, true);\n\n      if (!options?.silent) {\n        const itemDef = manifestService.getItem(useProfileStore.getState().itemInstances[itemInstanceId]?.itemHash || 0);\n        addToast({ type: 'success', message: `${itemDef?.displayProperties?.name || 'Item'} equipped`, duration: 3000 });\n      }\n      return { success: true, request: { itemId: itemInstanceId, itemHash: 0, toCharacter: characterId, action: 'equip' } };\n    } catch (error: any) {\n      const errorCode = error?.errorCode;\n\n      // DIM Parity: Retry on 500/504 errors\n      if ((error?.httpStatus === 500 || error?.httpStatus === 504) && !options?.silent) {\n        // Simple retry counter check (using a local variable since equip doesn't always have a session passed in the same way)\n        // For now, we just do one retry for equip if it's a server error\n        if (!options?.silent) { // Don't infinite loop if silent is false but we re-call with silent=false\n          infoLog('Transfer', `500 error during equip of ${itemInstanceId}. Retrying once...`);\n          await new Promise(r => setTimeout(r, 1000));\n          return this.equipItem(itemInstanceId, characterId, { ...options, silent: true });\n        }\n      }\n\n      // DIM Parity: Handle ghost success for 500 errors\n      if (error?.httpStatus === 500 || error?.isPotentialSuccess) {\n        debugLog('Transfer', `500 error during equip of ${itemInstanceId}. Verifying ghost success...`);\n        await new Promise(r => setTimeout(r, 1500));\n        await profileLoader.loadProfile(true);\n\n        let currentInstance = useProfileStore.getState().itemInstances[itemInstanceId];\n        if (currentInstance?.isEquipped) {\n          infoLog('Transfer', `Ghost success detected for ${itemInstanceId} equip on ${characterId}`);\n          if (!options?.silent) {\n            const itemName = manifestService.getName(currentInstance.itemHash || 0) || 'Item';\n            addToast({ type: 'success', message: `${itemName} equipped` });\n          }\n          return { success: true, request: { itemId: itemInstanceId, itemHash: 0, toCharacter: characterId, action: 'equip' } };\n        }\n\n        // Retry check\n        await new Promise(r => setTimeout(r, 1000));\n        await profileLoader.loadProfile(true);\n        currentInstance = useProfileStore.getState().itemInstances[itemInstanceId];\n        if (currentInstance?.isEquipped) {\n          infoLog('Transfer', `Ghost success detected (retry) for ${itemInstanceId} equip on ${characterId}`);\n          if (!options?.silent) {\n            const itemName = manifestService.getName(currentInstance.itemHash || 0) || 'Item';\n            addToast({ type: 'success', message: `${itemName} equipped` });\n          }\n          return { success: true, request: { itemId: itemInstanceId, itemHash: 0, toCharacter: characterId, action: 'equip' } };\n        }\n      }\n\n      if (errorCode === PlatformErrorCodes.DestinyItemNotFound || error?.httpStatus === 500) {\n        await profileLoader.loadProfile(true);\n        const currentInstance = useProfileStore.getState().itemInstances[itemInstanceId];\n        if (currentInstance?.isEquipped) return { success: true, request: { itemId: itemInstanceId, itemHash: 0, toCharacter: characterId, action: 'equip' } };\n      }\n      if (!options?.silent) addToast({ type: 'error', message: error.message || 'Equip failed' });\n      return { success: false, error: error.message, request: { itemId: itemInstanceId, itemHash: 0, toCharacter: characterId, action: 'equip' } };\n    } finally {\n      useProfileStore.getState().removeActiveTransfer(itemInstanceId);\n    }\n  }\n\n  async smartTransfer(itemInstanceId: string, itemHash: number, toVault: boolean, characterId: string, session: MoveSession, options?: { silent?: boolean }): Promise<TransferResult> {\n    const state = useProfileStore.getState();\n    const item = state.getAllInventory().find(i => i.itemInstanceId === itemInstanceId);\n    if (!item) return { success: false, error: 'Not found', request: { itemId: itemInstanceId, itemHash, toCharacter: toVault ? 'vault' : characterId, action: 'transfer' } };\n    return this.moveItem(item, this.getItemSource(item), toVault ? 'vault' : characterId, session, options);\n  }\n\n  async snapshotLoadout(characterId: string, loadoutIndex: number): Promise<{ success: boolean; error?: string }> {\n    const membership = await profileService.getPrimaryMembership();\n    const identifiers = manifestService.getDefaultLoadoutIdentifiers();\n    if (!membership || !identifiers) return { success: false, error: 'Missing data' };\n    try {\n      await bungieApi.post(BUNGIE_CONFIG.endpoints.snapshotLoadout, {\n        loadoutIndex,\n        characterId,\n        membershipType: membership.membershipType,\n        colorHash: identifiers.colorHash,\n        iconHash: identifiers.iconHash,\n        nameHash: identifiers.nameHash\n      }, true);\n      return { success: true };\n    } catch (e: any) { return { success: false, error: e.message }; }\n  }\n\n  async moveItemToVault(characterId: string, bucketHash: number): Promise<TransferResult> {\n    const state = useProfileStore.getState();\n    const session = createMoveSession([], 1);\n    const candidates = this.findMoveAsideCandidates(bucketHash, characterId, session, state);\n    if (candidates.length > 0) return this.moveItem(candidates[0], characterId, 'vault', session, { silent: true });\n    return { success: false, error: 'No candidates', request: { itemId: '', itemHash: 0, toCharacter: 'vault', action: 'transfer' } };\n  }\n\n  async applyItemSocketOverrides(itemInstanceId: string, overrides: Record<number, number>, characterId: string, _options?: { silent?: boolean }): Promise<void> {\n    const state = useProfileStore.getState();\n    const instance = state.itemInstances[itemInstanceId];\n    for (const [idx, hash] of Object.entries(overrides)) {\n      const socketIndex = parseInt(idx);\n      if (instance?.sockets?.find(s => s.socketIndex === socketIndex)?.plugHash === hash) continue;\n      try {\n        await this.insertSocketPlugFree(itemInstanceId, hash, socketIndex, characterId, { silent: true });\n        await new Promise(r => setTimeout(r, 250));\n      } catch (e: any) {\n        if (e.httpStatus === 500 || e.errorCode === 5) {\n          await profileLoader.loadProfile(true);\n          await new Promise(r => setTimeout(r, 1000));\n        }\n      }\n    }\n    await profileLoader.loadProfile(true);\n  }\n\n  async equipItems(itemInstanceIds: string[], characterId: string, retryDepth = 0, options?: { silent?: boolean }): Promise<{ success: boolean; error?: string; failedIds: string[]; results: Record<string, number> }> {\n    if (itemInstanceIds.length === 0) return { success: true, failedIds: [], results: {} };\n    if (retryDepth > 2) return { success: false, failedIds: itemInstanceIds, results: {} };\n\n    const state = useProfileStore.getState();\n    const character = state.characters.find(c => c.characterId === characterId);\n\n    // DIM Parity: Filter out items that are already equipped on the target character\n    const targetEquipment = state.characterEquipment[characterId] || [];\n    const filteredIds = itemInstanceIds.filter(id => !targetEquipment.some(eq => eq.itemInstanceId === id));\n\n    if (filteredIds.length === 0) {\n      debugLog('Transfer', `All items in bulk request are already equipped on ${characterId}. Skipping API call.`);\n      return { success: true, failedIds: [], results: {} };\n    }\n\n    const membership = await profileService.getPrimaryMembership();\n    const membershipType = membership?.membershipType ?? character?.membershipType;\n\n    try {\n      const response = await bungieApi.post<{ equipResults: Array<{ itemInstanceId: string; equipStatus: number }> }>(\n        BUNGIE_CONFIG.endpoints.equipItems,\n        { itemIds: filteredIds, characterId, membershipType },\n        true\n      );\n\n      const results: Record<string, number> = {};\n      const failedIds: string[] = [];\n      let restricted = false;\n\n      response.equipResults.forEach(r => {\n        results[r.itemInstanceId] = r.equipStatus;\n        if (r.equipStatus === 1) profileService.updateLocalStore({ instanceId: r.itemInstanceId, sourceId: characterId, targetId: characterId, isEquip: true });\n        else {\n          failedIds.push(r.itemInstanceId);\n          if (r.equipStatus === 1634 || r.equipStatus === 1663) restricted = true;\n        }\n      });\n\n      if (failedIds.length > 0 && retryDepth < 2 && !restricted) {\n        await new Promise(r => setTimeout(r, 2000));\n        await profileLoader.loadProfile(true);\n        return this.equipItems(failedIds, characterId, retryDepth + 1, options);\n      }\n\n      return { success: failedIds.length === 0, error: restricted ? 'ORBIT_REQUIRED' : undefined, failedIds, results };\n    } catch (error: any) {\n      if (error?.httpStatus === 500 || error?.isPotentialSuccess) {\n        debugLog('Transfer', `500 error during bulk equip on ${characterId}. Verifying ghost success...`);\n        await new Promise(r => setTimeout(r, 1200));\n        await profileLoader.loadProfile(true);\n\n        const latestState = useProfileStore.getState();\n        const latestEquipment = latestState.characterEquipment[characterId] || [];\n        const results: Record<string, number> = {};\n        const failedIds: string[] = [];\n\n        itemInstanceIds.forEach(id => {\n          const isEquipped = latestEquipment.some(eq => eq.itemInstanceId === id);\n          if (isEquipped) {\n            results[id] = 1;\n            profileService.updateLocalStore({ instanceId: id, sourceId: characterId, targetId: characterId, isEquip: true });\n          } else {\n            failedIds.push(id);\n            results[id] = 0;\n          }\n        });\n\n        if (failedIds.length < itemInstanceIds.length) {\n          infoLog('Transfer', `Partial ghost success detected for bulk equip on ${characterId}. ${itemInstanceIds.length - failedIds.length} items equipped.`);\n          return { success: failedIds.length === 0, failedIds, results };\n        }\n      }\n\n      return { success: false, error: error.message, failedIds: itemInstanceIds, results: {} };\n    }\n  }\n\n  async equipBuild(template: BuildTemplate, characterId: string, onProgress?: (step: string, progress: number) => void, transferOnly = false, options?: { silent?: boolean }): Promise<{ success: boolean; error?: string; missing: string[]; failed: string[]; equipped: string[]; session?: MoveSession }> {\n    return queueAction(async () => {\n      const store = useProfileStore.getState();\n      if (store.selectedCharacterId !== characterId) store.setSelectedCharacter(characterId);\n\n      await profileLoader.loadProfile(true);\n      const state = useProfileStore.getState();\n      const all = state.getAllInventory();\n      const missing: string[] = [];\n\n      const getLoadoutItem = (loadoutItemHash: number, _name: string, storeId: string): DestinyItem | undefined => {\n        const hash = oldToNewItems[loadoutItemHash] ?? loadoutItemHash;\n        const candidates = all.filter(i => i.itemHash === hash);\n\n        // DIM Parity: Priority 1: Item already on the target character\n        const held = candidates.find(i => this.getItemSource(i) === storeId);\n        if (held) return held;\n\n        // DIM Parity: Priority 2: First candidate found elsewhere, UNLESS it's notransfer\n        const firstInRange = candidates[0];\n        if (firstInRange) {\n          // 2 = Not transferable (from DestinyItem.transferStatus)\n          const isNoTransfer = (firstInRange.transferStatus & 2) === 2;\n          if (!isNoTransfer) return firstInRange;\n        }\n\n        return undefined;\n      };\n\n      const findOrTrack = (hash: number, name: string) => {\n        const item = getLoadoutItem(hash, name, characterId);\n        if (!item) missing.push(name || hash.toString());\n        return item;\n      };\n\n      const exoticW = template.exoticWeapon ? findOrTrack(template.exoticWeapon.hash, template.exoticWeapon.name || '') : undefined;\n      const exoticA = template.exoticArmor ? findOrTrack(template.exoticArmor.hash, template.exoticArmor.name || '') : undefined;\n\n      const character = state.characters.find(c => c.characterId === characterId);\n      const targetItems = [...(state.characterInventories[characterId] || []), ...(state.characterEquipment[characterId] || [])];\n\n      // DIM Parity: Subclasses are NOT transferable. We MUST find one on the target character.\n      let subclass: DestinyItem | undefined = undefined;\n      const subclassConfig = template.subclassConfig;\n      if (subclassConfig?.subclassHash) {\n        const hash = oldToNewItems[subclassConfig.subclassHash] ?? subclassConfig.subclassHash;\n        subclass = targetItems.find(i => i.itemHash === hash);\n      }\n\n      // Fallback: match by element hash on character (matches \"always pulls the subclass... if it can\")\n      if (!subclass && template.element) {\n        subclass = this.findSubclassItem(template.element, targetItems, character?.classType);\n      }\n\n      if (!subclass) {\n        missing.push(`Subclass (${template.element})`);\n      }\n\n      if (missing.length > 0 && !options?.silent) {\n        useToastStore.getState().addToast({\n          type: 'warning',\n          message: `Some loadout items missing: ${missing.join(', ')}. Equipping remaining components.`,\n          duration: 4000\n        });\n      }\n\n      const itemsToMove: DestinyItem[] = [];\n      if (exoticW && this.itemCanBeEquippedBy(exoticW, characterId)) itemsToMove.push(exoticW);\n      if (exoticA && this.itemCanBeEquippedBy(exoticA, characterId)) itemsToMove.push(exoticA);\n      if (subclass && this.itemCanBeEquippedBy(subclass, characterId)) itemsToMove.push(subclass);\n\n      (template.items || []).forEach(ti => {\n        const i = findOrTrack(ti.hash, ti.name || '');\n        if (i && this.itemCanBeEquippedBy(i, characterId)) {\n          itemsToMove.push(i);\n        }\n      });\n\n      const session = createMoveSession(itemsToMove.map(i => i.itemInstanceId!).filter(Boolean), 5, characterId);\n      if (!onProgress) onProgress = () => { };\n\n      let replacements: DestinyItem[] = [];\n      const moveFailures: { hash: number; name: string }[] = [];\n      let equipRestricted = false;\n      const failed: string[] = [];\n      let ids: string[] = [];\n\n      try {\n        onProgress('Dequipping Conflicts...', 15);\n        const itemsToDequip = itemsToMove.filter(i => (i.transferStatus & 1) === 1 && this.getItemSource(i) !== characterId);\n        for (const item of itemsToDequip) {\n          try {\n            await profileService.ensureItemUnequipped(this.getItemSource(item), item.itemInstanceId!);\n          } catch (e) {\n            errorLog('Transfer', `Initial dequip failed for ${item.itemHash}`, e);\n          }\n        }\n\n        replacements = await this.resolveExoticConflicts(characterId, exoticW, exoticA, session);\n        await profileLoader.loadProfile(true);\n\n        onProgress('Moving Gear...', 40);\n        for (const i of itemsToMove) {\n          const src = this.getItemSource(i);\n          if (src !== characterId) {\n            let res = await this.moveItem(i, src, characterId, session, { silent: true });\n            if (!res.success) {\n              await profileLoader.loadProfile(true);\n              res = await this.moveItem(i, this.getItemSource(i), characterId, session, { silent: true });\n              if (!res.success) {\n                const def = manifestService.getItem(i.itemHash);\n                moveFailures.push({ hash: i.itemHash, name: def?.displayProperties?.name || i.itemHash.toString() });\n              }\n            }\n          }\n        }\n\n        if (transferOnly) return { success: true, session, missing, failed: [], equipped: [] };\n\n        onProgress('Equipping Build...', 60);\n\n        // 1. Bulk Equip Gear (Weapons/Armor)\n        ids = Array.from(new Set(replacements.concat(itemsToMove).map(i => i.itemInstanceId!)));\n        const equipRes = await this.equipItems(ids, characterId, 0, { silent: true });\n        if (equipRes.error === 'ORBIT_REQUIRED') equipRestricted = true;\n\n        (equipRes as any).failedIds?.forEach((fid: string) => {\n          const item = state.itemInstances[fid];\n          failed.push(item?.itemHash ? (manifestService.getItem(item.itemHash)?.displayProperties.name || fid) : fid);\n        });\n\n        // 2. Subclass Pre-Equip (DIM Parity: Must be equipped before configuration)\n        if (subclass && !template.skipSubclassSwap) {\n          try {\n            const currentSubclass = (state.characterEquipment[characterId] || []).find(i => i.bucketHash === BUCKET_HASHES.SUBCLASS);\n            if (currentSubclass?.itemInstanceId !== subclass.itemInstanceId) {\n              onProgress('Switching Subclass...', 70);\n              await this.equipItem(subclass.itemInstanceId!, characterId, { silent: true });\n              // DIM Parity: settle interval\n              await new Promise(r => setTimeout(r, 1000));\n              await profileLoader.loadProfile(true);\n            }\n          } catch {\n            equipRestricted = true;\n            errorLog('Transfer', 'Subclass pre-equip failed');\n          }\n        }\n      } catch (e) {\n        errorLog('Transfer', 'Gear phase failure (continuing to subclass/mods)', e);\n      }\n\n      const failureNames = [...new Set([...failed, ...moveFailures.map(f => f.name)])];\n      const hasMajorFailures = failureNames.length > 0;\n\n      // DIM Parity: Configuration phase (always happens sequentially after gear is settled)\n      if (!template.skipSocketOverrides) {\n        // 3. Subclass Configuration (Supers, Abilities, Aspects, Fragments)\n        if (subclass && template.subclassConfig) {\n          onProgress('Configuring Subclass...', 85);\n          try {\n            await this.applySubclassConfiguration(subclass, template.subclassConfig, characterId, (s: string) => onProgress!(s, 85), { silent: true });\n          } catch (e) {\n            errorLog('Transfer', `Failed to apply subclass config: ${e}`);\n          }\n        }\n\n        // 4. Armor Mods (General then Fashion)\n        if (template.armorMods?.length) {\n          onProgress('Applying Armor Mods...', 95);\n          try {\n            await this.applyArmorMods(characterId, template.armorMods, (s: string) => onProgress!(s, 95), { silent: true });\n          } catch (e) {\n            errorLog('Transfer', `Failed to apply armor mods: ${e}`);\n          }\n        }\n      }\n\n      if (!options?.silent) {\n        let msg = `${template.name} equipped successfully!`;\n        let toastType: 'success' | 'warning' | 'error' = 'success';\n\n        if (equipRestricted) {\n          msg = `${template.name} moved, but Orbit is required to equip.`;\n          toastType = 'warning';\n        } else if (hasMajorFailures || missing.length > 0) {\n          msg = `${template.name} applied with issues. Check notifications.`;\n          toastType = 'warning';\n        }\n\n        useToastStore.getState().addToast({ type: toastType, message: msg });\n      }\n\n      return { success: !equipRestricted && !hasMajorFailures, session, missing, failed: failureNames, equipped: ids };\n    }).catch(err => {\n      errorLog('Transfer', 'EquipBuild Fatal', err);\n      return { success: false, error: err.message, missing: [], failed: [], equipped: [] };\n    });\n  }\n\n  /**\n   * DIM Parity: executeMoveItem equivalent\n   * Move item to target store, optionally equipping it.\n   *\n   * KEY DIFFERENCE FROM BEFORE: For char-to-char transfers, we now:\n   * 1. Dequip at source FIRST\n   * 2. Move to vault (no exotic check needed - equip=false)\n   * 3. Then call ensureValidTransfer which handles BOTH space AND exotic conflicts\n   * 4. Move from vault to target\n   * 5. Equip if requested\n   */\n  async moveItem(item: DestinyItem, sourceId: string, targetId: string, session?: MoveSession, options?: { silent?: boolean; equip?: boolean }): Promise<TransferResult> {\n    const s = session || createMoveSession([item.itemInstanceId!]);\n    let state = useProfileStore.getState();\n    const equip = options?.equip ?? false;\n\n    // DIM Parity Lock Bug Workaround: Record lock state if duplicates exist\n    const isLocked = state.itemInstances[item.itemInstanceId!]?.isLocked;\n    const hasDuplicates = (sourceId === 'vault'\n      ? state.vaultInventory.filter(i => i.itemHash === item.itemHash && this.getNativeBucketHash(i) === this.getNativeBucketHash(item))\n      : [...(state.characterEquipment[sourceId] || []), ...(state.characterInventories[sourceId] || [])]\n        .filter(i => i.itemHash === item.itemHash && i.bucketHash === item.bucketHash)\n    ).length > 1;\n    const lockResetState = (isLocked !== undefined && hasDuplicates) ? isLocked : undefined;\n\n    // Same store - just equip if needed\n    if (sourceId === targetId) {\n      if (equip) return this.equipItem(item.itemInstanceId!, targetId, options);\n      return { success: true, request: { itemId: item.itemInstanceId!, itemHash: item.itemHash, toCharacter: targetId, action: 'transfer' } };\n    }\n\n    const sourceIsVault = sourceId === 'vault';\n    const targetIsVault = targetId === 'vault';\n    const isCharToChar = !sourceIsVault && !targetIsVault;\n\n    // \n    // CASE 1: Character to Character (requires vault routing)\n    // DIM Pattern: dequip at source  ensureValidTransfer(vault)  moveToVault \n    //              ensureValidTransfer(target, equip)  moveToStore  equip if needed\n    // \n    if (isCharToChar) {\n      // Step 1: Dequip at source if equipped\n      const isEquippedAtSource = (state.characterEquipment[sourceId] || []).some(i => i.itemInstanceId === item.itemInstanceId);\n      if (isEquippedAtSource) {\n        // DIM Parity: When dequipping an exotic, we must replace it with a non-exotic\n        // Otherwise we might try to equip an exotic replacement which conflicts with other equipped exotics\n        const itemDef = manifestService.getItem(item.itemHash);\n        const itemIsExotic = itemDef?.tierType === 6;\n\n        infoLog('Transfer', `[CharChar] Step 1: Dequipping ${item.itemHash} at source ${sourceId} (exotic=${itemIsExotic})`);\n        const dequipped = await profileService.ensureItemUnequipped(sourceId, item.itemInstanceId!, itemIsExotic, s);\n        if (!dequipped) {\n          errorLog('Transfer', `Failed to dequip ${item.itemHash} at source`);\n          return { success: false, error: 'Dequip failed at source', request: { itemId: item.itemInstanceId!, itemHash: item.itemHash, toCharacter: targetId, action: 'transfer' } };\n        }\n        await new Promise(r => setTimeout(r, 200));\n        state = useProfileStore.getState();\n      }\n\n      // Step 2: Ensure vault has space (NO exotic check - equip=false for vault)\n      infoLog('Transfer', `[CharChar] Step 2: Ensuring vault space for ${item.itemHash}`);\n      const vaultStore = { id: 'vault', isVault: true, items: state.vaultInventory };\n      if (!(await this.ensureCanMoveToStore(item, vaultStore, 1, s))) {\n        return { success: false, error: 'No space in vault', request: { itemId: item.itemInstanceId!, itemHash: item.itemHash, toCharacter: targetId, action: 'transfer' } };\n      }\n\n      // Step 3: Move to vault via API\n      infoLog('Transfer', `[CharChar] Step 3: Moving ${item.itemHash} to vault`);\n      const toVaultRes = await this.moveToStore(item, sourceId, 'vault', false, s, { silent: true });\n      if (!toVaultRes.success) return toVaultRes;\n\n      // Short delay for Bungie backend consistency\n      await new Promise(r => setTimeout(r, 200));\n      state = useProfileStore.getState();\n\n      // Step 4: ensureValidTransfer for target - THIS handles exotic conflicts!\n      infoLog('Transfer', `[CharChar] Step 4: Ensuring target space + exotic conflicts for ${item.itemHash}`);\n      const targetChar = state.characters.find((c: any) => c.characterId === targetId);\n      if (targetChar) {\n        // Wrap with id property for ensureCanMoveToStore compatibility\n        const targetStore = { ...targetChar, id: targetId };\n        const valid = await this.ensureValidTransfer(equip, targetStore, item, 1, s);\n        if (!valid) {\n          return { success: false, error: 'Cannot complete transfer to target', request: { itemId: item.itemInstanceId!, itemHash: item.itemHash, toCharacter: targetId, action: 'transfer' } };\n        }\n      }\n\n      // Step 5: Move from vault to target via API\n      infoLog('Transfer', `[CharChar] Step 5: Moving ${item.itemHash} from vault to ${targetId}`);\n      const toTargetRes = await this.moveToStore(item, 'vault', targetId, equip, s, options);\n      if (!toTargetRes.success) return toTargetRes;\n\n      // Step 6: Final equip check (moveToStore handles equip, but double-check)\n      state = useProfileStore.getState();\n      const isNowEquipped = (state.characterEquipment[targetId] || []).some(i => i.itemInstanceId === item.itemInstanceId);\n      if (equip && !isNowEquipped) {\n        infoLog('Transfer', `[CharChar] Step 6: Final equip for ${item.itemHash}`);\n        return this.equipItem(item.itemInstanceId!, targetId, options);\n      }\n\n      this.handleLockStateReset(item, targetId, lockResetState, state);\n      return toTargetRes;\n    }\n\n    // \n    // CASE 2: Vault  Character (single hop)\n    // \n\n    // Dequip at source if moving FROM character and item is equipped\n    if (!sourceIsVault) {\n      const isEquippedAtSource = (state.characterEquipment[sourceId] || []).some(i => i.itemInstanceId === item.itemInstanceId);\n      if (isEquippedAtSource) {\n        // DIM Parity: When dequipping an exotic, we must replace it with a non-exotic\n        const itemDef = manifestService.getItem(item.itemHash);\n        const itemIsExotic = itemDef?.tierType === 6;\n\n        infoLog('Transfer', `[Single-hop] Dequipping ${item.itemHash} at source ${sourceId} (exotic=${itemIsExotic})`);\n        const dequipped = await profileService.ensureItemUnequipped(sourceId, item.itemInstanceId!, itemIsExotic, s);\n        if (!dequipped) {\n          return { success: false, error: 'Dequip failed at source', request: { itemId: item.itemInstanceId!, itemHash: item.itemHash, toCharacter: targetId, action: 'transfer' } };\n        }\n        await new Promise(r => setTimeout(r, 200));\n        state = useProfileStore.getState();\n      }\n    }\n\n    // Determine target store for space/exotic check\n    // Note: Characters need id property for ensureCanMoveToStore compatibility\n    const targetChar = targetIsVault ? null : state.characters.find((c: any) => c.characterId === targetId);\n    const store = targetIsVault\n      ? { id: 'vault', isVault: true, items: state.vaultInventory }\n      : targetChar ? { ...targetChar, id: targetId } : null;\n\n    if (store) {\n      // ensureValidTransfer handles BOTH space AND exotic conflicts\n      const valid = await this.ensureValidTransfer(equip && !targetIsVault, store, item, 1, s);\n      if (!valid) {\n        return { success: false, error: 'No space available', request: { itemId: item.itemInstanceId!, itemHash: item.itemHash, toCharacter: targetId, action: 'transfer' } };\n      }\n    }\n\n    // Perform the transfer + optional equip\n    const res = await this.moveToStore(item, sourceId, targetId, equip && !targetIsVault, s, options);\n\n    this.handleLockStateReset(item, targetId, lockResetState, state);\n    return res;\n  }\n\n  /**\n   * DIM Parity: ensureValidTransfer\n   * Ensures the transfer is valid by:\n   * 1. Checking if equip is possible (class/level)\n   * 2. Handling exotic conflicts if equipping an exotic\n   * 3. Ensuring space is available\n   */\n  private async ensureValidTransfer(\n    equip: boolean,\n    store: any,\n    item: DestinyItem,\n    amount: number,\n    session: MoveSession\n  ): Promise<boolean> {\n    const def = manifestService.getItem(item.itemHash);\n\n    if (equip && !store.isVault) {\n      // Check exotic conflict and resolve it\n      if (def?.inventory?.equippingLabel) {\n        const canEquip = await this.canEquipExotic(item, store, session);\n        if (!canEquip) {\n          errorLog('Transfer', `Cannot equip exotic ${item.itemHash} on ${store.id || store.characterId}`);\n          return false;\n        }\n      }\n    }\n\n    // Ensure space is available\n    return this.ensureCanMoveToStore(item, store, amount, session);\n  }\n\n  /**\n   * DIM Parity: canEquipExotic\n   * Checks if an exotic can be equipped and dequips any conflicting exotic.\n   * Returns true if exotic can be equipped, false if conflict couldn't be resolved.\n   */\n  private async canEquipExotic(item: DestinyItem, store: any, session: MoveSession): Promise<boolean> {\n    const def = manifestService.getItem(item.itemHash);\n    if (!def?.inventory?.equippingLabel) return true;\n\n    const storeId = store.id || store.characterId;\n    const state = useProfileStore.getState();\n    const currentEq = state.characterEquipment[storeId] || [];\n    const label = def.inventory.equippingLabel;\n\n    debugLog('Transfer', `canEquipExotic: Checking for conflict with label=${label} on ${storeId}`);\n\n    // Find conflicting exotic (same label, different bucket)\n    const otherExotic = currentEq.find(i => {\n      const iDef = manifestService.getItem(i.itemHash);\n      return iDef?.inventory?.equippingLabel === label && i.bucketHash !== item.bucketHash;\n    });\n\n    if (!otherExotic) {\n      debugLog('Transfer', `canEquipExotic: No conflict found`);\n      return true;\n    }\n\n    infoLog('Transfer', `canEquipExotic: Conflict found - ${otherExotic.itemHash} in bucket ${otherExotic.bucketHash}. Dequipping...`);\n\n    // Dequip the conflicting exotic (excludeExotic=true to not replace with another exotic)\n    const dequipped = await profileService.ensureItemUnequipped(storeId, otherExotic.itemInstanceId!, true, session);\n    if (!dequipped) {\n      errorLog('Transfer', `canEquipExotic: Failed to dequip conflicting exotic ${otherExotic.itemHash}`);\n      return false;\n    }\n\n    infoLog('Transfer', `canEquipExotic: Successfully dequipped ${otherExotic.itemHash}`);\n    return true;\n  }\n\n  /**\n   * DIM Parity: moveToStore\n   * Low-level transfer that makes the API call and optionally equips.\n   * This is analogous to DIM's moveToStore function.\n   */\n  private async moveToStore(\n    item: DestinyItem,\n    sourceId: string,\n    targetId: string,\n    equip: boolean,\n    session: MoveSession,\n    options?: { silent?: boolean }\n  ): Promise<TransferResult> {\n    const toVault = targetId === 'vault';\n    const characterId = toVault ? sourceId : targetId;\n\n    // Make the transfer API call\n    // Skip space check since moveItem/moveToStore caller already verified space via ensureValidTransfer\n    const res = await this.transferItem(\n      item.itemInstanceId!,\n      item.itemHash,\n      toVault,\n      characterId,\n      1,\n      session,\n      { ...options, silent: true, skipSpaceCheck: true }\n    );\n\n    if (!res.success) {\n      if (!options?.silent) {\n        useToastStore.getState().addToast({ type: 'error', message: res.error || 'Transfer failed' });\n      }\n      return res;\n    }\n\n    // If equip requested and target is not vault, equip the item\n    if (equip && !toVault) {\n      const equipRes = await this.equipItem(item.itemInstanceId!, targetId, { silent: true });\n      if (!equipRes.success) {\n        // Don't fail the whole operation - item is transferred, just not equipped\n        if (!options?.silent) {\n          useToastStore.getState().addToast({ type: 'warning', message: 'Item moved but equip failed' });\n        }\n      }\n      return equipRes;\n    }\n\n    if (!options?.silent) {\n      const itemDef = manifestService.getItem(item.itemHash);\n      useToastStore.getState().addToast({ type: 'success', message: `${itemDef?.displayProperties?.name || 'Item'} moved`, duration: 2000 });\n    }\n\n    return res;\n  }\n\n  /**\n   * Handle lock state reset asynchronously after transfers\n   */\n  private handleLockStateReset(item: DestinyItem, targetId: string, lockResetState: boolean | undefined, state: any): void {\n    if (lockResetState !== undefined) {\n      const anyCharId = Object.keys(state.characterInventories)[0];\n      const effectiveCharId = targetId === 'vault' ? anyCharId : targetId;\n      if (effectiveCharId) {\n        debugLog('Transfer', `Bungie Lock Bug: Resetting lock status of ${item.itemHash} to ${lockResetState}`);\n        this.setItemLockState(item.itemInstanceId!, effectiveCharId, lockResetState).catch(() => { });\n      }\n    }\n  }\n\n  /**\n   * DIM Parity: Recursive space-making logic.\n   * Ensures there is enough space to move the given item into store.\n   * This will move items aside in an attempt to make a move possible.\n   */\n  private async ensureCanMoveToStore(\n    item: DestinyItem,\n    store: any,\n    amount: number,\n    session: MoveSession,\n    options: { excludes: any[]; numRetries?: number; depth?: number } = { excludes: [] }\n  ): Promise<boolean> {\n    const { excludes, numRetries = 0, depth = 0 } = options;\n\n    // Prevent infinite recursion - max 10 items moved aside\n    if (depth > 10) {\n      errorLog('Transfer', `Max recursion depth reached trying to make space for ${item.itemHash}`);\n      return false;\n    }\n\n    // DIM Standard: Re-fetch latest state before every space check to avoid desync\n    const state = useProfileStore.getState();\n    const classNames = ['Titan', 'Hunter', 'Warlock'];\n    const stores = [\n      ...state.characters.map((c: any) => ({ ...c, id: c.characterId, name: classNames[c.classType] || 'Guardian' })),\n      { name: 'Vault', id: 'vault', isVault: true, items: state.vaultInventory }\n    ];\n\n    const bucketHash = this.getNativeBucketHash(item);\n\n    // How much space will be needed in the target store?\n    const storeReservations: Record<string, number> = {};\n    storeReservations[store.id] = amount;\n\n    // Guardian-to-guardian transfer will also need space in the vault\n    const sourceId = this.getItemSource(item, state);\n    if (sourceId !== 'vault' && !store.isVault && sourceId !== store.id) {\n      storeReservations.vault = amount;\n    }\n\n    // Check space without adding reservations - trust optimistic updates instead\n    const movesNeeded: Record<string, number> = {};\n    for (const s of stores) {\n      if (storeReservations[s.id]) {\n        const left = this.getSpaceInBucket(bucketHash, s.id, state, session);\n        movesNeeded[s.id] = Math.max(0, storeReservations[s.id] - left);\n        debugLog('Transfer', `Space check for ${s.name} (${s.id}): left=${left}, reserved=${storeReservations[s.id]}, movesNeeded=${movesNeeded[s.id]}`);\n      }\n    }\n\n    if (Object.values(movesNeeded).every(m => m === 0)) {\n      return true;\n    }\n\n    const moveAsideSourceEntries = Object.entries(movesNeeded).reverse().filter(([_, amt]) => (amt as number) > 0);\n    const [moveAsideSourceId] = moveAsideSourceEntries[0] || [];\n    if (!moveAsideSourceId) return true;\n\n    const sourceStore = stores.find(s => s.id === moveAsideSourceId);\n    const context: MoveContext = {\n      originalItemType: bucketHash,\n      excludes,\n      spaceLeft: (s, i) => {\n        let left = this.getSpaceInBucket(this.getNativeBucketHash(i), s.id, state, session);\n        // If this is the target store for the original move, we must reserve space for it\n        if (s.id === store.id && this.getNativeBucketHash(i) === bucketHash) {\n          left -= amount;\n        }\n        return Math.max(0, left);\n      }\n    };\n\n    infoLog('Transfer', `Making space in ${sourceStore?.name || moveAsideSourceId} for ${item.itemHash}. Moves needed:`, movesNeeded);\n    const choice = this.chooseMoveAsideItem(sourceStore, item, context, state, session);\n    if (!choice.item || !choice.target) {\n      errorLog('Transfer', `No move-aside candidate found for bucket ${bucketHash} in ${sourceStore?.name || moveAsideSourceId}. Total possible candidates checked: ${this.findMoveAsideCandidates(bucketHash, moveAsideSourceId, session, state).length}`);\n      return false;\n    }\n\n    try {\n      infoLog('Transfer', `Moving aside ${choice.item.itemHash} from ${sourceStore?.name || moveAsideSourceId} to ${choice.target.name || choice.target.id} to make room.`);\n      const res = await this.moveItem(choice.item, moveAsideSourceId, choice.target.id, session, { silent: true });\n\n      if (!res.success) {\n        throw new Error(`Move-aside failed: ${res.error}`);\n      }\n\n      // DIM Parity: Sequential spacing. 50ms is enough between moves if optimistic updates are working.\n      await new Promise(r => setTimeout(r, 50));\n\n      // Continue checking space with incremented depth\n      return this.ensureCanMoveToStore(item, store, amount, session, { excludes, numRetries: 0, depth: depth + 1 });\n    } catch (e) {\n      if (numRetries < 3) {\n        infoLog('Transfer', `Move-aside failed for ${choice.item.itemHash}, retrying with exclusion.`);\n        excludes.push(choice.item);\n        return this.ensureCanMoveToStore(item, store, amount, session, { excludes, numRetries: numRetries + 1, depth });\n      }\n      return false;\n    }\n  }\n\n  private chooseMoveAsideItem(sourceStore: any, displacingItem: DestinyItem, _context: MoveContext, state: any, session: MoveSession): { item?: DestinyItem; target?: any } {\n    const candidates = this.findMoveAsideCandidates(this.getNativeBucketHash(displacingItem), sourceStore.id, session, state);\n    if (!candidates.length) return {};\n\n    const sorted = this.sortMoveAsideCandidates(candidates, sourceStore, state);\n    const item = sorted[0];\n\n    // Find a target store with space\n    // DIM Parity: Prefer filling up the least-recently-played character first\n    const stores = [\n      ...state.characters\n        .sort((a: any, b: any) => new Date(a.dateLastPlayed).getTime() - new Date(b.dateLastPlayed).getTime())\n        .map((c: any) => ({ ...c, id: c.characterId })),\n      { name: 'Vault', id: 'vault', isVault: true, items: state.vaultInventory }\n    ];\n\n    const target = stores.find(s => s.id !== sourceStore.id && this.getSpaceInBucket(this.getNativeBucketHash(item), s.id, state, session) > 0);\n    return { item, target };\n  }\n\n  private sortMoveAsideCandidates(candidates: DestinyItem[], sourceStore: any, state: any): DestinyItem[] {\n    const builds = state.builds || [];\n    const buildItemIds = new Set(builds.flatMap((b: any) => [\n      b.kineticWeapon?.itemInstanceId, b.energyWeapon?.itemInstanceId, b.powerWeapon?.itemInstanceId,\n      b.helmet?.itemInstanceId, b.gauntlets?.itemInstanceId, b.chestArmor?.itemInstanceId,\n      b.legArmor?.itemInstanceId, b.classArmor?.itemInstanceId\n    ]).filter(Boolean));\n\n    return candidates.sort((a, b) => {\n      // 0. DIM Parity: Prefer items NOT in any loadouts\n      const inBuildA = buildItemIds.has(a.itemInstanceId!) ? 1 : 0;\n      const inBuildB = buildItemIds.has(b.itemInstanceId!) ? 1 : 0;\n      if (inBuildA !== inBuildB) return inBuildA - inBuildB;\n\n      // 1. Prefer moving unequipped items\n      const isEqA = (state.characterEquipment[sourceStore.id] || []).some((e: any) => e.itemInstanceId === a.itemInstanceId);\n      const isEqB = (state.characterEquipment[sourceStore.id] || []).some((e: any) => e.itemInstanceId === b.itemInstanceId);\n      if (isEqA !== isEqB) return isEqA ? 1 : -1;\n\n      // 2. Rarity (prefer moving lower rarity)\n      const tierA = a.tierType || 0;\n      const tierB = b.tierType || 0;\n      if (tierA !== tierB) return tierA - tierB;\n\n      // 3. Power (prefer moving lower power)\n      const pA = state.itemInstances[a.itemInstanceId!]?.power || 0;\n      const pB = state.itemInstances[b.itemInstanceId!]?.power || 0;\n      if (pA !== pB) return pA - pB;\n\n      return 0;\n    });\n  }\n\n  private getSpaceInBucket(bucketHash: number, characterId: string | 'vault', state: any, session?: MoveSession): number {\n    const reservations = session?.reservations?.[characterId]?.[bucketHash] || 0;\n\n    if (characterId === 'vault') {\n      // DIM Standard: Use manifest capacity for the vault bucket (1000 for weapons/armor)\n      const isGeneralBucket = [BUCKET_HASHES.KINETIC_WEAPONS, BUCKET_HASHES.ENERGY_WEAPONS, BUCKET_HASHES.POWER_WEAPONS,\n      BUCKET_HASHES.HELMET, BUCKET_HASHES.GAUNTLETS, BUCKET_HASHES.CHEST_ARMOR,\n      BUCKET_HASHES.LEG_ARMOR, BUCKET_HASHES.CLASS_ARMOR, BUCKET_HASHES.GHOST,\n      BUCKET_HASHES.VEHICLE, BUCKET_HASHES.SHIPS].includes(bucketHash);\n\n      if (isGeneralBucket) {\n        const generalUsage = state.vaultInventory.filter((i: any) => {\n          const native = this.getNativeBucketHash(i);\n          return ![BUCKET_HASHES.CONSUMABLES, BUCKET_HASHES.MODIFICATIONS].includes(native);\n        }).length;\n        return Math.max(0, VAULT_TOTAL_CAPACITY - (generalUsage + reservations));\n      }\n\n      if (bucketHash === BUCKET_HASHES.CONSUMABLES) {\n        const usage = state.vaultInventory.filter((i: any) => this.getNativeBucketHash(i) === BUCKET_HASHES.CONSUMABLES).length;\n        return Math.max(0, 50 - (usage + reservations));\n      }\n\n      if (bucketHash === BUCKET_HASHES.MODIFICATIONS) {\n        const usage = state.vaultInventory.filter((i: any) => this.getNativeBucketHash(i) === BUCKET_HASHES.MODIFICATIONS).length;\n        return Math.max(0, 50 - (usage + reservations));\n      }\n\n      return 0;\n    }\n\n    // Count inventory items (not equipped) - equipped items don't count against capacity\n    const charInventory = state.characterInventories[characterId] || [];\n    const usage = charInventory.filter((i: any) => this.getNativeBucketHash(i) === bucketHash).length;\n    let left = (BUCKET_CAPACITIES[bucketHash] || 10) - (usage + reservations);\n\n    // DIM Parity: Always leave 1 slot free in all equipment buckets to prevent 500 errors/stuck items\n    if (EQUIP_BUCKETS.has(bucketHash) || bucketHash === BUCKET_HASHES.CONSUMABLES) {\n      left -= 1;\n    }\n\n    return Math.max(0, left);\n  }\n\n  private findMoveAsideCandidates(bucketHash: number, characterId: string | 'vault', session: MoveSession, state: any): DestinyItem[] {\n    const isVault = characterId === 'vault';\n    const eq = isVault ? [] : (state.characterEquipment[characterId] || []);\n    const inv = isVault ? [] : (state.characterInventories[characterId] || []);\n    const all = isVault ? state.vaultInventory : [...inv, ...eq];\n\n    const filtered = all.filter((i: any) => {\n      const native = this.getNativeBucketHash(i);\n\n      // DIM Parity: Candidates must be in the same vault section if moving from vault\n      if (isVault) {\n        const isGeneral = (h: number) => ![BUCKET_HASHES.CONSUMABLES, BUCKET_HASHES.MODIFICATIONS].includes(h);\n        if (isGeneral(bucketHash) && !isGeneral(native)) return false;\n        if (bucketHash === BUCKET_HASHES.CONSUMABLES && native !== BUCKET_HASHES.CONSUMABLES) return false;\n        if (bucketHash === BUCKET_HASHES.MODIFICATIONS && native !== BUCKET_HASHES.MODIFICATIONS) return false;\n      } else {\n        // If moving from character, we only care about the same specific bucket\n        if (native !== bucketHash) return false;\n      }\n\n      // Can't move aside items involved in the current operation\n      if (session.involvedItems.has(i.itemInstanceId!)) return false;\n\n      // DIM Parity: Only move aside items that are actually in the character inventory (not postmaster)\n      if (!isVault && i.location !== 1) return false;\n\n      return true;\n    });\n\n    if (filtered.length === 0 && all.length > 0) {\n      infoLog('Transfer', `No candidates found in ${characterId} for bucket ${bucketHash}. Total items checked: ${all.length}. Involved: ${session.involvedItems.size}`);\n    }\n\n    return filtered.sort((a: any, b: any) => {\n      const isEqA = eq.some((e: any) => e.itemInstanceId === a.itemInstanceId), isEqB = eq.some((e: any) => e.itemInstanceId === b.itemInstanceId);\n      if (isEqA !== isEqB) return isEqA ? 1 : -1;\n      if (a.tierType !== b.tierType) return (a.tierType || 0) - (b.tierType || 0);\n      return (state.itemInstances[a.itemInstanceId!]?.power || 0) - (state.itemInstances[b.itemInstanceId!]?.power || 0);\n    });\n  }\n\n  async orchestrateBulkDequip(characterId: string, itemsToEquip: DestinyItem[]): Promise<boolean> {\n    const state = useProfileStore.getState();\n    const current = state.characterEquipment?.[characterId] || [];\n    const conflicts = current.filter((eq: any) => {\n      const target = itemsToEquip.find((t: any) => t.bucketHash === eq.bucketHash);\n      if (!target) return false;\n      const tDef = manifestService.getItem(target.itemHash), eDef = manifestService.getItem(eq.itemHash);\n      return tDef?.tierType === 6 && eDef?.tierType === 6;\n    });\n    for (const c of conflicts) await profileService.ensureItemUnequipped(characterId, c.itemInstanceId!, true);\n    return true;\n  }\n\n  private async resolveExoticConflicts(characterId: string, exoticW: any, exoticA: any, session: MoveSession): Promise<DestinyItem[]> {\n    const reps: DestinyItem[] = [];\n    const state = useProfileStore.getState();\n    const character = state.characters.find(c => c.characterId === characterId);\n    const currentEquipment = state.characterEquipment?.[characterId] || [];\n    const checkConflict = async (targetExotic: any) => {\n      if (!targetExotic) return;\n      const targetDef = manifestService.getItem(targetExotic.itemHash);\n      const conflict = currentEquipment.find(i => {\n        const def = manifestService.getItem(i.itemHash);\n        return def?.inventory?.equippingLabel === targetDef?.inventory?.equippingLabel && i.itemInstanceId !== targetExotic.itemInstanceId;\n      });\n      if (conflict) {\n        const rep = this.findReplacementItem(conflict.bucketHash, characterId, session.involvedItems, character?.classType);\n        if (rep) {\n          const src = this.getItemSource(rep, state);\n          if (src !== characterId) await this.moveItem(rep, src, characterId, session, { silent: true });\n          await this.equipItem(rep.itemInstanceId!, characterId, { silent: true });\n          reps.push(rep); session.involvedItems.add(rep.itemInstanceId!);\n        }\n      }\n    };\n    await checkConflict(exoticW); await checkConflict(exoticA);\n    return reps;\n  }\n\n  private searchForSimilarItem(\n    item: DestinyItem,\n    characterId: string,\n    exclusions: Set<string | number> = new Set(),\n    classType?: number,\n    excludeExotic = true\n  ): DestinyItem | undefined {\n    const state = useProfileStore.getState();\n    const all = [\n      ...state.vaultInventory,\n      ...Object.entries(state.characterInventories).flatMap(([_, items]) => items)\n    ];\n\n    const candidates = all.filter((i: any) => {\n      const native = this.getNativeBucketHash(i);\n      const def = manifestService.getItem(i.itemHash);\n      const isEquipped = (state.characterEquipment[this.getItemSource(i, state)] || []).some((e: any) => e.itemInstanceId === i.itemInstanceId);\n\n      return (\n        native === item.bucketHash &&\n        !isEquipped &&\n        !exclusions.has(i.itemInstanceId!) &&  // DIM Parity: Filter out items in exclusions\n        (i.transferStatus & 2) === 0 &&\n        (!excludeExotic || def?.tierType !== 6) &&\n        (classType === undefined || def?.classType === classType || def?.classType === 3)\n      );\n    });\n\n    if (candidates.length === 0) {\n      infoLog('Transfer', `searchForSimilarItem: No candidates for bucket ${item.bucketHash}. Checked ${all.length} items. ExcludeExotic: ${excludeExotic}`);\n      return undefined;\n    }\n\n    return candidates.sort((a, b) => {\n      // 0. DIM Parity: Prefer items NOT in the involved/exclusions list\n      const invA = exclusions.has(a.itemInstanceId!) ? 1 : 0;\n      const invB = exclusions.has(b.itemInstanceId!) ? 1 : 0;\n      if (invA !== invB) return invA - invB;\n\n      // DIM Parity: Prefer non-exotics even if excludeExotic is false\n      const tierA = a.tierType || 0, tierB = b.tierType || 0;\n      if (tierA !== tierB) {\n        if (tierA === 6) return 1;\n        if (tierB === 6) return -1;\n        return tierB - tierA; // Higher rarity (Legendary=5) before lower\n      }\n\n      const srcA = this.getItemSource(a, state);\n      const srcB = this.getItemSource(b, state);\n      const score = (src: string) => src === characterId ? 0 : (src === 'vault' ? 1 : 2);\n      if (score(srcA) !== score(srcB)) return score(srcA) - score(srcB);\n\n      const pA = state.itemInstances[a.itemInstanceId!]?.power || 0;\n      const pB = state.itemInstances[b.itemInstanceId!]?.power || 0;\n      return pB - pA;\n    })[0];\n  }\n\n  findReplacementItem(bucketHash: number, characterId: string, excludeInstanceIds: Set<string | number> = new Set(), classType?: number, excludeExotic = true): DestinyItem | undefined {\n    return this.searchForSimilarItem({ bucketHash } as DestinyItem, characterId, excludeInstanceIds, classType, excludeExotic);\n  }\n\n\n  private findSubclassItem(element: string, inv: DestinyItem[], classType?: number): DestinyItem | undefined {\n    if (!element) return undefined;\n    const elLower = element.toLowerCase();\n    const damageTypeHash = DAMAGE_TYPE_HASHES[elLower.toUpperCase() as keyof typeof DAMAGE_TYPE_HASHES];\n\n    return inv.find(i => {\n      if (i.bucketHash !== BUCKET_HASHES.SUBCLASS) return false;\n      const def = manifestService.getItem(i.itemHash);\n      if (!def || (classType !== undefined && def.classType !== classType && def.classType !== 3)) return false;\n\n      // Strict match by damage type hash if available\n      if (damageTypeHash && (def as any).defaultDamageTypeHash === damageTypeHash) return true;\n\n      // Fallback for Prismatic or edge cases\n      const name = (def.displayProperties?.name || '').toLowerCase();\n      return name.includes(elLower);\n    });\n  }\n\n  async applyArmorMods(characterId: string, mods: number[], onProgress: any, options?: { silent?: boolean }): Promise<void> { await modService.applyArmorMods(characterId, mods, onProgress, options); }\n  async applySubclassConfiguration(subclass: DestinyItem, config: any, characterId: string, onProgress: any, options?: { silent?: boolean }): Promise<void> { await modService.applySubclassConfiguration(subclass, config, characterId, onProgress, options); }\n  async setItemLockState(itemId: string, characterId: string, state: boolean): Promise<boolean> {\n    const char = useProfileStore.getState().characters.find(c => c.characterId === characterId) || useProfileStore.getState().characters[0];\n    if (!char) return false;\n    const membership = await profileService.getPrimaryMembership();\n    const membershipType = membership?.membershipType ?? char.membershipType;\n    try { await bungieApi.post(BUNGIE_CONFIG.endpoints.setLockState, { state, itemId, characterId: char.characterId, membershipType }, true); return true; } catch { return false; }\n  }\n  async insertSocketPlugFree(itemId: string, plugHash: number, socketIndex: number, characterId: string, _options?: { silent?: boolean }): Promise<{ success: boolean; stop?: boolean }> {\n    const state = useProfileStore.getState();\n    const char = state.characters.find(c => c.characterId === characterId);\n    if (!char) return { success: false };\n\n    // DIM Parity: Skip if plug is already in socket\n    const instance = state.itemInstances[itemId];\n    const currentSocket = instance?.sockets?.find((s: any) => s.socketIndex === socketIndex);\n    if (currentSocket?.plugHash === plugHash) {\n      debugLog('Transfer', `Socket ${socketIndex} already has plug ${plugHash}, skipping API call`);\n      return { success: true };\n    }\n\n    const membership = await profileService.getPrimaryMembership();\n    const membershipType = membership?.membershipType ?? char.membershipType;\n\n    // Optimistic local update\n    profileService.updateLocalSocketPlug(itemId, socketIndex, plugHash);\n\n    try {\n      const response = await bungieApi.post<any>(BUNGIE_CONFIG.endpoints.insertSocketPlugFree, { itemId, plug: { plugItemHash: plugHash, socketIndex, socketArrayType: 0 }, characterId, membershipType }, true);\n\n      // DIM Parity: Update the local item model with the returned change response\n      if (response) {\n        profileService.updateItemFromChange(itemId, response);\n      }\n\n      return { success: true };\n    } catch (e: any) {\n      // DIM Parity: Handle ghost success for 500 errors\n      if (e?.httpStatus === 500 || e?.isPotentialSuccess) {\n        debugLog('Transfer', `500 error during socket plug of ${plugHash}. Verifying ghost success...`);\n        await new Promise(r => setTimeout(r, 1500));\n        await profileLoader.loadProfile(true);\n\n        let latestState = useProfileStore.getState();\n        let latestInstance = latestState.itemInstances[itemId];\n        let latestSocket = latestInstance?.sockets?.find((s: any) => s.socketIndex === socketIndex);\n\n        if (latestSocket?.plugHash === plugHash) {\n          infoLog('Transfer', `Ghost success detected for socket plug ${plugHash} on item ${itemId}`);\n          return { success: true };\n        }\n\n        // Retry check\n        await new Promise(r => setTimeout(r, 1000));\n        await profileLoader.loadProfile(true);\n        latestState = useProfileStore.getState();\n        latestInstance = latestState.itemInstances[itemId];\n        latestSocket = latestInstance?.sockets?.find((s: any) => s.socketIndex === socketIndex);\n        if (latestSocket?.plugHash === plugHash) {\n          infoLog('Transfer', `Ghost success detected (retry) for socket plug ${plugHash} on item ${itemId}`);\n          return { success: true };\n        }\n      }\n\n      // DIM Parity: Handle known error codes at debug level to reduce console noise\n      const code = e?.ErrorCode || e?.bungieErrorCode?.();\n      const isStopError = code === 1618 || code === 1663 || code === 1634 || code === 1642; // Location-based or locked-gear restrictions\n\n      if (isStopError || code === 1640) { // DestinyItemAlreadyEquipped\n        debugLog('Transfer', `Socket plug restricted: ${code} for item ${itemId}, socket ${socketIndex}${isStopError ? ' - STOPPING' : ''}`);\n      } else if (e?.httpStatus === 500) {\n        // Server errors are often transient or due to rate limiting\n        debugLog('Transfer', `Socket plug server error for item ${itemId}, socket ${socketIndex}: ${e.message}`);\n      } else {\n        errorLog('Transfer', `Socket plug failed for item ${itemId}, socket ${socketIndex}:`, e);\n      }\n\n      return { success: false, stop: isStopError };\n    }\n  }\n\n  private getNativeBucketHash(item: DestinyItem): number {\n    if (EQUIP_BUCKETS.has(item.bucketHash)) return item.bucketHash;\n    return manifestService.getItem(item.itemHash)?.inventory?.bucketTypeHash || item.bucketHash;\n  }\n\n  getItemSource(item: DestinyItem, state?: any): string {\n    const s = state || useProfileStore.getState();\n    if (s.vaultInventory?.some((i: any) => i.itemInstanceId === item.itemInstanceId)) return 'vault';\n    for (const [charId, items] of Object.entries(s.characterInventories)) {\n      if ((items as any[]).some(i => i.itemInstanceId === item.itemInstanceId)) return charId;\n    }\n    for (const [charId, items] of Object.entries(s.characterEquipment)) {\n      if ((items as any[]).some(i => i.itemInstanceId === item.itemInstanceId)) return charId;\n    }\n    return '';\n  }\n\n  /**\n   * DIM Parity: Check if an item can be equipped by a specific store\n   */\n  itemCanBeEquippedBy(item: DestinyItem, characterId: string): boolean {\n    const state = useProfileStore.getState();\n    const character = state.characters.find(c => c.characterId === characterId);\n    if (!character) return false;\n\n    const def = manifestService.getItem(item.itemHash);\n    if (!def) return false;\n\n    // Must be equipment\n    if (!def.equippable && !def.inventory?.equippable) {\n      // Check if it's already equipped or in an equipment bucket\n      if (!EQUIP_BUCKETS.has(item.bucketHash)) return false;\n    }\n\n    // Class compatibility\n    if (!this.isClassCompatible(def.classType, character.classType)) {\n      return false;\n    }\n\n    // Transfers and other restrictions usually handled by the API when we try to move it,\n    // but we can check if it's \"equippable\" in the UI.\n    return true;\n  }\n\n  private isClassCompatible(itemClass: number, characterClass: number): boolean {\n    return (\n      itemClass === 3 || // All classes\n      characterClass === 3 ||\n      itemClass === characterClass\n    );\n  }\n}\n\nexport const transferService = new TransferService();","// Profile Service - DIM-Grade Implementation\n// Handles profile fetching, inventory management, and optimistic updates with memoization\n\nimport { bungieApi, BungieApiError, PlatformErrorCodes } from './api-client';\nimport { db } from '../db/indexeddb.service';\nimport { manifestService } from './manifest.service';\nimport { transferService, createMoveSession } from './transfer.service';\nimport { useProfileStore, useSettingsStore, useAuthStore, SetInventoriesResult } from '../../store';\nimport { STAT_HASHES } from '../../config/bungie.config';\nimport { warnLog, infoLog, errorLog, debugLog } from '../../utils/logger';\n\nimport type { DestinyItem, BungieMembership } from '../../types';\n\ninterface DestinyProfileResponse {\n  responseMintedTimestamp?: string;\n  profileInventory: { data: { items: DestinyItem[] } };\n  characterInventories: { data: Record<string, { items: DestinyItem[] }> };\n  characterEquipment: { data: Record<string, { items: DestinyItem[] }> };\n  characters: { data: Record<string, DestinyCharacterComponent> };\n  itemComponents: {\n    instances: { data: Record<string, any> };\n    stats: { data: Record<string, any> };\n    sockets: { data: Record<string, any> };\n    objectives: { data: Record<string, any> };\n  };\n  profileStringVariables: { data: { integerValuesByHash: Record<string, number> } };\n  profileArtifact?: { data: any };\n  characterArtifact?: { data: Record<string, any> };\n  characterProgressions: { data: Record<string, any> };\n  profileCommendations?: { data: any };\n  characterCommendations?: { data: Record<string, any> };\n  profilePlugSets?: { data: { plugs: Record<number, any[]> } };\n  characterPlugSets?: { data: Record<string, { plugs: Record<number, any[]> }> };\n  profileRecords?: { data: any };\n  profileMetrics?: { data: any };\n  characterMetrics?: { data: Record<string, any> };\n  profile?: { data: { currentGuardianRank: number; lifetimeScore: number } };\n  characterActivities?: { data: Record<string, any> };\n}\n\ninterface DestinyCharacterComponent {\n  membershipId: string;\n  membershipType: number;\n  characterId: string;\n  dateLastPlayed: string;\n  minutesPlayedThisSession: string;\n  minutesPlayedTotal: string;\n  light: number;\n  stats: Record<string, number>;\n  raceHash: number;\n  genderHash: number;\n  classHash: number;\n  raceType: number;\n  classType: number;\n  genderType: number;\n  emblemPath: string;\n  emblemBackgroundPath: string;\n  emblemHash: number;\n  levelProgression: { level: number; progressionHash: number };\n  baseCharacterLevel: number;\n  percentToNextLevel: number;\n}\n\nconst bucketMemoCache = new WeakMap<object, Map<number, DestinyItem[]>>();\n\nfunction memoizedItemsByBucket(items: DestinyItem[], cacheKey: object): Map<number, DestinyItem[]> {\n  let cached = bucketMemoCache.get(cacheKey);\n  if (cached) return cached;\n  const byBucket = new Map<number, DestinyItem[]>();\n  for (const item of items) {\n    if (!byBucket.has(item.bucketHash)) byBucket.set(item.bucketHash, []);\n    byBucket.get(item.bucketHash)!.push(item);\n  }\n  bucketMemoCache.set(cacheKey, byBucket);\n  return byBucket;\n}\n\nclass ProfileService {\n  private activeCharacterId: string | null = null;\n  private membershipCache: BungieMembership | null = null;\n  private membershipCacheTime = 0;\n\n  findItemsByBucket(store: { items: DestinyItem[] }, bucketHash: number): DestinyItem[] {\n    return memoizedItemsByBucket(store.items, store).get(bucketHash) || [];\n  }\n\n  public updateLocalStore(args: { instanceId: string, sourceId: string, targetId: string, isEquip?: boolean, customAction?: (item: DestinyItem) => void }) {\n    const store = useProfileStore.getState();\n    const { characterInventories, characterEquipment, vaultInventory } = store;\n    let item: DestinyItem | null = null;\n    const newVault = [...vaultInventory];\n    const newCI = { ...characterInventories };\n    const newCE = { ...characterEquipment };\n\n    const findAndRemove = (list: DestinyItem[]) => {\n      const idx = list.findIndex(i => i.itemInstanceId === args.instanceId);\n      if (idx !== -1) { item = { ...list[idx] }; list.splice(idx, 1); return true; }\n      return false;\n    };\n\n    if (!findAndRemove(newVault)) {\n      for (const id of Object.keys(newCI)) {\n        const list = [...(newCI[id] || [])];\n        if (findAndRemove(list)) { newCI[id] = list; break; }\n      }\n      if (!item) {\n        for (const id of Object.keys(newCE)) {\n          const list = [...(newCE[id] || [])];\n          if (findAndRemove(list)) { newCE[id] = list; break; }\n        }\n      }\n    }\n\n    if (!item) return;\n    if (args.customAction) args.customAction(item);\n\n    if (args.targetId === 'vault') {\n      newVault.push(item);\n    } else {\n      if (args.isEquip) {\n        const curEq = [...(newCE[args.targetId] || [])];\n        const itemDef = manifestService.getItem((item as DestinyItem).itemHash);\n        const label = itemDef?.inventory?.equippingLabel;\n        const slotIdx = curEq.findIndex(i => i.bucketHash === (item as DestinyItem).bucketHash);\n        if (slotIdx !== -1) {\n          const old = curEq.splice(slotIdx, 1)[0];\n          newCI[args.targetId] = [...(newCI[args.targetId] || []), old];\n        }\n        if (label) {\n          const cIdx = curEq.findIndex(i => manifestService.getItem(i.itemHash)?.inventory?.equippingLabel === label);\n          if (cIdx !== -1) {\n            const oldEx = curEq.splice(cIdx, 1)[0];\n            newCI[args.targetId] = [...(newCI[args.targetId] || []), oldEx];\n          }\n        }\n        curEq.push(item);\n        newCE[args.targetId] = curEq;\n      } else {\n        newCI[args.targetId] = [...(newCI[args.targetId] || []), item];\n      }\n    }\n\n    useProfileStore.setState({\n      vaultInventory: newVault,\n      characterInventories: newCI,\n      characterEquipment: newCE,\n      responseMintedTimestamp: new Date().toISOString(),\n      lastUpdated: Date.now()\n    });\n  }\n\n  /**\n   * DIM Parity: Update a single item from a Bungie change response (after socketing)\n   */\n  public updateItemFromChange(instanceId: string, change: any) {\n    const state = useProfileStore.getState();\n    const itemData = change.item;\n    if (!itemData) return;\n\n    // Update item instances - DIM Parity: Only update non-socket properties\n    // The optimistic update (updateLocalSocketPlug) already correctly set the socket,\n    // so we MUST preserve existing sockets. Overwriting them causes UI flashing because\n    // the Bungie API response doesn't include proper socketIndex values.\n    const newInstances = { ...state.itemInstances };\n    if (newInstances[instanceId]) {\n      const inst = itemData;\n      const existingSockets = newInstances[instanceId].sockets;\n      newInstances[instanceId] = {\n        ...newInstances[instanceId],\n        power: inst.primaryStat?.value,\n        damageType: inst.damageType,\n        isEquipped: inst.isEquipped,\n        // PRESERVE existing sockets - they're already correctly updated by updateLocalSocketPlug\n        sockets: existingSockets\n      };\n    }\n\n    // Replace item in the inventory list to update bucket/hash if needed (though unlikely for socket change)\n    const updateInList = (list: DestinyItem[]) => {\n      const idx = list.findIndex(i => i.itemInstanceId === instanceId);\n      if (idx !== -1) {\n        list[idx] = { ...list[idx], ...itemData, tierType: manifestService.getItem(itemData.itemHash)?.inventory?.tierType || 0 };\n        return true;\n      }\n      return false;\n    };\n\n    const newVault = [...state.vaultInventory];\n    const newCI = { ...state.characterInventories };\n    const newCE = { ...state.characterEquipment };\n\n    let found = updateInList(newVault);\n    if (!found) {\n      for (const id of Object.keys(newCI)) {\n        const list = [...(newCI[id] || [])];\n        if (updateInList(list)) { newCI[id] = list; found = true; break; }\n      }\n    }\n    if (!found) {\n      for (const id of Object.keys(newCE)) {\n        const list = [...(newCE[id] || [])];\n        if (updateInList(list)) { newCE[id] = list; found = true; break; }\n      }\n    }\n\n    useProfileStore.setState({\n      itemInstances: newInstances,\n      vaultInventory: newVault,\n      characterInventories: newCI,\n      characterEquipment: newCE,\n      lastUpdated: Date.now()\n    });\n  }\n\n  async getActiveCharacterId(): Promise<string | null> {\n    if (this.activeCharacterId) return this.activeCharacterId;\n    const profile = await this.getProfile();\n    if (!profile?.characters?.data) return null;\n    const chars = Object.values(profile.characters.data).sort((a, b) => new Date(b.dateLastPlayed).getTime() - new Date(a.dateLastPlayed).getTime());\n    return (this.activeCharacterId = chars[0]?.characterId || null);\n  }\n\n  async getProfile(): Promise<DestinyProfileResponse | null> {\n    const tokens = await db.getAuthTokens();\n    if (!tokens) return null;\n    const membership = await this.getPrimaryMembership();\n    if (!membership) return null;\n    try {\n      const components = [100, 102, 201, 205, 200, 202, 204, 206, 300, 301, 304, 305, 900, 1100, 1400, 1401];\n      return await bungieApi.request<DestinyProfileResponse>(`/Destiny2/${membership.membershipType}/Profile/${membership.membershipId}/?components=${components.join(',')}`, { requiresAuth: true });\n    } catch { return null; }\n  }\n\n  async getPrimaryMembership(): Promise<BungieMembership | null> {\n    if (this.membershipCache && Date.now() - this.membershipCacheTime < 300000) return this.membershipCache;\n    try {\n      const resp = await bungieApi.request<any>('/User/GetMembershipsForCurrentUser/', { requiresAuth: true });\n      const primary = resp.destinyMemberships.find((m: any) => m.membershipId === resp.primaryMembershipId) || resp.destinyMemberships[0];\n      this.membershipCacheTime = Date.now();\n      return (this.membershipCache = { membershipId: primary.membershipId, membershipType: primary.membershipType, displayName: primary.displayName, bungieGlobalDisplayName: resp.bungieNetUser?.cachedBungieGlobalDisplayName || primary.displayName, bungieGlobalDisplayNameCode: resp.bungieNetUser?.cachedBungieGlobalDisplayNameCode || 0 });\n    } catch { return null; }\n  }\n\n  async getClanInfo(): Promise<string | null> {\n    const mem = await this.getPrimaryMembership();\n    if (!mem) return null;\n    try {\n      const resp = await bungieApi.get<any>(`/GroupV2/User/${mem.membershipType}/${mem.membershipId}/0/1/`, true);\n      return resp?.results?.[0]?.group?.name || null;\n    } catch { return null; }\n  }\n\n  formatForStore(profile: DestinyProfileResponse) {\n    const characterInventories: Record<string, DestinyItem[]> = {};\n    const characterEquipment: Record<string, DestinyItem[]> = {};\n    const itemInstances: Record<string, any> = {};\n\n    if (profile.characterInventories?.data) Object.entries(profile.characterInventories.data).forEach(([id, d]) => characterInventories[id] = d.items.map(i => ({ ...i, tierType: manifestService.getItem(i.itemHash)?.inventory?.tierType || 0 })));\n    if (profile.characterEquipment?.data) Object.entries(profile.characterEquipment.data).forEach(([id, d]) => characterEquipment[id] = d.items.map(i => ({ ...i, tierType: manifestService.getItem(i.itemHash)?.inventory?.tierType || 0 })));\n    const vaultInventory = (profile.profileInventory?.data?.items || []).map(i => ({ ...i, tierType: manifestService.getItem(i.itemHash)?.inventory?.tierType || 0 }));\n\n    if (profile.itemComponents?.instances?.data) {\n      Object.entries(profile.itemComponents.instances.data).forEach(([id, inst]) => {\n        itemInstances[id] = {\n          power: inst.primaryStat?.value, damageType: inst.damageType, isEquipped: inst.isEquipped, isLocked: inst.isLocked, canEquip: inst.canEquip,\n          energy: { ...inst.energy, isArtifice: profile.itemComponents.sockets?.data?.[id]?.sockets.some((s: any) => s.plugHash === 3727270518) || false },\n          sockets: (profile.itemComponents.sockets?.data?.[id]?.sockets || []).map((s: any, idx: number) => ({ ...s, socketIndex: idx, plugName: manifestService.getName(s.plugHash || 0), plugIcon: manifestService.getIcon(s.plugHash || 0) })),\n          objectives: profile.itemComponents.objectives?.data?.[id]?.objectives || []\n        };\n      });\n    }\n\n    if (profile.itemComponents?.stats?.data) {\n      Object.entries(profile.itemComponents.stats.data).forEach(([id, sd]) => {\n        if (!itemInstances[id]) itemInstances[id] = { sockets: [] };\n        const s: any = { total: 0 };\n        Object.values(sd.stats).forEach((stat: any) => {\n          if (stat.statHash === STAT_HASHES.MOBILITY) s.mobility = stat.value;\n          if (stat.statHash === STAT_HASHES.RESILIENCE) s.resilience = stat.value;\n          if (stat.statHash === STAT_HASHES.RECOVERY) s.recovery = stat.value;\n          if (stat.statHash === STAT_HASHES.DISCIPLINE) s.discipline = stat.value;\n          if (stat.statHash === STAT_HASHES.INTELLECT) s.intellect = stat.value;\n          if (stat.statHash === STAT_HASHES.STRENGTH) s.strength = stat.value;\n        });\n        itemInstances[id].stats = s;\n      });\n    }\n\n    const firstCharId = Object.keys(profile.characterProgressions?.data || {})[0];\n\n    // Extract Commendations (Using exact Bungie API property names provided by user)\n    const comms = profile.profileCommendations?.data;\n    const commendationScore = comms?.totalScore || 0;\n    const commendationNodeScores = comms?.commendationNodeScoresByHash || {};\n    const commendationNodePercentages = comms?.commendationNodePercentagesByHash || {};\n\n    // Extract Given/Received Scores from scoreDetailValues (Component 1400)\n    // scoreDetailValues[0] = Received Score, scoreDetailValues[1] = Sent (Given) Score\n    const scoreDetails = comms?.scoreDetailValues || [];\n    const commendationsReceived = scoreDetails[0] || 0;\n    const commendationsSent = scoreDetails[1] || 0;\n\n    return {\n      characterInventories, characterEquipment, vaultInventory, itemInstances,\n      activeSeasonRank: firstCharId ? profile.characterProgressions.data[firstCharId]?.progressions['362041442']?.level || 0 : 0,\n      responseMintedTimestamp: profile.responseMintedTimestamp,\n      commendationScore,\n      commendationNodeScores,\n      commendationNodePercentages,\n      commendationsSent,\n      commendationsReceived,\n    };\n  }\n\n  async getItemSockets(itemInstanceId: string): Promise<{ sockets: any[] }> {\n    // Optimistic: Check store first\n    const state = useProfileStore.getState();\n    const instance = state.itemInstances[itemInstanceId];\n    if (instance?.sockets?.length) {\n      return { sockets: instance.sockets };\n    }\n\n    const mem = await this.getPrimaryMembership();\n    if (!mem) return { sockets: [] };\n    try {\n      const resp = await bungieApi.request<any>(`/Destiny2/${mem.membershipType}/Profile/${mem.membershipId}/Item/${itemInstanceId}/?components=305`, { requiresAuth: true });\n      return { sockets: resp.sockets?.data?.sockets || [] };\n    } catch { return { sockets: [] }; }\n  }\n\n  /**\n   * Optimistically updates a socket plug in the local store\n   */\n  updateLocalSocketPlug(instanceId: string, socketIndex: number, plugHash: number) {\n    const name = manifestService.getName(plugHash);\n    const icon = manifestService.getIcon(plugHash);\n    useProfileStore.getState().updateItemSocket(instanceId, socketIndex, plugHash, name, icon);\n  }\n\n  async ensureItemUnequipped(characterId: string, itemInstanceId: string, excludeExotic = false, session?: any): Promise<boolean> {\n    debugLog('Transfer', `ensureItemUnequipped: char=${characterId} item=${itemInstanceId} excludeExotic=${excludeExotic}`);\n    const state = useProfileStore.getState();\n    const inventory = state.getAllInventory();\n    const item = inventory.find(i => i.itemInstanceId === itemInstanceId);\n    if (!item) {\n      debugLog('Transfer', `ensureItemUnequipped: item not found in inventory, returning true`);\n      return true;\n    }\n\n    // Check if it's actually equipped\n    const equipped = state.characterEquipment?.[characterId] || [];\n    if (!equipped.some(i => i.itemInstanceId === itemInstanceId)) {\n      debugLog('Transfer', `ensureItemUnequipped: item not equipped on ${characterId}, returning true`);\n      return true;\n    }\n\n    debugLog('Transfer', `ensureItemUnequipped: item ${item.itemHash} IS equipped on ${characterId}, finding replacement...`);\n\n    const bucket = item.bucketHash;\n    const char = state.characters.find(c => c.characterId === characterId);\n\n    // DIM Parity: First, look for a replacement ALREADY on this character (no move needed)\n    const charInventory = state.characterInventories[characterId] || [];\n    let rep = charInventory.find(i => {\n      if (i.bucketHash !== bucket) return false;\n      if (i.itemInstanceId === itemInstanceId) return false;\n      if (session?.involvedItems?.has(i.itemInstanceId)) return false;\n      const def = manifestService.getItem(i.itemHash);\n      if (excludeExotic && def?.tierType === 6) return false;\n      if (char?.classType !== undefined && def?.classType !== 3 && def?.classType !== char.classType) return false;\n      return true;\n    });\n\n    // If no local replacement, search vault and other characters\n    if (!rep) {\n      debugLog('Transfer', `ensureItemUnequipped: no local replacement, searching globally...`);\n      rep = transferService.findReplacementItem(bucket, characterId, new Set([itemInstanceId, ...(session?.involvedItems || [])]), char?.classType, excludeExotic);\n    }\n\n    if (!rep) {\n      errorLog('Transfer', `ensureItemUnequipped: failed to find replacement item for bucket ${bucket} on character ${characterId}`);\n      return false;\n    }\n\n    debugLog('Transfer', `ensureItemUnequipped: found replacement ${rep.itemHash} (${rep.itemInstanceId})`);\n\n    const source = (transferService as any).getItemSource(rep);\n\n    // If replacement is not on character, need to move it\n    if (source !== characterId) {\n      infoLog('Transfer', `Moving replacement ${rep.itemInstanceId} from ${source} to ${characterId}`);\n\n      // DIM Parity: Ensure space on character BEFORE moving. \n      // But we're dequipping, so we free up 1 slot by moving the equipped item out. \n      // The issue is the equipped item is STILL equipped until we complete this process.\n      // Solution: Add the item being dequipped to involved items so it's not moved aside.\n      const s = session || createMoveSession([rep.itemInstanceId!, itemInstanceId], 3, characterId);\n      s.involvedItems.add(itemInstanceId); // Prevent circular: don't try to move aside the item we're dequipping\n      s.involvedItems.add(rep.itemInstanceId!); // Don't move aside the replacement either\n\n      // Check if character has space for the replacement\n      const charInvCount = charInventory.filter(i => i.bucketHash === bucket).length;\n      const capacity = 10; // Standard equipment bucket capacity\n\n      // We have 1 equipped + N in inventory. After dequip: N+1 in inventory. Adding replacement: N+2. Max is 10.\n      // So we need: charInvCount + 2 <= 10, i.e., charInvCount <= 8\n      if (charInvCount >= capacity - 1) {\n        // Need to make space first - move something to vault (not the item being dequipped)\n        const movableItems = charInventory.filter(i =>\n          i.bucketHash === bucket &&\n          i.itemInstanceId !== itemInstanceId &&\n          !s.involvedItems.has(i.itemInstanceId!)\n        );\n\n        if (movableItems.length > 0) {\n          // Sort: prefer lower tier, lower power\n          movableItems.sort((a, b) => {\n            const tierA = a.tierType || 0, tierB = b.tierType || 0;\n            if (tierA !== tierB) return tierA - tierB;\n            const pA = state.itemInstances[a.itemInstanceId!]?.power || 0;\n            const pB = state.itemInstances[b.itemInstanceId!]?.power || 0;\n            return pA - pB;\n          });\n\n          const toVault = movableItems[0];\n          infoLog('Transfer', `Pre-emptive space-making: moving ${toVault.itemInstanceId} to vault before dequip`);\n          const vaultRes = await transferService.moveItem(toVault, characterId, 'vault', s, { silent: true });\n          if (!vaultRes.success) {\n            errorLog('Transfer', `Failed to make space for dequip replacement: ${vaultRes.error}`);\n            return false;\n          }\n        } else {\n          errorLog('Transfer', `No items to move aside for dequip space-making in bucket ${bucket}`);\n          return false;\n        }\n      }\n\n      const moved = await transferService.moveItem(rep, source, characterId, s, { silent: true });\n      if (!moved.success) {\n        errorLog('Transfer', `Failed to move replacement item ${rep.itemInstanceId} to ${characterId}: ${moved.error}`);\n        return false;\n      }\n\n      // Refresh local rep after move\n      await profileLoader.loadProfile(true);\n      const newState = useProfileStore.getState();\n      rep = newState.getAllInventory().find(i => i.itemInstanceId === rep?.itemInstanceId);\n      if (!rep) {\n        errorLog('Transfer', `Replacement item ${itemInstanceId} disappeared after move refresh`);\n        return false;\n      }\n    }\n\n    // OPTIMISTIC: Equip the replacement immediately in UI\n    debugLog('Transfer', `ensureItemUnequipped: equipping replacement ${rep.itemInstanceId} via updateLocalStore + API`);\n    this.updateLocalStore({\n      instanceId: rep.itemInstanceId!,\n      sourceId: characterId,\n      targetId: characterId,\n      isEquip: true\n    });\n\n    const result = await this.equipItemInstance(characterId, rep.itemInstanceId!);\n    debugLog('Transfer', `ensureItemUnequipped: equipItemInstance returned ${result}`);\n    return result;\n  }\n\n\n  async equipItemInstance(characterId: string, itemInstanceId: string): Promise<boolean> {\n    debugLog('Transfer', `equipItemInstance: char=${characterId} item=${itemInstanceId}`);\n    const mem = await this.getPrimaryMembership();\n    if (!mem) {\n      errorLog('Transfer', `equipItemInstance: no membership found`);\n      return false;\n    }\n    try {\n      await bungieApi.post('/Destiny2/Actions/Items/EquipItem/', {\n        itemId: itemInstanceId,\n        characterId,\n        membershipType: mem.membershipType\n      }, true);\n      debugLog('Transfer', `equipItemInstance: API call succeeded`);\n      return true;\n    } catch (e: any) {\n      errorLog('Transfer', `equipItemInstance: API call failed`, e);\n      return false;\n    }\n  }\n\n  async transferItem(itemHash: number, itemInstanceId: string, toVault: boolean, characterId: string): Promise<boolean> {\n    const mem = await this.getPrimaryMembership();\n    if (!mem) return false;\n    try {\n      await bungieApi.post('/Destiny2/Actions/Items/TransferItem/', {\n        itemReferenceHash: itemHash,\n        stackSize: 1,\n        transferToVault: toVault,\n        itemId: itemInstanceId,\n        characterId,\n        membershipType: mem.membershipType\n      }, true);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n}\n\nexport const profileService = new ProfileService();\n\nclass ProfileLoader {\n  private loadPromise: Promise<boolean> | null = null;\n  private isLoading = false;\n  private autoRefreshTimeout: ReturnType<typeof setTimeout> | null = null;\n  private isAutoRefreshing = false;\n\n  async loadProfile(force = false, retryCount = 0): Promise<boolean> {\n    if (this.loadPromise) {\n      if (force) { await this.loadPromise; return this.loadProfile(true, retryCount); }\n      return this.loadPromise;\n    }\n    this.isLoading = true;\n    useProfileStore.getState().setLoading(true);\n    this.loadPromise = (async () => {\n      try {\n        const p = await profileService.getProfile();\n        if (!p) return false;\n        const store = useProfileStore.getState();\n        const f = profileService.formatForStore(p);\n        const res = store.setInventories(f);\n        if (res === SetInventoriesResult.DISCARDED_STALE && retryCount === 0) {\n          setTimeout(() => this.loadProfile(false, 1), 5000);\n        }\n\n        const currentGuardianRank = p.profile?.data?.currentGuardianRank || 0;\n        const lifetimeScore = p.profile?.data?.lifetimeScore || 0;\n\n        useProfileStore.setState({\n          currentGuardianRank,\n          lifetimeScore\n        });\n\n        store.setCharacters(p.characters.data ? Object.values(p.characters.data)\n          .sort((a, b) => new Date(b.dateLastPlayed).getTime() - new Date(a.dateLastPlayed).getTime())\n          .map(c => ({\n            ...c,\n            guardianRank: currentGuardianRank,\n            seasonRank: f.activeSeasonRank || 0\n          })) as any : []);\n\n        const updatedStore = useProfileStore.getState();\n        if (updatedStore.selectedCharacterId && !updatedStore.characters.some(c => c.characterId === updatedStore.selectedCharacterId)) {\n          warnLog('Profile', 'Selected character no longer valid after profile refresh, resetting...');\n          updatedStore.setSelectedCharacter(updatedStore.characters[0]?.characterId || null);\n        }\n\n        const { ghostFarming } = useSettingsStore.getState();\n        if (ghostFarming && !force && retryCount === 0) {\n          this.runFarmingCheck();\n        }\n\n        return true;\n      } catch (error) {\n        if (error instanceof BungieApiError && error.errorCode === PlatformErrorCodes.SystemDisabled) {\n          console.warn('[ProfileLoader] Maintenance detected during profile load.');\n        }\n        return false;\n      } finally {\n        this.isLoading = false;\n        useProfileStore.getState().setLoading(false);\n        this.loadPromise = null;\n      }\n    })();\n    return this.loadPromise;\n  }\n\n  /**\n   * Proactive Make-Room Logic (DIM-style)\n   */\n  private async runFarmingCheck(): Promise<void> {\n    const store = useProfileStore.getState();\n    const chars = store.characters;\n\n    for (const char of chars) {\n      // Check common equippable buckets\n      const buckets = [1498876634, 2465295065, 953998645, 3448274439, 3551918588, 14239492, 20886954, 1585787867];\n      for (const bucketHash of buckets) {\n        const space = profileService.findItemsByBucket({ items: [...store.characterInventories[char.characterId] || [], ...store.characterEquipment[char.characterId] || []] }, bucketHash).length;\n\n        // DIM Standard: If only 1 slot left, move something to vault\n        if (space >= 9) {\n          console.log(`[Farming] Bucket ${bucketHash} is almost full on ${char.characterId}. Moving item to vault...`);\n          await transferService.moveItemToVault(char.characterId, bucketHash);\n        }\n      }\n    }\n  }\n\n  public startAutoRefresh(intervalMs = 30000): void {\n    if (this.isAutoRefreshing) return;\n    this.isAutoRefreshing = true;\n    const visibilityHandler = () => {\n      if (!document.hidden) this.triggerImmediateRefresh();\n      else this.stopAutoRefresh(true);\n    };\n    document.addEventListener('visibilitychange', visibilityHandler);\n    window.addEventListener('online', () => this.triggerImmediateRefresh());\n    this.scheduleNextRefresh(intervalMs);\n  }\n\n  private scheduleNextRefresh(intervalMs: number): void {\n    this.stopAutoRefresh(true);\n    if (!this.isAutoRefreshing) return;\n    this.autoRefreshTimeout = setTimeout(async () => {\n      const isMaintenance = useAuthStore.getState().isMaintenance;\n      if (!document.hidden && useProfileStore.getState().activeTransfers.size === 0 && !isMaintenance) {\n        await this.loadProfile();\n      }\n      this.scheduleNextRefresh(intervalMs);\n    }, intervalMs);\n  }\n\n  public triggerImmediateRefresh(): void {\n    if (this.autoRefreshTimeout) clearTimeout(this.autoRefreshTimeout);\n    this.loadProfile();\n    this.scheduleNextRefresh(30000);\n  }\n\n  public stopAutoRefresh(soft = false): void {\n    if (this.autoRefreshTimeout) { clearTimeout(this.autoRefreshTimeout); this.autoRefreshTimeout = null; }\n    if (!soft) this.isAutoRefreshing = false;\n  }\n\n  get loading() { return this.isLoading; }\n}\n\nexport const profileLoader = new ProfileLoader();\n","export function getBungieUrl(path: string | undefined): string | undefined {\r\n    if (!path) return undefined;\r\n\r\n    // Check for double-prefix pattern (https://www.bungie.nethttps//...)\r\n    if (path.includes('https://www.bungie.net')) {\r\n        // If it starts with the domain, clean it\r\n        if (path.startsWith('https://www.bungie.net')) {\r\n            // Check if there is TRASH after it\r\n            // e.g. \"https://www.bungie.nethttps//www.bungie.net/...\"\r\n            const secondIdx = path.indexOf('https', 10);\r\n            if (secondIdx > -1) {\r\n                // Aggressive clean: find the last occurrence of /common\r\n                const commonIdx = path.indexOf('/common');\r\n                if (commonIdx > -1) {\r\n                    return `https://www.bungie.net${path.substring(commonIdx)}`;\r\n                }\r\n            }\r\n            return path;\r\n        }\r\n    }\r\n\r\n    // Standard relative path (starts with /)\r\n    if (path.startsWith('/')) {\r\n        return `https://www.bungie.net${path}`;\r\n    }\r\n\r\n    // Relative path missing leading slash\r\n    if (!path.startsWith('http')) {\r\n        return `https://www.bungie.net/${path}`;\r\n    }\r\n\r\n    // Already absolute\r\n    return path;\r\n}\r\n","// Sync Manager Service\r\n// Orchestrates intelligent profile refreshing based on visibility, connectivity, and heartbeat.\r\n\r\nimport { profileService } from './profile.service';\r\nimport { useProfileStore, useAuthStore } from '../../store';\r\n\r\nclass SyncManagerService {\r\n    private lastFullRefresh = 0;\r\n    private heartbeatTimer: number | null = null;\r\n    private isRefreshing = false;\r\n\r\n    // Thresholds (ms)\r\n    private readonly FULL_REFRESH_STALE_THRESHOLD = 5 * 60 * 1000; // 5 minutes (user returned after long break)\r\n    private readonly DELTA_REFRESH_STALE_THRESHOLD = 90 * 1000;    // 90 seconds (standard stale threshold)\r\n    private readonly HEARTBEAT_INTERVAL = 3 * 60 * 1000;           // 3 minutes background heartbeat\r\n\r\n    public init() {\r\n\r\n        // 1. Visibility tracking\r\n        document.addEventListener('visibilitychange', () => this.handleVisibilityChange());\r\n\r\n        // 2. Connectivity tracking\r\n        window.addEventListener('online', () => this.handleOnline());\r\n\r\n        // 3. Heartbeat\r\n        this.startHeartbeat();\r\n\r\n        // Initial sync\r\n        this.refresh();\r\n    }\r\n\r\n    private handleVisibilityChange() {\r\n        if (document.hidden) {\r\n            this.stopHeartbeat();\r\n        } else {\r\n            this.startHeartbeat();\r\n\r\n            const timeSinceLastRefresh = Date.now() - this.lastFullRefresh;\r\n\r\n            if (timeSinceLastRefresh > this.FULL_REFRESH_STALE_THRESHOLD) {\r\n                this.refresh(true);\r\n            } else if (timeSinceLastRefresh > this.DELTA_REFRESH_STALE_THRESHOLD) {\r\n                this.refresh(false);\r\n            }\r\n        }\r\n    }\r\n\r\n    private handleOnline() {\r\n        this.refresh(true);\r\n    }\r\n\r\n    private startHeartbeat() {\r\n        this.stopHeartbeat();\r\n        this.heartbeatTimer = window.setInterval(() => {\r\n            this.refresh(false);\r\n        }, this.HEARTBEAT_INTERVAL);\r\n    }\r\n\r\n    private stopHeartbeat() {\r\n        if (this.heartbeatTimer) {\r\n            clearInterval(this.heartbeatTimer);\r\n            this.heartbeatTimer = null;\r\n        }\r\n    }\r\n\r\n    public async refresh(full = true) {\r\n        if (this.isRefreshing) return;\r\n\r\n        const store = useProfileStore.getState();\r\n        if (store.isEquipping) {\r\n            return;\r\n        }\r\n\r\n        // Prevent sync if not authenticated to avoid infinite loops\r\n        const authStore = useAuthStore.getState();\r\n        if (!authStore.isAuthenticated && !store.characters.length) { // Allow if we have chars (maybe just token expired)\r\n            this.isRefreshing = false; // Reset flag\r\n            return;\r\n        }\r\n\r\n        if (!store.setInventories) return; // Store not ready\r\n\r\n        const isMaintenance = authStore.isMaintenance;\r\n        if (isMaintenance) {\r\n            return;\r\n        }\r\n\r\n        this.isRefreshing = true;\r\n\r\n        try {\r\n            if (full) {\r\n                const profile = await profileService.getProfile();\r\n                if (profile) {\r\n                    const formatted = profileService.formatForStore(profile);\r\n                    store.setInventories(formatted);\r\n\r\n                    // CRITICAL: Update characters too, otherwise character select screen is empty\r\n                    if (profile.characters?.data) {\r\n                        store.setCharacters(Object.values(profile.characters.data) as any);\r\n                    }\r\n\r\n                    this.lastFullRefresh = Date.now();\r\n                }\r\n            } else {\r\n                // Delta sync: Just characters and basic inventory, skip heavy component parsing if possible\r\n                const profile = await profileService.getProfile();\r\n                if (profile) {\r\n                    const formatted = profileService.formatForStore(profile);\r\n                    store.setInventories(formatted);\r\n\r\n                    // Update characters here too\r\n                    if (profile.characters?.data) {\r\n                        store.setCharacters(Object.values(profile.characters.data) as any);\r\n                    }\r\n\r\n                }\r\n            }\r\n        } catch (e) {\r\n        } finally {\r\n            this.isRefreshing = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Proactively trigger a refresh if we know an external action happened\r\n     * (e.g. after a transfer or equip call completes)\r\n     */\r\n    public async triggerImmediateSync() {\r\n        // Mitigation for Bungie API latency: stale reads after successful writes.\r\n        // Waiting 0.8s allows the Bungie-side database state to \"settle\" before we sync.\r\n        await new Promise(resolve => setTimeout(resolve, 800));\r\n        this.refresh(false);\r\n    }\r\n}\r\n\r\nexport const syncManager = new SyncManagerService();\r\n","// Toast Notification Component\r\nimport { useToastStore } from '../../store';\r\nimport './Toast.css';\r\n\r\nexport function ToastContainer() {\r\n  const { toasts, removeToast } = useToastStore();\r\n\r\n  if (toasts.length === 0) return null;\r\n\r\n  return (\r\n    <div className=\"toast-container\">\r\n      {toasts.map((toast) => (\r\n        <div\r\n          key={toast.id}\r\n          className={`toast toast--${toast.type}`}\r\n          role=\"alert\"\r\n          style={{ '--duration': `${toast.duration ?? 5000}ms` } as React.CSSProperties}\r\n        >\r\n          <div className=\"toast__progress-inward\"></div>\r\n          <div className=\"toast__icon\">{getIcon(toast.type)}</div>\r\n          <div className=\"toast__content\">\r\n            {toast.type === 'alert' && <div className=\"toast__alert-title\">SERVICE ALERT</div>}\r\n            {toast.type === 'success' && <div className=\"toast__alert-title\">TRANSFER COMPLETE</div>}\r\n            {toast.type === 'error' && <div className=\"toast__alert-title\">TRANSFER FAILED</div>}\r\n            {toast.type === 'lock' && <div className=\"toast__alert-title\">ITEM LOCKED</div>}\r\n            {toast.type === 'unlock' && <div className=\"toast__alert-title\">ITEM UNLOCKED</div>}\r\n            <p className=\"toast__message\">{toast.message}</p>\r\n          </div>\r\n          <button\r\n            className=\"toast__close\"\r\n            onClick={() => removeToast(toast.id)}\r\n            aria-label=\"Dismiss\"\r\n          >\r\n            <svg\r\n              width=\"16\"\r\n              height=\"16\"\r\n              viewBox=\"0 0 24 24\"\r\n              fill=\"none\"\r\n              stroke=\"currentColor\"\r\n              strokeWidth=\"2\"\r\n            >\r\n              <path d=\"M18 6L6 18M6 6l12 12\" />\r\n            </svg>\r\n          </button>\r\n        </div>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction getIcon(type: string) {\r\n  switch (type) {\r\n    case 'success':\r\n      return (\r\n        <svg\r\n          width=\"20\"\r\n          height=\"20\"\r\n          viewBox=\"0 0 24 24\"\r\n          fill=\"none\"\r\n          stroke=\"currentColor\"\r\n          strokeWidth=\"2\"\r\n        >\r\n          <path d=\"M20 6L9 17l-5-5\" />\r\n        </svg>\r\n      );\r\n    case 'error':\r\n      return (\r\n        <svg\r\n          width=\"20\"\r\n          height=\"20\"\r\n          viewBox=\"0 0 24 24\"\r\n          fill=\"none\"\r\n          stroke=\"currentColor\"\r\n          strokeWidth=\"2\"\r\n        >\r\n          <circle cx=\"12\" cy=\"12\" r=\"10\" />\r\n          <path d=\"M15 9l-6 6M9 9l6 6\" />\r\n        </svg>\r\n      );\r\n    case 'warning':\r\n      return (\r\n        <svg\r\n          width=\"20\"\r\n          height=\"20\"\r\n          viewBox=\"0 0 24 24\"\r\n          fill=\"none\"\r\n          stroke=\"currentColor\"\r\n          strokeWidth=\"2\"\r\n        >\r\n          <path d=\"M12 9v4M12 17h.01\" />\r\n          <path d=\"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z\" />\r\n        </svg>\r\n      );\r\n    case 'alert':\r\n      return (\r\n        <svg\r\n          width=\"24\"\r\n          height=\"24\"\r\n          viewBox=\"0 0 24 24\"\r\n          fill=\"none\"\r\n        >\r\n          <circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#dc2626\" />\r\n          <path d=\"M12 7v6M12 16h.01\" fill=\"none\" stroke=\"white\" strokeWidth=\"2.5\" strokeLinecap=\"round\" />\r\n        </svg>\r\n      );\r\n    case 'lock':\r\n      return (\r\n        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#dc2626\" strokeWidth=\"2.5\">\r\n          <rect x=\"3\" y=\"11\" width=\"18\" height=\"11\" rx=\"2\" ry=\"2\" />\r\n          <path d=\"M7 11V7a5 5 0 0110 0v4\" />\r\n        </svg>\r\n      );\r\n    case 'unlock':\r\n      return (\r\n        <svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#22c55e\" strokeWidth=\"2.5\">\r\n          <rect x=\"3\" y=\"11\" width=\"18\" height=\"11\" rx=\"2\" ry=\"2\" />\r\n          <path d=\"M7 11V7a5 5 0 019.9-1\" />\r\n        </svg>\r\n      );\r\n    case 'info':\r\n    default:\r\n      return (\r\n        <svg\r\n          width=\"20\"\r\n          height=\"20\"\r\n          viewBox=\"0 0 24 24\"\r\n          fill=\"none\"\r\n          stroke=\"currentColor\"\r\n          strokeWidth=\"2\"\r\n        >\r\n          <circle cx=\"12\" cy=\"12\" r=\"10\" />\r\n          <path d=\"M12 16v-4M12 8h.01\" />\r\n        </svg>\r\n      );\r\n  }\r\n}\r\n\r\n// Hook to easily show toasts\r\nexport function useToast() {\r\n  const addToast = useToastStore((state) => state.addToast);\r\n\r\n  return {\r\n    success: (message: string) => addToast({ type: 'success', message }),\r\n    error: (message: string) => addToast({ type: 'error', message }),\r\n    warning: (message: string) => addToast({ type: 'warning', message }),\r\n    info: (message: string) => addToast({ type: 'info', message }),\r\n    alert: (message: string) => addToast({ type: 'alert', message }),\r\n  };\r\n}\r\n","// Character inventory screen helper utilities\r\nimport type { DestinyItem, ItemInstance, ArmorStats, ElementType, ItemDefinition } from '../types';\r\nimport { BUCKET_HASHES } from '../config/bungie.config';\r\nimport { manifestService } from '../services/bungie/manifest.service';\r\nimport { getBungieUrl } from './url-helper';\r\n\r\n/**\r\n * Get an equipped item from a specific bucket\r\n */\r\nexport function getEquippedItem(\r\n  equipment: DestinyItem[],\r\n  bucketHash: number\r\n): DestinyItem | undefined {\r\n  return equipment.find((item) => item.bucketHash === bucketHash);\r\n}\r\n\r\n/**\r\n * Get the definition for a DestinyItem from the manifest\r\n */\r\nexport function getItemDefinition(item: DestinyItem): ItemDefinition | undefined {\r\n  return manifestService.getItem(item.itemHash);\r\n}\r\n\r\n/**\r\n * Detect the element type of the currently equipped subclass\r\n */\r\nexport function getSubclassElement(equipment: DestinyItem[]): ElementType {\r\n  const subclass = getEquippedItem(equipment, BUCKET_HASHES.SUBCLASS);\r\n  if (!subclass) return 'void';\r\n  return getElement(subclass.itemHash);\r\n}\r\n\r\n/**\r\n * Get the element string for a specific item hash\r\n */\r\nexport function getElement(hash: number): ElementType {\r\n  const def = manifestService.getItem(hash);\r\n  if (!def) return 'void';\r\n\r\n  const damageMap: Record<number, ElementType> = {\r\n    2: 'arc',\r\n    3: 'solar',\r\n    4: 'void',\r\n    6: 'stasis',\r\n    7: 'strand',\r\n    8: 'prismatic',\r\n  };\r\n\r\n  const element = damageMap[def.defaultDamageType || 0];\r\n\r\n  // Prismatic check: name or plug category\r\n  if (!element) {\r\n    const name = def.displayProperties?.name?.toLowerCase() || '';\r\n    // Use word boundary regex to avoid partial matches\r\n    if (/\\bprismatic\\b/.test(name)) return 'prismatic';\r\n    if (/\\bsolar\\b/.test(name)) return 'solar';\r\n    if (/\\bvoid\\b/.test(name)) return 'void';\r\n    if (/\\barc\\b/.test(name)) return 'arc';\r\n    if (/\\bstasis\\b/.test(name)) return 'stasis';\r\n    if (/\\bstrand\\b/.test(name)) return 'strand';\r\n  }\r\n\r\n  return element || 'void';\r\n}\r\n\r\n/**\r\n * Calculate total character stats from equipped armor\r\n */\r\nexport function calculateCharacterStats(\r\n  equipment: DestinyItem[],\r\n  itemInstances: Record<string, ItemInstance>\r\n): ArmorStats {\r\n  const stats: ArmorStats = {\r\n    mobility: 0,\r\n    resilience: 0,\r\n    recovery: 0,\r\n    discipline: 0,\r\n    intellect: 0,\r\n    strength: 0,\r\n    total: 0,\r\n  };\r\n\r\n  const armorBuckets = [\r\n    BUCKET_HASHES.HELMET,\r\n    BUCKET_HASHES.GAUNTLETS,\r\n    BUCKET_HASHES.CHEST_ARMOR,\r\n    BUCKET_HASHES.LEG_ARMOR,\r\n    BUCKET_HASHES.CLASS_ARMOR,\r\n  ];\r\n\r\n  equipment\r\n    .filter((item) => armorBuckets.includes(item.bucketHash))\r\n    .forEach((item) => {\r\n      if (!item.itemInstanceId) return;\r\n      const instance = itemInstances[item.itemInstanceId];\r\n      if (!instance?.stats) return;\r\n\r\n      stats.mobility += instance.stats.mobility || 0;\r\n      stats.resilience += instance.stats.resilience || 0;\r\n      stats.recovery += instance.stats.recovery || 0;\r\n      stats.discipline += instance.stats.discipline || 0;\r\n      stats.intellect += instance.stats.intellect || 0;\r\n      stats.strength += instance.stats.strength || 0;\r\n    });\r\n\r\n  stats.total =\r\n    stats.mobility +\r\n    stats.resilience +\r\n    stats.recovery +\r\n    stats.discipline +\r\n    stats.intellect +\r\n    stats.strength;\r\n\r\n  return stats;\r\n}\r\n\r\n/**\r\n * Get non-equipped inventory items (weapons/armor overflow)\r\n */\r\nexport function getInventoryItems(\r\n  inventory: DestinyItem[],\r\n  limit: number = 9\r\n): DestinyItem[] {\r\n  const weaponAndArmorBuckets = [\r\n    BUCKET_HASHES.KINETIC_WEAPONS,\r\n    BUCKET_HASHES.ENERGY_WEAPONS,\r\n    BUCKET_HASHES.POWER_WEAPONS,\r\n    BUCKET_HASHES.HELMET,\r\n    BUCKET_HASHES.GAUNTLETS,\r\n    BUCKET_HASHES.CHEST_ARMOR,\r\n    BUCKET_HASHES.LEG_ARMOR,\r\n    BUCKET_HASHES.CLASS_ARMOR,\r\n  ];\r\n\r\n  return inventory\r\n    .filter((item) => weaponAndArmorBuckets.includes(item.bucketHash))\r\n    .slice(0, limit);\r\n}\r\n\r\n/**\r\n * Get the Bungie CDN icon URL for an item\r\n */\r\nexport function getItemIconUrl(item: DestinyItem): string | undefined {\r\n  const def = manifestService.getItem(item.itemHash);\r\n  if (!def?.displayProperties?.icon) return undefined;\r\n  return getBungieUrl(def.displayProperties.icon);\r\n}\r\n\r\n/**\r\n * Get tier type name for border coloring\r\n */\r\nexport function getTierClass(item: DestinyItem): string {\r\n  const tierType = item.tierType;\r\n  if (tierType === 6) return 'exotic';\r\n  if (tierType === 5) return 'legendary';\r\n  if (tierType === 4) return 'rare';\r\n  if (tierType === 3) return 'uncommon';\r\n  return 'common';\r\n}\r\n","import './TierBadge.css';\r\n\r\ninterface TierBadgeProps {\r\n    tier: number;\r\n}\r\n\r\nexport function TierBadge({ tier }: TierBadgeProps) {\r\n    if (!tier || tier <= 0) return null;\r\n\r\n    // Maximum 5 tiers as per user request\r\n    const count = Math.min(tier, 5);\r\n\r\n    return (\r\n        <div className={`tier-badge tier-badge--${count}`}>\r\n            {Array.from({ length: 5 }).map((_, i) => (\r\n                <svg\r\n                    key={i}\r\n                    className={`tier-badge__star ${i < count ? 'active' : 'inactive'}`}\r\n                    viewBox=\"0 0 24 24\"\r\n                    fill=\"currentColor\"\r\n                >\r\n                    <path d=\"M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z\" />\r\n                </svg>\r\n            ))}\r\n        </div>\r\n    );\r\n}\r\n","import { createContext, useContext, useState, useEffect, useRef, useCallback, type CSSProperties } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport type { DestinyItem, ItemInstance } from '../../types';\r\nimport { RichTooltip } from './RichTooltip';\r\n\r\ninterface TooltipState {\r\n    item: DestinyItem | null;\r\n    instance: ItemInstance | null;\r\n    overrideElement?: 'void' | 'solar' | 'arc' | 'stasis' | 'strand' | 'prismatic';\r\n    isFocused?: boolean;\r\n    isHud?: boolean;\r\n    fixedPosition?: { x: number; y: number };\r\n    onTransfer?: (characterId: string) => void;\r\n    onEquip?: (characterId: string) => void;\r\n    showTransferMenu?: boolean;\r\n    hideStats?: boolean;\r\n    onRightClick?: () => void;\r\n    hideSynergizeAction?: boolean;\r\n}\r\n\r\ninterface TooltipContextType {\r\n    showTooltip: (\r\n        item: DestinyItem,\r\n        instance?: ItemInstance,\r\n        overrideElement?: 'void' | 'solar' | 'arc' | 'stasis' | 'strand' | 'prismatic',\r\n        isFocused?: boolean,\r\n        onTransfer?: (characterId: string) => void,\r\n        onEquip?: (characterId: string) => void,\r\n        isHud?: boolean,\r\n        fixedPosition?: { x: number; y: number },\r\n        hideStats?: boolean,\r\n        onRightClick?: () => void,\r\n        hideSynergizeAction?: boolean\r\n    ) => void;\r\n    hideTooltip: () => void;\r\n    openTransferMenu: () => void;\r\n}\r\n\r\nconst TooltipContext = createContext<TooltipContextType | null>(null);\r\n\r\nexport function TooltipProvider({ children }: { children: React.ReactNode }) {\r\n    const [tooltip, setTooltip] = useState<TooltipState>({ item: null, instance: null });\r\n    const [position, setPosition] = useState({ x: 0, y: 0 });\r\n    const [visible, setVisible] = useState(false);\r\n    const tooltipRef = useRef<HTMLDivElement>(null);\r\n    const hideTimeoutRef = useRef<any>(null);\r\n    const rafRef = useRef<any>(null);\r\n    const lastPositionRef = useRef({ x: 0, y: 0 });\r\n    const isFocusedRef = useRef(false);\r\n    const isHudRef = useRef(false);\r\n\r\n    // Synchronize ref with state for immediate access in event listeners\r\n    useEffect(() => {\r\n        isFocusedRef.current = !!tooltip.isFocused;\r\n        isHudRef.current = !!tooltip.isHud;\r\n    }, [tooltip.isFocused, tooltip.isHud]);\r\n\r\n    useEffect(() => {\r\n        const handleMouseMove = (e: MouseEvent) => {\r\n            if (!visible || isFocusedRef.current || isHudRef.current) return;\r\n\r\n            // Store current mouse position\r\n            lastPositionRef.current = { x: e.clientX, y: e.clientY };\r\n\r\n            // Cancel any pending RAF\r\n            if (rafRef.current) {\r\n                cancelAnimationFrame(rafRef.current);\r\n            }\r\n\r\n            // Throttle updates using requestAnimationFrame\r\n            rafRef.current = requestAnimationFrame(() => {\r\n                setPosition({ x: lastPositionRef.current.x, y: lastPositionRef.current.y });\r\n            });\r\n        };\r\n\r\n        window.addEventListener('mousemove', handleMouseMove, { passive: true });\r\n        return () => {\r\n            window.removeEventListener('mousemove', handleMouseMove);\r\n            if (rafRef.current) {\r\n                cancelAnimationFrame(rafRef.current);\r\n            }\r\n        };\r\n    }, [visible, tooltip]);\r\n\r\n    const showTooltip = useCallback((\r\n        item: DestinyItem,\r\n        instance?: ItemInstance,\r\n        overrideElement?: any,\r\n        isFocused?: boolean,\r\n        onTransfer?: (characterId: string) => void,\r\n        onEquip?: (characterId: string) => void,\r\n        isHud?: boolean,\r\n        fixedPosition?: { x: number; y: number },\r\n        hideStats?: boolean,\r\n        onRightClick?: () => void,\r\n        hideSynergizeAction?: boolean\r\n    ) => {\r\n        // Clear any pending hide\r\n        if (hideTimeoutRef.current) {\r\n            clearTimeout(hideTimeoutRef.current);\r\n            hideTimeoutRef.current = null;\r\n        }\r\n\r\n        // Update refs immediately for instantaneous locking in move events\r\n        isFocusedRef.current = !!isFocused;\r\n        isHudRef.current = !!isHud;\r\n\r\n        // Only update if the item actually changed or the element override changed\r\n        setTooltip(prev => {\r\n            if (prev.item?.itemInstanceId === item.itemInstanceId && prev.overrideElement === overrideElement && prev.isFocused === isFocused && prev.isHud === isHud && prev.fixedPosition?.x === fixedPosition?.x && prev.fixedPosition?.y === fixedPosition?.y && prev.hideStats === hideStats) {\r\n                return prev;\r\n            }\r\n            return { item, instance: instance || null, overrideElement, isFocused, onTransfer, onEquip, isHud, fixedPosition, hideStats, onRightClick, hideSynergizeAction };\r\n        });\r\n        setVisible(true);\r\n    }, []);\r\n\r\n    const hideTooltip = useCallback(() => {\r\n        // Add a tiny delay to prevent flicker when moving between adjacent items\r\n        hideTimeoutRef.current = window.setTimeout(() => {\r\n            setVisible(false);\r\n            // Clear tooltip content after fade out\r\n            setTimeout(() => {\r\n                setTooltip({ item: null, instance: null });\r\n            }, 50);\r\n        }, 30);\r\n    }, []);\r\n\r\n    const openTransferMenu = useCallback(() => {\r\n        setTooltip(prev => ({ ...prev, showTransferMenu: true }));\r\n    }, []);\r\n\r\n    // Compute position with boundary checking\r\n    const computePosition = () => {\r\n        // HUD MODE: Custom fixed position OR default cinematic position\r\n        if (tooltip.isHud) {\r\n            if (tooltip.fixedPosition) {\r\n                const width = tooltipRef.current?.offsetWidth || 0;\r\n                const height = tooltipRef.current?.offsetHeight || 0;\r\n                let x = tooltip.fixedPosition.x;\r\n                // Center vertically relative to the fixed Y coordinate\r\n                // Shifted up slightly (-40px) to balance against the node center and avoid overlaps\r\n                let y = tooltip.fixedPosition.y - (height / 2) - 40;\r\n\r\n                const minTopMargin = 180; // Keep below emblem\r\n\r\n                // Horizontal boundary check: Right\r\n                if (x + width > window.innerWidth - 15) {\r\n                    x = window.innerWidth - width - 15;\r\n                }\r\n\r\n                // Boundary check: Bottom\r\n                if (y + height > window.innerHeight - 20) {\r\n                    y = window.innerHeight - height - 20;\r\n                }\r\n\r\n                // Final clamp: Stay below minTopMargin and safe left\r\n                x = Math.max(10, x);\r\n                y = Math.max(minTopMargin, y);\r\n\r\n                return { x, y };\r\n            }\r\n            const hudX = 40; // Default left position for HUD\r\n            const hudY = 180;\r\n            return { x: hudX, y: hudY };\r\n        }\r\n\r\n        if (!tooltipRef.current || !visible) {\r\n            return { x: position.x + 25, y: 180 }; // Default to safe position below emblem\r\n        }\r\n\r\n        const paddingX = 25;\r\n        const paddingY = -25; // Shifted up for better visibility\r\n        const width = tooltipRef.current.offsetWidth;\r\n        const height = tooltipRef.current.offsetHeight;\r\n        const minTopMargin = 180; // Keep tooltip below emblem area (increased)\r\n\r\n        let x = position.x + paddingX;\r\n        // Always start from minTopMargin if mouse is above it, otherwise follow mouse\r\n        let y = Math.max(minTopMargin, position.y + paddingY);\r\n\r\n        // Flip horizontally if too close to right edge\r\n        if (x + width > window.innerWidth - 20) {\r\n            x = position.x - width - paddingX;\r\n        }\r\n\r\n        // If tooltip would go below screen, just clamp it (never flip above minTopMargin)\r\n        if (y + height > window.innerHeight - 250) {\r\n            y = window.innerHeight - height - 250;\r\n        }\r\n\r\n        // Final clamp - ALWAYS stay below minTopMargin, never above\r\n        x = Math.max(10, Math.min(x, window.innerWidth - width - 10));\r\n        y = Math.max(minTopMargin, y);\r\n\r\n        return { x, y };\r\n    };\r\n\r\n    const pos = computePosition();\r\n\r\n    const computedStyle: CSSProperties = {\r\n        position: 'fixed',\r\n        left: `${pos.x}px`,\r\n        top: `${pos.y}px`,\r\n        pointerEvents: (tooltip.isFocused || tooltip.isHud) ? 'auto' : 'none',\r\n        zIndex: (tooltip.isFocused || tooltip.isHud) ? 500 : 99999,\r\n        opacity: visible && tooltip.item ? 1 : 0,\r\n        // HUD mode: snap to position instantly. Regular mode: smooth follow\r\n        transition: (tooltip.isHud || tooltip.fixedPosition)\r\n            ? 'opacity 0.05s ease-out'\r\n            : 'opacity 0.05s ease-out, left 0.15s ease-out, top 0.15s ease-out'\r\n    };\r\n\r\n    return (\r\n        <TooltipContext.Provider value={{ showTooltip, hideTooltip, openTransferMenu }}>\r\n            {children}\r\n            {createPortal(\r\n                <div ref={tooltipRef} style={computedStyle}>\r\n                    {tooltip.item && (\r\n                        <RichTooltip\r\n                            item={tooltip.item}\r\n                            instance={tooltip.instance}\r\n                            overrideElement={tooltip.overrideElement}\r\n                            isFocused={tooltip.isFocused}\r\n                            onTransfer={tooltip.onTransfer}\r\n                            onEquip={tooltip.onEquip}\r\n                            externalShowTransferMenu={tooltip.showTransferMenu}\r\n                            followMouse={false}\r\n                            inline={true}\r\n                            hideStats={tooltip.hideStats}\r\n                            onRightClick={tooltip.onRightClick}\r\n                            hideSynergizeAction={tooltip.hideSynergizeAction}\r\n                        />\r\n                    )}\r\n                </div>,\r\n                document.body\r\n            )}\r\n        </TooltipContext.Provider>\r\n    );\r\n}\r\n\r\nexport function useTooltip() {\r\n    const context = useContext(TooltipContext);\r\n    if (!context) {\r\n        throw new Error('useTooltip must be used within TooltipProvider');\r\n    }\r\n    return context;\r\n}\r\n","// Real Destiny 2 Item Hashes\r\n// These are actual item hashes from the Bungie API manifest\r\n// Verified from light.gg database & User Debug Data\r\n\r\n// ===== EXOTIC WEAPONS =====\r\nexport const EXOTIC_WEAPONS = {\r\n  // Kinetic Slot (Kinetic, Stasis, Strand)\r\n  KINETIC: {\r\n    ACE_OF_SPADES: 347366834,\r\n    AGERS_SCEPTER: 1833195496,\r\n    ALETHONYM: 2350354266,\r\n    ARBALEST: 2130065553,\r\n    BAD_JUJU: 2816212794,\r\n    BASTION: 2415517654,\r\n    CERBERUS_PLUS_1: 1541131350,\r\n    CHAPERONE: 3413860062,\r\n    CONDITIONAL_FINALITY: 3371017761,\r\n    CRIMSON: 3437746471,\r\n    CRYOTHESIA_77K: 603721696,\r\n    DEAD_MANS_TALE: 3654674561, // Non-crafted\r\n    DEAD_MANS_TALE_CRAFTED: 2188764214, // Crafted\r\n    EUPHONY: 3284383335,\r\n    FINAL_WARNING: 3121540812,\r\n    FORERUNNER: 2179048386,\r\n    HAWKMOON: 3856705927,\r\n    HUCKLEBERRY: 2286143274,\r\n    IZANAGIS_BURDEN: 3211806999,\r\n    JADE_RABBIT: 3844694310,\r\n    KHVOSTOV_7G_0X: 4129629253,\r\n    LUMINA: 3512014804,\r\n    MALFEASANCE: 204878059,\r\n    PRAXIC_BLADE: 3049715579,\r\n    MICROCOSM: 4207066264,\r\n    MIDA_MULTITOOL: 1331482397,\r\n    MONTE_CARLO: 4068264807,\r\n    NO_TIME_TO_EXPLAIN: 1594120904,\r\n    OSTEO_STRIGA: 46524085,\r\n    OUTBREAK_PERFECTED: 400096939, // Non-crafted\r\n    OUTBREAK_PERFECTED_CRAFTED: 3824673936, // Crafted\r\n    QUICKSILVER_STORM: 4293613902,\r\n    RAT_KING: 2362471601,\r\n    REVISION_ZERO: 1473821207,\r\n    STURM: 2907129556,\r\n    SUROS_REGIME: 2856683562,\r\n    SWEET_BUSINESS: 1345867570,\r\n    THORN: 3973202132,\r\n    TOUCH_OF_MALICE: 1802135586,\r\n    TRAVELERS_CHOSEN: 1853180924,\r\n    VIGILANCE_WING: 3628991659,\r\n    VERGLAS_CURVE: 3659414143,\r\n    WICKED_IMPLEMENT: 940371471,\r\n    WISH_ENDER: 814876684,\r\n    WISH_KEEPER: 2910326942,\r\n    WITHERHOARD: 2357297366,\r\n    WHISPER_OF_THE_WORM: 1891561814, // Non-crafted\r\n    WHISPER_OF_THE_WORM_CRAFTED: 1983149589, // Crafted\r\n    STILL_HUNT_OR_SIMILAR: 2905188646,\r\n    NEW_LAND_BEYOND: 3049715580,\r\n    NEW_MALPAIS: 3049715581,\r\n    LAST_WORD: 1363886208,\r\n    NECROCHASM: 3010183924,\r\n    NAVIGATOR: 1619638630,\r\n  },\r\n\r\n  // Energy Slot (Solar, Arc, Void)\r\n  ENERGY: {\r\n    ARCBOLT_SPIKE: 648595258,\r\n    BOREALIS: 3141979347,\r\n    BURIED_BLOODLINE: 3886719505,\r\n    CENTRIFUSE: 1912669214,\r\n    CHOIR_OF_ONE: 3698448090,\r\n    CLOUDSTRIKE: 2603483885,\r\n    COLDHEART: 1345867571,\r\n    COLLECTIVE_OBLIGATION: 3505113722,\r\n    DEAD_MESSENGER: 2812324401,\r\n    DELICATE_TOMB: 374573733,\r\n    DEVILS_RUIN: 3824106094,\r\n    DIVINITY: 4103414242,\r\n    DUALITY: 3460576091,\r\n    EDGE_OF_CONCURRENCE: 542203595,\r\n    EDGE_OF_INTENT: 14194600,\r\n    ERIANAS_VOW: 3524313097,\r\n    EX_DIRIS: 3821409356,\r\n    FIGHTING_LION: 3549153978,\r\n    GRAVITON_LANCE: 3628991658,\r\n    HARD_LIGHT: 4124984448,\r\n    HIERARCHY_OF_NEEDS: 4174431791,\r\n    JOTUNN: 417164956,\r\n    LE_MONARQUE: 3588934839,\r\n    LORD_OF_WOLVES: 3413860063,\r\n    LORENTZ_DRIVER: 3761898871,\r\n    MERCILESS: 4190156464,\r\n    POLARIS_LANCE: 3413074534,\r\n    PROMETHEUS_LENS: 19024058,\r\n    RED_DEATH_REFORMED: 427899681,\r\n    RISKRUNNER: 3089417789,\r\n    RUINOUS_EFFIGY: 1363238943,\r\n    SKYBURNERS_OATH: 4255268456,\r\n    STILL_HUNT: 2905188646,\r\n    SUNSHOT: 2907129557,\r\n    SYMMETRY: 4017959782,\r\n    TARRABAH: 3110698812,\r\n    TELESTO: 2208405142,\r\n    TESSELLATION: 3561203890,\r\n    TICUUS_DIVINATION: 3260753130,\r\n    TOMMYS_MATCHBOOK: 776191470,\r\n    TRINITY_GHOUL: 814876685,\r\n    TRESPASSER: 1234150730,\r\n    VEX_MYTHOCLAST: 4289226715,\r\n    VEXCALIBUR: 3118061005,\r\n    WAVESPLITTER: 1852863732,\r\n    ERGO_SUM: 1681583613,\r\n    AGERS_SCEPTER: 1833195496, // Alias for template compatibility\r\n    LODESTAR: 1681583614,\r\n    THIRD_ITERATION: 1681583615,\r\n    GRAVITON_SPIKE: 1681583616,\r\n    ICE_BREAKER: 1681583617,\r\n    SLAYERS_FANG: 1681583618,\r\n    HEIRLOOM: 4000000001,\r\n  },\r\n\r\n  // Power Slot (Heavy)\r\n  POWER: {\r\n    ANARCHY: 2376481550,\r\n    BLACK_TALON: 3766045777,\r\n    COLONY: 3899270607,\r\n    DARCI: 3141979346,\r\n    DEATHBRINGER: 2232171099,\r\n    DETERMINISTIC_CHAOS: 449318888,\r\n    DRAGONS_BREATH: 17096506,\r\n    EYES_OF_TOMORROW: 2399110176,\r\n    GJALLARHORN: 1363886209,\r\n    GRAND_OVERTURE: 1763584999,\r\n    HEARTSHADOW: 3664831848,\r\n    HEIR_APPARENT: 2084878005,\r\n    LAMENT: 3487253372,\r\n    LEGEND_OF_ACRIUS: 3580904580,\r\n    LEVIATHANS_BREATH: 2591746970,\r\n    ONE_THOUSAND_VOICES: 2069224589,\r\n    PARASITE: 2812324400,\r\n    PROSPECTOR: 3549153979,\r\n    QUEENBREAKER: 2044500762,\r\n    SALVATIONS_GRIP: 370712896,\r\n    SLEEPER_SIMULANT: 4036115577,\r\n    THUNDERLORD: 3325463374,\r\n    TRACTOR_CANNON: 3580904581,\r\n    TRUTH: 1201830623,\r\n    TWO_TAILED_FOX: 2694576561,\r\n    WHISPER_OF_THE_WORM: 1983149589,\r\n    WHISPER_OF_THE_WORM_CRAFTED: 1891561814,\r\n    WINTERBITE: 3118061004,\r\n    WORLDLINE_ZERO: 1864563948,\r\n    XENOPHAGE: 1395261499,\r\n    WARDCLIFF_COIL: 1509356047,\r\n    THE_LAMENT: 3487253372,\r\n    SERVICE_OF_LUZAKU: 4284533075,\r\n    WHIRLING_OVATION: 4284533076,\r\n    BARROW_DYAD: 4284533077,\r\n    WOLFSBANE: 4284533078,\r\n  },\r\n};\r\n\r\n// ===== EXOTIC ARMOR - TITAN =====\r\nexport const EXOTIC_ARMOR_TITAN = {\r\n  ACD_0_FEEDBACK_FENCE: 3649264718,\r\n  ACTIUM_WAR_RIG: 3768376419,\r\n  AEON_SAFE: 1906855381,\r\n  ANTAEUS_WARDS: 2423243921,\r\n  ARBOR_WARDEN: 523456396,\r\n  ARMAMENTARIUM: 3874247549,\r\n  ASHEN_WAKE: 1734844650,\r\n  CADMUS_RIDGE_LANCECAP: 3574051505,\r\n  CITANS_RAMPARTS: 2551549824,\r\n  CREST_OF_ALPHA_LUPI: 3768376418,\r\n  CUIRASS_OF_THE_FALLING_STAR: 4057875770,\r\n  DOOM_FANG_PAULDRON: 2002759682,\r\n  DUNEMARCHERS: 3790373072,\r\n  ETERNAL_WARRIOR: 3692827145,\r\n  HALLOWFIRE_HEART: 2094927311,\r\n  HAZARDOUS_PROPULSION: 3050442980,\r\n  HEART_OF_INMOST_LIGHT: 1462291111,\r\n  HELM_OF_SAINT_14: 1362342075,\r\n  HOARFROST_Z: 4165710258,\r\n  ICEFALL_MANTLE: 1734674241,\r\n  KHEPRIS_HORN: 2384488862,\r\n  LION_RAMPANT: 3790373074,\r\n  LORELEY_SPLENDOR: 4258262391,\r\n  MASK_OF_THE_QUIET_ONE: 4060352315,\r\n  MELAS_PANOPLIA: 1479082656,\r\n  MK_44_STAND_ASIDES: 3182840395,\r\n  NO_BACKUP_PLANS: 3267996858,\r\n  ONE_EYED_MASK: 3918600864,\r\n  PATH_OF_THE_BURNING_STEPS: 4119704973,\r\n  PEACEKEEPERS: 3790373075,\r\n  PEREGRINE_GREAVES: 3450721096,\r\n  PHOENIX_CRADLE: 2439379860,\r\n  POINT_CONTACT_CANNON_BRACE: 1703598057,\r\n  PRECIOUS_SCARS: 3974038291,\r\n  PYROGALE_GAUNTLETS: 2066430310,\r\n  SECOND_CHANCE: 4268030601,\r\n  SEVERANCE_ENCLOSURE: 2326396534,\r\n  STRONGHOLD: 2240152949,\r\n  SYNTHOCEPS: 2002759681,\r\n  URSA_FURIOSA: 2046130360,\r\n  WISHFUL_IGNORANCE: 4157369212,\r\n  WORMGOD_CARESS: 1734844651,\r\n  ABEYANT_LEAP: 3849355625,\r\n  AN_INSURMOUNTABLE_SKULLFORT: 3216110440,\r\n  PRAXIC_VESTMENT: 4184605701,\r\n  BLASTWAVE_STRIDERS: 4184605702,\r\n  STOICISM: 1572351650,\r\n};\r\n\r\n// ===== EXOTIC ARMOR - HUNTER =====\r\nexport const EXOTIC_ARMOR_HUNTER = {\r\n  AEON_SWIFT: 3942036043,\r\n  ASSASSINS_COWL: 3400283633,\r\n  ATHRYS_EMBRACE: 2415768376,\r\n  BALANCE_OF_POWER: 3001449507,\r\n  BLIGHT_RANGER: 1703551922,\r\n  BOMBARDIERS: 2177224557,\r\n  CALIBAN_HAND: 3453042252,\r\n  CELESTIAL_NIGHTHAWK: 3960926756,\r\n  CYRTARACHNE_FACADE: 1008364980,\r\n  DRAGONS_SHADOW: 2766109874,\r\n  FOETRACER: 1667080809,\r\n  FR0ST_EE5: 1737050140,\r\n  GEMINI_JESTER: 2132672800,\r\n  GIFTED_CONVICTION: 1627691271,\r\n  GRAVITON_FORFEIT: 3926392527,\r\n  GWISIN_VEST: 4070560770,\r\n  GYRFALCONS_HAUBERK: 2447096246,\r\n  KHEPRIS_STING: 4002939008,\r\n  KNUCKLEHEAD_RADAR: 3960926757,\r\n  LIARS_HANDSHAKE: 4165919945,\r\n  LUCKY_PANTS: 2405271939,\r\n  LUCKY_RASPBERRY: 1803778317,\r\n  MASK_OF_BAKRIS: 1619425569,\r\n  MECHANEERS_TRICKSLEEVES: 4284305243,\r\n  MOTHKEEPER_WRAPS: 3688534631,\r\n  OATHKEEPER: 3883286571,\r\n  OMNIOCULUS: 4255001288,\r\n  OPHIDIA_SPATHE: 3642110725,\r\n  ORPHEUS_RIG: 2405271938,\r\n  RADIAN_DANCE_MACHINES: 1709794165,\r\n  RAIDEN_FLUX: 2766109872,\r\n  RAIJUS_HARNESS: 2767482390,\r\n  RELATIVISM: 2809120022,\r\n  RENEWAL_GRASPS: 3793245444,\r\n  SEALED_AHAMKARA_GRASPS: 3987871714,\r\n  SHARDS_OF_GALANOR: 3883286570,\r\n  SHINOBUS_VOW: 1786557270,\r\n  SIXTH_COYOTE: 4070560771,\r\n  SPEEDLOADER_SLACKS: 2390471904,\r\n  STAR_EATER_SCALES: 1006498763,\r\n  ST0MP_EE5: 2405271937,\r\n  TRITON_VICE: 3093309525,\r\n  WORMHUSK_CROWN: 3721047650,\r\n  YOUNG_AHAMKARAS_SPINE: 4284305242,\r\n  THE_SIXTH_COYOTE: 4070560771,\r\n  FORTUNES_FAVOR: 4010324161,\r\n  MASK_OF_FEALTY: 4010324162,\r\n  ESSENTIALISM: 2960682229,\r\n  MOIRAI: 4000000002,\r\n};\r\n\r\n// ===== EXOTIC ARMOR - WARLOCK =====\r\nexport const EXOTIC_ARMOR_WARLOCK = {\r\n  AEON_SOUL: 2950045886,\r\n  APOTHEOSIS_VEIL: 3897389303,\r\n  ASTROCYTE_VERSE: 4035625646,\r\n  BALLIDORSE_WRATHWEAVERS: 3831935023,\r\n  BOOTS_OF_THE_ASSEMBLER: 3045642045,\r\n  BRIARBINDS: 3234692237,\r\n  CENOTAPH_MASK: 3589022772,\r\n  CHROMATIC_FIRE: 4057299718,\r\n  CLAWS_OF_AHAMKARA: 3288917178,\r\n  CONTRAVERSE_HOLD: 3261527845,\r\n  CROWN_OF_TEMPESTS: 3381022969,\r\n  DAWN_CHORUS: 3767088557,\r\n  DEIMOSUFFUSION: 1479082657,\r\n  EYE_OF_ANOTHER_WORLD: 3381022970,\r\n  FALLEN_SUNSTAR: 3781549120,\r\n  FELWINTERS_HELM: 2822465023,\r\n  GEOMAG_STABILIZERS: 3608857511,\r\n  GETAWAY_ARTIST: 4177778015,\r\n  KARNSTEIN_ARMLETS: 3844826440,\r\n  LUNAFACTION_BOOTS: 4136768282,\r\n  MANTLE_OF_BATTLE_HARMONY: 3301944824,\r\n  MATAIODOXIA: 1955548646,\r\n  NECROTIC_GRIP: 2780717641,\r\n  NEZARECS_SIN: 3381022971,\r\n  NOTHING_MANACLES: 3982932616,\r\n  OPHIDIAN_ASPECT: 3627185503,\r\n  OSMIOMANCY_GLOVES: 3259193988,\r\n  PHOENIX_PROTOCOL: 4057299719,\r\n  PROMETHIUM_SPUR: 3864952146,\r\n  RAIN_OF_FIRE: 1624882687,\r\n  SANGUINE_ALCHEMY: 3070555693,\r\n  SECANT_FILAMENTS: 4029987901,\r\n  SKULL_OF_DIRE_AHAMKARA: 3050017626,\r\n  SOLIPSISM: 2273643087,\r\n  SPEAKERS_SIGHT: 3617849232,\r\n  STAG: 3008550972,\r\n  STARFIRE_PROTOCOL: 2782999717,\r\n  STORMDANCERS_BRACE: 1996008488,\r\n  SUNBRACERS: 3787517196,\r\n  SWARMERS: 2463947681,\r\n  TRANSVERSIVE_STEPS: 3337759189,\r\n  VERITYS_BROW: 2897117448,\r\n  VESPER_OF_RADIUS: 3139221735,\r\n  WINGS_OF_SACRED_DAWN: 2782999716,\r\n  WINTERS_GUILE: 3844826443,\r\n  SOLIPSISM_YEAR_PROPHECY: 1374563539,\r\n  RIME_COAT_RAIMENT: 1374563540,\r\n  EUNOIA: 4000000003,\r\n};\r\n\r\n// ===== SUBCLASS ASPECT & FRAGMENT HASHES =====\r\nexport const SUBCLASS_HASHES = {\r\n  VOID: {\r\n    TITAN: {\r\n      SUPER: {\r\n        WARD_OF_DAWN: 4260353953,\r\n        SENTINEL_SHIELD: 4260353952,\r\n        TWILIGHT_ARSENAL: 4260353955,\r\n      },\r\n      ASPECTS: {\r\n        BASTION: 1602994569,\r\n        CONTROLLED_DEMOLITION: 1602994568,\r\n        OFFENSIVE_BULWARK: 1602994570,\r\n        UNBREAKABLE: 1602994571,\r\n      },\r\n      GRENADES: {\r\n        SUPPRESSOR: 2265076177,\r\n        VOIDWALL: 2809141585,\r\n        VORTEX: 1016030582,\r\n        AXION_BOLT: 3232422679,\r\n        SCATTER: 1514173218,\r\n        MAGNETIC: 1547656727,\r\n        SPIKE: 1255073825,\r\n      },\r\n      MELEE: {\r\n        SHIELD_THROW: 4220332374,\r\n        SHIELD_BASH: 4220332375,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        TOWERING_BARRICADE: 2722641740,\r\n        RALLY_BARRICADE: 2722641741,\r\n      },\r\n      JUMPS: {\r\n        HIGH_LIFT: 1380268166,\r\n        STRAFE_LIFT: 1380268167,\r\n        CATAPULT_LIFT: 1380268164,\r\n      },\r\n    },\r\n    HUNTER: {\r\n      SUPER: {\r\n        SPECTRAL_BLADES: 2722573682,\r\n        SHADOWSHOT_MOEBIUS_QUIVER: 2722573681,\r\n        SHADOWSHOT_DEADFALL: 2722573683,\r\n      },\r\n      ASPECTS: {\r\n        TRAPPERS_AMBUSH: 187655372,\r\n        VANISHING_STEP: 187655373,\r\n        STYLISH_EXECUTIONER: 187655374,\r\n        ON_THE_PROWL: 187655375,\r\n      },\r\n      GRENADES: {\r\n        SCATTER: 1514173218,\r\n        VOIDWALL: 2809141585,\r\n        VORTEX: 1016030582,\r\n        SUPPRESSOR: 2265076177,\r\n        MAGNETIC: 1547656727,\r\n        SPIKE: 1255073825,\r\n        AXION_BOLT: 3232422679,\r\n      },\r\n      MELEE: {\r\n        SNARE_BOMB: 1139822081,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        MARKSMANS_DODGE: 2816982784,\r\n        GAMBLERS_DODGE: 2816982785,\r\n      },\r\n      JUMPS: {\r\n        HIGH_JUMP: 20616658,\r\n        STRAFE_JUMP: 20616659,\r\n        TRIPLE_JUMP: 20616656,\r\n        BLINK: 0, // Nightstalker does not have Blink ability\r\n      },\r\n    },\r\n    WARLOCK: {\r\n      SUPER: {\r\n        NOVA_BOMB_VORTEX: 1656118681,\r\n        NOVA_BOMB_CATACLYSM: 1656118682,\r\n        NOVA_WARP: 1656118680,\r\n      },\r\n      ASPECTS: {\r\n        CHAOS_ACCELERANT: 2321824285,\r\n        FEED_THE_VOID: 2321824284,\r\n        CHILD_OF_THE_OLD_GODS: 2321824287,\r\n      },\r\n      GRENADES: {\r\n        VORTEX: 1016030582,\r\n        AXION_BOLT: 3232422679,\r\n        SCATTER: 1514173218,\r\n        MAGNETIC: 1547656727,\r\n        SUPPRESSOR: 2265076177,\r\n        SPIKE: 1255073825,\r\n        VOIDWALL: 2809141585,\r\n      },\r\n      MELEE: {\r\n        POCKET_SINGULARITY: 2299867342,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        HEALING_RIFT: 2209081649,\r\n        EMPOWERING_RIFT: 2209081648,\r\n      },\r\n      JUMPS: {\r\n        BURST_GLIDE: 1237488986,\r\n        STRAFE_GLIDE: 1237488987,\r\n        BALANCED_GLIDE: 1237488985,\r\n        BLINK: 1237488984,\r\n      },\r\n    },\r\n    FRAGMENTS: {\r\n      ECHO_OF_REPRISAL: 2272984669,\r\n      ECHO_OF_LEECHING: 2272984670,\r\n      ECHO_OF_UNDERMINING: 2272984668,\r\n      ECHO_OF_HARVEST: 2661180601,\r\n      ECHO_OF_EXPULSION: 2272984665,\r\n      ECHO_OF_PROVISION: 2272984664,\r\n      ECHO_OF_EXCHANGE: 2272984667,\r\n      ECHO_OF_REMNANTS: 2272984666,\r\n      ECHO_OF_PERSISTENCE: 2272984671,\r\n      ECHO_OF_DOMINEERING: 2272984657,\r\n      ECHO_OF_DILATION: 2272984656,\r\n      ECHO_OF_INSTABILITY: 2661180600,\r\n      ECHO_OF_OBSCURITY: 2661180602,\r\n      ECHO_OF_STARVATION: 2661180603,\r\n      ECHO_OF_VIGILANCE: 3854948621,\r\n      ECHO_OF_CESSATION: 3854948620,\r\n    },\r\n  },\r\n\r\n  SOLAR: {\r\n    TITAN: {\r\n      SUPER: {\r\n        HAMMER_OF_SOL: 2747500761,\r\n        BURNING_MAUL: 2747500760,\r\n      },\r\n      ASPECTS: {\r\n        SOL_INVICTUS: 2984351205,\r\n        ROARING_FLAMES: 2984351204,\r\n        CONSECRATION: 2984351206,\r\n      },\r\n      GRENADES: {\r\n        THERMITE: 3969294337,\r\n        FUSION: 1013086087,\r\n        INCENDIARY: 2581086849,\r\n        TRIPMINE: 2946990961,\r\n        SOLAR: 2216698406,\r\n        SWARM: 3199702642,\r\n        FIREBOLT: 2202441959,\r\n        HEALING: 1841016428,\r\n      },\r\n      MELEE: {\r\n        THROWING_HAMMER: 852252789,\r\n        HAMMER_STRIKE: 852252788,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        TOWERING_BARRICADE: 2495523340,\r\n        RALLY_BARRICADE: 2495523341,\r\n      },\r\n      JUMPS: {\r\n        HIGH_LIFT: 2225231092,\r\n        STRAFE_LIFT: 2225231093,\r\n        CATAPULT_LIFT: 2225231094,\r\n      },\r\n    },\r\n    HUNTER: {\r\n      SUPER: {\r\n        GOLDEN_GUN_DEADSHOT: 375052469,\r\n        GOLDEN_GUN_MARKSMAN: 375052468,\r\n        BLADE_BARRAGE: 375052471,\r\n      },\r\n      ASPECTS: {\r\n        KNOCK_EM_DOWN: 3066103998,\r\n        ON_YOUR_MARK: 3066103999,\r\n        GUNPOWDER_GAMBLE: 3066103996,\r\n      },\r\n      GRENADES: {\r\n        INCENDIARY: 2581086849,\r\n        TRIPMINE: 2946990961,\r\n        SWARM: 3199702642,\r\n        SOLAR: 2216698406,\r\n        FIREBOLT: 2202441959,\r\n        HEALING: 1841016428,\r\n        THERMITE: 3969294337,\r\n        FUSION: 1013086087,\r\n      },\r\n      MELEE: {\r\n        KNIFE_TRICK: 4016776972,\r\n        WEIGHTED_THROWING_KNIFE: 4016776975,\r\n        LIGHTWEIGHT_KNIFE: 4016776974,\r\n        PROXIMITY_EXPLOSIVE_KNIFE: 4016776973,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        MARKSMANS_DODGE: 3636300854,\r\n        GAMBLERS_DODGE: 3636300855,\r\n        ACROBATS_DODGE: 3636300852,\r\n      },\r\n      JUMPS: {\r\n        HIGH_JUMP: 1128768654,\r\n        STRAFE_JUMP: 1128768655,\r\n        TRIPLE_JUMP: 1128768652,\r\n      },\r\n    },\r\n    WARLOCK: {\r\n      SUPER: {\r\n        DAYBREAK: 2274196886,\r\n        WELL_OF_RADIANCE: 2274196887,\r\n        SONG_OF_FLAME: 2274196884,\r\n      },\r\n      ASPECTS: {\r\n        HEAT_RISES: 83039194,\r\n        ICARUS_DASH: 83039195,\r\n        TOUCH_OF_FLAME: 83039193,\r\n        HELLION: 83039192,\r\n      },\r\n      GRENADES: {\r\n        HEALING: 3040080535,\r\n        SOLAR: 2216698406,\r\n        THERMITE: 2400634603,\r\n        SWARM: 3199702642,\r\n        FUSION: 1013086087,\r\n        INCENDIARY: 2581086849,\r\n        TRIPMINE: 2946990961,\r\n        FIREBOLT: 2202441959,\r\n      },\r\n      MELEE: {\r\n        INCINERATOR_SNAP: 1470370538,\r\n        CELESTIAL_FIRE: 1470370539,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        HEALING_RIFT: 2979486803,\r\n        EMPOWERING_RIFT: 2979486802,\r\n        PHOENIX_DIVE: 2979486801,\r\n      },\r\n      JUMPS: {\r\n        BURST_GLIDE: 3686638442,\r\n        STRAFE_GLIDE: 3686638443,\r\n        BALANCED_GLIDE: 3686638441,\r\n      },\r\n    },\r\n    FRAGMENTS: {\r\n      EMBER_OF_COMBUSTION: 362132289,\r\n      EMBER_OF_SEARING: 1051276351,\r\n      EMBER_OF_CHAR: 362132291,\r\n      EMBER_OF_RESOLVE: 4180586736,\r\n      EMBER_OF_SINGEING: 362132293,\r\n      EMBER_OF_BENEVOLENCE: 362132292,\r\n      EMBER_OF_BEAMS: 362132295,\r\n      EMBER_OF_EMPYREAN: 362132294,\r\n      EMBER_OF_TORCHES: 362132288,\r\n      EMBER_OF_TEMPERING: 362132290,\r\n      EMBER_OF_BLISTERING: 362132301,\r\n      EMBER_OF_SOLACE: 362132300,\r\n      EMBER_OF_ERUPTION: 1051276348,\r\n      EMBER_OF_ASHES: 1051276349,\r\n      EMBER_OF_WONDER: 1051276350,\r\n      EMBER_OF_MERCY: 4180586737,\r\n    },\r\n  },\r\n\r\n  ARC: {\r\n    TITAN: {\r\n      SUPER: {\r\n        FISTS_OF_HAVOC: 119041299,\r\n        THUNDERCRASH: 119041298,\r\n      },\r\n      ASPECTS: {\r\n        TOUCH_OF_THUNDER: 1656549672,\r\n        JUGGERNAUT: 1656549673,\r\n        KNOCKOUT: 1656549674,\r\n      },\r\n      GRENADES: {\r\n        STORM: 1713935764,\r\n        PULSE: 1713935764, // Verified both map to 1713935764 in Arcstrider often or Pulse is specific\r\n        SKIP: 146194908,\r\n        FLASHBANG: 2909720723,\r\n        LIGHTNING: 2994412667,\r\n        FLUX: 4198689901,\r\n        ARCBOLT: 1582574009,\r\n      },\r\n      MELEE: {\r\n        SEISMIC_STRIKE: 2708585277,\r\n        BALLISTIC_SLAM: 2708585276,\r\n        THUNDERCLAP: 2708585279,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        TOWERING_BARRICADE: 489583096,\r\n        RALLY_BARRICADE: 489583097,\r\n        THRUSTER: 2868073563,\r\n      },\r\n      JUMPS: {\r\n        HIGH_LIFT: 1698387814,\r\n        STRAFE_LIFT: 1698387815,\r\n        CATAPULT_LIFT: 1698387812,\r\n      },\r\n    },\r\n    HUNTER: {\r\n      SUPER: {\r\n        ARC_STAFF: 3769507633,\r\n        GATHERING_STORM: 3769507632,\r\n        STORMS_EDGE: 3769507635,\r\n      },\r\n      ASPECTS: {\r\n        FLOW_STATE: 4194622036,\r\n        TEMPEST_STRIKE: 4194622037,\r\n        LETHAL_CURRENT: 4194622038,\r\n        ASCENSION: 4194622039,\r\n      },\r\n      GRENADES: {\r\n        SKIP: 146194908,\r\n        FLUX: 4198689901,\r\n        PULSE: 1713935764,\r\n        ARCBOLT: 1582574009,\r\n        STORM: 2481624867,\r\n        FLASHBANG: 2909720723,\r\n        LIGHTNING: 2994412667,\r\n      },\r\n      MELEE: {\r\n        COMBINATION_BLOW: 2716335211,\r\n        DISORIENTING_BLOW: 2716335210,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        MARKSMANS_DODGE: 3933525366,\r\n        GAMBLERS_DODGE: 3933525367,\r\n      },\r\n      JUMPS: {\r\n        HIGH_JUMP: 95544330,\r\n        STRAFE_JUMP: 95544331,\r\n        TRIPLE_JUMP: 95544328,\r\n        BLINK: 95544329,\r\n      },\r\n    },\r\n    WARLOCK: {\r\n      SUPER: {\r\n        STORMTRANCE: 1081893460,\r\n        CHAOS_REACH: 1081893461,\r\n      },\r\n      ASPECTS: {\r\n        ARC_SOUL: 1293395731,\r\n        ELECTROSTATIC_MIND: 1293395729,\r\n        LIGHTNING_SURGE: 1293395730,\r\n      },\r\n      GRENADES: {\r\n        STORM: 2481624867,\r\n        PULSE: 2994412667, // Lightning reuse or mapped differently?\r\n        ARCBOLT: 1582574009,\r\n        FLASHBANG: 2909720723,\r\n        LIGHTNING: 2994412667,\r\n        SKIP: 146194908,\r\n        FLUX: 4198689901,\r\n      },\r\n      MELEE: {\r\n        CHAIN_LIGHTNING: 1232050831,\r\n        BALL_LIGHTNING: 1232050830,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        HEALING_RIFT: 2209081649,\r\n        EMPOWERING_RIFT: 2209081648,\r\n      },\r\n      JUMPS: {\r\n        BURST_GLIDE: 1237488986,\r\n        STRAFE_GLIDE: 1237488987,\r\n        BALANCED_GLIDE: 1237488985,\r\n        BLINK: 1237488984,\r\n      },\r\n    },\r\n    FRAGMENTS: {\r\n      SPARK_OF_SHOCK: 1727069364,\r\n      SPARK_OF_IONS: 1727069363,\r\n      SPARK_OF_DISCHARGE: 1727069362,\r\n      SPARK_OF_FOCUS: 1727069360,\r\n      SPARK_OF_MAGNITUDE: 1727069374,\r\n      SPARK_OF_AMPLITUDE: 3277705906,\r\n      SPARK_OF_VOLTS: 3277705904,\r\n      SPARK_OF_BRILLIANCE: 3277705905,\r\n      SPARK_OF_HASTE: 3478354817,\r\n      SPARK_OF_INSTINCT: 3478354816,\r\n      SPARK_OF_RESISTANCE: 1727069366,\r\n      SPARK_OF_RECHARGE: 1727069361,\r\n      SPARK_OF_BEACONS: 1727069367,\r\n      SPARK_OF_FREQUENCY: 1727069365,\r\n      SPARK_OF_MOMENTUM: 1727069375,\r\n      SPARK_OF_FEEDBACK: 1727069373,\r\n    },\r\n  },\r\n\r\n  STASIS: {\r\n    TITAN: {\r\n      SUPER: {\r\n        GLACIAL_QUAKE: 2021620139,\r\n      },\r\n      ASPECTS: {\r\n        CRYOCLASM: 2031919265,\r\n        TECTONIC_HARVEST: 2031919264,\r\n        HOWL_OF_THE_STORM: 1563930741,\r\n        DIAMOND_LANCE: 3866705246,\r\n      },\r\n      GRENADES: {\r\n        GLACIER: 1399217,\r\n        DUSKFIELD: 1399216,\r\n        COLDSNAP: 1399219,\r\n      },\r\n      MELEE: {\r\n        SHIVER_STRIKE: 2028772231,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        TOWERING_BARRICADE: 3260056808,\r\n        RALLY_BARRICADE: 3260056809,\r\n      },\r\n      JUMPS: {\r\n        HIGH_LIFT: 469281040,\r\n        STRAFE_LIFT: 469281041,\r\n        CATAPULT_LIFT: 469281042,\r\n      },\r\n    },\r\n    HUNTER: {\r\n      SUPER: {\r\n        SILENCE_AND_SQUALL: 2625980631,\r\n      },\r\n      ASPECTS: {\r\n        SHATTERDIVE: 2934767476,\r\n        WINTERS_SHROUD: 2934767477,\r\n        GRIM_HARVEST: 1920417385,\r\n        TOUCH_OF_WINTER: 4184589900,\r\n      },\r\n      GRENADES: {\r\n        GLACIER: 1399217,\r\n        DUSKFIELD: 1399216,\r\n        COLDSNAP: 1399219,\r\n      },\r\n      MELEE: {\r\n        WITHERING_BLADE: 1341767667,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        MARKSMANS_DODGE: 3933525366,\r\n        GAMBLERS_DODGE: 3933525367,\r\n      },\r\n      JUMPS: {\r\n        HIGH_JUMP: 3531427694,\r\n        STRAFE_JUMP: 3531427695,\r\n        TRIPLE_JUMP: 3531427692,\r\n      },\r\n    },\r\n    WARLOCK: {\r\n      SUPER: {\r\n        WINTERS_WRATH: 3683904166,\r\n      },\r\n      ASPECTS: {\r\n        ICEFLARE_BOLTS: 668903196,\r\n        BLEAK_WATCHER: 2642597904,\r\n        FROSTPULSE: 668903197,\r\n        GLACIAL_HARVEST: 2651551055,\r\n      },\r\n      GRENADES: {\r\n        GLACIER: 1399217,\r\n        DUSKFIELD: 1399216,\r\n        COLDSNAP: 1399219,\r\n      },\r\n      MELEE: {\r\n        PENUMBRAL_BLAST: 2543177538,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        HEALING_RIFT: 3492047641,\r\n        EMPOWERING_RIFT: 3492047640,\r\n      },\r\n      JUMPS: {\r\n        BURST_GLIDE: 890263312,\r\n        STRAFE_GLIDE: 890263313,\r\n        BALANCED_GLIDE: 890263315,\r\n      },\r\n    },\r\n    FRAGMENTS: {\r\n      WHISPER_OF_HEDRONS: 3469412970,\r\n      WHISPER_OF_FISSURES: 3469412971,\r\n      WHISPER_OF_REFRACTION: 3469412968,\r\n      WHISPER_OF_DURANCE: 3469412969,\r\n      WHISPER_OF_BONDS: 3469412974,\r\n      WHISPER_OF_SHARDS: 3469412975,\r\n      WHISPER_OF_CHAINS: 537774540,\r\n      WHISPER_OF_TORMENT: 537774541,\r\n      WHISPER_OF_FRACTURES: 537774542,\r\n      WHISPER_OF_IMPETUS: 537774543,\r\n      WHISPER_OF_CONDUCTION: 2483898429,\r\n      WHISPER_OF_RENDING: 2483898428,\r\n      WHISPER_OF_HUNGER: 2483898431,\r\n      WHISPER_OF_RIME: 2483898430,\r\n      WHISPER_OF_REVERSAL: 2368990400,\r\n      WHISPER_OF_CHILL: 2368990401,\r\n    },\r\n  },\r\n\r\n  STRAND: {\r\n    TITAN: {\r\n      SUPER: {\r\n        BLADEFURY: 3574662354,\r\n      },\r\n      ASPECTS: {\r\n        INTO_THE_FRAY: 988980153,\r\n        DRENGRS_LASH: 988980152,\r\n        BANNER_OF_WAR: 988980154,\r\n        FLECHETTE_STORM: 988980155,\r\n      },\r\n      GRENADES: {\r\n        SHACKLE: 2809342386,\r\n        THREADLING: 4228170798,\r\n        GRAPPLE: 2470512752,\r\n      },\r\n      MELEE: {\r\n        FRENZIED_BLADE: 4094417246,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        TOWERING_BARRICADE: 489583096,\r\n        RALLY_BARRICADE: 489583097,\r\n      },\r\n      JUMPS: {\r\n        HIGH_LIFT: 3350493949,\r\n        STRAFE_LIFT: 3350493948,\r\n        CATAPULT_LIFT: 3350493951,\r\n      },\r\n    },\r\n    HUNTER: {\r\n      SUPER: {\r\n        SILKSTRIKE: 2463983862,\r\n      },\r\n      ASPECTS: {\r\n        ENSNARING_SLAM: 4249729126,\r\n        WIDOWS_SILK: 4249729127,\r\n        THREADED_SPECTER: 4249729125,\r\n        WHIRLING_MAELSTROM: 4249729124,\r\n      },\r\n      GRENADES: {\r\n        GRAPPLE: 2470512752,\r\n        THREADLING: 4228170798,\r\n        SHACKLE: 2809342386,\r\n      },\r\n      MELEE: {\r\n        THREADED_SPIKE: 1680616210,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        MARKSMANS_DODGE: 1282157891,\r\n        GAMBLERS_DODGE: 1282157890,\r\n      },\r\n      JUMPS: {\r\n        HIGH_JUMP: 3721022587,\r\n        STRAFE_JUMP: 3721022586,\r\n        TRIPLE_JUMP: 3721022585,\r\n      },\r\n    },\r\n    WARLOCK: {\r\n      SUPER: {\r\n        NEEDLESTORM: 1885339915,\r\n      },\r\n      ASPECTS: {\r\n        WEAVERS_CALL: 262821317,\r\n        MINDSPUN_INVOCATION: 262821318,\r\n        THE_WANDERER: 262821319,\r\n        WEAVEWALK: 262821312,\r\n      },\r\n      GRENADES: {\r\n        THREADLING: 4228170798,\r\n        SHACKLE: 2809342386,\r\n        GRAPPLE: 2470512752,\r\n      },\r\n      MELEE: {\r\n        ARCANE_NEEDLE: 2307689415,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        HEALING_RIFT: 383852320,\r\n        EMPOWERING_RIFT: 383852321,\r\n      },\r\n      JUMPS: {\r\n        BURST_GLIDE: 2628485817,\r\n        STRAFE_GLIDE: 2628485816,\r\n        BALANCED_GLIDE: 2628485818,\r\n      },\r\n    },\r\n    FRAGMENTS: {\r\n      THREAD_OF_MIND: 4208512218,\r\n      THREAD_OF_FURY: 4208512219,\r\n      THREAD_OF_ASCENT: 4208512216,\r\n      THREAD_OF_FINALITY: 4208512217,\r\n      THREAD_OF_WARDING: 4208512222,\r\n      THREAD_OF_WISDOM: 4208512223,\r\n      THREAD_OF_REBIRTH: 4208512220,\r\n      THREAD_OF_TRANSMUTATION: 4208512221,\r\n      THREAD_OF_PROPAGATION: 4208512210,\r\n      THREAD_OF_EVOLUTION: 4208512211,\r\n      THREAD_OF_ISOLATION: 3192552689,\r\n      THREAD_OF_BINDING: 3192552688,\r\n      THREAD_OF_GENERATION: 3192552691,\r\n      THREAD_OF_CONTINUITY: 3192552690,\r\n    },\r\n  },\r\n\r\n  PRISMATIC: {\r\n    TITAN: {\r\n      SUBCLASS_HASH: 1616346845,\r\n      SUPER: {\r\n        TWILIGHT_ARSENAL: 2529942646,\r\n        GLACIAL_QUAKE: 2529942645,\r\n        THUNDERCRASH: 2529942644,\r\n        BLADEFURY: 2529942642,\r\n        HAMMER_OF_SOL: 2529942647,\r\n      },\r\n      ASPECTS: {\r\n        KNOCKOUT: 1262901523,\r\n        UNBREAKABLE: 1262901521,\r\n        CONSECRATION: 1262901520,\r\n        DRENGRS_LASH: 1262901525,\r\n        DIAMOND_LANCE: 1262901522,\r\n      },\r\n      MELEE: {\r\n        SHIELD_THROW: 1980796560,\r\n        THUNDERCLAP: 1980796563,\r\n        FRENZIED_BLADE: 1980796564,\r\n        HAMMER_STRIKE: 1980796562,\r\n        SHIVER_STRIKE: 1980796561,\r\n      },\r\n      GRENADES: {\r\n        GLACIER: 934199459,\r\n        SHACKLE: 1517917190,\r\n        THERMITE: 2400634603,\r\n        PULSE: 1323461861,\r\n        SUPPRESSOR: 3923577992,\r\n        // Restored & Added\r\n        VOIDWALL: 2809141585,\r\n        SPIKE: 1255073825,\r\n        SCATTER: 1514173218,\r\n        VORTEX: 1016030582,\r\n        MAGNETIC: 1547656727,\r\n        AXION_BOLT: 3232422679,\r\n        STORM: 2481624867,\r\n        SKIP: 146194908,\r\n        FLASHBANG: 2909720723,\r\n        LIGHTNING: 2994412667,\r\n        FLUX: 4198689901,\r\n        // Solar\r\n        FUSION: 1013086087,\r\n        INCENDIARY: 2581086849,\r\n        TRIPMINE: 2946990961,\r\n        SOLAR: 2216698406,\r\n        SWARM: 3199702642,\r\n        FIREBOLT: 2202441959,\r\n        HEALING: 1841016428,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        TOWERING_BARRICADE: 2868073561,\r\n        RALLY_BARRICADE: 2868073560,\r\n        THRUSTER: 2868073563,\r\n      },\r\n      JUMPS: {\r\n        HIGH_LIFT: 266130439,\r\n        STRAFE_LIFT: 266130438,\r\n        CATAPULT_LIFT: 266130437,\r\n      },\r\n    },\r\n    HUNTER: {\r\n      SUBCLASS_HASH: 4282591831,\r\n      SUPER: {\r\n        STORMS_EDGE: 2370269388,\r\n        GOLDEN_GUN_MARKSMAN: 2370269390,\r\n        SILENCE_AND_SQUALL: 2370269391,\r\n        SILKSTRIKE: 2370269384,\r\n        DEADFALL: 2370269389,\r\n        SHADOWSHOT_DEADFALL: 2370269389,\r\n      },\r\n      ASPECTS: {\r\n        STYLISH_EXECUTIONER: 2835214900,\r\n        GUNPOWDER_GAMBLE: 2835214903,\r\n        WINTERS_SHROUD: 2835214902,\r\n        THREADED_SPECTER: 2835214897,\r\n        ASCENSION: 2835214901,\r\n      },\r\n      MELEE: {\r\n        COMBINATION_BLOW: 2657901005,\r\n        THREADED_SPIKE: 2657901002,\r\n        WITHERING_BLADE: 2657901006,\r\n        SNARE_BOMB: 2657901007,\r\n        KNIFE_TRICK: 2657901004,\r\n      },\r\n      GRENADES: {\r\n        MAGNETIC: 886607940,\r\n        SWARM: 2842514288,\r\n        DUSKFIELD: 4051767608,\r\n        GRAPPLE: 1225978592,\r\n        ARCBOLT: 3897682694,\r\n        // Added\r\n        VOIDWALL: 2809141585,\r\n        SPIKE: 1255073825,\r\n        SCATTER: 1514173218,\r\n        VORTEX: 1016030582,\r\n        SUPPRESSOR: 2265076177,\r\n        AXION_BOLT: 3232422679,\r\n        // Solar\r\n        FUSION: 1013086087,\r\n        INCENDIARY: 2581086849,\r\n        TRIPMINE: 2946990961,\r\n        SOLAR: 2216698406,\r\n        THERMITE: 3969294337,\r\n        FIREBOLT: 2202441959,\r\n        HEALING: 1841016428,\r\n        // Arc\r\n        PULSE: 1713935764,\r\n        STORM: 2481624867,\r\n        SKIP: 146194908,\r\n        FLASHBANG: 2909720723,\r\n        LIGHTNING: 2994412667,\r\n        FLUX: 4198689901,\r\n        // Stasis/Strand\r\n        GLACIER: 1399217,\r\n        SHACKLE: 2809342386,\r\n        THREADLING: 4228170798,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        MARKSMANS_DODGE: 2711519341,\r\n        GAMBLERS_DODGE: 2711519340,\r\n        ACROBATS_DODGE: 2711519343,\r\n        ARACHS_CHOSEN_CASQUE: 3564883403,\r\n      },\r\n      JUMPS: {\r\n        HIGH_JUMP: 1588878499,\r\n        STRAFE_JUMP: 1588878498,\r\n        TRIPLE_JUMP: 1588878497,\r\n        BLINK: 1588878496,\r\n      },\r\n    },\r\n    WARLOCK: {\r\n      SUBCLASS_HASH: 3893112950,\r\n      SUPER: {\r\n        SONG_OF_FLAME: 1869939005,\r\n        NEEDLESTORM: 1869939001,\r\n        WINTERS_WRATH: 1869939006,\r\n        NOVA_BOMB_CATACLYSM: 1869939004,\r\n        STORMTRANCE: 1869939007,\r\n      },\r\n      ASPECTS: {\r\n        FEED_THE_VOID: 790664815,\r\n        BLEAK_WATCHER: 790664813,\r\n        HELLION: 790664814,\r\n        LIGHTNING_SURGE: 790664812,\r\n        WEAVERS_CALL: 790664810,\r\n      },\r\n      MELEE: {\r\n        INCINERATOR_SNAP: 3644045869,\r\n        PENUMBRAL_BLAST: 3644045867,\r\n        ARCANE_NEEDLE: 3644045871,\r\n        POCKET_SINGULARITY: 3644045870,\r\n        CHAIN_LIGHTNING: 3644045868,\r\n      },\r\n      GRENADES: {\r\n        STORM: 4241856103,\r\n        HEALING: 3040080535,\r\n        COLDSNAP: 4265391440,\r\n        THREADLING: 3994381207,\r\n        VORTEX: 1048847436,\r\n      },\r\n      CLASS_ABILITIES: {\r\n        HEALING_RIFT: 1444664838,\r\n        EMPOWERING_RIFT: 1444664839,\r\n        PHOENIX_DIVE: 1444664836,\r\n      },\r\n      JUMPS: {\r\n        BURST_GLIDE: 1237488986,\r\n        STRAFE_GLIDE: 1237488987,\r\n        BALANCED_GLIDE: 1237488985,\r\n        BLINK: 1237488984,\r\n      },\r\n    },\r\n    FRAGMENTS: {\r\n      FACET_OF_DAWN: 2626922126,\r\n      FACET_OF_HOPE: 2626922122,\r\n      FACET_OF_PROTECTION: 2626922120,\r\n      FACET_OF_RUIN: 124726499,\r\n      FACET_OF_PURPOSE: 124726498,\r\n      FACET_OF_COURAGE: 2626922124,\r\n      FACET_OF_AWAKENING: 124726505,\r\n      FACET_OF_BALANCE: 2626922114,\r\n      FACET_OF_BRAVERY: 124726503,\r\n      FACET_OF_BLESSING: 124726496,\r\n      FACET_OF_COMMAND: 124726497,\r\n      FACET_OF_DEFIANCE: 74393640,\r\n      FACET_OF_DEVOTION: 2626922125,\r\n      FACET_OF_DOMINANCE: 124726504,\r\n      FACET_OF_GENEROSITY: 2626922127,\r\n      FACET_OF_GRACE: 2626922121,\r\n      FACET_OF_HONOR: 124726501,\r\n      FACET_OF_JUSTICE: 2626922115,\r\n      FACET_OF_MENDING: 124726500,\r\n      FACET_OF_SOLITUDE: 2626922123,\r\n      FACET_OF_SACRIFICE: 124726502,\r\n    },\r\n  },\r\n};\r\n\r\n// Common weapon perk hashes\r\nexport const WEAPON_PERKS = {\r\n  // Damage perks\r\n  RAMPAGE: 3425386926,\r\n  KILL_CLIP: 1015611457,\r\n  MULTIKILL_CLIP: 2458213969,\r\n  FRENZY: 4104185692,\r\n  SURROUNDED: 3708227201,\r\n  SWASHBUCKLER: 4082225868,\r\n  ONE_FOR_ALL: 4049631843,\r\n  ADRENALINE_JUNKIE: 11612903,\r\n  VORPAL_WEAPON: 1546637391,\r\n\r\n  // Reload perks\r\n  OUTLAW: 1168162263,\r\n  RAPID_HIT: 247725512,\r\n  FEEDING_FRENZY: 2779035018,\r\n  SUBSISTENCE: 1820235745,\r\n  FOURTH_TIMES_THE_CHARM: 1354429876,\r\n  TRIPLE_TAP: 3400784728,\r\n\r\n  // Utility perks\r\n  DEMOLITIONIST: 3523296417,\r\n  WELLSPRING: 3592538738,\r\n  OSMOSIS: 3477110138,\r\n  INCANDESCENT: 4293542123,\r\n  VOLTSHOT: 2731215423,\r\n  REPULSOR_BRACE: 776531651,\r\n  DESTABILIZING_ROUNDS: 1600092898,\r\n\r\n  // Origin perks\r\n  VEIST_STINGER: 2748801589,\r\n  HAKKE_BREACH_ARMAMENTS: 3851075243,\r\n  SUROS_SYNERGY: 4293542124,\r\n};\r\n\r\n// Map of Standard Subclass Aspects to their Prismatic Counterparts\r\n// Key = Standard Hash, Value = Prismatic Hash\r\nexport const PRISMATIC_ASPECT_MAPPING: Record<number, number> = {\r\n  // Warlock\r\n  262821317: 790664810, // Weaver's Call\r\n  1293395730: 790664812, // Lightning Surge\r\n  83039192: 790664814, // Hellion\r\n  2642597904: 790664813, // Bleak Watcher\r\n  2321824284: 790664815, // Feed the Void\r\n\r\n  // Titan\r\n  3866705246: 1262901522, // Diamond Lance\r\n  988980152: 1262901525, // Drengr's Lash\r\n  1602994571: 1262901521, // Unbreakable\r\n  2984351206: 1262901520, // Consecration\r\n  1656549674: 1262901523, // Knockout\r\n\r\n  // Hunter\r\n  4194622039: 2835214901, // Ascension\r\n  3066103996: 2835214903, // Gunpowder Gamble\r\n  2934767477: 2835214902, // Winter's Shroud\r\n  4249729125: 2835214897, // Threaded Specter\r\n  187655374: 2835214900, // Stylish Executioner\r\n};\r\n\r\n// Inverse Map: Prismatic -> Standard\r\n// Useful if we ever need to downgrade or check equivalence\r\nexport const STANDARD_ASPECT_MAPPING: Record<number, number> = Object.entries(PRISMATIC_ASPECT_MAPPING).reduce((acc, [std, prism]) => {\r\n  acc[prism] = Number(std);\r\n  return acc;\r\n}, {} as Record<number, number>);\r\n","import { useMemo } from 'react';\r\nimport { manifestService } from '../../services/bungie/manifest.service';\r\nimport { getBungieUrl } from '../../utils/url-helper';\r\nimport { isLegacyVersion } from '../../utils/season-utils';\r\nimport { TierBadge } from '../builder/TierBadge';\r\nimport './RichItemIcon.css';\r\n\r\ninterface RichItemIconProps {\r\n    hash: number;\r\n    instance?: any; // Partial instance data (power, state, etc)\r\n    onClick?: () => void;\r\n    onMouseEnter?: () => void;\r\n    onMouseLeave?: () => void;\r\n    className?: string;\r\n}\r\n\r\nexport function RichItemIcon({ hash, instance, onClick, onMouseEnter, onMouseLeave, className }: RichItemIconProps) {\r\n    const def = useMemo(() => manifestService.getItem(hash), [hash]);\r\n\r\n    if (!def) return <div className=\"rich-item-icon rich-item-icon--empty\" />;\r\n\r\n    const iconUrl = def.displayProperties?.icon ? getBungieUrl(def.displayProperties.icon) : '';\r\n    const tierType = def.inventory?.tierType || 0;\r\n    const tierClass = tierType === 6 ? 'exotic' : tierType === 5 ? 'legendary' : tierType === 4 ? 'rare' : 'common';\r\n\r\n    // API Banners\r\n    const secondarySpecialUrl = getBungieUrl(def.secondarySpecial);\r\n    const secondaryIconUrl = getBungieUrl(def.secondaryIcon);\r\n    const secondaryOverlayUrl = getBungieUrl(def.secondaryOverlay);\r\n\r\n    // Watermark\r\n    const standardWatermark = def.iconWatermark;\r\n    const featuredWatermark = def.iconWatermarkFeatured;\r\n    const isLegacyWatermark = (!featuredWatermark && !!standardWatermark) || isLegacyVersion(def.quality?.currentVersion);\r\n    const watermarkUrl = getBungieUrl(featuredWatermark || standardWatermark);\r\n\r\n    // States\r\n    const isMasterwork = !!(instance?.state && (instance.state & 4));\r\n    const isCrafted = !!(instance?.state && (instance.state & 8));\r\n    const isEnhanced = !!(isCrafted && instance?.gearTier && instance.gearTier >= 2);\r\n    const isWeapon = def.itemType === 3;\r\n\r\n    return (\r\n        <div\r\n            className={`rich-item-icon rich-item-icon--${tierClass} ${isMasterwork ? 'rich-item-icon--masterwork' : ''} ${className || ''}`}\r\n            onClick={onClick}\r\n            onMouseEnter={onMouseEnter}\r\n            onMouseLeave={onMouseLeave}\r\n        >\r\n            {/* Background Banners */}\r\n            {(secondaryIconUrl || secondarySpecialUrl || secondaryOverlayUrl) && (\r\n                <div className=\"rich-item-icon__banner\">\r\n                    {secondaryIconUrl && <img src={secondaryIconUrl} className=\"rich-item-icon__banner-layer\" alt=\"\" style={{ zIndex: 1 }} />}\r\n                    {secondarySpecialUrl && <img src={secondarySpecialUrl} className=\"rich-item-icon__banner-layer\" alt=\"\" style={{ zIndex: 2 }} />}\r\n                    {secondaryOverlayUrl && <img src={secondaryOverlayUrl} className=\"rich-item-icon__banner-layer\" alt=\"\" style={{ zIndex: 3 }} />}\r\n                </div>\r\n            )}\r\n\r\n            {/* Main Icon */}\r\n            <div className=\"rich-item-icon__main\">\r\n                <img src={iconUrl} alt={def.displayProperties?.name} className=\"rich-item-icon__img\" />\r\n\r\n                {/* Watermark */}\r\n                {watermarkUrl && (\r\n                    <img\r\n                        src={watermarkUrl}\r\n                        className={`rich-item-icon__watermark ${isLegacyWatermark ? 'rich-item-icon__watermark--legacy' : 'rich-item-icon__watermark--featured'}`}\r\n                        alt=\"\"\r\n                    />\r\n                )}\r\n\r\n                {/* Enhancement Stars */}\r\n                {((def.itemType === 3) || (def.itemType === 2 && tierType !== 6)) && (\r\n                    <TierBadge tier={instance?.gearTier || 0} />\r\n                )}\r\n\r\n                {/* Crafted/Enhanced Icons */}\r\n                {isWeapon && (isCrafted || isEnhanced) && (\r\n                    <div className=\"rich-item-icon__status\">\r\n                        {isCrafted && <img src={getBungieUrl('/img/destiny_content/items/crafted-icon-overlay.png')} alt=\"Crafted\" />}\r\n                        {isEnhanced && <img src={getBungieUrl('/img/destiny_content/items/enhanced-item-overlay.png')} alt=\"Enhanced\" />}\r\n                    </div>\r\n                )}\r\n            </div>\r\n\r\n            {/* Power Level */}\r\n            {instance?.power > 0 && (\r\n                <div className=\"rich-item-icon__power\">\r\n                    <span className=\"rich-item-icon__power-value\">{instance.power}</span>\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n","import { manifestService } from '../services/bungie/manifest.service';\r\nimport type { LoadoutShareData } from '../services/bungie/loadout-link.service';\r\n\r\nexport interface ModGroups {\r\n    helmet: number[];\r\n    arms: number[];\r\n    chest: number[];\r\n    legs: number[];\r\n    classItem: number[];\r\n    general: number[];\r\n}\r\n\r\nexport interface ArmorCosmetic {\r\n    shader?: number;\r\n    ornament?: number;\r\n}\r\n\r\nexport interface ArmorCosmetics {\r\n    helmet: ArmorCosmetic;\r\n    arms: ArmorCosmetic;\r\n    chest: ArmorCosmetic;\r\n    legs: ArmorCosmetic;\r\n    classItem: ArmorCosmetic;\r\n    general: ArmorCosmetic;\r\n}\r\n\r\nconst BUCKET_TO_SLOT: Record<number, keyof ModGroups> = {\r\n    3448274439: 'helmet',\r\n    3551918588: 'arms',\r\n    14239492: 'chest',\r\n    20886954: 'legs',\r\n    1585787867: 'classItem'\r\n};\r\n\r\nexport interface CategorizedMods {\r\n    health: number[];\r\n    melee: number[];\r\n    grenade: number[];\r\n    super: number[];\r\n    class: number[];\r\n    weapon: number[];\r\n    other: number[];\r\n}\r\n\r\nexport const classifyMod = (hash: number) => {\r\n    const def = manifestService.getItem(hash) as any;\r\n    if (!def) return 'other';\r\n\r\n    const name = (def.displayProperties?.name || \"\").toLowerCase();\r\n    const plugCat = (def.plug?.plugCategoryIdentifier || \"\").toLowerCase();\r\n    const description = (def.displayProperties?.description || \"\").toLowerCase();\r\n    const typeName = (def.itemTypeDisplayName || \"\").toLowerCase();\r\n\r\n    // 1. Health/Survival (Resil, Recov, Orbs for Health, Damage Reduction)\r\n    if (name.includes(\"resilience\") || name.includes(\"recovery\") ||\r\n        name.includes(\"recuperation\") || name.includes(\"better already\") ||\r\n        name.includes(\"siphon\") || description.includes(\"orb of power\") ||\r\n        name.includes(\"resistance\") || plugCat.includes(\"resistance\") ||\r\n        name.includes(\"absolution\") || name.includes(\"better already\")) {\r\n        return \"health\";\r\n    }\r\n\r\n    // 2. Melee (Strength, Melee energy, Impact Induction)\r\n    if (name.includes(\"strength\") || name.includes(\"melee\") ||\r\n        name.includes(\"impact induction\") || name.includes(\"outreach\") ||\r\n        name.includes(\"heavy handed\") || name.includes(\"focusing strike\")) {\r\n        return \"melee\";\r\n    }\r\n\r\n    // 3. Grenade (Discipline, Grenade energy, Firepower, Bomber)\r\n    if (name.includes(\"discipline\") || name.includes(\"grenade\") ||\r\n        name.includes(\"firepower\") || name.includes(\"bomber\") ||\r\n        name.includes(\"bolstering detonation\") || name.includes(\"innervation\") ||\r\n        name.includes(\"momentum transfer\")) {\r\n        return \"grenade\";\r\n    }\r\n\r\n    // 4. Super (Intellect, Super energy, Ashes to Assets, Hands-on)\r\n    if (name.includes(\"intellect\") || name.includes(\"super\") ||\r\n        name.includes(\"ashes to assets\") || name.includes(\"hands-on\") ||\r\n        name.includes(\"dynamo\") || name.includes(\"font of wisdom\")) {\r\n        return \"super\";\r\n    }\r\n\r\n    // 5. Class Ability (Mobility, Class energy, Reaper, Utility Kickstart)\r\n    if (name.includes(\"mobility\") || name.includes(\"class\") ||\r\n        name.includes(\"utility\") || name.includes(\"reaper\") ||\r\n        name.includes(\"distribution\")) {\r\n        return \"class\";\r\n    }\r\n\r\n    // 6. Weapon Performance (Loaders, Dex, Scavenger, Holster, Surge, Targeting)\r\n    if (name.includes(\"loader\") || name.includes(\"dexterity\") ||\r\n        name.includes(\"scavenger\") || name.includes(\"holster\") ||\r\n        name.includes(\"surge\") || name.includes(\"targeting\") ||\r\n        name.includes(\"unflinching\") || typeName.includes(\"loader\") ||\r\n        typeName.includes(\"dexterity\") || name.includes(\"aim\") ||\r\n        name.includes(\"reload\") || name.includes(\"steady\") ||\r\n        name.includes(\"handling\")) {\r\n        return \"weapon\";\r\n    }\r\n\r\n    return \"other\";\r\n};\r\n\r\n/**\r\n * Categorizes and sorts armor mods for the fixed slot layout.\r\n * Returns:\r\n * - mainStat: +10/+5 stat mod\r\n * - secondaryStat: Artifice/Font/Stat combo mod\r\n * - others: Slot-specific and remaining mods\r\n */\r\nexport function categorizeMods(modHashes: number[]): {\r\n    mainStat: number | null;\r\n    secondaryStat: number | null;\r\n    others: number[];\r\n} {\r\n    let mainStat: number | null = null;\r\n    let secondaryStat: number | null = null;\r\n    const others: number[] = [];\r\n\r\n    // Use a Set to prevent duplicates from the input\r\n    const uniqueHashes = Array.from(new Set(modHashes));\r\n\r\n    uniqueHashes.forEach(hash => {\r\n        const def = manifestService.getItem(hash) as any;\r\n        if (!def) return;\r\n\r\n        const cat = (def.plug?.plugCategoryIdentifier || \"\").toLowerCase();\r\n        const name = (def.displayProperties?.name || \"\").toLowerCase();\r\n        const typeName = (def.itemTypeDisplayName || \"\").toLowerCase();\r\n\r\n        // STRICT COSMETIC FILTER: Do not allow any cosmetics in the gameplay mod list\r\n        const isCosmetic = cat.includes('shader') || cat.includes('appearance') || cat.includes('ornament') ||\r\n            cat.includes('skins') || typeName.includes('shader') || typeName.includes('ornament');\r\n        if (isCosmetic) return;\r\n\r\n        // 1. Main Stat Mod (+10 / +5)\r\n        if (cat.includes('armor_stats') && !cat.includes('artifice')) {\r\n            if (!mainStat) mainStat = hash;\r\n            else others.push(hash);\r\n        }\r\n        // 2. Secondary Stat Mod (Artifice / Font / Combo)\r\n        else if (cat.includes('artifice') || name.includes('font of') || cat.includes('.stat.')) {\r\n            if (!secondaryStat) secondaryStat = hash;\r\n            else others.push(hash);\r\n        }\r\n        // 3. Others\r\n        else {\r\n            others.push(hash);\r\n        }\r\n    });\r\n\r\n    // Sort others by name for stability\r\n    others.sort((a, b) => {\r\n        const nameA = (manifestService.getItem(a) as any)?.displayProperties?.name?.toLowerCase() || \"\";\r\n        const nameB = (manifestService.getItem(b) as any)?.displayProperties?.name?.toLowerCase() || \"\";\r\n        return nameA.localeCompare(nameB);\r\n    });\r\n\r\n    return { mainStat, secondaryStat, others };\r\n}\r\n\r\n/**\r\n * Distributes mods from a loadout across armor pieces AND categorizes them by theme\r\n * Extracted from LoadoutDisplay.tsx to be reusable\r\n */\r\nexport function distributeLoadoutMods(\r\n    loadout: LoadoutShareData,\r\n    armor: Record<string, any>\r\n): { modGroups: ModGroups; armorCosmetics: ArmorCosmetics; themedMods: CategorizedMods } {\r\n    const armorCosmetics: ArmorCosmetics = {\r\n        helmet: {},\r\n        arms: {},\r\n        chest: {},\r\n        legs: {},\r\n        classItem: {},\r\n        general: {}\r\n    };\r\n\r\n    const modGroups: ModGroups = {\r\n        helmet: [],\r\n        arms: [],\r\n        chest: [],\r\n        legs: [],\r\n        classItem: [],\r\n        general: []\r\n    };\r\n\r\n    const themedMods: CategorizedMods = {\r\n        health: [],\r\n        melee: [],\r\n        grenade: [],\r\n        super: [],\r\n        class: [],\r\n        weapon: [],\r\n        other: []\r\n    };\r\n\r\n    // Track how many of each mod we've assigned vs how many we need\r\n    const goalCounts = new Map<number, number>();\r\n    if (loadout.parameters?.mods) {\r\n        loadout.parameters.mods.forEach(h => goalCounts.set(h, (goalCounts.get(h) || 0) + 1));\r\n    }\r\n\r\n    const currentCounts = new Map<number, number>();\r\n\r\n    // Track occupancy to balance general mods\r\n    const slotOccupancy: Record<string, number> = {\r\n        helmet: 0,\r\n        arms: 0,\r\n        chest: 0,\r\n        legs: 0,\r\n        classItem: 0\r\n    };\r\n\r\n    const trackMod = (hash: number, slot: string, socketIndex?: number) => {\r\n        currentCounts.set(hash, (currentCounts.get(hash) || 0) + 1);\r\n        const def = manifestService.getItem(hash) as any;\r\n        const plugCat = (def?.plug?.plugCategoryIdentifier || '').toLowerCase();\r\n        const typeName = (def?.itemTypeDisplayName || '').toLowerCase();\r\n\r\n        const isShader = plugCat.includes('shader') || typeName.includes('shader') || socketIndex === 5;\r\n        const isOrnament = plugCat.includes('ornament') || plugCat.includes('appearance') || plugCat.includes('skins') || typeName.includes('ornament') || socketIndex === 6;\r\n\r\n        const isGameplayMod =\r\n            plugCat.includes('enhancements') ||\r\n            plugCat.includes('armor_stats') ||\r\n            plugCat.includes('armor_mods');\r\n\r\n        const isSubclassItem =\r\n            plugCat.includes('fragments') ||\r\n            plugCat.includes('aspects') ||\r\n            plugCat.includes('abilities') ||\r\n            plugCat.includes('supers') ||\r\n            plugCat.includes('plugs.subclass') ||\r\n            typeName.includes('fragment') ||\r\n            typeName.includes('aspect') ||\r\n            def?.itemCategoryHashes?.includes(1313488945) ||\r\n            def?.itemCategoryHashes?.includes(764703411);\r\n\r\n        if (isSubclassItem) return;\r\n\r\n        if ((isShader || isOrnament) && !isGameplayMod) {\r\n            const cosmetic = (armorCosmetics as any)[slot];\r\n            if (cosmetic) {\r\n                if (isShader) cosmetic.shader = hash;\r\n                else if (isOrnament) cosmetic.ornament = hash;\r\n            }\r\n        } else {\r\n            (modGroups as any)[slot]?.push(hash);\r\n            if (slotOccupancy[slot] !== undefined) {\r\n                slotOccupancy[slot]++;\r\n            }\r\n            // Add to themed classification\r\n            const theme = classifyMod(hash);\r\n            themedMods[theme as keyof CategorizedMods].push(hash);\r\n        }\r\n    };\r\n\r\n    // Step 0: Identify General/Artifice mods that should be balanced\r\n    const isModBalanced = (hash: number) => {\r\n        const def = manifestService.getItem(hash) as any;\r\n        if (!def) return true;\r\n        const plugCat = (def.plug?.plugCategoryIdentifier || \"\").toLowerCase();\r\n        const typeName = (def.itemTypeDisplayName || \"\").toLowerCase();\r\n        const name = (def.displayProperties?.name || def?.name || '').toLowerCase();\r\n\r\n        // Cosmetics (Shaders/Ornaments) should NEVER be balanced, they belong to the item\r\n        if (plugCat.includes('shader') || plugCat.includes('appearance') || plugCat.includes('ornament') ||\r\n            plugCat.includes('skins') || typeName.includes('shader') || typeName.includes('ornament')) {\r\n            return false;\r\n        }\r\n\r\n        // Stat mods and Artifice mods are always candidates for balancing\r\n        if (plugCat.includes('armor_stats') || plugCat.includes('artifice') ||\r\n            name.includes('resilience') || name.includes('recovery') ||\r\n            name.includes('discipline') || name.includes('strength') ||\r\n            name.includes('intellect') || name.includes('mobility') ||\r\n            name === 'melee mod' || name === 'armor charge mod' ||\r\n            name.includes('/ -') || name.includes('+class')) {\r\n            return true;\r\n        }\r\n\r\n        // Seasonal mods/Artifact mods are often general too\r\n        if (plugCat.includes('seasonal') || plugCat.includes('artifact')) return true;\r\n\r\n        // If it specifically targets a slot, keep it there\r\n        if (plugCat.includes('head') || plugCat.includes('helmet') ||\r\n            plugCat.includes('arms') || plugCat.includes('gauntlets') ||\r\n            plugCat.includes('chest') || plugCat.includes('plate') || plugCat.includes('vest') ||\r\n            plugCat.includes('legs') || plugCat.includes('boots') ||\r\n            plugCat.includes('class') || plugCat.includes('cloak') || plugCat.includes('bond') || plugCat.includes('mark')) {\r\n            return false;\r\n        }\r\n\r\n        return false; // Default to specific if unsure (better to stay on item than float away)\r\n    };\r\n\r\n    const pendingBalanceMods: number[] = [];\r\n\r\n    // Step 1: Process socketOverrides from armor items\r\n    Object.entries(armor).forEach(([slot, item]) => {\r\n        if (item && item.socketOverrides) {\r\n            Object.entries(item.socketOverrides).forEach(([idxStr, hash]) => {\r\n                const modHash = Number(hash);\r\n                const idx = parseInt(idxStr);\r\n                if (modHash && modHash !== 3696633656) {\r\n                    const def = manifestService.getItem(modHash);\r\n                    if (def && (def.itemType === 1 || def.itemType === 19 || def.itemType === 24 || def.itemType === 11 || def.plug?.plugCategoryIdentifier)) {\r\n                        if (isModBalanced(modHash)) {\r\n                            pendingBalanceMods.push(modHash);\r\n                            // We don't track it yet, we just note we have it\r\n                            currentCounts.set(modHash, (currentCounts.get(modHash) || 0) + 1);\r\n                        } else {\r\n                            trackMod(modHash, slot, idx);\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    });\r\n\r\n    // Step 2: Process modsByBucket\r\n    if (loadout.parameters?.modsByBucket) {\r\n        for (const [bucketStr, mods] of Object.entries(loadout.parameters.modsByBucket)) {\r\n            const bucketHash = parseInt(bucketStr);\r\n            const slot = BUCKET_TO_SLOT[bucketHash];\r\n            if (Array.isArray(mods)) {\r\n                mods.forEach(hash => {\r\n                    if (isModBalanced(hash)) {\r\n                        pendingBalanceMods.push(hash);\r\n                        currentCounts.set(hash, (currentCounts.get(hash) || 0) + 1);\r\n                    } else {\r\n                        trackMod(hash, slot || 'general');\r\n                    }\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    // Step 2.5: Distribute collected \"Balanceable\" mods\r\n    const armorSlots = ['helmet', 'arms', 'chest', 'legs', 'classItem'];\r\n    pendingBalanceMods.forEach(hash => {\r\n        // Find least occupied slot that has an armor piece\r\n        let bestSlot = 'general';\r\n        let minMods = Infinity;\r\n\r\n        for (const slotName of armorSlots) {\r\n            if (!armor[slotName]) continue;\r\n\r\n            // Check occupancy\r\n            if (slotOccupancy[slotName] < minMods) {\r\n                minMods = slotOccupancy[slotName];\r\n                bestSlot = slotName;\r\n            }\r\n        }\r\n\r\n        // Actually track it to the best slot (ignoring the 'id' part of trackMod to avoid double currentCounts)\r\n        (modGroups as any)[bestSlot]?.push(hash);\r\n        if (slotOccupancy[bestSlot] !== undefined) slotOccupancy[bestSlot]++;\r\n        const theme = classifyMod(hash);\r\n        themedMods[theme as keyof CategorizedMods].push(hash);\r\n    });\r\n\r\n    // Step 3: Distribute remaining mods from the goal list (from loadout.parameters.mods)\r\n    goalCounts.forEach((goal, hash) => {\r\n        const current = currentCounts.get(hash) || 0;\r\n        const remaining = goal - current;\r\n\r\n        if (remaining <= 0) return;\r\n\r\n        const def = manifestService.getItem(hash) as any;\r\n        if (!def) {\r\n            for (let i = 0; i < remaining; i++) trackMod(hash, 'general');\r\n            return;\r\n        }\r\n\r\n        let targetSlot = 'general';\r\n        if (!isModBalanced(hash)) {\r\n            const plugCat = (def.plug?.plugCategoryIdentifier || '').toLowerCase();\r\n            if (plugCat.includes('head') || plugCat.includes('helmet')) targetSlot = 'helmet';\r\n            else if (plugCat.includes('arms') || plugCat.includes('gauntlets')) targetSlot = 'arms';\r\n            else if (plugCat.includes('chest') || plugCat.includes('plate') || plugCat.includes('vest')) targetSlot = 'chest';\r\n            else if (plugCat.includes('legs') || plugCat.includes('boots')) targetSlot = 'legs';\r\n            else if (plugCat.includes('class') || plugCat.includes('cloak') || plugCat.includes('bond')) targetSlot = 'classItem';\r\n        }\r\n\r\n        if (targetSlot !== 'general') {\r\n            for (let i = 0; i < remaining; i++) trackMod(hash, targetSlot);\r\n        } else {\r\n            for (let i = 0; i < remaining; i++) {\r\n                let bestSlot = 'general';\r\n                let minMods = Infinity;\r\n\r\n                for (const slotName of armorSlots) {\r\n                    if (!armor[slotName]) continue;\r\n                    if (slotOccupancy[slotName] < minMods) {\r\n                        minMods = slotOccupancy[slotName];\r\n                        bestSlot = slotName;\r\n                    }\r\n                }\r\n                trackMod(hash, bestSlot);\r\n            }\r\n        }\r\n    });\r\n\r\n    return { modGroups, armorCosmetics, themedMods };\r\n}\r\n","// import { debugLog, warnLog, errorLog } from '../../utils/logger';\r\nimport { manifestService } from './manifest.service';\r\nimport { transferService, createMoveSession } from './transfer.service';\r\nimport { useProfileStore, useToastStore } from '../../store';\r\nimport type { DestinyItem, BuildTemplate } from '../../types';\r\nimport { SOCKET_CATEGORY_HASHES, BUCKET_HASHES } from '../../config/bungie.config';\r\nimport { syncManager } from './sync-manager.service';\r\nimport pako from 'pako';\r\n\r\n/**\r\n * DIM-Compatible Loadout Structure\r\n * Based on DIM's API loadout format for maximum compatibility\r\n */\r\nexport interface LoadoutShareData {\r\n    id: string;\r\n    name: string;\r\n    classType: 0 | 1 | 2; // Titan, Hunter, Warlock\r\n    equipped: LoadoutItem[];\r\n    unequipped?: LoadoutItem[];\r\n    parameters?: {\r\n        mods?: number[];\r\n        modsByBucket?: {\r\n            [bucketHash: number]: number[];\r\n        };\r\n        query?: string;\r\n        exoticArmorHash?: number;\r\n        statConstraints?: {\r\n            statHash: number;\r\n            minTier?: number;\r\n            maxTier?: number;\r\n            ignored?: boolean;\r\n        }[];\r\n        // Support both old format (artifactPerks) and new DIM API format (artifactUnlocks)\r\n        artifactPerks?: number[];\r\n        artifactUnlocks?: {\r\n            unlockedItemHashes: number[] | string; // DIM API returns string, we normalize to array\r\n            seasonNumber: number;\r\n        };\r\n    };\r\n    notes?: string;\r\n    source?: 'dim' | 'exoengine';\r\n}\r\n\r\nexport interface LoadoutItem {\r\n    id?: string;        // Item instance ID\r\n    hash: number;      // Item hash\r\n    amount?: number;\r\n    socketOverrides?: {\r\n        [socketIndex: number]: number; // Plug hash\r\n    };\r\n    equip?: boolean;\r\n    craftedDate?: number;\r\n}\r\n\r\n// Store last raw response for debugging\r\nlet lastRawResponse: any = null;\r\n\r\nexport function getLastDebugRaw(): string {\r\n    return JSON.stringify(lastRawResponse, null, 2);\r\n}\r\n\r\n// DIM's empty socket placeholder hash\r\nconst DIM_EMPTY_SOCKET_HASH = 4287799666;\r\n\r\n/**\r\n * Parse DIM's flat mods array into modsByBucket structure\r\n * DIM uses a separator hash (4287799666) to divide mods between armor pieces\r\n * Format: [helmet mods...], 4287799666, [gauntlet mods...], 4287799666, etc.\r\n * Order: Helmet, Gauntlets, Chest, Legs, Class Item\r\n */\r\nfunction parseModsArrayToModsByBucket(\r\n    modsArray: number[]\r\n): { [bucketHash: number]: number[] } {\r\n    const modsByBucket: { [bucketHash: number]: number[] } = {};\r\n\r\n    // Split the flat array by separator\r\n    const bucketGroups: number[][] = [];\r\n    let currentGroup: number[] = [];\r\n    let foundSeparator = false;\r\n\r\n    for (const modHash of modsArray) {\r\n        if (modHash === DIM_EMPTY_SOCKET_HASH) {\r\n            foundSeparator = true;\r\n            if (currentGroup.length > 0) {\r\n                bucketGroups.push([...currentGroup]);\r\n                currentGroup = [];\r\n            }\r\n        } else {\r\n            currentGroup.push(modHash);\r\n        }\r\n    }\r\n\r\n    // Don't forget the last group\r\n    if (currentGroup.length > 0) {\r\n        bucketGroups.push([...currentGroup]);\r\n    }\r\n\r\n    // If no separators found, we don't know the buckets. \r\n    // Return empty so the viewer can distribute them balanced.\r\n    if (!foundSeparator && bucketGroups.length <= 1) {\r\n        return {};\r\n    }\r\n\r\n    // Map groups to bucket hashes in order: Helmet, Gauntlets, Chest, Legs, Class Item\r\n    const armorBuckets = [\r\n        BUCKET_HASHES.HELMET,\r\n        BUCKET_HASHES.GAUNTLETS,\r\n        BUCKET_HASHES.CHEST_ARMOR,\r\n        BUCKET_HASHES.LEG_ARMOR,\r\n        BUCKET_HASHES.CLASS_ARMOR,\r\n    ];\r\n\r\n    // Assign each group to its corresponding bucket\r\n    for (let i = 0; i < bucketGroups.length && i < armorBuckets.length; i++) {\r\n        const bucketHash = armorBuckets[i];\r\n        const mods = bucketGroups[i];\r\n\r\n        if (mods.length > 0) {\r\n            modsByBucket[bucketHash] = mods;\r\n        }\r\n    }\r\n\r\n\r\n    return modsByBucket;\r\n}\r\n\r\n/**\r\n * Parse a loadout link (DIM API or ExoEngine format)\r\n * - DIM API links: https://dim.gg/[shareId]/[slug] - fetches from DIM's server\r\n * - ExoEngine links: https://exoengine.online/loadout/[base64] - client-side decode\r\n */\r\nexport async function parseLoadoutLink(url: string): Promise<LoadoutShareData | null> {\r\n    try {\r\n\r\n        // Check if it's a DIM query parameter format (e.g., ?loadout={json})\r\n        // This format is used by both DIM import URLs and ExoEngine's DIM-compatible links\r\n        const loadoutParamMatch = url.match(/[?&]loadout=([^&]+)/);\r\n        if (loadoutParamMatch) {\r\n            const encodedJson = loadoutParamMatch[1];\r\n            const json = decodeURIComponent(encodedJson);\r\n\r\n            const loadout = JSON.parse(json) as LoadoutShareData;\r\n\r\n            // Validate structure\r\n            if (!loadout.name || loadout.classType === undefined || !loadout.equipped) {\r\n                throw new Error('Loadout data is missing required fields');\r\n            }\r\n\r\n            // Parse flat mods array if present\r\n            if (loadout.parameters?.mods && loadout.parameters.mods.length > 0) {\r\n                const parsedMods = parseModsArrayToModsByBucket(loadout.parameters.mods);\r\n                if (!loadout.parameters.modsByBucket) {\r\n                    loadout.parameters.modsByBucket = parsedMods;\r\n                } else {\r\n                    for (const [bucketHash, mods] of Object.entries(parsedMods)) {\r\n                        const bucket = parseInt(bucketHash);\r\n                        const existing = loadout.parameters.modsByBucket[bucket] || [];\r\n                        loadout.parameters.modsByBucket[bucket] = [...existing, ...mods];\r\n                    }\r\n                }\r\n            }\r\n\r\n            return loadout;\r\n        }\r\n\r\n        // Check if it's a DIM profile page link (not a loadout share link)\r\n        // These links don't contain loadout data, they're just navigation URLs\r\n        const profilePageMatch = url.match(/destinyitemmanager\\.com\\/\\d+\\/d2\\/(loadouts|inventory|progress|records|optimizer|collections)/i);\r\n        if (profilePageMatch) {\r\n            throw new Error(\r\n                'This is a DIM profile page link, not a loadout share link. ' +\r\n                'To share a loadout from DIM:\\n' +\r\n                '1. Open DIM and go to your Loadouts page\\n' +\r\n                '2. Click on a loadout\\n' +\r\n                '3. Click the Share button to get a dim.gg share link\\n' +\r\n                'Or paste a DIM loadout URL with ?loadout= parameter.'\r\n            );\r\n        }\r\n\r\n        // Check if it's a DIM API share link (e.g., https://dim.gg/otjycrq/Unluckvj-Melee)\r\n        const dimApiMatch = url.match(/dim\\.gg\\/([a-z0-9]+)/i);\r\n        if (dimApiMatch) {\r\n            const shareId = dimApiMatch[1];\r\n            console.log('[LoadoutLink] Fetching DIM loadout:', shareId);\r\n\r\n            // Fetch from DIM's public API using our own server-side proxy\r\n            // This bypasses CORS and public proxy restrictions\r\n            const proxyUrl = `/dim-proxy.php?shareId=${shareId}`;\r\n\r\n            console.log('[LoadoutLink] Fetching from DIM API via Proxy:', shareId);\r\n            const response = await fetch(proxyUrl);\r\n\r\n            if (!response.ok) {\r\n                // Try to get error details from response body\r\n                const errorText = await response.text();\r\n                console.error('[LoadoutLink] Proxy Error Response:', errorText);\r\n                throw new Error(`Failed to fetch loadout from DIM (Status: ${response.status}).`);\r\n            }\r\n\r\n            const responseText = await response.text();\r\n            let data;\r\n            try {\r\n                data = JSON.parse(responseText);\r\n            } catch (e) {\r\n                console.error('[LoadoutLink] Failed to parse JSON. Raw response:', responseText);\r\n                throw new Error('DIM Proxy returned an invalid response. See console for details.');\r\n            }\r\n\r\n            lastRawResponse = data; // Store for debugging\r\n            console.log('[LoadoutLink] RAW DIM RESPONSE:', JSON.stringify(data, null, 2));\r\n\r\n            if (!data.loadout) {\r\n                throw new Error('No loadout data received from DIM');\r\n            }\r\n\r\n            // Parse the flat mods array into modsByBucket\r\n            const loadout = data.loadout as LoadoutShareData;\r\n            if (loadout.parameters?.mods && loadout.parameters.mods.length > 0) {\r\n                const parsedMods = parseModsArrayToModsByBucket(loadout.parameters.mods);\r\n\r\n                // Merge parsed mods with existing modsByBucket\r\n                if (!loadout.parameters.modsByBucket) {\r\n                    loadout.parameters.modsByBucket = parsedMods;\r\n                } else {\r\n                    for (const [bucketHash, mods] of Object.entries(parsedMods)) {\r\n                        const bucket = parseInt(bucketHash);\r\n                        const existing = loadout.parameters.modsByBucket[bucket] || [];\r\n                        loadout.parameters.modsByBucket[bucket] = [...existing, ...mods];\r\n                    }\r\n                }\r\n\r\n                console.log('[LoadoutLink] Parsed mods array into modsByBucket:', loadout.parameters.modsByBucket);\r\n            }\r\n\r\n            console.log('[LoadoutLink] Successfully fetched DIM loadout:', data.loadout.name);\r\n            return loadout;\r\n        }\r\n\r\n        // Extract base64 data from URL (ExoEngine format)\r\n        // Supports: https://exoengine.online/loadout/[data]\r\n        //           /loadout/[data]\r\n        const match = url.match(/\\/loadout\\/([A-Za-z0-9+/=_-]+)/);\r\n        if (!match) {\r\n            if (url.includes('loadout/')) {\r\n                throw new Error('Invalid loadout link format. Please paste a DIM share link or ExoEngine loadout link.');\r\n            }\r\n            throw new Error('Not a recognizable loadout link. Please verify the URL.');\r\n        }\r\n\r\n        // Decode base64 (handle URL-safe base64)\r\n        const base64 = match[1].replace(/-/g, '+').replace(/_/g, '/');\r\n        const binaryString = atob(base64);\r\n\r\n        // Convert binary string to Uint8Array\r\n        const bytes = new Uint8Array(binaryString.length);\r\n        for (let i = 0; i < binaryString.length; i++) {\r\n            bytes[i] = binaryString.charCodeAt(i);\r\n        }\r\n\r\n        // Detect compression type and decompress\r\n        let decoded: string;\r\n\r\n        // Check for gzip header (0x1f 0x8b)\r\n        if (bytes[0] === 0x1f && bytes[1] === 0x8b) {\r\n            // Decompress gzipped data\r\n            const decompressed = pako.ungzip(bytes, { to: 'string' });\r\n            decoded = decompressed;\r\n        }\r\n        // Check for zlib/deflate header (0x78)\r\n        else if (bytes[0] === 0x78) {\r\n            // Decompress deflate data\r\n            const decompressed = pako.inflate(bytes, { to: 'string' });\r\n            decoded = decompressed;\r\n        }\r\n        else {\r\n            // Try to decompress as deflate anyway (raw deflate without headers)\r\n            try {\r\n                const decompressed = pako.inflateRaw(bytes, { to: 'string' });\r\n                decoded = decompressed;\r\n            } catch (e) {\r\n                // Plain base64 (uncompressed)\r\n                decoded = binaryString;\r\n            }\r\n        }\r\n\r\n        // Trim trailing null bytes but keep internal \\x00 markers\r\n        const trimmed = decoded.replace(/\\0+$/, '');\r\n\r\n        let loadout: LoadoutShareData;\r\n\r\n        // Check if it's the new binary format (contains \\x00 name separator)\r\n        if (trimmed.includes('\\x00') && !trimmed.startsWith('[') && !trimmed.startsWith('{')) {\r\n            // Binary format: name\\0classType|hash1,idx:plug|hash2|...\r\n            const nullIdx = trimmed.indexOf('\\x00');\r\n            const name = trimmed.substring(0, nullIdx);\r\n            const classType = trimmed.charCodeAt(nullIdx + 1);\r\n\r\n            // Find parameters marker if exists\r\n            const paramMarkerIdx = trimmed.indexOf('\\x01', nullIdx + 2);\r\n            const itemsSection = paramMarkerIdx > 0\r\n                ? trimmed.substring(nullIdx + 2, paramMarkerIdx)\r\n                : trimmed.substring(nullIdx + 2);\r\n\r\n            // Parse items\r\n            const itemParts = itemsSection.split('|').filter(p => p);\r\n            const equipped = itemParts.map(itemStr => {\r\n                const parts = itemStr.split(',');\r\n                const hash = parseInt(parts[0], 36); // Base36 decode\r\n                const socketOverrides: Record<number, number> = {};\r\n\r\n                // Parse socket overrides\r\n                for (let i = 1; i < parts.length; i++) {\r\n                    const [idxStr, plugStr] = parts[i].split(':');\r\n                    if (idxStr && plugStr) {\r\n                        socketOverrides[parseInt(idxStr, 36)] = parseInt(plugStr, 36);\r\n                    }\r\n                }\r\n\r\n                return { hash, socketOverrides };\r\n            });\r\n\r\n            // Parse parameters if they exist\r\n            let parameters: any = undefined;\r\n            if (paramMarkerIdx > 0) {\r\n                const paramSection = trimmed.substring(paramMarkerIdx + 1);\r\n                parameters = {\r\n                    mods: [],\r\n                    modsByBucket: {},\r\n                    exoticArmorHash: undefined\r\n                };\r\n\r\n                // Improved Parameter Parsing with Delimiters\r\n                const paramsMap: Record<string, string> = {};\r\n                const segments = paramSection.split(';');\r\n                segments.forEach(seg => {\r\n                    if (seg.includes(':')) {\r\n                        const parts = seg.split(':');\r\n                        const key = parts[0];\r\n                        const val = parts.slice(1).join(':'); // Handle values containing colons\r\n                        if (key && val) paramsMap[key] = val;\r\n                    }\r\n                });\r\n\r\n                // Decode General Mods\r\n                if (paramsMap.m) {\r\n                    parameters.mods = paramsMap.m.split(',').map(h => parseInt(h, 36));\r\n                }\r\n\r\n                // Decode Mods By Bucket\r\n                if (paramsMap.b) {\r\n                    const groups = paramsMap.b.split('|');\r\n                    groups.forEach(group => {\r\n                        const parts = group.split(':');\r\n                        if (parts.length === 2) {\r\n                            const bucketHash = parseInt(parts[0], 36);\r\n                            const mods = parts[1].split(',').map(h => parseInt(h, 36));\r\n                            parameters.modsByBucket[bucketHash] = mods;\r\n                        }\r\n                    });\r\n                }\r\n\r\n                // Decode Exotic Armor Hash\r\n                if (paramsMap.e) {\r\n                    parameters.exoticArmorHash = parseInt(paramsMap.e, 36);\r\n                }\r\n\r\n                // Decode Artifact Perks\r\n                if (paramsMap.a) {\r\n                    parameters.artifactPerks = paramsMap.a.split(',').map(h => parseInt(h, 36));\r\n                }\r\n            }\r\n\r\n            loadout = {\r\n                id: `imported-${Date.now()}`,\r\n                name,\r\n                classType: classType as 0 | 1 | 2,\r\n                equipped,\r\n                parameters,\r\n                source: 'exoengine'\r\n            };\r\n        } else {\r\n            // Internal formats or DIM JSON fallback\r\n            const parsed = JSON.parse(trimmed);\r\n\r\n            // Check if it's the hyper-minimal flat array format\r\n            if (Array.isArray(parsed) && typeof parsed[0] === 'string' && typeof parsed[1] === 'number') {\r\n                // Hyper-minimal format: [name, classType, ...items, null?, ...params]\r\n                const name = parsed[0];\r\n                const classType = parsed[1];\r\n\r\n                // Find null marker (if exists) which separates items from params\r\n                let nullIndex = parsed.indexOf(null, 2);\r\n                if (nullIndex === -1) nullIndex = parsed.length;\r\n\r\n                // Extract items (from index 2 to null or end)\r\n                const itemsData = parsed.slice(2, nullIndex);\r\n                const equipped = itemsData.map((item: any) => {\r\n                    if (typeof item === 'number') {\r\n                        return { hash: item, socketOverrides: {} };\r\n                    } else if (Array.isArray(item)) {\r\n                        const hash = item[0];\r\n                        const socketOverrides: Record<number, number> = {};\r\n                        // Remaining items are socket pairs [idx, hash, idx, hash, ...]\r\n                        for (let i = 1; i < item.length; i += 2) {\r\n                            socketOverrides[item[i]] = item[i + 1];\r\n                        }\r\n                        return { hash, socketOverrides };\r\n                    }\r\n                    return { hash: item, socketOverrides: {} };\r\n                });\r\n\r\n                // Extract parameters if they exist after null marker\r\n                let parameters: any = undefined;\r\n                if (nullIndex < parsed.length - 1) {\r\n                    const paramsData = parsed.slice(nullIndex + 1);\r\n                    parameters = {\r\n                        mods: Array.isArray(paramsData[0]) ? paramsData[0] : [],\r\n                        modsByBucket: typeof paramsData[1] === 'object' && !Array.isArray(paramsData[1]) ? paramsData[1] : {},\r\n                        exoticArmorHash: typeof paramsData[2] === 'number' ? paramsData[2] : undefined,\r\n                        artifactPerks: Array.isArray(paramsData[3]) ? paramsData[3] : []\r\n                    };\r\n                }\r\n\r\n                loadout = {\r\n                    id: `imported-${Date.now()}`,\r\n                    name,\r\n                    classType: classType as 0 | 1 | 2,\r\n                    equipped,\r\n                    parameters\r\n                };\r\n            } else if (Array.isArray(parsed) && parsed.length >= 3 && !parsed[0].hasOwnProperty('length')) {\r\n                // Old ultra-minimal format: [name, classType, [equipped]]\r\n                loadout = {\r\n                    id: `imported-${Date.now()}`,\r\n                    name: parsed[0],\r\n                    classType: parsed[1] as 0 | 1 | 2,\r\n                    equipped: parsed[2].map((item: any) => {\r\n                        if (Array.isArray(item)) {\r\n                            const hash = item[0];\r\n                            const socketArray = item[1];\r\n                            const socketOverrides: Record<number, number> = {};\r\n\r\n                            if (socketArray) {\r\n                                for (let i = 0; i < socketArray.length; i += 2) {\r\n                                    socketOverrides[socketArray[i]] = socketArray[i + 1];\r\n                                }\r\n                            }\r\n\r\n                            return { hash, socketOverrides: Object.keys(socketOverrides).length > 0 ? socketOverrides : {} };\r\n                        }\r\n                        return { hash: item, socketOverrides: {} };\r\n                    }),\r\n                    parameters: parsed[3] ? {\r\n                        mods: parsed[3].m || [],\r\n                        modsByBucket: parsed[3].mb || {},\r\n                        exoticArmorHash: parsed[3].ea,\r\n                        artifactPerks: parsed[3].ap || []\r\n                    } : undefined\r\n                };\r\n            } else if (parsed.n !== undefined && parsed.c !== undefined && parsed.e !== undefined) {\r\n                // Old minimal format (object with short keys)\r\n                loadout = {\r\n                    id: `imported-${Date.now()}`,\r\n                    name: parsed.n,\r\n                    classType: parsed.c as 0 | 1 | 2,\r\n                    equipped: parsed.e.map((item: any) => ({\r\n                        hash: item.h,\r\n                        socketOverrides: item.s || {}\r\n                    })),\r\n                    parameters: parsed.p ? {\r\n                        mods: parsed.p.m || [],\r\n                        modsByBucket: parsed.p.mb || {},\r\n                        exoticArmorHash: parsed.p.ea,\r\n                        artifactPerks: parsed.p.ap || []\r\n                    } : undefined\r\n                };\r\n            } else {\r\n                // Original format (full object keys)\r\n                loadout = parsed as LoadoutShareData;\r\n            }\r\n        }\r\n\r\n        // Validate structure\r\n        if (!loadout.name || loadout.classType === undefined || !loadout.equipped) {\r\n            throw new Error('Loadout data is missing required fields');\r\n        }\r\n\r\n        // Set source fallback if not explicitly set\r\n        if (loadout && !loadout.source) {\r\n            loadout.source = 'dim';\r\n        }\r\n\r\n        return loadout;\r\n    } catch (error) {\r\n        if (error instanceof Error) {\r\n            throw error;\r\n        }\r\n        throw new Error('Failed to parse loadout link');\r\n    }\r\n}\r\n\r\n/**\r\n * Generate an ExoEngine loadout link (Synchronous)\r\n * Returns a full https://exoengine.online/loadout/[base64] URL\r\n */\r\nexport function generateExoEngineLink(loadout: LoadoutShareData): string {\r\n    try {\r\n        // Binary encoding for maximum compression\r\n        // Format: name\\0classType|hash1,idx:plug,idx:plug|hash2|...\r\n\r\n        let binary = '';\r\n\r\n        // Encode name (shortened to 20 chars max)\r\n        const shortName = loadout.name.substring(0, 20);\r\n        binary += shortName + '\\x00';\r\n\r\n        // Encode classType (single byte)\r\n        binary += String.fromCharCode(loadout.classType);\r\n\r\n        // Encode equipped items\r\n        loadout.equipped.forEach((item, i) => {\r\n            if (i > 0) binary += '|';\r\n            binary += item.hash.toString(36); // Base36 encoding for numbers\r\n\r\n            const sockets = item.socketOverrides;\r\n            if (sockets && Object.keys(sockets).length > 0) {\r\n                Object.entries(sockets).forEach(([idx, hash]) => {\r\n                    binary += ',' + parseInt(idx).toString(36) + ':' + (hash as number).toString(36);\r\n                });\r\n            }\r\n        });\r\n\r\n        // Encode parameters if they exist\r\n        if (loadout.parameters) {\r\n            const hasParams =\r\n                (loadout.parameters.mods && loadout.parameters.mods.length > 0) ||\r\n                (loadout.parameters.modsByBucket && Object.keys(loadout.parameters.modsByBucket).length > 0) ||\r\n                loadout.parameters.exoticArmorHash;\r\n\r\n            if (hasParams) {\r\n                binary += '\\x01'; // Parameters marker\r\n\r\n                // Encode parameters with clear delimiters\r\n                if (loadout.parameters.mods && loadout.parameters.mods.length > 0) {\r\n                    binary += `;m:${loadout.parameters.mods.map(m => m.toString(36)).join(',')}`;\r\n                }\r\n\r\n                if (loadout.parameters.modsByBucket && Object.keys(loadout.parameters.modsByBucket).length > 0) {\r\n                    const bucketStrings = Object.entries(loadout.parameters.modsByBucket)\r\n                        .map(([bucket, mods]) => {\r\n                            const bucketId = parseInt(bucket).toString(36);\r\n                            const modIds = (mods as number[]).map(m => m.toString(36)).join(',');\r\n                            return `${bucketId}:${modIds}`;\r\n                        });\r\n                    binary += `;b:${bucketStrings.join('|')}`;\r\n                }\r\n\r\n                if (loadout.parameters.exoticArmorHash) {\r\n                    binary += `;e:${loadout.parameters.exoticArmorHash.toString(36)}`;\r\n                }\r\n\r\n                if (loadout.parameters.artifactPerks && loadout.parameters.artifactPerks.length > 0) {\r\n                    binary += `;a:${loadout.parameters.artifactPerks.map(p => p.toString(36)).join(',')}`;\r\n                }\r\n            }\r\n        }\r\n\r\n        const encoder = new TextEncoder();\r\n        const data = encoder.encode(binary);\r\n\r\n        // Compress with maximum level\r\n        const compressed = pako.deflate(data, { level: 9, windowBits: 15 });\r\n\r\n        // Use base64url encoding\r\n        const base64 = btoa(String.fromCharCode(...compressed))\r\n            .replace(/\\+/g, '-')\r\n            .replace(/\\//g, '_')\r\n            .replace(/=/g, '');\r\n\r\n        const origin = typeof window !== 'undefined' ? window.location.origin : 'https://exoengine.online';\r\n        return `${origin}/loadout/${base64}`;\r\n    } catch (error) {\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Generate a DIM-compatible link\r\n * Uses the app.destinyitemmanager.com/loadouts?loadout= format\r\n */\r\nexport function generateDIMCompatibleLink(loadout: LoadoutShareData): string {\r\n    try {\r\n        const cleanLoadout = {\r\n            id: loadout.id,\r\n            name: loadout.name,\r\n            classType: loadout.classType,\r\n            equipped: loadout.equipped,\r\n            unequipped: loadout.unequipped || [],\r\n            parameters: loadout.parameters,\r\n            notes: loadout.notes,\r\n            destinyVersion: 2,\r\n            game: 'd2',\r\n            source: 'ExoEngine'\r\n        };\r\n\r\n        const json = JSON.stringify(cleanLoadout);\r\n        const encoded = encodeURIComponent(json);\r\n\r\n        return `https://app.destinyitemmanager.com/loadouts?loadout=${encoded}`;\r\n    } catch (error) {\r\n        throw error;\r\n    }\r\n}\r\n\r\n/**\r\n * Orchestrates the application of a loadout\r\n */\r\nexport async function applyLoadout(\r\n    loadout: LoadoutShareData,\r\n    characterId: string,\r\n    onProgress: (step: string, progress: number) => void\r\n): Promise<{ success: boolean; error?: string }> {\r\n    try {\r\n        onProgress('Analyzing inventory...', 10);\r\n\r\n        // 1. Find items in profile inventory\r\n        const state = useProfileStore.getState();\r\n        const allItems = [\r\n            ...state.vaultInventory,\r\n            ...Object.values(state.characterInventories as Record<string, DestinyItem[]>).flat(),\r\n            ...Object.values(state.characterEquipment as Record<string, DestinyItem[]>).flat()\r\n        ];\r\n\r\n        const itemsToMove: { instanceId: string; hash: number; currentOwner: string }[] = [];\r\n        const missingItems: string[] = [];\r\n        const itemsToEquip: DestinyItem[] = [];\r\n\r\n        for (const itemRef of loadout.equipped) {\r\n            const def = manifestService.getItem(itemRef.hash);\r\n            const foundItem = allItems.find(i => i.itemHash === itemRef.hash);\r\n\r\n            if (foundItem && foundItem.itemInstanceId) {\r\n                itemsToEquip.push(foundItem);\r\n\r\n                // Determine current owner\r\n                let currentOwner = 'vault';\r\n                if (state.vaultInventory.find(i => i.itemInstanceId === foundItem.itemInstanceId)) {\r\n                    currentOwner = 'vault';\r\n                } else {\r\n                    for (const [charId, inv] of Object.entries(state.characterInventories as Record<string, DestinyItem[]>)) {\r\n                        if (inv.find(i => i.itemInstanceId === foundItem.itemInstanceId)) currentOwner = charId;\r\n                    }\r\n                    for (const [charId, eq] of Object.entries(state.characterEquipment as Record<string, DestinyItem[]>)) {\r\n                        if (eq.find(i => i.itemInstanceId === foundItem.itemInstanceId)) currentOwner = charId;\r\n                    }\r\n                }\r\n\r\n                itemsToMove.push({\r\n                    instanceId: foundItem.itemInstanceId,\r\n                    hash: itemRef.hash,\r\n                    currentOwner\r\n                });\r\n            } else if (def && def.itemType !== 16) { // Ignore Subclass (handled separately)\r\n                missingItems.push(def.name);\r\n            }\r\n        }\r\n\r\n        // DIM STANDARD: Proactive Conflict Resolution\r\n        // De-equip conflicting exotics BEFORE moving anything to avoid 1641 errors\r\n        onProgress('Resolving exotic conflicts...', 15);\r\n        await transferService.orchestrateBulkDequip(characterId, itemsToEquip);\r\n\r\n        // 3. Transfer Items (Strict Sequential Queue - DIM Standard)\r\n        onProgress('Transferring items...', 20);\r\n        const session = createMoveSession(itemsToMove.map(i => i.instanceId));\r\n\r\n        let movedCount = 0;\r\n        // DIM Standard: Process moves one-by-one to allow Bungie API to settle\r\n        for (const item of itemsToMove) {\r\n            if (item.currentOwner === characterId) {\r\n                movedCount++;\r\n                continue;\r\n            }\r\n\r\n            const progress = 20 + Math.floor((movedCount / itemsToMove.length) * 40);\r\n            onProgress(`Transferring ${movedCount + 1}/${itemsToMove.length}...`, progress);\r\n\r\n            try {\r\n                // Execute move and WAIT for Bungie's confirmation before starting the next\r\n                const success = await transferService.moveItem(\r\n                    { itemHash: item.hash, itemInstanceId: item.instanceId } as any,\r\n                    item.currentOwner,\r\n                    characterId,\r\n                    session,\r\n                    { silent: true }\r\n                );\r\n\r\n                if (!success) {\r\n                    console.warn(`[LoadoutLink] Sequential move failed for item ${item.hash}, continuing...`);\r\n                }\r\n            } catch (e) {\r\n                console.error(`[LoadoutLink] Critical error in sequential move for item ${item.hash}:`, e);\r\n            }\r\n            movedCount++;\r\n        }\r\n        console.log(`[LoadoutLink] Sequential transfer phase complete: ${movedCount} items processed`);\r\n\r\n        // 4. Equip Items (Bulk API)\r\n        onProgress('Equipping items...', 70);\r\n        const equipIds = itemsToMove.map(i => i.instanceId);\r\n        // Bulk equip is much faster than individual equips\r\n        await transferService.equipItems(equipIds, characterId, 0, { silent: true });\r\n\r\n        // CRITICAL: Settle delay after moves/equips. \r\n        // Bungie's API needs a moment to realize the item is actually on the character before we can socket it.\r\n        await new Promise(resolve => setTimeout(resolve, 2000));\r\n\r\n        // 5. Apply Subclass & Item Configuration\r\n        // Note: Socket insertions (mods/perks) MUST remain sequential to avoid 500 errors\r\n        onProgress('Configuring subclass and perks...', 85);\r\n\r\n        // 5a. Handle Subclass (Fragments, Aspects, etc.)\r\n        const subclassRef = loadout.equipped.find(i => {\r\n            const def = manifestService.getItem(i.hash);\r\n            return def?.itemType === 16;\r\n        });\r\n\r\n        if (subclassRef && subclassRef.socketOverrides) {\r\n            const state = useProfileStore.getState();\r\n            const subclassItem = [...(state.characterEquipment[characterId] || []), ...(state.characterInventories[characterId] || [])]\r\n                .find(i => i.itemHash === subclassRef.hash);\r\n\r\n            if (subclassItem?.itemInstanceId) {\r\n                const template = convertToBuildTemplate(loadout);\r\n                try {\r\n                    await transferService.applySubclassConfiguration(\r\n                        subclassItem,\r\n                        template.subclassConfig,\r\n                        characterId,\r\n                        onProgress\r\n                    );\r\n                } catch (e) {\r\n                    console.warn('[LoadoutLink] Subclass config failed (partial application):', e);\r\n                }\r\n            }\r\n        }\r\n\r\n        // 5b. Handle Item Socket Overrides (Weapon/Armor Perks & Mods)\r\n        onProgress('Applying item perks and mods...', 90);\r\n        const socketItems = loadout.equipped.filter(i => i.socketOverrides && Object.keys(i.socketOverrides).length > 0);\r\n\r\n        for (let i = 0; i < socketItems.length; i++) {\r\n            const itemRef = socketItems[i];\r\n            const state = useProfileStore.getState();\r\n            const foundItem = [...(state.characterEquipment[characterId] || []), ...(state.characterInventories[characterId] || [])]\r\n                .find(i => i.itemHash === itemRef.hash);\r\n\r\n            if (foundItem?.itemInstanceId) {\r\n                const overrides = itemRef.socketOverrides as Record<number, number>;\r\n                const progress = 90 + Math.floor((i / socketItems.length) * 5);\r\n                onProgress(`Applying perks (${i + 1}/${socketItems.length})...`, progress);\r\n\r\n                try {\r\n                    await transferService.applyItemSocketOverrides(foundItem.itemInstanceId, overrides, characterId);\r\n                } catch (e) {\r\n                    console.warn(`[LoadoutLink] Socket override failed for item ${itemRef.hash}:`, e);\r\n                }\r\n            }\r\n        }\r\n\r\n        // 6. Apply Mods (Parameters)\r\n        if (loadout.parameters?.mods && loadout.parameters.mods.length > 0) {\r\n            onProgress('Applying general mods...', 95);\r\n            try {\r\n                await transferService.applyArmorMods(characterId, loadout.parameters.mods, onProgress);\r\n            } catch (e) {\r\n                console.warn('[LoadoutLink] Armor mods application failed (partial application):', e);\r\n            }\r\n        }\r\n\r\n        onProgress('Loadout applied!', 100);\r\n\r\n        // Consolidated success notification\r\n        const { addToast } = useToastStore.getState();\r\n        addToast({\r\n            type: 'success',\r\n            message: `Loadout \"${loadout.name}\" applied successfully!`,\r\n            duration: 5000\r\n        });\r\n\r\n        // Crucial: Trigger an immediate sync to verify the new state and provide a clean slate for sequential operations\r\n        // This ensures that the NEXT loadout applied starts with fresh, confirmed item locations.\r\n        // Also includes a delay for Bungie API to settle.\r\n        await syncManager.triggerImmediateSync();\r\n\r\n        if (missingItems.length > 0) {\r\n            return {\r\n                success: true,\r\n                error: `Partial success. Missing ${missingItems.length} items: ${missingItems.slice(0, 2).join(', ')}${missingItems.length > 2 ? '...' : ''}`\r\n            };\r\n        }\r\n\r\n        return { success: true };\r\n\r\n    } catch (error: any) {\r\n        return { success: false, error: error.message || 'Unknown error' };\r\n    }\r\n}\r\n\r\n/**\r\n * Converts a shared loadout to a saved build template\r\n */\r\n/**\r\n * Converts a shared loadout to a saved build template\r\n */\r\nexport function convertToBuildTemplate(loadout: LoadoutShareData): BuildTemplate {\r\n\r\n    // 1. Identify Subclass\r\n    const subclassItem = loadout.equipped.find(i => {\r\n        const def = manifestService.getItem(i.hash);\r\n        // DIM Standard: Check both itemType (16) and bucket (Subclass)\r\n        return def?.itemType === 16 || def?.inventory?.bucketTypeHash === BUCKET_HASHES.SUBCLASS;\r\n    });\r\n\r\n    // Derive element from subclass damage type\r\n    let derivedElement = 'solar';\r\n    if (subclassItem) {\r\n        const subDef = manifestService.getItem(subclassItem.hash) as any;\r\n        const damageType = subDef?.talentGrid?.hudDamageType || subDef?.defaultDamageType || 0;\r\n        const damageTypeMap: Record<number, string> = {\r\n            1: 'kinetic',\r\n            2: 'arc',\r\n            3: 'solar',\r\n            4: 'void',\r\n            5: 'stasis',\r\n            6: 'strand',\r\n            7: 'prismatic'\r\n        };\r\n        derivedElement = damageTypeMap[damageType] || 'solar';\r\n    }\r\n\r\n    const exoticWeapon = loadout.equipped.find(i => {\r\n        const def = manifestService.getItem(i.hash);\r\n        return def?.tierType === 6 && def.itemType === 3;\r\n    });\r\n\r\n    const exoticArmor = loadout.equipped.find(i => {\r\n        const def = manifestService.getItem(i.hash);\r\n        return def?.tierType === 6 && def.itemType === 2;\r\n    });\r\n\r\n    // 2. Parse Subclass Config\r\n    const subclassConfig: BuildTemplate['subclassConfig'] = {\r\n        subclassHash: subclassItem?.hash,\r\n        superHash: 0,\r\n        aspects: [],\r\n        fragments: [],\r\n        grenadeHash: 0,\r\n        meleeHash: 0,\r\n        classAbilityHash: 0\r\n    };\r\n\r\n    if (subclassItem && subclassItem.socketOverrides) {\r\n        const subDef = manifestService.getItem(subclassItem.hash) as any;\r\n        if (subDef && subDef.sockets) {\r\n            const getSocketCategory = (index: number) => {\r\n                const cats = subDef.sockets.socketCategories || subDef.sockets.categories;\r\n                return cats?.find((c: any) => c.socketIndexes.includes(index))?.socketCategoryHash;\r\n            };\r\n\r\n            for (const [indexStr, plugHash] of Object.entries(subclassItem.socketOverrides)) {\r\n                const index = parseInt(indexStr);\r\n                const hash = plugHash as number;\r\n                const catHash = getSocketCategory(index);\r\n                const plugDef = manifestService.getItem(hash);\r\n\r\n                if (catHash === SOCKET_CATEGORY_HASHES.SUPER) subclassConfig.superHash = hash;\r\n                else if (catHash === SOCKET_CATEGORY_HASHES.ABILITIES) {\r\n                    if (plugDef) {\r\n                        const id = (plugDef as any).plug?.plugCategoryIdentifier || '';\r\n                        if (id.includes('class_abilities')) subclassConfig.classAbilityHash = hash;\r\n                        else if (id.includes('grenades')) subclassConfig.grenadeHash = hash;\r\n                        else if (id.includes('melee')) subclassConfig.meleeHash = hash;\r\n                        else if (plugDef.itemType === 16) subclassConfig.superHash = hash;\r\n                    }\r\n                }\r\n                else if (catHash === SOCKET_CATEGORY_HASHES.ASPECTS) subclassConfig.aspects?.push(hash);\r\n                else if (catHash === SOCKET_CATEGORY_HASHES.FRAGMENTS) subclassConfig.fragments?.push(hash);\r\n                // Direct plug check fallback\r\n                else if (plugDef) {\r\n                    const id = (plugDef as any).plug?.plugCategoryIdentifier || '';\r\n                    if (id.includes('aspects')) subclassConfig.aspects?.push(hash);\r\n                    else if (id.includes('fragments')) subclassConfig.fragments?.push(hash);\r\n                    else if (id.includes('super')) subclassConfig.superHash = hash;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    // 3. Other Items (Legendaries, etc.)\r\n    const items: BuildTemplate['items'] = [];\r\n    for (const item of loadout.equipped) {\r\n        // Skip Exotics and Subclass as they are explicitly handled\r\n        if (item.hash === exoticWeapon?.hash || item.hash === exoticArmor?.hash || item.hash === subclassItem?.hash) continue;\r\n\r\n        const def = manifestService.getItem(item.hash);\r\n        if (def) {\r\n            items.push({ hash: item.hash, name: def.name, socketOverrides: item.socketOverrides });\r\n        } else {\r\n            items.push({ hash: item.hash, name: 'Unknown', socketOverrides: item.socketOverrides });\r\n        }\r\n    }\r\n\r\n    return {\r\n        id: loadout.id || `imported-${Date.now()}`,\r\n        name: loadout.name || 'Imported Loadout',\r\n        element: derivedElement as any,\r\n        guardianClass: loadout.classType,\r\n        exoticWeapon: {\r\n            hash: exoticWeapon?.hash || 0,\r\n            name: 'Unknown',\r\n            slot: 1\r\n        },\r\n        exoticArmor: {\r\n            hash: exoticArmor?.hash || 0,\r\n            name: 'Unknown',\r\n            slot: 0\r\n        },\r\n        subclassConfig,\r\n        armorMods: loadout.parameters?.mods || [],\r\n        artifactPerks: loadout.parameters?.artifactPerks || [],\r\n        items, // Full Loadout Fidelity\r\n        playstyle: 'Imported from Loadout Link',\r\n        difficulty: 'intermediate'\r\n    };\r\n}\r\n\r\n/**\r\n * Converts a BuildTemplate back to LoadoutShareData for link sharing\r\n */\r\nexport function convertBuildToLoadoutShareData(build: BuildTemplate): LoadoutShareData {\r\n    const equipped: LoadoutItem[] = [];\r\n\r\n    // Subclass Item Hash Lookup by Class (0=Titan, 1=Hunter, 2=Warlock) + Element\r\n    // These are the actual subclass ITEM hashes (not ability hashes)\r\n    const SUBCLASS_ITEM_HASHES: Record<string, number> = {\r\n        // Titan\r\n        '0-Arc': 2932390016,\r\n        '0-Solar': 2550323932,\r\n        '0-Void': 4178525824,\r\n        '0-Stasis': 613647804,\r\n        '0-Strand': 242419065,\r\n        '0-Prismatic': 3450112461,\r\n        // Hunter\r\n        '1-Arc': 2328211300,\r\n        '1-Solar': 2240888816,\r\n        '1-Void': 2453351420,\r\n        '1-Stasis': 873720784,\r\n        '1-Strand': 3785442599,\r\n        '1-Prismatic': 1040198773,\r\n        // Warlock\r\n        '2-Arc': 3168997075,\r\n        '2-Solar': 3941205951,\r\n        '2-Void': 2849050827,\r\n        '2-Stasis': 3291545503,\r\n        '2-Strand': 4204413574,\r\n        '2-Prismatic': 2806388174,\r\n    };\r\n\r\n    // Add Exotic Weapon with socketOverrides if available\r\n    if (build.exoticWeapon?.hash && build.exoticWeapon.hash > 0) {\r\n        equipped.push({\r\n            hash: build.exoticWeapon.hash,\r\n            socketOverrides: (build.exoticWeapon as any).socketOverrides || {}\r\n        });\r\n    }\r\n\r\n    // Add Exotic Armor with socketOverrides if available\r\n    if (build.exoticArmor?.hash && build.exoticArmor.hash > 0) {\r\n        equipped.push({\r\n            hash: build.exoticArmor.hash,\r\n            socketOverrides: build.exoticArmor.socketOverrides || {}\r\n        });\r\n    }\r\n\r\n    // Add Legendaries/Other Items\r\n    if (build.items) {\r\n        build.items.forEach(item => equipped.push({ hash: item.hash, socketOverrides: item.socketOverrides || {} }));\r\n    }\r\n\r\n    // Derive subclass item hash from class + element if not explicitly provided\r\n    const elementKey = typeof build.element === 'string'\r\n        ? build.element.charAt(0).toUpperCase() + build.element.slice(1).toLowerCase()\r\n        : String(build.element);\r\n    const subclassLookupKey = `${build.guardianClass}-${elementKey}`;\r\n    const subclassHash = build.subclassConfig?.subclassHash || SUBCLASS_ITEM_HASHES[subclassLookupKey] || 0;\r\n\r\n    if (subclassHash) {\r\n        const subclassOverrides: Record<number, number> = {};\r\n        const subDef = manifestService.getItem(subclassHash) as any;\r\n\r\n        if (subDef?.sockets?.socketCategories) {\r\n            const findIndices = (categoryHashes: number[]) => {\r\n                return categoryHashes.flatMap(h => {\r\n                    const cat = subDef.sockets.socketCategories.find((c: any) => c.socketCategoryHash === h);\r\n                    return cat ? cat.socketIndexes : [];\r\n                }).sort((a, b) => a - b);\r\n            };\r\n\r\n            const aspectIndices = findIndices([\r\n                SOCKET_CATEGORY_HASHES.ASPECTS,\r\n                SOCKET_CATEGORY_HASHES.ASPECTS_IKORA,\r\n                SOCKET_CATEGORY_HASHES.ASPECTS_STRANGER,\r\n                SOCKET_CATEGORY_HASHES.ASPECTS_NEOMUNA\r\n            ]);\r\n\r\n            const fragmentIndices = findIndices([\r\n                SOCKET_CATEGORY_HASHES.FRAGMENTS,\r\n                SOCKET_CATEGORY_HASHES.FRAGMENTS_IKORA,\r\n                SOCKET_CATEGORY_HASHES.FRAGMENTS_STRANGER,\r\n                SOCKET_CATEGORY_HASHES.FRAGMENTS_NEOMUNA\r\n            ]);\r\n\r\n            const superIndices = findIndices([SOCKET_CATEGORY_HASHES.SUPER]);\r\n\r\n            // Assign Super\r\n            if (build.subclassConfig?.superHash && superIndices.length > 0) {\r\n                subclassOverrides[superIndices[0]] = build.subclassConfig.superHash;\r\n            }\r\n\r\n            // Assign Aspects\r\n            if (build.subclassConfig?.aspects) {\r\n                build.subclassConfig.aspects.forEach((hash, i) => {\r\n                    if (hash && i < aspectIndices.length) subclassOverrides[aspectIndices[i]] = hash;\r\n                });\r\n            }\r\n\r\n            // Assign Fragments\r\n            if (build.subclassConfig?.fragments) {\r\n                build.subclassConfig.fragments.forEach((hash, i) => {\r\n                    if (hash && i < fragmentIndices.length) subclassOverrides[fragmentIndices[i]] = hash;\r\n                });\r\n            }\r\n\r\n            // Assign Abilities (Greande, Melee, Class) using strict plug compatibility checking\r\n            // We iterate through available ability sockets and check if the specific ability plug fits\r\n            const abilityIndices = findIndices([\r\n                SOCKET_CATEGORY_HASHES.ABILITIES,\r\n                SOCKET_CATEGORY_HASHES.ABILITIES_IKORA\r\n            ]);\r\n\r\n            const abilitiesToSocket = [\r\n                build.subclassConfig?.classAbilityHash,\r\n                build.subclassConfig?.meleeHash,\r\n                build.subclassConfig?.grenadeHash\r\n            ].filter(Boolean) as number[];\r\n\r\n            abilitiesToSocket.forEach(abilityHash => {\r\n                const plugDef = manifestService.getItem(abilityHash) as any;\r\n                if (!plugDef) return;\r\n\r\n                // Find the first empty ability socket that accepts this plug\r\n                const targetIndex = abilityIndices.find(socketIndex => {\r\n                    // Check if already occupied by our overrides\r\n                    if (subclassOverrides[socketIndex]) return false;\r\n\r\n                    // Check if socket accepts this plug category\r\n                    const socketEntry = subDef.sockets.socketEntries[socketIndex];\r\n                    if (!socketEntry) return false;\r\n\r\n                    const socketType = manifestService.getRawDefinition('DestinySocketTypeDefinition', socketEntry.socketTypeHash);\r\n                    if (!socketType?.plugWhitelist) return false;\r\n\r\n                    return socketType.plugWhitelist.some((w: any) => w.categoryHash === plugDef.plug?.plugCategoryHash);\r\n                });\r\n\r\n                if (targetIndex !== undefined) {\r\n                    subclassOverrides[targetIndex] = abilityHash;\r\n                }\r\n            });\r\n\r\n        } else {\r\n            // Fallback for missing manifest data (Legacy behavior)\r\n            if (build.subclassConfig?.superHash) subclassOverrides[0] = build.subclassConfig.superHash;\r\n\r\n            // Aspects\r\n            if (build.subclassConfig?.aspects?.[0]) subclassOverrides[1] = build.subclassConfig.aspects[0];\r\n            if (build.subclassConfig?.aspects?.[1]) subclassOverrides[2] = build.subclassConfig.aspects[1];\r\n\r\n            // Fragments\r\n            build.subclassConfig?.fragments?.forEach((hash, i) => {\r\n                if (hash) subclassOverrides[10 + i] = hash;\r\n            });\r\n\r\n            // Abilities\r\n            if (build.subclassConfig?.grenadeHash) subclassOverrides[20] = build.subclassConfig.grenadeHash;\r\n            if (build.subclassConfig?.meleeHash) subclassOverrides[21] = build.subclassConfig.meleeHash;\r\n            if (build.subclassConfig?.classAbilityHash) subclassOverrides[22] = build.subclassConfig.classAbilityHash;\r\n        }\r\n\r\n        equipped.push({\r\n            hash: subclassHash,\r\n            socketOverrides: subclassOverrides\r\n        });\r\n    }\r\n\r\n    return {\r\n        id: build.id,\r\n        name: build.name,\r\n        classType: build.guardianClass,\r\n        equipped,\r\n        parameters: {\r\n            mods: build.armorMods,\r\n            exoticArmorHash: build.exoticArmor?.hash,\r\n            artifactPerks: build.artifactPerks,\r\n            // Future: Group mods by bucket if needed for 100% DIM parity\r\n        }\r\n    };\r\n}\r\n\r\n\r\n/**\r\n * Generate an ExoEngine loadout link from LoadoutShareData\r\n */\r\nasync function generateLoadoutLink(loadout: LoadoutShareData): Promise<string> {\r\n    try {\r\n        // Encode the loadout data\r\n        const jsonString = JSON.stringify(loadout);\r\n        const encoder = new TextEncoder();\r\n        const data = encoder.encode(jsonString);\r\n\r\n        // Compress using CompressionStream if available\r\n        if (typeof CompressionStream !== 'undefined') {\r\n            const stream = new Blob([data]).stream();\r\n            const compressedStream = stream.pipeThrough(new CompressionStream('gzip'));\r\n            const compressedBlob = await new Response(compressedStream).blob();\r\n            const compressedData = new Uint8Array(await compressedBlob.arrayBuffer());\r\n\r\n            // Base64 encode\r\n            const base64 = btoa(String.fromCharCode(...compressedData));\r\n            const urlSafe = base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '');\r\n\r\n            return `/loadout/${urlSafe}`;\r\n        } else {\r\n            // Fallback: Just base64 encode without compression\r\n            const base64 = btoa(jsonString);\r\n            const urlSafe = base64.replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=/g, '');\r\n\r\n            return `/loadout/${urlSafe}`;\r\n        }\r\n    } catch (error) {\r\n        throw new Error('Failed to generate loadout link');\r\n    }\r\n}\r\n\r\n/**\r\n * Generate a DIM-compatible loadout link from LoadoutShareData\r\n */\r\nasync function generateDIMLink(): Promise<string> {\r\n    try {\r\n        // DIM uses their own API to create shareable links\r\n        // For now, we'll generate an ExoEngine link since we can't directly create DIM links\r\n        // without calling DIM's API with authentication\r\n\r\n        // Alternative: Return a message that DIM links require DIM's API\r\n        throw new Error('DIM link generation requires DIM API access. Use ExoEngine link instead (S key).');\r\n\r\n        // NOTE: Future enhancement if DIM API access is granted:\r\n        // - POST to https://api.destinyitemmanager.com/loadout/share\r\n        // - Return dim.gg share URL\r\n    } catch (error: any) {\r\n        throw error;\r\n    }\r\n}\r\n\r\nexport const loadoutLinkService = {\r\n    parseLoadoutLink,\r\n    generateExoEngineLink,\r\n    generateDIMCompatibleLink,\r\n    generateLoadoutLink,\r\n    generateDIMLink,\r\n    getLastDebugRaw,\r\n    importDIMJson,\r\n    convertToBuildTemplate,\r\n    convertBuildToLoadoutShareData\r\n};\r\n\r\nexport function importDIMJson(json: any): LoadoutShareData[] {\r\n    const loadouts: LoadoutShareData[] = [];\r\n\r\n    // Format 1: Direct LoadoutShareData object\r\n    if (json.name && json.equipped) {\r\n        loadouts.push(json as LoadoutShareData);\r\n    }\r\n    // Format 2: DIM Backup JSON (e.g. dim-data.json)\r\n    else if (json.loadouts && Array.isArray(json.loadouts)) {\r\n        json.loadouts.forEach((entry: any) => {\r\n            if (entry.loadout) {\r\n                loadouts.push(entry.loadout as LoadoutShareData);\r\n            }\r\n        });\r\n    }\r\n\r\n    return loadouts;\r\n}\r\n","/**\r\n * SynergyBuildOverlay Component\r\n *\r\n * Full-screen synergy build overlay that displays complete build information\r\n * matching the SavedBuildsPage and DIM loadout viewer layouts.\r\n * Shows: Super, all abilities, 2 aspects, all fragments, exotic armor & weapon.\r\n * Includes DIM link copy and Exo share functionality.\r\n */\r\nimport { useEffect, useState, useCallback } from 'react';\r\nimport { createPortal } from 'react-dom';\r\nimport { manifestService } from '../../services/bungie/manifest.service';\r\nimport { useManifestStore, useProfileStore, useUIStore } from '../../store';\r\nimport { SUBCLASS_HASHES } from '../../constants/item-hashes';\r\nimport type { DashboardSynergy } from '../../services/synergy-matcher.service';\r\nimport { type BuildTemplate, ElementType } from '../../types';\r\nimport { useToast } from '../common/Toast';\r\nimport { RichItemIcon } from '../common/RichItemIcon';\r\nimport { RichTooltip } from '../builder/RichTooltip';\r\nimport { categorizeMods } from '../../utils/loadout-mods.utils';\r\nimport { getBungieUrl } from '../../utils/url-helper';\r\nimport { loadoutLinkService, convertBuildToLoadoutShareData } from '../../services/bungie/loadout-link.service';\r\nimport './SynergyBuildOverlay.css';\r\n\r\n// Hash lookup cache for abilities by name\r\nconst ABILITY_HASH_CACHE: Record<string, number> = {};\r\n\r\ninterface SynergyBuildOverlayProps {\r\n    synergy: DashboardSynergy;\r\n    onClose: () => void;\r\n    onEquip?: (synergy: DashboardSynergy) => void;\r\n}\r\n\r\n// Helper to find item hash by name from player's inventory\r\nfunction findItemHashByName(itemName: string): number | undefined {\r\n    const searchName = itemName.toLowerCase().trim();\r\n    const store = useProfileStore.getState();\r\n    const { characterEquipment, characterInventories, vaultInventory } = store;\r\n\r\n    const allHashes = new Set<number>();\r\n\r\n    for (const equipment of Object.values(characterEquipment)) {\r\n        for (const item of equipment) {\r\n            allHashes.add(item.itemHash);\r\n        }\r\n    }\r\n\r\n    for (const inventory of Object.values(characterInventories)) {\r\n        for (const item of inventory) {\r\n            allHashes.add(item.itemHash);\r\n        }\r\n    }\r\n\r\n    for (const item of vaultInventory) {\r\n        allHashes.add(item.itemHash);\r\n    }\r\n\r\n    for (const hash of allHashes) {\r\n        const def = manifestService.getItem(hash);\r\n        if (def?.displayProperties?.name?.toLowerCase() === searchName) {\r\n            return hash;\r\n        }\r\n    }\r\n\r\n    return undefined;\r\n}\r\n\r\n// Helper to look up static ability hashes from constants\r\nfunction getStaticAbilityHash(name: string, classType: number | string, element: string): number | null {\r\n    if (!name) return null;\r\n\r\n\r\n    // Normalize class/element keys for lookup\r\n    // classType comes as 0,1,2 or string from synergy\r\n    let clsKey: 'TITAN' | 'HUNTER' | 'WARLOCK' | null = null;\r\n    if (classType === 0 || classType === 'Titan') clsKey = 'TITAN';\r\n    if (classType === 1 || classType === 'Hunter') clsKey = 'HUNTER';\r\n    if (classType === 2 || classType === 'Warlock') clsKey = 'WARLOCK';\r\n    // Prismatic specific logic if needed, but usually handled by element\r\n\r\n    const eleKey = element.toUpperCase() as keyof typeof SUBCLASS_HASHES;\r\n    if (!clsKey || !SUBCLASS_HASHES[eleKey]) return null;\r\n\r\n    // Helper to normalize names to match constant keys\r\n    // \"Knock 'Em Down\" -> \"KNOCK_EM_DOWN\"\r\n    // \"Marksman's Dodge\" -> \"MARKSMANS_DODGE\"\r\n    const normalizeKey = (str: string) => {\r\n        return str.toLowerCase()\r\n            .replace(/[']/g, '') // Remove apostrophes\r\n            .replace(/[^a-z0-9 ]/g, '') // Keep only alphanumeric and spaces\r\n            .trim()\r\n            .replace(/ /g, '_')\r\n            .toUpperCase();\r\n    };\r\n\r\n    // Prismatic is special case structure in constants\r\n    if (eleKey === 'PRISMATIC') {\r\n        const prismaBranch = SUBCLASS_HASHES.PRISMATIC[clsKey];\r\n        if (!prismaBranch) return null;\r\n\r\n        const searchObj = (obj: any): number | null => {\r\n            // key matching\r\n            const cleanName = normalizeKey(name);\r\n\r\n            // Direct lookup if structure matches\r\n            if (typeof obj === 'object') {\r\n                if (obj[cleanName]) return obj[cleanName];\r\n\r\n                // Recursive search for flat keys\r\n                for (const key in obj) {\r\n                    const val = obj[key];\r\n                    if (typeof val === 'number') {\r\n                        if (key === cleanName) return val;\r\n                    } else if (typeof val === 'object') {\r\n                        // Check sub-sections like SUPER, JUMPS etc with direct key\r\n                        if (val[cleanName]) return val[cleanName];\r\n                    }\r\n                }\r\n            }\r\n            return null;\r\n        };\r\n        const found = searchObj(prismaBranch);\r\n        if (found) return found;\r\n\r\n        // Also check fragments (shared) if not found in class branch?\r\n        // Actually Prismatic Fragments are under PRISMATIC.FRAGMENTS (shared)\r\n        if (SUBCLASS_HASHES.PRISMATIC.FRAGMENTS) {\r\n            const cleanName = normalizeKey(name);\r\n            if ((SUBCLASS_HASHES.PRISMATIC.FRAGMENTS as any)[cleanName]) {\r\n                return (SUBCLASS_HASHES.PRISMATIC.FRAGMENTS as any)[cleanName];\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    // Standard Subclasses\r\n    const root = SUBCLASS_HASHES as any;\r\n    const branch = root[eleKey]?.[clsKey];\r\n\r\n    if (branch) {\r\n        const cleanName = normalizeKey(name);\r\n\r\n        // Direct lookup attempts\r\n        if (branch.SUPER?.[cleanName]) return branch.SUPER[cleanName];\r\n        if (branch.JUMPS?.[cleanName]) return branch.JUMPS[cleanName];\r\n        if (branch.MELEE?.[cleanName]) return branch.MELEE[cleanName];\r\n        if (branch.GRENADES?.[cleanName]) return branch.GRENADES[cleanName];\r\n        if (branch.CLASS_ABILITIES?.[cleanName]) return branch.CLASS_ABILITIES[cleanName];\r\n\r\n        // Aspects (might be shared or specific)\r\n        if (branch.ASPECTS?.[cleanName]) return branch.ASPECTS[cleanName];\r\n\r\n        // Fragments match check\r\n        if (root[eleKey]?.FRAGMENTS?.[cleanName]) return root[eleKey].FRAGMENTS[cleanName];\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\n// Helper to find ability hash by name from manifest (searches all plugs)\r\nfunction findAbilityHashByName(name: string, searchType: 'super' | 'ability' | 'aspect' | 'fragment'): number | null {\r\n    if (!name) return null;\r\n\r\n    const cacheKey = `${searchType}-${name.toLowerCase()}`;\r\n    if (ABILITY_HASH_CACHE[cacheKey]) {\r\n        return ABILITY_HASH_CACHE[cacheKey];\r\n    }\r\n\r\n    const nameLower = name.toLowerCase().trim();\r\n    const store = useProfileStore.getState();\r\n    const { characterEquipment, itemInstances } = store;\r\n\r\n    // Search through all character equipment for subclass abilities\r\n    for (const equipment of Object.values(characterEquipment)) {\r\n        for (const item of equipment) {\r\n            const instance = item.itemInstanceId ? itemInstances[item.itemInstanceId] : null;\r\n            if (instance?.sockets) {\r\n                for (const socket of instance.sockets) {\r\n                    if (!socket.plugHash) continue;\r\n                    const plugDef = manifestService.getItem(socket.plugHash);\r\n                    if (!plugDef?.displayProperties?.name) continue;\r\n\r\n                    const plugName = plugDef.displayProperties.name.toLowerCase();\r\n                    const category = plugDef.plug?.plugCategoryIdentifier?.toLowerCase() || '';\r\n\r\n                    if (plugName === nameLower || plugName.includes(nameLower) || nameLower.includes(plugName)) {\r\n                        let matches = false;\r\n                        switch (searchType) {\r\n                            case 'super':\r\n                                matches = category.includes('super');\r\n                                break;\r\n                            case 'ability':\r\n                                matches = category.includes('grenade') || category.includes('melee') ||\r\n                                    category.includes('class_abilities') || category.includes('movement');\r\n                                break;\r\n                            case 'aspect':\r\n                                matches = category.includes('aspects');\r\n                                break;\r\n                            case 'fragment':\r\n                                matches = category.includes('fragments') || category.includes('facets');\r\n                                break;\r\n                        }\r\n\r\n                        if (matches) {\r\n                            ABILITY_HASH_CACHE[cacheKey] = socket.plugHash;\r\n                            return socket.plugHash;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return null;\r\n}\r\n\r\n// Subclass item hash lookup by class + element\r\nconst SUBCLASS_ITEM_HASHES: Record<string, number> = {\r\n    '0-Arc': 2932390016, '0-Solar': 2550323932, '0-Void': 4178525824,\r\n    '0-Stasis': 613647804, '0-Strand': 242419065, '0-Prismatic': 3450112461,\r\n    '1-Arc': 2328211300, '1-Solar': 2240888816, '1-Void': 2453351420,\r\n    '1-Stasis': 873720784, '1-Strand': 3785442599, '1-Prismatic': 1040198773,\r\n    '2-Arc': 3168997075, '2-Solar': 3941205951, '2-Void': 2849050827,\r\n    '2-Stasis': 3291545503, '2-Strand': 4204413574, '2-Prismatic': 2806388174,\r\n};\r\n\r\nexport function SynergyBuildOverlay({ synergy, onClose, onEquip }: SynergyBuildOverlayProps) {\r\n    const classNames = ['Titan', 'Hunter', 'Warlock'];\r\n    const { success, error: showError } = useToast();\r\n    const [screenshot, setScreenshot] = useState<string | null>(null);\r\n    const [isLoreOpen, setIsLoreOpen] = useState(false);\r\n    const [hoveredHash, setHoveredHash] = useState<number | null>(null);\r\n    const [hoveredItemHash, setHoveredItemHash] = useState<number | null>(null);\r\n    const [mousePos, setMousePos] = useState({ x: 0, y: 0 });\r\n\r\n    const handleMouseMove = (e: React.MouseEvent) => {\r\n        const { clientX, clientY } = e;\r\n        const { innerWidth, innerHeight } = window;\r\n        const x = (clientX / innerWidth) - 0.5;\r\n        const y = (clientY / innerHeight) - 0.5;\r\n        setMousePos({ x, y });\r\n    };\r\n\r\n    const { isLoaded: manifestLoaded } = useManifestStore();\r\n    // const { selectedCharacterId, characterInventories } = useProfileStore();\r\n\r\n    // Build data state\r\n    const [buildData, setBuildData] = useState<{\r\n        superHash: number;\r\n        superIcon: string;\r\n        superName: string;\r\n        grenadeHash: number;\r\n        grenadeIcon: string;\r\n        grenadeName: string;\r\n        meleeHash: number;\r\n        meleeIcon: string;\r\n        meleeName: string;\r\n        classAbilityHash: number;\r\n        classAbilityIcon: string;\r\n        classAbilityName: string;\r\n        jumpHash: number;\r\n        jumpIcon: string;\r\n        jumpName: string;\r\n        aspects: Array<{ hash: number; icon: string; name: string }>;\r\n        fragments: Array<{ hash: number; icon: string; name: string }>;\r\n        weaponHash: number;\r\n        weaponIcon: string;\r\n        armorHash: number;\r\n        armorIcon: string;\r\n        transcendenceIcon?: string;\r\n        transcendentAbilityHash?: number;\r\n        transcendentAbilityIcon?: string;\r\n        transcendentAbilityName?: string;\r\n    }>({\r\n        superHash: 0, superIcon: '', superName: '',\r\n        grenadeHash: 0, grenadeIcon: '', grenadeName: '',\r\n        meleeHash: 0, meleeIcon: '', meleeName: '',\r\n        classAbilityHash: 0, classAbilityIcon: '', classAbilityName: '',\r\n        jumpHash: 0, jumpIcon: '', jumpName: '',\r\n        aspects: [],\r\n        fragments: [],\r\n        weaponHash: 0, weaponIcon: '',\r\n        armorHash: 0, armorIcon: '',\r\n    });\r\n\r\n    // Convert synergy to BuildTemplate for link generation\r\n    const convertSynergyToBuildTemplate = useCallback((): BuildTemplate => {\r\n        const elementKey = (synergy.element as ElementType).charAt(0).toUpperCase() + (synergy.element as ElementType).slice(1).toLowerCase();\r\n        const subclassLookupKey = `${synergy.classType}-${elementKey}`;\r\n        const subclassHash = SUBCLASS_ITEM_HASHES[subclassLookupKey] || 0;\r\n\r\n        return {\r\n            id: `synergy-${Date.now()}`,\r\n            name: synergy.buildName,\r\n            element: synergy.element.toLowerCase(),\r\n            guardianClass: synergy.classType,\r\n            exoticWeapon: {\r\n                hash: buildData.weaponHash || 0,\r\n                name: synergy.weapon,\r\n                slot: 1\r\n            },\r\n            exoticArmor: {\r\n                hash: buildData.armorHash || 0,\r\n                name: synergy.armor,\r\n                slot: 0\r\n            },\r\n            subclassConfig: {\r\n                subclassHash,\r\n                superHash: buildData.superHash,\r\n                aspects: buildData.aspects.map(a => a.hash).filter(h => h > 0),\r\n                fragments: buildData.fragments.map(f => f.hash).filter(h => h > 0),\r\n                grenadeHash: buildData.grenadeHash,\r\n                meleeHash: buildData.meleeHash,\r\n                classAbilityHash: buildData.classAbilityHash,\r\n            },\r\n            armorMods: [],\r\n            artifactPerks: [],\r\n            items: [],\r\n            playstyle: synergy.description,\r\n            difficulty: 'intermediate'\r\n        } as BuildTemplate;\r\n    }, [synergy, buildData]);\r\n\r\n    // Share handlers\r\n    const handleShareExo = useCallback(async () => {\r\n        try {\r\n            const template = convertSynergyToBuildTemplate();\r\n            const shareData = convertBuildToLoadoutShareData(template); // Assuming convertBuildToLoadoutShareData is defined elsewhere\r\n            const link = await loadoutLinkService.generateExoEngineLink(shareData); // Assuming loadoutLinkService is defined elsewhere\r\n            await navigator.clipboard.writeText(link);\r\n            success(\"ExoEngine Link copied to clipboard!\");\r\n        } catch (e) {\r\n            showError(\"Failed to generate link\");\r\n        }\r\n    }, [convertSynergyToBuildTemplate, success, showError]);\r\n\r\n    const handleShareDIM = useCallback(() => {\r\n        try {\r\n            const template = convertSynergyToBuildTemplate();\r\n            const shareData = convertBuildToLoadoutShareData(template); // Assuming convertBuildToLoadoutShareData is defined elsewhere\r\n            const link = loadoutLinkService.generateDIMCompatibleLink(shareData); // Assuming loadoutLinkService is defined elsewhere\r\n            navigator.clipboard.writeText(link);\r\n            success(\"DIM Link copied to clipboard!\");\r\n        } catch (e) {\r\n            showError(\"Failed to generate DIM link\");\r\n        }\r\n    }, [convertSynergyToBuildTemplate, success, showError]);\r\n\r\n    // Keyboard shortcuts\r\n    useEffect(() => {\r\n        const handleKeyDown = (e: KeyboardEvent) => {\r\n            if (e.key.toLowerCase() === 'a') setIsLoreOpen(v => !v);\r\n            if (e.key.toLowerCase() === 'f' && onEquip) {\r\n                onEquip(synergy);\r\n                // Trigger global transmat beam for feedback when equipping from overlay\r\n                useUIStore.getState().triggerGlobalTransmat('success');\r\n            }\r\n            if (e.key.toLowerCase() === 's') handleShareExo();\r\n            if (e.key.toLowerCase() === 'd') handleShareDIM();\r\n            if (e.key === 'Escape') onClose();\r\n        };\r\n\r\n        const handleRightClick = (e: MouseEvent) => {\r\n            e.preventDefault();\r\n            onClose();\r\n        };\r\n\r\n        window.addEventListener('keydown', handleKeyDown);\r\n        window.addEventListener('contextmenu', handleRightClick);\r\n\r\n        return () => {\r\n            window.removeEventListener('keydown', handleKeyDown);\r\n            window.removeEventListener('contextmenu', handleRightClick);\r\n        };\r\n    }, [onClose, onEquip, synergy, handleShareExo, handleShareDIM]);\r\n\r\n    // Load all build data from manifest\r\n    useEffect(() => {\r\n        if (!manifestLoaded) return;\r\n\r\n        async function loadBuildData() {\r\n            const data: typeof buildData = {\r\n                superHash: 0, superIcon: '', superName: '',\r\n                grenadeHash: 0, grenadeIcon: '', grenadeName: '',\r\n                meleeHash: 0, meleeIcon: '', meleeName: '',\r\n                classAbilityHash: 0, classAbilityIcon: '', classAbilityName: '',\r\n                jumpHash: 0, jumpIcon: '', jumpName: '',\r\n                aspects: [],\r\n                fragments: [],\r\n                weaponHash: 0, weaponIcon: '',\r\n                armorHash: 0, armorIcon: '',\r\n            };\r\n\r\n            // Find weapon and armor\r\n            const weaponHash = synergy.weapon ? findItemHashByName(synergy.weapon) : undefined;\r\n            const armorHash = synergy.armor ? findItemHashByName(synergy.armor) : undefined;\r\n\r\n            if (weaponHash) {\r\n                data.weaponHash = weaponHash;\r\n                data.weaponIcon = manifestService.getIcon(weaponHash) || '';\r\n                const weaponDef = manifestService.getItem(weaponHash);\r\n                if (weaponDef?.screenshot) setScreenshot(weaponDef.screenshot);\r\n            }\r\n\r\n            if (armorHash) {\r\n                data.armorHash = armorHash;\r\n                data.armorIcon = manifestService.getIcon(armorHash) || '';\r\n                if (!screenshot) {\r\n                    const armorDef = manifestService.getItem(armorHash);\r\n                    if (armorDef?.screenshot) setScreenshot(armorDef.screenshot);\r\n                }\r\n            }\r\n\r\n            // Super\r\n            const superHash = getStaticAbilityHash(synergy.super, synergy.classType, synergy.element) || findAbilityHashByName(synergy.super, 'super');\r\n            if (superHash) {\r\n                data.superHash = superHash;\r\n                data.superIcon = manifestService.getIcon(superHash) || '';\r\n                data.superName = synergy.super;\r\n            }\r\n\r\n            // Grenade\r\n            const grenadeHash = getStaticAbilityHash(synergy.grenade, synergy.classType, synergy.element) || findAbilityHashByName(synergy.grenade, 'ability');\r\n            if (grenadeHash) {\r\n                data.grenadeHash = grenadeHash;\r\n                data.grenadeIcon = manifestService.getIcon(grenadeHash) || '';\r\n                data.grenadeName = synergy.grenade;\r\n            }\r\n\r\n            // Melee\r\n            const meleeHash = getStaticAbilityHash(synergy.melee, synergy.classType, synergy.element) || findAbilityHashByName(synergy.melee, 'ability');\r\n            if (meleeHash) {\r\n                data.meleeHash = meleeHash;\r\n                data.meleeIcon = manifestService.getIcon(meleeHash) || '';\r\n                data.meleeName = synergy.melee;\r\n            }\r\n\r\n            // Class Ability\r\n            const classAbilityHash = getStaticAbilityHash(synergy.classAbility, synergy.classType, synergy.element) || findAbilityHashByName(synergy.classAbility, 'ability');\r\n            if (classAbilityHash) {\r\n                data.classAbilityHash = classAbilityHash;\r\n                data.classAbilityIcon = manifestService.getIcon(classAbilityHash) || '';\r\n                data.classAbilityName = synergy.classAbility;\r\n            }\r\n\r\n            // Jump\r\n            const jumpHash = getStaticAbilityHash(synergy.jump, synergy.classType, synergy.element) || findAbilityHashByName(synergy.jump, 'ability');\r\n            if (jumpHash) {\r\n                data.jumpHash = jumpHash;\r\n                data.jumpIcon = manifestService.getIcon(jumpHash) || ''; // Manifest lookup handles icon\r\n                data.jumpName = synergy.jump;\r\n            }\r\n\r\n            // Prismatic Transcendence\r\n            if (synergy.element.toLowerCase() === 'prismatic') {\r\n                data.transcendenceIcon = manifestService.getIcon(3976332159) || '';\r\n                if (synergy.transcendentAbility) {\r\n                    const transHash = findAbilityHashByName(synergy.transcendentAbility, 'ability');\r\n                    if (transHash) {\r\n                        data.transcendentAbilityHash = transHash;\r\n                        data.transcendentAbilityIcon = manifestService.getIcon(transHash) || '';\r\n                        data.transcendentAbilityName = synergy.transcendentAbility;\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Aspects (always 2)\r\n            for (const aspectName of synergy.aspects) {\r\n                const aspectHash = getStaticAbilityHash(aspectName, synergy.classType, synergy.element) || findAbilityHashByName(aspectName, 'aspect');\r\n                if (aspectHash) {\r\n                    const icon = manifestService.getIcon(aspectHash) || '';\r\n                    data.aspects.push({ hash: aspectHash, icon, name: aspectName });\r\n                }\r\n            }\r\n\r\n            // Fragments (all of them)\r\n            for (const fragmentName of synergy.fragments) {\r\n                const fragmentHash = getStaticAbilityHash(fragmentName, synergy.classType, synergy.element) || findAbilityHashByName(fragmentName, 'fragment');\r\n                if (fragmentHash) {\r\n                    const icon = manifestService.getIcon(fragmentHash) || '';\r\n                    data.fragments.push({ hash: fragmentHash, icon, name: fragmentName });\r\n                }\r\n            }\r\n\r\n            setBuildData(data);\r\n        }\r\n\r\n        loadBuildData();\r\n    }, [synergy, manifestLoaded]);\r\n\r\n    // Mod distribution and rendering helpers\r\n\r\n    const { renderCompactMods } = (() => {\r\n        const renderCompactMods = (slotMods: number[], ornament: any = null, shader: any = null) => {\r\n            const { mainStat, secondaryStat, others } = categorizeMods(slotMods);\r\n\r\n            const renderCosmeticPod = (hash: number | null) => {\r\n                const def = hash ? manifestService.getItem(hash) : null;\r\n                if (!def) return <div className=\"mod-pod cosmetic-pod placeholder-pod\" />;\r\n\r\n                return (\r\n                    <div key={hash} className=\"mod-pod cosmetic-pod\" onMouseEnter={() => setHoveredItemHash(hash)} onMouseLeave={() => setHoveredItemHash(null)}>\r\n                        <img src={getBungieUrl((def as any).displayProperties?.icon || '')} alt=\"\" />\r\n                    </div>\r\n                );\r\n            };\r\n\r\n            const renderModPod = (hash: number) => {\r\n                const def = manifestService.getItem(hash);\r\n                if (!def) return null;\r\n                return (\r\n                    <div key={hash} className=\"mod-pod\" onMouseEnter={() => setHoveredItemHash(hash)} onMouseLeave={() => setHoveredItemHash(null)}>\r\n                        <img src={getBungieUrl((def as any).displayProperties?.icon || '')} alt=\"\" />\r\n                    </div>\r\n                );\r\n            };\r\n\r\n            return (\r\n                <div className=\"armor-mods-pod-grid\">\r\n                    {renderCosmeticPod(shader?.hash)}\r\n                    {renderCosmeticPod(ornament?.hash)}\r\n                    {mainStat && renderModPod(mainStat)}\r\n                    {secondaryStat && renderModPod(secondaryStat)}\r\n                    {others.map((h) => renderModPod(h))}\r\n                </div>\r\n            );\r\n        };\r\n        return { renderCompactMods };\r\n    })();\r\n\r\n    // Tooltip handlers\r\n    const handleIconHover = (hash: number | null) => {\r\n        setHoveredHash(hash);\r\n    };\r\n\r\n    const element = (synergy.element as ElementType).toLowerCase();\r\n\r\n    // Get tooltip content\r\n    return createPortal(\r\n        <div\r\n            className={`synergy-build-overlay synergy-build-overlay--${element}`}\r\n            onMouseMove={handleMouseMove}\r\n            style={{\r\n                '--parallax-x': mousePos.x,\r\n                '--parallax-y': mousePos.y\r\n            } as any}\r\n        >\r\n            {/* Background */}\r\n            <div className=\"synergy-build-overlay__bg\">\r\n                <div className=\"synergy-build-overlay__pattern\" />\r\n                {screenshot && (\r\n                    <img src={screenshot} className=\"synergy-build-overlay__screenshot\" alt=\"\" />\r\n                )}\r\n                <div className=\"synergy-build-overlay__vignette\" />\r\n            </div>\r\n\r\n            {/* Header */}\r\n            <div className=\"synergy-build-overlay__header\">\r\n                <div className=\"synergy-build-overlay__title-group\">\r\n                    <h1 className=\"synergy-build-overlay__name\">{synergy.buildName}</h1>\r\n                    <div className=\"synergy-build-overlay__subtitle\">\r\n                        <span className={`element-badge element-badge--${element}`}>{synergy.element}</span>\r\n                        <span>{classNames[synergy.classType]}  {synergy.subclassType}</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main Content - Full 3-Column Build Layout */}\r\n            <div className=\"synergy-build-overlay__content\">\r\n                {/* 1. Super Section (Column 1) */}\r\n                <div className=\"build-section build-section--super\">\r\n                    {buildData.superIcon && (\r\n                        <div\r\n                            className=\"super-node-large\"\r\n                            onMouseEnter={() => handleIconHover(buildData.superHash)}\r\n                            onMouseLeave={() => handleIconHover(null)}\r\n                        >\r\n                            <img src={buildData.superIcon} alt={buildData.superName} />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* 2. Middle Section (Column 2) - Abilities, Aspects, Fragments, Stats */}\r\n                <div className=\"build-section--middle\">\r\n                    <div className=\"build-section--middle__top-row\">\r\n                        {/* Abilities Section */}\r\n                        <div className=\"node-section section-abilities\">\r\n                            <div className=\"node-section-header-prefixed\">| ABILITIES</div>\r\n                            <div className=\"node-section-content\">\r\n                                {buildData.classAbilityIcon && (\r\n                                    <div\r\n                                        className={`build-item element--${element}`}\r\n                                        onMouseEnter={() => handleIconHover(buildData.classAbilityHash)}\r\n                                        onMouseLeave={() => handleIconHover(null)}\r\n                                    >\r\n                                        <img src={buildData.classAbilityIcon} alt={buildData.classAbilityName} />\r\n                                    </div>\r\n                                )}\r\n                                {buildData.jumpIcon && (\r\n                                    <div\r\n                                        className={`build-item element--${element}`}\r\n                                        onMouseEnter={() => handleIconHover(buildData.jumpHash)}\r\n                                        onMouseLeave={() => handleIconHover(null)}\r\n                                    >\r\n                                        <img src={buildData.jumpIcon} alt={buildData.jumpName} />\r\n                                    </div>\r\n                                )}\r\n                                {buildData.grenadeIcon && (\r\n                                    <div\r\n                                        className={`build-item element--${element}`}\r\n                                        onMouseEnter={() => handleIconHover(buildData.grenadeHash)}\r\n                                        onMouseLeave={() => handleIconHover(null)}\r\n                                    >\r\n                                        <img src={buildData.grenadeIcon} alt={buildData.grenadeName} />\r\n                                    </div>\r\n                                )}\r\n                                {buildData.meleeIcon && (\r\n                                    <div\r\n                                        className={`build-item element--${element}`}\r\n                                        onMouseEnter={() => handleIconHover(buildData.meleeHash)}\r\n                                        onMouseLeave={() => handleIconHover(null)}\r\n                                    >\r\n                                        <img src={buildData.meleeIcon} alt={buildData.meleeName} />\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Aspects Section */}\r\n                        <div className=\"node-section section-aspects\">\r\n                            <div className=\"node-section-header-prefixed\">| ASPECTS</div>\r\n                            <div className=\"node-section-content\">\r\n                                {buildData.aspects.map((aspect: any, i: number) => (\r\n                                    <div\r\n                                        key={i}\r\n                                        className={`build-item element--${element}`}\r\n                                        onMouseEnter={() => handleIconHover(aspect.hash)}\r\n                                        onMouseLeave={() => handleIconHover(null)}\r\n                                    >\r\n                                        <img src={aspect.icon} alt={aspect.name} />\r\n                                    </div>\r\n                                ))}\r\n                                {/* Transcendence inline if Prismatic */}\r\n                                {buildData.transcendenceIcon && (\r\n                                    <div\r\n                                        className=\"build-item element--prismatic\"\r\n                                        onMouseEnter={() => handleIconHover(3976332159)}\r\n                                        onMouseLeave={() => handleIconHover(null)}\r\n                                    >\r\n                                        <img src={buildData.transcendenceIcon} alt=\"Transcendence\" />\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"build-section--middle__bottom-row\">\r\n                        {/* Fragments Section */}\r\n                        <div className=\"node-section section-fragments\">\r\n                            <div className=\"node-section-header-prefixed\">| FRAGMENTS</div>\r\n                            <div className=\"synergy-build-overlay__fragments-grid\">\r\n                                {buildData.fragments.map((fragment: any, i: number) => (\r\n                                    <div\r\n                                        key={i}\r\n                                        className={`build-item build-item--fragment element--${element}`}\r\n                                        onMouseEnter={() => handleIconHover(fragment.hash)}\r\n                                        onMouseLeave={() => handleIconHover(null)}\r\n                                    >\r\n                                        <img src={fragment.icon} alt={fragment.name} />\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* 3. Loadout & Gear Section (Moved from Column 3) */}\r\n                    <div className=\"build-section--middle__gear-row\">\r\n                        <div className=\"node-section section-gear\">\r\n                            <div className=\"node-section-header-prefixed\">| LOADOUT & GEAR</div>\r\n                            <div className=\"synergy-build-overlay__gear-horizontal-grid\">\r\n                                {/* Exotic Weapon */}\r\n                                {buildData.weaponIcon && (\r\n                                    <div\r\n                                        className=\"gear-item-horizontal\"\r\n                                        onMouseEnter={() => setHoveredItemHash(buildData.weaponHash || null)}\r\n                                        onMouseLeave={() => setHoveredItemHash(null)}\r\n                                    >\r\n                                        <RichItemIcon\r\n                                            hash={buildData.weaponHash || 0}\r\n                                            instance={{ state: 4 }}\r\n                                        />\r\n                                        <div className=\"gear-item-info\">\r\n                                            <span className=\"build-item__label--compact\">{synergy.weapon}</span>\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n\r\n                                {/* Exotic Armor */}\r\n                                {buildData.armorHash > 0 && (\r\n                                    <div\r\n                                        className=\"gear-item-horizontal\"\r\n                                        onMouseEnter={() => setHoveredItemHash(buildData.armorHash || null)}\r\n                                        onMouseLeave={() => setHoveredItemHash(null)}\r\n                                    >\r\n                                        <RichItemIcon\r\n                                            hash={buildData.armorHash || 0}\r\n                                            instance={{ state: 4 }}\r\n                                        />\r\n                                        <div className=\"gear-item-info\">\r\n                                            <span className=\"build-item__label--compact\">{synergy.armor}</span>\r\n                                            {(synergy as any).armorMods && (synergy as any).armorMods.length > 0 && renderCompactMods((synergy as any).armorMods)}\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Build Description Panel */}\r\n            <div className={`synergy-build-overlay__lore-panel ${isLoreOpen ? 'synergy-build-overlay__lore-panel--open' : ''}`}>\r\n                <div className=\"lore-panel__header\">\r\n                    <h2 className=\"lore-panel__title\">Build Strategy</h2>\r\n                </div>\r\n                <div className=\"lore-panel__content\">\r\n                    {synergy.description}\r\n                </div>\r\n            </div>\r\n\r\n\r\n            {/* Tooltip */}\r\n            {(hoveredHash || hoveredItemHash) && (\r\n                <RichTooltip item={{ hash: (hoveredHash || hoveredItemHash)! }} />\r\n            )}\r\n        </div>,\r\n        document.body\r\n    );\r\n}\r\n\r\nexport default SynergyBuildOverlay;\r\n","/**\r\n * SynergyWeb Component\r\n * \r\n * Renders animated SVG wires connecting synergistic items in the Synergy Galaxy.\r\n * Wires are color-coded by element and have hover tooltips.\r\n */\r\nimport { debugLog } from '../../utils/logger';\r\nimport { useState, useCallback, useEffect, useRef } from 'react';\r\nimport type { SynergyConnection, DashboardSynergy } from '../../services/synergy-matcher.service';\r\nimport type { ItemInstance } from '../../types';\r\nimport { RichTooltip } from './RichTooltip';\r\nimport { SynergyBuildOverlay } from '../synergy/SynergyBuildOverlay';\r\nimport './SynergyWeb.css';\r\n\r\n// Element color definitions\r\nconst ELEMENT_COLORS: Record<string, string> = {\r\n    solar: '#f97316',      // Orange\r\n    arc: '#7df9ff',        // Electric cyan/light blue - matches Arc subclass\r\n    void: '#a855f7',       // Purple\r\n    stasis: '#4d88ff',     // Deep ice blue - matches Stasis subclass\r\n    strand: '#10b981',     // Green\r\n    prismatic: '#ff6be8',  // Pink with rainbow hints\r\n    kinetic: '#ffffff'     // White\r\n};\r\n\r\nexport interface WirePosition {\r\n    sourceX: number;\r\n    sourceY: number;\r\n    sourceScale: number;\r\n    hubX?: number;\r\n    hubY?: number;\r\n    hubScale?: number;\r\n    hubOpacity?: number;\r\n    targetX: number;\r\n    targetY: number;\r\n    targetScale: number;\r\n    targetOpacity: number;\r\n    targetRadius: number; // For pixel-perfect tooltip offset\r\n    targetOpacityActual: number; // For overall visibility\r\n    element: string;\r\n    synergy: DashboardSynergy;\r\n    armorResult: SynergyConnection['armorResult'] | null;\r\n    weaponResult: SynergyConnection['weaponResult'] | null;\r\n    abilityName?: string;\r\n    targetType: 'armor' | 'weapon' | 'ability';\r\n}\r\n\r\ninterface SynergyWebProps {\r\n    connections: SynergyConnection[];\r\n    sourcePosition: { x: number; y: number; scale?: number } | null;\r\n    sourceNodeId: string | null;\r\n    getItemPosition: (itemName: string, location: 'equipped' | 'inventory' | 'vault', characterId?: string, nodeId?: string) => { x: number; y: number; scale: number; opacity: number; nodeId?: string } | null;\r\n    onEquipSynergy?: (synergy: DashboardSynergy) => void;\r\n    onSynergyOverlayChange?: (isOpen: boolean, synergy: any) => void;\r\n    itemInstances: Record<string, ItemInstance | undefined>;\r\n    onWireClick?: (synergy: DashboardSynergy) => void;\r\n    onWireHoverChange?: (hovered: boolean) => void;\r\n    onWireHover?: (wire: { armorInstanceId: string | null; weaponInstanceId: string | null } | null) => void; // Called with wire target IDs when hovering\r\n    onWireLock?: (itemInstanceId: string | null) => void; // Called when a wire endpoint is clicked to lock/unlock\r\n    onClose?: () => void;\r\n    isExiting?: boolean;\r\n    // Wire positions computed by parent RAF loop for perfect synchronization\r\n    syncedWirePositions?: Array<{ targetX: number; targetY: number; targetScale: number; targetOpacity: number; targetRadius: number }>;\r\n    hoveredNodeId?: string | null;\r\n    forceCloseTrigger?: number;\r\n}\r\n\r\nexport function SynergyWeb({\r\n    connections,\r\n    sourcePosition,\r\n    sourceNodeId,\r\n    getItemPosition,\r\n    onEquipSynergy,\r\n    onSynergyOverlayChange,\r\n    itemInstances,\r\n    onWireClick,\r\n    onWireHoverChange,\r\n    onWireHover,\r\n    onWireLock,\r\n    onClose,\r\n    isExiting = false,\r\n    syncedWirePositions,\r\n    hoveredNodeId,\r\n    forceCloseTrigger\r\n}: SynergyWebProps) {\r\n    const [hoveredWireId, setHoveredWireId] = useState<{ buildName: string; targetType: 'armor' | 'weapon' | 'ability'; abilityName?: string } | null>(null);\r\n    // Store locked wire identifier instead of full object so we can get live positions\r\n    const [lockedWireId, setLockedWireId] = useState<{ buildName: string; targetType: 'armor' | 'weapon' | 'ability'; abilityName?: string } | null>(null);\r\n    const [wires, setWires] = useState<WirePosition[]>([]);\r\n    const [animationProgress, setAnimationProgress] = useState(0);\r\n    const [exitProgress, setExitProgress] = useState(1); // 1 = visible, 0 = hidden\r\n    const [confirmedSynergy, setConfirmedSynergy] = useState<DashboardSynergy | null>(null);\r\n\r\n    // Force close effect when parent triggers it\r\n    useEffect(() => {\r\n        if (forceCloseTrigger && forceCloseTrigger > 0) {\r\n            handleCloseOverlay();\r\n        }\r\n    }, [forceCloseTrigger]);\r\n    const svgRef = useRef<SVGSVGElement>(null);\r\n\r\n    const hoveredWireRef = useRef<WirePosition | null>(null);\r\n    const lockedWireIdRef = useRef<{ buildName: string; targetType: 'armor' | 'weapon' | 'ability'; abilityName?: string } | null>(null);\r\n    const syncedWirePositionsRef = useRef(syncedWirePositions);\r\n    const wireHoverTimerRef = useRef<NodeJS.Timeout | null>(null);\r\n    const wireShowTimerRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n    // Get the live hovered wire from the wires array\r\n    const hoveredWire = hoveredWireId\r\n        ? wires.find(w => w.synergy.buildName === hoveredWireId.buildName && w.targetType === hoveredWireId.targetType) || null\r\n        : null;\r\n\r\n    // Get the live locked wire from the wires array\r\n    const lockedWire = lockedWireId\r\n        ? wires.find(w => w.synergy.buildName === lockedWireId.buildName && w.targetType === lockedWireId.targetType) || null\r\n        : null;\r\n\r\n    useEffect(() => {\r\n        hoveredWireRef.current = hoveredWire;\r\n    }, [hoveredWire]);\r\n\r\n    useEffect(() => {\r\n        lockedWireIdRef.current = lockedWireId;\r\n    }, [lockedWireId]);\r\n\r\n    // Clear timer on unmount\r\n    useEffect(() => {\r\n        return () => {\r\n            if (wireHoverTimerRef.current) {\r\n                clearTimeout(wireHoverTimerRef.current);\r\n            }\r\n            if (wireShowTimerRef.current) {\r\n                clearTimeout(wireShowTimerRef.current);\r\n            }\r\n        };\r\n    }, []);\r\n\r\n    // Keep ref in sync with prop (no re-render trigger)\r\n    useEffect(() => {\r\n        syncedWirePositionsRef.current = syncedWirePositions;\r\n    }, [syncedWirePositions]);\r\n\r\n    // Sync hovered wire with external hoveredNodeId from SynergyGalaxy HUD\r\n    const lastHoveredRef = useRef<boolean>(false);\r\n\r\n    useEffect(() => {\r\n        if (hoveredNodeId) {\r\n            // Find the wire connected to this node\r\n            const wire = wires.find(w =>\r\n                (w.armorResult?.item.itemInstanceId === hoveredNodeId) ||\r\n                (w.weaponResult?.item.itemInstanceId === hoveredNodeId)\r\n            );\r\n\r\n            if (wire) {\r\n                // External input: clear any local hide timer immediately\r\n                if (wireHoverTimerRef.current) {\r\n                    clearTimeout(wireHoverTimerRef.current);\r\n                    wireHoverTimerRef.current = null;\r\n                }\r\n\r\n                const wireId = { buildName: wire.synergy.buildName, targetType: wire.targetType, abilityName: wire.abilityName };\r\n                // Only update if ID actually changed\r\n                if (hoveredWireId?.buildName !== wireId.buildName || hoveredWireId?.targetType !== wireId.targetType || hoveredWireId?.abilityName !== wireId.abilityName) {\r\n                    setHoveredWireId(wireId);\r\n                }\r\n                if (!lastHoveredRef.current) {\r\n                    lastHoveredRef.current = true;\r\n                    onWireHoverChange?.(true);\r\n                    // Notify parent of which wire targets are being hovered (external hover from galaxy node)\r\n                    onWireHover?.({\r\n                        armorInstanceId: wire.armorResult?.item.itemInstanceId || null,\r\n                        weaponInstanceId: wire.weaponResult?.item.itemInstanceId || null\r\n                    });\r\n                }\r\n            }\r\n        } else {\r\n            // External clear - only if we don't have a local hover active\r\n            // NOTE: We trust internal hover over external clear to prevent flicker\r\n        }\r\n    }, [hoveredNodeId, wires, hoveredWireId, onWireHoverChange, onWireHover]);\r\n\r\n    // Exit animation - wires retract toward center\r\n    useEffect(() => {\r\n        if (!isExiting) {\r\n            setExitProgress(1);\r\n            return;\r\n        }\r\n\r\n        const startTime = performance.now();\r\n        const duration = 400;\r\n\r\n        const animate = (now: number) => {\r\n            const elapsed = now - startTime;\r\n            const progress = 1 - Math.min(elapsed / duration, 1);\r\n            // Ease in for accelerating retraction\r\n            setExitProgress(progress * progress);\r\n            if (progress > 0) requestAnimationFrame(animate);\r\n        };\r\n\r\n        requestAnimationFrame(animate);\r\n    }, [isExiting]);\r\n\r\n    // Frame-Synced Wire Recalculation\r\n    // Uses RAF loop that reads from syncedWirePositionsRef to avoid dependency on array reference\r\n    useEffect(() => {\r\n        if (!sourcePosition || !connections.length || isExiting) {\r\n            setWires([]);\r\n            return;\r\n        }\r\n\r\n        let raf: number;\r\n        const lastPositionsJsonRef = { current: '' };\r\n\r\n        const updateWires = () => {\r\n            const syncedPositions = syncedWirePositionsRef.current;\r\n            const newWires: WirePosition[] = [];\r\n\r\n            // Fetch source position\r\n            let currentSourceX = sourcePosition.x;\r\n            let currentSourceY = sourcePosition.y;\r\n            let currentSourceScale = sourcePosition.scale ?? 1;\r\n\r\n            if (sourceNodeId) {\r\n                const liveSource = getItemPosition('', 'equipped', undefined, sourceNodeId);\r\n                if (liveSource) {\r\n                    currentSourceX = liveSource.x;\r\n                    currentSourceY = liveSource.y;\r\n                    currentSourceScale = liveSource.scale;\r\n                }\r\n            }\r\n\r\n            const hubCache: Record<string, { x: number; y: number; scale: number; opacity: number; nodeId?: string } | null> = {};\r\n            const isSourceSubclass = sourceNodeId?.includes('subclass');\r\n\r\n            // CRITICAL: Determine the source element for unified coloring\r\n            // This ensures \"1 color for 1 subclass\" logic\r\n            let sourceElement = '';\r\n            if (sourceNodeId && isSourceSubclass) {\r\n                const match = sourceNodeId.match(/subclass-(\\d+)/);\r\n                if (match) {\r\n                    const hash = parseInt(match[1]);\r\n                    // In SynergyGalaxy, the element is stored in the node, but we can re-derive it\r\n                    // Or check the subclass node by hash\r\n                    const subclassElements: Record<number, string> = {\r\n                        // Warlock\r\n                        2366883719: 'solar',\r\n                        240538059: 'void',\r\n                        139534062: 'arc',\r\n                        1256795856: 'stasis',\r\n                        1811800262: 'strand',\r\n                        2732997195: 'prismatic',\r\n                        // Hunter\r\n                        2240825105: 'solar',\r\n                        245081432: 'void',\r\n                        3164832584: 'arc',\r\n                        3291544903: 'stasis',\r\n                        3828340157: 'strand',\r\n                        2835214899: 'prismatic',\r\n                        // Titan\r\n                        2024474330: 'solar',\r\n                        2007421831: 'void',\r\n                        1215437841: 'arc',\r\n                        1530663428: 'stasis',\r\n                        531398864: 'strand',\r\n                        2984351206: 'prismatic',\r\n                        1262901524: 'prismatic',\r\n                    };\r\n                    sourceElement = subclassElements[hash] || '';\r\n                }\r\n            }\r\n            if (!sourceElement && connections.length > 0) {\r\n                // If not a subclass source, use the first connection's element as a baseline\r\n                // This ensures weapon/armor webs are also monochromatic\r\n                sourceElement = connections[0].element.toLowerCase();\r\n            }\r\n\r\n            // If parent provides synced positions, use those\r\n            if (syncedPositions && syncedPositions.length > 0) {\r\n                let posIdx = 0;\r\n\r\n                for (const conn of connections) {\r\n                    const element = conn.element.toLowerCase();\r\n                    if (hubCache[element] === undefined) {\r\n                        hubCache[element] = getItemPosition(`${element} subclass`, 'equipped');\r\n                    }\r\n                    const hub = hubCache[element];\r\n                    const isSourceHub = hub?.nodeId === sourceNodeId;\r\n                    const shouldUseHub = isSourceSubclass && !isSourceHub;\r\n                    const finalHubX = shouldUseHub ? hub?.x : undefined;\r\n                    const finalHubY = shouldUseHub ? hub?.y : undefined;\r\n\r\n                    // Use synced positions for armor\r\n                    if (conn.armorResult && posIdx < syncedPositions.length) {\r\n                        const syncedPos = syncedPositions[posIdx++];\r\n                        newWires.push({\r\n                            sourceX: currentSourceX,\r\n                            sourceY: currentSourceY,\r\n                            sourceScale: currentSourceScale,\r\n                            hubX: finalHubX,\r\n                            hubY: finalHubY,\r\n                            hubScale: hub?.scale,\r\n                            hubOpacity: hub?.opacity,\r\n                            targetX: syncedPos.targetX,\r\n                            targetY: syncedPos.targetY,\r\n                            targetScale: syncedPos.targetScale,\r\n                            targetOpacity: syncedPos.targetOpacity,\r\n                            targetOpacityActual: syncedPos.targetOpacity,\r\n                            targetRadius: syncedPos.targetRadius,\r\n                            element: sourceElement || conn.element,\r\n                            synergy: conn.synergy,\r\n                            armorResult: conn.armorResult,\r\n                            weaponResult: conn.weaponResult,\r\n                            targetType: 'armor'\r\n                        });\r\n                    }\r\n\r\n                    // Use synced positions for weapon\r\n                    if (conn.weaponResult && posIdx < syncedPositions.length) {\r\n                        const syncedPos = syncedPositions[posIdx++];\r\n                        newWires.push({\r\n                            sourceX: currentSourceX,\r\n                            sourceY: currentSourceY,\r\n                            sourceScale: currentSourceScale,\r\n                            hubX: finalHubX,\r\n                            hubY: finalHubY,\r\n                            hubScale: hub?.scale,\r\n                            hubOpacity: hub?.opacity,\r\n                            targetX: syncedPos.targetX,\r\n                            targetY: syncedPos.targetY,\r\n                            targetScale: syncedPos.targetScale,\r\n                            targetOpacity: syncedPos.targetOpacity,\r\n                            targetOpacityActual: syncedPos.targetOpacity,\r\n                            targetRadius: syncedPos.targetRadius,\r\n                            element: sourceElement || conn.element,\r\n                            synergy: conn.synergy,\r\n                            armorResult: conn.armorResult,\r\n                            weaponResult: conn.weaponResult,\r\n                            targetType: 'weapon'\r\n                        });\r\n                    }\r\n                }\r\n            } else {\r\n                // Fallback: compute positions ourselves\r\n                for (const conn of connections) {\r\n                    const element = conn.element.toLowerCase();\r\n                    if (hubCache[element] === undefined) {\r\n                        hubCache[element] = getItemPosition(`${element} subclass`, 'equipped');\r\n                    }\r\n                    const hub = hubCache[element];\r\n                    const isSourceHub = hub?.nodeId === sourceNodeId;\r\n                    const shouldUseHub = isSourceSubclass && !isSourceHub;\r\n                    const finalHubX = shouldUseHub ? hub?.x : undefined;\r\n                    const finalHubY = shouldUseHub ? hub?.y : undefined;\r\n\r\n                    let armorRes = null;\r\n                    let weaponRes = null;\r\n\r\n                    if (conn.armorResult) {\r\n                        armorRes = getItemPosition(\r\n                            conn.synergy.armor,\r\n                            conn.armorResult.location,\r\n                            conn.armorResult.characterId,\r\n                            conn.armorResult.item.itemInstanceId\r\n                        );\r\n                    }\r\n\r\n                    if (conn.weaponResult) {\r\n                        weaponRes = getItemPosition(\r\n                            conn.synergy.weapon,\r\n                            conn.weaponResult.location,\r\n                            conn.weaponResult.characterId,\r\n                            conn.weaponResult.item.itemInstanceId\r\n                        );\r\n                    }\r\n\r\n                    const processResult = (res: any, type: 'armor' | 'weapon') => {\r\n                        if (!res) return;\r\n                        newWires.push({\r\n                            sourceX: currentSourceX,\r\n                            sourceY: currentSourceY,\r\n                            sourceScale: currentSourceScale,\r\n                            hubX: finalHubX,\r\n                            hubY: finalHubY,\r\n                            hubScale: hub?.scale,\r\n                            hubOpacity: hub?.opacity,\r\n                            targetX: res.x,\r\n                            targetY: res.y,\r\n                            targetScale: res.scale,\r\n                            targetOpacity: res.opacity,\r\n                            targetOpacityActual: res.opacity,\r\n                            targetRadius: Math.max(0, 32 * res.scale),\r\n                            element: conn.element, // Force use of synergy element for single-color consistency\r\n                            synergy: conn.synergy,\r\n                            armorResult: conn.armorResult,\r\n                            weaponResult: conn.weaponResult,\r\n                            targetType: type\r\n                        });\r\n                    };\r\n\r\n                    processResult(armorRes, 'armor');\r\n                    processResult(weaponRes, 'weapon');\r\n\r\n                    // 3. Process Abilities (Direct wires to subclass nodes)\r\n                    // OPTIMIZATION: Only draw detail wires for the hovered or locked synergy\r\n                    const isHovered = hoveredWireId?.buildName === conn.synergy.buildName;\r\n                    const isLocked = lockedWireId?.buildName === conn.synergy.buildName;\r\n\r\n                    if (isHovered || isLocked) {\r\n                        const abilities = [\r\n                            { name: conn.synergy.super, type: 'super' },\r\n                            { name: conn.synergy.grenade, type: 'grenade' },\r\n                            { name: conn.synergy.melee, type: 'melee' },\r\n                            { name: conn.synergy.classAbility, type: 'classAbility' },\r\n                            ...(conn.synergy.aspects || []).map(a => ({ name: a, type: 'aspect' })),\r\n                            ...(conn.synergy.fragments || []).map(f => ({ name: f, type: 'fragment' }))\r\n                        ];\r\n\r\n                        for (const ability of abilities) {\r\n                            if (!ability.name) continue;\r\n                            const abilityRes = getItemPosition(ability.name, 'equipped');\r\n                            if (abilityRes) {\r\n                                newWires.push({\r\n                                    sourceX: currentSourceX,\r\n                                    sourceY: currentSourceY,\r\n                                    sourceScale: currentSourceScale,\r\n                                    hubX: finalHubX,\r\n                                    hubY: finalHubY,\r\n                                    hubScale: hub?.scale,\r\n                                    hubOpacity: hub?.opacity,\r\n                                    targetX: abilityRes.x,\r\n                                    targetY: abilityRes.y,\r\n                                    targetScale: abilityRes.scale * 0.8,\r\n                                    targetOpacity: abilityRes.opacity,\r\n                                    targetOpacityActual: abilityRes.opacity,\r\n                                    targetRadius: Math.max(0, 24 * abilityRes.scale),\r\n                                    element: conn.element, // Force use of synergy element\r\n                                    synergy: conn.synergy,\r\n                                    armorResult: conn.armorResult,\r\n                                    weaponResult: conn.weaponResult,\r\n                                    targetType: 'ability',\r\n                                    abilityName: ability.name\r\n                                });\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n\r\n            // Only update state if positions actually changed (avoid unnecessary re-renders)\r\n            const newPositionsJson = JSON.stringify(newWires.map(w => ({\r\n                tx: Math.round(w.targetX),\r\n                ty: Math.round(w.targetY),\r\n                ts: w.targetScale.toFixed(3),\r\n                to: w.targetOpacity.toFixed(2)\r\n            })));\r\n\r\n            if (newPositionsJson !== lastPositionsJsonRef.current) {\r\n                lastPositionsJsonRef.current = newPositionsJson;\r\n                setWires(newWires);\r\n            }\r\n\r\n            raf = requestAnimationFrame(updateWires);\r\n        };\r\n\r\n        // Start RAF loop immediately\r\n        raf = requestAnimationFrame(updateWires);\r\n        return () => cancelAnimationFrame(raf);\r\n    }, [connections, sourcePosition, sourceNodeId, getItemPosition, isExiting]);\r\n\r\n    // Independent Entry Animation (Only once when connections change)\r\n    useEffect(() => {\r\n        if (!connections.length) return;\r\n        const startTime = performance.now();\r\n        const duration = 600;\r\n        const animate = (now: number) => {\r\n            const progress = Math.min((now - startTime) / duration, 1);\r\n            setAnimationProgress(progress);\r\n            if (progress < 1) requestAnimationFrame(animate);\r\n        };\r\n        requestAnimationFrame(animate);\r\n    }, [connections]);\r\n\r\n    // Generate cubic bezier curve path with 3D perspective awareness\r\n    const getWirePath = useCallback((wire: WirePosition, progress: number = 1): string => {\r\n        const { sourceX, sourceY, targetX, targetY, targetScale } = wire;\r\n\r\n        const dx = targetX - sourceX;\r\n        const dy = targetY - sourceY;\r\n        const dist = Math.sqrt(dx * dx + dy * dy);\r\n\r\n        // Control points should scale with the distance AND the perspective\r\n        // Cap the bulge complexity to avoid extreme offsets at high zoom\r\n        const curveComplexity = Math.min(dist * 0.25, 300);\r\n        const offset = Math.max(20, curveComplexity) * targetScale;\r\n\r\n        const cp1x = sourceX + dx * 0.25;\r\n        const cp1y = sourceY + dy * 0.25 - offset;\r\n        const cp2x = sourceX + dx * 0.75;\r\n        const cp2y = sourceY + dy * 0.75 + offset;\r\n\r\n        // Animate the endpoint for the 'growing' effect\r\n        const endX = sourceX + dx * progress;\r\n        const endY = sourceY + dy * progress;\r\n\r\n        if (progress < 1) {\r\n            // During entry, use a simpler quadratic curve for speed\r\n            return `M ${sourceX} ${sourceY} Q ${cp1x} ${cp1y} ${endX} ${endY}`;\r\n        }\r\n\r\n        return `M ${sourceX} ${sourceY} C ${cp1x} ${cp1y} ${cp2x} ${cp2y} ${targetX} ${targetY}`;\r\n    }, []);\r\n\r\n    // Handle wire hover for tooltip - only show hover tooltip if nothing is locked\r\n    const handleWireMouseEnter = useCallback((wire: WirePosition) => {\r\n        // Clear any pending hide timer\r\n        if (wireHoverTimerRef.current) {\r\n            clearTimeout(wireHoverTimerRef.current);\r\n            wireHoverTimerRef.current = null;\r\n        }\r\n\r\n        if (!lockedWireIdRef.current) {\r\n            // Check if we are already hovering THIS wire to avoid redundant timer setting\r\n            const isSameWire = hoveredWireRef.current?.synergy.buildName === wire.synergy.buildName &&\r\n                hoveredWireRef.current?.targetType === wire.targetType;\r\n\r\n            if (isSameWire) return;\r\n\r\n            // FLUIDITY: Delay showing the new wire\r\n            if (wireShowTimerRef.current) {\r\n                clearTimeout(wireShowTimerRef.current);\r\n            }\r\n\r\n            wireShowTimerRef.current = setTimeout(() => {\r\n                setHoveredWireId({ buildName: wire.synergy.buildName, targetType: wire.targetType });\r\n                onWireHoverChange?.(true);\r\n                // Notify parent of which wire targets are being hovered\r\n                onWireHover?.({\r\n                    armorInstanceId: wire.armorResult?.item.itemInstanceId || null,\r\n                    weaponInstanceId: wire.weaponResult?.item.itemInstanceId || null\r\n                });\r\n                wireShowTimerRef.current = null;\r\n            }, 200); // 200ms delay\r\n        }\r\n    }, [onWireHoverChange, onWireHover]);\r\n\r\n    const handleWireMouseLeave = useCallback(() => {\r\n        if (!lockedWireIdRef.current) {\r\n            // FLUIDITY: Cancel pending show if we leave before it triggers\r\n            if (wireShowTimerRef.current) {\r\n                clearTimeout(wireShowTimerRef.current);\r\n                wireShowTimerRef.current = null;\r\n            }\r\n\r\n            // Hysteresis: Delay hiding to prevent flicker\r\n            wireHoverTimerRef.current = setTimeout(() => {\r\n                setHoveredWireId(null);\r\n                onWireHoverChange?.(false);\r\n                onWireHover?.(null);\r\n                wireHoverTimerRef.current = null;\r\n            }, 150);\r\n        }\r\n    }, [onWireHoverChange, onWireHover]);\r\n\r\n    const handleTooltipMouseLeave = useCallback(() => {\r\n        // Don't hide tooltip on mouse leave if it's locked\r\n        if (!lockedWireIdRef.current) {\r\n            // Hysteresis: Delay hiding to prevent flicker when moving back to wire\r\n            if (wireHoverTimerRef.current) {\r\n                clearTimeout(wireHoverTimerRef.current);\r\n            }\r\n            wireHoverTimerRef.current = setTimeout(() => {\r\n                setHoveredWireId(null);\r\n                onWireHoverChange?.(false);\r\n                onWireHover?.(null);\r\n                wireHoverTimerRef.current = null;\r\n            }, 150);\r\n        }\r\n    }, [onWireHoverChange, onWireHover]);\r\n\r\n    const handleTooltipMouseEnter = useCallback(() => {\r\n        // Clear any pending hide timer\r\n        if (wireHoverTimerRef.current) {\r\n            clearTimeout(wireHoverTimerRef.current);\r\n            wireHoverTimerRef.current = null;\r\n        }\r\n\r\n        const activeWire = lockedWire || hoveredWireRef.current;\r\n        if (activeWire) {\r\n            setHoveredWireId({ buildName: activeWire.synergy.buildName, targetType: activeWire.targetType });\r\n            // RE-NOTIFY isolation state when entering tooltip to ensure it stays active\r\n            // This prevents \"clumping\" from resetting when mouse moves from wire to tooltip\r\n            onWireHover?.({\r\n                armorInstanceId: activeWire.armorResult?.item.itemInstanceId || null,\r\n                weaponInstanceId: activeWire.weaponResult?.item.itemInstanceId || null\r\n            });\r\n        }\r\n        onWireHoverChange?.(true);\r\n    }, [onWireHoverChange, onWireHover, lockedWire]);\r\n\r\n    // Handle click on end node to lock/unlock tooltip\r\n    const handleEndNodeClick = useCallback((wire: WirePosition) => {\r\n        debugLog('SynergyWeb', `End node click: ${wire.targetType}`, wire);\r\n        const wireId = { buildName: wire.synergy.buildName, targetType: wire.targetType };\r\n        const isAlreadyLocked = lockedWireIdRef.current?.buildName === wireId.buildName &&\r\n            lockedWireIdRef.current?.targetType === wireId.targetType;\r\n\r\n        if (isAlreadyLocked) {\r\n            // Clicking the same node unlocks it\r\n            setLockedWireId(null);\r\n            setHoveredWireId(null);\r\n            onWireHoverChange?.(false);\r\n            onWireHover?.(null); // Clear the hovered wire info\r\n            onWireLock?.(null); // Notify parent to reset zoom\r\n        } else {\r\n            // Lock this wire's tooltip by storing its identifier\r\n            setLockedWireId(wireId);\r\n            setHoveredWireId(wireId);\r\n            onWireHoverChange?.(true);\r\n            // Notify parent which items are part of this locked wire (so they stay visible)\r\n            onWireHover?.({\r\n                armorInstanceId: wire.armorResult?.item.itemInstanceId || null,\r\n                weaponInstanceId: wire.weaponResult?.item.itemInstanceId || null\r\n            });\r\n            // Notify parent to zoom to this item\r\n            const itemInstanceId = wire.targetType === 'armor'\r\n                ? wire.armorResult?.item.itemInstanceId\r\n                : wire.weaponResult?.item.itemInstanceId;\r\n            debugLog('SynergyWeb', `Calling onWireLock: ${itemInstanceId}`);\r\n            onWireLock?.(itemInstanceId || null);\r\n        }\r\n    }, [onWireHoverChange, onWireHover, onWireLock]);\r\n\r\n    // Handle clicking outside to unlock tooltip\r\n    const handleBackgroundClick = useCallback(() => {\r\n        if (lockedWireIdRef.current) {\r\n            setLockedWireId(null);\r\n            setHoveredWireId(null);\r\n            onWireHoverChange?.(false);\r\n            onWireHover?.(null); // Clear the hovered wire info\r\n            onWireLock?.(null); // Notify parent to reset zoom\r\n        }\r\n    }, [onWireHoverChange, onWireHover, onWireLock]);\r\n\r\n    const handleConfirmBuild = useCallback((synergy: DashboardSynergy) => {\r\n        setConfirmedSynergy(synergy);\r\n        setHoveredWireId(null);\r\n        onWireHoverChange?.(false);\r\n        if (onSynergyOverlayChange) {\r\n            onSynergyOverlayChange(true, synergy);\r\n        }\r\n    }, [onWireHoverChange, onSynergyOverlayChange]);\r\n\r\n    const handleCloseOverlay = useCallback(() => {\r\n        setConfirmedSynergy(null);\r\n        if (onSynergyOverlayChange) {\r\n            onSynergyOverlayChange(false, null);\r\n        }\r\n    }, [onSynergyOverlayChange]);\r\n\r\n    const renderSynergyTooltip = useCallback((wire: WirePosition | null) => {\r\n        if (!wire) return null;\r\n        const tooltipId = `synergy-wire-${wire.synergy.buildName}-${wire.synergy.armor}-${wire.synergy.weapon}`;\r\n\r\n        return (\r\n            <div className=\"synergy-web__combined-tooltip\" onMouseEnter={handleTooltipMouseEnter} onMouseLeave={handleTooltipMouseLeave}>\r\n                <div className=\"synergy-web__combined-tooltip-items\">\r\n                    {wire.armorResult?.item && (\r\n                        <div className=\"synergy-web__combined-tooltip-item\">\r\n                            <RichTooltip\r\n                                key={`${tooltipId}-armor`}\r\n                                item={wire.armorResult.item}\r\n                                instance={wire.armorResult.item.itemInstanceId ? itemInstances[wire.armorResult.item.itemInstanceId] : undefined}\r\n                                inline\r\n                                followMouse={false}\r\n                                hideZoomButtons={false}\r\n                                clickActionLabel=\"Confirm Synergy\"\r\n                                onClick={() => handleConfirmBuild(wire.synergy)}\r\n                                hideSynergizeAction={true}\r\n                            />\r\n                        </div>\r\n                    )}\r\n                    {wire.weaponResult?.item && (\r\n                        <div className=\"synergy-web__combined-tooltip-item\">\r\n                            <RichTooltip\r\n                                key={`${tooltipId}-weapon`}\r\n                                item={wire.weaponResult.item}\r\n                                instance={wire.weaponResult.item.itemInstanceId ? itemInstances[wire.weaponResult.item.itemInstanceId] : undefined}\r\n                                inline\r\n                                followMouse={false}\r\n                                hideZoomButtons={false}\r\n                                onClick={() => handleConfirmBuild(wire.synergy)}\r\n                                hideSynergizeAction={true}\r\n                            />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        );\r\n    }, [handleTooltipMouseEnter, handleTooltipMouseLeave, itemInstances, handleConfirmBuild]);\r\n\r\n    // Handle wire click - now just locks the tooltip (original behavior preserved via onWireClick if needed)\r\n    const handleWireClick = useCallback((wire: WirePosition) => {\r\n        // Lock the tooltip on click\r\n        handleEndNodeClick(wire);\r\n        // Also call the original callback if provided\r\n        if (onWireClick) {\r\n            onWireClick(wire.synergy);\r\n        }\r\n    }, [onWireClick, handleEndNodeClick]);\r\n\r\n    // Handle escape to close - first unlock tooltip, then close synergy web\r\n    useEffect(() => {\r\n        const handleKeyDown = (e: KeyboardEvent) => {\r\n            if (e.key === 'Escape') {\r\n                // If tooltip is locked, unlock it first\r\n                if (lockedWireIdRef.current) {\r\n                    setLockedWireId(null);\r\n                    setHoveredWireId(null);\r\n                    onWireHoverChange?.(false);\r\n                    onWireHover?.(null); // Clear the hovered wire info\r\n                    onWireLock?.(null); // Notify parent to reset zoom\r\n                    return; // Don't close the synergy web yet\r\n                }\r\n                // Otherwise close the synergy web\r\n                if (onClose) {\r\n                    onClose();\r\n                }\r\n            }\r\n        };\r\n\r\n        window.addEventListener('keydown', handleKeyDown);\r\n        return () => window.removeEventListener('keydown', handleKeyDown);\r\n    }, [onClose, onWireHoverChange, onWireHover, onWireLock]);\r\n\r\n    if (!wires.length) {\r\n        return null;\r\n    }\r\n\r\n    // Group wires by element for gradient generation\r\n    const wiresByElement = wires.reduce((acc, wire) => {\r\n        if (!acc[wire.element]) {\r\n            acc[wire.element] = [];\r\n        }\r\n        acc[wire.element].push(wire);\r\n        return acc;\r\n    }, {} as Record<string, WirePosition[]>);\r\n\r\n    // Determine which wire to display - locked takes precedence over hovered\r\n    const displayedWire = lockedWire || hoveredWire;\r\n\r\n    return (\r\n        <div className=\"synergy-web\" onClick={handleBackgroundClick}>\r\n            <svg\r\n                ref={svgRef}\r\n                className=\"synergy-web__svg\"\r\n                style={{ width: '100%', height: '100%', position: 'absolute', top: 0, left: 0, pointerEvents: 'auto' }}\r\n            >\r\n                <defs>\r\n                    {/* Solar - Burning flame effect with multiple glow layers */}\r\n                    <filter id=\"glow-solar\" x=\"-100%\" y=\"-100%\" width=\"300%\" height=\"300%\">\r\n                        <feGaussianBlur stdDeviation=\"3\" result=\"blur1\" />\r\n                        <feGaussianBlur stdDeviation=\"8\" result=\"blur2\" />\r\n                        <feColorMatrix in=\"blur2\" type=\"matrix\" values=\"\r\n                            1.2 0 0 0 0\r\n                            0.8 0 0 0 0\r\n                            0 0 0 0 0\r\n                            0 0 0 1 0\" result=\"orangeGlow\" />\r\n                        <feMerge>\r\n                            <feMergeNode in=\"orangeGlow\" />\r\n                            <feMergeNode in=\"blur1\" />\r\n                            <feMergeNode in=\"SourceGraphic\" />\r\n                        </feMerge>\r\n                    </filter>\r\n\r\n                    {/* Arc - Electric crackling with displacement */}\r\n                    <filter id=\"glow-arc\" x=\"-100%\" y=\"-100%\" width=\"300%\" height=\"300%\">\r\n                        <feTurbulence type=\"fractalNoise\" baseFrequency=\"2\" numOctaves=\"2\" result=\"noise\" seed=\"1\" />\r\n                        <feDisplacementMap in=\"SourceGraphic\" in2=\"noise\" scale=\"1.5\" result=\"displacement\" />\r\n                        <feGaussianBlur in=\"displacement\" stdDeviation=\"2\" result=\"blur\" />\r\n                        <feColorMatrix in=\"blur\" type=\"matrix\" values=\"\r\n                            0.5 0 0 0 0\r\n                            0.8 0 0 0 0\r\n                            1 0 0 0 0\r\n                            0 0 0 1 0\" result=\"cyanGlow\" />\r\n                        <feMerge>\r\n                            <feMergeNode in=\"cyanGlow\" />\r\n                            <feMergeNode in=\"SourceGraphic\" />\r\n                        </feMerge>\r\n                    </filter>\r\n\r\n                    {/* Void - Standard glow */}\r\n                    <filter id=\"glow-void\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\r\n                        <feGaussianBlur stdDeviation=\"4\" result=\"blur\" />\r\n                        <feMerge>\r\n                            <feMergeNode in=\"blur\" />\r\n                            <feMergeNode in=\"SourceGraphic\" />\r\n                        </feMerge>\r\n                    </filter>\r\n\r\n                    {/* Stasis - Crystalline ice with sharp edges */}\r\n                    <filter id=\"glow-stasis\" x=\"-80%\" y=\"-80%\" width=\"260%\" height=\"260%\">\r\n                        <feGaussianBlur stdDeviation=\"1\" result=\"blur1\" />\r\n                        <feGaussianBlur stdDeviation=\"4\" result=\"blur2\" />\r\n                        <feColorMatrix in=\"blur2\" type=\"matrix\" values=\"\r\n                            0.3 0 0 0 0\r\n                            0.5 0 0 0 0\r\n                            1 0 0 0 0.2\r\n                            0 0 0 1 0\" result=\"iceGlow\" />\r\n                        <feMerge>\r\n                            <feMergeNode in=\"iceGlow\" />\r\n                            <feMergeNode in=\"blur1\" />\r\n                            <feMergeNode in=\"SourceGraphic\" />\r\n                        </feMerge>\r\n                    </filter>\r\n\r\n                    {/* Strand - Standard glow */}\r\n                    <filter id=\"glow-strand\" x=\"-50%\" y=\"-50%\" width=\"200%\" height=\"200%\">\r\n                        <feGaussianBlur stdDeviation=\"4\" result=\"blur\" />\r\n                        <feMerge>\r\n                            <feMergeNode in=\"blur\" />\r\n                            <feMergeNode in=\"SourceGraphic\" />\r\n                        </feMerge>\r\n                    </filter>\r\n\r\n                    {/* Prismatic - Pink with rainbow shimmer */}\r\n                    <filter id=\"glow-prismatic\" x=\"-100%\" y=\"-100%\" width=\"300%\" height=\"300%\">\r\n                        <feGaussianBlur stdDeviation=\"5\" result=\"blur1\" />\r\n                        <feGaussianBlur stdDeviation=\"10\" result=\"blur2\" />\r\n                        <feColorMatrix in=\"blur1\" type=\"matrix\" values=\"\r\n                            1 0 0 0 0.3\r\n                            0.5 0 0 0 0\r\n                            1 0 0 0 0.4\r\n                            0 0 0 1 0\" result=\"pinkGlow\" />\r\n                        <feColorMatrix in=\"blur2\" type=\"matrix\" values=\"\r\n                            1 0 0 0 0.4\r\n                            0.8 0 0 0 0.2\r\n                            0.6 0 0 0 0\r\n                            0 0 0 0.5 0\" result=\"rainbowGlow\" />\r\n                        <feMerge>\r\n                            <feMergeNode in=\"rainbowGlow\" />\r\n                            <feMergeNode in=\"pinkGlow\" />\r\n                            <feMergeNode in=\"SourceGraphic\" />\r\n                        </feMerge>\r\n                    </filter>\r\n\r\n                    <linearGradient id=\"prismatic-gradient\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"0%\">\r\n                        <stop offset=\"0%\" stopColor=\"#ff8df6\" />\r\n                        <stop offset=\"100%\" stopColor=\"#eecc44\" />\r\n                    </linearGradient>\r\n\r\n                    {/* Dynamic gradients for each wire fade */}\r\n                    {Object.entries(wiresByElement).map(([element, elementalWires]) =>\r\n                        elementalWires.map((wire, index) => {\r\n                            const gradId = `fade-${element}-${index}`;\r\n                            // Determine source for gradient based on whether there's a hub\r\n                            const hasHub = wire.hubX !== undefined && wire.hubY !== undefined;\r\n                            const sx = hasHub ? wire.hubX! : wire.sourceX;\r\n                            const sy = hasHub ? wire.hubY! : wire.sourceY;\r\n                            const tx = wire.targetX;\r\n                            const ty = wire.targetY;\r\n                            const wireColor = ELEMENT_COLORS[element] || '#fff';\r\n                            const stopColor = wireColor; // USER REQUEST: No dual colors. Stop at same color.\r\n\r\n                            return (\r\n                                <linearGradient\r\n                                    key={gradId}\r\n                                    id={gradId}\r\n                                    gradientUnits=\"userSpaceOnUse\"\r\n                                    x1={sx} y1={sy}\r\n                                    x2={tx} y2={ty}\r\n                                >\r\n                                    {/* Light traveling through space - bright at source, fading into distance */}\r\n                                    <stop offset=\"0%\" stopColor={wireColor} stopOpacity={1} />\r\n                                    <stop offset=\"30%\" stopColor={wireColor} stopOpacity={0.7} />\r\n                                    <stop offset=\"100%\" stopColor={stopColor} stopOpacity={0.2} />\r\n                                </linearGradient>\r\n                            );\r\n                        })\r\n                    )}\r\n                </defs>\r\n\r\n                {/* Group wires by element to render shared Hub-to-Source \"trunks\" */}\r\n                {Object.keys(ELEMENT_COLORS).map(element => {\r\n                    const elementalWires = wires.filter(w => w.element === element);\r\n                    if (elementalWires.length === 0) return null;\r\n\r\n                    const firstWire = elementalWires[0];\r\n                    const hasHub = firstWire.hubX !== undefined && firstWire.hubY !== undefined;\r\n                    // Calculate average hub positions and source positions\r\n                    const sourceX = firstWire.sourceX;\r\n                    const sourceY = firstWire.sourceY;\r\n                    const sourceScale = firstWire.sourceScale;\r\n                    const hubX = firstWire.hubX ?? sourceX;\r\n                    const hubY = firstWire.hubY ?? sourceY;\r\n                    const hubScale = firstWire.hubScale ?? sourceScale;\r\n                    const hubOpacity = firstWire.hubOpacity ?? 1;\r\n\r\n                    return (\r\n                        <g key={`element-group-${element}`}>\r\n                            {/* Shared \"Trunk\": Source -> Hub (Tapered) */}\r\n                            {hasHub && (\r\n                                <g style={{ opacity: hubOpacity }}>\r\n                                    {null}\r\n                                </g>\r\n                            )}\r\n\r\n                            {/* Individual Wires: Hub -> Target */}\r\n                            {elementalWires.map((wire, index) => {\r\n                                // Entry animation: wires grow from source\r\n                                const entryProgress = Math.min(1, animationProgress * wires.length / (index + 1));\r\n                                // Combined with exit animation\r\n                                const wireProgress = entryProgress * exitProgress;\r\n                                const isHovered = hoveredWire === wire;\r\n                                // Check if ANY wire is being hovered (for dimming non-hovered wires)\r\n                                const anyWireHovered = hoveredWire !== null;\r\n\r\n                                // If we have a hub, use it as the source for this segment\r\n                                const segmentSourceX = hasHub ? hubX : sourceX;\r\n                                const segmentSourceY = hasHub ? hubY : sourceY;\r\n                                const segmentSourceScale = hasHub ? hubScale : sourceScale;\r\n\r\n                                // Apply exit fade to opacity\r\n                                // When any wire is hovered, dim non-hovered wires significantly\r\n                                let opacity = wire.targetOpacityActual * exitProgress;\r\n                                if (anyWireHovered && !isHovered) {\r\n                                    opacity *= 0.1; // Dim non-hovered wires\r\n                                }\r\n\r\n                                return (\r\n                                    <g key={`${wire.synergy.buildName}-${wire.targetType}-${index}`} style={{ opacity }}>\r\n                                        {/* OPTIMIZED: Calculate path once for both hit-test and visual */}\r\n                                        {(() => {\r\n                                            const wirePath = getWirePath({\r\n                                                ...wire,\r\n                                                sourceX: segmentSourceX,\r\n                                                sourceY: segmentSourceY,\r\n                                                sourceScale: segmentSourceScale\r\n                                            }, 1);\r\n\r\n                                            return (\r\n                                                <>\r\n                                                    {/* 1. HIT PATH REMOVED - User requested only points be interactive */}\r\n\r\n                                                    {/* 2. Circular hitbox at the target node (end of wire) */}\r\n                                                    <circle\r\n                                                        cx={wire.targetX}\r\n                                                        cy={wire.targetY}\r\n                                                        r={Math.max(0, 50 * wire.targetScale)}\r\n                                                        fill=\"transparent\"\r\n                                                        style={{ cursor: 'pointer', pointerEvents: 'fill' }}\r\n                                                        onPointerEnter={() => handleWireMouseEnter(wire)}\r\n                                                        onPointerLeave={handleWireMouseLeave}\r\n                                                        onClick={(e) => {\r\n                                                            e.stopPropagation(); // Prevent background click handler\r\n                                                            handleWireClick(wire);\r\n                                                        }}\r\n                                                    />\r\n\r\n                                                    {/* 3. Visual Wires */}\r\n                                                    {wireProgress === 1 && (() => {\r\n                                                        const baseWidth = isHovered ? 1.2 : 0.6;\r\n                                                        const isIsolating = !!(hoveredWireId || lockedWireId);\r\n                                                        const isThisWireActive = isHovered || (lockedWireId?.buildName === wire.synergy.buildName && lockedWireId?.targetType === wire.targetType);\r\n\r\n                                                        let baseOpacity = isHovered ? 0.6 : 0.4;\r\n                                                        if (isIsolating && !isThisWireActive) {\r\n                                                            baseOpacity *= 0.15; // Aggressively dim non-active wires\r\n                                                        }\r\n\r\n                                                        switch (wire.element) {\r\n                                                            case 'solar':\r\n                                                                return (\r\n                                                                    <>\r\n                                                                        <path d={wirePath} stroke=\"#ff8800\" strokeWidth={baseWidth * 3} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.3} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#ffaa00\" strokeWidth={baseWidth * 2} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.5} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#ff6600\" strokeWidth={baseWidth} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity} style={{ pointerEvents: 'none' }} />\r\n                                                                    </>\r\n                                                                );\r\n                                                            case 'arc':\r\n                                                                return (\r\n                                                                    <>\r\n                                                                        <path d={wirePath} stroke=\"#00d4ff\" strokeWidth={baseWidth * 2.5} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.4} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#88f0ff\" strokeWidth={baseWidth * 1.5} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.6} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#00ffff\" strokeWidth={baseWidth} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity} style={{ pointerEvents: 'none' }} />\r\n                                                                    </>\r\n                                                                );\r\n                                                            case 'stasis':\r\n                                                                return (\r\n                                                                    <>\r\n                                                                        <path d={wirePath} stroke=\"#2266ff\" strokeWidth={baseWidth * 2} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.5} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#66aaff\" strokeWidth={baseWidth * 1.2} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.7} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#aaddff\" strokeWidth={baseWidth * 0.8} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity} style={{ pointerEvents: 'none' }} />\r\n                                                                    </>\r\n                                                                );\r\n                                                            case 'void':\r\n                                                                return (\r\n                                                                    <>\r\n                                                                        <path d={wirePath} stroke=\"#6600cc\" strokeWidth={baseWidth * 3} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.4} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#9933ff\" strokeWidth={baseWidth * 2} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.6} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#cc66ff\" strokeWidth={baseWidth} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity} style={{ pointerEvents: 'none' }} />\r\n                                                                    </>\r\n                                                                );\r\n                                                            case 'prismatic':\r\n                                                                return (\r\n                                                                    <>\r\n                                                                        <path d={wirePath} stroke=\"#ff66dd\" strokeWidth={baseWidth * 3} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.3} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#ff88ee\" strokeWidth={baseWidth * 2} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.5} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#ffaaff\" strokeWidth={baseWidth * 1.5} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.7} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke=\"#ff6be8\" strokeWidth={baseWidth} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity} style={{ pointerEvents: 'none' }} />\r\n                                                                    </>\r\n                                                                );\r\n                                                            default:\r\n                                                                return (\r\n                                                                    <>\r\n                                                                        <path d={wirePath} stroke={ELEMENT_COLORS[wire.element]} strokeWidth={baseWidth * 2} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity * 0.5} style={{ pointerEvents: 'none' }} />\r\n                                                                        <path d={wirePath} stroke={ELEMENT_COLORS[wire.element]} strokeWidth={baseWidth} fill=\"none\" strokeLinecap=\"round\" opacity={baseOpacity} style={{ pointerEvents: 'none' }} />\r\n                                                                    </>\r\n                                                                );\r\n                                                        }\r\n                                                    })()}\r\n                                                </>\r\n                                            );\r\n                                        })()}\r\n\r\n                                        {/* Endpoint dots removed - pure particle effect only */}\r\n                                    </g>\r\n                                );\r\n                            })}\r\n                        </g>\r\n                    );\r\n                })}\r\n            </svg>\r\n\r\n            {/* Combined wire + item tooltip - shows locked or hovered wire */}\r\n            {displayedWire && (() => {\r\n                // Calculate tooltip position when locked\r\n                let tooltipStyle: React.CSSProperties;\r\n                if (lockedWire) {\r\n                    // Centered behind the item\r\n                    let posX = displayedWire.targetX;\r\n                    let posY = displayedWire.targetY - 40; // Shifted up slightly for balance\r\n\r\n                    // Boundary checks to keep on-screen vertically\r\n                    const tooltipHeight = 300;\r\n                    if (posY - tooltipHeight / 2 < 100) posY = 100 + tooltipHeight / 2;\r\n                    if (posY + tooltipHeight / 2 > window.innerHeight - 20) posY = window.innerHeight - 20 - tooltipHeight / 2;\r\n\r\n                    tooltipStyle = {\r\n                        left: `${posX}px`,\r\n                        top: `${posY}px`,\r\n                        bottom: 'auto',\r\n                        transform: 'translateY(-50%) translateX(-50%)' // Center it!\r\n                    };\r\n                } else {\r\n                    // When hovering, keep at bottom center\r\n                    tooltipStyle = {\r\n                        left: '50%',\r\n                        bottom: '40px',\r\n                        top: 'auto'\r\n                    };\r\n                }\r\n\r\n                return (\r\n                    <div\r\n                        className={`synergy-web__combined-tooltip-wrapper synergy-web__combined-tooltip-wrapper--${displayedWire.element}${lockedWire ? ' synergy-web__combined-tooltip-wrapper--locked' : ''}`}\r\n                        style={tooltipStyle}\r\n                        onClick={(e) => e.stopPropagation()} // Prevent background click from closing when clicking tooltip\r\n                        onMouseEnter={() => {\r\n                            // KEEP OPEN: Clear any pending hide timer\r\n                            if (wireHoverTimerRef.current) {\r\n                                clearTimeout(wireHoverTimerRef.current);\r\n                                wireHoverTimerRef.current = null;\r\n                            }\r\n                        }}\r\n                        onMouseLeave={handleWireMouseLeave} // Resume hide timer on leave\r\n                    >\r\n                        {renderSynergyTooltip(displayedWire)}\r\n                    </div>\r\n                );\r\n            })()}\r\n\r\n\r\n            {/* Full-screen synergy build overlay */}\r\n            {confirmedSynergy && (\r\n                <SynergyBuildOverlay\r\n                    synergy={confirmedSynergy}\r\n                    onClose={handleCloseOverlay}\r\n                    onEquip={(synergy) => {\r\n                        handleCloseOverlay(); // Close overlay first to show transmat animation\r\n                        // Trigger equip through parent if available\r\n                        if (onEquipSynergy) {\r\n                            onEquipSynergy(synergy);\r\n                        }\r\n                    }}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default SynergyWeb;\r\n","/**\r\n * Item Search Service\r\n * Searches for items across all inventory locations\r\n */\r\nimport { useProfileStore } from '../store';\r\nimport { manifestService } from './bungie/manifest.service';\r\nimport type { DestinyItem, ItemDefinition, GuardianClass } from '../types';\r\n\r\nexport interface ItemSearchResult {\r\n    item: DestinyItem;\r\n    definition: ItemDefinition;\r\n    location: 'equipped' | 'inventory' | 'vault';\r\n    characterId?: string;\r\n}\r\n\r\n// Cache for name -> hash lookups\r\nconst nameToHashCache = new Map<string, number>();\r\n\r\n/**\r\n * Normalize text for comparison - removes apostrophes, special chars\r\n */\r\nfunction normalizeForMatching(text: string): string {\r\n    return text\r\n        .toLowerCase()\r\n        .trim()\r\n        .replace(/['`]/g, '') // DIM Standard: Remove all types of apostrophes\r\n        .replace(/[^a-z0-9\\s]/g, '') // Remove special chars except spaces\r\n        .replace(/\\s+/g, ' '); // Normalize spaces\r\n}\r\n\r\n/**\r\n * Search for item hash by name using manifest (supports partial/fuzzy matching)\r\n */\r\nfunction findHashByName(itemName: string): number | undefined {\r\n    const searchName = normalizeForMatching(itemName);\r\n\r\n    // Check cache first\r\n    if (nameToHashCache.has(searchName)) {\r\n        return nameToHashCache.get(searchName);\r\n    }\r\n\r\n    // Search through player's inventory to find matching items by comparing names\r\n    const store = useProfileStore.getState();\r\n    const { characterEquipment, characterInventories, vaultInventory } = store;\r\n\r\n    // Collect all unique item hashes from player inventory with their names\r\n    const allItems = new Map<number, string>();\r\n\r\n    for (const equipment of Object.values(characterEquipment)) {\r\n        for (const item of equipment) {\r\n            const def = manifestService.getItem(item.itemHash);\r\n            if (def?.displayProperties?.name) {\r\n                allItems.set(item.itemHash, normalizeForMatching(def.displayProperties.name));\r\n            }\r\n        }\r\n    }\r\n\r\n    for (const inventory of Object.values(characterInventories)) {\r\n        for (const item of inventory) {\r\n            const def = manifestService.getItem(item.itemHash);\r\n            if (def?.displayProperties?.name) {\r\n                allItems.set(item.itemHash, normalizeForMatching(def.displayProperties.name));\r\n            }\r\n        }\r\n    }\r\n\r\n    for (const item of vaultInventory) {\r\n        const def = manifestService.getItem(item.itemHash);\r\n        if (def?.displayProperties?.name) {\r\n            allItems.set(item.itemHash, normalizeForMatching(def.displayProperties.name));\r\n        }\r\n    }\r\n\r\n    // 1. Try exact match first\r\n    for (const [hash, name] of allItems.entries()) {\r\n        if (name === searchName) {\r\n            nameToHashCache.set(searchName, hash);\r\n            return hash;\r\n        }\r\n    }\r\n\r\n    // 2. Try \"starts with\" match\r\n    for (const [hash, name] of allItems.entries()) {\r\n        if (name.startsWith(searchName)) {\r\n            nameToHashCache.set(searchName, hash);\r\n            return hash;\r\n        }\r\n    }\r\n\r\n    // 3. Try word match\r\n    if (searchName.length >= 3) {\r\n        for (const [hash, name] of allItems.entries()) {\r\n            const words = name.split(/\\s+/);\r\n            const matched = words.some(word => word.startsWith(searchName));\r\n            if (matched) {\r\n                nameToHashCache.set(searchName, hash);\r\n                return hash;\r\n            }\r\n        }\r\n    }\r\n\r\n    // 4. Try fuzzy contains match\r\n    if (searchName.length >= 4) {\r\n        for (const [hash, name] of allItems.entries()) {\r\n            if (name.includes(searchName)) {\r\n                nameToHashCache.set(searchName, hash);\r\n                return hash;\r\n            }\r\n        }\r\n    }\r\n\r\n    return undefined;\r\n}\r\n\r\n/**\r\n * Find an item by hash across all locations\r\n * DIM STANDARD: Prioritize currently selected character, then others, then vault.\r\n */\r\nexport async function findItemByHash(itemHash: number): Promise<ItemSearchResult | null> {\r\n    const store = useProfileStore.getState();\r\n    const { characterInventories, characterEquipment, vaultInventory, selectedCharacterId } = store;\r\n\r\n    const def = manifestService.getItem(itemHash);\r\n    if (!def) return null;\r\n\r\n    // 1. Check Selected Character FIRST (Priority 1: No transfer needed)\r\n    if (selectedCharacterId) {\r\n        const eq = characterEquipment[selectedCharacterId] || [];\r\n        const inv = characterInventories[selectedCharacterId] || [];\r\n        \r\n        const foundEq = eq.find(i => i.itemHash === itemHash);\r\n        if (foundEq) return { item: foundEq, definition: def, location: 'equipped', characterId: selectedCharacterId };\r\n        \r\n        const foundInv = inv.find(i => i.itemHash === itemHash);\r\n        if (foundInv) return { item: foundInv, definition: def, location: 'inventory', characterId: selectedCharacterId };\r\n    }\r\n\r\n    // 2. Check Other Characters (Priority 2: 2 transfers needed)\r\n    for (const [charId, equipment] of Object.entries(characterEquipment)) {\r\n        if (charId === selectedCharacterId) continue;\r\n        const found = equipment.find(item => item.itemHash === itemHash);\r\n        if (found) return { item: found, definition: def, location: 'equipped', characterId: charId };\r\n    }\r\n\r\n    for (const [charId, inventory] of Object.entries(characterInventories)) {\r\n        if (charId === selectedCharacterId) continue;\r\n        const found = inventory.find(item => item.itemHash === itemHash);\r\n        if (found) return { item: found, definition: def, location: 'inventory', characterId: charId };\r\n    }\r\n\r\n    // 3. Check Vault (Priority 3: 1 transfer needed)\r\n    const vaultItem = vaultInventory.find(item => item.itemHash === itemHash);\r\n    if (vaultItem) return { item: vaultItem, definition: def, location: 'vault' };\r\n\r\n    return null;\r\n}\r\n\r\n/**\r\n * Find an exotic item by name across all locations\r\n */\r\nexport async function findItemByName(itemName: string): Promise<ItemSearchResult | null> {\r\n    const targetHash = findHashByName(itemName);\r\n    if (!targetHash) {\r\n        return null;\r\n    }\r\n\r\n    // Use findItemByHash to avoid duplicating search logic\r\n    return findItemByHash(targetHash);\r\n}\r\n\r\n/**\r\n * Find all copies of an item by name\r\n */\r\nexport async function findAllItemsByName(itemName: string): Promise<ItemSearchResult[]> {\r\n    const store = useProfileStore.getState();\r\n    const { characterInventories, characterEquipment, vaultInventory } = store;\r\n    const results: ItemSearchResult[] = [];\r\n\r\n    const targetHash = findHashByName(itemName);\r\n    if (!targetHash) return results;\r\n\r\n    const def = manifestService.getItem(targetHash);\r\n    if (!def) return results;\r\n\r\n    // Equipped\r\n    for (const [charId, equipment] of Object.entries(characterEquipment)) {\r\n        for (const item of equipment) {\r\n            if (item.itemHash === targetHash) {\r\n                results.push({ item, definition: def, location: 'equipped', characterId: charId });\r\n            }\r\n        }\r\n    }\r\n\r\n    // Inventory\r\n    for (const [charId, inventory] of Object.entries(characterInventories)) {\r\n        for (const item of inventory) {\r\n            if (item.itemHash === targetHash) {\r\n                results.push({ item, definition: def, location: 'inventory', characterId: charId });\r\n            }\r\n        }\r\n    }\r\n\r\n    // Vault\r\n    for (const item of vaultInventory) {\r\n        if (item.itemHash === targetHash) {\r\n            results.push({ item, definition: def, location: 'vault' });\r\n        }\r\n    }\r\n\r\n    return results;\r\n}\r\n\r\n/**\r\n * Find all exotic armor for a specific class\r\n */\r\nexport async function findAllExoticsForClass(\r\n    guardianClass: GuardianClass,\r\n    bucketChoice: 'armor' | 'weapon' = 'armor'\r\n): Promise<ItemSearchResult[]> {\r\n    const store = useProfileStore.getState();\r\n    const { characterInventories, characterEquipment, vaultInventory } = store;\r\n    const results: ItemSearchResult[] = [];\r\n\r\n    const processItem = (item: DestinyItem, location: 'equipped' | 'inventory' | 'vault', charId?: string) => {\r\n        const def = manifestService.getItem(item.itemHash);\r\n        if (!def) return;\r\n\r\n        // Check if Exotic\r\n        // TierType 6 = Exotic\r\n        if (def.inventory?.tierType !== 6) return;\r\n\r\n        // Check Type (Armor vs Weapon)\r\n        // ItemType 2 = Armor, 3 = Weapon\r\n        const expectedType = bucketChoice === 'armor' ? 2 : 3;\r\n        if (def.itemType !== expectedType) return;\r\n\r\n        // Check Class (0=Titan, 1=Hunter, 2=Warlock, 3=Unknown)\r\n        // If classType is 3, it's generic (like weapons or some armor), so we accept it unless it's class-specific armor\r\n        if (def.classType !== 3 && def.classType !== guardianClass) return;\r\n\r\n        results.push({ item, definition: def, location, characterId: charId });\r\n    };\r\n\r\n    // Equipped\r\n    for (const [charId, equipment] of Object.entries(characterEquipment)) {\r\n        equipment.forEach(item => processItem(item, 'equipped', charId));\r\n    }\r\n\r\n    // Inventory\r\n    for (const [charId, inventory] of Object.entries(characterInventories)) {\r\n        inventory.forEach(item => processItem(item, 'inventory', charId));\r\n    }\r\n\r\n    // Vault\r\n    vaultInventory.forEach(item => processItem(item, 'vault'));\r\n\r\n    return results;\r\n}\r\n\r\n/**\r\n * Check if player owns an item (in any location)\r\n */\r\nexport async function hasItem(itemName: string): Promise<boolean> {\r\n    const result = await findItemByName(itemName);\r\n    return result !== null;\r\n}\r\n\r\n/**\r\n * Clear the name-to-hash cache (call when manifest updates)\r\n */\r\nexport function clearItemSearchCache(): void {\r\n    nameToHashCache.clear();\r\n}\r\n\r\n/**\r\n * Find all copies of an item by name (Synchronous version for internal services)\r\n */\r\nexport function findAllItemsByNameSync(itemName: string): ItemSearchResult[] {\r\n    const store = useProfileStore.getState();\r\n    const { characterInventories, characterEquipment, vaultInventory } = store;\r\n    const results: ItemSearchResult[] = [];\r\n\r\n    const targetHash = findHashByName(itemName);\r\n    if (!targetHash) return results;\r\n\r\n    const def = manifestService.getItem(targetHash);\r\n    if (!def) return results;\r\n\r\n    // Equipped\r\n    for (const [charId, equipment] of Object.entries(characterEquipment)) {\r\n        for (const item of equipment) {\r\n            if (item.itemHash === targetHash) {\r\n                results.push({ item, definition: def, location: 'equipped', characterId: charId });\r\n            }\r\n        }\r\n    }\r\n\r\n    // Inventory\r\n    for (const [charId, inventory] of Object.entries(characterInventories)) {\r\n        for (const item of inventory) {\r\n            if (item.itemHash === targetHash) {\r\n                results.push({ item, definition: def, location: 'inventory', characterId: charId });\r\n            }\r\n        }\r\n    }\r\n\r\n    // Vault\r\n    for (const item of vaultInventory) {\r\n        if (item.itemHash === targetHash) {\r\n            results.push({ item, definition: def, location: 'vault' });\r\n        }\r\n    }\r\n\r\n    return results;\r\n}\r\n\r\nexport const itemSearchService = {\r\n    findItemByHash,\r\n    findItemByName,\r\n    findAllItemsByName,\r\n    findAllItemsByNameSync,\r\n    findAllExoticsForClass,\r\n    hasItem,\r\n    clearItemSearchCache\r\n};\r\n","// Synergy Definitions - Pre-built ability loops\r\nimport { ElementType, GuardianClass, ItemSlot, Difficulty, type SynergyDefinition, Expansion } from '../types';\r\nimport {\r\n  EXOTIC_ARMOR_TITAN,\r\n  EXOTIC_ARMOR_HUNTER,\r\n  EXOTIC_ARMOR_WARLOCK,\r\n  SUBCLASS_HASHES,\r\n  WEAPON_PERKS,\r\n  EXOTIC_WEAPONS,\r\n} from './item-hashes';\r\n\r\nexport const SYNERGY_DEFINITIONS: SynergyDefinition[] = [\r\n  // ===== TITAN SYNERGIES =====\r\n  {\r\n    id: 'titan-solar-sunspot-loop',\r\n    name: 'Sunspot Engine',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_TITAN.HALLOWFIRE_HEART,\r\n      name: 'Hallowfire Heart',\r\n      slot: ItemSlot.Chest,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.SUNSHOT,\r\n      name: 'Sunshot',\r\n    },\r\n    // Strict Requirement: Solar Grenade\r\n    requiredGrenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.TITAN.SUPER.HAMMER_OF_SOL,\r\n      superName: 'Hammer of Sol',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.SOL_INVICTUS,\r\n        SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.ROARING_FLAMES\r\n      ],\r\n      aspectNames: ['Sol Invictus', 'Roaring Flames'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SINGEING,\r\n      ],\r\n      fragmentNames: ['Ember of Solace', 'Ember of Empyrean', 'Ember of Ashes', 'Ember of Singeing'],\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.TITAN.GRENADES.THERMITE,\r\n      grenadeName: 'Thermite Grenade',\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.TITAN.MELEE.THROWING_HAMMER,\r\n      meleeName: 'Throwing Hammer',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.TITAN.CLASS_ABILITIES.RALLY_BARRICADE,\r\n      classAbilityName: 'Rally Barricade',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.TITAN.JUMPS.HIGH_LIFT,\r\n      jumpName: 'High Lift',\r\n    },\r\n    weaponPerk: {\r\n      perkHash: WEAPON_PERKS.INCANDESCENT,\r\n      perkName: 'Incandescent',\r\n      weaponTypes: ['SMG', 'Hand Cannon', 'Scout Rifle'],\r\n    },\r\n    loopDescription:\r\n      'Sunspots heal you and boost ability regen. Hallowfire Heart supercharges this when Super is full. Incandescent weapons spread scorch to create more Sunspots.',\r\n    playstyle:\r\n      'Hold your Super to maximize ability regen. Stand in Sunspots for healing. Use Throwing Hammer for easy Sunspot creation.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['survivability', 'ability-spam', 'solo-friendly', 'add-clear'],\r\n  }, {\r\n    id: 'titan-arc-thundercrash-dps',\r\n    name: 'Ballistic Missile',\r\n    element: ElementType.Arc,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.BeyondLight,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_TITAN.CUIRASS_OF_THE_FALLING_STAR,\r\n      name: 'Cuirass of the Falling Star',\r\n      slot: ItemSlot.Chest,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.POWER.THUNDERLORD,\r\n      name: 'Thunderlord',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.ARC.TITAN.SUPER.THUNDERCRASH,\r\n      superName: 'Thundercrash',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.ARC.TITAN.ASPECTS.TOUCH_OF_THUNDER,\r\n        SUBCLASS_HASHES.ARC.TITAN.ASPECTS.KNOCKOUT\r\n      ],\r\n      aspectNames: ['Touch of Thunder', 'Knockout'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_MAGNITUDE,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_SHOCK,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_IONS,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_RECHARGE,\r\n      ],\r\n      fragmentNames: ['Spark of Magnitude', 'Spark of Shock', 'Spark of Ions', 'Spark of Recharge'],\r\n      grenadeHash: SUBCLASS_HASHES.ARC.TITAN.GRENADES.STORM,\r\n      grenadeName: 'Storm Grenade',\r\n      meleeHash: SUBCLASS_HASHES.ARC.TITAN.MELEE.THUNDERCLAP,\r\n      meleeName: 'Thunderclap',\r\n      classAbilityHash: SUBCLASS_HASHES.ARC.TITAN.CLASS_ABILITIES.THRUSTER,\r\n      classAbilityName: 'Thruster',\r\n      jumpHash: SUBCLASS_HASHES.ARC.TITAN.JUMPS.HIGH_LIFT,\r\n      jumpName: 'High Lift',\r\n    },\r\n    loopDescription:\r\n      'Cuirass doubles Thundercrash damage and gives overshield on impact. Touch of Thunder enhances Storm Grenades for add clear between DPS phases.',\r\n    playstyle:\r\n      'Build Super quickly with orbs. Save for boss DPS. Storm Grenades roam and clear adds.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['boss-dps', 'burst-damage', 'endgame', 'simple'],\r\n  }, {\r\n    id: 'hunter-solar-knife-spam',\r\n    name: 'Blade Dancer',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.WitchQueen,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.CALIBAN_HAND,\r\n      name: \"Caliban's Hand\",\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.SUNSHOT,\r\n      name: 'Sunshot',\r\n    },\r\n    // Strict Requirement: Solar Grenade\r\n    requiredGrenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.HUNTER.SUPER.BLADE_BARRAGE,\r\n      superName: 'Blade Barrage',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.KNOCK_EM_DOWN,\r\n        SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.ON_YOUR_MARK\r\n      ],\r\n      aspectNames: [\"Knock 'Em Down\", 'On Your Mark'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR,\r\n      ],\r\n      fragmentNames: ['Ember of Torches', 'Ember of Solace', 'Ember of Ashes', 'Ember of Char'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.HUNTER.MELEE.KNIFE_TRICK,\r\n      meleeName: 'Knife Trick',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.HUNTER.GRENADES.TRIPMINE,\r\n      grenadeName: 'Tripmine Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.HUNTER.CLASS_ABILITIES.MARKSMANS_DODGE,\r\n      classAbilityName: \"Marksman's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    weaponPerk: {\r\n      perkHash: WEAPON_PERKS.INCANDESCENT,\r\n      perkName: 'Incandescent',\r\n      weaponTypes: ['Hand Cannon', 'SMG'],\r\n    },\r\n    loopDescription:\r\n      \"Proximity Knife ignites on hit. Caliban's Hand causes ignition explosions and refunds knife on scorched kills.\",\r\n    playstyle:\r\n      'Throw knives constantly. Kills refund the knife. Ignitions clear rooms. Knock Em Down extends duration.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['ability-spam', 'ignition', 'add-clear', 'fun'],\r\n  }, {\r\n    id: 'warlock-solar-starfire',\r\n    name: 'Grenade Battery',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.STARFIRE_PROTOCOL,\r\n      name: 'Starfire Protocol',\r\n      slot: ItemSlot.Chest,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.SUNSHOT,\r\n      name: 'Sunshot',\r\n    },\r\n    // Strict Requirement: Solar Grenade\r\n    requiredGrenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.WELL_OF_RADIANCE,\r\n      superName: 'Well of Radiance',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME,\r\n        SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.ICARUS_DASH\r\n      ],\r\n      aspectNames: ['Touch of Flame', 'Icarus Dash'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SINGEING,\r\n      ],\r\n      fragmentNames: ['Ember of Torches', 'Ember of Solace', 'Ember of Ashes', 'Ember of Singeing'],\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.FUSION,\r\n      grenadeName: 'Fusion Grenade',\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.CELESTIAL_FIRE,\r\n      meleeName: 'Celestial Fire',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.EMPOWERING_RIFT,\r\n      classAbilityName: 'Empowering Rift',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Fusion Grenades get two charges and deal bonus damage. Empowered weapon hits (Rift) recharge grenades. Touch of Flame makes them stronger.',\r\n    playstyle:\r\n      'Drop Rift, throw grenades, shoot boss, repeat. Two Fusion Grenades constantly available for huge DPS.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['boss-dps', 'grenade-spam', 'endgame', 'simple'],\r\n  }, {\r\n    id: 'titan-stasis-hoarfrost',\r\n    name: 'Glacial Wall',\r\n    element: ElementType.Stasis,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.WitchQueen,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_TITAN.HOARFROST_Z,\r\n      name: 'Hoarfrost-Z',\r\n      slot: ItemSlot.Chest,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.VERGLAS_CURVE,\r\n      name: 'Verglas Curve',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STASIS.TITAN.SUPER.GLACIAL_QUAKE,\r\n      superName: 'Glacial Quake',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.STASIS.TITAN.ASPECTS.TECTONIC_HARVEST,\r\n        SUBCLASS_HASHES.STASIS.TITAN.ASPECTS.HOWL_OF_THE_STORM,\r\n      ],\r\n      aspectNames: ['Tectonic Harvest', 'Howl of the Storm'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_SHARDS,\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_CHAINS,\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_RIME,\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_CONDUCTION,\r\n      ],\r\n      fragmentNames: ['Whisper of Shards', 'Whisper of Chains', 'Whisper of Rime', 'Whisper of Conduction'],\r\n      meleeHash: SUBCLASS_HASHES.STASIS.TITAN.MELEE.SHIVER_STRIKE,\r\n      meleeName: 'Shiver Strike',\r\n      grenadeHash: SUBCLASS_HASHES.STASIS.TITAN.GRENADES.GLACIER,\r\n      grenadeName: 'Glacier Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STASIS.TITAN.CLASS_ABILITIES.TOWERING_BARRICADE,\r\n      classAbilityName: 'Towering Barricade',\r\n      jumpHash: SUBCLASS_HASHES.STASIS.TITAN.JUMPS.HIGH_LIFT,\r\n      jumpName: 'High Lift',\r\n    },\r\n    playstyle:\r\n      'Barricade creates Stasis crystals. Destroy them for damage resist and shards. Be an immovable ice object.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['defensive', 'damage-resist', 'crystal-spam'],\r\n    loopDescription: 'Barricade creates Stasis crystals. Destroy them for damage resist and shards. Be an immovable ice object.',\r\n  },\r\n  {\r\n    id: 'titan-strand-abeyant',\r\n    name: 'Suspend King',\r\n    element: ElementType.Strand,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.Lightfall,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_TITAN.ABEYANT_LEAP,\r\n      name: 'Abeyant Leap',\r\n      slot: ItemSlot.Legs,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.LE_MONARQUE,\r\n      name: 'Le Monarque',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STRAND.TITAN.SUPER.BLADEFURY,\r\n      superName: 'Bladefury',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.STRAND.TITAN.ASPECTS.DRENGRS_LASH,\r\n        SUBCLASS_HASHES.STRAND.TITAN.ASPECTS.INTO_THE_FRAY,\r\n      ],\r\n      aspectNames: ['Drengrs Lash', 'Into the Fray'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_WARDING,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_MIND,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_CONTINUITY,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_GENERATION,\r\n      ],\r\n      fragmentNames: ['Thread of Warding', 'Thread of Mind', 'Thread of Continuity', 'Thread of Generation'],\r\n      meleeHash: SUBCLASS_HASHES.STRAND.TITAN.MELEE.FRENZIED_BLADE,\r\n      meleeName: 'Frenzied Blade',\r\n      grenadeHash: SUBCLASS_HASHES.STRAND.TITAN.GRENADES.SHACKLE,\r\n      grenadeName: 'Shackle Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STRAND.TITAN.CLASS_ABILITIES.RALLY_BARRICADE,\r\n      classAbilityName: 'Rally Barricade',\r\n      jumpHash: SUBCLASS_HASHES.STRAND.TITAN.JUMPS.HIGH_LIFT,\r\n      jumpName: 'High Lift',\r\n    },\r\n    playstyle:\r\n      'Barricade sends 3 suspending waves. Suspending enemies grants Woven Mail. Lock down the entire battlefield.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['crowd-control', 'suspend', 'woven-mail'],\r\n    loopDescription: 'Barricade sends 3 suspending waves. Suspending enemies grants Woven Mail. Lock down the entire battlefield.',\r\n  },\r\n\r\n  // ===== HUNTER EXPANSION =====\r\n  {\r\n    id: 'hunter-arc-shinobu',\r\n    name: 'Skip Spammer',\r\n    element: ElementType.Arc,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.SHINOBUS_VOW,\r\n      name: \"Shinobu's Vow\",\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.RISKRUNNER,\r\n      name: 'Riskrunner',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.ARC.HUNTER.SUPER.GATHERING_STORM,\r\n      superName: 'Gathering Storm',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.ARC.HUNTER.ASPECTS.FLOW_STATE,\r\n        SUBCLASS_HASHES.ARC.HUNTER.ASPECTS.LETHAL_CURRENT,\r\n      ],\r\n      aspectNames: ['Flow State', 'Lethal Current'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_SHOCK,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_IONS,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_DISCHARGE,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_RECHARGE,\r\n      ],\r\n      fragmentNames: ['Spark of Shock', 'Spark of Ions', 'Spark of Discharge', 'Spark of Recharge'],\r\n      grenadeHash: SUBCLASS_HASHES.ARC.HUNTER.GRENADES.SKIP,\r\n      grenadeName: 'Skip Grenade',\r\n      meleeHash: SUBCLASS_HASHES.ARC.HUNTER.MELEE.COMBINATION_BLOW,\r\n      meleeName: 'Combination Blow',\r\n      classAbilityHash: SUBCLASS_HASHES.ARC.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: \"Gambler's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.ARC.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    playstyle:\r\n      'Grenades improve tracking and refund energy on hit. Throw grenades, jolt enemies, repeat.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['grenade-spam', 'tracking', 'easy'],\r\n    loopDescription: 'Grenades improve tracking and refund energy on hit. Throw grenades, jolt enemies, repeat.',\r\n  },\r\n  {\r\n    id: 'hunter-stasis-bakris',\r\n    name: 'Void Shift',\r\n    element: ElementType.Stasis,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.BeyondLight,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.MASK_OF_BAKRIS,\r\n      name: 'Mask of Bakris',\r\n      slot: ItemSlot.Helmet,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.CLOUDSTRIKE,\r\n      name: 'Cloudstrike',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STASIS.HUNTER.SUPER.SILENCE_AND_SQUALL,\r\n      superName: 'Silence and Squall',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.STASIS.HUNTER.ASPECTS.TOUCH_OF_WINTER,\r\n        SUBCLASS_HASHES.STASIS.HUNTER.ASPECTS.WINTERS_SHROUD,\r\n      ],\r\n      aspectNames: ['Touch of Winter', 'Winters Shroud'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_HEDRONS,\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_REFRACTION,\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_DURANCE,\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_SHARDS,\r\n      ],\r\n      fragmentNames: ['Whisper of Hedrons', 'Whisper of Refraction', 'Whisper of Durance', 'Whisper of Shards'],\r\n      meleeHash: SUBCLASS_HASHES.STASIS.HUNTER.MELEE.WITHERING_BLADE,\r\n      meleeName: 'Withering Blade',\r\n      grenadeHash: SUBCLASS_HASHES.STASIS.HUNTER.GRENADES.DUSKFIELD,\r\n      grenadeName: 'Duskfield Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STASIS.HUNTER.CLASS_ABILITIES.MARKSMANS_DODGE,\r\n      classAbilityName: \"Marksman's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.STASIS.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    playstyle:\r\n      'Dodge teleports and boosts Arc/Stasis weapon damage. Use Cloudstrike or Arc weapons for huge burst damage.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['dps', 'burst-damage', 'teleport'],\r\n    loopDescription: 'Dodge teleports and boosts Arc/Stasis weapon damage. Use Cloudstrike or Arc weapons for huge burst damage.',\r\n  },\r\n  {\r\n    id: 'hunter-strand-cyrtarachne',\r\n    name: 'Woven Spider',\r\n    element: ElementType.Strand,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.Lightfall,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.CYRTARACHNE_FACADE,\r\n      name: \"Cyrtarachne's Facade\",\r\n      slot: ItemSlot.Helmet,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.QUICKSILVER_STORM,\r\n      name: 'Quicksilver Storm',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STRAND.HUNTER.SUPER.SILKSTRIKE,\r\n      superName: 'Silkstrike',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.STRAND.HUNTER.ASPECTS.WIDOWS_SILK,\r\n        SUBCLASS_HASHES.STRAND.HUNTER.ASPECTS.WHIRLING_MAELSTROM,\r\n      ],\r\n      aspectNames: ['Widows Silk', 'Whirling Maelstrom'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_WARDING,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_GENERATION,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_ASCENT,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_FURY,\r\n      ],\r\n      fragmentNames: ['Thread of Warding', 'Thread of Generation', 'Thread of Ascent', 'Thread of Fury'],\r\n      grenadeHash: SUBCLASS_HASHES.STRAND.HUNTER.GRENADES.GRAPPLE,\r\n      grenadeName: 'Grapple',\r\n      meleeHash: SUBCLASS_HASHES.STRAND.HUNTER.MELEE.THREADED_SPIKE,\r\n      meleeName: 'Threaded Spike',\r\n      classAbilityHash: SUBCLASS_HASHES.STRAND.HUNTER.CLASS_ABILITIES.MARKSMANS_DODGE,\r\n      classAbilityName: \"Marksman's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.STRAND.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    playstyle:\r\n      'Grappling gives Woven Mail. Swing around the arena safely. Creates tangles for Whirling Maelstrom.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['mobility', 'survivability', 'grapple'],\r\n    loopDescription: 'Grappling gives Woven Mail. Swing around the arena safely. Creates tangles for Whirling Maelstrom.',\r\n  },\r\n\r\n  // ===== WARLOCK EXPANSION =====\r\n  {\r\n    id: 'warlock-arc-crown',\r\n    name: 'Tempest King',\r\n    element: ElementType.Arc,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.CROWN_OF_TEMPESTS,\r\n      name: 'Crown of Tempests',\r\n      slot: ItemSlot.Helmet,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.RISKRUNNER,\r\n      name: 'Riskrunner',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.ARC.WARLOCK.SUPER.STORMTRANCE,\r\n      superName: 'Stormtrance',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.ARC.WARLOCK.ASPECTS.ELECTROSTATIC_MIND,\r\n        SUBCLASS_HASHES.ARC.WARLOCK.ASPECTS.LIGHTNING_SURGE,\r\n      ],\r\n      aspectNames: ['Electrostatic Mind', 'Lightning Surge'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_IONS,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_DISCHARGE,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_MAGNITUDE,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_SHOCK,\r\n      ],\r\n      fragmentNames: ['Spark of Ions', 'Spark of Discharge', 'Spark of Magnitude', 'Spark of Shock'],\r\n      grenadeHash: SUBCLASS_HASHES.ARC.WARLOCK.GRENADES.STORM,\r\n      grenadeName: 'Storm Grenade',\r\n      meleeHash: SUBCLASS_HASHES.ARC.WARLOCK.MELEE.CHAIN_LIGHTNING,\r\n      meleeName: 'Chain Lightning',\r\n      classAbilityHash: SUBCLASS_HASHES.ARC.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.ARC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    playstyle:\r\n      'Conduction Tines stacks recharge abilities. Stormtrance lasts forever. The ultimate ability spam build.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['ability-spam', 'add-clear', 'super-duration'],\r\n    loopDescription: 'Conduction Tines stacks recharge abilities. Stormtrance lasts forever. The ultimate ability spam build.',\r\n  },\r\n  {\r\n    id: 'warlock-stasis-ballidorse',\r\n    name: 'Winter Wrath',\r\n    element: ElementType.Stasis,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.Lightfall,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.BALLIDORSE_WRATHWEAVERS,\r\n      name: 'Ballidorse Wrathweavers',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.VERGLAS_CURVE,\r\n      name: 'Verglas Curve',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STASIS.WARLOCK.SUPER.WINTERS_WRATH,\r\n      superName: \"Winter's Wrath\",\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.STASIS.WARLOCK.ASPECTS.GLACIAL_HARVEST,\r\n        SUBCLASS_HASHES.STASIS.WARLOCK.ASPECTS.BLEAK_WATCHER,\r\n      ],\r\n      aspectNames: ['Glacial Harvest', 'Bleak Watcher'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_RIME,\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_SHARDS,\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_FISSURES,\r\n        SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_CONDUCTION,\r\n      ],\r\n      fragmentNames: ['Whisper of Rime', 'Whisper of Shards', 'Whisper of Fissures', 'Whisper of Conduction'],\r\n      grenadeHash: SUBCLASS_HASHES.STASIS.WARLOCK.GRENADES.COLDSNAP,\r\n      grenadeName: 'Coldsnap Grenade',\r\n      meleeHash: SUBCLASS_HASHES.STASIS.WARLOCK.MELEE.PENUMBRAL_BLAST,\r\n      meleeName: 'Penumbral Blast',\r\n      classAbilityHash: SUBCLASS_HASHES.STASIS.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.STASIS.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    playstyle:\r\n      'Boosts Winter\\'s Wrath shatter damage. Rift gives Stasis surge to allies. Control the field and shatter everything.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['super-damage', 'team-support', 'shatter'],\r\n    loopDescription: 'Boosts Winter\\'s Wrath shatter damage. Rift gives Stasis surge to allies. Control the field and shatter everything.',\r\n  },\r\n\r\n  // ===== PRISMATIC SYNERGIES =====\r\n  {\r\n    id: 'titan-prismatic-consecration',\r\n    name: 'Consecration Master',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_TITAN.WISHFUL_IGNORANCE,\r\n      name: 'Wishful Ignorance',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.KHVOSTOV_7G_0X,\r\n      name: 'Khvostov 7G-0X',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.TITAN.SUPER.TWILIGHT_ARSENAL,\r\n      superName: 'Twilight Arsenal',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.TITAN.ASPECTS.CONSECRATION,\r\n        SUBCLASS_HASHES.PRISMATIC.TITAN.ASPECTS.KNOCKOUT,\r\n      ],\r\n      aspectNames: ['Consecration', 'Knockout'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_DAWN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_RUIN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_COURAGE,\r\n      ],\r\n      fragmentNames: ['Facet of Dawn', 'Facet of Ruin', 'Facet of Protection', 'Facet of Courage'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.TITAN.GRENADES.THERMITE,\r\n      grenadeName: 'Thermite Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.TITAN.MELEE.FRENZIED_BLADE,\r\n      meleeName: 'Frenzied Blade',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.TITAN.CLASS_ABILITIES.THRUSTER,\r\n      classAbilityName: 'Thruster',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.TITAN.JUMPS.HIGH_LIFT,\r\n      jumpName: 'High Lift',\r\n    },\r\n    loopDescription:\r\n      'Consecration unleashes devastating slam attacks. Synthoceps boosts damage when surrounded. Twilight Arsenal for burst damage.',\r\n    playstyle:\r\n      'Slide + Melee for Consecration. Get surrounded for Synthoceps buff. Chain slams and axes for room clear.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['burst-damage', 'melee-build', 'add-clear', 'prismatic'],\r\n  },\r\n  {\r\n    id: 'hunter-prismatic-assassin',\r\n    name: 'Prismatic Assassin',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.GYRFALCONS_HAUBERK,\r\n      name: \"Gyrfalcon's Hauberk\",\r\n      slot: ItemSlot.Chest,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.OUTBREAK_PERFECTED,\r\n      name: 'Outbreak Perfected',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.SUPER.STORMS_EDGE,\r\n      superName: \"Storm's Edge\",\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.HUNTER.ASPECTS.STYLISH_EXECUTIONER,\r\n        SUBCLASS_HASHES.PRISMATIC.HUNTER.ASPECTS.THREADED_SPECTER,\r\n      ],\r\n      aspectNames: ['Stylish Executioner', 'Threaded Specter'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_DAWN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_RUIN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_HOPE,\r\n      ],\r\n      fragmentNames: ['Facet of Dawn', 'Facet of Protection', 'Facet of Ruin', 'Facet of Hope'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.GRENADES.DUSKFIELD,\r\n      grenadeName: 'Duskfield Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.MELEE.SNARE_BOMB,\r\n      meleeName: 'Snare Bomb',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: \"Gambler's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription:\r\n      'Kill weakened enemies for invisibility and damage buff. Gyrfalcon grants volatile rounds on exiting invis.',\r\n    playstyle:\r\n      'Weaken with grenade/smoke, kill for invis, exit invis for volatile rounds. Repeat the assassination loop.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['invisibility', 'volatile', 'assassination', 'prismatic'],\r\n  },\r\n  {\r\n    id: 'warlock-solar-sunbracers-v1',\r\n    name: 'Solar Spammer',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.SUNBRACERS,\r\n      name: 'Sunbracers',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.SUNSHOT,\r\n      name: 'Sunshot',\r\n    },\r\n    // Strict Requirement: Solar Grenade\r\n    requiredGrenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.WELL_OF_RADIANCE,\r\n      superName: 'Well of Radiance',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME,\r\n        SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.HEAT_RISES,\r\n      ],\r\n      aspectNames: ['Touch of Flame', 'Heat Rises'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SINGEING,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE,\r\n      ],\r\n      fragmentNames: ['Ember of Empyrean', 'Ember of Ashes', 'Ember of Singeing', 'Ember of Solace'],\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n      grenadeName: 'Solar Grenade',\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.INCINERATOR_SNAP,\r\n      meleeName: 'Incinerator Snap',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Melee kills grant unlimited grenades. Heat Rises gives melee energy on air kills. Touch of Flame makes grenades stronger.',\r\n    playstyle:\r\n      'Eat grenade for Heat Rises -> Melee kill -> Spam grenades from the sky. Repeat.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['grenade-spam', 'airborne', 'add-clear', 'solar'],\r\n  },\r\n  // ===== MORE EXPANSION SYNERGIES =====\r\n  {\r\n    id: 'titan-solar-pyrogale',\r\n    name: 'Burning Fists',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.Lightfall,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_TITAN.PYROGALE_GAUNTLETS,\r\n      name: 'Pyrogale Gauntlets',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.JOTUNN,\r\n      name: 'Jotunn',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.TITAN.SUPER.BURNING_MAUL,\r\n      superName: 'Burning Maul',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.SOL_INVICTUS,\r\n        SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.ROARING_FLAMES,\r\n      ],\r\n      aspectNames: ['Sol Invictus', 'Roaring Flames'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ERUPTION,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES,\r\n      ],\r\n      fragmentNames: ['Ember of Eruption', 'Ember of Ashes', 'Ember of Char', 'Ember of Torches'],\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.TITAN.GRENADES.FUSION,\r\n      grenadeName: 'Fusion Grenade',\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.TITAN.MELEE.THROWING_HAMMER,\r\n      meleeName: 'Throwing Hammer',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.TITAN.CLASS_ABILITIES.RALLY_BARRICADE,\r\n      classAbilityName: 'Rally Barricade',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.TITAN.JUMPS.HIGH_LIFT,\r\n      jumpName: 'High Lift',\r\n    },\r\n    loopDescription:\r\n      'Pyrogale changes Burning Maul into a powerful slam attack. Roaring Flames stacks increase all Solar damage.',\r\n    playstyle:\r\n      'Build Roaring Flames stacks with hammer. Pop Super for massive single slam. Ignitions everywhere.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['super-damage', 'ignition', 'burst-dps', 'solar'],\r\n  },\r\n  {\r\n    id: 'hunter-solar-galanor',\r\n    name: 'Blade Spam',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.Forsaken,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.SHARDS_OF_GALANOR,\r\n      name: 'Shards of Galanor',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.PROMETHEUS_LENS,\r\n      name: 'Prometheus Lens',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.HUNTER.SUPER.BLADE_BARRAGE,\r\n      superName: 'Blade Barrage',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.KNOCK_EM_DOWN,\r\n        SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.GUNPOWDER_GAMBLE,\r\n      ],\r\n      aspectNames: [\"Knock 'Em Down\", 'Gunpowder Gamble'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_COMBUSTION,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SINGEING,\r\n      ],\r\n      fragmentNames: ['Ember of Combustion', 'Ember of Ashes', 'Ember of Solace', 'Ember of Singeing'],\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.HUNTER.GRENADES.TRIPMINE,\r\n      grenadeName: 'Tripmine Grenade',\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.HUNTER.MELEE.KNIFE_TRICK,\r\n      meleeName: 'Knife Trick',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: \"Gambler's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription:\r\n      'Blade Barrage hits return Super energy with Shards. Knock Em Down makes knives throw more. Constant Supers.',\r\n    playstyle:\r\n      'Use Super on groups for maximum refund. Knock Em Down boosts knives. Gunpowder Gamble for add clear between Supers.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['super-spam', 'add-clear', 'burst-damage', 'solar'],\r\n  },\r\n  {\r\n    id: 'warlock-void-manacles',\r\n    name: 'Handheld Supernova',\r\n    element: ElementType.Void,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.NOTHING_MANACLES,\r\n      name: 'Nothing Manacles',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.GRAVITON_LANCE,\r\n      name: 'Graviton Lance',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.VOID.WARLOCK.SUPER.NOVA_WARP,\r\n      superName: 'Nova Warp',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.VOID.WARLOCK.ASPECTS.CHAOS_ACCELERANT,\r\n        SUBCLASS_HASHES.VOID.WARLOCK.ASPECTS.FEED_THE_VOID,\r\n      ],\r\n      aspectNames: ['Chaos Accelerant', 'Feed the Void'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_UNDERMINING,\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_EXPULSION,\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_INSTABILITY,\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_STARVATION,\r\n      ],\r\n      fragmentNames: ['Echo of Undermining', 'Echo of Expulsion', 'Echo of Instability', 'Echo of Starvation'],\r\n      grenadeHash: SUBCLASS_HASHES.VOID.WARLOCK.GRENADES.SCATTER,\r\n      grenadeName: 'Scatter Grenade',\r\n      meleeHash: SUBCLASS_HASHES.VOID.WARLOCK.MELEE.POCKET_SINGULARITY,\r\n      meleeName: 'Pocket Singularity',\r\n      classAbilityHash: SUBCLASS_HASHES.VOID.WARLOCK.CLASS_ABILITIES.EMPOWERING_RIFT,\r\n      classAbilityName: 'Empowering Rift',\r\n      jumpHash: SUBCLASS_HASHES.VOID.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Nothing Manacles gives two Scatter Grenades with improved tracking. Chaos Accelerant makes them devastating.',\r\n    playstyle:\r\n      'Charge Scatter Grenades for Handheld Supernova. Two charges means constant HHSN spam. Devour for survivability.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['grenade-spam', 'burst-damage', 'devour', 'void'],\r\n  },\r\n  {\r\n    id: 'hunter-void-gyrfalcon',\r\n    name: 'Volatile Hunter',\r\n    element: ElementType.Void,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.WitchQueen,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.GYRFALCONS_HAUBERK,\r\n      name: \"Gyrfalcon's Hauberk\",\r\n      slot: ItemSlot.Chest,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.WITHERHOARD,\r\n      name: 'Witherhoard',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.VOID.HUNTER.SUPER.SHADOWSHOT_DEADFALL,\r\n      superName: 'Shadowshot: Deadfall',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.VANISHING_STEP,\r\n        SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.TRAPPERS_AMBUSH,\r\n      ],\r\n      aspectNames: ['Vanishing Step', 'Trappers Ambush'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_OBSCURITY,\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_INSTABILITY,\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_STARVATION,\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_PERSISTENCE,\r\n      ],\r\n      fragmentNames: ['Echo of Obscurity', 'Echo of Instability', 'Echo of Starvation', 'Echo of Persistence'],\r\n      grenadeHash: SUBCLASS_HASHES.VOID.HUNTER.GRENADES.VORTEX,\r\n      grenadeName: 'Vortex Grenade',\r\n      meleeHash: SUBCLASS_HASHES.VOID.HUNTER.MELEE.SNARE_BOMB,\r\n      meleeName: 'Snare Bomb',\r\n      classAbilityHash: SUBCLASS_HASHES.VOID.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: \"Gambler's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.VOID.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription:\r\n      'Exiting invisibility grants Volatile Rounds and a damage buff. Witherhoard keeps dealing damage while invis.',\r\n    playstyle:\r\n      'Go invis, place Witherhoard, exit invis near enemies with volatile rounds. Rinse repeat.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['invisibility', 'volatile', 'zone-control', 'void'],\r\n  },\r\n  {\r\n    id: 'titan-arc-peacekeepers',\r\n    name: 'SMG Striker',\r\n    element: ElementType.Arc,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_TITAN.PEACEKEEPERS,\r\n      name: 'Peacekeepers',\r\n      slot: ItemSlot.Legs,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.RISKRUNNER,\r\n      name: 'Riskrunner',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.ARC.TITAN.SUPER.FISTS_OF_HAVOC,\r\n      superName: 'Fists of Havoc',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.ARC.TITAN.ASPECTS.TOUCH_OF_THUNDER,\r\n        SUBCLASS_HASHES.ARC.TITAN.ASPECTS.JUGGERNAUT,\r\n      ],\r\n      aspectNames: ['Touch of Thunder', 'Juggernaut'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_SHOCK,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_IONS,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_MOMENTUM,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_RECHARGE,\r\n      ],\r\n      fragmentNames: ['Spark of Shock', 'Spark of Ions', 'Spark of Momentum', 'Spark of Recharge'],\r\n      grenadeHash: SUBCLASS_HASHES.ARC.TITAN.GRENADES.STORM,\r\n      grenadeName: 'Storm Grenade',\r\n      meleeHash: SUBCLASS_HASHES.ARC.TITAN.MELEE.THUNDERCLAP,\r\n      meleeName: 'Thunderclap',\r\n      classAbilityHash: SUBCLASS_HASHES.ARC.TITAN.CLASS_ABILITIES.THRUSTER,\r\n      classAbilityName: 'Thruster',\r\n      jumpHash: SUBCLASS_HASHES.ARC.TITAN.JUMPS.HIGH_LIFT,\r\n      jumpName: 'High Lift',\r\n    },\r\n    loopDescription:\r\n      'Peacekeepers auto-reload stowed SMGs and grant mobility. Riskrunner chains Arc damage when taking Arc damage.',\r\n    playstyle:\r\n      'Sprint with Juggernaut shield. Swap SMGs constantly with instant ready. Riskrunner procs make you unkillable in Arc content.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['smg', 'mobility', 'arc-damage', 'aggressive'],\r\n  },\r\n  {\r\n    id: 'warlock-solar-sunbracers',\r\n    name: 'Grenade Rain',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.SUNBRACERS,\r\n      name: 'Sunbracers',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.MONTE_CARLO,\r\n      name: 'Monte Carlo',\r\n    },\r\n    // Strict Requirement: Solar Grenade\r\n    requiredGrenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.DAYBREAK,\r\n      superName: 'Daybreak',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.HEAT_RISES,\r\n        SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME,\r\n      ],\r\n      aspectNames: ['Heat Rises', 'Touch of Flame'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SINGEING,\r\n      ],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Char', 'Ember of Torches', 'Ember of Singeing'],\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n      grenadeName: 'Solar Grenade',\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.CELESTIAL_FIRE,\r\n      meleeName: 'Celestial Fire',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Solar melee kills grant unlimited Solar grenades for 5 seconds. Monte Carlo keeps melee charged.',\r\n    playstyle:\r\n      'Get melee kill, spam 5+ Solar grenades while airborne. Monte Carlo refunds melee for next cycle. Rain fire.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['grenade-spam', 'airborne', 'add-clear', 'solar'],\r\n  },\r\n  // ===== RENEGADE EXPANSION =====\r\n  {\r\n    id: 'hunter-arc-assassin',\r\n    name: 'Lightning Assassin',\r\n    element: ElementType.Arc,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.Shadowkeep,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.ASSASSINS_COWL,\r\n      name: \"Assassin's Cowl\",\r\n      slot: ItemSlot.Helmet,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.MONTE_CARLO,\r\n      name: 'Monte Carlo',\r\n    },\r\n    // Strict Requirement: Solar Grenade\r\n    requiredGrenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.ARC.HUNTER.SUPER.GATHERING_STORM,\r\n      superName: 'Gathering Storm',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.ARC.HUNTER.ASPECTS.LETHAL_CURRENT,\r\n        SUBCLASS_HASHES.ARC.HUNTER.ASPECTS.FLOW_STATE,\r\n      ],\r\n      aspectNames: ['Lethal Current', 'Flow State'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_RESISTANCE,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_SHOCK,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_FEEDBACK,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_MAGNITUDE,\r\n      ],\r\n      fragmentNames: ['Spark of Resistance', 'Spark of Shock', 'Spark of Feedback', 'Spark of Magnitude'],\r\n      grenadeHash: SUBCLASS_HASHES.ARC.HUNTER.GRENADES.PULSE,\r\n      grenadeName: 'Pulse Grenade',\r\n      meleeHash: SUBCLASS_HASHES.ARC.HUNTER.MELEE.COMBINATION_BLOW,\r\n      meleeName: 'Combination Blow',\r\n      classAbilityHash: SUBCLASS_HASHES.ARC.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: 'Gamblers Dodge',\r\n      jumpHash: SUBCLASS_HASHES.ARC.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription:\r\n      'Powered melee kills heal you and make you invisible. Combination Blow increases damage. Infinite punch-invis-punch loop.',\r\n    playstyle:\r\n      'Punch to kill -> Invis -> Find next target -> Punch. Safe and deadly.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['arc', 'invisibility', 'melee', 'healing'],\r\n  },\r\n  // ===== PRISMATIC SYNERGIES =====\r\n  {\r\n    id: 'warlock-prismatic-getaway-praxic',\r\n    name: 'Praxic Stormcaller',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.GETAWAY_ARTIST,\r\n      name: 'Getaway Artist',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.PRAXIC_BLADE,\r\n      name: 'Praxic Blade',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.SUPER.STORMTRANCE,\r\n      superName: 'Stormtrance',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.BLEAK_WATCHER,\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.FEED_THE_VOID,\r\n      ],\r\n      aspectNames: ['Bleak Watcher', 'Feed the Void'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_RUIN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_HOPE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PURPOSE,\r\n      ],\r\n      fragmentNames: ['Facet of Ruin', 'Facet of Hope', 'Facet of Protection', 'Facet of Purpose'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.GRENADES.STORM,\r\n      grenadeName: 'Storm Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.MELEE.ARCANE_NEEDLE,\r\n      meleeName: 'Arcane Needle',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Getaway Artist provides an Arc Soul while Praxic Blade heavy attacks reflect damage and clear groups. Prismatic synergies keep ability energy flowing.',\r\n    playstyle:\r\n      'Consume grenade for Arc Soul. Use Praxic Blade to reflect damage and sever targets. Combined turret and sword damage controls the battlefield.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['prismatic', 'praxic-blade', 'getaway-artist', 'warlock'],\r\n  },\r\n  {\r\n    id: 'titan-prismatic-hazardous',\r\n    name: 'Hazardous Artillery',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_TITAN.HAZARDOUS_PROPULSION,\r\n      name: 'Hazardous Propulsion',\r\n      slot: ItemSlot.Chest,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.GRAVITON_LANCE, // Graviton for range/void\r\n      name: 'Graviton Lance',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.TITAN.SUPER.TWILIGHT_ARSENAL,\r\n      superName: 'Twilight Arsenal',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.TITAN.ASPECTS.KNOCKOUT,\r\n        SUBCLASS_HASHES.PRISMATIC.TITAN.ASPECTS.DRENGRS_LASH,\r\n      ],\r\n      aspectNames: ['Knockout', 'Drengrs Lash'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_DAWN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_RUIN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_HOPE,\r\n      ],\r\n      fragmentNames: ['Facet of Dawn', 'Facet of Ruin', 'Facet of Protection', 'Facet of Hope'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.TITAN.GRENADES.SHACKLE,\r\n      grenadeName: 'Shackle Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.TITAN.MELEE.SHIELD_THROW,\r\n      meleeName: 'Shield Throw',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.TITAN.CLASS_ABILITIES.THRUSTER,\r\n      classAbilityName: 'Thruster',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.TITAN.JUMPS.HIGH_LIFT,\r\n      jumpName: 'High Lift',\r\n    },\r\n    loopDescription:\r\n      'Hazardous Propulsion builds up rockets on hits. Class ability fires them. Twilight Arsenal fits the artillery theme.',\r\n    playstyle:\r\n      'Build stacks. Dash/Thrust to fire homing rockets. Barrage with Twilight Arsenal.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['prismatic', 'rockets', 'burst', 'range'],\r\n  },\r\n  {\r\n    id: 'hunter-prismatic-punch',\r\n    name: 'Rocket Punch',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.LIARS_HANDSHAKE,\r\n      name: \"Liar's Handshake\",\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.MONTE_CARLO,\r\n      name: 'Monte Carlo',\r\n    },\r\n    // Strict Requirement: Solar Grenade\r\n    requiredGrenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.SUPER.SILENCE_AND_SQUALL, // Or Storms Edge\r\n      superName: 'Silence and Squall',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.HUNTER.ASPECTS.STYLISH_EXECUTIONER,\r\n        SUBCLASS_HASHES.PRISMATIC.HUNTER.ASPECTS.WINTERS_SHROUD,\r\n      ],\r\n      aspectNames: ['Stylish Executioner', 'Winters Shroud'], // Winter's Shroud from Prismatic\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_DAWN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_RUIN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_HOPE,\r\n      ],\r\n      fragmentNames: ['Facet of Dawn', 'Facet of Ruin', 'Facet of Protection', 'Facet of Hope'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.GRENADES.GRAPPLE,\r\n      grenadeName: 'Grapple Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.MELEE.COMBINATION_BLOW, // Prismatic Combo Blow\r\n      meleeName: 'Combination Blow',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: 'Gamblers Dodge',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription:\r\n      'Combination Blow + Liar\\'s Handshake on Prismatic. Grapple Melee counts as melee. Stylish Executioner for invis.',\r\n    playstyle:\r\n      'Punch, Dodge, Punch. Repeat. Invis on kills. Massive single target damage.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['prismatic', 'melee', 'invis', 'high-dps'],\r\n  },\r\n  {\r\n    id: 'warlock-prismatic-devour-weave',\r\n    name: 'Devour Weave',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.SWARMERS,\r\n      name: 'Swarmers',\r\n      slot: ItemSlot.Legs,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.WISH_KEEPER,\r\n      name: 'Wish-Keeper',\r\n    },\r\n    // Strict Requirement: Weaver's Call (Prismatic)\r\n    requiredAspectHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.WEAVERS_CALL,\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.SUPER.NEEDLESTORM,\r\n      superName: 'Needlestorm',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.WEAVERS_CALL,\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.FEED_THE_VOID,\r\n      ],\r\n      aspectNames: [\"Weaver's Call\", 'Feed the Void'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_HOPE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_BALANCE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_COURAGE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PURPOSE,\r\n      ],\r\n      fragmentNames: ['Facet of Hope', 'Facet of Balance', 'Facet of Courage', 'Facet of Protection', 'Facet of Purpose'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.GRENADES.THREADLING,\r\n      grenadeName: 'Threadling Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.MELEE.ARCANE_NEEDLE,\r\n      meleeName: 'Arcane Needle',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Consume Threadlings to heal. Weaver\\'s Call spawns Threadlings on dive. Swarmers make them Unravel.',\r\n    playstyle:\r\n      'Constant threadling spam that heals you. Use dive to spawn threadlings and proc Weaver\\'s Call.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['prismatic', 'threadlings', 'healing', 'warlock'],\r\n  },\r\n  {\r\n    id: 'warlock-strand-swarmers',\r\n    name: 'Broodweaver Swarm',\r\n    element: ElementType.Strand,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.Lightfall,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.SWARMERS,\r\n      name: 'Swarmers',\r\n      slot: ItemSlot.Legs,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.QUICKSILVER_STORM,\r\n      name: 'Quicksilver Storm',\r\n    },\r\n    requiredAspectHash: SUBCLASS_HASHES.STRAND.WARLOCK.ASPECTS.WEAVERS_CALL,\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STRAND.WARLOCK.SUPER.NEEDLESTORM,\r\n      superName: 'Needlestorm',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.STRAND.WARLOCK.ASPECTS.WEAVERS_CALL,\r\n        SUBCLASS_HASHES.STRAND.WARLOCK.ASPECTS.THE_WANDERER,\r\n      ],\r\n      aspectNames: [\"Weaver's Call\", 'The Wanderer'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_EVOLUTION,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_GENERATION,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_REBIRTH,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_WARDING,\r\n      ],\r\n      fragmentNames: ['Thread of Evolution', 'Thread of Generation', 'Thread of Rebirth', 'Thread of Warding'],\r\n      grenadeHash: SUBCLASS_HASHES.STRAND.WARLOCK.GRENADES.THREADLING,\r\n      grenadeName: 'Threadling Grenade',\r\n      meleeHash: SUBCLASS_HASHES.STRAND.WARLOCK.MELEE.ARCANE_NEEDLE,\r\n      meleeName: 'Arcane Needle',\r\n      classAbilityHash: SUBCLASS_HASHES.STRAND.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift', // Or Rift if dive not typical for strand pure? Keep Dive for implementation simplicity\r\n      jumpHash: SUBCLASS_HASHES.STRAND.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Swarmers allows threadlings to Unravel enemies. The Wanderer creates tangles that suspend. Maximum summoner build.',\r\n    playstyle:\r\n      'Throw tangle -> Suspend -> Kill with Quicksilver -> Spawn Threadlings -> Unravel. Control the battlefield.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['strand', 'summoner', 'unravel', 'suspend'],\r\n  },\r\n  {\r\n    id: 'warlock-arc-getaway',\r\n    name: 'Sentient Arc Soul',\r\n    element: ElementType.Arc,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.GETAWAY_ARTIST,\r\n      name: 'Getaway Artist',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.CENTRIFUSE,\r\n      name: 'Centrifuse',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.ARC.WARLOCK.SUPER.CHAOS_REACH,\r\n      superName: 'Chaos Reach',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.ARC.WARLOCK.ASPECTS.ARC_SOUL,\r\n        SUBCLASS_HASHES.ARC.WARLOCK.ASPECTS.ELECTROSTATIC_MIND,\r\n      ],\r\n      aspectNames: ['Arc Soul', 'Electrostatic Mind'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_MAGNITUDE,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_SHOCK,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_BEACONS,\r\n        SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_AMPLITUDE,\r\n      ],\r\n      fragmentNames: ['Spark of Magnitude', 'Spark of Shock', 'Spark of Beacons', 'Spark of Amplitude'],\r\n      grenadeHash: SUBCLASS_HASHES.ARC.WARLOCK.GRENADES.STORM,\r\n      grenadeName: 'Storm Grenade', // Getaway consumes this\r\n      meleeHash: SUBCLASS_HASHES.ARC.WARLOCK.MELEE.CHAIN_LIGHTNING,\r\n      meleeName: 'Chain Lightning',\r\n      classAbilityHash: SUBCLASS_HASHES.ARC.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.ARC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Getaway Artist converts grenade into a supercharged Arc Soul. Centrifuse builds charge while sprinting to blind enemies.',\r\n    playstyle:\r\n      'Consume grenade for Arc Soul. Sprint and shoot Centrifuse. Generate Ionic Traces to get grenade back immediately.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['arc', 'auto-turret', 'speed', 'blind'],\r\n  },\r\n  {\r\n    id: 'warlock-prismatic-winter',\r\n    name: 'Lightning God',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.WINTERS_GUILE,\r\n      name: \"Winter's Guile\",\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.TRINITY_GHOUL,\r\n      name: 'Trinity Ghoul',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.SUPER.STORMTRANCE,\r\n      superName: 'Stormtrance',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.LIGHTNING_SURGE,\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.FEED_THE_VOID,\r\n      ],\r\n      aspectNames: ['Lightning Surge', 'Feed the Void'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PURPOSE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_BRAVERY,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_BALANCE,\r\n      ],\r\n      fragmentNames: ['Facet of Protection', 'Facet of Purpose', 'Facet of Bravery', 'Facet of Balance'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.GRENADES.STORM,\r\n      grenadeName: 'Storm Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.MELEE.ARCANE_NEEDLE,\r\n      meleeName: 'Arcane Needle',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Use Arcane Needle to activate Lightning Surge slide-melee. Winter\\'s Guile stacks melee damage to absurd levels.',\r\n    playstyle:\r\n      'Slide, zap, heal via Devour, repeat. High APM melee nuke build.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['prismatic', 'melee', 'add-clear', 'warlock'],\r\n  },\r\n  {\r\n    id: 'warlock-prismatic-monte-winters',\r\n    name: 'Melee Rampage',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.WINTERS_GUILE,\r\n      name: \"Winter's Guile\",\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.MONTE_CARLO,\r\n      name: 'Monte Carlo',\r\n    },\r\n    // Strict Requirement: Solar Grenade\r\n    requiredGrenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.SUPER.NOVA_BOMB_CATACLYSM,\r\n      superName: 'Nova Bomb',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.HELLION,\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.FEED_THE_VOID,\r\n      ],\r\n      aspectNames: ['Hellion', 'Feed the Void'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_COURAGE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_SACRIFICE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_BALANCE,\r\n      ],\r\n      fragmentNames: ['Facet of Courage', 'Facet of Sacrifice', 'Facet of Protection', 'Facet of Balance'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.GRENADES.VORTEX,\r\n      grenadeName: 'Vortex Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.MELEE.ARCANE_NEEDLE,\r\n      meleeName: 'Arcane Needle',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Monte Carlo keeps melee charged. Winter\\'s Guile stacks melee damage up to 5x. Works on any subclass.',\r\n    playstyle:\r\n      'Constant melee attacks with ramping damage. Monte Carlo ensures you always have melee energy. Universal synergy.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['prismatic', 'melee', 'neutral-game', 'any-subclass', 'universal'],\r\n  },\r\n  {\r\n    id: 'warlock-prismatic-blade',\r\n    name: 'Prismatic Conductor',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.SPEAKERS_SIGHT,\r\n      name: \"Speaker's Sight\",\r\n      slot: ItemSlot.Helmet,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.ERGO_SUM,\r\n      name: 'Ergo Sum',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.SUPER.SONG_OF_FLAME,\r\n      superName: 'Song of Flame',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.HELLION,\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.FEED_THE_VOID,\r\n      ],\r\n      aspectNames: ['Hellion', 'Feed the Void'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_HOPE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_BALANCE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_DAWN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n      ],\r\n      fragmentNames: ['Facet of Hope', 'Facet of Balance', 'Facet of Dawn', 'Facet of Protection'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.GRENADES.HEALING,\r\n      grenadeName: 'Healing Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.MELEE.INCINERATOR_SNAP,\r\n      meleeName: 'Incinerator Snap',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Speaker\\'s Sight turns healing nades into turrets. Ergo Sum clears adds with Arc Conductor.',\r\n    playstyle:\r\n      'Support heavy build with high add-clear potential. Keep turrets up and chain lightning.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['prismatic', 'support', 'healing', 'ergo-sum'],\r\n  },\r\n  {\r\n    id: 'titan-prismatic-stronghold-praxic',\r\n    name: 'Praxic Knight',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_TITAN.STRONGHOLD,\r\n      name: 'Stronghold',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.PRAXIC_BLADE,\r\n      name: 'Praxic Blade',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.TITAN.SUPER.TWILIGHT_ARSENAL,\r\n      superName: 'Twilight Arsenal',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.TITAN.ASPECTS.CONSECRATION,\r\n        SUBCLASS_HASHES.PRISMATIC.TITAN.ASPECTS.KNOCKOUT,\r\n      ],\r\n      aspectNames: ['Consecration', 'Knockout'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_RUIN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PURPOSE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_BALANCE,\r\n      ],\r\n      fragmentNames: ['Facet of Ruin', 'Facet of Protection', 'Facet of Purpose', 'Facet of Balance'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.TITAN.GRENADES.GLACIER,\r\n      grenadeName: 'Glacier Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.TITAN.MELEE.FRENZIED_BLADE,\r\n      meleeName: 'Frenzied Blade',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.TITAN.CLASS_ABILITIES.THRUSTER,\r\n      classAbilityName: 'Thruster',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.TITAN.JUMPS.HIGH_LIFT,\r\n      jumpName: 'High Lift',\r\n    },\r\n    loopDescription:\r\n      'Infinite sword guard with Stronghold. Praxic Blade heavy attacks reflect incoming damage and sever targets. Consecration for burst.',\r\n    playstyle:\r\n      'Be the unbreakable wall. Block damage with Stronghold, then use Praxic Blade\\'s heavy attack to reflect damage back at enemies.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['prismatic', 'sword', 'tank', 'praxic-blade'],\r\n  },\r\n  {\r\n    id: 'hunter-prismatic-blade',\r\n    name: 'Prismatic Duelist',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.GIFTED_CONVICTION,\r\n      name: 'Gifted Conviction',\r\n      slot: ItemSlot.Chest,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.ERGO_SUM,\r\n      name: 'Ergo Sum',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.SUPER.STORMS_EDGE,\r\n      superName: \"Storm's Edge\",\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.HUNTER.ASPECTS.ASCENSION,\r\n        SUBCLASS_HASHES.PRISMATIC.HUNTER.ASPECTS.STYLISH_EXECUTIONER,\r\n      ],\r\n      aspectNames: ['Ascension', 'Stylish Executioner'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_DAWN,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_HOPE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_COURAGE,\r\n      ],\r\n      fragmentNames: ['Facet of Dawn', 'Facet of Hope', 'Facet of Protection', 'Facet of Courage'],\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.GRENADES.ARCBOLT,\r\n      grenadeName: 'Arcbolt Grenade',\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.MELEE.COMBINATION_BLOW,\r\n      meleeName: 'Combination Blow',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: 'Gamblers Dodge',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription:\r\n      'Ascension + Gifted Conviction for bouncing explosives. Ergo Sum chains lightning via Arc Conductor.',\r\n    playstyle:\r\n      'Extremely mobile add-clear. Use Ascension to jolt and spawn explosives, then mop up with the blade.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['prismatic', 'mobility', 'add-clear', 'ergo-sum'],\r\n  }, {\r\n    id: 'hunter-void-gyrfalcon-loop',\r\n    name: \"Gyrfalcon's Volatility\",\r\n    element: ElementType.Void,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.WitchQueen,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.GYRFALCONS_HAUBERK,\r\n      name: \"Gyrfalcon's Hauberk\",\r\n      slot: ItemSlot.Chest,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.FIGHTING_LION,\r\n      name: 'Fighting Lion',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.VOID.HUNTER.SUPER.SHADOWSHOT_DEADFALL,\r\n      superName: 'Shadowshot: Deadfall',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.STYLISH_EXECUTIONER,\r\n        SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.VANISHING_STEP,\r\n      ],\r\n      aspectNames: ['Stylish Executioner', 'Vanishing Step'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_INSTABILITY,\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_STARVATION,\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_PERSISTENCE,\r\n        SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_OBSCURITY,\r\n      ],\r\n      fragmentNames: ['Echo of Instability', 'Echo of Starvation', 'Echo of Persistence', 'Echo of Obscurity'],\r\n      meleeHash: SUBCLASS_HASHES.VOID.HUNTER.MELEE.SNARE_BOMB,\r\n      meleeName: 'Snare Bomb',\r\n      grenadeHash: SUBCLASS_HASHES.VOID.HUNTER.GRENADES.VORTEX,\r\n      grenadeName: 'Vortex Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.VOID.HUNTER.CLASS_ABILITIES.MARKSMANS_DODGE,\r\n      classAbilityName: \"Marksman's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.VOID.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription:\r\n      \"Coming out of invisibility grants Volatile Rounds to Void weapons. Kills on debuffed enemies grant invisibility via Stylish Executioner.\",\r\n    playstyle:\r\n      'Dodge to go invis -> Kill an enemy to get Volatile Rounds -> Kill another to go back invis. Infinite loop of purple explosions.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['void', 'volatile', 'invisibility', 'add-clear'],\r\n  },\r\n  {\r\n    id: 'hunter-any-lucky-pants-dps',\r\n    name: 'Lucky Shots',\r\n    element: ElementType.Kinetic,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.LUCKY_PANTS,\r\n      name: 'Lucky Pants',\r\n      slot: ItemSlot.Legs,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.MALFEASANCE,\r\n      name: 'Malfeasance',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.HUNTER.SUPER.GOLDEN_GUN_MARKSMAN,\r\n      superName: 'Golden Gun: Marksman',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.ON_YOUR_MARK,\r\n        SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.KNOCK_EM_DOWN,\r\n      ],\r\n      aspectNames: ['On Your Mark', \"Knock 'Em Down\"],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES,\r\n      ],\r\n      fragmentNames: ['Ember of Torches', 'Ember of Solace', 'Ember of Empyrean', 'Ember of Ashes'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.HUNTER.MELEE.WEIGHTED_THROWING_KNIFE,\r\n      meleeName: 'Weighted Throwing Knife',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.HUNTER.GRENADES.HEALING,\r\n      grenadeName: 'Healing Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.HUNTER.CLASS_ABILITIES.MARKSMANS_DODGE,\r\n      classAbilityName: \"Marksman's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription:\r\n      'Readying a fully loaded Hand Cannon matching your element (or Kinetic) grants massive damage bonuses. Malfeasance deals monstrous damage to bosses.',\r\n    playstyle:\r\n      'Whip out your Hand Cannon when a major or boss appears. Land quick shots to stack the damage buff. Swap away once the buff ends.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['kinetic', 'hand-cannon', 'boss-dps', 'burst-damage'],\r\n  }, {\r\n    id: 'hunter-solar-celestial-nuke',\r\n    name: 'One Shot Sharpshooter',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_HUNTER.CELESTIAL_NIGHTHAWK,\r\n      name: 'Celestial Nighthawk',\r\n      slot: ItemSlot.Helmet,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.POWER.WHISPER_OF_THE_WORM,\r\n      name: 'Whisper of the Worm',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.HUNTER.SUPER.GOLDEN_GUN_MARKSMAN,\r\n      superName: 'Golden Gun: Marksman',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.ON_YOUR_MARK,\r\n        SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.KNOCK_EM_DOWN,\r\n      ],\r\n      aspectNames: ['On Your Mark', \"Knock 'Em Down\"],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES,\r\n      ],\r\n      fragmentNames: ['Ember of Torches', 'Ember of Solace', 'Ember of Empyrean', 'Ember of Ashes'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.HUNTER.MELEE.WEIGHTED_THROWING_KNIFE,\r\n      meleeName: 'Weighted Throwing Knife',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.HUNTER.GRENADES.HEALING,\r\n      grenadeName: 'Healing Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.HUNTER.CLASS_ABILITIES.MARKSMANS_DODGE,\r\n      classAbilityName: \"Marksman's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription:\r\n      'Golden Gun becomes a single, high-damage shot. Precision kills with any weapon refund Golden Gun energy.',\r\n    playstyle:\r\n      'Aim for the head. Line up your one Golden Gun shot for massive boss damage. Keep getting headshots to build your next super.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['solar', 'boss-dps', 'burst-damage', 'precision'],\r\n  }, {\r\n    id: 'warlock-any-assembler-support',\r\n    name: \"Assembler's Blessing\",\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BeyondLight,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.BOOTS_OF_THE_ASSEMBLER,\r\n      name: 'Boots of the Assembler',\r\n      slot: ItemSlot.Legs,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.LUMINA,\r\n      name: 'Lumina',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.WELL_OF_RADIANCE,\r\n      superName: 'Well of Radiance',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME,\r\n        SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.HELLION,\r\n      ],\r\n      aspectNames: ['Touch of Flame', 'Hellion'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_BENEVOLENCE,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_MERCY,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN,\r\n      ],\r\n      fragmentNames: ['Ember of Benevolence', 'Ember of Mercy', 'Ember of Solace', 'Ember of Empyrean'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.CELESTIAL_FIRE,\r\n      meleeName: 'Celestial Fire',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.HEALING,\r\n      grenadeName: 'Healing Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Standing in a rift spawns noble seekers that track and heal/empower allies. Lumina kills provide even more noble rounds.',\r\n    playstyle:\r\n      'Drop your rift and stay in it to keep the seekers flowing. Tap allies with Lumina to give them 35% damage bonus.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'healing', 'team-support', 'lumina'],\r\n  }, {\r\n    id: 'warlock-any-necrotic-poison',\r\n    name: 'Contagion Architect',\r\n    element: ElementType.Strand,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.Lightfall,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.NECROTIC_GRIP,\r\n      name: 'Necrotic Grip',\r\n      slot: ItemSlot.Arms,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.KINETIC.OSTEO_STRIGA,\r\n      name: 'Osteo Striga',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STRAND.WARLOCK.SUPER.NEEDLESTORM,\r\n      superName: 'Needlestorm',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.STRAND.WARLOCK.ASPECTS.MINDSPUN_INVOCATION,\r\n        SUBCLASS_HASHES.STRAND.WARLOCK.ASPECTS.WEAVEWALK,\r\n      ],\r\n      aspectNames: ['Mindspun Invocation', 'Weaverwalk'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_GENERATION,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_EVOLUTION,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_MIND,\r\n        SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_CONTINUITY,\r\n      ],\r\n      fragmentNames: ['Thread of Generation', 'Thread of Evolution', 'Thread of Mind', 'Thread of Continuity'],\r\n      meleeHash: SUBCLASS_HASHES.STRAND.WARLOCK.MELEE.ARCANE_NEEDLE,\r\n      meleeName: 'Arcane Needle',\r\n      grenadeHash: SUBCLASS_HASHES.STRAND.WARLOCK.GRENADES.SHACKLE,\r\n      grenadeName: 'Shackle Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STRAND.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.VOID.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      'Melee hits poison enemies. Poison kills spread the effect. Osteo Striga triggers this effect on every kill.',\r\n    playstyle:\r\n      'Shoot one enemy with Osteo Striga and watch the poison clear the whole room. Shackle grenades to keep them still while they rot.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['strand', 'poison', 'add-clear', 'passive-damage'],\r\n  }, {\r\n    id: 'warlock-prismatic-nezarec-loop',\r\n    name: \"Nezarec's Spectrum\",\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: {\r\n      hash: EXOTIC_ARMOR_WARLOCK.NEZARECS_SIN,\r\n      name: \"Nezarec's Sin\",\r\n      slot: ItemSlot.Helmet,\r\n    },\r\n    exoticWeapon: {\r\n      hash: EXOTIC_WEAPONS.ENERGY.GRAVITON_LANCE,\r\n      name: 'Graviton Lance',\r\n    },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.SUPER.NOVA_BOMB_CATACLYSM,\r\n      superName: 'Nova Bomb',\r\n      aspectHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.FEED_THE_VOID,\r\n        SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.HELLION,\r\n      ],\r\n      aspectNames: ['Feed the Void', 'Hellion'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_HOPE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_BRAVERY,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_BALANCE,\r\n        SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION,\r\n      ],\r\n      fragmentNames: ['Facet of Hope', 'Facet of Bravery', 'Facet of Balance', 'Facet of Protection'],\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.MELEE.POCKET_SINGULARITY,\r\n      meleeName: 'Pocket Singularity',\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.GRENADES.VORTEX,\r\n      grenadeName: 'Vortex Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription:\r\n      \"All Void kills (weapon or ability) trigger Abyssal Extractors for massive ability energy. Feed the Void grants Devour on any ability kill.\",\r\n    playstyle:\r\n      'The ultimate ability spam build. Use Graviton Lance to trigger Nezarec, and use your abilities to stay alive via Devour.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['prismatic', 'ability-spam', 'void-synergy', 'healing'],\r\n  },\r\n  {\r\n    id: 'warlock-solar-dawn-chorus',\r\n    name: 'Daybreak Scorch',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BeyondLight,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.DAWN_CHORUS, name: 'Dawn Chorus', slot: ItemSlot.Helmet },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.SKYBURNERS_OATH, name: \"Skyburner's Oath\" },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.DAYBREAK,\r\n      superName: 'Daybreak',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME, SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.HEAT_RISES],\r\n      aspectNames: ['Touch of Flame', 'Heat Rises'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SINGEING, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_COMBUSTION],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Char', 'Ember of Singeing', 'Ember of Combustion'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.INCINERATOR_SNAP,\r\n      meleeName: 'Incinerator Snap',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n      grenadeName: 'Solar Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Massive damage buff for Daybreak and Scorch builds. Scorch deals more damage and refunds melee energy.',\r\n    playstyle: 'Scorch everything. Use Skyburner\\'s for easy scorch application. Daybreak deals massive damage to scorched targets.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'scorch', 'daybreak', 'warlock'],\r\n  },\r\n  {\r\n    id: 'warlock-void-briarbinds',\r\n    name: 'Void Soul Weaver',\r\n    element: ElementType.Void,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.BRIARBINDS, name: 'Briarbinds', slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.GRAVITON_LANCE, name: 'Graviton Lance' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.VOID.WARLOCK.SUPER.NOVA_BOMB_VORTEX,\r\n      superName: 'Nova Bomb: Vortex',\r\n      aspectHashes: [SUBCLASS_HASHES.VOID.WARLOCK.ASPECTS.CHILD_OF_THE_OLD_GODS, SUBCLASS_HASHES.VOID.WARLOCK.ASPECTS.FEED_THE_VOID],\r\n      aspectNames: ['Child of the Old Gods', 'Feed the Void'],\r\n      fragmentHashes: [SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_UNDERMINING, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_EXPULSION, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_STARVATION, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_PERSISTENCE],\r\n      fragmentNames: ['Echo of Undermining', 'Echo of Expulsion', 'Echo of Starvation', 'Echo of Persistence'],\r\n      meleeHash: SUBCLASS_HASHES.VOID.WARLOCK.MELEE.POCKET_SINGULARITY,\r\n      meleeName: 'Pocket Singularity',\r\n      grenadeHash: SUBCLASS_HASHES.VOID.WARLOCK.GRENADES.VORTEX,\r\n      grenadeName: 'Vortex Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.VOID.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.VOID.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Lets you retrieve and move your Void Soul. Void Souls last longer and deal escalating damage.',\r\n    playstyle: 'Deploy Void Soul, then pick it up to redeploy it with increased duration and damage. Keep the purple orb moving.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['void', 'void-soul', 'warlock', 'control'],\r\n  },\r\n  {\r\n    id: 'titan-strand-abeyant-leap',\r\n    name: \"Puppeteer's Control\",\r\n    element: ElementType.Strand,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.Lightfall,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_TITAN.ABEYANT_LEAP, name: 'Abeyant Leap', slot: ItemSlot.Legs },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.KINETIC.WISH_KEEPER, name: 'Wish-Keeper' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STRAND.TITAN.SUPER.BLADEFURY,\r\n      superName: 'Bladefury',\r\n      aspectHashes: [SUBCLASS_HASHES.STRAND.TITAN.ASPECTS.DRENGRS_LASH, SUBCLASS_HASHES.STRAND.TITAN.ASPECTS.BANNER_OF_WAR],\r\n      aspectNames: [\"Drengr's Lash\", 'Banner of War'],\r\n      fragmentHashes: [SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_MIND, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_CONTINUITY, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_WARDING, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_GENERATION],\r\n      fragmentNames: ['Thread of Mind', 'Thread of Continuity', 'Thread of Warding', 'Thread of Generation'],\r\n      meleeHash: SUBCLASS_HASHES.STRAND.TITAN.MELEE.FRENZIED_BLADE,\r\n      meleeName: 'Frenzied Blade',\r\n      grenadeHash: SUBCLASS_HASHES.STRAND.TITAN.GRENADES.SHACKLE,\r\n      grenadeName: 'Shackle Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STRAND.TITAN.CLASS_ABILITIES.RALLY_BARRICADE,\r\n      classAbilityName: 'Rally Barricade',\r\n      jumpHash: SUBCLASS_HASHES.STRAND.TITAN.JUMPS.STRAFE_LIFT,\r\n      jumpName: 'Strafe Lift',\r\n    },\r\n    loopDescription: \"Improves Drengr's Lash: Barricade creates three seeking lashes that Suspend targets and grant Woven Mail.\",\r\n    playstyle: 'Spam barricades to lock down entire rooms. Use Wish-Keeper to keep the suspension loop going.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['strand', 'suspend', 'titan', 'control'],\r\n  },\r\n  {\r\n    id: 'titan-solar-pyrogale-slam',\r\n    name: 'Burning Wrath',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_TITAN.PYROGALE_GAUNTLETS, name: 'Pyrogale Gauntlets', slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.POWER.DRAGONS_BREATH, name: \"Dragon's Breath\" },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.TITAN.SUPER.BURNING_MAUL,\r\n      superName: 'Burning Maul',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.CONSECRATION, SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.ROARING_FLAMES],\r\n      aspectNames: ['Consecration', 'Roaring Flames'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ERUPTION, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Eruption', 'Ember of Char', 'Ember of Torches'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.TITAN.MELEE.THROWING_HAMMER,\r\n      meleeName: 'Throwing Hammer',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.TITAN.GRENADES.THERMITE,\r\n      grenadeName: 'Thermite Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.TITAN.CLASS_ABILITIES.RALLY_BARRICADE,\r\n      classAbilityName: 'Rally Barricade',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.TITAN.JUMPS.STRAFE_LIFT,\r\n      jumpName: 'Strafe Lift',\r\n    },\r\n    loopDescription: 'Turns the Burning Maul Super into a single high-damage slam with fire cyclones. Consecration creates fire cyclones too.',\r\n    playstyle: 'Nuke bosses with a single Super slam. Chain Consecration slide-melees for massive add clear.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'burst-damage', 'titan', 'slam'],\r\n  },\r\n  {\r\n    id: 'hunter-solar-caliban-ignition',\r\n    name: 'Ignition Fever',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.WitchQueen,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_HUNTER.CALIBAN_HAND, name: \"Caliban's Hand\", slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.SUNSHOT, name: 'Sunshot' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.HUNTER.SUPER.BLADE_BARRAGE,\r\n      superName: 'Blade Barrage',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.KNOCK_EM_DOWN, SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.ON_YOUR_MARK],\r\n      aspectNames: [\"Knock 'Em Down\", 'On Your Mark'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ERUPTION, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Char', 'Ember of Eruption', 'Ember of Torches'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.HUNTER.MELEE.PROXIMITY_EXPLOSIVE_KNIFE,\r\n      meleeName: 'Proximity Explosive Knife',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.HUNTER.GRENADES.HEALING,\r\n      grenadeName: 'Healing Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: \"Gambler's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription: 'Your Proximity Knives cause massive Solar Ignitions on kills. Ignitions refund melee energy.',\r\n    playstyle: 'Throw proximity knives into groups. Every kill triggers an ignition that clears the rest. Infinite knife loop.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'ignition', 'hunter', 'add-clear'],\r\n  },\r\n  {\r\n    id: 'hunter-void-omnioculus',\r\n    name: 'Invisible Protector',\r\n    element: ElementType.Void,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.BeyondLight,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_HUNTER.OMNIOCULUS, name: 'Omnioculus', slot: ItemSlot.Chest },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.LE_MONARQUE, name: 'Le Monarque' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.VOID.HUNTER.SUPER.SHADOWSHOT_DEADFALL,\r\n      superName: 'Shadowshot: Deadfall',\r\n      aspectHashes: [SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.TRAPPERS_AMBUSH, SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.VANISHING_STEP],\r\n      aspectNames: ['Trappers Ambush', 'Vanishing Step'],\r\n      fragmentHashes: [SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_OBSCURITY, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_STARVATION, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_PERSISTENCE, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_HARVEST],\r\n      fragmentNames: ['Echo of Obscurity', 'Echo of Starvation', 'Echo of Persistence', 'Echo of Harvest'],\r\n      meleeHash: SUBCLASS_HASHES.VOID.HUNTER.MELEE.SNARE_BOMB,\r\n      meleeName: 'Snare Bomb',\r\n      grenadeHash: SUBCLASS_HASHES.VOID.HUNTER.GRENADES.VORTEX,\r\n      grenadeName: 'Vortex Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.VOID.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: \"Gambler's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.VOID.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription: 'Grants a second Smoke Bomb charge and gives damage resistance while invisible. Making allies invisible refunds smoke energy.',\r\n    playstyle: 'Keep your team invisible and resistant. Dive into groups to save allies. Infinite smoke energy if you play as a team.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['void', 'invisibility', 'hunter', 'support'],\r\n  },\r\n  {\r\n    id: 'warlock-any-cenotaph-divinity',\r\n    name: 'Sect of Insight',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.CENOTAPH_MASK, name: 'Cenotaph Mask', slot: ItemSlot.Helmet },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.DIVINITY, name: 'Divinity' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.WELL_OF_RADIANCE,\r\n      superName: 'Well of Radiance',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME, SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.HELLION],\r\n      aspectNames: ['Touch of Flame', 'Hellion'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_BENEVOLENCE, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_MERCY, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN],\r\n      fragmentNames: ['Ember of Benevolence', 'Ember of Mercy', 'Ember of Solace', 'Ember of Empyrean'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.CELESTIAL_FIRE,\r\n      meleeName: 'Celestial Fire',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.HEALING,\r\n      grenadeName: 'Healing Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Mandatory for Divinity users. Marks targets to generate Heavy ammo for your team.',\r\n    playstyle: 'Lock onto champions and bosses with Divinity. Your team gets Heavy ammo when they kill the marked target.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'support', 'heavy-ammo', 'warlock'],\r\n  },\r\n  {\r\n    id: 'titan-solar-loreley-survival',\r\n    name: 'Sunspot Sanctuary',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.WitchQueen,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_TITAN.LORELEY_SPLENDOR, name: 'Loreley Splendor', slot: ItemSlot.Helmet },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.SUNSHOT, name: 'Sunshot' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.TITAN.SUPER.HAMMER_OF_SOL,\r\n      superName: 'Hammer of Sol',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.SOL_INVICTUS, SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.ROARING_FLAMES],\r\n      aspectNames: ['Sol Invictus', 'Roaring Flames'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_BENEVOLENCE],\r\n      fragmentNames: ['Ember of Solace', 'Ember of Empyrean', 'Ember of Torches', 'Ember of Benevolence'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.TITAN.MELEE.THROWING_HAMMER,\r\n      meleeName: 'Throwing Hammer',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.TITAN.GRENADES.THERMITE,\r\n      grenadeName: 'Thermite Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.TITAN.CLASS_ABILITIES.RALLY_BARRICADE,\r\n      classAbilityName: 'Rally Barricade',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.TITAN.JUMPS.STRAFE_LIFT,\r\n      jumpName: 'Strafe Lift',\r\n    },\r\n    loopDescription: 'Automatically creates a Sunspot when you are critically wounded or use your class ability. Sunspots heal you and damage enemies.',\r\n    playstyle: 'Aggressive play with a safety net. Use Sunshot to create sunspots on kills via Sol Invictus. Stay in the sunspots for Restoration.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['solar', 'survival', 'healing', 'titan'],\r\n  },\r\n  {\r\n    id: 'titan-stasis-cadmus-lance',\r\n    name: 'Diamond Stalker',\r\n    element: ElementType.Stasis,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_TITAN.CADMUS_RIDGE_LANCECAP, name: 'Cadmus Ridge Lancecap', slot: ItemSlot.Helmet },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.KINETIC.WICKED_IMPLEMENT, name: 'Wicked Implement' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STASIS.TITAN.SUPER.GLACIAL_QUAKE,\r\n      superName: 'Glacial Quake',\r\n      aspectHashes: [SUBCLASS_HASHES.STASIS.TITAN.ASPECTS.DIAMOND_LANCE, SUBCLASS_HASHES.STASIS.TITAN.ASPECTS.TECTONIC_HARVEST],\r\n      aspectNames: ['Diamond Lance', 'Tectonic Harvest'],\r\n      fragmentHashes: [SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_SHARDS, SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_CHAINS, SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_CONDUCTION, SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_BONDS],\r\n      fragmentNames: ['Whisper of Shards', 'Whisper of Chains', 'Whisper of Conduction', 'Whisper of Bonds'],\r\n      meleeHash: SUBCLASS_HASHES.STASIS.TITAN.MELEE.SHIVER_STRIKE,\r\n      meleeName: 'Shiver Strike',\r\n      grenadeHash: SUBCLASS_HASHES.STASIS.TITAN.GRENADES.GLACIER,\r\n      grenadeName: 'Glacier Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STASIS.TITAN.CLASS_ABILITIES.RALLY_BARRICADE,\r\n      classAbilityName: 'Rally Barricade',\r\n      jumpHash: SUBCLASS_HASHES.STASIS.TITAN.JUMPS.STRAFE_LIFT,\r\n      jumpName: 'Strafe Lift',\r\n    },\r\n    loopDescription: 'Precision hits with a Stasis weapon create Diamond Lances near you while standing behind a rally barricade.',\r\n    playstyle: 'Park behind your barricade and use Wicked Implement to slow targets. Every few precision hits spawns a Lance you can throw to freeze groups.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['stasis', 'precision', 'titan', 'freeze'],\r\n  },\r\n  {\r\n    id: 'hunter-any-mothkeeper-wraps',\r\n    name: 'Swarm Lord',\r\n    element: ElementType.Neutral,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_HUNTER.MOTHKEEPER_WRAPS, name: \"Mothkeeper's Wraps\", slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.EX_DIRIS, name: 'Ex Diris' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.ARC.HUNTER.SUPER.GATHERING_STORM,\r\n      superName: 'Gathering Storm',\r\n      aspectHashes: [SUBCLASS_HASHES.ARC.HUNTER.ASPECTS.FLOW_STATE, SUBCLASS_HASHES.ARC.HUNTER.ASPECTS.ASCENSION],\r\n      aspectNames: ['Flow State', 'Ascension'],\r\n      fragmentHashes: [SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_SHOCK, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_IONS, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_RESISTANCE, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_AMPLITUDE],\r\n      fragmentNames: ['Spark of Shock', 'Spark of Ions', 'Spark of Resistance', 'Spark of Amplitude'],\r\n      meleeHash: SUBCLASS_HASHES.ARC.HUNTER.MELEE.COMBINATION_BLOW,\r\n      meleeName: 'Combination Blow',\r\n      grenadeHash: SUBCLASS_HASHES.ARC.HUNTER.GRENADES.STORM,\r\n      grenadeName: 'Storm Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.ARC.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: \"Gambler's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.ARC.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription: 'Converts your grenade into a cage of loyal moths that track enemies to explode or track allies to grant overshields. Ex Diris spawns more moths.',\r\n    playstyle: 'Spam moths everywhere. Use Ex Diris to keep the swarm growing. Great for both add clear and team protection.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['neutral', 'moths', 'overshield', 'hunter'],\r\n  },\r\n  {\r\n    id: 'warlock-stasis-osmiomancy-freeze',\r\n    name: 'Glacial Overlord',\r\n    element: ElementType.Stasis,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.WitchQueen,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.OSMIOMANCY_GLOVES, name: 'Osmiomancy Gloves', slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.KINETIC.AGERS_SCEPTER, name: \"Ager's Scepter\" },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STASIS.WARLOCK.SUPER.WINTERS_WRATH,\r\n      superName: \"Winter's Wrath\",\r\n      aspectHashes: [SUBCLASS_HASHES.STASIS.WARLOCK.ASPECTS.BLEAK_WATCHER, SUBCLASS_HASHES.STASIS.WARLOCK.ASPECTS.ICEFLARE_BOLTS],\r\n      aspectNames: ['Bleak Watcher', 'Iceflare Bolts'],\r\n      fragmentHashes: [SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_HEDRONS, SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_DURANCE, SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_REFRACTION, SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_BONDS],\r\n      fragmentNames: ['Whisper of Hedrons', 'Whisper of Durance', 'Whisper of Refraction', 'Whisper of Bonds'],\r\n      meleeHash: SUBCLASS_HASHES.STASIS.WARLOCK.MELEE.PENUMBRAL_BLAST,\r\n      meleeName: 'Penumbral Blast',\r\n      grenadeHash: SUBCLASS_HASHES.STASIS.WARLOCK.GRENADES.COLDSNAP,\r\n      grenadeName: 'Coldsnap Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STASIS.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.STASIS.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Grants a second Coldsnap charge with significantly improved tracking and energy refund on hits. Bleak Watchers last much longer.',\r\n    playstyle: 'Lock down the entire room with multiple Bleak Watcher turrets. Use Ager\\'s Scepter to shatter everything.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['stasis', 'freeze', 'warlock', 'crowd-control'],\r\n  },\r\n  {\r\n    id: 'warlock-solar-sunbracers-polaris',\r\n    name: 'Solar Ignition Loop',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BeyondLight,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.SUNBRACERS, name: 'Sunbracers', slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.POLARIS_LANCE, name: 'Polaris Lance' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.WELL_OF_RADIANCE,\r\n      superName: 'Well of Radiance',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME, SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.HEAT_RISES],\r\n      aspectNames: ['Touch of Flame', 'Heat Rises'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Char', 'Ember of Empyrean', 'Ember of Solace'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.INCINERATOR_SNAP,\r\n      meleeName: 'Incinerator Snap',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n      grenadeName: 'Solar Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Melee kills grant infinite Solar grenades for a short duration. Polaris Lance causes ignitions to keep the heat growing.',\r\n    playstyle: 'Kill a red bar with your snap, then carpet the floor in Solar grenades. Use Polaris Lance at range to ignite high-health targets.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'explosions', 'warlock', 'grenades'],\r\n  },\r\n  {\r\n    id: 'warlock-solar-dawn-polaris',\r\n    name: 'Scorching Vision',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BeyondLight,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.DAWN_CHORUS, name: 'Dawn Chorus', slot: ItemSlot.Helmet },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.POLARIS_LANCE, name: 'Polaris Lance' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.SONG_OF_FLAME,\r\n      superName: 'Song of Flame',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.HELLION, SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME],\r\n      aspectNames: ['Hellion', 'Touch of Flame'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SINGEING],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Char', 'Ember of Empyrean', 'Ember of Singeing'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.INCINERATOR_SNAP,\r\n      meleeName: 'Incinerator Snap',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n      grenadeName: 'Solar Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Dawn Chorus makes your Scorch deal more damage and grants melee energy when you damage scorched targets. Polaris Lance applies massive scorch.',\r\n    playstyle: 'Stay at range and use Polaris Lance to ignite everything. Every ignition refunds melee energy thanks to the helmet.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['solar', 'scorch', 'warlock', 'precision'],\r\n  },\r\n  {\r\n    id: 'warlock-solar-starfire-polaris',\r\n    name: 'Fusion Firestorm',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.BaseGame,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.STARFIRE_PROTOCOL, name: 'Starfire Protocol', slot: ItemSlot.Chest },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.POLARIS_LANCE, name: 'Polaris Lance' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.WELL_OF_RADIANCE,\r\n      superName: 'Well of Radiance',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME, SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.HELLION],\r\n      aspectNames: ['Touch of Flame', 'Hellion'],\r\n      fragmentHashes: [\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN,\r\n        SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_RESOLVE\r\n      ],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Char', 'Ember of Empyrean', 'Ember of Resolve'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.INCINERATOR_SNAP,\r\n      meleeName: 'Incinerator Snap',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.FUSION,\r\n      grenadeName: 'Fusion Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.EMPOWERING_RIFT,\r\n      classAbilityName: 'Empowering Rift',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Fusion Grenade hits grant Class Ability energy. Empowered weapon damage grants Fusion Grenade energy. Polaris Lance provides constant precision damage to fuel the loop.',\r\n    playstyle: 'Drop an Empowering Rift and land precision shots with Polaris Lance to rapidly regen Fusion Grenades. Use grenades to get your rift back.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'grenades', 'warlock', 'infinite-loop'],\r\n  },\r\n  {\r\n    id: 'hunter-solar-caliban-polaris',\r\n    name: 'Explosive Precision',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.BeyondLight,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_HUNTER.CALIBAN_HAND, name: \"Caliban's Hand\", slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.POLARIS_LANCE, name: 'Polaris Lance' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.HUNTER.SUPER.BLADE_BARRAGE,\r\n      superName: 'Blade Barrage',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.KNOCK_EM_DOWN, SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.ON_YOUR_MARK],\r\n      aspectNames: ['Knock \\'Em Down', 'On Your Mark'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Char', 'Ember of Empyrean', 'Ember of Torches'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.HUNTER.MELEE.PROXIMITY_EXPLOSIVE_KNIFE,\r\n      meleeName: 'Proximity Explosive Knife',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.HUNTER.GRENADES.SOLAR,\r\n      grenadeName: 'Solar Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: \"Gambler's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription: \"Proximity Knife causes ignitions on direct hits. Polaris Lance provides the perfect long-range solar complement for constant scorch.\",\r\n    playstyle: 'Throw your knife into groups and shoot the perfect fifth into those who survive. Everything explodes.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'ignitions', 'hunter', 'explosions'],\r\n  },\r\n  {\r\n    id: 'warlock-arc-getaway-artist',\r\n    name: 'Sentient Thunder',\r\n    element: ElementType.Arc,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.Forsaken,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.GETAWAY_ARTIST, name: 'Getaway Artist', slot: ItemSlot.Arms },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.ARC.WARLOCK.SUPER.STORMTRANCE,\r\n      superName: 'Stormtrance',\r\n      aspectHashes: [SUBCLASS_HASHES.ARC.WARLOCK.ASPECTS.ARC_SOUL, SUBCLASS_HASHES.ARC.WARLOCK.ASPECTS.ELECTROSTATIC_MIND],\r\n      aspectNames: ['Arc Soul', 'Electrostatic Mind'],\r\n      fragmentHashes: [SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_SHOCK, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_IONS, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_RESISTANCE, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_MAGNITUDE],\r\n      fragmentNames: ['Spark of Shock', 'Spark of Ions', 'Spark of Resistance', 'Spark of Magnitude'],\r\n      meleeHash: SUBCLASS_HASHES.ARC.WARLOCK.MELEE.BALL_LIGHTNING,\r\n      meleeName: 'Ball Lightning',\r\n      grenadeHash: SUBCLASS_HASHES.ARC.WARLOCK.GRENADES.STORM,\r\n      grenadeName: 'Storm Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.ARC.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.ARC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Consume your grenade to summon a supercharged, auto-firing Arc Soul. Pairs perfectly with Arc weapons to maintain amplification.',\r\n    playstyle: 'Keep your Sentient Soul active at all times. Use Electrostatic Mind to generate Ionic Traces for constant grenade energy.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['arc-soul', 'passive-damage', 'warlock', 'arc'],\r\n  },\r\n  {\r\n    id: 'warlock-prismatic-getaway-turret',\r\n    name: 'Prismatic Battery',\r\n    element: ElementType.Prismatic,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.GETAWAY_ARTIST, name: 'Getaway Artist', slot: ItemSlot.Arms },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.SUPER.SONG_OF_FLAME,\r\n      superName: 'Song of Flame',\r\n      aspectHashes: [SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.BLEAK_WATCHER, SUBCLASS_HASHES.PRISMATIC.WARLOCK.ASPECTS.FEED_THE_VOID],\r\n      aspectNames: ['Bleak Watcher', 'Feed the Void'],\r\n      fragmentHashes: [SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_DAWN, SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_HOPE, SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_PROTECTION, SUBCLASS_HASHES.PRISMATIC.FRAGMENTS.FACET_OF_BALANCE],\r\n      fragmentNames: ['Facet of Dawn', 'Facet of Hope', 'Facet of Protection', 'Facet of Balance'],\r\n      meleeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.MELEE.ARCANE_NEEDLE,\r\n      meleeName: 'Arcane Needle',\r\n      grenadeHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.GRENADES.STORM,\r\n      grenadeName: 'Storm Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.PRISMATIC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Consuming your grenade spawns BOTH a supercharged Arc Soul AND a Stasis Bleak Watcher turret. Feed the Void ensures constant grenade energy.',\r\n    playstyle: 'A support-damage hybrid. Lock down rooms with Stasis turrets while your auto-firing Arc Soul melts targets.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['prismatic', 'turrets', 'warlock', 'support'],\r\n  },\r\n\r\n  {\r\n    id: 'titan-strand-service-of-luzaku',\r\n    name: 'Hive Memory Shield',\r\n    element: ElementType.Strand,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_TITAN.ABEYANT_LEAP, name: 'Abeyant Leap', slot: ItemSlot.Legs },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.POWER.SERVICE_OF_LUZAKU, name: 'Service of Luzaku' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STRAND.TITAN.SUPER.BLADEFURY,\r\n      superName: 'Bladefury',\r\n      aspectHashes: [SUBCLASS_HASHES.STRAND.TITAN.ASPECTS.BANNER_OF_WAR, SUBCLASS_HASHES.STRAND.TITAN.ASPECTS.INTO_THE_FRAY],\r\n      aspectNames: ['Banner of War', 'Into the Fray'],\r\n      fragmentHashes: [SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_WARDING, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_FURY, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_GENERATION, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_CONTINUITY],\r\n      fragmentNames: ['Thread of Warding', 'Thread of Fury', 'Thread of Generation', 'Thread of Continuity'],\r\n      meleeHash: SUBCLASS_HASHES.STRAND.TITAN.MELEE.FRENZIED_BLADE,\r\n      meleeName: 'Frenzied Blade',\r\n      grenadeHash: SUBCLASS_HASHES.STRAND.TITAN.GRENADES.SHACKLE,\r\n      grenadeName: 'Shackle Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STRAND.TITAN.CLASS_ABILITIES.TOWERING_BARRICADE,\r\n      classAbilityName: 'Towering Barricade',\r\n      jumpHash: SUBCLASS_HASHES.STRAND.TITAN.JUMPS.STRAFE_LIFT,\r\n      jumpName: 'Strafe Lift',\r\n    },\r\n    loopDescription: 'Rapid hits with Service of Luzaku create a Hive Shield. Combine with Banner of War for ultimate frontline survivability.',\r\n    playstyle: 'The ultimate tank. Charge into battle, unleash needle fire to unravel targets, and stay alive with your custom frontal shield.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['strand', 'tank', 'titan', 'defense'],\r\n  },\r\n\r\n\r\n\r\n  {\r\n    id: 'warlock-arc-getaway-centrifuse',\r\n    name: 'Sentient Thunder',\r\n    element: ElementType.Arc,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.Forsaken,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.GETAWAY_ARTIST, name: 'Getaway Artist', slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.CENTRIFUSE, name: 'Centrifuse' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.ARC.WARLOCK.SUPER.STORMTRANCE,\r\n      superName: 'Stormtrance',\r\n      aspectHashes: [SUBCLASS_HASHES.ARC.WARLOCK.ASPECTS.ARC_SOUL, SUBCLASS_HASHES.ARC.WARLOCK.ASPECTS.ELECTROSTATIC_MIND],\r\n      aspectNames: ['Arc Soul', 'Electrostatic Mind'],\r\n      fragmentHashes: [SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_IONS, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_SHOCK, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_AMPLITUDE, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_RECHARGE],\r\n      fragmentNames: ['Spark of Ions', 'Spark of Shock', 'Spark of Amplitude', 'Spark of Recharge'],\r\n      meleeHash: SUBCLASS_HASHES.ARC.WARLOCK.MELEE.CHAIN_LIGHTNING,\r\n      meleeName: 'Chain Lightning',\r\n      grenadeHash: SUBCLASS_HASHES.ARC.WARLOCK.GRENADES.STORM,\r\n      grenadeName: 'Storm Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.ARC.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.ARC.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Consume your grenade to summon a Sentient Arc Soul. Centrifuse builds charge as you sprint, blinding enemies and feeding your arc engine.',\r\n    playstyle: 'Run and gun. Keep moving to charge Centrifuse and let your Arc Soul auto-target everything nearby.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['warlock', 'arc', 'speed', 'battlemage', 'auto-rifle'],\r\n  },\r\n\r\n  {\r\n    id: 'titan-strand-stronghold-lament',\r\n    name: 'Immortal Guard',\r\n    element: ElementType.Strand,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_TITAN.STRONGHOLD, name: 'Stronghold', slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.POWER.THE_LAMENT, name: 'The Lament' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STRAND.TITAN.SUPER.BLADEFURY,\r\n      superName: 'Bladefury',\r\n      aspectHashes: [SUBCLASS_HASHES.STRAND.TITAN.ASPECTS.BANNER_OF_WAR, SUBCLASS_HASHES.STRAND.TITAN.ASPECTS.INTO_THE_FRAY],\r\n      aspectNames: ['Banner of War', 'Into the Fray'],\r\n      fragmentHashes: [SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_WARDING, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_FURY, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_GENERATION, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_CONTINUITY],\r\n      fragmentNames: ['Thread of Warding', 'Thread of Fury', 'Thread of Generation', 'Thread of Continuity'],\r\n      meleeHash: SUBCLASS_HASHES.STRAND.TITAN.MELEE.FRENZIED_BLADE,\r\n      meleeName: 'Frenzied Blade',\r\n      grenadeHash: SUBCLASS_HASHES.STRAND.TITAN.GRENADES.SHACKLE,\r\n      grenadeName: 'Shackle Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STRAND.TITAN.CLASS_ABILITIES.TOWERING_BARRICADE,\r\n      classAbilityName: 'Towering Barricade',\r\n      jumpHash: SUBCLASS_HASHES.STRAND.TITAN.JUMPS.STRAFE_LIFT,\r\n      jumpName: 'Strafe Lift',\r\n    },\r\n    loopDescription: 'Stronghold makes your guard infinite and heals you on blocks. The Lament shreds everything. Banner of War heals your team.',\r\n    playstyle: 'The \"Immortal King\". Block damage to heal, rev up The Lament to erase champions, and keep Banner of War stacking.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['tank', 'sword', 'titan', 'stronghold', 'strand'],\r\n  },\r\n  {\r\n    id: 'warlock-solar-chromatic-outbreak',\r\n    name: 'Nanite Explosion',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.CHROMATIC_FIRE, name: 'Chromatic Fire', slot: ItemSlot.Chest },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.KINETIC.OUTBREAK_PERFECTED, name: 'Outbreak Perfected' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.WELL_OF_RADIANCE,\r\n      superName: 'Well of Radiance',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME, SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.HELLION],\r\n      aspectNames: ['Touch of Flame', 'Hellion'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_BENEVOLENCE, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES],\r\n      fragmentNames: ['Ember of Benevolence', 'Ember of Torches', 'Ember of Empyrean', 'Ember of Ashes'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.INCINERATOR_SNAP,\r\n      meleeName: 'Incinerator Snap',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n      grenadeName: 'Solar Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Precision kills with Outbreak Perfected create BOTH SIVA nanites AND Solar explosions from Chromatic Fire. The ultimate ad-clear display.',\r\n    playstyle: 'Precision management. Land headshots to trigger dual explosions that wipe out clusters of enemies instantly.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['warlock', 'solar', 'explosion', 'siva', 'kinetic'],\r\n  },\r\n  {\r\n    id: 'hunter-void-graviton-heartshadow',\r\n    name: 'Spectral Shadow',\r\n    element: ElementType.Void,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_HUNTER.GRAVITON_FORFEIT, name: 'Graviton Forfeit', slot: ItemSlot.Helmet },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.POWER.HEARTSHADOW, name: 'Heartshadow' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.VOID.HUNTER.SUPER.SHADOWSHOT_DEADFALL,\r\n      superName: 'Shadowshot: Deadfall',\r\n      aspectHashes: [SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.VANISHING_STEP, SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.STYLISH_EXECUTIONER],\r\n      aspectNames: ['Vanishing Step', 'Stylish Executioner'],\r\n      fragmentHashes: [SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_OBSCURITY, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_STARVATION, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_PERSISTENCE, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_LEECHING],\r\n      fragmentNames: ['Echo of Obscurity', 'Echo of Starvation', 'Echo of Persistence', 'Echo of Leeching'],\r\n      meleeHash: SUBCLASS_HASHES.VOID.HUNTER.MELEE.SNARE_BOMB,\r\n      meleeName: 'Snare Bomb',\r\n      grenadeHash: SUBCLASS_HASHES.VOID.HUNTER.GRENADES.VORTEX,\r\n      grenadeName: 'Vortex Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.VOID.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: 'Gambler\\'s Dodge',\r\n      jumpHash: SUBCLASS_HASHES.VOID.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription: 'Heartshadow grants invisibility on heavy attacks. Graviton Forfeit extends it. Stylish Executioner lets you chain invisible kills forever.',\r\n    playstyle: 'True Assassin. Strike from the shadows with your void sword, vanish, and reposition. You are never seen.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['hunter', 'void', 'stealth', 'sword', 'invisibility'],\r\n  },\r\n  {\r\n    id: 'titan-solar-pyrogale-sunshot',\r\n    name: 'Burning Cyclone',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_TITAN.PYROGALE_GAUNTLETS, name: 'Pyrogale Gauntlets', slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.SUNSHOT, name: 'Sunshot' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.TITAN.SUPER.BURNING_MAUL,\r\n      superName: 'Burning Maul',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.ROARING_FLAMES, SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.SOL_INVICTUS],\r\n      aspectNames: ['Roaring Flames', 'Sol Invictus'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_BLISTERING, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Blazing', 'Ember of Empyrean', 'Ember of Solace'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.TITAN.MELEE.THROWING_HAMMER,\r\n      meleeName: 'Throwing Hammer',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.TITAN.GRENADES.THERMITE,\r\n      grenadeName: 'Thermite Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.TITAN.CLASS_ABILITIES.RALLY_BARRICADE,\r\n      classAbilityName: 'Rally Barricade',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.TITAN.JUMPS.STRAFE_LIFT,\r\n      jumpName: 'Strafe Lift',\r\n    },\r\n    loopDescription: 'Sunshot chains explosions to build Roaring Flames. Consecration (from Pyrogale effect) and Burning Maul creates massive fire cyclones.',\r\n    playstyle: 'Explosive carnage. Use Sunshot for adds, and drop the Pyrogale hammer on bosses.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['titan', 'solar', 'explosions', 'sunspot', 'dps'],\r\n  },\r\n\r\n\r\n\r\n\r\n\r\n  // ===== RENEGADES & EDGE OF FATE SYNERGIES =====\r\n\r\n  // HEIRLOOM (Solar Bow - \"Bowcaster\")\r\n  {\r\n    id: 'hunter-solar-heirloom-explosion',\r\n    name: 'Wookiee Demolitionist',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.FinalShape, // Assuming requirement\r\n    exoticArmor: { hash: EXOTIC_ARMOR_HUNTER.CALIBAN_HAND, name: \"Caliban's Hand\", slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.HEIRLOOM, name: 'Heirloom' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.HUNTER.SUPER.BLADE_BARRAGE,\r\n      superName: 'Blade Barrage',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.KNOCK_EM_DOWN, SUBCLASS_HASHES.SOLAR.HUNTER.ASPECTS.GUNPOWDER_GAMBLE],\r\n      aspectNames: ['Knock \\'Em Down', 'Gunpowder Gamble'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ERUPTION, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_TORCHES],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Char', 'Ember of Eruption', 'Ember of Torches'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.HUNTER.MELEE.PROXIMITY_EXPLOSIVE_KNIFE,\r\n      meleeName: 'Proximity Explosive Knife',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.HUNTER.GRENADES.TRIPMINE,\r\n      grenadeName: 'Tripmine Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: \"Gambler's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription: 'Heirloom\\'s explosive bolts trigger Solar ignitions. Caliban\\'s Hand ensures your knives also explode. Gunpowder Gamble adds even more explosions.',\r\n    playstyle: 'Charge your bow for maximum blast radius, then follow up with explosive knives. Everything burns.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'bow', 'explosion', 'hunter', 'caliban'],\r\n  },\r\n  {\r\n    id: 'warlock-solar-heirloom-rain',\r\n    name: 'Orbital Bombardment',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.RAIN_OF_FIRE, name: 'Rain of Fire', slot: ItemSlot.Legs },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.HEIRLOOM, name: 'Heirloom' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.SONG_OF_FLAME,\r\n      superName: 'Song of Flame',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME, SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.ICARUS_DASH],\r\n      aspectNames: ['Touch of Flame', 'Icarus Dash'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_EMPYREAN, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SOLACE, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SEARING],\r\n      fragmentNames: ['Ember of Empyrean', 'Ember of Solace', 'Ember of Ashes', 'Ember of Searing'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.INCINERATOR_SNAP,\r\n      meleeName: 'Incinerator Snap',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n      grenadeName: 'Solar Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Air dashes reload Heirloom instantly (Rain of Fire). Hover above the battlefield raining down explosive solar bolts.',\r\n    playstyle: 'Aerial superiority. Dash to reload, charge a shot, fire, repeat. Keep radiant active 100% of the time.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['solar', 'bow', 'aerial', 'warlock', 'rain-of-fire'],\r\n  },\r\n\r\n  // PRAXIC VESTMENT (Titan Arc - \"Jetpack\")\r\n  {\r\n    id: 'titan-arc-praxic-vestment',\r\n    name: 'Thunderbird',\r\n    element: ElementType.Arc,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_TITAN.PRAXIC_VESTMENT, name: 'Praxic Vestment', slot: ItemSlot.Chest },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.RISKRUNNER, name: 'Riskrunner' }, // Good Arc Pairing\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.ARC.TITAN.SUPER.THUNDERCRASH,\r\n      superName: 'Thundercrash',\r\n      aspectHashes: [SUBCLASS_HASHES.ARC.TITAN.ASPECTS.KNOCKOUT, SUBCLASS_HASHES.ARC.TITAN.ASPECTS.TOUCH_OF_THUNDER],\r\n      aspectNames: ['Knockout', 'Touch of Thunder'],\r\n      fragmentHashes: [SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_RESISTANCE, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_SHOCK, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_RECHARGE, SUBCLASS_HASHES.ARC.FRAGMENTS.SPARK_OF_AMPLITUDE],\r\n      fragmentNames: ['Spark of Resistance', 'Spark of Shock', 'Spark of Recharge', 'Spark of Amplitude'],\r\n      meleeHash: SUBCLASS_HASHES.ARC.TITAN.MELEE.BALLISTIC_SLAM,\r\n      meleeName: 'Ballistic Slam',\r\n      grenadeHash: SUBCLASS_HASHES.ARC.TITAN.GRENADES.PULSE,\r\n      grenadeName: 'Pulse Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.ARC.TITAN.CLASS_ABILITIES.THRUSTER,\r\n      classAbilityName: 'Thruster',\r\n      jumpHash: SUBCLASS_HASHES.ARC.TITAN.JUMPS.STRAFE_LIFT,\r\n      jumpName: 'Strafe Lift',\r\n    },\r\n    loopDescription: 'Arc kills build fuel for Praxic Vestment\\'s jetpack. Boost into the air and slam down with Ballistic Slam or the jetpack collision.',\r\n    playstyle: 'Hyper-aggressive aerial assault. Use Riskrunner to stay safe from Arc damage while building fuel.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['arc', 'titan', 'jetpack', 'mobility', 'slam'],\r\n  },\r\n\r\n  // DEIMOSUFFUSION (Warlock Strand - \"Rift Suspend\")\r\n  {\r\n    id: 'warlock-strand-deimosuffusion',\r\n    name: 'Weaver\\'s Trap',\r\n    element: ElementType.Strand,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.DEIMOSUFFUSION, name: 'Deimosuffusion', slot: ItemSlot.Helmet },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.KINETIC.WISH_KEEPER, name: 'Wish-Keeper' }, // Strand Bow for more suspend\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STRAND.WARLOCK.SUPER.NEEDLESTORM,\r\n      superName: 'Needlestorm',\r\n      aspectHashes: [SUBCLASS_HASHES.STRAND.WARLOCK.ASPECTS.THE_WANDERER, SUBCLASS_HASHES.STRAND.WARLOCK.ASPECTS.MINDSPUN_INVOCATION],\r\n      aspectNames: ['The Wanderer', 'Mindspun Invocation'],\r\n      fragmentHashes: [SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_MIND, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_WISDOM, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_GENERATION, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_CONTINUITY],\r\n      fragmentNames: ['Thread of Mind', 'Thread of Wisdom', 'Thread of Generation', 'Thread of Continuity'],\r\n      meleeHash: SUBCLASS_HASHES.STRAND.WARLOCK.MELEE.ARCANE_NEEDLE,\r\n      meleeName: 'Arcane Needle',\r\n      grenadeHash: SUBCLASS_HASHES.STRAND.WARLOCK.GRENADES.SHACKLE,\r\n      grenadeName: 'Shackle Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STRAND.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.STRAND.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Casting Rift suspends everyone nearby (Deimosuffusion). Suspended targets take DOT and heal you. Wish-Keeper traps any survivors.',\r\n    playstyle: 'Drop your rift aggressively in the middle of enemies. Watch them hang helpless while you heal.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['strand', 'warlock', 'suspend', 'control', 'healing'],\r\n  },\r\n\r\n  // FORTUNE'S FAVOR (Hunter Void - \"Overshield DPS\")\r\n  {\r\n    id: 'hunter-void-fortune-favor',\r\n    name: 'Void Apex',\r\n    element: ElementType.Void,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_HUNTER.FORTUNES_FAVOR, name: \"Fortune's Favor\", slot: ItemSlot.Legs },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.GRAVITON_LANCE, name: 'Graviton Lance' }, // Long range void\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.VOID.HUNTER.SUPER.SHADOWSHOT_MOEBIUS_QUIVER,\r\n      superName: 'Moebius Quiver',\r\n      aspectHashes: [SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.STYLISH_EXECUTIONER, SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.VANISHING_STEP],\r\n      aspectNames: ['Stylish Executioner', 'Vanishing Step'],\r\n      fragmentHashes: [SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_VIGILANCE, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_PERSISTENCE, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_STARVATION, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_LEECHING],\r\n      fragmentNames: ['Echo of Vigilance', 'Echo of Persistence', 'Echo of Starvation', 'Echo of Leeching'],\r\n      meleeHash: SUBCLASS_HASHES.VOID.HUNTER.MELEE.SNARE_BOMB,\r\n      meleeName: 'Snare Bomb',\r\n      grenadeHash: SUBCLASS_HASHES.VOID.HUNTER.GRENADES.VORTEX,\r\n      grenadeName: 'Vortex Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.VOID.HUNTER.CLASS_ABILITIES.MARKSMANS_DODGE,\r\n      classAbilityName: \"Marksman's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.VOID.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription: 'Get a kill at full health to gain a Void Overshield. While shielded, enjoy +20% damage and laser-beam accuracy with simple weapons like Graviton Lance.',\r\n    playstyle: 'Marksman. Keep your distance, keep your health full, and chain kills to maintain the damage buff.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['void', 'hunter', 'damage-buff', 'overshield', 'neutral'],\r\n  },\r\n\r\n  // SERVICE OF LUZAKU (Refined - Strand Warlock Threadlings)\r\n  {\r\n    id: 'warlock-strand-luzaku',\r\n    name: 'Brood Mother\\'s Wrath',\r\n    element: ElementType.Strand,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.SWARMERS, name: 'Swarmers', slot: ItemSlot.Legs },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.POWER.SERVICE_OF_LUZAKU, name: 'Service of Luzaku' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STRAND.WARLOCK.SUPER.NEEDLESTORM,\r\n      superName: 'Needlestorm',\r\n      aspectHashes: [SUBCLASS_HASHES.STRAND.WARLOCK.ASPECTS.WEAVERS_CALL, SUBCLASS_HASHES.STRAND.WARLOCK.ASPECTS.THE_WANDERER],\r\n      aspectNames: ['Weaver\\'s Call', 'The Wanderer'],\r\n      fragmentHashes: [SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_EVOLUTION, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_REBIRTH, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_GENERATION, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_WARDING],\r\n      fragmentNames: ['Thread of Evolution', 'Thread of Rebirth', 'Thread of Generation', 'Thread of Warding'],\r\n      meleeHash: SUBCLASS_HASHES.STRAND.WARLOCK.MELEE.ARCANE_NEEDLE,\r\n      meleeName: 'Arcane Needle',\r\n      grenadeHash: SUBCLASS_HASHES.STRAND.WARLOCK.GRENADES.THREADLING,\r\n      grenadeName: 'Threadling Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STRAND.WARLOCK.CLASS_ABILITIES.HEALING_RIFT,\r\n      classAbilityName: 'Healing Rift',\r\n      jumpHash: SUBCLASS_HASHES.STRAND.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Service of Luzaku spawns Threadlings on hip-fire. Swarmers makes them Unravel. Warlock aspects create even more Threadlings.',\r\n    playstyle: 'Summoner. Hip-fire your LMG to flood the field with minions while staying healed.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['strand', 'warlock', 'threadlings', 'summoner', 'lmg'],\r\n  },\r\n\r\n  // WHIRLING OVATION (Solar Rocket Launcher - \"Maelstrom\")\r\n  {\r\n    id: 'titan-solar-whirling-ovation',\r\n    name: 'Scorched Earth Protocol',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_TITAN.PYROGALE_GAUNTLETS, name: 'Pyrogale Gauntlets', slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.POWER.WHIRLING_OVATION, name: 'Whirling Ovation' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.TITAN.SUPER.BURNING_MAUL,\r\n      superName: 'Burning Maul',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.ROARING_FLAMES, SUBCLASS_HASHES.SOLAR.TITAN.ASPECTS.SOL_INVICTUS],\r\n      aspectNames: ['Roaring Flames', 'Sol Invictus'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ERUPTION, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SEARING],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Char', 'Ember of Eruption', 'Ember of Searing'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.TITAN.MELEE.THROWING_HAMMER,\r\n      meleeName: 'Throwing Hammer',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.TITAN.GRENADES.THERMITE,\r\n      grenadeName: 'Thermite Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.TITAN.CLASS_ABILITIES.RALLY_BARRICADE,\r\n      classAbilityName: 'Rally Barricade',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.TITAN.JUMPS.STRAFE_LIFT,\r\n      jumpName: 'Strafe Lift',\r\n    },\r\n    loopDescription: 'Whirling Ovation charges quickly and deals massive Solar damage. Pyrogale Gauntlets turn your super into a boss-melting nuke. Roaring Flames buffs both.',\r\n    playstyle: 'Boss Damage Specialist. Stack Roaring Flames with abilities, then unleash rockets and your Pyrogale super.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'titan', 'dps', 'rockets', 'pyrogale'],\r\n  },\r\n\r\n  // GRAVITON SPIKE (Arc/Stasis HC - \"Dual Mode\")\r\n  {\r\n    id: 'hunter-arc-graviton-spike',\r\n    name: 'Temporal Shock',\r\n    element: ElementType.Arc,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_HUNTER.MASK_OF_BAKRIS, name: 'Mask of Bakris', slot: ItemSlot.Helmet },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.GRAVITON_SPIKE, name: 'Graviton Spike' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STASIS.HUNTER.SUPER.SILENCE_AND_SQUALL, // Bakris usage often implies Stasis subclass for shift\r\n      superName: 'Silence and Squall',\r\n      aspectHashes: [SUBCLASS_HASHES.STASIS.HUNTER.ASPECTS.WINTERS_SHROUD, SUBCLASS_HASHES.STASIS.HUNTER.ASPECTS.TOUCH_OF_WINTER],\r\n      aspectNames: ['Winter\\'s Shroud', 'Touch of Winter'],\r\n      fragmentHashes: [SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_HEDRONS, SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_IMPETUS, SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_FISSURES, SUBCLASS_HASHES.STASIS.FRAGMENTS.WHISPER_OF_REFRACTION],\r\n      fragmentNames: ['Whisper of Hedrons', 'Whisper of Impetus', 'Whisper of Fissures', 'Whisper of Refraction'],\r\n      meleeHash: SUBCLASS_HASHES.STASIS.HUNTER.MELEE.WITHERING_BLADE,\r\n      meleeName: 'Withering Blade',\r\n      grenadeHash: SUBCLASS_HASHES.STASIS.HUNTER.GRENADES.DUSKFIELD,\r\n      grenadeName: 'Duskfield Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.STASIS.HUNTER.CLASS_ABILITIES.MARKSMANS_DODGE,\r\n      classAbilityName: \"Marksman's Dodge\", // Shift replaces this\r\n      jumpHash: SUBCLASS_HASHES.STASIS.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription: 'Graviton Spike swaps between Arc and Stasis. Mask of Bakris buffs BOTH damage types after shifting. Kills in one mode charge the other.',\r\n    playstyle: 'Shift behind enemies, unleash Arc fire, freeze them with Stasis mode, shatter them intact. Maximum hybrid synergy.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['stasis', 'arc', 'hybrid', 'hunter', 'bakris'],\r\n  },\r\n\r\n  // THIRD ITERATION (Void Scout - \"Invis Marker\")\r\n  {\r\n    id: 'hunter-void-third-iteration',\r\n    name: 'Iterative Stalker',\r\n    element: ElementType.Void,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_HUNTER.GYRFALCONS_HAUBERK, name: \"Gyrfalcon's Hauberk\", slot: ItemSlot.Chest },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.THIRD_ITERATION, name: 'Third Iteration' },\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.VOID.HUNTER.SUPER.SHADOWSHOT_DEADFALL,\r\n      superName: 'Shadowshot: Deadfall',\r\n      aspectHashes: [SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.STYLISH_EXECUTIONER, SUBCLASS_HASHES.VOID.HUNTER.ASPECTS.VANISHING_STEP],\r\n      aspectNames: ['Stylish Executioner', 'Vanishing Step'],\r\n      fragmentHashes: [SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_OBSCURITY, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_STARVATION, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_PERSISTENCE, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_INSTABILITY],\r\n      fragmentNames: ['Echo of Obscurity', 'Echo of Starvation', 'Echo of Persistence', 'Echo of Instability'],\r\n      meleeHash: SUBCLASS_HASHES.VOID.HUNTER.MELEE.SNARE_BOMB,\r\n      meleeName: 'Snare Bomb',\r\n      grenadeHash: SUBCLASS_HASHES.VOID.HUNTER.GRENADES.VORTEX,\r\n      grenadeName: 'Vortex Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.VOID.HUNTER.CLASS_ABILITIES.GAMBLERS_DODGE,\r\n      classAbilityName: \"Gambler's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.VOID.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription: 'Third Iteration marks targets and grants invisibility on kills. Gyrfalcon\\'s Hauberk gives Volatile Rounds when you exit invisibility. It\\'s an infinite loop.',\r\n    playstyle: 'Mark enemies from safe distance. Kill them to vanishing. Reappear with explosive volatile rounds.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['void', 'hunter', 'volatile', 'invisibility', 'scout'],\r\n  },\r\n\r\n  // MOIRAI (Hunter Strand Chest - \"Webcatcher\")\r\n  {\r\n    id: 'hunter-strand-moirai',\r\n    name: 'Weaver\\'s Retrieval',\r\n    element: ElementType.Strand,\r\n    guardianClass: GuardianClass.Hunter,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_HUNTER.MOIRAI, name: 'Moirai', slot: ItemSlot.Chest },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.KINETIC.FINAL_WARNING, name: 'Final Warning' }, // Strand Sidearm creates tangles\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.STRAND.HUNTER.SUPER.SILKSTRIKE,\r\n      superName: 'Silkstrike',\r\n      aspectHashes: [SUBCLASS_HASHES.STRAND.HUNTER.ASPECTS.WHIRLING_MAELSTROM, SUBCLASS_HASHES.STRAND.HUNTER.ASPECTS.THREADED_SPECTER],\r\n      aspectNames: ['Whirling Maelstrom', 'Threaded Specter'],\r\n      fragmentHashes: [SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_GENERATION, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_WARDING, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_TRANSMUTATION, SUBCLASS_HASHES.STRAND.FRAGMENTS.THREAD_OF_EVOLUTION],\r\n      fragmentNames: ['Thread of Generation', 'Thread of Warding', 'Thread of Transmutation', 'Thread of Evolution'],\r\n      meleeHash: SUBCLASS_HASHES.STRAND.HUNTER.MELEE.THREADED_SPIKE,\r\n      meleeName: 'Threaded Spike',\r\n      grenadeHash: SUBCLASS_HASHES.STRAND.HUNTER.GRENADES.GRAPPLE,\r\n      grenadeName: 'Grapple',\r\n      classAbilityHash: SUBCLASS_HASHES.STRAND.HUNTER.CLASS_ABILITIES.MARKSMANS_DODGE,\r\n      classAbilityName: \"Marksman's Dodge\",\r\n      jumpHash: SUBCLASS_HASHES.STRAND.HUNTER.JUMPS.TRIPLE_JUMP,\r\n      jumpName: 'Triple Jump',\r\n    },\r\n    loopDescription: 'Moirai allows Threaded Spike to detonate and retrieve Tangles. Use Final Warning to generate Tangles, then use your melee to manipulate the battlefield.',\r\n    playstyle: 'Tangle Master. Create tangles, throw your spike to retrieve/detonate them, and keep Woven Mail up.',\r\n    difficulty: Difficulty.Advanced,\r\n    tags: ['strand', 'hunter', 'tangle', 'melee', 'moirai'],\r\n  },\r\n\r\n  // EUNOIA (Warlock Solar Arms - \"Hellion Carpet Bomb\")\r\n  {\r\n    id: 'warlock-solar-eunoia',\r\n    name: 'Hellfire Barrage',\r\n    element: ElementType.Solar,\r\n    guardianClass: GuardianClass.Warlock,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_WARLOCK.EUNOIA, name: 'Eunoia', slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.SUNSHOT, name: 'Sunshot' }, // More solar explosions\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.SOLAR.WARLOCK.SUPER.SONG_OF_FLAME,\r\n      superName: 'Song of Flame',\r\n      aspectHashes: [SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.HELLION, SUBCLASS_HASHES.SOLAR.WARLOCK.ASPECTS.TOUCH_OF_FLAME],\r\n      aspectNames: ['Hellion', 'Touch of Flame'],\r\n      fragmentHashes: [SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_ASHES, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_CHAR, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_SINGEING, SUBCLASS_HASHES.SOLAR.FRAGMENTS.EMBER_OF_BENEVOLENCE],\r\n      fragmentNames: ['Ember of Ashes', 'Ember of Char', 'Ember of Singeing', 'Ember of Benevolence'],\r\n      meleeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.MELEE.INCINERATOR_SNAP,\r\n      meleeName: 'Incinerator Snap',\r\n      grenadeHash: SUBCLASS_HASHES.SOLAR.WARLOCK.GRENADES.SOLAR,\r\n      grenadeName: 'Solar Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.SOLAR.WARLOCK.CLASS_ABILITIES.PHOENIX_DIVE,\r\n      classAbilityName: 'Phoenix Dive',\r\n      jumpHash: SUBCLASS_HASHES.SOLAR.WARLOCK.JUMPS.BURST_GLIDE,\r\n      jumpName: 'Burst Glide',\r\n    },\r\n    loopDescription: 'Eunoia causes your Hellion shots to explode mid-flight for AOE carpet bombing. Cast Rift/Dive to summon Hellion, then reign fire.',\r\n    playstyle: 'Artillery Mage. Summon your Solar Buddy and watch it carpet bomb everything in front of you.',\r\n    difficulty: Difficulty.Intermediate,\r\n    tags: ['solar', 'warlock', 'hellion', 'explosions', 'summoner'],\r\n  },\r\n\r\n  // MELAS PANOPLIA (Titan Arms - \"Tank/Defense\")\r\n  {\r\n    id: 'titan-void-melas-panoplia',\r\n    name: 'Void Fortress',\r\n    element: ElementType.Void,\r\n    guardianClass: GuardianClass.Titan,\r\n    requiredExpansion: Expansion.FinalShape,\r\n    exoticArmor: { hash: EXOTIC_ARMOR_TITAN.MELAS_PANOPLIA, name: 'Melas Panoplia', slot: ItemSlot.Arms },\r\n    exoticWeapon: { hash: EXOTIC_WEAPONS.ENERGY.VEXCALIBUR, name: 'Vexcalibur' }, // Void Glaive for overshields\r\n    subclassNode: {\r\n      superHash: SUBCLASS_HASHES.VOID.TITAN.SUPER.WARD_OF_DAWN,\r\n      superName: 'Ward of Dawn',\r\n      aspectHashes: [SUBCLASS_HASHES.VOID.TITAN.ASPECTS.BASTION, SUBCLASS_HASHES.VOID.TITAN.ASPECTS.OFFENSIVE_BULWARK],\r\n      aspectNames: ['Bastion', 'Offensive Bulwark'],\r\n      fragmentHashes: [SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_LEECHING, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_VIGILANCE, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_PERSISTENCE, SUBCLASS_HASHES.VOID.FRAGMENTS.ECHO_OF_REPRISAL],\r\n      fragmentNames: ['Echo of Leeching', 'Echo of Vigilance', 'Echo of Persistence', 'Echo of Reprisal'],\r\n      meleeHash: SUBCLASS_HASHES.VOID.TITAN.MELEE.SHIELD_BASH,\r\n      meleeName: 'Shield Bash',\r\n      grenadeHash: SUBCLASS_HASHES.VOID.TITAN.GRENADES.VORTEX,\r\n      grenadeName: 'Vortex Grenade',\r\n      classAbilityHash: SUBCLASS_HASHES.VOID.TITAN.CLASS_ABILITIES.TOWERING_BARRICADE,\r\n      classAbilityName: 'Towering Barricade',\r\n      jumpHash: SUBCLASS_HASHES.VOID.TITAN.JUMPS.CATAPULT_LIFT,\r\n      jumpName: 'Catapult Lift',\r\n    },\r\n    loopDescription: 'Melas Panoplia enhances your defensive capabilities. Combine with Vexcalibur and Bastion for maximum Void Overshield uptime.',\r\n    playstyle: 'The Wall. Create barriers, block damage, and protect your team with impenetrable void defenses.',\r\n    difficulty: Difficulty.Beginner,\r\n    tags: ['void', 'titan', 'tank', 'defense', 'overshield'],\r\n  },\r\n];\r\n\r\n// Helper function to get synergies by class\r\nexport function getSynergiesByClass(\r\n  guardianClass: GuardianClass,\r\n  ownedExpansions?: Expansion[]\r\n): SynergyDefinition[] {\r\n  return SYNERGY_DEFINITIONS.filter(\r\n    (s) =>\r\n      s.guardianClass === guardianClass &&\r\n      (!s.requiredExpansion || !ownedExpansions || ownedExpansions.includes(s.requiredExpansion))\r\n  );\r\n}\r\n\r\n// Helper function to get synergies by element\r\nexport function getSynergiesByElement(element: ElementType): SynergyDefinition[] {\r\n  return SYNERGY_DEFINITIONS.filter((s) => s.element === element);\r\n}\r\n\r\n// Helper function to get beginner-friendly synergies\r\nexport function getBeginnerSynergies(): SynergyDefinition[] {\r\n  return SYNERGY_DEFINITIONS.filter((s) => s.difficulty === Difficulty.Beginner);\r\n}\r\n\r\n// Helper function to search synergies by tag\r\nexport function getSynergiesByTag(tag: string): SynergyDefinition[] {\r\n  return SYNERGY_DEFINITIONS.filter((s) =>\r\n    s.tags.some((t) => t.toLowerCase().includes(tag.toLowerCase()))\r\n  );\r\n}\r\n","/**\r\n * Synergy Matcher Service\r\n * Lazy-loads synergy data by class and finds matching synergies\r\n */\r\nimport { itemSearchService, type ItemSearchResult } from './item-search.service';\r\nimport type { GuardianClass } from '../types';\r\nimport { BUCKET_HASHES } from '../config/bungie.config';\r\nimport { debugLog } from '../utils/logger';\r\n\r\n// Synergy structure from JSON files\r\nexport interface DashboardSynergy {\r\n  score: number;\r\n  classType: 0 | 1 | 2;\r\n  armor: string;\r\n  weapon: string;\r\n  buildName: string;\r\n  description: string;\r\n  subclassType: string;\r\n  super: string;\r\n  classAbility: string;\r\n  jump: string;\r\n  melee: string;\r\n  grenade: string;\r\n  aspects: string[];\r\n  fragments: string[];\r\n  fragmentSlots: number;\r\n  element: string;\r\n  transcendentAbility?: string;\r\n  definition?: any;\r\n}\r\n\r\n// Wire connection for rendering\r\nexport interface SynergyConnection {\r\n  synergy: DashboardSynergy;\r\n  sourceType: 'subclass' | 'armor' | 'weapon';\r\n  armorResult: ItemSearchResult | null;\r\n  weaponResult: ItemSearchResult | null;\r\n  element: string;\r\n}\r\n\r\nimport { SYNERGY_DEFINITIONS } from '../constants/synergy-definitions';\r\n\r\n\r\n// Valid defaults that map to keys in item-hashes.ts\r\nconst FALLBACK_DEFAULTS: Record<string, Record<number, {\r\n  super: string;\r\n  classAbility: string;\r\n  jump: string;\r\n  melee: string;\r\n  grenade: string;\r\n  aspects: string[];\r\n  fragments: string[];\r\n}>> = {\r\n  solar: {\r\n    0: { // Titan\r\n      super: 'Hammer of Sol', classAbility: 'Towering Barricade', jump: 'Strafe Lift', melee: 'Throwing Hammer', grenade: 'Thermite Grenade',\r\n      aspects: ['Sol Invictus', 'Roaring Flames'], fragments: ['Ember of Torches', 'Ember of Empyrean', 'Ember of Solace']\r\n    },\r\n    1: { // Hunter\r\n      super: 'Golden Gun: Marksman', classAbility: 'Marksman\\'s Dodge', jump: 'Triple Jump', melee: 'Knife Trick', grenade: 'Tripmine Grenade',\r\n      aspects: ['Knock \\'Em Down', 'On Your Mark'], fragments: ['Ember of Torches', 'Ember of Singeing', 'Ember of Searing']\r\n    },\r\n    2: { // Warlock\r\n      super: 'Well of Radiance', classAbility: 'Healing Rift', jump: 'Burst Glide', melee: 'Celestial Fire', grenade: 'Solar Grenade',\r\n      aspects: ['Touch of Flame', 'Heat Rises'], fragments: ['Ember of Ashes', 'Ember of Char', 'Ember of Wonder']\r\n    }\r\n  },\r\n  arc: {\r\n    0: { // Titan\r\n      super: 'Thundercrash', classAbility: 'Thruster', jump: 'Catapult Lift', melee: 'Thunderclap', grenade: 'Storm Grenade',\r\n      aspects: ['Touch of Thunder', 'Knockout'], fragments: ['Spark of Shock', 'Spark of Magnitude', 'Spark of Resistance']\r\n    },\r\n    1: { // Hunter\r\n      super: 'Gathering Storm', classAbility: 'Gambler\\'s Dodge', jump: 'Triple Jump', melee: 'Combination Blow', grenade: 'Pulse Grenade',\r\n      aspects: ['Flow State', 'Lethal Current'], fragments: ['Spark of Shock', 'Spark of Ions', 'Spark of Resistance']\r\n    },\r\n    2: { // Warlock\r\n      super: 'Chaos Reach', classAbility: 'Healing Rift', jump: 'Burst Glide', melee: 'Chain Lightning', grenade: 'Pulse Grenade',\r\n      aspects: ['Electrostatic Mind', 'Arc Soul'], fragments: ['Spark of Shock', 'Spark of Beacons', 'Spark of Discharge']\r\n    }\r\n  },\r\n  void: {\r\n    0: {\r\n      super: 'Twilight Arsenal', classAbility: 'Towering Barricade', jump: 'Strafe Lift', melee: 'Shield Throw', grenade: 'Vortex Grenade',\r\n      aspects: ['Bastion', 'Controlled Demolition'], fragments: ['Echo of Undermining', 'Echo of Starvation', 'Echo of Persistence']\r\n    },\r\n    1: {\r\n      super: 'Shadowshot: Deadfall', classAbility: 'Gambler\\'s Dodge', jump: 'Triple Jump', melee: 'Snare Bomb', grenade: 'Vortex Grenade',\r\n      aspects: ['Vanishing Step', 'Stylish Executioner'], fragments: ['Echo of Undermining', 'Echo of Starvation', 'Echo of Persistence']\r\n    },\r\n    2: {\r\n      super: 'Nova Bomb: Cataclysm', classAbility: 'Healing Rift', jump: 'Burst Glide', melee: 'Pocket Singularity', grenade: 'Vortex Grenade',\r\n      aspects: ['Feed the Void', 'Child of the Old Gods'], fragments: ['Echo of Undermining', 'Echo of Starvation', 'Echo of Remnants']\r\n    }\r\n  },\r\n  stasis: {\r\n    0: {\r\n      super: 'Glacial Quake', classAbility: 'Towering Barricade', jump: 'High Lift', melee: 'Shiver Strike', grenade: 'Glacier Grenade',\r\n      aspects: ['Tectonic Harvest', 'Diamond Lance'], fragments: ['Whisper of Shards', 'Whisper of Rime', 'Whisper of Chains']\r\n    },\r\n    1: {\r\n      super: 'Silence and Squall', classAbility: 'Marksman\\'s Dodge', jump: 'Triple Jump', melee: 'Withering Blade', grenade: 'Duskfield Grenade',\r\n      aspects: ['Touch of Winter', 'Grim Harvest'], fragments: ['Whisper of Shards', 'Whisper of Durance', 'Whisper of Chains']\r\n    },\r\n    2: {\r\n      super: 'Winter\\'s Wrath', classAbility: 'Healing Rift', jump: 'Burst Glide', melee: 'Penumbral Blast', grenade: 'Coldsnap Grenade',\r\n      aspects: ['Iceflare Bolts', 'Bleak Watcher'], fragments: ['Whisper of Torment', 'Whisper of Refraction', 'Whisper of Chains']\r\n    }\r\n  },\r\n  strand: {\r\n    0: {\r\n      super: 'Bladefury', classAbility: 'Towering Barricade', jump: 'Strafe Lift', melee: 'Frenzied Blade', grenade: 'Shackle Grenade',\r\n      aspects: ['Banner of War', 'Into the Fray'], fragments: ['Thread of Warding', 'Thread of Generation', 'Thread of Fury']\r\n    },\r\n    1: {\r\n      super: 'Silkstrike', classAbility: 'Gambler\\'s Dodge', jump: 'Triple Jump', melee: 'Threaded Spike', grenade: 'Grapple',\r\n      aspects: ['Widow\\'s Silk', 'Whirling Maelstrom'], fragments: ['Thread of Warding', 'Thread of Generation', 'Thread of Ascent']\r\n    },\r\n    2: {\r\n      super: 'Needlestorm', classAbility: 'Healing Rift', jump: 'Burst Glide', melee: 'Arcane Needle', grenade: 'Threadling Grenade',\r\n      aspects: ['Weavewalk', 'The Wanderer'], fragments: ['Thread of Warding', 'Thread of Evolution', 'Thread of Generation']\r\n    }\r\n  },\r\n  prismatic: {\r\n    0: {\r\n      super: 'Twilight Arsenal', classAbility: 'Thruster', jump: 'Strafe Lift', melee: 'Thunderclap', grenade: 'Shackle Grenade',\r\n      aspects: ['Knockout', 'Consecration'], fragments: ['Facet of Dawn', 'Facet of Hope', 'Facet of Protection']\r\n    },\r\n    1: {\r\n      super: 'Silence and Squall', classAbility: 'Gambler\\'s Dodge', jump: 'Triple Jump', melee: 'Combination Blow', grenade: 'Grapple',\r\n      aspects: ['Stylish Executioner', 'Winter\\'s Shroud'], fragments: ['Facet of Dawn', 'Facet of Hope', 'Facet of Protection']\r\n    },\r\n    2: {\r\n      super: 'Song of Flame', classAbility: 'Phoenix Dive', jump: 'Burst Glide', melee: 'Arcane Needle', grenade: 'Vortex Grenade',\r\n      aspects: ['Feed the Void', 'Hellion'], fragments: ['Facet of Dawn', 'Facet of Hope', 'Facet of Protection']\r\n    }\r\n  }\r\n};\r\n\r\n// Specific Combo Pairings (Armor -> Preferred Weapon)\r\nconst COMBO_PAIRS: Record<string, string[]> = {\r\n  // Warlock\r\n  'necrotic': ['thorn', 'osteo striga', 'necrochasm', 'touch of malice', 'euphony'],\r\n  'rain of fire': ['vex mythoclast', 'dragon\\'s breath'],\r\n  'mothkeeper': ['ex diris'],\r\n  'cenotaph': ['divinity', 'ager\\'s scepter', 'coldheart'],\r\n  'dawn chorus': ['skyburner\\'s oath', 'polaris lance', 'dragon\\'s breath', 'tommy\\'s matchbook'],\r\n  'speaker\\'s sight': ['red death reformed', 'lumina', 'no time to explain', 'edge of intent'],\r\n  'sunbracers': ['sunshot', 'skyburner\\'s oath', 'polaris lance', 'ticuu\\'s divination', 'monte carlo'],\r\n  'osmiomancy': ['ager\\'s scepter', 'wicked implement', 'verglas curve', 'conditional finality', 'winterbite'],\r\n\r\n  'briarbinds': ['graviton lance', 'le monarque', 'buried bloodline', 'collective obligation', 'choir of one'],\r\n  'gyrfalcon': ['graviton lance', 'le monarque', 'wavesplitter', 'collective obligation', 'fighting lion', 'buried bloodline', 'rat king'],\r\n  'starfire protocol': ['witherhoard', 'anarchy', 'dragon\\'s breath'],\r\n\r\n  // Hunter\r\n  'lucky pants': ['malfeasance', 'crimson', 'the last word', 'sunshot', 'ace of spades', 'hawkmoon', 'wardens law'],\r\n  'oathkeeper': ['wish-ender', 'le monarque', 'ticuu\\'s divination', 'trinity ghoul', 'leviathan\\'s breath', 'wish-keeper'],\r\n  'mechaneer': ['forerunner', 'rat king', 'traveler\\'s chosen', 'devil\\'s ruin', 'buried bloodline'],\r\n  'caliban': ['sunshot', 'skyburner\\'s oath', 'polaris lance', 'dragon\\'s breath'],\r\n  'omnioculus': ['le monarque', 'wish-ender', 'rat king'],\r\n  'mask of bakris': ['fourth horseman', 'cloudstrike', 'anarchy', 'thunderlord', 'legend of acrius'],\r\n  'triton vice': ['winterbite', 'vexcalibur', 'edge of concurrence', 'black talon'],\r\n  'cyrtarachne': ['quicksilver storm', 'final warning', 'the navigator', 'wish-keeper'],\r\n  'star-eater': ['izaganis burden', 'the fourth horseman', 'still hunt', 'bad juju'],\r\n  'celestial nighthawk': ['still hunt'],\r\n\r\n  // Titan\r\n  'actium war rig': ['sweet business', 'xenophage', 'heir apparent', 'thunderlord', 'grand overture', 'khvostov 7g-0x', 'microcosm'],\r\n  'stronghold': ['the lament', 'black talon', 'heartshadow', 'crown-splitter', 'throne-cleaver'],\r\n  'abeyant leap': ['wish-keeper', 'quicksilver storm', 'final warning'],\r\n  'pyrogale': ['dragon\\'s breath', 'sunshot', 'tommy\\'s matchbook'],\r\n  'cadmus ridge': ['wicked implement', 'ager\\'s scepter', 'verglas curve', 'winterbite'],\r\n  'hazard pulse': ['grand overture', 'the colony', 'deathbringer', 'two-tailed fox', 'truth'],\r\n  'peacekeepers': ['tarrabah', 'riskrunner', 'huckleberry', 'osteo striga'],\r\n  'no backup plans': ['conditional finality', 'lord of wolves', 'duality', 'fourth horseman'],\r\n  'doom fang pauldrons': ['monte carlo'],\r\n\r\n  // Special Specific Support\r\n  'chromatic fire': ['outbreak perfected', 'bad juju', 'necrochasm', 'ace of spades'],\r\n  'getaway artist': ['centrifuse', 'riskrunner', 'trinity ghoul', 'coldheart'],\r\n  'graviton forfeit': ['le monarque', 'graviton lance', 'heartshadow'],\r\n  'swarmers': ['euphony', 'quicksilver storm', 'final warning'],\r\n  'mataiodoxia': ['wish-keeper', 'the navigator', 'euphony'],\r\n  'point-contact cannon brace': ['monte carlo'],\r\n\r\n\r\n  // Pairs\r\n  'sturm': ['drang'],\r\n  'mida multi-tool': ['mida mini-tool'],\r\n  'necrochasm': ['necrotic'],\r\n  'thorn': ['necrotic'],\r\n  'osteo striga': ['necrotic'],\r\n  'vex mythoclast': ['rain of fire'],\r\n  'ex diris': ['mothkeeper'],\r\n  'divinity': ['cenotaph'],\r\n  'graviton lance': ['gyrfalcon', 'briarbinds'],\r\n  'le monarque': ['gyrfalcon', 'omnioculus'],\r\n  'wish-keeper': ['abeyant leap'],\r\n  'dragon\\'s breath': ['pyrogale', 'starfire protocol'],\r\n  'skyburner\\'s oath': ['dawn chorus', 'caliban'],\r\n  'still hunt': ['celestial nighthawk'],\r\n};\r\n\r\n// Strict Element Enforcement Map\r\n// If an exotic is listed here, it is ONLY allowed on these elements.\r\nconst STRICT_ARMOR_ELEMENTS: Record<string, string[]> = {\r\n  // Solar\r\n  'starfire protocol': ['solar'],\r\n  'sunbracers': ['solar'],\r\n  'dawn chorus': ['solar', 'prismatic'], // Prismatic Dawnblade is a thing? User says Dawn Chorus is \"Solar Exotics\".\r\n  'phoenix protocol': ['solar'],\r\n  'wings of sacred dawn': ['solar', 'prismatic'], // Works with any dawnblade/heat rises usually\r\n  'promethium spur': ['solar'],\r\n  'pyrogale gauntlets': ['solar', 'prismatic'], // Consecration is on Prismatic\r\n  'loreley splendor helm': ['solar'], // Sunspots are Solar only usually\r\n  'ashen wake': ['solar'],\r\n  'phoenix cradle': ['solar'], // Sol Invictus is Solar only\r\n  'hallowfire heart': ['solar'],\r\n  'celestial nighthawk': ['solar', 'prismatic'], // Golden Gun is on Prismatic Hunter\r\n  'caliban\\'s hand': ['solar', 'prismatic'], // Proximity Knife is on Prismatic? No, it's Knife Trick/Spike usually. Wait, Proximity IS available? Check Build Templates.\r\n  'young ahamkara\\'s spine': ['solar'], // Tripmine not on Prismatic Hunter? (Swarm, Duskfield, Arcbolt, Spike, Magnetic)\r\n  'athrys\\'s embrace': ['solar'], // Weighted Knife not on Prismatic\r\n  'ophidia spathe': ['solar', 'prismatic'], // Knife Trick is on Prismatic\r\n\r\n  // Void\r\n  'skull of dire ahamkara': ['void', 'prismatic'], // Nova Bomb on Prismatic Warlock\r\n  'briarbinds': ['void'], // Void Soul not on Prismatic? Or is it? (Feed the Void / Weaver's Call / Hellion / Bleak Watcher / Getaway Artist). NO Void Soul (\"Child of Old Gods\").\r\n  'contraverse hold': ['void', 'prismatic'], // Vortex Grenade is on Prismatic Warlock\r\n  'nothing manacles': ['void'], // Scatter Grenade is NOT on Prismatic Warlock\r\n  'secant filaments': ['void'], // Devour on Empowering Rift. Works on Prismatic with Feed the Void? Maybe.\r\n  'graviton forfeit': ['void', 'prismatic'], // Invisibility works on Prismatic\r\n  'gwisin vest': ['void'], // Spectral Blades not on Prismatic\r\n  'omnioculus': ['void'], // Smoke Bomb not on Prismatic Hunter (Snare Bomb is Void Melee, listed in Void kit) -> Yes on Prismatic? No, Prismatic Hunter has Snare Bomb.\r\n  'orpheus rig': ['void', 'prismatic'], // Deadfall/Moebius on Prismatic\r\n  'gyrfalcon\\'s hauberk': ['void', 'prismatic'], // Volatile Rounds works on Prismatic\r\n  'helm of saint-14': ['void'], // Ward of Dawn not on Prismatic Titan? No (Twilight Arsenal).\r\n  'doom fang pauldrons': ['void'], // Sentinel Shield not on Prismatic\r\n  'ursa furiosa': ['void'], // Sentinel Shield/Banner Shield not on Prismatic\r\n  'second chance': ['void', 'prismatic'], // Shield Throw is on Prismatic Titan\r\n\r\n  // Arc\r\n  'crown of tempests': ['arc', 'prismatic'], // Stormtrance not on Prismatic. But Arc abilities?\r\n  'fallen sunstar': ['arc', 'prismatic'], // Ionic Traces exist on Prismatic\r\n  'getaway artist': ['arc', 'prismatic'], // Storm Grenade on Prismatic\r\n  'stormdancer\\'s brace': ['arc'], // Stormtrance Only\r\n  'vesper of radius': ['arc', 'prismatic'], // Arc Shockwave on Rift. Works on Prismatic?\r\n  'geomag stabilizers': ['arc'], // Chaos Reach not on Prismatic\r\n  'raiden flux': ['arc'], // Arc Staff not on Prismatic Hunter? No (Silkstrike/Silence/Golden/Deadfall/Storm's Edge). Storm's Edge is NEW.\r\n  'liar\\'s handshake': ['arc', 'prismatic'], // Combination Blow is on Prismatic\r\n  'shinobu\\'s vow': ['arc'], // Skip Grenade not on Prismatic Hunter?\r\n  'blight ranger': ['arc'], // Arc Staff Only\r\n  'raiju\\'s harness': ['arc'],\r\n  'cuirass of the falling star': ['arc'], // Thundercrash not on Prismatic (Twilight Arsenal/Bladefury/Glacial)\r\n  'point-contact cannon brace': ['arc', 'prismatic'], // Thunderclap is on Prismatic\r\n  'insurmountable skullfort': ['arc', 'prismatic'], // Arc Melee kills matches Thunderclap\r\n\r\n  // Stasis\r\n  'osmiomancy gloves': ['stasis', 'prismatic'], // Coldsnap is on Prismatic Warlock\r\n  'ballidorse wrathweavers': ['stasis', 'prismatic'], // Winter's Wrath not on Prismatic. But Stasis damage buff?\r\n  'mask of bakris': ['stasis', 'prismatic'], // Stasis/Arc damage boost. Works on Prismatic.\r\n  'renewal grasps': ['stasis', 'prismatic'], // Duskfield is on Prismatic Hunter\r\n  'hoarfrost-z': ['stasis'], // Stasis Crystal Barricade.\r\n  'icefall mantle': ['stasis'],\r\n  'cadmus ridge lancecap': ['stasis', 'prismatic'], // Diamond Lances are on Prismatic Titan\r\n\r\n  // Strand\r\n  'swarmers': ['strand', 'prismatic'], // Threadlings on Prismatic\r\n  'mataiodoxia': ['strand', 'prismatic'], // Arcane Needle is on Prismatic\r\n  'cyrtarachne\\'s faade': ['strand', 'prismatic'], // Grapple is on Prismatic\r\n  'abeyant leap': ['strand', 'prismatic'], // Drengr's Lash is on Prismatic Titan\r\n\r\n  // Prismatic Only\r\n  'solipsism': ['prismatic'],\r\n  'essentialism': ['prismatic'],\r\n  'stoicism': ['prismatic'],\r\n};\r\n\r\n// Comprehensive keywords and their associated element/type\r\nconst KEYWORD_MAP: Record<string, string> = {\r\n  // Solar\r\n  'solar': 'solar', 'scorch': 'solar', 'ignite': 'solar', 'radiant': 'solar', 'restoration': 'solar',\r\n  'sunspot': 'solar', 'cure': 'solar', 'benevolence': 'solar', 'ember': 'solar', 'incandescent': 'solar',\r\n  'daybreak': 'solar', 'well of radiance': 'solar', 'golden gun': 'solar', 'blade barrage': 'solar',\r\n  'hammer of sol': 'solar', 'burning maul': 'solar',\r\n\r\n  // Void\r\n  'void': 'void', 'suppress': 'void', 'weaken': 'void', 'volatile': 'void', 'invisibility': 'void',\r\n  'devour': 'void', 'overshield': 'void', 'invis': 'void', 'echo': 'void', 'repulsor': 'void',\r\n  'destabilizing': 'void', 'nova bomb': 'void', 'shadowshot': 'void', 'sentinel shield': 'void',\r\n  'ward of dawn': 'void', 'twilight arsenal': 'void', 'spectral blades': 'void',\r\n\r\n  // Arc\r\n  'arc': 'arc', 'jolt': 'arc', 'blind': 'arc', 'amplified': 'arc', 'ionic trace': 'arc',\r\n  'spark': 'arc', 'voltshot': 'arc', 'stormtrance': 'arc', 'chaos reach': 'arc',\r\n  'thundercrash': 'arc', 'fists of havoc': 'arc', 'gathering storm': 'arc', 'arc staff': 'arc',\r\n  'storm\\'s edge': 'arc',\r\n\r\n  // Stasis\r\n  'stasis': 'stasis', 'slow': 'stasis', 'freeze': 'stasis', 'shatter': 'stasis', 'crystal': 'stasis',\r\n  'whisper': 'stasis', 'chill clip': 'stasis', 'headstone': 'stasis', 'winter\\'s wrath': 'stasis',\r\n  'glacial quake': 'stasis', 'silence and squall': 'stasis',\r\n\r\n  // Strand\r\n  'strand': 'strand', 'suspend': 'strand', 'unravel': 'strand', 'sever': 'strand', 'tangle': 'strand',\r\n  'woven mail': 'strand', 'threadling': 'strand', 'thread': 'strand', 'hatchling': 'strand',\r\n  'needlestorm': 'strand', 'bladefury': 'strand', 'silkstrike': 'strand',\r\n\r\n  'prismatic': 'prismatic', 'transcendence': 'prismatic', 'facet': 'prismatic', 'spirit of': 'prismatic',\r\n  'solipsism': 'prismatic', 'stoicism': 'prismatic', 'essentialism': 'prismatic', 'relativism': 'prismatic',\r\n  // Year of Prophecy / Meta Keywords\r\n  'will of the flame': 'solar', 'jetpack': 'arc', 'arid overgrowth': 'strand', 'twin fangs': 'strand',\r\n  'malstrom': 'strand', 'hive memory': 'strand', 'scorched earth': 'solar', 'perfect fifth': 'solar',\r\n  'arcane needle': 'strand', 'feed the void': 'void', 'hellion': 'solar', 'sentient soul': 'arc',\r\n  'arc soul': 'arc', 'sentient arc soul': 'arc',\r\n  // --- Gameplay Meta/Verbs (Applied to all elements) ---\r\n  'ability spam': 'prismatic', 'cooldown': 'prismatic', 'super energy': 'prismatic',\r\n  'finisher': 'prismatic', 'debuff': 'prismatic', 'movement': 'prismatic',\r\n  'handling': 'prismatic', 'reload': 'prismatic', 'health': 'prismatic',\r\n  'healing': 'prismatic', 'damage resistance': 'prismatic',\r\n  'unstop': 'prismatic', 'barrier': 'prismatic', 'overload': 'prismatic',\r\n  'reflect': 'prismatic', 'guard': 'prismatic', 'sword': 'prismatic',\r\n  'kinetic': 'prismatic', 'precision': 'prismatic', 'explosion': 'prismatic',\r\n  'universal': 'prismatic',\r\n};\r\n\r\nconst SPECIAL_CASES: Record<string, string[]> = {\r\n  // --- WARLOCK ---\r\n  'apotheosis veil': null as any,\r\n  'cenotaph mask': null as any,\r\n  'eye of another world': null as any,\r\n  'felwinter\\'s helm': null as any,\r\n  'the stag': null as any,\r\n  'aeon soul': null as any,\r\n  'karnstein armlets': null as any,\r\n  'necrotic grip': null as any,\r\n  'ophidian aspect': null as any,\r\n  'winter\\'s guile': null as any,\r\n  'chromatic fire': null as any,\r\n  'mantle of battle harmony': null as any,\r\n  'sanguine alchemy': null as any,\r\n  'boots of the assembler': null as any,\r\n  'lunafaction boots': null as any,\r\n  'transversive steps': null as any,\r\n  'verity\\'s brow': null as any,\r\n\r\n  // Solar Exotics (Dawnblade) - Removed Prismatic from locked items\r\n  'dawn chorus': ['solar'],\r\n  'speaker\\'s sight': ['solar', 'prismatic'], // Healing grenades are on Prismatic\r\n  'sunbracers': ['solar'],\r\n  'phoenix protocol': ['solar'],\r\n  'starfire protocol': ['solar'],\r\n  'wings of sacred dawn': ['solar'],\r\n  'promethium spur': ['solar'],\r\n\r\n  // Void Exotics (Voidwalker)\r\n  'nezarec\\'s sin': ['void', 'prismatic'], // Works with any void kill\r\n  'skull of dire ahamkara': ['void'],\r\n  'briarbinds': ['void', 'prismatic'], // Void soul is on Prismatic\r\n  'contraverse hold': ['void'],\r\n  'nothing manacles': ['void'],\r\n  'secant filaments': ['void'],\r\n\r\n  // Arc Exotics (Stormcaller)\r\n  'crown of tempests': ['arc'],\r\n  'fallen sunstar': ['arc'],\r\n  'getaway artist': ['arc', 'prismatic'], // META on Prismatic\r\n  'stormdancer\\'s brace': ['arc'],\r\n  'vesper of radius': ['arc', 'prismatic'], // Rift shockwave matches Prismatic logic\r\n  'geomag stabilizers': ['arc'],\r\n\r\n  // Stasis Exotics (Shadebinder)\r\n  'ballidorse wrathweavers': ['stasis'],\r\n  'osmiomancy gloves': ['stasis', 'prismatic'], // META on Prismatic\r\n\r\n  // Strand Exotics (Broodweaver)\r\n  'mataiodoxa': ['strand', 'prismatic'], // Arcane Needle is on Prismatic\r\n  'swarmers': ['strand', 'prismatic'], // Threadlings are on Prismatic\r\n\r\n  // Prismatic\r\n  'solipsism': ['prismatic'],\r\n\r\n  // --- HUNTER ---\r\n  'foetracer': null as any,\r\n  'knucklehead radar': null as any,\r\n  'wormhusk crown': null as any,\r\n  'aeon swift': null as any,\r\n  'mechaneer\\'s tricksleeves': null as any,\r\n  'oathkeeper': null as any,\r\n  'sealed ahamkara grasps': null as any,\r\n  'the dragon\\'s shadow': null as any,\r\n  'the sixth coyote': null as any,\r\n  'fr0st-ee5': null as any,\r\n  'lucky pants': null as any,\r\n  'st0mp-ee5': null as any,\r\n  'the bombardiers': null as any,\r\n  'star-eater scales': null as any,\r\n\r\n  // Solar Exotics (Gunslinger)\r\n  'celestial nighthawk': ['solar'],\r\n  'athrys\\'s embrace': ['solar', 'prismatic'], // Weighted knife is on Prismatic\r\n  'caliban\\'s hand': ['solar'],\r\n  'shards of galanor': ['solar'],\r\n  'young ahamkara\\'s spine': ['solar'],\r\n  'ophidia spathe': ['solar'],\r\n\r\n  // Void Exotics (Nightstalker)\r\n  'graviton forfeit': ['void', 'prismatic'],\r\n  'khepri\\'s sting': ['void'],\r\n  'gyrfalcon\\'s hauberk': ['void', 'prismatic'], // Stylish Executioner on Prismatic\r\n  'omnioculus': ['void'],\r\n  'gwisin vest': ['void'],\r\n  'orpheus rig': ['void'],\r\n\r\n  // Arc Exotics (Arcstrider)\r\n  'blight ranger': ['arc'],\r\n  'liar\\'s handshake': ['arc'],\r\n  'shinobu\\'s vow': ['arc'],\r\n  'raiden flux': ['arc'],\r\n  'raiju\\'s harness': ['arc'],\r\n\r\n  // Stasis Exotics (Revenant)\r\n  'mask of bakris': ['stasis'],\r\n  'renewal grasps': ['stasis', 'prismatic'], // Duskfield is on Prismatic\r\n\r\n  // Strand Exotics (Threadrunner)\r\n  'cyrtarachne\\'s faade': ['strand', 'prismatic'], // Grapple is on Prismatic\r\n\r\n  // Prismatic\r\n  'essentialism': ['prismatic'],\r\n  'relativism': ['prismatic'],\r\n\r\n  // --- TITAN ---\r\n  'one-eyed mask': null as any,\r\n  'precious scars': null as any,\r\n  'synthoceps': null as any,\r\n  'heart of inmost light': null as any,\r\n  'actium war rig': null as any,\r\n  'dunemarchers': null as any,\r\n  'hazardous propulsion': null as any,\r\n  'stronghold': null as any,\r\n  'aeon safe': null as any,\r\n\r\n  // Solar Exotics (Sunbreaker)\r\n  'loreley splendor': ['solar'],\r\n  'pyrogale gauntlets': ['solar'],\r\n  'ashen wake': ['solar'],\r\n  'phoenix cradle': ['solar'],\r\n  'hallowfire heart': ['solar'],\r\n\r\n  // Void Exotics (Sentinel)\r\n  'helm of saint-14': ['void'],\r\n  'doom fang pauldrons': ['void'],\r\n  'ursa furiosa': ['void'],\r\n  'second chance': ['void', 'prismatic'], // Shield Throw is on Prismatic\r\n\r\n  // Arc Exotics (Striker)\r\n  'an insurmountable skullfort': ['arc'],\r\n  'cuirass of the falling star': ['arc'],\r\n  'point-contact cannon brace': ['arc', 'prismatic'], // Thunderclap is on Prismatic\r\n  'praxic vestment': ['arc'],\r\n\r\n  // Stasis Exotics (Behemoth)\r\n  'cadmus ridge lancecap': ['stasis'],\r\n  'hoarfrost-z': ['stasis'],\r\n  'icefall mantle': ['stasis'],\r\n\r\n  // Strand Exotics (Berserker)\r\n  'abeyant leap': ['strand', 'prismatic'], // Drengr's Lash is on Prismatic\r\n  'wishful ignorance': ['strand', 'prismatic'], // Frenzied Blade is on Prismatic\r\n\r\n  // Prismatic\r\n  'stoicism': ['prismatic'],\r\n};\r\n\r\nfunction getNaturalAffinity(def: any): string | string[] | null {\r\n  if (!def?.displayProperties) return null;\r\n  const name = def.displayProperties.name.toLowerCase();\r\n\r\n  // 1. Check Special Cases (Strict Overrides)\r\n  for (const [key, affinities] of Object.entries(SPECIAL_CASES)) {\r\n    if (name.includes(key) || key.includes(name)) {\r\n      // If affinity is null, it's explicitly universal\r\n      return affinities;\r\n    }\r\n  }\r\n\r\n  const text = (def.displayProperties.description + ' ' + def.displayProperties.name).toLowerCase();\r\n\r\n  const detected = new Set<string>();\r\n  for (const [keyword, element] of Object.entries(KEYWORD_MAP)) {\r\n    if (text.includes(keyword)) {\r\n      detected.add(element);\r\n    }\r\n  }\r\n\r\n  if (detected.size === 0) return null;\r\n  if (detected.size === 1) return Array.from(detected)[0];\r\n  return Array.from(detected);\r\n}\r\n\r\nfunction capitalize(s: string) {\r\n  return s.charAt(0).toUpperCase() + s.slice(1);\r\n}\r\n\r\n/**\r\n * Fisher-Yates Shuffle with optional seed for stability\r\n */\r\nfunction shuffleArray<T>(array: T[], seed?: string | number): T[] {\r\n  const result = [...array];\r\n\r\n  // Deterministic random if seed provided\r\n  const generateRandom = (s: string | number) => {\r\n    let h = typeof s === 'string'\r\n      ? s.split('').reduce((a, b) => ((a << 5) - a) + b.charCodeAt(0), 0)\r\n      : s;\r\n\r\n    // EXTREMELY CRITICAL: LCG fails if state (h) is 0. \r\n    // State becomes 0 if s=0 or string hashes to 0, causing Math.floor(random() * i) \r\n    // to return negative indices, corrupting result[] with undefined.\r\n    h = Math.abs(h) || 1;\r\n\r\n    return () => {\r\n      h = (h * 16807) % 2147483647;\r\n      return (h - 1) / 2147483646;\r\n    };\r\n  };\r\n\r\n  const random = seed !== undefined ? generateRandom(seed) : Math.random;\r\n\r\n  for (let i = result.length - 1; i > 0; i--) {\r\n    const j = Math.floor(random() * (i + 1));\r\n    [result[i], result[j]] = [result[j], result[i]];\r\n  }\r\n  return result;\r\n}\r\n\r\n/**\r\n * Load synergies for a specific class (filtered from constants)\r\n */\r\nexport async function loadSynergiesForClass(classType: GuardianClass): Promise<DashboardSynergy[]> {\r\n  // Filter from the constant source of truth\r\n  // We map the static definition to the DashboardSynergy shape if needed, \r\n  // or if they are already compatible, just return them.\r\n  // The interface in synergy-definitions.ts might differ slightly from DashboardSynergy here.\r\n  // Let's check compat. \r\n  // actually, let's just return the definitions and let the matcher handle it. \r\n  // But definition is SynergyDefinition, matcher expects DashboardSynergy.\r\n\r\n  // Mapping logic:\r\n  return SYNERGY_DEFINITIONS.filter(s => s.guardianClass === classType).map(def => ({\r\n    score: 100, // Default score\r\n    classType: def.guardianClass,\r\n    armor: def.exoticArmor.name,\r\n    weapon: def.exoticWeapon?.name || '',\r\n    buildName: def.name,\r\n    description: def.loopDescription,\r\n    subclassType: def.element, // 'Solar', 'Void' etc\r\n    super: def.subclassNode.superName,\r\n    classAbility: def.subclassNode.classAbilityName,\r\n    jump: def.subclassNode.jumpName,\r\n    melee: def.subclassNode.meleeName,\r\n    grenade: def.subclassNode.grenadeName,\r\n    aspects: def.subclassNode.aspectNames,\r\n    fragments: def.subclassNode.fragmentNames,\r\n    fragmentSlots: def.subclassNode.fragmentHashes?.length || 0, // approximation\r\n    element: def.element.toLowerCase(),\r\n    definition: def // Keep reference to full def for strict checking later\r\n  })) as any; // Casting to any/DashboardSynergy to satisfy interface for now\r\n}\r\n\r\n/**\r\n * Find synergies matching a clicked element\r\n */\r\nexport async function findSynergies(\r\n  targetType: 'subclass' | 'armor' | 'weapon',\r\n  targetIdentifier: string, // Element name for subclass, item name for armor/weapon\r\n  guardianClass: GuardianClass,\r\n  options: {\r\n    maxResults?: number;\r\n    minScore?: number;\r\n    seed?: string | number; // Session seed for diversity stability\r\n  } = {}\r\n): Promise<SynergyConnection[]> {\r\n  const { maxResults = 100, minScore = 0, seed = 0 } = options;\r\n\r\n  // Load synergies for class\r\n  const synergies = await loadSynergiesForClass(guardianClass);\r\n  if (!synergies.length) return [];\r\n\r\n  // Consistent hashing for this search\r\n  const combinedSeed = `${targetIdentifier}-${seed}`;\r\n\r\n\r\n  // Filter synergies based on target type\r\n  let filtered: DashboardSynergy[];\r\n\r\n  switch (targetType) {\r\n    case 'subclass':\r\n      // Match by element\r\n      const searchTerms = targetIdentifier.toLowerCase().split(',').map(s => s.trim());\r\n      const isBroadSubclass = searchTerms.some(s => s === 'all' || s === '' || s === 'kinetic');\r\n\r\n      if (isBroadSubclass) {\r\n        filtered = synergies;\r\n      } else {\r\n        filtered = synergies.filter(s =>\r\n          searchTerms.includes(s.element) ||\r\n          searchTerms.some(term => s.subclassType.toLowerCase().includes(term))\r\n        );\r\n      }\r\n      break;\r\n\r\n    case 'armor':\r\n      // Match by armor name (partial match)\r\n      const armorSearch = targetIdentifier.toLowerCase();\r\n      filtered = synergies.filter(s =>\r\n        s.armor.toLowerCase().includes(armorSearch) ||\r\n        armorSearch.includes(s.armor.toLowerCase())\r\n      );\r\n      break;\r\n\r\n    case 'weapon':\r\n      // Match by weapon name (partial match)\r\n      const weaponSearch = targetIdentifier.toLowerCase();\r\n      filtered = synergies.filter(s =>\r\n        s.weapon.toLowerCase().includes(weaponSearch) ||\r\n        weaponSearch.includes(s.weapon.toLowerCase())\r\n      );\r\n      break;\r\n\r\n    default:\r\n      filtered = [];\r\n  }\r\n\r\n\r\n  // Filter by minimum score\r\n  filtered = filtered.filter(s => s.score >= minScore);\r\n\r\n\r\n  // Sort by score descending\r\n  filtered.sort((a, b) => b.score - a.score);\r\n\r\n  // DIVERSITY: Shuffle results with the same score to ensure variety on refresh\r\n  // This is especially useful for the thousands of fallback pairings\r\n  let shuffledResults: DashboardSynergy[] = [];\r\n  const groups = new Map<number, DashboardSynergy[]>();\r\n\r\n  filtered.forEach(s => {\r\n    if (!groups.has(s.score)) groups.set(s.score, []);\r\n    groups.get(s.score)!.push(s);\r\n  });\r\n\r\n  const sortedScores = Array.from(groups.keys()).sort((a, b) => b - a);\r\n  for (const score of sortedScores) {\r\n    const group = groups.get(score)!;\r\n    // Use the combined seed to shuffle this specific score group consistently\r\n    const shuffledGroup = shuffleArray(group, `${combinedSeed}-${score}`);\r\n    shuffledResults = [...shuffledResults, ...shuffledGroup];\r\n  }\r\n\r\n  filtered = shuffledResults.slice(0, maxResults * 2); // Take a larger pool for connection processing\r\n\r\n  // Build connections with item locations\r\n  const connections: SynergyConnection[] = [];\r\n  const processedExotics = new Set<string>();\r\n\r\n  // 1. Process Strict Synergies First\r\n  for (const synergy of filtered) {\r\n    if (connections.length >= maxResults) break;\r\n    if (!synergy.armor || !synergy.weapon) continue;\r\n\r\n    // Find armor and weapon in inventory (must both exist)\r\n    const [armorResult, weaponResult] = await Promise.all([\r\n      itemSearchService.findItemByName(synergy.armor),\r\n      itemSearchService.findItemByName(synergy.weapon)\r\n    ]);\r\n\r\n    if (!armorResult || !weaponResult) continue;\r\n\r\n    processedExotics.add(armorResult.item.itemInstanceId || synergy.armor);\r\n\r\n    connections.push({\r\n      synergy,\r\n      sourceType: targetType,\r\n      armorResult,\r\n      weaponResult,\r\n      element: synergy.element\r\n    });\r\n  }\r\n\r\n  // 2. Generative Fallback: Smart Heuristic & Diversity\r\n  if (connections.length < maxResults) {\r\n    debugLog('SynergyMatcher', `Strict search: ${connections.length}/${maxResults}, generating fallbacks...`);\r\n\r\n    const searchTerms = targetIdentifier.toLowerCase().split(',').map(s => s.trim());\r\n    const isBroadSearch = searchTerms.some(s => s === 'all' || s === '' || s === 'kinetic');\r\n\r\n    // Find all exotic armor for this class\r\n    let allExoticArmor = await itemSearchService.findAllExoticsForClass(guardianClass, 'armor');\r\n    if (isBroadSearch) {\r\n      allExoticArmor = shuffleArray(allExoticArmor, combinedSeed);\r\n    }\r\n    // Fetch all exotic weapons to pair with\r\n    const allExoticWeapons = await itemSearchService.findAllExoticsForClass(3 as any, 'weapon'); // Class 3 = Generic/All\r\n\r\n    for (const armor of allExoticArmor) {\r\n      if (connections.length >= maxResults) break;\r\n\r\n      const armorName = armor.definition.displayProperties.name.toLowerCase();\r\n      const armorInstanceId = armor.item.itemInstanceId || armor.item.itemHash.toString();\r\n\r\n      // IF WE ARE LOOKING FOR SPECIFIC ARMOR: Skip others\r\n      if (targetType === 'armor' && !armor.definition.displayProperties.name.toLowerCase().includes(targetIdentifier.toLowerCase())) continue;\r\n\r\n      // Determine Affinity from Description/Name\r\n      let affinity = getNaturalAffinity(armor.definition);\r\n      let targetElements: string[] = [];\r\n\r\n      // 0. Use Strict Enforcement if available\r\n      const strictElements = STRICT_ARMOR_ELEMENTS[armorName];\r\n      if (strictElements) {\r\n        targetElements = strictElements;\r\n      } else if (Array.isArray(affinity)) {\r\n        targetElements = affinity;\r\n      } else if (affinity) {\r\n        // STRICT MATCHING: Only use the detected element. \r\n        targetElements = [affinity as string];\r\n      } else {\r\n        // PRIORITY: Put prismatic at the start of the search for generic items\r\n        targetElements = ['prismatic', 'solar', 'void', 'arc', 'stasis', 'strand'];\r\n        if (isBroadSearch) {\r\n          targetElements = shuffleArray(targetElements, `${combinedSeed}-${armorInstanceId}`);\r\n        }\r\n      }\r\n\r\n      for (const el of targetElements) {\r\n        if (connections.length >= maxResults) break;\r\n\r\n        // IF WE ARE LOOKING FOR SPECIFIC SUBCLASS: Skip non-matching elements (unless broad search requested)\r\n        if (targetType === 'subclass' && !isBroadSearch && !searchTerms.includes(el)) continue;\r\n\r\n        // Determine if this armor can pair with the target search item if it's a weapon\r\n        let candidates: ItemSearchResult[] = [];\r\n\r\n        // 0. Use COMBO_PAIRS to prioritize specific fits\r\n        for (const [key, preferredWeapons] of Object.entries(COMBO_PAIRS)) {\r\n          if (armorName.includes(key)) {\r\n            const matches = allExoticWeapons.filter(w => preferredWeapons.some(pw => w.definition.displayProperties.name.toLowerCase().includes(pw)));\r\n            if (matches.length > 0) {\r\n              candidates = matches;\r\n              break;\r\n            }\r\n          }\r\n        }\r\n\r\n        // 0.5 Verb-Based Alignment (Heuristic from exoticlist.txt)\r\n        // If armor and weapon share a gameplay verb (Scorch, Jolt, etc), they are a match\r\n        if (candidates.length === 0) {\r\n          const armorDesc = armor.definition.displayProperties.description.toLowerCase();\r\n          const verbMatches = allExoticWeapons.filter(w => {\r\n            const weaponDesc = w.definition.displayProperties.description.toLowerCase();\r\n            return Object.keys(KEYWORD_MAP).some(verb =>\r\n              KEYWORD_MAP[verb] !== 'universal' && armorDesc.includes(verb) && weaponDesc.includes(verb)\r\n            );\r\n          });\r\n          if (verbMatches.length > 0) candidates = verbMatches;\r\n        }\r\n\r\n        // 1. If targetType is 'weapon', we MUST check if the armor can pair with the target weapon\r\n        if (targetType === 'weapon') {\r\n          const targetWeaponName = targetIdentifier.toLowerCase();\r\n          const targetWeapon = allExoticWeapons.find(w => w.definition.displayProperties.name.toLowerCase().includes(targetWeaponName));\r\n          const weaponDescription = targetWeapon?.definition.displayProperties.description.toLowerCase() || '';\r\n\r\n          // Does the combo match the target weapon?\r\n          const comboMatch = candidates.find(w => w.definition.displayProperties.name.toLowerCase().includes(targetWeaponName));\r\n\r\n          if (comboMatch) {\r\n            candidates = [comboMatch]; // Explicit COMBO_PAIRS match!\r\n          } else {\r\n            // ELEMENTAL SYNERGY: If they share an element, they are synergistic!\r\n            // This fixes \"Polaris missing solar connections\"\r\n            const armorElement = el;\r\n            const damageTypeMap: Record<string, number> = { arc: 2, solar: 3, void: 4, stasis: 6, strand: 7 };\r\n\r\n            const weaponsThatMatchTarget = allExoticWeapons.filter(w => w.definition.displayProperties.name.toLowerCase().includes(targetWeaponName));\r\n            const weaponMatch = weaponsThatMatchTarget.find(w => {\r\n              // UNIVERSAL WEAPONS: Kinetic slot exotics (non-elemental) match everything\r\n              const isKineticSlot = Number(w.definition.inventory?.bucketTypeHash) === Number(BUCKET_HASHES.KINETIC_WEAPONS);\r\n              const isKineticDamage = Number(w.definition.defaultDamageTypeHash) === 1;\r\n              if (isKineticSlot && isKineticDamage) return true;\r\n\r\n              // 1. Direct Element Match (Solar Weapon + Solar Armor)\r\n              const armorDamageType = damageTypeMap[armorElement] || 0;\r\n              const weaponDamageType = Number(w.definition.defaultDamageTypeHash);\r\n              const weaponElementMatches = weaponDamageType === armorDamageType || weaponDamageType === 1;\r\n              if (weaponElementMatches) return true;\r\n\r\n              // 2. Keyword/Description matching as fallback\r\n              const armorDescription = armor.definition.displayProperties.description.toLowerCase();\r\n              const descriptionsOverlap = Object.keys(KEYWORD_MAP).some(k =>\r\n                armorDescription.includes(k) && weaponDescription.includes(k)\r\n              );\r\n              return descriptionsOverlap || weaponDescription.includes(armorElement);\r\n            });\r\n\r\n            if (weaponMatch) {\r\n              candidates = [weaponMatch];\r\n            } else {\r\n              // This armor has no reasonable synergy with the target weapon\r\n              continue;\r\n            }\r\n          }\r\n        }\r\n\r\n        // 2. If no candidates yet and NOT a restricted weapon search, use defaults\r\n        if (candidates.length === 0) {\r\n          const damageTypeMap: Record<string, number> = { arc: 2, solar: 3, void: 4, stasis: 6, strand: 7 };\r\n          const targetDamage = damageTypeMap[el];\r\n          if (targetDamage) {\r\n            candidates = allExoticWeapons.filter(w => Number(w.definition.defaultDamageTypeHash) === targetDamage);\r\n          }\r\n          if (candidates.length === 0) {\r\n            candidates = allExoticWeapons.filter(w => {\r\n              const hash = Number(w.definition.defaultDamageTypeHash);\r\n              const type = Number(w.definition.defaultDamageType);\r\n              return hash === 1 || type === 1;\r\n            });\r\n            // EXCLUSION: Prevent special quest items like Praxic Blade from being auto-selected as generic Kinetic defaults\r\n            candidates = candidates.filter(w => !w.definition.displayProperties.name.toLowerCase().includes('praxic blade'));\r\n          }\r\n        }\r\n\r\n        if (candidates.length === 0) candidates = allExoticWeapons;\r\n\r\n        // Select the weapon(s)\r\n        let selectedWeaponItems = [candidates[0]];\r\n\r\n        // For diversity, we can pick a specific one if multiple exist\r\n        // If targetType is weapon, candidates should only be 1\r\n        if (targetType === 'weapon') {\r\n          selectedWeaponItems = [candidates[0]];\r\n        } else if (candidates.length > 1) {\r\n          // GROUPING: If multiple instances of same item exist, group them and pick a stable representative\r\n          // This prevents wires from jittering between identical items when clicking\r\n          const uniqueByHash = new Map<number, ItemSearchResult>();\r\n          candidates.forEach(c => {\r\n            const hash = c.item.itemHash;\r\n            if (!uniqueByHash.has(hash)) {\r\n              uniqueByHash.set(hash, c);\r\n            } else {\r\n              // Prefer equipped or higher power if duplicates exist\r\n              const existing = uniqueByHash.get(hash)!;\r\n              const isEquipped = c.location === 'equipped';\r\n              if (isEquipped && existing.location !== 'equipped') {\r\n                uniqueByHash.set(hash, c);\r\n              }\r\n            }\r\n          });\r\n\r\n          const uniqueCandidates = Array.from(uniqueByHash.values());\r\n\r\n          // DIVERSITY: Shuffle the fallback candidates for varied wires on every refresh\r\n          // Use combined seed + element for stability\r\n          const shuffledCandidates = shuffleArray(uniqueCandidates, `${combinedSeed}-${el}`);\r\n          const limit = Math.min(3, maxResults - connections.length);\r\n          selectedWeaponItems = shuffledCandidates.slice(0, limit);\r\n        }\r\n\r\n        for (const selectedWeaponItem of selectedWeaponItems) {\r\n          // Skip if already in strict pass\r\n          const connectionId = `${armorInstanceId}-${selectedWeaponItem.item.itemInstanceId || selectedWeaponItem.item.itemHash}-${el}`;\r\n          if (processedExotics.has(connectionId)) continue;\r\n          processedExotics.add(connectionId);\r\n\r\n          const buildTemplate = FALLBACK_DEFAULTS[el]?.[guardianClass] || FALLBACK_DEFAULTS['prismatic'][guardianClass];\r\n          const isPrismatic = el === 'prismatic';\r\n\r\n          const adHocSynergy: DashboardSynergy = {\r\n            score: 60,\r\n            classType: guardianClass,\r\n            armor: armor.definition.displayProperties.name,\r\n            weapon: selectedWeaponItem.definition.displayProperties.name,\r\n            buildName: `${armor.definition.displayProperties.name} ${isPrismatic ? 'Prism' : capitalize(el)}`,\r\n            description: armor.definition.displayProperties.description || `Synergy for ${armor.definition.displayProperties.name}.`,\r\n            subclassType: isPrismatic ? 'Prismatic' : capitalize(el),\r\n            element: el,\r\n            super: buildTemplate?.super || 'Roaming Super',\r\n            classAbility: buildTemplate?.classAbility || 'Class Ability',\r\n            jump: buildTemplate?.jump || 'Triple Jump',\r\n            melee: buildTemplate?.melee || 'Charged Melee',\r\n            grenade: buildTemplate?.grenade || 'Grenade',\r\n            aspects: buildTemplate?.aspects || [],\r\n            fragments: buildTemplate?.fragments || [],\r\n            fragmentSlots: 3,\r\n            transcendentAbility: isPrismatic ? 'Transcendence' : undefined\r\n          };\r\n\r\n          // STRICT COLORING: If this is a Prismatic connection, ensure element is 'prismatic'\r\n          // This prevents wires from being colored by the super element (e.g. Solar) instead of Pink.\r\n          if (isPrismatic) {\r\n            adHocSynergy.element = 'prismatic';\r\n          }\r\n\r\n          connections.push({\r\n            synergy: adHocSynergy,\r\n            sourceType: targetType,\r\n            armorResult: armor,\r\n            weaponResult: selectedWeaponItem,\r\n            element: el\r\n          });\r\n\r\n          if (connections.length >= maxResults) break;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // 3. FINAL SORT: Prioritize Prismatic connections for the UI\r\n  connections.sort((a, b) => {\r\n    const isAPrismatic = String(a.element).toLowerCase() === 'prismatic';\r\n    const isBPrismatic = String(b.element).toLowerCase() === 'prismatic';\r\n    if (isAPrismatic && !isBPrismatic) return -1;\r\n    if (!isAPrismatic && isBPrismatic) return 1;\r\n    return 0;\r\n  });\r\n\r\n  return connections;\r\n}\r\n\r\n/**\r\n * Find synergies for a specific subclass element\r\n */\r\nexport async function findSynergiesByElement(\r\n  element: string,\r\n  guardianClass: GuardianClass,\r\n  options?: { maxResults?: number; minScore?: number }\r\n): Promise<SynergyConnection[]> {\r\n  return findSynergies('subclass', element, guardianClass, options);\r\n}\r\n\r\n/**\r\n * Find synergies for a specific exotic armor\r\n */\r\nexport async function findSynergiesByArmor(\r\n  armorName: string,\r\n  guardianClass: GuardianClass,\r\n  options?: { maxResults?: number; minScore?: number }\r\n): Promise<SynergyConnection[]> {\r\n  return findSynergies('armor', armorName, guardianClass, options);\r\n}\r\n\r\n/**\r\n * Find synergies for a specific exotic weapon\r\n */\r\nexport async function findSynergiesByWeapon(\r\n  weaponName: string,\r\n  guardianClass: GuardianClass,\r\n  options?: { maxResults?: number; minScore?: number }\r\n): Promise<SynergyConnection[]> {\r\n  return findSynergies('weapon', weaponName, guardianClass, options);\r\n}\r\n\r\n\r\n// Legacy export for compatibility (Stubbed)\r\nexport class SynergyMatcherService {\r\n  async detectSynergies(): Promise<any[]> {\r\n    return [];\r\n  }\r\n\r\n  async autoDetect(_characterId: string): Promise<any[]> {\r\n    return [];\r\n  }\r\n\r\n  clearCache(): void {\r\n    // No-op\r\n  }\r\n}\r\n\r\n\r\nexport const synergyMatcherService = new SynergyMatcherService();\r\n\r\n// Default export for convenience\r\nexport default {\r\n  loadSynergiesForClass,\r\n  findSynergies,\r\n  findSynergiesByElement,\r\n  findSynergiesByArmor,\r\n  findSynergiesByWeapon\r\n};\r\n","import { useRef, useCallback, useMemo, useEffect, useState } from 'react';\r\nimport { debugLog, warnLog, errorLog } from '../../utils/logger';\r\nimport { flushSync } from 'react-dom';\r\nimport { useProfileStore, useManifestStore, useUIStore, useSettingsStore } from '../../store';\r\nimport { ElementType, GuardianClass } from '../../types';\r\nimport { BUCKET_HASHES } from '../../config/bungie.config';\r\nimport { manifestService } from '../../services/bungie/manifest.service';\r\nimport { transferService, createMoveSession } from '../../services/bungie/transfer.service';\r\nimport { profileLoader, profileService } from '../../services/bungie/profile.service';\r\nimport { getBungieUrl } from '../../utils/url-helper';\r\nimport { getTierClass } from '../../utils/character-helpers';\r\nimport { isLegacyVersion } from '../../utils/season-utils';\r\nimport { TierBadge } from '../builder/TierBadge';\r\nimport { useTooltip } from '../builder/TooltipManager';\r\nimport { SynergyWeb } from '../builder/SynergyWeb';\r\nimport { findSynergies, type SynergyConnection } from '../../services/synergy-matcher.service';\r\nimport '../../styles/TransmatEffect.css';\r\nimport './SynergyGalaxy.css';\r\n\r\ninterface NodePosition {\r\n    x: number;\r\n    y: number;\r\n    z: number;\r\n    id: string;\r\n    type: 'armor' | 'weapon' | 'subclass';\r\n    hash?: number;\r\n    instanceId?: string;\r\n    bucketHash: number;\r\n    element: ElementType;\r\n    isEquipped: boolean;\r\n    isEmpty: boolean;\r\n    lodLevel: 0 | 1 | 2; // 0 = high, 1 = med, 2 = low\r\n    tierClass?: string;\r\n    power?: number;\r\n    damageIconUrl?: string;\r\n    watermarkUrl?: string;\r\n    isLegacyWatermark?: boolean;\r\n    isMasterwork?: boolean;\r\n    isCrafted?: boolean;\r\n    isEnhanced?: boolean;\r\n    isFocused?: boolean;\r\n    tier?: number;\r\n    originalItem?: any;\r\n    iconUrl?: string; // Resolved icon (including ornaments)\r\n}\r\n\r\n\r\n\r\nconst WEAPON_BUCKETS = [\r\n    BUCKET_HASHES.KINETIC_WEAPONS,\r\n    BUCKET_HASHES.ENERGY_WEAPONS,\r\n    BUCKET_HASHES.POWER_WEAPONS,\r\n];\r\n\r\nconst ARMOR_BUCKETS = [\r\n    BUCKET_HASHES.HELMET,\r\n    BUCKET_HASHES.GAUNTLETS,\r\n    BUCKET_HASHES.CHEST_ARMOR,\r\n    BUCKET_HASHES.LEG_ARMOR,\r\n    BUCKET_HASHES.CLASS_ARMOR,\r\n];\r\n\r\nconst DAMAGE_TYPE_NAMES: Record<number, string> = {\r\n    1: 'kinetic',\r\n    2: 'arc',\r\n    3: 'solar',\r\n    4: 'void',\r\n    6: 'stasis',\r\n    7: 'strand',\r\n};\r\n\r\nconst ELEMENT_COLORS: Record<string, string> = {\r\n    [ElementType.Kinetic]: '#ffffff',\r\n    [ElementType.Arc]: '#7df9ff',\r\n    [ElementType.Solar]: '#ff9000',\r\n    [ElementType.Void]: '#bf84ff',\r\n    [ElementType.Stasis]: '#4d88ff',\r\n    [ElementType.Strand]: '#4aff9b',\r\n    [ElementType.Prismatic]: '#ff8df6',\r\n};\r\n\r\n// Rarity colors are handled via CSS classes (.exotic, .legendary, etc.)\r\n\r\ninterface SynergyGalaxyProps {\r\n    searchQuery?: string;\r\n    elementFilter?: string;\r\n    classFilter?: string;\r\n    isVaultSearchVisible?: boolean;\r\n    onSynergyElementChange?: (element: string | null) => void;\r\n    onSynergyOverlayChange?: (isOpen: boolean, synergy: any) => void;\r\n    viewMode?: 'all' | 'subclass-only' | 'inventory-only';\r\n    /** Pre-filter for auto-triggering synergy web on specific items */\r\n    synergyFilter?: {\r\n        weaponName?: string;\r\n        armorName?: string;\r\n        element?: string;\r\n        buildName?: string;\r\n    };\r\n    onResetView?: () => void;\r\n    forceCloseTrigger?: number;\r\n    /** Ref to expose the handleResetView function to parent components */\r\n    resetViewRef?: React.MutableRefObject<(() => void) | null>;\r\n}\r\n\r\n// Helper function to check if item matches search query\r\n// Helper function to check if item matches search query and filters\r\n// Helper function to check if item matches search query and filters\r\nfunction itemMatchesFilters(\r\n    item: any,\r\n    searchQuery: string,\r\n    elementFilter: string,\r\n    classFilter: string,\r\n    getElementFn: (hash: number) => ElementType\r\n): boolean {\r\n    const itemHash = item.itemHash || item.hash;\r\n    if (itemHash === undefined) return true;\r\n\r\n    const itemDef = manifestService.getItem(itemHash);\r\n    if (!itemDef) return false;\r\n\r\n    // 1. Hard Filters (UI Selectors)\r\n    if (elementFilter && elementFilter !== 'all') {\r\n        const itemElement = getElementFn(itemHash);\r\n        if (itemElement.toLowerCase() !== elementFilter.toLowerCase()) return false;\r\n    }\r\n\r\n    if (classFilter && classFilter !== 'all') {\r\n        const classMap: Record<string, number> = {\r\n            'titan': 0,\r\n            'hunter': 1,\r\n            'warlock': 2\r\n        };\r\n        const targetClassType = classMap[classFilter.toLowerCase()];\r\n        if (targetClassType !== undefined && itemDef.classType !== 3 && itemDef.classType !== targetClassType) {\r\n            return false;\r\n        }\r\n    }\r\n\r\n    // 2. Search Query (DIM-style AND logic)\r\n    if (!searchQuery || !searchQuery.trim()) return true;\r\n    const query = searchQuery.toLowerCase().trim();\r\n    const terms = query.split(/\\s+/);\r\n\r\n    const itemName = itemDef.displayProperties?.name?.toLowerCase() || '';\r\n    const itemType = itemDef.itemTypeDisplayName?.toLowerCase() || '';\r\n    const itemDescription = itemDef.displayProperties?.description?.toLowerCase() || '';\r\n    const itemTier = itemDef.inventory?.tierType;\r\n    const itemElement = getElementFn(itemHash).toLowerCase();\r\n\r\n    // EVERY term must match (AND logic)\r\n    return terms.every(term => {\r\n        let isTag = false;\r\n        let actualTerm = term;\r\n\r\n        if (term.startsWith('is:')) {\r\n            isTag = true;\r\n            actualTerm = term.substring(3);\r\n        }\r\n\r\n        // Special Tag Matches\r\n        if (actualTerm === 'weapon' && itemDef.itemType === 3) return true;\r\n        if (actualTerm === 'armor' && itemDef.itemType === 2) return true;\r\n        if (actualTerm === 'exotic' && itemTier === 6) return true;\r\n        if (actualTerm === 'legendary' && itemTier === 5) return true;\r\n        if (actualTerm === 'rare' && itemTier === 4) return true;\r\n        if (actualTerm === 'uncommon' && itemTier === 3) return true;\r\n        if (actualTerm === 'common' && itemTier === 2) return true;\r\n\r\n        // Element Tags\r\n        if (actualTerm === 'kinetic' && itemDef.defaultDamageType === 1) return true;\r\n        if (actualTerm === 'arc' && (itemDef.defaultDamageType === 2 || itemElement === 'arc')) return true;\r\n        if (actualTerm === 'solar' && (itemDef.defaultDamageType === 3 || itemElement === 'solar')) return true;\r\n        if (actualTerm === 'void' && (itemDef.defaultDamageType === 4 || itemElement === 'void')) return true;\r\n        if (actualTerm === 'stasis' && (itemDef.defaultDamageType === 6 || itemElement === 'stasis')) return true;\r\n        if (actualTerm === 'strand' && (itemDef.defaultDamageType === 7 || itemElement === 'strand')) return true;\r\n        if (actualTerm === 'prismatic' && (itemElement === 'prismatic')) return true;\r\n\r\n        // Class Tags\r\n        if (actualTerm === 'titan' && itemDef.classType === 0) return true;\r\n        if (actualTerm === 'hunter' && itemDef.classType === 1) return true;\r\n        if (actualTerm === 'warlock' && itemDef.classType === 2) return true;\r\n\r\n        // If it was a forced tag and didn't match, this term fails\r\n        if (isTag) return false;\r\n\r\n        // Otherwise, match against name, type, or description (OR logic within the term)\r\n        return itemName.includes(actualTerm) ||\r\n            itemType.includes(actualTerm) ||\r\n            itemDescription.includes(actualTerm);\r\n    });\r\n}\r\n\r\nexport function SynergyGalaxy({\r\n    searchQuery: searchQueryProp = '',\r\n    elementFilter = 'all',\r\n    classFilter = 'all',\r\n    isVaultSearchVisible = false,\r\n    onSynergyElementChange,\r\n    onSynergyOverlayChange,\r\n    viewMode = 'all',\r\n    synergyFilter,\r\n    onResetView,\r\n    forceCloseTrigger,\r\n    resetViewRef\r\n}: SynergyGalaxyProps = {}) {\r\n    const searchQueryRef = useRef(searchQueryProp);\r\n    const viewModeRef = useRef(viewMode);\r\n    const elementFilterRef = useRef(elementFilter);\r\n    const classFilterRef = useRef(classFilter);\r\n\r\n    // OPTIMIZATION: Single effect to update all filter refs\r\n    useEffect(() => {\r\n        searchQueryRef.current = searchQueryProp;\r\n        elementFilterRef.current = elementFilter;\r\n        classFilterRef.current = classFilter;\r\n        viewModeRef.current = viewMode;\r\n    }, [searchQueryProp, elementFilter, classFilter, viewMode]);\r\n\r\n    const galaxyRef = useRef<HTMLDivElement>(null);\r\n    const containerRef = useRef<HTMLDivElement>(null);\r\n    const canvasRef = useRef<HTMLCanvasElement>(null);\r\n    const offset = useRef({ x: 0, y: 0, z: -200 }); // Pulled camera back for full-frame visibility\r\n    const isDragging = useRef(false);\r\n    const lastMousePos = useRef({ x: -1, y: -1 });\r\n    const dragStartPos = useRef({ x: -1, y: -1 }); // To distinguish click vs drag\r\n    const isDraggingDisabled = useRef(true); // START DISABLED: Freeze camera on mount until player clicks\r\n    const isParallaxDisabled = useRef(true); // START DISABLED: Freeze camera on mount until player clicks\r\n    const isMiddleButtonDown = useRef(false); // Track middle mouse button for rotation\r\n\r\n    const [isLocked, setIsLocked] = useState(false);\r\n    const [focusedNode, setFocusedNode] = useState<any | null>(null);\r\n    const [fps, setFps] = useState(0);\r\n    const [renderTrigger, setRenderTrigger] = useState(0); // Added for forcing re-renders\r\n\r\n    // Synergy Web State\r\n    const [synergyConnections, setSynergyConnections] = useState<SynergyConnection[]>([]);\r\n    const [synergySourcePos, setSynergySourcePos] = useState<{ x: number; y: number; scale?: number } | null>(null);\r\n    const [synergySourceNodeId, setSynergySourceNodeId] = useState<string | null>(null);\r\n    const [isSynergyMode, setIsSynergyMode] = useState(false);\r\n    const [isSynergyExiting, setIsSynergyExiting] = useState(false);\r\n    // Wire positions computed in RAF loop for perfect sync with node positions\r\n\r\n    const [hoveredSynergyNodeId, setHoveredSynergyNodeId] = useState<string | null>(null);\r\n    // Track which wire is being hovered (contains both armor and weapon instance IDs for the synergy)\r\n    const [hoveredSynergyWire, setHoveredSynergyWire] = useState<{ armorInstanceId: string | null; weaponInstanceId: string | null } | null>(null);\r\n    const [isIsolatingDebounced, setIsIsolatingDebounced] = useState(false);\r\n\r\n    // Equip Animation State: Tracks item instance IDs currently playing the \"Equip\" flash animation\r\n    const [equippingItemIds, setEquippingItemIds] = useState<Set<string>>(new Set());\r\n    // Failed Equip State: Red glitch effect - REMOVED\r\n    // const [failedEquipItemIds, setFailedEquipItemIds] = useState<Set<string>>(new Set());\r\n\r\n    // SYNCHRONIZED NODES TRACKING: Memoize nodes involved in the active synergy web\r\n    // Store both node.id and instanceId for flexible matching\r\n    const synchronizedNodeIds = useMemo(() => {\r\n        const ids = new Set<string>();\r\n        if (synergySourceNodeId) ids.add(synergySourceNodeId);\r\n        synergyConnections.forEach(conn => {\r\n            if (conn.armorResult?.item.itemInstanceId) ids.add(conn.armorResult.item.itemInstanceId);\r\n            if (conn.weaponResult?.item.itemInstanceId) ids.add(conn.weaponResult.item.itemInstanceId);\r\n            // Also add by name-match for hubs\r\n            if (conn.element) ids.add(`${conn.element.toLowerCase()}-subclass`);\r\n        });\r\n        return ids;\r\n    }, [synergySourceNodeId, synergyConnections]);\r\n\r\n    // Helper to check if a node is synchronized (by id or instanceId)\r\n    const isNodeSynchronized = useCallback((node: any) => {\r\n        return (node.id && synchronizedNodeIds.has(node.id)) || (node.instanceId && synchronizedNodeIds.has(node.instanceId));\r\n    }, [synchronizedNodeIds]);\r\n\r\n    const isLockedRef = useRef(isLocked);\r\n    const containerRect = useRef<DOMRect | null>(null);\r\n    const canvasSize = useRef({ width: 0, height: 0 });\r\n    const rafId = useRef<number | null>(null);\r\n    const activeTooltipNodeId = useRef<string | null>(null); // Track which node is showing tooltip\r\n    const keysPressed = useRef<Set<string>>(new Set());\r\n    const tickRef = useRef<(now: number) => void>(() => { });\r\n    const updateTooltipDetectionRef = useRef<(mx: number, my: number) => void>(() => { });\r\n    const isWireHoveringRef = useRef(false);\r\n    const isMouseInBounds = useRef(true); // Track if mouse is inside the galaxy view\r\n    const isMovingRef = useRef(false); // Track if camera is moving (velocity > threshold)\r\n\r\n    const [isSynergyMenuOpen, setIsSynergyMenuOpen] = useState(false);\r\n\r\n    const lastFpsUpdateTime = useRef(0);\r\n    const frameCount = useRef(0);\r\n\r\n    // Immersive Mode: Parallax + Drift effects for \"flying through space\" feel\r\n    const { immersiveMode } = useSettingsStore();\r\n    const driftOffset = useRef({ x: 0, y: 0 }); // Accumulated drift for floating feel\r\n    const driftPhase = useRef(Math.random() * Math.PI * 2); // Random starting phase\r\n\r\n    const tooltipHideTimerRef = useRef<NodeJS.Timeout | null>(null);\r\n    const tooltipShowTimerRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n    const { hideGlobalUI, setHideGlobalUI } = useUIStore();\r\n\r\n    // Stability Refs: Used to prevent the main animation effect from re-running on every state/prop change\r\n    const isSynergyModeRef = useRef(isSynergyMode);\r\n    const synergyConnectionsRef = useRef(synergyConnections);\r\n    const synergySourceNodeIdRef = useRef(synergySourceNodeId);\r\n    const isVaultSearchVisibleRef = useRef(isVaultSearchVisible);\r\n    const hideGlobalUIRef = useRef(hideGlobalUI);\r\n    const hoveredSynergyWireRef = useRef(hoveredSynergyWire);\r\n    const isIsolatingDebouncedRef = useRef(isIsolatingDebounced);\r\n\r\n    // Tooltip Guard Ref: Prevents hammering the TooltipManager 60 times per second\r\n    const lastTooltipStateRef = useRef<{ id: string | null; x: number; y: number }>({ id: null, x: -1, y: -1 });\r\n\r\n    // OPTIMIZATION: Consolidated ref synchronization - single effect instead of 8\r\n    useEffect(() => {\r\n        isLockedRef.current = isLocked;\r\n        isSynergyModeRef.current = isSynergyMode;\r\n        synergyConnectionsRef.current = synergyConnections;\r\n        synergySourceNodeIdRef.current = synergySourceNodeId;\r\n        isVaultSearchVisibleRef.current = isVaultSearchVisible;\r\n        hideGlobalUIRef.current = hideGlobalUI;\r\n        hoveredSynergyWireRef.current = hoveredSynergyWire;\r\n        isIsolatingDebouncedRef.current = isIsolatingDebounced;\r\n    }, [isLocked, isSynergyMode, synergyConnections, synergySourceNodeId, isVaultSearchVisible, hideGlobalUI, hoveredSynergyWire, isIsolatingDebounced]);\r\n\r\n    const lastNotifiedElementRef = useRef<string | null>(null);\r\n    const safeNotifyElementChange = useCallback((element: string | null) => {\r\n        if (lastNotifiedElementRef.current === element) return;\r\n        lastNotifiedElementRef.current = element;\r\n        if (onSynergyElementChange) {\r\n            onSynergyElementChange(element);\r\n        }\r\n    }, [onSynergyElementChange]);\r\n\r\n    const targetOffset = useRef({ x: 0, y: 0, z: -200 });\r\n    const targetTilt = useRef({ x: 0, y: 0 });\r\n    const targetParallax = useRef({ x: 0, y: 0 }); // Current mouse-based shift target\r\n    const parallaxOffset = useRef({ x: 0, y: 0 }); // Lerped mouse-based shift\r\n\r\n    // FRAME-LEVEL SNAPSHOT: Captures exact projection constants for 1:1 wire sync\r\n    const projectionSnapshotRef = useRef({\r\n        offX: 0, offY: 0, offZ: 0,\r\n        tiltX: 0, tiltY: 0,\r\n        centerX: 0, centerY: 0,\r\n        focalLength: 1000\r\n    });\r\n\r\n    const transitionRef = useRef<{ active: boolean, startTime: number, duration: number, start: any, target: any } | null>(null);\r\n\r\n    // Helper to safely start a camera transition with NaN protection\r\n    const startTransition = useCallback((targetX: number, targetY: number, targetZ: number, duration: number = 800) => {\r\n        // Validate target values\r\n        if (isNaN(targetX) || isNaN(targetY) || isNaN(targetZ)) {\r\n            warnLog('SynergyGalaxy', ' NaN target in transition:', { targetX, targetY, targetZ });\r\n            return false;\r\n        }\r\n\r\n        // Validate current offset\r\n        if (isNaN(offset.current.x) || isNaN(offset.current.y) || isNaN(offset.current.z)) {\r\n            warnLog('SynergyGalaxy', ' NaN offset detected, resetting');\r\n            offset.current = { x: 0, y: 0, z: -200 };\r\n        }\r\n\r\n        transitionRef.current = {\r\n            active: true,\r\n            startTime: performance.now(),\r\n            duration,\r\n            start: { ...offset.current },\r\n            target: { x: targetX, y: targetY, z: targetZ }\r\n        };\r\n        targetOffset.current = { x: targetX, y: targetY, z: targetZ };\r\n        return true;\r\n    }, []);\r\n\r\n    // Helper to project a 3D position to screen coordinates\r\n    // Returns both stageX/Y (relative to viewport center) and screenX/Y (absolute pixels)\r\n    const projectToScreen = useCallback((x: number, y: number, z: number) => {\r\n        const snap = projectionSnapshotRef.current;\r\n\r\n        // SAFETY: Check for NaN in projection snapshot (camera corruption recovery)\r\n        if (isNaN(snap.offX) || isNaN(snap.offY) || isNaN(snap.offZ)) {\r\n            warnLog('SynergyGalaxy', ' NaN in projection, using safe defaults');\r\n            return {\r\n                stageX: 0,\r\n                stageY: 0,\r\n                screenX: snap.centerX || 0,\r\n                screenY: snap.centerY || 0,\r\n                scale: 1,\r\n                finalZ: 0\r\n            };\r\n        }\r\n\r\n        // OPTIMIZATION: Trig calculations are expensive, but necessary here since snap values change every frame\r\n        const rx = (-snap.tiltX) * Math.PI / 180;\r\n        const ry = snap.tiltY * Math.PI / 180;\r\n        const cosX = Math.cos(rx);\r\n        const sinX = Math.sin(rx);\r\n        const cosY = Math.cos(ry);\r\n        const sinY = Math.sin(ry);\r\n\r\n        const tx1 = x * cosY + z * sinY;\r\n        const tz1 = -x * sinY + z * cosY;\r\n        const ty2 = y * cosX - tz1 * sinX;\r\n        const tz2 = y * sinX + tz1 * cosX;\r\n\r\n        // COMBINED OFFSET: Camera Position (lerped focus) + Parallax Shift (lerped peek)\r\n        const finalX = tx1 + snap.offX;\r\n        const finalY = ty2 + snap.offY;\r\n        const finalZ = tz2 + snap.offZ;\r\n\r\n        const scale = Math.max(0.01, Math.min(20, snap.focalLength / Math.max(1, snap.focalLength - finalZ)));\r\n\r\n        // Stage-relative (for DOM nodes at top:50%/left:50%)\r\n        const stageX = finalX * scale;\r\n        const stageY = finalY * scale;\r\n\r\n        // Visual Clipping (Near Plane)\r\n        // If finalZ approaches focalLength (1000), scale explodes.\r\n        // We set isVisible=false for anything behind the camera (finalZ >= focalLength)\r\n        // to implement \"fly-through\" and back-face culling.\r\n        const isVisible = finalZ < (snap.focalLength - 5);\r\n\r\n        // Safety: Prevent negative or infinite scales when very close to focalLength\r\n        const effectiveScale = isVisible ? scale : 0;\r\n\r\n        return {\r\n            stageX,\r\n            stageY,\r\n            screenX: snap.centerX + stageX,\r\n            screenY: snap.centerY + stageY,\r\n            scale: effectiveScale,\r\n            finalZ,\r\n            isVisible\r\n        };\r\n    }, []);\r\n\r\n    // Subscribe to profile store with shallow equality to detect all updates\r\n    const characterEquipment = useProfileStore(state => state.characterEquipment);\r\n    const characterInventories = useProfileStore(state => state.characterInventories);\r\n    const vaultInventory = useProfileStore(state => state.vaultInventory);\r\n    const itemInstances = useProfileStore(state => state.itemInstances);\r\n    const selectedCharacterId = useProfileStore(state => state.selectedCharacterId);\r\n    const responseMintedTimestamp = useProfileStore(state => state.responseMintedTimestamp);\r\n    const isLoading = useProfileStore(state => state.isLoading);\r\n\r\n\r\n    // Clear cached rect on data change\r\n\r\n\r\n    const { maxSynergies, organizedGalaxy, randomVaultSeed, performanceMode, showFps } = useSettingsStore();\r\n    const { isLoaded: manifestLoaded } = useManifestStore();\r\n    const { showTooltip, hideTooltip, openTransferMenu } = useTooltip();\r\n\r\n    // DIM Standard: Check for stale data from Bungie API\r\n    const isStale = useMemo(() => {\r\n        if (!responseMintedTimestamp) return false;\r\n        try {\r\n            const mintedDate = new Date(responseMintedTimestamp);\r\n            const now = new Date();\r\n            const diffMs = now.getTime() - mintedDate.getTime();\r\n            // If data is older than 2 minutes, mark as stale/warning\r\n            return diffMs > 120000;\r\n        } catch (e) {\r\n            return false;\r\n        }\r\n    }, [responseMintedTimestamp]);\r\n\r\n    // Auto-trigger synergy web when synergyFilter is provided (from Vault builds)\r\n    const synergyFilterTriggered = useRef(false);\r\n\r\n    // Store projected vault points for interaction\r\n    const projectedVaultRef = useRef<Array<{ px: number, py: number, size: number, item: any, instanceId?: string, x: number, y: number, z: number, opacity?: number }>>([]);\r\n    const nodeRefs = useRef<Map<string, HTMLDivElement>>(new Map());\r\n\r\n    // Layout configuration\r\n    const COLUMN_X = 550; // Brought closer to the center\r\n    const COLUMN_Y_GAP = 220;\r\n\r\n    // Helper to get element from itemHash\r\n    const getElement = useCallback((hash: number): ElementType => {\r\n        if (!manifestLoaded) return ElementType.Kinetic;\r\n        const def = manifestService.getItem(hash);\r\n        if (!def) return ElementType.Kinetic;\r\n\r\n        // 1. Subclass Element (via talentGrid)\r\n        if (def.talentGrid?.hudDamageType === 2) return ElementType.Arc;\r\n        if (def.talentGrid?.hudDamageType === 3) return ElementType.Solar;\r\n        if (def.talentGrid?.hudDamageType === 4) return ElementType.Void;\r\n        if (def.talentGrid?.hudDamageType === 6) return ElementType.Stasis;\r\n        if (def.talentGrid?.hudDamageType === 7) return ElementType.Strand;\r\n\r\n        // 2. Weapon Element (via defaultDamageType)\r\n        const damageType = def.defaultDamageType;\r\n        if (damageType === 2) return ElementType.Arc;\r\n        if (damageType === 3) return ElementType.Solar;\r\n        if (damageType === 4) return ElementType.Void;\r\n        if (damageType === 6) return ElementType.Stasis;\r\n        if (damageType === 7) return ElementType.Strand;\r\n\r\n        const name = def.displayProperties?.name?.toLowerCase() || '';\r\n        if (name.includes('prismatic')) return ElementType.Prismatic;\r\n        return ElementType.Kinetic;\r\n    }, [manifestLoaded]);\r\n\r\n    // Deterministic random helper\r\n    const seedRandom = (seed: string | number) => {\r\n        let h = typeof seed === 'string'\r\n            ? seed.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0)\r\n            : seed;\r\n        const x = Math.sin(h++) * 10000;\r\n        return x - Math.floor(x);\r\n    };\r\n\r\n    // OPTIMIZATION: Generate nodes without search dependency (filtering happens in render)\r\n    const { nodes, vaultPoints } = useMemo(() => {\r\n        const generatedNodes: NodePosition[] = [];\r\n        const currentCharacterId = selectedCharacterId || '';\r\n\r\n        const equipment = characterEquipment[currentCharacterId] || [];\r\n        const inventory = characterInventories[currentCharacterId] || [];\r\n\r\n        // 1. All Subclasses (Central Constellation)\r\n        const equippedSubclass = equipment.find(i => i.bucketHash === BUCKET_HASHES.SUBCLASS);\r\n        const inventorySubclasses = inventory.filter(i => i.bucketHash === BUCKET_HASHES.SUBCLASS);\r\n        const allSubclasses = [equippedSubclass, ...inventorySubclasses].filter(Boolean) as any[];\r\n\r\n        allSubclasses.forEach((sc, idx) => {\r\n            const isEquipped = sc.itemHash === equippedSubclass?.itemHash;\r\n            // DYNAMIC CENTERING: Equipped is always at the origin (0,0,0)\r\n            // Inventory subclasses spiral behind starting from -600px Z\r\n            const zPos = isEquipped ? 0 : (idx * -600) - 200;\r\n            const xOffset = isEquipped ? 0 : Math.sin(idx * 1.5) * 450;\r\n            const yOffset = isEquipped ? 0 : Math.cos(idx * 1.5) * 350;\r\n\r\n            generatedNodes.push({\r\n                id: `subclass-${sc.itemHash}-${idx}`,\r\n                type: 'subclass',\r\n                hash: sc.itemHash,\r\n                instanceId: sc.itemInstanceId,\r\n                bucketHash: BUCKET_HASHES.SUBCLASS,\r\n                element: getElement(sc.itemHash),\r\n                x: xOffset,\r\n                y: yOffset,\r\n                z: zPos,\r\n                isEquipped,\r\n                isEmpty: false,\r\n                originalItem: sc,\r\n                lodLevel: 0\r\n            });\r\n        });\r\n\r\n        // 2. Character Gear (Fixed columns or light scatter)\r\n        const allCharacterGear = [...equipment, ...inventory];\r\n        allCharacterGear.forEach((item) => {\r\n            if (item.bucketHash === BUCKET_HASHES.SUBCLASS) return;\r\n\r\n            const isWeapon = WEAPON_BUCKETS.includes(item.bucketHash);\r\n            const isArmor = ARMOR_BUCKETS.includes(item.bucketHash);\r\n            if (!isWeapon && !isArmor) return;\r\n\r\n            const isEquipped = equipment.some(e => e.itemInstanceId === item.itemInstanceId);\r\n            const itemInstance = item.itemInstanceId ? itemInstances[item.itemInstanceId] : undefined;\r\n            const itemDef = manifestService.getItem(item.itemHash);\r\n            const damageType = itemInstance?.damageType || itemDef?.defaultDamageType;\r\n            const damageTypeName = damageType ? DAMAGE_TYPE_NAMES[damageType] : undefined;\r\n\r\n            let x, y, z;\r\n            if (isEquipped) {\r\n                const bIdx = (isWeapon ? WEAPON_BUCKETS : ARMOR_BUCKETS).indexOf(item.bucketHash);\r\n                x = isWeapon ? -COLUMN_X : COLUMN_X;\r\n                y = (bIdx - (isWeapon ? 1 : 2)) * COLUMN_Y_GAP;\r\n                z = 0; // Same plane as subclass for perfect alignment\r\n            } else {\r\n                // Character inventory - scatter NEAR the center (around subclass spiral)\r\n                const seed = item.itemInstanceId || item.itemHash.toString();\r\n\r\n                if (!organizedGalaxy) {\r\n                    const xScatter = seedRandom(seed + 'rx' + randomVaultSeed);\r\n                    const yScatter = seedRandom(seed + 'ry' + randomVaultSeed);\r\n                    const zScatter = seedRandom(seed + 'rz' + randomVaultSeed);\r\n                    const baseX = isWeapon ? -COLUMN_X : COLUMN_X;\r\n                    x = baseX + ((xScatter - 0.5) * 800);\r\n                    y = ((yScatter - 0.5) * 800);\r\n                    z = -200 - (zScatter * 4000);\r\n                } else {\r\n                    const bIdx = (isWeapon ? WEAPON_BUCKETS : ARMOR_BUCKETS).indexOf(item.bucketHash);\r\n                    const baseX = isWeapon ? -COLUMN_X - 200 : COLUMN_X + 200;\r\n                    const depthMin = -500 - (bIdx * 1200);\r\n                    const depthMax = depthMin - 1200;\r\n                    const zBias = seedRandom(seed + 'z');\r\n                    const xScatter = seedRandom(seed + 'x');\r\n                    const yScatter = seedRandom(seed + 'y');\r\n                    z = depthMin + (zBias * (depthMax - depthMin));\r\n                    x = baseX + ((xScatter - 0.5) * 400);\r\n                    y = ((yScatter - 0.5) * 800);\r\n                }\r\n            }\r\n\r\n            generatedNodes.push({\r\n                id: `gear-${item.itemInstanceId || item.itemHash}-${item.bucketHash}-${isEquipped ? 'eq' : 'inv'}`,\r\n                type: isWeapon ? 'weapon' : 'armor',\r\n                hash: item.itemHash,\r\n                instanceId: item.itemInstanceId,\r\n                bucketHash: item.bucketHash,\r\n                element: getElement(item.itemHash),\r\n                x, y, z,\r\n                isEquipped,\r\n                isEmpty: false,\r\n                tierClass: getTierClass(item),\r\n                power: itemInstance?.power,\r\n                damageIconUrl: (isWeapon && damageTypeName) ? getBungieUrl(manifestService.getDamageTypeIcon(damageTypeName as any) || '') : undefined,\r\n                watermarkUrl: itemDef ? getBungieUrl(itemDef.iconWatermarkFeatured || itemDef.iconWatermark) : undefined,\r\n                isLegacyWatermark: itemDef ? (!itemDef.iconWatermarkFeatured && !!itemDef.iconWatermark) || isLegacyVersion(itemDef.quality?.currentVersion) : false,\r\n                isMasterwork: !!(item.state && (item.state & 4)),\r\n                isCrafted: !!(item.state && (item.state & 8)),\r\n                isEnhanced: !!(itemInstance?.sockets?.some((s: any) => s.plugHash === 3727270518)) || !!(item.state && (item.state & 8) && itemInstance?.gearTier && itemInstance.gearTier >= 2),\r\n                tier: itemInstance?.gearTier,\r\n                originalItem: item,\r\n                lodLevel: isEquipped ? 0 : 1,\r\n                iconUrl: getBungieUrl(manifestService.getItem(item.overrideStyleItemHash || item.itemHash)?.displayProperties?.icon || '')\r\n            });\r\n        });\r\n\r\n        // 3. VAULT STARFIELD\r\n        const actualVaultGear = vaultInventory.filter(item => {\r\n            const itemDef = manifestService.getItem(item.itemHash);\r\n            const bucketHash = itemDef?.inventory?.bucketTypeHash || 0;\r\n            return WEAPON_BUCKETS.includes(bucketHash) || ARMOR_BUCKETS.includes(bucketHash);\r\n        });\r\n\r\n        const vaultPointsArray: Array<{ x: number, y: number, z: number, color: string, originalItem: any, instanceId?: string, isMasterwork?: boolean, isCrafted?: boolean, isExotic?: boolean }> = [];\r\n        actualVaultGear.forEach((item) => {\r\n            const itemDef = manifestService.getItem(item.itemHash);\r\n            const bucketHash = itemDef?.inventory?.bucketTypeHash || 0;\r\n            const isWeapon = WEAPON_BUCKETS.includes(bucketHash);\r\n            const isArmor = ARMOR_BUCKETS.includes(bucketHash);\r\n            if (!isWeapon && !isArmor) return;\r\n\r\n            let x, y, z;\r\n            const seed = item.itemInstanceId || item.itemHash.toString();\r\n\r\n            if (!organizedGalaxy) {\r\n                const xScatter = seedRandom(seed + 'rx' + randomVaultSeed);\r\n                const yScatter = seedRandom(seed + 'ry' + randomVaultSeed);\r\n                const zScatter = seedRandom(seed + 'rz' + randomVaultSeed);\r\n                x = (xScatter - 0.5) * 15000;\r\n                y = (yScatter - 0.5) * 10000;\r\n                z = -1000 - (zScatter * 25000);\r\n            } else {\r\n                let slotIndex = 0;\r\n                let baseX = 0;\r\n                let depthRange = { min: 0, max: 0 };\r\n                if (isWeapon) {\r\n                    baseX = -2250;\r\n                    slotIndex = WEAPON_BUCKETS.indexOf(bucketHash);\r\n                    depthRange = { min: -1500 - (slotIndex * 3500), max: -1500 - (slotIndex * 3500) - 3500 };\r\n                } else {\r\n                    baseX = 2250;\r\n                    slotIndex = ARMOR_BUCKETS.indexOf(bucketHash);\r\n                    depthRange = { min: -1500 - (slotIndex * 2300), max: -1500 - (slotIndex * 2300) - 2300 };\r\n                }\r\n                const zBias = seedRandom(seed + 'z');\r\n                const xScatter = seedRandom(seed + 'x');\r\n                const yScatter = seedRandom(seed + 'y');\r\n                z = depthRange.min + (zBias * (depthRange.max - depthRange.min));\r\n                x = baseX + ((xScatter - 0.5) * 1200);\r\n                y = ((yScatter - 0.5) * 2500);\r\n            }\r\n\r\n            const element = getElement(item.itemHash);\r\n            const tierClass = getTierClass(item);\r\n            const isExotic = tierClass === 'exotic';\r\n            let color: string;\r\n            if (organizedGalaxy) {\r\n                if (isExotic) color = '#FFD700'; else if (tierClass === 'legendary') color = '#a850f2'; else color = ELEMENT_COLORS[element] || '#fff';\r\n            } else {\r\n                color = ELEMENT_COLORS[element] || '#fff';\r\n            }\r\n\r\n            vaultPointsArray.push({\r\n                x, y, z,\r\n                color: color,\r\n                isMasterwork: !!(item.state && (item.state & 4)),\r\n                isCrafted: !!(item.state && (item.state & 8)),\r\n                isExotic: isExotic,\r\n                originalItem: item,\r\n                instanceId: item.itemInstanceId\r\n            });\r\n        });\r\n\r\n        return { nodes: generatedNodes, vaultPoints: vaultPointsArray };\r\n    }, [selectedCharacterId, characterEquipment, characterInventories, vaultInventory, itemInstances, getElement, organizedGalaxy, randomVaultSeed, manifestLoaded]);\r\n\r\n    // NEW OPTIMIZATION: Pre-calculate filter matches to avoid expensive work in the 60FPS loop\r\n    const filteredNodeIds = useMemo(() => {\r\n        const matches = new Set<string>();\r\n        nodes.forEach(node => {\r\n            if (itemMatchesFilters(node, searchQueryProp, elementFilter, classFilter, getElement)) {\r\n                matches.add(node.id);\r\n            }\r\n        });\r\n        return matches;\r\n    }, [nodes, searchQueryProp, elementFilter, classFilter, getElement]);\r\n\r\n    const filteredVaultPoints = useMemo(() => {\r\n        return vaultPoints.filter(pt =>\r\n            itemMatchesFilters(pt.originalItem, searchQueryProp, elementFilter, classFilter, getElement)\r\n        );\r\n    }, [vaultPoints, searchQueryProp, elementFilter, classFilter, getElement]);\r\n\r\n\r\n\r\n    // Auto-trigger synergy web when synergyFilter is provided (from Vault builds)\r\n    useEffect(() => {\r\n        debugLog('SynergyGalaxy', 'Filter effect check:', {\r\n            synergyFilter,\r\n            triggered: synergyFilterTriggered.current,\r\n            manifestLoaded,\r\n            nodesCount: nodes.length\r\n        });\r\n\r\n        if (!synergyFilter || synergyFilterTriggered.current || !manifestLoaded || nodes.length === 0) return;\r\n\r\n        const { weaponName, armorName, element } = synergyFilter;\r\n        if (!weaponName && !armorName) return;\r\n\r\n        // Mark as triggered to prevent re-running\r\n        synergyFilterTriggered.current = true;\r\n\r\n        // Get guardian class\r\n        const { characters, selectedCharacterId: charId } = useProfileStore.getState();\r\n        const currentChar = characters.find(c => c.characterId === charId);\r\n        const guardianClass = currentChar?.classType ?? 0;\r\n\r\n        // Find the equipped subclass node to use as source\r\n        const equippedSubclassNode = nodes.find(n => n.type === 'subclass' && n.isEquipped);\r\n\r\n        // Delay to let the galaxy render and containerRect to be set\r\n        const timer = setTimeout(async () => {\r\n            try {\r\n                // Find synergies for the weapon or armor\r\n                const searchType = weaponName ? 'weapon' : 'armor';\r\n                const searchName = weaponName || armorName || '';\r\n\r\n                debugLog('SynergyGalaxy', 'Auto-trigger search:', { searchType, searchName, guardianClass });\r\n\r\n                const synergies = await findSynergies(\r\n                    searchType,\r\n                    searchName,\r\n                    guardianClass,\r\n                    { maxResults: maxSynergies, seed: randomVaultSeed }\r\n                );\r\n\r\n                debugLog('SynergyGalaxy', `Found ${synergies.length} synergies`, { synergies, equippedSubclassNode, containerRect: containerRect.current });\r\n\r\n                if (synergies.length > 0) {\r\n                    setSynergyConnections(synergies);\r\n                    setIsSynergyMode(true);\r\n                    setIsSynergyExiting(false);\r\n\r\n                    // Set source node ID to the equipped subclass\r\n                    if (equippedSubclassNode) {\r\n                        setSynergySourceNodeId(equippedSubclassNode.id);\r\n                        debugLog('SynergyGalaxy', `Set source node: ${equippedSubclassNode.id}`);\r\n\r\n                        // Calculate source position from the equipped subclass\r\n                        if (containerRect.current) {\r\n                            const { screenX, screenY, scale } = projectToScreen(\r\n                                equippedSubclassNode.x,\r\n                                equippedSubclassNode.y,\r\n                                equippedSubclassNode.z\r\n                            );\r\n                            debugLog('SynergyGalaxy', 'Set source position:', { screenX, screenY, scale });\r\n                            setSynergySourcePos({ x: screenX, y: screenY, scale });\r\n                        }\r\n                    }\r\n\r\n                    // Set element for UI\r\n                    if (onSynergyElementChange && element) {\r\n                        onSynergyElementChange(element);\r\n                    }\r\n                } else {\r\n                    debugLog('SynergyGalaxy', 'No synergies found - items may not be in inventory');\r\n                }\r\n            } catch (err) {\r\n                errorLog('SynergyGalaxy', 'Failed to auto-trigger synergies:', err);\r\n            }\r\n        }, 800); // Longer delay to ensure containerRect is set\r\n\r\n        return () => clearTimeout(timer);\r\n    }, [synergyFilter, manifestLoaded, nodes, maxSynergies, randomVaultSeed, onSynergyElementChange, projectToScreen]);\r\n\r\n    // Update refs for use in tick loop\r\n    const filteredNodeIdsRef = useRef(filteredNodeIds);\r\n    const filteredVaultPointsRef = useRef(filteredVaultPoints);\r\n\r\n    // OPTIMIZATION: Memoize inventory hashes to prevent recreation every frame\r\n    const inventoryHashes = useMemo(() => {\r\n        const equipment = characterEquipment[selectedCharacterId || ''] || [];\r\n        const inventory = characterInventories[selectedCharacterId || ''] || [];\r\n        return new Set([...equipment, ...inventory].map(i => i.itemHash));\r\n    }, [characterEquipment, characterInventories, selectedCharacterId]);\r\n\r\n    const vaultPointsRef = useRef<any[]>([]);\r\n\r\n    const drawCanvas = useCallback((tiltX: number = 0, tiltY: number = 0, timestamp: number = 0) => {\r\n        const canvas = canvasRef.current;\r\n        if (!canvas || !containerRect.current) return;\r\n        const ctx = canvas.getContext('2d');\r\n        if (!ctx) return;\r\n\r\n        const { width, height } = canvasSize.current;\r\n        if (width === 0 || height === 0) return;\r\n\r\n        ctx.clearRect(0, 0, width, height);\r\n\r\n        const centerX = width / 2;\r\n        const centerY = height / 2;\r\n        const focalLength = 1000;\r\n        const offX = offset.current.x + parallaxOffset.current.x;\r\n        const offY = offset.current.y + parallaxOffset.current.y;\r\n        const offZ = offset.current.z;\r\n\r\n        // Update snapshot for frame-locked consistency across wires, stars, and icons\r\n        projectionSnapshotRef.current = {\r\n            offX, offY, offZ,\r\n            tiltX, tiltY,\r\n            centerX, centerY,\r\n            focalLength\r\n        };\r\n\r\n        const nextProjectedVault: typeof projectedVaultRef.current = [];\r\n\r\n        // OPTIMIZATION: Pre-compute trig values once per frame\r\n        const rx = (-tiltX) * Math.PI / 180;\r\n        const ry = tiltY * Math.PI / 180;\r\n        const cosX = Math.cos(rx);\r\n        const sinX = Math.sin(rx);\r\n        const cosY = Math.cos(ry);\r\n        const sinY = Math.sin(ry);\r\n\r\n        filteredVaultPointsRef.current.forEach(pt => {\r\n            // CULLING PRIORITY\r\n            // 1. Never show focused item in starfield (double image)\r\n            // 2. Never show items that are already equipped or in character inventory\r\n            if (focusedNode && pt.instanceId === focusedNode.instanceId) return;\r\n            if (inventoryHashes.has(pt.originalItem.itemHash)) return;\r\n\r\n            // 2.5. Filter by view mode\r\n            const isSync = isNodeSynchronized(pt);\r\n            const itemDef = manifestService.getItem(pt.originalItem.itemHash);\r\n            if (!isSync && itemDef && viewModeRef.current !== 'all') {\r\n                if (viewModeRef.current === 'subclass-only') {\r\n                    // Vault items are never subclasses, so hide all vault items\r\n                    return;\r\n                } else if (viewModeRef.current === 'inventory-only') {\r\n                    // Hide all vault items in inventory-only mode\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // matchesSearch is now implicit since we use filteredVaultPointsRef\r\n            const matchesSearch = true;\r\n\r\n\r\n            // 1. Initial Translation (Node Relative to Stage)\r\n            let x = pt.x;\r\n            let y = pt.y;\r\n            let z = pt.z;\r\n\r\n            // 2. Rotate Y (first in CSS order)\r\n            const tx1 = x * cosY + z * sinY;\r\n            const tz1 = -x * sinY + z * cosY;\r\n\r\n            // 3. Rotate X\r\n            const ty2 = y * cosX - tz1 * sinX;\r\n            const tz2 = y * sinX + tz1 * cosX;\r\n\r\n            // 4. Final Translation (Stage Offset)\r\n            const finalX = tx1 + offX;\r\n            const finalY = ty2 + offY;\r\n            const finalZ = tz2 + offZ;\r\n\r\n            // 5. Projection\r\n            // PERFORMANCE MODE CULLING: Adjust visual range based on setting\r\n            // BYPASS CULLING for active synergy nodes so web connections always have a target\r\n            const farClip = performanceMode === 'low' ? -5000 : performanceMode === 'medium' ? -25000 : -60000;\r\n            if (!isSync && (finalZ > 900 || finalZ < farClip)) return; // Cull only if not part of active synergy\r\n\r\n            const scale = focalLength / (focalLength - finalZ);\r\n            const px = centerX + finalX * scale;\r\n            const py = centerY + finalY * scale;\r\n\r\n            if (px < -100 || px > width + 100 || py < -100 || py > height + 100) return;\r\n\r\n            let size = Math.max(0.8, 3.5 * scale); // Increased min size\r\n            let alpha = Math.min(1, Math.max(0.2, scale * 2.1)); // Increased brightness\r\n\r\n            // SYNERGY HOVER DIMMING: When hovering a wire, dim vault items that aren't part of the synergy\r\n            if (isSynergyModeRef.current && hoveredSynergyWireRef.current) {\r\n                const isHoveredArmor = pt.instanceId === hoveredSynergyWireRef.current.armorInstanceId;\r\n                const isHoveredWeapon = pt.instanceId === hoveredSynergyWireRef.current.weaponInstanceId;\r\n                if (!isHoveredArmor && !isHoveredWeapon) {\r\n                    alpha *= 0.08;\r\n                }\r\n            }\r\n\r\n            // SEARCH PULSE: Make filtered items \"breathe\" to stand out in the starfield\r\n            if (searchQueryRef.current && matchesSearch && !isSync) {\r\n                const pulse = 1 + Math.sin(timestamp / 400) * 0.15;\r\n                size *= pulse;\r\n                alpha = Math.min(1, alpha * 1.4);\r\n            }\r\n\r\n            // Only apply masterwork glow if item matches search (or no search active)\r\n            if (pt.isMasterwork && matchesSearch) {\r\n                const pulse = 1 + Math.sin(timestamp / 300) * 0.2;\r\n                size *= 1.4 * pulse;\r\n                alpha = Math.min(1, alpha * 1.5 * pulse);\r\n            }\r\n\r\n            // Glow effect (More pronounced) - Bright yellow glow for masterworks and exotics\r\n            // In colorful mode, exotics get bright yellow glow regardless of masterwork status\r\n            const shouldGlow = pt.isMasterwork || (organizedGalaxy && pt.isExotic);\r\n            ctx.fillStyle = shouldGlow ? '#FFD700' : pt.color;\r\n            ctx.globalAlpha = alpha * (shouldGlow ? 0.8 : 0.55);\r\n            ctx.beginPath();\r\n            ctx.arc(px, py, size * 3.5, 0, Math.PI * 2);\r\n            ctx.fill();\r\n\r\n            // Core point - Use bright yellow for exotics in colorful mode, otherwise use original color\r\n            ctx.fillStyle = (organizedGalaxy && pt.isExotic) ? '#FFD700' : pt.color;\r\n            ctx.globalAlpha = Math.min(1, alpha * 1.5); // Brighter core\r\n            ctx.beginPath();\r\n            ctx.arc(px, py, size * 2.8, 0, Math.PI * 2); // Much bigger\r\n            ctx.fill();\r\n\r\n            // Store for hit detection and synergy wire positioning\r\n            // Only store if the item is actually visible (matches search or is part of synergy)\r\n            if (matchesSearch || isSync) {\r\n                nextProjectedVault.push({\r\n                    px,\r\n                    py,\r\n                    size: size * 4,\r\n                    item: pt.originalItem,\r\n                    instanceId: pt.instanceId,\r\n                    x: pt.x,\r\n                    y: pt.y,\r\n                    z: pt.z,\r\n                    opacity: 1\r\n                });\r\n            }\r\n        });\r\n\r\n        projectedVaultRef.current = nextProjectedVault;\r\n    }, [focusedNode, inventoryHashes, isNodeSynchronized, getElement, organizedGalaxy, performanceMode]);\r\n\r\n    // Sync all refs and trigger redraw when filters or data change\r\n    useEffect(() => {\r\n        filteredNodeIdsRef.current = filteredNodeIds;\r\n        filteredVaultPointsRef.current = filteredVaultPoints;\r\n        vaultPointsRef.current = vaultPoints;\r\n        drawCanvas();\r\n    }, [filteredNodeIds, filteredVaultPoints, vaultPoints, drawCanvas, renderTrigger]);\r\n\r\n    const updateTransform = useCallback((tX: number, tY: number, timestamp: number = 0) => {\r\n        // Stage transformation is now handled by individual node projection in renderLoop\r\n        // This avoids browser-level CSS perspective clipping\r\n        if (galaxyRef.current) {\r\n            galaxyRef.current.style.transform = 'none';\r\n        }\r\n\r\n        // Sync Canvas with Tilts\r\n        drawCanvas(tX, tY, timestamp);\r\n    }, [drawCanvas]);\r\n\r\n\r\n    const handleResetView = useCallback(() => {\r\n        debugLog('SynergyGalaxy', 'Reset view triggered');\r\n        // EARLY EXIT: If already at orbit (default position) with nothing to reset, skip expensive operations\r\n        const isAtOrbit = !isLocked && !focusedNode && !isSynergyMode && !activeTooltipNodeId.current;\r\n        const isAtDefaultPosition = Math.abs(offset.current.x) < 1 &&\r\n            Math.abs(offset.current.y) < 1 &&\r\n            Math.abs(offset.current.z - (-200)) < 1;\r\n\r\n        if (isAtOrbit && isAtDefaultPosition) {\r\n            // Already at orbit with nothing to reset - skip to prevent unnecessary freeze\r\n            return;\r\n        }\r\n\r\n        // Reset UI state immediately\r\n        setIsLocked(false);\r\n        isLockedRef.current = false;\r\n        setFocusedNode(null);\r\n        hideTooltip();\r\n        activeTooltipNodeId.current = null;\r\n\r\n        // Close synergy web with exit animation if active\r\n        // Reset synergy wire hover state to clear isolation immediately\r\n        setHoveredSynergyWire(null);\r\n        hoveredSynergyWireRef.current = null;\r\n\r\n        if (isSynergyMode && !isSynergyExiting) {\r\n            setIsSynergyExiting(true);\r\n            // Reset synergy element immediately\r\n            if (onSynergyElementChange) {\r\n                onSynergyElementChange(null);\r\n            }\r\n        }\r\n\r\n        // rotateVaultSeed: Every time we return to orbit, randomize the galaxy as requested\r\n        useSettingsStore.getState().rotateVaultSeed();\r\n\r\n        // Disable camera dragging and parallax to keep orbit view perfectly centered\r\n        isDraggingDisabled.current = true;\r\n        isParallaxDisabled.current = true;\r\n\r\n        // Zero out parallax immediately\r\n        targetParallax.current = { x: 0, y: 0 };\r\n        parallaxOffset.current = { x: 0, y: 0 };\r\n\r\n        // START Camera transition immediately (use helper for NaN safety)\r\n        // Duration reduced to 300ms for a truly \"take me right to orbit\" feel\r\n        startTransition(0, 0, -200, 300);\r\n\r\n        // Cleanup synergy state after animation completes\r\n        if (isSynergyMode && !isSynergyExiting) {\r\n            setTimeout(() => {\r\n                // Use regular state updates for cleanup\r\n                setSynergyConnections([]);\r\n                setSynergySourcePos(null);\r\n                setSynergySourceNodeId(null);\r\n                setIsSynergyMode(false);\r\n                setIsSynergyExiting(false);\r\n            }, 200); // Reduced delay to match faster transition\r\n        }\r\n    }, [hideTooltip, isSynergyMode, isSynergyExiting, onSynergyElementChange, isLocked, focusedNode, startTransition]);\r\n\r\n    // Handle closing the synergy web overlay\r\n    const handleCloseSynergyWeb = useCallback(() => {\r\n        if (!isSynergyExiting) {\r\n            // Defer to next frame to prevent blocking\r\n            requestAnimationFrame(() => {\r\n                flushSync(() => {\r\n                    setIsSynergyExiting(true);\r\n                    if (onSynergyElementChange) {\r\n                        onSynergyElementChange(null);\r\n                    }\r\n                });\r\n\r\n                setTimeout(() => {\r\n                    flushSync(() => {\r\n                        setSynergyConnections([]);\r\n                        setSynergySourcePos(null);\r\n                        setSynergySourceNodeId(null);\r\n                        setIsSynergyMode(false);\r\n                        setIsSynergyExiting(false);\r\n                    });\r\n                }, 300);\r\n            });\r\n        }\r\n    }, [isSynergyExiting, onSynergyElementChange]);\r\n\r\n    // PULL BACK TO ORBIT: Respond to parent signalling a force close (e.g. after equip)\r\n    const lastProcessedTrigger = useRef(0);\r\n    useEffect(() => {\r\n        if (forceCloseTrigger !== undefined && forceCloseTrigger > lastProcessedTrigger.current) {\r\n            lastProcessedTrigger.current = forceCloseTrigger;\r\n            handleResetView();\r\n        }\r\n    }, [forceCloseTrigger, handleResetView]);\r\n\r\n    // Handle synergy wire lock - zoom to the clicked item and keep synergy mode with tooltip attached\r\n    const handleSynergyWireLock = useCallback((itemInstanceId: string | null) => {\r\n        debugLog('SynergyGalaxy', `Wire lock triggered: ${itemInstanceId}`);\r\n        if (!itemInstanceId) {\r\n            // Unlocked - reset the locked state so user can navigate freely\r\n            setFocusedNode(null);\r\n            setIsLocked(false);\r\n            isLockedRef.current = false;\r\n            return;\r\n        }\r\n\r\n        // Find the node or vault item with this instance ID\r\n        // Check both instanceId and id to match the wire position calculation\r\n        let node = nodes.find(n => n.instanceId === itemInstanceId || n.id === itemInstanceId);\r\n        let targetX: number, targetY: number, targetZ: number;\r\n        let focusNode: any = null;\r\n\r\n        debugLog('SynergyGalaxy', `Found node: ${node?.id} (${nodes.length} total)`);\r\n\r\n        if (node) {\r\n            // Zoom to this DOM node\r\n            targetX = -node.x;\r\n            targetY = -node.y;\r\n            targetZ = -node.z + 400; // Zoom in closer\r\n            focusNode = node;\r\n            debugLog('SynergyGalaxy', `Zooming to: ${targetX}, ${targetY}, ${targetZ}`);\r\n        } else {\r\n            // Check projected vault items first (visible stars)\r\n            let vaultItem = projectedVaultRef.current.find(v => v.instanceId === itemInstanceId);\r\n\r\n            // Fallback to full vault points if not in projected\r\n            if (!vaultItem) {\r\n                vaultItem = vaultPointsRef.current.find((v: any) => v.instanceId === itemInstanceId);\r\n            }\r\n\r\n            if (vaultItem) {\r\n                targetX = -vaultItem.x;\r\n                targetY = -vaultItem.y;\r\n                targetZ = -vaultItem.z + 400;\r\n\r\n                // Build a focused node from vault item\r\n                // Use the vaultItem.item property or search full inventory as backup\r\n                const item = (vaultItem as any).item || (vaultItem as any).originalItem;\r\n                if (!item) {\r\n                    warnLog('SynergyGalaxy', ' Vault item missing data:', vaultItem);\r\n                    return;\r\n                }\r\n                const itemInstance = vaultItem.instanceId ? itemInstances[vaultItem.instanceId] : undefined;\r\n                const itemDef = manifestService.getItem(item.itemHash);\r\n                const element = getElement(item.itemHash);\r\n                const isWeapon = itemDef?.itemType === 3;\r\n                const damageType = itemInstance?.damageType || itemDef?.defaultDamageType;\r\n                const damageTypeName = damageType ? DAMAGE_TYPE_NAMES[damageType] : undefined;\r\n\r\n                focusNode = {\r\n                    x: vaultItem.x,\r\n                    y: vaultItem.y,\r\n                    z: vaultItem.z,\r\n                    id: `vault-${vaultItem.instanceId || item.itemHash}`,\r\n                    type: isWeapon ? 'weapon' : 'armor',\r\n                    hash: item.itemHash,\r\n                    instanceId: vaultItem.instanceId,\r\n                    bucketHash: itemDef?.inventory?.bucketTypeHash || 0,\r\n                    element: element as any,\r\n                    isEquipped: false,\r\n                    isEmpty: false,\r\n                    lodLevel: 0,\r\n                    tierClass: getTierClass(item),\r\n                    power: itemInstance?.power,\r\n                    damageIconUrl: (isWeapon && damageTypeName) ? getBungieUrl(manifestService.getDamageTypeIcon(damageTypeName as any) || '') : undefined,\r\n                    watermarkUrl: itemDef ? getBungieUrl(itemDef.iconWatermarkFeatured || itemDef.iconWatermark) : undefined,\r\n                    isLegacyWatermark: itemDef ? (!itemDef.iconWatermarkFeatured && !!itemDef.iconWatermark) || isLegacyVersion(itemDef.quality?.currentVersion) : false,\r\n                    isMasterwork: !!(item.state && (item.state & 4)),\r\n                    isCrafted: !!(item.state && (item.state & 8)),\r\n                    isEnhanced: !!(item.state && (item.state & 8) && itemInstance?.gearTier && itemInstance.gearTier >= 2),\r\n                    tier: itemInstance?.gearTier,\r\n                    originalItem: item\r\n                };\r\n            } else {\r\n                // Item not found\r\n                return;\r\n            }\r\n        }\r\n\r\n        // Freeze parallax during zoom\r\n        targetParallax.current = { x: 0, y: 0 };\r\n\r\n        // Use helper for NaN-safe transition\r\n        startTransition(targetX, targetY, targetZ, 600);\r\n\r\n        // Keep synergy mode open and focus on the item\r\n        // The synergy tooltip will stay visible and attached to the item\r\n        if (focusNode) {\r\n            setFocusedNode(focusNode);\r\n            setIsLocked(true);\r\n            isLockedRef.current = true;\r\n        }\r\n    }, [nodes, itemInstances, getElement, startTransition]);\r\n\r\n    // Store the focused node data in a ref so it doesn't get lost when tooltip updates\r\n    const focusedNodeRef = useRef<any>(null);\r\n\r\n    // Sync focusedNodeRef whenever focusedNode changes\r\n    useEffect(() => {\r\n        focusedNodeRef.current = focusedNode;\r\n    }, [focusedNode]);\r\n\r\n    // Handle item transfer from vault/character to selected character\r\n    const handleTransferItem = useCallback(async (targetCharacterId: string) => {\r\n        debugLog('SynergyGalaxy', `Transfer item to: ${targetCharacterId}`);\r\n\r\n        // Use ref to get the node data (more reliable than state which may have changed)\r\n        const nodeToTransfer = focusedNodeRef.current;\r\n\r\n        if (!nodeToTransfer?.instanceId || !nodeToTransfer?.originalItem) {\r\n            errorLog('SynergyGalaxy', 'Missing focusedNode or item data', {\r\n                focusedNode,\r\n                focusedNodeRef: focusedNodeRef.current\r\n            });\r\n            return;\r\n        }\r\n\r\n        const item = nodeToTransfer.originalItem;\r\n        const itemInstanceId = nodeToTransfer.instanceId;\r\n        const itemHash = item.itemHash;\r\n\r\n        debugLog('SynergyGalaxy', 'Transfer request:', {\r\n            itemInstanceId,\r\n            itemHash,\r\n            targetCharacterId,\r\n            itemName: manifestService.getItem(itemHash)?.displayProperties?.name\r\n        });\r\n\r\n        try {\r\n            // Create a session for tracking the move\r\n            const session = createMoveSession([itemInstanceId], 3, targetCharacterId);\r\n\r\n            // Determine source and whether it's currently in vault or equipped\r\n            const isInVault = vaultInventory.some(v => v.itemInstanceId === itemInstanceId);\r\n            let currentCharId: string | undefined;\r\n\r\n            // Robust source detection for items on any character\r\n            for (const charId in characterInventories) {\r\n                if (characterInventories[charId].some(i => i.itemInstanceId === itemInstanceId)) {\r\n                    currentCharId = charId;\r\n                    break;\r\n                }\r\n            }\r\n            if (!currentCharId) {\r\n                for (const charId in characterEquipment) {\r\n                    if (characterEquipment[charId].some(i => i.itemInstanceId === itemInstanceId)) {\r\n                        currentCharId = charId;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            const isEquipped = currentCharId ? characterEquipment[currentCharId]?.some(e => e.itemInstanceId === itemInstanceId) : false;\r\n\r\n            if (!isInVault && !currentCharId) {\r\n                errorLog('SynergyGalaxy', 'Could not identify source character for transfer');\r\n                return;\r\n            }\r\n\r\n            // CRITICAL: Unequip item first before ANY transfer (Bungie API requirement)\r\n            // Equipped items CANNOT be transferred anywhere (not even to vault)\r\n            if (isEquipped && !isInVault) {\r\n                debugLog('SynergyGalaxy', `Item ${itemInstanceId} equipped, must unequip first`);\r\n                const unequipSuccess = await profileService.ensureItemUnequipped(currentCharId!, itemInstanceId);\r\n                if (!unequipSuccess) {\r\n                    errorLog('SynergyGalaxy', 'Failed to unequip: No replacement found');\r\n                    alert('Cannot transfer equipped item. Please equip a different weapon first, or move a replacement from vault to your character.');\r\n                    return;\r\n                }\r\n                // Refresh profile after unequipping to get latest state\r\n                debugLog('SynergyGalaxy', ' Item unequipped, refreshing profile');\r\n                await profileLoader.loadProfile(true);\r\n\r\n                // DIM-STYLE: Wait for Bungie servers to sync (eventually consistent)\r\n                // This prevents 1623 (ItemNotFound) errors when transferring immediately after equip\r\n                debugLog('SynergyGalaxy', ' Waiting for Bungie sync...');\r\n                await new Promise(resolve => setTimeout(resolve, 1000)); // 1 second delay\r\n            }\r\n\r\n            if (targetCharacterId === 'vault') {\r\n                // Transfer to vault - optimistic update happens inside smartTransfer\r\n                debugLog('SynergyGalaxy', ' Starting vault transfer...');\r\n\r\n                // Start the transfer (updateLocalStore happens synchronously inside)\r\n                const transferPromise = transferService.smartTransfer(itemInstanceId, itemHash, true, currentCharId!, session);\r\n\r\n                // Force TWO synchronous re-renders to ensure nodes regenerate\r\n                flushSync(() => {\r\n                    setRenderTrigger(prev => prev + 1);\r\n                });\r\n                flushSync(() => {\r\n                    setRenderTrigger(prev => prev + 2);\r\n                });\r\n\r\n                debugLog('SynergyGalaxy', 'Forced sync re-render, waiting for API');\r\n\r\n                // Wait for API to complete\r\n                const res = await transferPromise;\r\n                if (!res.success) {\r\n                    errorLog('SynergyGalaxy', 'Vault transfer failed:', res.error);\r\n                    // If it was a real failure (not ghost success), we stop here\r\n                    useProfileStore.getState().removeActiveTransfer(itemInstanceId, false, true);\r\n                    return;\r\n                }\r\n                debugLog('SynergyGalaxy', ' Vault transfer complete');\r\n            } else {\r\n                // Transfer to character\r\n                if (isInVault) {\r\n                    // Vault -> Character\r\n                    debugLog('SynergyGalaxy', ' Starting vaultcharacter transfer...');\r\n                    await transferService.smartTransfer(itemInstanceId, itemHash, false, targetCharacterId, session);\r\n                    debugLog('SynergyGalaxy', ' Vaultcharacter complete, sync re-render');\r\n                    flushSync(() => {\r\n                        setRenderTrigger(prev => prev + 1);\r\n                    });\r\n                } else {\r\n                    // Character -> Character (via vault)\r\n                    debugLog('SynergyGalaxy', ' Starting charchar transfer (via vault)...');\r\n\r\n                    // First to vault (SILENT to avoid double notification)\r\n                    const res1 = await transferService.smartTransfer(itemInstanceId, itemHash, true, currentCharId!, session, { silent: true });\r\n                    if (!res1.success) {\r\n                        errorLog('SynergyGalaxy', 'CharVault leg failed:', res1.error);\r\n                        useProfileStore.getState().removeActiveTransfer(itemInstanceId, false, true);\r\n                        return;\r\n                    }\r\n\r\n                    debugLog('SynergyGalaxy', ' First leg (vault) complete, sync re-render');\r\n                    flushSync(() => {\r\n                        setRenderTrigger(prev => prev + 1);\r\n                    });\r\n\r\n                    // Then to target character\r\n                    const res2 = await transferService.smartTransfer(itemInstanceId, itemHash, false, targetCharacterId, session);\r\n                    if (!res2.success) {\r\n                        errorLog('SynergyGalaxy', 'VaultChar leg failed:', res2.error);\r\n                        useProfileStore.getState().removeActiveTransfer(itemInstanceId, false, true);\r\n                        return;\r\n                    }\r\n                    debugLog('SynergyGalaxy', ' Second leg (character) complete, sync re-render');\r\n                    flushSync(() => {\r\n                        setRenderTrigger(prev => prev + 1);\r\n                    });\r\n                }\r\n            }\r\n\r\n            // User Request: Stabilize camera at orbit immediately after transfer confirmation\r\n            // Trigger home before slow profile reloads\r\n            handleResetView();\r\n\r\n            // Refresh profile to get latest state\r\n            debugLog('SynergyGalaxy', ' Transfer complete, refreshing profile');\r\n            await profileLoader.loadProfile(true);\r\n\r\n            // Trigger visual arrival effect (refresh success state for new node)\r\n            // Call removeActiveTransfer again with success=true to set the bit\r\n            useProfileStore.getState().removeActiveTransfer(itemInstanceId);\r\n\r\n            // Trigger Gold Transmat Effect\r\n            setEquippingItemIds(prev => {\r\n                const next = new Set(prev);\r\n                next.add(itemInstanceId);\r\n                return next;\r\n            });\r\n            setTimeout(() => {\r\n                setEquippingItemIds(prev => {\r\n                    const next = new Set(prev);\r\n                    next.delete(itemInstanceId);\r\n                    return next;\r\n                });\r\n            }, 2500);\r\n\r\n            // Final re-render to ensure everything is in sync\r\n            debugLog('SynergyGalaxy', 'Final galaxy re-render');\r\n            setRenderTrigger(prev => prev + 1);\r\n\r\n            // Reset view after successful transfer\r\n            debugLog('SynergyGalaxy', 'Resetting view');\r\n            handleResetView();\r\n\r\n            debugLog('SynergyGalaxy', ' Transfer sequence completed!');\r\n\r\n        } catch (error) {\r\n            errorLog('SynergyGalaxy', 'Transfer failed:', error);\r\n            // Visual feedback: clear loading and set failed state\r\n            useProfileStore.getState().removeActiveTransfer(itemInstanceId, false, true);\r\n            setRenderTrigger(prev => prev + 1);\r\n        }\r\n    }, [focusedNode, vaultInventory, selectedCharacterId, characterEquipment, handleResetView]);\r\n\r\n    const handleEquipItem = useCallback(async (targetCharacterId: string) => {\r\n        const nodeToEquip = focusedNodeRef.current;\r\n        if (!nodeToEquip?.instanceId || !nodeToEquip?.originalItem) return;\r\n\r\n        const itemInstanceId = nodeToEquip.instanceId;\r\n\r\n        // User Request: Stabilize camera at orbit immediately\r\n        handleResetView();\r\n\r\n        try {\r\n            // Determine current location\r\n            const isInVault = vaultInventory.some(v => v.itemInstanceId === itemInstanceId);\r\n            let sourceCharacterId: string | undefined;\r\n            for (const charId in characterInventories) {\r\n                if (characterInventories[charId].some(i => i.itemInstanceId === itemInstanceId)) {\r\n                    sourceCharacterId = charId;\r\n                    break;\r\n                }\r\n            }\r\n            if (!sourceCharacterId) {\r\n                for (const charId in characterEquipment) {\r\n                    if (characterEquipment[charId].some(i => i.itemInstanceId === itemInstanceId)) {\r\n                        sourceCharacterId = charId;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n\r\n\r\n            // 1 & 2. Unified Transfer & Equip (DIM Parity)\r\n            const sourceId = isInVault ? 'vault' : sourceCharacterId!;\r\n            const session = createMoveSession([itemInstanceId], 5, targetCharacterId);\r\n\r\n            debugLog('SynergyGalaxy', `Starting unified move/equip for ${itemInstanceId} from ${sourceId} to ${targetCharacterId}`);\r\n            // DIM Parity: Pass silent: true since Galaxy handles its own success animations\r\n            const equipSuccess = await transferService.moveItem(nodeToEquip.originalItem, sourceId, targetCharacterId, session, { equip: true, silent: true });\r\n            debugLog('SynergyGalaxy', 'Unified move result:', equipSuccess);\r\n\r\n            if (equipSuccess.success === false) {\r\n                // DIM Parity: Ghost success verification - check actual item state before treating as error\r\n                // This handles cases where Bungie API returns 500 but the operation actually succeeded\r\n                await profileLoader.loadProfile(true);\r\n                const latestState = useProfileStore.getState();\r\n                const targetEquipment = latestState.characterEquipment[targetCharacterId] || [];\r\n                const isActuallyEquipped = targetEquipment.some(eq => eq.itemInstanceId === itemInstanceId);\r\n\r\n                if (!isActuallyEquipped) {\r\n                    // Only throw if item is truly not equipped\r\n                    throw new Error(equipSuccess.error || \"Equip failed\");\r\n                }\r\n                // Ghost success detected - continue with success animation\r\n                debugLog('SynergyGalaxy', `Ghost success detected for equip of ${itemInstanceId}`);\r\n            }\r\n\r\n            // 3. Final cleanup and Success Animation\r\n            await profileLoader.loadProfile(true);\r\n            useProfileStore.getState().removeActiveTransfer(itemInstanceId);\r\n            useProfileStore.getState().removeActiveTransfer(itemInstanceId, true);\r\n\r\n            // Trigger Gold Transmat Effect\r\n            setEquippingItemIds(prev => {\r\n                const next = new Set(prev);\r\n                next.add(itemInstanceId);\r\n                return next;\r\n            });\r\n            setTimeout(() => {\r\n                setEquippingItemIds(prev => {\r\n                    const next = new Set(prev);\r\n                    next.delete(itemInstanceId);\r\n                    return next;\r\n                });\r\n            }, 2500);\r\n\r\n            // Trigger Global Centered Effect\r\n            useUIStore.getState().triggerGlobalTransmat('success');\r\n            setTimeout(() => useProfileStore.getState().clearSuccessfulTransfer(itemInstanceId), 2000);\r\n\r\n        } catch (error) {\r\n            errorLog('SynergyGalaxy', 'Equip failed:', error);\r\n            // Visual feedback: clear loading and set failed state\r\n            useProfileStore.getState().removeActiveTransfer(itemInstanceId, false, true);\r\n\r\n            setRenderTrigger(prev => prev + 1);\r\n        }\r\n    }, [vaultInventory, characterInventories, characterEquipment, handleResetView, startTransition]);\r\n\r\n    const handleNodeClick = useCallback((node: any) => {\r\n        // Disable left-click zoom when an item is already focused\r\n        // UNLESS it's the same node, handled below\r\n        if (focusedNode && focusedNode.instanceId !== node.instanceId && focusedNode.id !== node.id) {\r\n            return;\r\n        }\r\n\r\n        if (isSynergyMode) {\r\n            // If in synergy mode and clicking a node, only allow if it's part of the web\r\n            if (isNodeSynchronized(node)) {\r\n                // Treat as a wire lock to this specific instance\r\n                handleSynergyWireLock(node.instanceId || node.id);\r\n            }\r\n            return;\r\n        }\r\n\r\n        // Subclass nodes should ALWAYS navigate immediately, never zoom/focus like gear\r\n        if (node.type === 'subclass' || node.originalItem?.bucketHash === BUCKET_HASHES.SUBCLASS) {\r\n            const item = node.originalItem;\r\n            if (item) {\r\n                useUIStore.getState().setBuilderView('subclass', { hash: item.itemHash, itemInstanceId: item.itemInstanceId });\r\n                // Clean up view state when navigating away\r\n                setIsLocked(false);\r\n                isLockedRef.current = false;\r\n                setFocusedNode(null);\r\n                hideTooltip();\r\n                activeTooltipNodeId.current = null;\r\n                return;\r\n            }\r\n        }\r\n\r\n        // If clicking the ALREADY focused node, open transfer menu\r\n        const nodeInstanceId = node.instanceId || node.id;\r\n        if (isLocked && focusedNode && (focusedNode.instanceId === nodeInstanceId || focusedNode.id === nodeInstanceId)) {\r\n            // Re-show tooltip to ensure it's visible/positioned\r\n            if (node.originalItem) {\r\n                const { screenX, screenY, scale } = projectToScreen(node.x, node.y, node.z);\r\n                const fixedPosition = {\r\n                    x: screenX + (42 * scale) + 12,\r\n                    y: screenY\r\n                };\r\n                showTooltip(\r\n                    node.originalItem,\r\n                    node.instanceId ? itemInstances[node.instanceId] : undefined,\r\n                    undefined,\r\n                    true,\r\n                    handleTransferItem,\r\n                    handleEquipItem,\r\n                    true,\r\n                    fixedPosition,\r\n                    node.type === 'subclass'\r\n                );\r\n                // Trigger the menu to open\r\n                openTransferMenu();\r\n            }\r\n            return;\r\n        }\r\n\r\n        setIsLocked(true);\r\n        isLockedRef.current = true;\r\n        setFocusedNode(node);\r\n\r\n        // Immediate HUD snap: Call showTooltip explicitly to bypass redundancy check and set isHud: true\r\n        if (node.originalItem) {\r\n            // Calculate proximal position: Connected to right edge, centered vertically\r\n            const { screenX, screenY } = projectToScreen(node.x, node.y, node.z);\r\n            const fixedPosition = {\r\n                x: screenX,\r\n                y: screenY\r\n            };\r\n            showTooltip(node.originalItem, node.instanceId ? itemInstances[node.instanceId] : undefined, undefined, true, handleTransferItem, handleEquipItem, true, fixedPosition, node.type === 'subclass', () => { }, false);\r\n            activeTooltipNodeId.current = nodeInstanceId;\r\n        }\r\n\r\n        // We shift the targetX slightly to the LEFT of the node center (-node.x - gap)\r\n        // This pushes the item to the LEFT of the screen center to make room for the tooltip on the right\r\n        const balanceShift = 0; // Centered to place tooltip behind image\r\n        const targetX = -node.x - balanceShift;\r\n        const targetY = -node.y;\r\n        const targetZ = -node.z + 300; // Zoom in closer to the item\r\n\r\n        // Freeze parallax when locking to prevent shifting during interaction\r\n        targetParallax.current = { x: 0, y: 0 };\r\n        parallaxOffset.current = { x: 0, y: 0 };\r\n\r\n        // Use helper for NaN-safe transition\r\n        startTransition(targetX, targetY, targetZ, 800);\r\n    }, [isSynergyMode, hideTooltip, isLocked, focusedNode, openTransferMenu, itemInstances, handleTransferItem, showTooltip, startTransition]);\r\n\r\n    // Tooltip detection callback - finds which node is under the mouse\r\n    const updateTooltipDetection = useCallback((mx: number, my: number) => {\r\n        if (!containerRect.current) return;\r\n        if (isWireHoveringRef.current) return;\r\n\r\n        // Disable tooltips during synergy mode unless we are already locked on a specific item\r\n        // This prevents background stars and other items from showing tooltips during the synergy interaction\r\n        if (isSynergyMode && !isLocked) {\r\n            if (activeTooltipNodeId.current) {\r\n                hideTooltip();\r\n                activeTooltipNodeId.current = null;\r\n            }\r\n            return;\r\n        }\r\n\r\n        let closestNode: Element | null = null;\r\n        let foundNode: NodePosition | null = null;\r\n        let minScore = Infinity;\r\n        let foundVaultStar: any = null;\r\n\r\n        // 1. Native Hover Check\r\n        const hoveredElement = document.elementFromPoint(mx, my);\r\n        const hoveredNodeEl = hoveredElement?.closest('.galaxy-node') as HTMLElement;\r\n\r\n        // OCCLUSION CHECK: Skip galaxy hovers if mouse is over UI or Tooltips\r\n        const isOverUI = hoveredElement &&\r\n            hoveredElement !== containerRef.current &&\r\n            hoveredElement !== canvasRef.current &&\r\n            !hoveredNodeEl;\r\n\r\n        if (isOverUI) {\r\n            // Keep locked tooltips visible, but hide floating ones\r\n            if (activeTooltipNodeId.current && !isLocked) {\r\n                hideTooltip();\r\n                activeTooltipNodeId.current = null;\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (hoveredNodeEl) {\r\n            const nodeId = hoveredNodeEl.getAttribute('data-node-id');\r\n            const node = nodes.find(n => n.id === nodeId);\r\n            if (node) {\r\n                closestNode = hoveredNodeEl;\r\n                foundNode = node;\r\n                minScore = 0;\r\n            }\r\n        }\r\n\r\n        // 2. Fallback Hit Detection\r\n        if (!foundNode) {\r\n            const rect = containerRect.current;\r\n            const snap = projectionSnapshotRef.current;\r\n            if (rect) {\r\n                const relX = mx - rect.left - snap.centerX;\r\n                const relY = my - rect.top - snap.centerY;\r\n\r\n                const visibleNodes = nodes.filter(n => n.lodLevel < 2);\r\n\r\n                // Pre-compute projections and finalZ for all nodes\r\n                const nodesWithProjection = visibleNodes.map(node => {\r\n                    const projection = projectToScreen(node.x, node.y, node.z);\r\n                    return { node, projection };\r\n                }).filter(({ projection }) => {\r\n                    const farClip = performanceMode === 'low' ? -2500 : performanceMode === 'medium' ? -10000 : -25000;\r\n                    return projection.finalZ <= 990 && projection.finalZ >= farClip;\r\n                });\r\n\r\n                // Sort by finalZ (CLOSEST FIRST) - items closer to camera have higher finalZ\r\n                const sortedNodes = nodesWithProjection.sort((a, b) => b.projection.finalZ - a.projection.finalZ);\r\n\r\n                sortedNodes.forEach(({ node, projection }) => {\r\n                    const el = nodeRefs.current.get(node.id);\r\n                    if (!el) return;\r\n                    if (el.style.display === 'none' || el.style.opacity === '0') return;\r\n\r\n                    const { stageX, stageY, scale, finalZ } = projection;\r\n\r\n                    const distance = Math.sqrt(Math.pow(relX - stageX, 2) + Math.pow(relY - stageY, 2));\r\n                    const actualIconSize = 84;\r\n                    const projectedSize = actualIconSize * scale;\r\n\r\n                    let hitRadius = projectedSize * 0.55;\r\n                    if (activeTooltipNodeId.current === node.id) {\r\n                        hitRadius *= 1.3;\r\n                    }\r\n                    hitRadius = Math.max(30, Math.min(120, hitRadius));\r\n\r\n                    if (distance < hitRadius) {\r\n                        const score = (distance / hitRadius) - (finalZ / 500);\r\n                        if (score < minScore) {\r\n                            minScore = score;\r\n                            closestNode = el;\r\n                            foundNode = node;\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        }\r\n\r\n        // 3. Vault Star Detection\r\n        if (!foundNode && isVaultSearchVisibleRef.current && containerRect.current) {\r\n            const rect = containerRect.current;\r\n            const relX = mx - rect.left;\r\n            const relY = my - rect.top;\r\n\r\n            let minVaultDist = Infinity;\r\n            projectedVaultRef.current.forEach(v => {\r\n                const dist = Math.sqrt(Math.pow(v.px - relX, 2) + Math.pow(v.py - relY, 2));\r\n                const hitRadius = Math.max(25, v.size + 15);\r\n\r\n                if (dist < hitRadius && dist < minVaultDist) {\r\n                    minVaultDist = dist;\r\n                    foundVaultStar = v;\r\n                }\r\n            });\r\n        }\r\n\r\n        if (closestNode && (foundNode as NodePosition)) {\r\n            const node = foundNode as NodePosition;\r\n            const item = node.originalItem;\r\n            const instanceId = node.instanceId;\r\n\r\n            if (isSynergyMode) {\r\n                // In synergy mode, only track hover for wire targeting, don't show tooltips\r\n                const targetId = closestNode ? (foundNode as NodePosition).instanceId || (foundNode as NodePosition).id : null;\r\n                if (targetId !== hoveredSynergyNodeId) {\r\n                    setHoveredSynergyNodeId(targetId);\r\n                }\r\n                // Hide any existing tooltip when in synergy mode\r\n                if (activeTooltipNodeId.current) {\r\n                    hideTooltip();\r\n                    activeTooltipNodeId.current = null;\r\n                }\r\n                return;\r\n            }\r\n\r\n            // Clear any pending hide timer\r\n            if (tooltipHideTimerRef.current) {\r\n                clearTimeout(tooltipHideTimerRef.current);\r\n                tooltipHideTimerRef.current = null;\r\n            }\r\n\r\n            // FLUIDITY: If we moved to a new node, cancel pending show timer for previous node\r\n            if (activeTooltipNodeId.current !== node.id) {\r\n                if (tooltipShowTimerRef.current && lastTooltipStateRef.current.id !== node.id) {\r\n                    clearTimeout(tooltipShowTimerRef.current);\r\n                    tooltipShowTimerRef.current = null;\r\n                }\r\n            }\r\n\r\n            if (isLocked && focusedNode) {\r\n                const isFocusedDisplay = (closestNode as HTMLElement).classList.contains('galaxy-focused-display');\r\n                const isFocusedNode = instanceId === focusedNode.instanceId;\r\n                if (!isFocusedDisplay && !isFocusedNode) {\r\n                    return;\r\n                }\r\n            }\r\n\r\n            if (item) {\r\n                const tooltipId = node.id;\r\n                const { screenX, screenY, scale } = projectToScreen(node.x, node.y, node.z);\r\n\r\n                // SAFETY: Skip tooltip update if projection returned NaN (camera corruption)\r\n                if (isNaN(screenX) || isNaN(screenY) || isNaN(scale)) {\r\n                    return;\r\n                }\r\n\r\n                const targetX = Math.round(screenX);\r\n                const targetY = Math.round(screenY);\r\n\r\n                const posChanged = Math.abs(targetX - lastTooltipStateRef.current.x) > 1 || Math.abs(targetY - lastTooltipStateRef.current.y) > 1;\r\n                const nodeChanged = activeTooltipNodeId.current !== tooltipId;\r\n\r\n                if (nodeChanged || (isLocked && posChanged)) {\r\n                    // FLUIDITY: Delay showing the tooltip for new nodes\r\n                    if (nodeChanged && !isLocked) { // Only delay if not locked (locked is responsive)\r\n                        if (tooltipShowTimerRef.current) {\r\n                            clearTimeout(tooltipShowTimerRef.current);\r\n                        }\r\n\r\n                        // Instant for equipped subclass, fast for other subclasses (50ms), normal delay for other items (150ms)\r\n                        const delay = (node.type === 'subclass' && node.isEquipped) ? 0 : (node.type === 'subclass' ? 50 : 150);\r\n                        tooltipShowTimerRef.current = setTimeout(() => {\r\n                            const element = getElement(item.itemHash);\r\n                            const fixedPosition = isLocked ? { x: targetX, y: targetY } : undefined;\r\n                            showTooltip(item, instanceId ? itemInstances[instanceId] : undefined, element as any, isLocked, handleTransferItem, handleEquipItem, isLocked, fixedPosition, node.type === 'subclass', () => { }, false);\r\n                            activeTooltipNodeId.current = tooltipId;\r\n                            lastTooltipStateRef.current = { id: tooltipId, x: targetX, y: targetY };\r\n                            tooltipShowTimerRef.current = null;\r\n                        }, delay);\r\n                    } else {\r\n                        // Immediate update for locked nodes or position changes (dragging locked item)\r\n                        const element = getElement(item.itemHash);\r\n                        const fixedPosition = isLocked ? { x: targetX, y: targetY } : undefined;\r\n                        showTooltip(item, instanceId ? itemInstances[instanceId] : undefined, element as any, isLocked, handleTransferItem, handleEquipItem, isLocked, fixedPosition, node.type === 'subclass', () => { }, false);\r\n                        // Only update refs if we are actually showing\r\n                        if (!tooltipShowTimerRef.current) {\r\n                            activeTooltipNodeId.current = tooltipId;\r\n                            lastTooltipStateRef.current = { id: tooltipId, x: targetX, y: targetY };\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        } else if (foundVaultStar) {\r\n            const star = foundVaultStar;\r\n            const item = star.item;\r\n            const instanceId = star.instanceId;\r\n\r\n            if (isSynergyMode) return;\r\n\r\n            if (item) {\r\n                const tooltipId = instanceId || `star-${item.itemHash}`;\r\n                const { screenX, screenY, scale } = projectToScreen(star.x, star.y, star.z);\r\n\r\n                // SAFETY: Skip tooltip update if projection returned NaN (camera corruption)\r\n                if (isNaN(screenX) || isNaN(screenY) || isNaN(scale)) {\r\n                    return;\r\n                }\r\n\r\n                const targetX = Math.round(screenX);\r\n                const targetY = Math.round(screenY);\r\n\r\n                const posChanged = Math.abs(targetX - lastTooltipStateRef.current.x) > 1 || Math.abs(targetY - lastTooltipStateRef.current.y) > 1;\r\n                const nodeChanged = activeTooltipNodeId.current !== tooltipId;\r\n\r\n                if (nodeChanged || (isLocked && posChanged)) {\r\n                    const element = getElement(item.itemHash);\r\n                    const fixedPosition = isLocked ? { x: targetX, y: targetY } : undefined;\r\n                    showTooltip(item, (instanceId && itemInstances[instanceId]) ? itemInstances[instanceId] : undefined, element as any, isLocked, handleTransferItem, handleEquipItem, isLocked, fixedPosition, star.type === 'subclass', () => { }, false);\r\n                    activeTooltipNodeId.current = tooltipId;\r\n                    lastTooltipStateRef.current = { id: tooltipId, x: targetX, y: targetY };\r\n                }\r\n            }\r\n        } else if (isLocked && focusedNode) {\r\n            // NO NODE HOVERED - but we're locked on a focused node\r\n            // SAFETY: Don't show tooltip in synergy mode even when locked\r\n            if (isSynergyMode) {\r\n                if (activeTooltipNodeId.current) {\r\n                    hideTooltip();\r\n                    activeTooltipNodeId.current = null;\r\n                }\r\n                return;\r\n            }\r\n\r\n            const item = focusedNode.originalItem;\r\n            if (item) {\r\n                const tooltipId = focusedNode.instanceId || focusedNode.id;\r\n                const { screenX, screenY, scale } = projectToScreen(focusedNode.x, focusedNode.y, focusedNode.z);\r\n\r\n                // SAFETY: Skip tooltip update if projection returned NaN (camera corruption)\r\n                if (isNaN(screenX) || isNaN(screenY) || isNaN(scale)) {\r\n                    return;\r\n                }\r\n\r\n                const targetX = Math.round(screenX + (42 * scale) + 12);\r\n                const targetY = Math.round(screenY);\r\n\r\n                const posChanged = Math.abs(targetX - lastTooltipStateRef.current.x) > 1 || Math.abs(targetY - lastTooltipStateRef.current.y) > 1;\r\n                const nodeChanged = activeTooltipNodeId.current !== tooltipId;\r\n\r\n                if (nodeChanged || posChanged) {\r\n                    const fixedPosition = { x: targetX, y: targetY };\r\n                    showTooltip(item, focusedNode.instanceId ? itemInstances[focusedNode.instanceId] : undefined, undefined, true, handleTransferItem, handleEquipItem, true, fixedPosition, false, () => { }, false);\r\n                    activeTooltipNodeId.current = tooltipId as string;\r\n                    lastTooltipStateRef.current = { id: tooltipId as string, x: targetX, y: targetY };\r\n                }\r\n            }\r\n        } else if (activeTooltipNodeId.current) {\r\n            // FLUIDITY: Cancel pending show if we leave before it triggers\r\n            if (tooltipShowTimerRef.current) {\r\n                clearTimeout(tooltipShowTimerRef.current);\r\n                tooltipShowTimerRef.current = null;\r\n            }\r\n\r\n            // HYSTERESIS: Don't hide immediately\r\n            if (!tooltipHideTimerRef.current) {\r\n                tooltipHideTimerRef.current = setTimeout(() => {\r\n                    hideTooltip();\r\n                    activeTooltipNodeId.current = null;\r\n                    lastTooltipStateRef.current = { id: null, x: -1, y: -1 };\r\n                    tooltipHideTimerRef.current = null;\r\n                }, 150);\r\n            }\r\n        }\r\n    }, [isLocked, focusedNode, showTooltip, hideTooltip, itemInstances, getElement, isSynergyMode, nodes, handleTransferItem, projectToScreen, hoveredSynergyNodeId, performanceMode]);\r\n\r\n    // Cleanup timer on unmount\r\n    useEffect(() => {\r\n        return () => {\r\n            if (tooltipHideTimerRef.current) {\r\n                clearTimeout(tooltipHideTimerRef.current);\r\n            }\r\n        };\r\n    }, []);\r\n\r\n    // Sync updateTooltipDetectionRef with state for use in the animation loop\r\n    useEffect(() => {\r\n        updateTooltipDetectionRef.current = updateTooltipDetection;\r\n    }, [updateTooltipDetection]);\r\n\r\n    // Update the ref so the render loop can always call the latest version\r\n    useEffect(() => {\r\n        updateTooltipDetectionRef.current = updateTooltipDetection;\r\n    }, [updateTooltipDetection]);\r\n\r\n    const handleMove = useCallback((e: MouseEvent) => {\r\n        const mx = e.clientX;\r\n        const my = e.clientY;\r\n\r\n        if (!containerRect.current) return;\r\n\r\n        // SELF-CORRECTION: Check if mouse is actually inside bounds to fix sticky false state\r\n        if (mx >= containerRect.current.left && mx <= containerRect.current.right &&\r\n            my >= containerRect.current.top && my <= containerRect.current.bottom) {\r\n            if (!isMouseInBounds.current) isMouseInBounds.current = true;\r\n        }\r\n\r\n        // Update tooltip detection immediately on move\r\n        // BUT prevent showing new tooltips if we are currently moving fast (isMovingRef)\r\n        // This ensures user must STOP to hover\r\n        if (!isMovingRef.current) {\r\n            updateTooltipDetection(mx, my);\r\n        }\r\n\r\n        // Camera Move Logic - DISABLE when locked OR during zoom transition OR when dragging is disabled\r\n        if (isDragging.current && !isLockedRef.current && !transitionRef.current?.active && !isDraggingDisabled.current) {\r\n            // Safety: If last pos was reset (-1), don't jump, just sync\r\n            if (lastMousePos.current.x !== -1 && lastMousePos.current.y !== -1) {\r\n                const dx = mx - lastMousePos.current.x;\r\n                const dy = my - lastMousePos.current.y;\r\n                targetOffset.current.x += dx;\r\n                targetOffset.current.y += dy;\r\n            }\r\n        }\r\n\r\n        // Middle-click rotation - apply tilt based on mouse movement\r\n        if (isMiddleButtonDown.current && !isLockedRef.current && !transitionRef.current?.active) {\r\n            if (lastMousePos.current.x !== -1 && lastMousePos.current.y !== -1) {\r\n                const dx = mx - lastMousePos.current.x;\r\n                const dy = my - lastMousePos.current.y;\r\n                // Scale rotation sensitivity (lower = slower rotation)\r\n                const rotationSensitivity = 0.3;\r\n                targetTilt.current.y += dx * rotationSensitivity;\r\n                targetTilt.current.x += dy * rotationSensitivity;\r\n                // No clamp - allow full 360 rotation\r\n            }\r\n        }\r\n        lastMousePos.current = { x: mx, y: my };\r\n    }, [updateTooltipDetection]);\r\n\r\n    const handleClick = useCallback((e: MouseEvent) => {\r\n        // Drag protection: If user moved more than 5px, it's a drag, not a click\r\n        const dist = Math.sqrt(Math.pow(e.clientX - dragStartPos.current.x, 2) + Math.pow(e.clientY - dragStartPos.current.y, 2));\r\n        if (dist > 5) return;\r\n\r\n        // DOM PRIORITY: If we clicked a DOM node that's NOT the container, bail.\r\n        // The individual nodes have their own onClick handlers.\r\n        const targetEl = e.target as HTMLElement;\r\n        const hoveredNodeEl = targetEl.closest('.galaxy-node');\r\n        if (hoveredNodeEl) {\r\n            return;\r\n        }\r\n\r\n        // OCCLUSION CHECK: Don't click through the search box or other UI\r\n        const isOverUI = targetEl &&\r\n            targetEl !== containerRef.current &&\r\n            targetEl !== canvasRef.current &&\r\n            !hoveredNodeEl;\r\n\r\n        if (isOverUI) {\r\n            return;\r\n        }\r\n\r\n        if (containerRect.current && isVaultSearchVisible) {\r\n            const rx = e.clientX - containerRect.current.left;\r\n            const ry = e.clientY - containerRect.current.top;\r\n\r\n            const target = projectedVaultRef.current.find(v => {\r\n                const dist = Math.sqrt(Math.pow(v.px - rx, 2) + Math.pow(v.py - ry, 2));\r\n                return dist < Math.max(25, v.size + 15);\r\n            });\r\n\r\n            if (target) {\r\n                const item = target.item;\r\n                const itemInstance = target.instanceId ? itemInstances[target.instanceId] : undefined;\r\n                const itemDef = manifestService.getItem(item.itemHash);\r\n                const element = getElement(item.itemHash);\r\n                const isWeapon = itemDef?.itemType === 3;\r\n                const damageType = itemInstance?.damageType || itemDef?.defaultDamageType;\r\n                const damageTypeName = damageType ? DAMAGE_TYPE_NAMES[damageType] : undefined;\r\n\r\n                // Build a full NodePosition object so the focused view has all data it needs (like .hash for icon)\r\n                const node: any = {\r\n                    x: target.x,\r\n                    y: target.y,\r\n                    z: target.z,\r\n                    id: `vault-${target.instanceId || item.itemHash}`,\r\n                    type: isWeapon ? 'weapon' : 'armor',\r\n                    hash: item.itemHash,\r\n                    instanceId: target.instanceId,\r\n                    bucketHash: itemDef?.inventory?.bucketTypeHash || 0,\r\n                    element: element as any,\r\n                    isEquipped: false,\r\n                    isEmpty: false,\r\n                    lodLevel: 0,\r\n                    tierClass: getTierClass(item),\r\n                    power: itemInstance?.power,\r\n                    damageIconUrl: (isWeapon && damageTypeName) ? getBungieUrl(manifestService.getDamageTypeIcon(damageTypeName as any) || '') : undefined,\r\n                    watermarkUrl: itemDef ? getBungieUrl(itemDef.iconWatermarkFeatured || itemDef.iconWatermark) : undefined,\r\n                    isLegacyWatermark: itemDef ? (!itemDef.iconWatermarkFeatured && !!itemDef.iconWatermark) || isLegacyVersion(itemDef.quality?.currentVersion) : false,\r\n                    isMasterwork: !!(item.state && (item.state & 4)),\r\n                    isCrafted: !!(item.state && (item.state & 8)),\r\n                    isEnhanced: !!(item.state && (item.state & 8) && itemInstance?.gearTier && itemInstance.gearTier >= 2),\r\n                    tier: itemInstance?.gearTier,\r\n\r\n                    originalItem: item,\r\n                    iconUrl: getBungieUrl(manifestService.getItem(item.overrideStyleItemHash || item.itemHash)?.displayProperties?.icon || '')\r\n                };\r\n\r\n                handleNodeClick(node);\r\n            }\r\n        }\r\n    }, [handleNodeClick, getElement, isVaultSearchVisible, handleResetView, itemInstances]);\r\n\r\n    const handleKeyDown = useCallback((e: KeyboardEvent) => {\r\n        if (e.key === 'Escape') {\r\n            // PRIORITY: Close Synergy Menu if open (Blackout mode exit)\r\n            if (isSynergyMenuOpen) {\r\n                setIsSynergyMenuOpen(false);\r\n                // Also reset view to ensure we don't return to a weird locked state\r\n                handleResetView();\r\n                return;\r\n            }\r\n\r\n            handleResetView();\r\n            onResetView?.();\r\n            return;\r\n        }\r\n\r\n        // DISABLE keyboard camera movement when locked\r\n        if (isLockedRef.current) return;\r\n\r\n        keysPressed.current.add(e.key.toLowerCase());\r\n    }, [handleResetView, onResetView, isSynergyMenuOpen]);\r\n\r\n    // Expose handleResetView to parent via ref\r\n    useEffect(() => {\r\n        if (resetViewRef) {\r\n            resetViewRef.current = handleResetView;\r\n        }\r\n    }, [resetViewRef, handleResetView]);\r\n\r\n    const handleKeyUp = useCallback((e: KeyboardEvent) => {\r\n        // DISABLE keyboard camera movement when locked\r\n        if (isLockedRef.current) return;\r\n\r\n        keysPressed.current.delete(e.key.toLowerCase());\r\n    }, []);\r\n\r\n    const handleDown = useCallback((e: MouseEvent) => {\r\n        if (isSynergyMenuOpen) return; // Disable drag when menu is open\r\n\r\n        // Re-enable dragging and parallax on first mouse down after being disabled\r\n        if (isDraggingDisabled.current) {\r\n            isDraggingDisabled.current = false;\r\n        }\r\n        if (isParallaxDisabled.current) {\r\n            isParallaxDisabled.current = false;\r\n        }\r\n\r\n        // Middle button (wheel click) for rotation\r\n        if (e.button === 1) {\r\n            e.preventDefault(); // Prevent default middle-click behavior (auto-scroll)\r\n            isMiddleButtonDown.current = true;\r\n            return;\r\n        }\r\n\r\n        // Left button (0) for panning - only left click should enable pan\r\n        if (e.button === 0) {\r\n            isDragging.current = true;\r\n            dragStartPos.current = { x: e.clientX, y: e.clientY };\r\n        }\r\n    }, [isSynergyMenuOpen]);\r\n\r\n    const handleUp = useCallback((e?: MouseEvent) => {\r\n        // Reset middle button state\r\n        if (e?.button === 1) {\r\n            isMiddleButtonDown.current = false;\r\n            return;\r\n        }\r\n        isDragging.current = false;\r\n        isMiddleButtonDown.current = false; // Also reset on any mouse up for safety\r\n    }, []);\r\n\r\n    const handleWheel = useCallback((e: React.WheelEvent) => {\r\n        // Don't call preventDefault - causes issues with passive listeners\r\n        // DISABLE zoom when locked, during zoom transition, OR when Synergy Menu is open\r\n        if (isLocked || transitionRef.current?.active || isSynergyMenuOpen) return;\r\n\r\n        // Zoom in/out by adjusting Z offset\r\n        // Faster zoom while synchronized - adjusted for smoother feel\r\n        const zoomSpeed = isSynergyMode ? 300 : 150;\r\n        const delta = e.deltaY > 0 ? -zoomSpeed : zoomSpeed;\r\n\r\n        // CAMERA BOUNDS: Prevent zooming too far out\r\n        // REMOVED FORWARD CAP: Truly infinite forward scroll (Fly-through handled by projectToScreen culling)\r\n        const minZ = -2000000; // Deep space limit\r\n\r\n        targetOffset.current.z = Math.max(minZ, targetOffset.current.z + delta);\r\n\r\n        // NO CAP on maxZ - fly as far forward as you want.\r\n    }, [isLocked, isSynergyMode, isSynergyMenuOpen]);\r\n\r\n    // Get the screen position of an item (used by SynergyWeb)\r\n    // Matches SynergyWeb's expected signature: (itemName, location, characterId?, nodeId?)\r\n    const getItemPosition = useCallback((\r\n        itemName: string,\r\n        _location: 'equipped' | 'inventory' | 'vault',\r\n        _characterId?: string,\r\n        nodeId?: string\r\n    ): { x: number; y: number; scale: number; opacity: number; nodeId?: string } | null => {\r\n        if (!containerRect.current) return null;\r\n\r\n        const { centerX, centerY } = projectionSnapshotRef.current;\r\n\r\n        // Find node by nodeId first (most reliable)\r\n        let foundNode: NodePosition | undefined;\r\n\r\n        if (nodeId) {\r\n            foundNode = nodes.find(n => n.id === nodeId || n.instanceId === nodeId);\r\n        }\r\n\r\n        // If not found by nodeId, search by itemName\r\n        if (!foundNode && itemName) {\r\n            const searchName = itemName.toLowerCase();\r\n\r\n            // Special handling for subclass searches like \"solar subclass\", \"arc subclass\"\r\n            // SynergyWeb searches with format \"${element} subclass\"\r\n            const subclassMatch = searchName.match(/^(arc|solar|void|stasis|strand|prismatic)\\s+subclass$/);\r\n            if (subclassMatch) {\r\n                const targetElement = subclassMatch[1];\r\n                // Find the EQUIPPED subclass that matches this element\r\n                foundNode = nodes.find(n => {\r\n                    if (n.type !== 'subclass' || !n.isEquipped) return false;\r\n                    return n.element.toLowerCase() === targetElement;\r\n                });\r\n            }\r\n\r\n            // If still not found, try regular name matching\r\n            if (!foundNode) {\r\n                foundNode = nodes.find(n => {\r\n                    if (!n.hash) return false;\r\n                    const itemDef = manifestService.getItem(n.hash);\r\n                    const name = itemDef?.displayProperties?.name?.toLowerCase() || '';\r\n                    // Match if names contain each other\r\n                    return name.includes(searchName) || searchName.includes(name);\r\n                });\r\n            }\r\n        }\r\n\r\n        if (foundNode) {\r\n            // SYNERGY HUD: If this is the synergy source node, it's anchored to screen center\r\n            const isSourceNode = isSynergyMode && foundNode.id === synergySourceNodeId;\r\n            if (isSourceNode) {\r\n                // Return screen center position for HUD-anchored source\r\n                return {\r\n                    x: centerX,\r\n                    y: centerY,\r\n                    scale: 1.5,\r\n                    opacity: 1,\r\n                    nodeId: foundNode.id\r\n                };\r\n            }\r\n\r\n            const { screenX, screenY, scale, finalZ, isVisible } = projectToScreen(foundNode.x, foundNode.y, foundNode.z);\r\n\r\n            // Hide if clipped by near plane\r\n            if (!isVisible) return null;\r\n\r\n            // Calculate opacity based on depth\r\n            let opacity = 1;\r\n\r\n            // PASS-BY FADE: Fade out rapidly as items pass the camera plane\r\n            if (finalZ > 850) {\r\n                opacity *= Math.max(0, 1 - (finalZ - 850) / 145);\r\n            }\r\n\r\n            // DEEP VOID FADE: In Random mode, items can be very far. \r\n            // Hide them initially and fade them in as we get closer (-15000 to -5000)\r\n            if (finalZ < -5000) {\r\n                opacity *= Math.max(0, 1 - (Math.abs(finalZ) - 5000) / 10000);\r\n            }\r\n\r\n            return {\r\n                x: screenX,\r\n                y: screenY,\r\n                scale,\r\n                opacity,\r\n                nodeId: foundNode.id\r\n            };\r\n        }\r\n\r\n        // Check vault points (canvas-based stars) by name or instanceId\r\n        let foundVaultPt: typeof vaultPointsRef.current[0] | undefined;\r\n\r\n        if (nodeId) {\r\n            foundVaultPt = vaultPointsRef.current.find(v => v.instanceId === nodeId);\r\n        }\r\n\r\n        if (!foundVaultPt && itemName) {\r\n            const searchName = itemName.toLowerCase();\r\n            foundVaultPt = vaultPointsRef.current.find(v => {\r\n                if (!v.originalItem?.itemHash) return false;\r\n                const itemDef = manifestService.getItem(v.originalItem.itemHash);\r\n                const name = itemDef?.displayProperties?.name?.toLowerCase() || '';\r\n                return name.includes(searchName) || searchName.includes(name);\r\n            });\r\n        }\r\n\r\n        if (foundVaultPt) {\r\n            const { screenX, screenY, scale, finalZ, isVisible } = projectToScreen(foundVaultPt.x, foundVaultPt.y, foundVaultPt.z);\r\n\r\n            // Hide if clipped by near plane\r\n            if (!isVisible) return null;\r\n\r\n            // Calculate opacity based on depth\r\n            let opacity = 1;\r\n\r\n            if (finalZ > 850) {\r\n                opacity *= Math.max(0, 1 - (finalZ - 850) / 145);\r\n            }\r\n\r\n            if (finalZ < -5000) {\r\n                opacity *= Math.max(0, 1 - (Math.abs(finalZ) - 5000) / 10000);\r\n            }\r\n\r\n            return {\r\n                x: screenX,\r\n                y: screenY,\r\n                scale,\r\n                opacity,\r\n                nodeId: foundVaultPt.instanceId\r\n            };\r\n        }\r\n\r\n        return null;\r\n    }, [nodes, isSynergyMode, synergySourceNodeId, synchronizedNodeIds, projectToScreen]);\r\n\r\n    // Handle right-click to trigger synergy web\r\n    const handleTriggerSynergy = useCallback(async (node: NodePosition, e: React.MouseEvent) => {\r\n        e.preventDefault();\r\n        e.stopPropagation();\r\n\r\n        // Disable synergize when an item is focused (zoomed in)\r\n        if (focusedNode) return;\r\n\r\n        if (!node.originalItem) return;\r\n\r\n        // Disable synergize for non-exotic items (allow subclasses)\r\n        if (node.type !== 'subclass' && node.tierClass !== 'exotic') return;\r\n\r\n        // Ensure tooltips are cleared when starting synergy view\r\n        hideTooltip();\r\n        activeTooltipNodeId.current = null;\r\n\r\n        // Get the item definition\r\n        const item = node.originalItem;\r\n        const itemDef = manifestService.getItem(item.itemHash);\r\n        if (!itemDef) return;\r\n\r\n        // Get guardian class from current character\r\n        const { characters, selectedCharacterId: charId } = useProfileStore.getState();\r\n        const currentChar = characters.find(c => c.characterId === charId);\r\n        const guardianClass = currentChar?.classType ?? GuardianClass.Titan;\r\n\r\n        // Set as synergy source - calculate screen position for the node\r\n        setSynergySourceNodeId(node.id);\r\n        setIsSynergyMode(true);\r\n        setIsSynergyExiting(false);\r\n\r\n        // Pan camera to the clicked node with smooth transition (same as left-click)\r\n        const targetX = -node.x;\r\n        const targetY = -node.y;\r\n        const targetZ = -node.z + 300; // Zoom in closer to the item\r\n\r\n        // Use helper for NaN-safe transition\r\n        startTransition(targetX, targetY, targetZ, 800);\r\n\r\n        // Calculate and set the source position for the synergy web\r\n        if (containerRect.current) {\r\n            const { screenX, screenY, scale } = projectToScreen(node.x, node.y, node.z);\r\n            setSynergySourcePos({ x: screenX, y: screenY, scale });\r\n        }\r\n\r\n        // For subclass, find synergies by element\r\n        if (node.type === 'subclass') {\r\n            const element = node.element;\r\n            const elementName = element.toLowerCase();\r\n\r\n            // Update element for UI immediately\r\n            safeNotifyElementChange(element);\r\n\r\n            // Find synergies for this element (search by element name)\r\n            try {\r\n                const synergies = await findSynergies(\r\n                    'subclass',\r\n                    elementName,\r\n                    guardianClass,\r\n                    { maxResults: maxSynergies, seed: randomVaultSeed }\r\n                );\r\n                setSynergyConnections(Array.isArray(synergies) ? synergies : []);\r\n            } catch (err) {\r\n                errorLog('SynergyGalaxy', 'Failed to find synergies for subclass:', err);\r\n                setSynergyConnections([]);\r\n            }\r\n            return;\r\n        }\r\n\r\n        // Determine if armor or weapon\r\n        const isWeapon = node.type === 'weapon';\r\n        const isArmor = node.type === 'armor';\r\n        if (!isWeapon && !isArmor) return;\r\n\r\n        // Get item name\r\n        const itemName = itemDef.displayProperties?.name || '';\r\n        if (!itemName) return;\r\n\r\n        // Find synergies for this item\r\n        try {\r\n            const synergies = await findSynergies(\r\n                isWeapon ? 'weapon' : 'armor',\r\n                itemName,\r\n                guardianClass,\r\n                { maxResults: maxSynergies, seed: randomVaultSeed }\r\n            );\r\n            setSynergyConnections(Array.isArray(synergies) ? synergies : []);\r\n\r\n            // Update element for UI\r\n            const element = getElement(item.itemHash);\r\n            safeNotifyElementChange(element);\r\n        } catch (err) {\r\n            errorLog('SynergyGalaxy', 'Failed to find synergies:', err);\r\n            setSynergyConnections([]);\r\n        }\r\n    }, [getElement, safeNotifyElementChange, maxSynergies, randomVaultSeed, projectToScreen, startTransition]);\r\n\r\n    // Handle Synergy Equip (Trigger Animation + Close Overlay + Execute Service)\r\n    const handleEquipSynergy = useCallback(async (synergy: any) => {\r\n        // 1. Close Override/Web Overlay immediately for clean visual\r\n        setIsSynergyMode(false); // Retract web, return to orbit or focus\r\n        setSynergyConnections([]); // Clear connections to trigger exit animation on Web if handled there\r\n        // Actually, better to keep mode true but let the overlay close - logic depends on if we want to stay in \"Synergy Mode\"\r\n        // User requested: \"Hide the equip screen to focus on the item being transported.\"\r\n        // So we just close the overlay but keep the galaxy view active. The SynergyWeb itself might close or stay.\r\n        // Let's close the overlay first via the callback passed to SynergyWeb (handled there),\r\n        // but here we handle the actual equip logic.\r\n\r\n        // User Request: Stabilize camera at orbit immediately\r\n        handleResetView();\r\n\r\n        debugLog('SynergyGalaxy', 'Equipping items for synergy:', synergy);\r\n\r\n        // 2. Identify Item Instance IDs for Animation\r\n        const targets = new Set<string>();\r\n\r\n        // Resolve Instance IDs from names (similar to how SynergyWeb wires do it)\r\n        const findNodeByName = (name: string, type: 'armor' | 'weapon') =>\r\n            nodes.find(n => n.type === type && n.originalItem?.displayProperties?.name === name);\r\n\r\n        const armor = findNodeByName(synergy.armor, 'armor');\r\n        const weapon = findNodeByName(synergy.weapon, 'weapon');\r\n\r\n        if (armor?.instanceId) targets.add(armor.instanceId);\r\n        if (weapon?.instanceId) targets.add(weapon.instanceId);\r\n\r\n        // Also add subclass if applicable? Usually subclass equip is instant or requires orbit, but we can animate it.\r\n        const subclass = nodes.find(n => n.type === 'subclass' && n.element?.toLowerCase() === synergy.subclassType?.toLowerCase());\r\n        if (subclass?.instanceId) targets.add(subclass.instanceId);\r\n\r\n        // 3. Trigger \"Equipping\" Animation (Gold Flash)\r\n        // MOVED: Trigger this AFTER the equip completes so it plays at the destination\r\n        /* \r\n        if (targets.size > 0) {\r\n            setEquippingItemIds(prev => {\r\n                const next = new Set(prev);\r\n                targets.forEach(t => next.add(t));\r\n                return next;\r\n            });\r\n     \r\n            // Auto-clear animation after 2.5s (animation duration + buffer)\r\n            setTimeout(() => {\r\n                setEquippingItemIds(prev => {\r\n                    const next = new Set(prev);\r\n                    targets.forEach(t => next.delete(t));\r\n                    return next;\r\n                });\r\n            }, 2500);\r\n        }\r\n        */\r\n\r\n        // 4. Delegate to TransferService for actual equip\r\n        // We need to construct a \"BuildTemplate\" or similar payload.\r\n        // For now, let's just use a simple robust equip if we have instances.\r\n        if (armor?.instanceId && weapon?.instanceId) {\r\n            const characterId = selectedCharacterId || '';\r\n\r\n            // Construct a proper BuildTemplate for the transfer service\r\n            // This ensures exotics are identified correctly for conflict resolution\r\n            const buildTemplate: any = {\r\n                id: `synergy-${Date.now()}`,\r\n                name: synergy.buildName,\r\n                element: synergy.element.toLowerCase(),\r\n                guardianClass: synergy.classType,\r\n                // Vital: Provide names/hashes because transferService uses them for exotic conflict logic\r\n                exoticWeapon: {\r\n                    name: synergy.weapon,\r\n                    hash: weapon?.originalItem?.itemHash || 0,\r\n                    slot: 1 // Kinetic/Energy slot assumption - service will resolve\r\n                },\r\n                exoticArmor: {\r\n                    name: synergy.armor,\r\n                    hash: armor?.originalItem?.itemHash || 0,\r\n                    slot: 0 // Helmet/Gauntlets assumption - service will resolve\r\n                },\r\n                items: [], // We rely on resolving instances below for specific items\r\n                armorMods: [],\r\n                subclassConfig: {\r\n                    // Start with basic hash if known\r\n                    subclassHash: subclass?.originalItem?.itemHash || 0\r\n                    // We could populate abilities here if we had them resolved to hashes\r\n                    // For now, equipping the subclass item itself is the MVP\r\n                }\r\n            };\r\n\r\n            // Use the specific instances we found to guarantee we equip the exact items shown in the graph\r\n            // We pass them as the 'exotic' instances found\r\n            if (weapon.instanceId) {\r\n                // Pre-resolve the item for the service\r\n                // Note: TransferService.equipBuild ultimately calls findItemByHashOrName.\r\n                // It doesn't take direct instanceIDs in the template unless we hack the service or format.\r\n                // However, we CAN just use equipBuild with the names (which we have) and let it work,\r\n                // OR we can rely on our resolution here.\r\n\r\n                // Better Strategy:\r\n                // Use `equipBuild` which handles the logic of \"unequip conflicting exotic -> equip new exotic\".\r\n                // We MUST provide the correctly shaped template.\r\n            }\r\n\r\n            try {\r\n                // Optimistic UI updates are handled by store subscriptions to TransferService\r\n                debugLog('SynergyGalaxy', 'Calling equipBuild with template:', buildTemplate);\r\n\r\n                // Use profile service to equip\r\n                // Note: transferService.equipBuild handles the logic\r\n                const { success, error } = await transferService.equipBuild(buildTemplate, characterId, undefined, false, { silent: false });\r\n\r\n                if (!success) {\r\n                    errorLog('SynergyGalaxy', 'Equip failed:', error);\r\n                } else {\r\n                    debugLog('SynergyGalaxy', 'Equip success!');\r\n                    // Trigger Global Centered Effect\r\n                    useUIStore.getState().triggerGlobalTransmat('success');\r\n\r\n                    // Close the menu\r\n                    setIsSynergyMenuOpen(false);\r\n                    setHoveredSynergyWire(null); // Clear hover state\r\n                }\r\n            } catch (err) {\r\n                errorLog('SynergyGalaxy', 'Equip failed:', err);\r\n            }\r\n        }\r\n    }, [nodes, selectedCharacterId, handleResetView]);\r\n\r\n    // Memoize the wire hover change callback to prevent hook violations in render\r\n    const handleWireHoverChange = useCallback((hovered: boolean) => {\r\n        if (isWireHoveringRef.current === hovered) return;\r\n        isWireHoveringRef.current = hovered;\r\n        if (hovered) {\r\n            hideTooltip();\r\n            activeTooltipNodeId.current = null;\r\n        }\r\n    }, [hideTooltip]);\r\n\r\n    // Track which wire is being hovered to dim non-synergy nodes\r\n    const handleWireHover = useCallback((wire: { armorInstanceId: string | null; weaponInstanceId: string | null } | null) => {\r\n        setHoveredSynergyWire(wire);\r\n    }, []);\r\n\r\n    const updateRect = useCallback(() => {\r\n        if (containerRef.current && canvasRef.current) {\r\n            const rect = containerRef.current.getBoundingClientRect();\r\n            containerRect.current = rect;\r\n\r\n            const canvas = canvasRef.current;\r\n            const dpr = window.devicePixelRatio || 1;\r\n            canvas.width = rect.width * dpr;\r\n            canvas.height = rect.height * dpr;\r\n            canvasSize.current = { width: rect.width, height: rect.height };\r\n\r\n            const ctx = canvas.getContext('2d');\r\n            if (ctx) ctx.scale(dpr, dpr);\r\n        }\r\n    }, []);\r\n\r\n    // UPDATE RECT ON DATA CHANGE: Ensure canvas dimensions are valid after data loads\r\n    // Previously this was clearing the rect causing a freeze until resize\r\n    useEffect(() => {\r\n        updateRect();\r\n    }, [characterEquipment, characterInventories, vaultInventory, responseMintedTimestamp, updateRect]);\r\n\r\n    useEffect(() => {\r\n        // Master Render Loop (The Heartbeat)\r\n        tickRef.current = (now: number) => {\r\n            // 0.5. Keyboard Movement (WASD) - Disabled while typing, locked, OR during zoom transition\r\n            // DISABLE keyboard movement when locked to allow tooltip interaction\r\n            if (!isLockedRef.current && !transitionRef.current?.active) {\r\n                const moveSpeed = isSynergyModeRef.current ? 45 : 25;\r\n                const activeEl = document.activeElement;\r\n                const isTyping = activeEl && (\r\n                    activeEl.tagName === 'INPUT' ||\r\n                    activeEl.tagName === 'TEXTAREA' ||\r\n                    (activeEl as HTMLElement).isContentEditable\r\n                );\r\n\r\n                // Disable keyboard movement if typing OR if Synergy Menu is open OR if in Synergy Mode\r\n                if (!isTyping && !isSynergyMenuOpen && !isSynergyModeRef.current) {\r\n                    if (keysPressed.current.has('w')) targetOffset.current.z += moveSpeed;\r\n                    if (keysPressed.current.has('s')) targetOffset.current.z -= moveSpeed;\r\n                    if (keysPressed.current.has('a')) targetOffset.current.x += moveSpeed;\r\n                    if (keysPressed.current.has('d')) targetOffset.current.x -= moveSpeed;\r\n                    // Vertical movement via keyboard (Up/Down)\r\n                    if (keysPressed.current.has('q')) targetOffset.current.y += moveSpeed;\r\n                    if (keysPressed.current.has('e')) targetOffset.current.y -= moveSpeed;\r\n                }\r\n            }\r\n\r\n            // 1. IMMERSIVE MODE: Drift + Parallax for \"flying through space\" feel\r\n            if (immersiveMode && !isLockedRef.current && !transitionRef.current?.active && !isSynergyModeRef.current) {\r\n                // Slow sinusoidal drift - like gently floating through space\r\n                const driftSpeed = 0.0003; // Very slow oscillation\r\n                const driftAmplitude = 0.15; // Subtle movement per frame\r\n                driftPhase.current += driftSpeed * (now - (lastFpsUpdateTime.current || now));\r\n\r\n                // Multi-frequency drift for organic feel\r\n                const driftX = Math.sin(driftPhase.current) * driftAmplitude +\r\n                    Math.sin(driftPhase.current * 0.7) * driftAmplitude * 0.5;\r\n                const driftY = Math.cos(driftPhase.current * 0.8) * driftAmplitude * 0.7 +\r\n                    Math.cos(driftPhase.current * 0.5) * driftAmplitude * 0.3;\r\n\r\n                // Apply drift to offset\r\n                driftOffset.current.x += driftX;\r\n                driftOffset.current.y += driftY;\r\n                targetOffset.current.x += driftX;\r\n                targetOffset.current.y += driftY;\r\n\r\n                // Subtle parallax tilt based on mouse position (gentle camera rotation)\r\n                if (containerRect.current && lastMousePos.current.x !== -1) {\r\n                    const centerX = containerRect.current.left + containerRect.current.width / 2;\r\n                    const centerY = containerRect.current.top + containerRect.current.height / 2;\r\n                    const normalizedX = (lastMousePos.current.x - centerX) / (containerRect.current.width / 2);\r\n                    const normalizedY = (lastMousePos.current.y - centerY) / (containerRect.current.height / 2);\r\n\r\n                    // Apply subtle parallax tilt (adds to manual rotation, doesn't override)\r\n                    const parallaxStrength = 3; // Degrees of max parallax tilt\r\n                    const parallaxTiltX = normalizedY * parallaxStrength;\r\n                    const parallaxTiltY = -normalizedX * parallaxStrength;\r\n\r\n                    // Smooth lerp toward parallax target\r\n                    targetTilt.current.x += (parallaxTiltX - targetTilt.current.x) * 0.02;\r\n                    targetTilt.current.y += (parallaxTiltY - targetTilt.current.y) * 0.02;\r\n                }\r\n            }\r\n\r\n            // 1.5. Tilts controlled manually via middle-click rotation\r\n            // (Removed auto-lerp behavior that reset tilt to zero)\r\n\r\n            // 1.5. Mouse Following (Parallax feel) & EDGE PANNING\r\n            // Disable parallax in synergy mode to allow free camera movement\r\n            // Also disable when in orbit view with parallax disabled\r\n            if (containerRect.current && !isLockedRef.current && !isSynergyModeRef.current && !isParallaxDisabled.current) {\r\n                const centerX = containerRect.current.left + containerRect.current.width / 2;\r\n                const centerY = containerRect.current.top + containerRect.current.height / 2;\r\n\r\n                // Additive Parallax (Peeking)\r\n                // We no longer set targetOffset directly; instead, we set targetParallax.\r\n                targetParallax.current.x = -(lastMousePos.current.x - centerX) * 1.5;\r\n                targetParallax.current.y = -(lastMousePos.current.y - centerY) * 1.5;\r\n\r\n                // EDGE PANNING: Unlimited movement when reaching screen edges\r\n                // Only active if mouse is actually inside the window/component bounds\r\n                if (isMouseInBounds.current) {\r\n                    const edgeThreshold = 150; // Pixels from edge to start panning (wider zone)\r\n                    const maxPanSpeed = 45; // Max pixels per frame (more aggressive)\r\n                    const { left, top, width, height } = containerRect.current;\r\n                    const mx = lastMousePos.current.x;\r\n                    const my = lastMousePos.current.y;\r\n\r\n                    // Calculate distance from edges\r\n                    const distLeft = mx - left;\r\n                    const distRight = (left + width) - mx;\r\n                    const distTop = my - top;\r\n                    const distBottom = (top + height) - my;\r\n\r\n                    // Use quadratic curve for more aggressive acceleration near edges\r\n                    const getIntensity = (dist: number) => {\r\n                        const normalized = 1 - (Math.max(0, dist) / edgeThreshold);\r\n                        return normalized * normalized; // Quadratic for aggressive ramp-up\r\n                    };\r\n\r\n                    // Pan LEFT (Move items RIGHT)\r\n                    if (distLeft < edgeThreshold && distLeft > -50) {\r\n                        targetOffset.current.x += maxPanSpeed * getIntensity(distLeft);\r\n                    }\r\n                    // Pan RIGHT (Move items LEFT)\r\n                    if (distRight < edgeThreshold && distRight > -50) {\r\n                        targetOffset.current.x -= maxPanSpeed * getIntensity(distRight);\r\n                    }\r\n                    // Pan UP (Move items DOWN)\r\n                    if (distTop < edgeThreshold && distTop > -50) {\r\n                        targetOffset.current.y += maxPanSpeed * getIntensity(distTop);\r\n                    }\r\n                    // Pan DOWN (Move items UP)\r\n                    if (distBottom < edgeThreshold && distBottom > -50) {\r\n                        targetOffset.current.y -= maxPanSpeed * getIntensity(distBottom);\r\n                    }\r\n                }\r\n            } else if (isLockedRef.current || isSynergyModeRef.current || isParallaxDisabled.current) {\r\n                // Keep parallax zeroed while locked, in synergy mode, or when parallax is disabled\r\n                targetParallax.current = { x: 0, y: 0 };\r\n                parallaxOffset.current = { x: 0, y: 0 }; // Also zero actual offset immediately\r\n            }\r\n\r\n            // Smooth parallax transition\r\n            // NOTE: Removed auto-lerp to desiredTilt (0, 0) to preserve manual middle-click rotation\r\n            // targetTilt is now only modified by user input (middle-click drag) or reset view\r\n\r\n            // 2. Handle Travel Transitions\r\n            if (transitionRef.current?.active) {\r\n                const { startTime, duration, start, target } = transitionRef.current;\r\n\r\n                // SAFETY: Validate transition data to prevent NaN camera position\r\n                const isValidTransition = (\r\n                    typeof startTime === 'number' && !isNaN(startTime) &&\r\n                    typeof duration === 'number' && !isNaN(duration) && duration > 0 &&\r\n                    start && typeof start.x === 'number' && !isNaN(start.x) &&\r\n                    target && typeof target.x === 'number' && !isNaN(target.x)\r\n                );\r\n\r\n                if (!isValidTransition) {\r\n                    // Invalid transition state - abort and reset\r\n                    warnLog('SynergyGalaxy', ' Invalid transition state, resetting:', transitionRef.current);\r\n                    transitionRef.current.active = false;\r\n                    // Keep current offset as-is (don't corrupt with NaN)\r\n                } else {\r\n                    const elapsed = now - startTime;\r\n                    const progress = Math.min(elapsed / duration, 1);\r\n                    const ease = 1 - Math.pow(1 - progress, 3); // Ease out cubic\r\n\r\n                    offset.current = {\r\n                        x: start.x + (target.x - start.x) * ease,\r\n                        y: start.y + (target.y - start.y) * ease,\r\n                        z: start.z + (target.z - start.z) * ease\r\n                    };\r\n\r\n                    if (progress >= 1) {\r\n                        // SNAP to final position for immediate camera control\r\n                        offset.current = { ...target };\r\n                        targetOffset.current = { ...target };\r\n                        transitionRef.current.active = false;\r\n                    }\r\n                }\r\n            } else {\r\n                // 3. Handle Regular Smooth Movement (Zoom + Pan) - ALWAYS RUN\r\n                // This ensures that if targetOffset changes programmatically (e.g., Reset View)\r\n                // the camera follows, even if isLocked is technically true for a frame.\r\n                // Input locking is handled upstream by preventing targetOffset updates.\r\n\r\n                // Increase lerp factor slightly for more responsive edge panning\r\n                const lerpFactor = 0.12;\r\n\r\n                // SAFETY: Check for NaN before LERP to prevent camera corruption\r\n                const newX = offset.current.x + (targetOffset.current.x - offset.current.x) * lerpFactor;\r\n                const newY = offset.current.y + (targetOffset.current.y - offset.current.y) * lerpFactor;\r\n                const newZ = offset.current.z + (targetOffset.current.z - offset.current.z) * lerpFactor;\r\n\r\n                if (!isNaN(newX) && !isNaN(newY) && !isNaN(newZ)) {\r\n                    offset.current.x = newX;\r\n                    offset.current.y = newY;\r\n                    offset.current.z = newZ;\r\n                } else {\r\n                    // NaN detected - reset to default orbit position\r\n                    warnLog('SynergyGalaxy', ' NaN in camera position, resetting:', {\r\n                        offset: offset.current,\r\n                        targetOffset: targetOffset.current\r\n                    });\r\n                    offset.current = { x: 0, y: 0, z: -200 };\r\n                    targetOffset.current = { x: 0, y: 0, z: -200 };\r\n                }\r\n\r\n                // VELOCITY CHECK: Detect if camera is moving\r\n                const dx = Math.abs(offset.current.x - targetOffset.current.x);\r\n                const dy = Math.abs(offset.current.y - targetOffset.current.y);\r\n                const dz = Math.abs(offset.current.z - targetOffset.current.z);\r\n                const velocity = dx + dy + dz;\r\n\r\n                // Threshold determining if \"moving\" (0.5 pixel combined delta)\r\n                // If moving, we hide tooltips to prevent flutter\r\n                const isMoving = velocity > 0.5;\r\n\r\n                if (isMoving !== isMovingRef.current) {\r\n                    isMovingRef.current = isMoving;\r\n                    if (isMoving) {\r\n                        // Immediately hide tooltips when movement starts\r\n                        hideTooltip();\r\n                        activeTooltipNodeId.current = null;\r\n                    }\r\n                }\r\n\r\n                // 3.5 Handle Parallax Smoothing\r\n                parallaxOffset.current.x += (targetParallax.current.x - parallaxOffset.current.x) * 0.1;\r\n                parallaxOffset.current.y += (targetParallax.current.y - parallaxOffset.current.y) * 0.1;\r\n            }\r\n\r\n            // 4. Update the Stage\r\n            updateTransform(targetTilt.current.x, targetTilt.current.y, now);\r\n\r\n            // 5. Global UI Visibility Tracking (Hide when leaving orbit)\r\n            const dx = offset.current.x;\r\n            const dy = offset.current.y;\r\n            // dz removed as it was unused (originally for spherical distance check)\r\n\r\n            // \"Safe Zone\": If mouse is in the notification/header area (top 150px), NEVER hide the UI\r\n            // This allows interaction with nav/settings even if camera is far away\r\n            let isMouseInHeader = false;\r\n            if (containerRect.current && lastMousePos.current.y >= 0) {\r\n                // Check if mouse Y is within top 150px (approx header height + buffer)\r\n                // Relative to container top\r\n                const mouseY = lastMousePos.current.y - containerRect.current.top;\r\n                if (mouseY < 150 && mouseY > -50) {\r\n                    isMouseInHeader = true;\r\n                }\r\n            }\r\n\r\n            // Metric: Hide UI if significantly zoomed in (Z > -50) or panned very far away (> 500)\r\n            // Relaxed from previous strict \"50 unit sphere\" to generic depth/pan checks\r\n            const isZoomedIn = offset.current.z > -50; // Orbit is -200, so -50 is 75% zoomed in\r\n            const isFarPan = Math.abs(dx) > 500 || Math.abs(dy) > 500;\r\n\r\n            // Only hide if NOT in header AND (zoomed in OR panned far)\r\n            const shouldHide = !isMouseInHeader && (isZoomedIn || isFarPan);\r\n\r\n            if (shouldHide !== hideGlobalUIRef.current) {\r\n                setHideGlobalUI(shouldHide);\r\n            }\r\n\r\n            // 5. LOD & Viewport Culling + Search Filtering\r\n            nodes.forEach(node => {\r\n                const el = nodeRefs.current.get(node.id);\r\n                if (!el) return;\r\n\r\n                const isFocused = focusedNodeRef.current && (\r\n                    focusedNodeRef.current.id === node.id ||\r\n                    (focusedNodeRef.current.instanceId && node.instanceId && focusedNodeRef.current.instanceId === node.instanceId)\r\n                );\r\n\r\n                // DEPTH-AWARE CULLING: Use world-space Z for distance checks\r\n                let effectiveZ = node.z + offset.current.z;\r\n                const isEquipped = node.isEquipped || node.type === 'subclass';\r\n                const isSync = isNodeSynchronized(node);\r\n\r\n                // Check if node matches search and filters (USE PRE-CALCULATED SET)\r\n                const matchesSearch = filteredNodeIdsRef.current.has(node.id);\r\n\r\n                // Check if node matches view mode filter\r\n                let matchesViewMode = true;\r\n                if (viewModeRef.current === 'subclass-only') {\r\n                    matchesViewMode = node.type === 'subclass';\r\n                } else if (viewModeRef.current === 'inventory-only') {\r\n                    // Show only weapons and armor (hide subclasses)\r\n                    matchesViewMode = node.type === 'weapon' || node.type === 'armor';\r\n                }\r\n\r\n                const shouldShow = (matchesSearch && matchesViewMode) || isSync || isFocused;\r\n\r\n                // Distance Check: Hide inventory items if they are too far\r\n                // Expanded range to allow scrolling deep into the vault (-50000)\r\n                const farClip = performanceMode === 'low' ? -2500 : performanceMode === 'medium' ? -15000 : -40000;\r\n                const isCloseEnough = isSync || isEquipped || (effectiveZ > farClip && effectiveZ < 1000);\r\n\r\n                if (!isCloseEnough) {\r\n                    el.style.display = 'none';\r\n                    // CRITICAL: Hide tooltip only if THIS node is showing it\r\n                    // When display:none is set, onMouseLeave never fires\r\n                    if (activeTooltipNodeId.current === node.id) {\r\n                        hideTooltip();\r\n                        activeTooltipNodeId.current = null;\r\n                    }\r\n                    return;\r\n                }\r\n\r\n                // Apply filtering (search + view mode)\r\n                if (!shouldShow) {\r\n                    el.style.display = 'none';\r\n                    el.style.opacity = '0';\r\n                    el.style.pointerEvents = 'none';\r\n                    // Remove masterwork class when hidden\r\n                    el.classList.remove('galaxy-node--masterwork');\r\n                    el.classList.add('galaxy-node--dimmed');\r\n                    if (activeTooltipNodeId.current === node.id) {\r\n                        hideTooltip();\r\n                        activeTooltipNodeId.current = null;\r\n                    }\r\n                } else {\r\n                    // Ensure visibility classes are correct when shown\r\n                    el.classList.remove('galaxy-node--dimmed');\r\n                    if (node.isMasterwork) el.classList.add('galaxy-node--masterwork');\r\n\r\n                    if (isFocused) {\r\n                        el.classList.add('galaxy-node--focused');\r\n                        el.style.filter = 'none'; // Clear any CSS filters that might dim\r\n                    }\r\n\r\n                    // Frustum Check: Hide if significantly off-screen\r\n                    const { stageX, stageY, scale, finalZ, isVisible: isNodeVisible } = projectToScreen(node.x, node.y, node.z);\r\n\r\n                    // Relax near-plane culling for focused items so they don't \"black out\" when close\r\n                    const isVisible = isNodeVisible || (isFocused && finalZ < 998);\r\n\r\n                    // SYNERGY HUD: Only anchor the SOURCE subclass to screen center\r\n                    // All other synergy items remain in 3D space for dynamic wire tracking\r\n                    // Hide the source subclass HUD when a wire endpoint is locked OR hovered (Smart Focus)\r\n                    if (isSync && isSynergyModeRef.current) {\r\n                        const isSourceSubclass = node.id === synergySourceNodeIdRef.current;\r\n\r\n                        if (isSourceSubclass) {\r\n                            // SMART FOCUS: Push source subclass to background when locked or hovering\r\n                            const isInteracting = isLockedRef.current || hoveredSynergyWireRef.current;\r\n\r\n                            // Source subclass anchors to screen center as HUD element\r\n                            el.style.transform = `translate3d(0px, 0px, 0px) scale(1.5)`;\r\n                            el.style.display = 'block';\r\n\r\n                            if (isInteracting) {\r\n                                // Push behind everything and dim significantly\r\n                                // USE EXTREMELY LOW Z-INDEX to ensure it's behind even far-away items (which have negative z-indices)\r\n                                el.style.zIndex = '-99999';\r\n                                el.style.opacity = '0.1';\r\n                                el.style.pointerEvents = 'none'; // Click-through when in background\r\n                            } else {\r\n                                // Standard HUD mode\r\n                                el.style.zIndex = '20000'; // Above everything (standard nodes are around 10000)\r\n                                el.style.opacity = '1';\r\n                                el.style.pointerEvents = 'auto';\r\n                            }\r\n                            return; // Bypass regular 3D update\r\n                        }\r\n                    }\r\n\r\n                    // DEPTH FADING: Smoothly fade out as items get too close or too far\r\n                    let opacity = 1;\r\n\r\n                    // BYPASS FADING FOR FOCUSED ITEMS: Ensure they are always at full brightness\r\n                    if (!isFocused) {\r\n                        // Fade out as it approaches the perspective plane (1000)\r\n                        if (finalZ > 850) {\r\n                            opacity *= Math.max(0, 1 - (finalZ - 850) / 145);\r\n                        }\r\n\r\n                        // Fade out as it recedes into distance\r\n                        if (finalZ < -5000) {\r\n                            // Adjust fade start based on clip plane (Clip: L-2500, M-15000, H-40000)\r\n                            const fadeStart = performanceMode === 'low' ? 1500 : performanceMode === 'medium' ? 10000 : 30000;\r\n                            const fadeRange = performanceMode === 'low' ? 1000 : performanceMode === 'medium' ? 5000 : 10000;\r\n                            opacity *= Math.max(0, 1 - (Math.abs(finalZ) - fadeStart) / fadeRange);\r\n                        }\r\n                    } else {\r\n                        opacity = 1; // Force full opacity for focused items\r\n                    }\r\n\r\n                    // ISOLATION LOGIC: In Synergy Mode, dim/hide nodes based on active wire\r\n                    const isIsolating = isIsolatingDebouncedRef.current;\r\n\r\n                    if (isIsolating) {\r\n                        const activeWire = hoveredSynergyWireRef.current;\r\n                        const isPartOfActiveSynergy = activeWire && (node.instanceId === activeWire.armorInstanceId || node.instanceId === activeWire.weaponInstanceId);\r\n\r\n                        if (isFocused || isPartOfActiveSynergy) {\r\n                            opacity = 1;\r\n                        } else {\r\n                            // STRICT HIDE for ALL non-relevant nodes to prevent visual noise\r\n                            // This replaces the previous \"dimming\" logic for generic nodes\r\n                            opacity = 0;\r\n                            el.style.display = 'none';\r\n                            return;\r\n                        }\r\n                    }\r\n\r\n                    // Show the element \r\n                    el.style.display = 'block';\r\n                    el.style.opacity = opacity.toString();\r\n                    el.style.pointerEvents = opacity > 0.05 ? 'auto' : 'none';\r\n\r\n                    // UNIVERSAL MANIFOLD: Apply manual projection to DOM nodes\r\n                    // Use scale for depth and 2D translate for stage position\r\n                    // We use stageX/stageY because .synergy-galaxy-stage is centered at 50%/50%\r\n                    el.style.transform = `translate3d(${stageX}px, ${stageY}px, 0px) scale(${scale})`;\r\n\r\n                    // Z-INDEX: Focused items must be above EVERYTHING (vignette, stars, other nodes)\r\n                    // Standard nodes are ~10000. HUD is 20000. We match HUD level for focused items.\r\n                    el.style.zIndex = isFocused ? '20000' : Math.round(finalZ + 10000).toString();\r\n\r\n                    if (opacity < 0.05) {\r\n                        el.style.display = 'none';\r\n                        if (activeTooltipNodeId.current === node.id) {\r\n                            hideTooltip();\r\n                            activeTooltipNodeId.current = null;\r\n                        }\r\n                        return;\r\n                    }\r\n\r\n                    if (containerRect.current) {\r\n                        const margin = 300; // Increased margin for stability\r\n                        const halfW = containerRect.current.width / 2 + margin;\r\n                        const halfH = containerRect.current.height / 2 + margin;\r\n\r\n                        if (Math.abs(stageX) > halfW || Math.abs(stageY) > halfH || !isVisible) {\r\n                            el.style.display = 'none';\r\n                            // CRITICAL: Hide tooltip only if THIS node is showing it\r\n                            if (activeTooltipNodeId.current === node.id) {\r\n                                hideTooltip();\r\n                                activeTooltipNodeId.current = null;\r\n                            }\r\n                        } else {\r\n                            el.style.display = 'block';\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n\r\n            // 6. Real-time Tooltip Update (Responsive during camera move)\r\n            // If locked, update every frame to \"glue\" the tooltip to the moving node\r\n            // IMPORTANT: Use updateTooltipDetectionRef to bypass stale state closure in tickRef\r\n            if (isLockedRef.current && focusedNodeRef.current) {\r\n                updateTooltipDetectionRef.current(-1, -1);\r\n            } else if (!isDragging.current && isMouseInBounds.current && lastMousePos.current.x !== -1) {\r\n                // FIXED: Only update detection if mouse is actually INSIDE the bounds\r\n                updateTooltipDetectionRef.current(lastMousePos.current.x, lastMousePos.current.y);\r\n            } else if (!isLockedRef.current && !isMouseInBounds.current && activeTooltipNodeId.current) {\r\n                // FIXED: If mouse left bounds and not locked, ensure tooltip is hidden\r\n                hideTooltip();\r\n                activeTooltipNodeId.current = null;\r\n            }\r\n\r\n            // 7. FPS Logic\r\n            frameCount.current++;\r\n            if (now - lastFpsUpdateTime.current > 1000) {\r\n                setFps(Math.round((frameCount.current * 1000) / (now - lastFpsUpdateTime.current)));\r\n                lastFpsUpdateTime.current = now;\r\n                frameCount.current = 0;\r\n            }\r\n\r\n\r\n        };\r\n    }, [nodes, updateTransform, updateRect, synchronizedNodeIds, hideTooltip, projectToScreen, setHideGlobalUI]);\r\n    // Event Listener Refs (Ref Proxy Pattern to avoid stale closures)\r\n    const handleKeyDownRef = useRef(handleKeyDown);\r\n    const handleKeyUpRef = useRef(handleKeyUp);\r\n    const handleClickRef = useRef(handleClick);\r\n    const handleDownRef = useRef(handleDown);\r\n    const handleUpRef = useRef(handleUp);\r\n    const handleMoveRef = useRef(handleMove);\r\n\r\n    // Sync refs with latest handlers\r\n    useEffect(() => {\r\n        handleKeyDownRef.current = handleKeyDown;\r\n        handleKeyUpRef.current = handleKeyUp;\r\n        handleClickRef.current = handleClick;\r\n        handleDownRef.current = handleDown;\r\n        handleUpRef.current = handleUp;\r\n        handleMoveRef.current = handleMove;\r\n\r\n        // Also sync updateTooltipDetection here to be safe\r\n        updateTooltipDetectionRef.current = updateTooltipDetection;\r\n    }, [handleKeyDown, handleKeyUp, handleClick, handleDown, handleUp, handleMove, updateTooltipDetection]);\r\n\r\n    useEffect(() => {\r\n        const renderLoop = (now: number) => {\r\n            tickRef.current?.(now);\r\n            rafId.current = requestAnimationFrame(renderLoop);\r\n        };\r\n\r\n        updateRect();\r\n        rafId.current = requestAnimationFrame(renderLoop);\r\n\r\n        // Proxied Event Handlers\r\n        const onDown = (e: MouseEvent) => handleDownRef.current(e);\r\n        const onUp = (e: MouseEvent) => handleUpRef.current(e); // Pass event for middle-click detection\r\n        const onMove = (e: MouseEvent) => handleMoveRef.current(e);\r\n        const onClick = (e: MouseEvent) => handleClickRef.current(e);\r\n        const onKeyDown = (e: KeyboardEvent) => handleKeyDownRef.current(e);\r\n        const onKeyUp = (e: KeyboardEvent) => handleKeyUpRef.current(e);\r\n        const onResize = () => updateRect(); // updateRect is stable via useCallback with minimal deps\r\n\r\n        window.addEventListener('mousedown', onDown);\r\n        window.addEventListener('mouseup', onUp);\r\n        window.addEventListener('mousemove', onMove, { passive: true });\r\n        window.addEventListener('click', onClick);\r\n        window.addEventListener('keydown', onKeyDown);\r\n        window.addEventListener('keyup', onKeyUp);\r\n        window.addEventListener('resize', onResize);\r\n\r\n        return () => {\r\n            if (rafId.current) cancelAnimationFrame(rafId.current);\r\n            window.removeEventListener('mousedown', onDown);\r\n            window.removeEventListener('mouseup', onUp);\r\n            window.removeEventListener('mousemove', onMove);\r\n            window.removeEventListener('click', onClick);\r\n            window.removeEventListener('keydown', onKeyDown);\r\n            window.removeEventListener('keyup', onKeyUp);\r\n            window.removeEventListener('resize', onResize);\r\n        };\r\n    }, []); // Only on mount! Logic updates happen via refs.\r\n\r\n    // Safety: Handle window blur to prevent stuck keys/mouse\r\n    // Isolation State Debouncing & Global UI Dimming\r\n    useEffect(() => {\r\n        const active = hoveredSynergyWire || isLocked || focusedNode;\r\n        let timer: any;\r\n\r\n        if (active) {\r\n            setIsIsolatingDebounced(true);\r\n            document.documentElement.classList.add('global-ui-isolate');\r\n        } else {\r\n            // Short delay before removing isolation to prevent flicker during transitions\r\n            timer = setTimeout(() => {\r\n                setIsIsolatingDebounced(false);\r\n                document.documentElement.classList.remove('global-ui-isolate');\r\n            }, 150);\r\n        }\r\n\r\n        return () => {\r\n            if (timer) clearTimeout(timer);\r\n        };\r\n    }, [hoveredSynergyWire, isLocked, focusedNode]);\r\n\r\n    const handleWindowBlur = useCallback(() => {\r\n        // Clear all input states immediately\r\n        keysPressed.current.clear();\r\n        isDragging.current = false;\r\n        dragStartPos.current = { x: -1, y: -1 };\r\n        lastMousePos.current = { x: -1, y: -1 };\r\n\r\n        // Hide tooltip if active\r\n        if (activeTooltipNodeId.current && !isLockedRef.current) {\r\n            hideTooltip();\r\n            activeTooltipNodeId.current = null;\r\n        }\r\n    }, [hideTooltip]);\r\n\r\n    // Register blur listener separate from the main mount effect to include the dependency\r\n    useEffect(() => {\r\n        const handleDocumentMouseLeave = () => {\r\n            isMouseInBounds.current = false;\r\n            // Also reset position to be safe\r\n            lastMousePos.current = { x: -1, y: -1 };\r\n\r\n            if (activeTooltipNodeId.current && !isLockedRef.current) {\r\n                hideTooltip();\r\n                activeTooltipNodeId.current = null;\r\n            }\r\n        };\r\n\r\n        window.addEventListener('blur', handleWindowBlur);\r\n        document.addEventListener('mouseleave', handleDocumentMouseLeave);\r\n\r\n        return () => {\r\n            window.removeEventListener('blur', handleWindowBlur);\r\n            document.removeEventListener('mouseleave', handleDocumentMouseLeave);\r\n        };\r\n    }, [handleWindowBlur, hideTooltip]);\r\n\r\n    // Ensure refs are always up to date\r\n    handleDownRef.current = handleDown;\r\n    handleUpRef.current = handleUp;\r\n    handleMoveRef.current = handleMove;\r\n    handleClickRef.current = handleClick;\r\n    handleKeyDownRef.current = handleKeyDown;\r\n    handleKeyUpRef.current = handleKeyUp;\r\n\r\n    return (\r\n        <div\r\n            ref={containerRef}\r\n            className={`synergy-galaxy-container ${isLocked ? 'synergy-galaxy--locked' : ''} ${isIsolatingDebounced ? 'is-isolating' : ''} ${isSynergyMenuOpen ? 'is-blackout-mode' : ''}`}\r\n            onWheel={handleWheel}\r\n            onMouseEnter={() => { isMouseInBounds.current = true; }}\r\n            onMouseLeave={() => { isMouseInBounds.current = false; }}\r\n        >\r\n\r\n            {/* BLACKOUT OVERLAY: Strictly hides everything behind the menu when open */}\r\n            <div className={`synergy-blackout ${isSynergyMenuOpen ? 'synergy-blackout--active' : ''}`} />\r\n\r\n            <div className=\"synergy-galaxy-vignette\" />\r\n            <div className=\"synergy-galaxy-stars\" />\r\n\r\n            <canvas\r\n                ref={canvasRef}\r\n                className=\"synergy-galaxy-canvas\"\r\n            />\r\n\r\n            <div\r\n                ref={galaxyRef}\r\n                className=\"synergy-galaxy-stage\"\r\n            >\r\n                {/* \r\n                DOM Phase: Standard 3D Nodes\r\n                Only render nodes that are NOT synchronized here.\r\n            */}\r\n                {nodes.filter(n => n.lodLevel < 2 && !isNodeSynchronized(n)).map(node => {\r\n                    const tierClass = node.tierClass;\r\n                    const isMasterwork = node.isMasterwork;\r\n                    const isEquipped = node.isEquipped;\r\n\r\n                    const isFocused = focusedNode?.id === node.id || (focusedNode?.instanceId && node.instanceId && focusedNode.instanceId === node.instanceId);\r\n\r\n                    // Check if node matches search query and filters\r\n                    const matchesSearch = itemMatchesFilters(node, searchQueryRef.current, elementFilterRef.current, classFilterRef.current, getElement);\r\n\r\n                    // Check if node matches view mode filter\r\n                    let matchesViewMode = true;\r\n                    if (viewMode === 'subclass-only') {\r\n                        matchesViewMode = node.type === 'subclass';\r\n                    } else if (viewMode === 'inventory-only') {\r\n                        // Show only weapons and armor (hide subclasses)\r\n                        matchesViewMode = node.type === 'weapon' || node.type === 'armor';\r\n                    }\r\n\r\n                    const isSync = isNodeSynchronized(node);\r\n                    const shouldShow = (matchesSearch && matchesViewMode) || isSync || isFocused;\r\n\r\n                    const isTransferring = node.instanceId ? useProfileStore.getState().activeTransfers.has(node.instanceId) : false;\r\n\r\n                    // REDUCE NOISE: Only show success state for a single item if multiple are in the success set\r\n                    // We only show it for the HIGH PRIORITY item (Exotic Weapon > Armor > Rest)\r\n                    let isSuccess = false;\r\n                    const { successfulTransfers } = useProfileStore.getState();\r\n                    if (node.instanceId && successfulTransfers.has(node.instanceId) && !node.id.startsWith('vault-')) {\r\n                        // Check if there's a \"better\" item also in success that should take the spotlight\r\n                        const hasHigherPrioritySuccess = Array.from(successfulTransfers).some(id => {\r\n                            if (id === node.instanceId) return false;\r\n                            const otherNode = nodes.find(n => n.instanceId === id);\r\n                            if (!otherNode) return false;\r\n\r\n                            // Priority logic: Weapons > Armor > Subclass\r\n                            if (node.type === 'weapon') return false; // Weapons are top priority\r\n                            if (node.type === 'armor' && otherNode.type === 'weapon') return true;\r\n                            if (node.type === 'subclass' && (otherNode.type === 'weapon' || otherNode.type === 'armor')) return true;\r\n                            return false;\r\n                        });\r\n\r\n                        isSuccess = !hasHigherPrioritySuccess;\r\n                    }\r\n\r\n\r\n                    // Visual Logic: Color by View Mode\r\n                    let colorClass = `element--${node.element}`;\r\n                    // \"Vault Mode\" generally implies standard view (viewMode='all' or 'inventory-only')\r\n                    // \"Galaxy\" implies 3D cloud which is this view, but user distinction implies \r\n                    // \"Vault Mode\" = Rarity Colors, \"Galaxy/Random\" = Element Colors.\r\n                    // We assume default 'all' view is \"Vault Mode\".\r\n                    // EXCEPTION: Subclasses always use element colors (they don't have tierClass)\r\n                    if (node.type === 'subclass') {\r\n                        // Subclasses always use element colors for their auras\r\n                        colorClass = `element--${node.element}`;\r\n                    } else if (viewMode === 'all' || viewMode === 'inventory-only' || !viewMode) {\r\n                        // Vault Mode: Rarity Colors (CSS: node-tier--)\r\n                        colorClass = `node-tier--${tierClass}`;\r\n                    } else {\r\n                        // Galaxy/Random Mode (subclass-only or synergy mode): Element Colors\r\n                        colorClass = `element--${node.element}`;\r\n                    }\r\n\r\n                    return (\r\n                        <div\r\n                            key={node.id}\r\n                            ref={(el) => {\r\n                                if (el) {\r\n                                    (el as any).__item = node.originalItem;\r\n                                    (el as any).__instanceId = node.instanceId;\r\n                                    nodeRefs.current.set(node.id, el);\r\n                                } else {\r\n                                    nodeRefs.current.delete(node.id);\r\n                                }\r\n                            }}\r\n                            className={`galaxy-node galaxy-node--${node.type} ${colorClass} node-lod--${node.lodLevel} ${isEquipped ? 'galaxy-node--equipped' : ''} ${isMasterwork && shouldShow ? 'galaxy-node--masterwork' : ''} ${!shouldShow ? 'galaxy-node--dimmed' : ''} ${isTransferring ? 'transfer-active' : ''} ${isSuccess ? 'transfer-success' : ''} ${node.instanceId && equippingItemIds.has(node.instanceId) ? 'transmat-equip' : ''} ${isFocused ? 'galaxy-node--focused galaxy-focused-display' : ''}`}\r\n                            style={{\r\n                                // Let the renderLoop handle its position and visibility.\r\n                                display: shouldShow ? 'block' : 'none',\r\n                                opacity: isFocused ? 1 : 0, // Force 1 if focused to prevent initial dim flash\r\n                                visibility: 'visible',\r\n                                pointerEvents: 'none' // CRITICAL: Always none for container, letting children handle events\r\n                            }}\r\n                            onMouseEnter={() => {\r\n                                // Only show tooltip if NOT in synergy mode and NOT locked\r\n                                if (!isSynergyMode && !isLocked && node.originalItem && (!focusedNode || focusedNode.instanceId === node.instanceId)) {\r\n                                    // Calculate proximal position\r\n                                    let fixedPosition;\r\n                                    if (isLocked) {\r\n                                        const { screenX, screenY } = projectToScreen(node.x, node.y, node.z);\r\n                                        fixedPosition = {\r\n                                            x: screenX,\r\n                                            y: screenY\r\n                                        };\r\n                                    }\r\n                                    showTooltip(node.originalItem, node.instanceId ? itemInstances[node.instanceId] : undefined, undefined, isLocked, handleTransferItem, handleEquipItem, isLocked, fixedPosition, node.type === 'subclass', () => { }, false);\r\n                                    activeTooltipNodeId.current = node.id;\r\n                                }\r\n                            }}\r\n                            onMouseLeave={() => {\r\n                                // Only hide if NOT locked\r\n                                if (!isLocked) {\r\n                                    hideTooltip();\r\n                                    activeTooltipNodeId.current = null;\r\n                                }\r\n                            }}\r\n                            onClick={() => handleNodeClick(node)}\r\n                            onContextMenu={(e) => handleTriggerSynergy(node, e)}\r\n                        >\r\n                            <div className=\"galaxy-node__icon-wrap\" style={{ pointerEvents: 'auto' }}>\r\n                                {manifestLoaded && node.hash && (\r\n                                    <>\r\n                                        <img\r\n                                            src={node.iconUrl || getBungieUrl(manifestService.getItem(node.hash)?.displayProperties?.icon || '')}\r\n                                            alt={node.id}\r\n                                            className=\"galaxy-node__icon\"\r\n                                            loading=\"lazy\"\r\n                                            draggable={false}\r\n                                        />\r\n                                        {node.watermarkUrl && (\r\n                                            <img\r\n                                                src={node.watermarkUrl}\r\n                                                className={`galaxy-node__watermark ${node.isLegacyWatermark ? 'galaxy-node__watermark--legacy' : 'galaxy-node__watermark--featured'}`}\r\n                                                alt=\"\"\r\n                                                draggable={false}\r\n                                            />\r\n                                        )}\r\n                                        {node.type !== 'subclass' && node.tierClass !== 'exotic' && node.tier != null && node.tier > 0 && (\r\n                                            <div className=\"galaxy-node__tier-stars\">\r\n                                                <TierBadge tier={node.tier} />\r\n                                            </div>\r\n                                        )}\r\n                                        {node.power != null && node.power > 0 && (\r\n                                            <div className=\"galaxy-node__power\">\r\n                                                {node.damageIconUrl && (\r\n                                                    <img src={node.damageIconUrl} className=\"galaxy-node__damage-icon\" alt=\"\" draggable={false} />\r\n                                                )}\r\n                                                <span className=\"galaxy-node__power-value\">{node.power}</span>\r\n                                            </div>\r\n                                        )}\r\n                                        {node.type === 'weapon' && (node.isCrafted || node.isEnhanced) && (\r\n                                            <div className=\"galaxy-node__craft-status\">\r\n                                                {node.isEnhanced ? (\r\n                                                    <img\r\n                                                        src={getBungieUrl('/img/destiny_content/items/enhanced-item-overlay.png')}\r\n                                                        className=\"galaxy-node__enhanced-icon\"\r\n                                                        alt=\"Enhanced\"\r\n                                                        draggable={false}\r\n                                                    />\r\n                                                ) : node.isCrafted ? (\r\n                                                    <img\r\n                                                        src={getBungieUrl('/img/destiny_content/items/crafted-icon-overlay.png')}\r\n                                                        className=\"galaxy-node__crafted-icon\"\r\n                                                        alt=\"Crafted\"\r\n                                                        draggable={false}\r\n                                                    />\r\n                                                ) : null}\r\n                                            </div>\r\n                                        )}\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n                            <div className=\"transmat-overlay\" />\r\n                            <div className=\"galaxy-node__glow\" />\r\n                        </div>\r\n                    );\r\n                })}\r\n\r\n                {/* \r\n                    Focused Vault Item (Manifested in DOM only when focused AND NOT in standard nodes) \r\n                    This handles items that are in the vault (stars) but not in the character nodes list.\r\n                */}\r\n                {focusedNode && !nodes.some(n => n.id === focusedNode.id || (n.instanceId && focusedNode.instanceId && n.instanceId === focusedNode.instanceId)) && !isNodeSynchronized(focusedNode) && (() => {\r\n                    const { stageX, stageY, scale, isVisible } = projectToScreen(focusedNode.x, focusedNode.y, focusedNode.z);\r\n\r\n                    if (!isVisible) return null;\r\n\r\n                    return (\r\n                        <div\r\n                            className={`galaxy-node galaxy-node--focused galaxy-focused-display galaxy-node--${focusedNode.type} element--${focusedNode.element} node-tier--${focusedNode.tierClass} node-lod--0 ${focusedNode.isMasterwork ? 'galaxy-node--masterwork' : ''}`}\r\n                            ref={(el) => {\r\n                                if (el) {\r\n                                    (el as any).__item = focusedNode.originalItem;\r\n                                    (el as any).__instanceId = focusedNode.instanceId;\r\n                                }\r\n                            }}\r\n                            style={{\r\n                                transform: `translate3d(${stageX}px, ${stageY}px, 0px) scale(${scale})`,\r\n                                zIndex: 20000,\r\n                                display: 'block',\r\n                                opacity: 1,\r\n                                pointerEvents: 'none' // Events handled by container click/hover logic\r\n                            }}\r\n                            onMouseEnter={() => {\r\n                                if (!isSynergyMode && !isLocked && focusedNode.originalItem) {\r\n                                    const { screenX, screenY, scale } = projectToScreen(focusedNode.x, focusedNode.y, focusedNode.z);\r\n                                    const fixedPosition = {\r\n                                        x: screenX + (42 * scale) + 12,\r\n                                        y: screenY\r\n                                    };\r\n                                    showTooltip(focusedNode.originalItem, focusedNode.instanceId ? itemInstances[focusedNode.instanceId] : undefined, undefined, true, handleTransferItem, handleEquipItem, true, fixedPosition, focusedNode.type === 'subclass', () => { }, false);\r\n                                    activeTooltipNodeId.current = focusedNode.id;\r\n                                }\r\n                            }}\r\n                            onMouseLeave={() => {\r\n                                hideTooltip();\r\n                                activeTooltipNodeId.current = null;\r\n                            }}\r\n                        >\r\n                            <div className=\"galaxy-node__icon-wrap\">\r\n                                <img\r\n                                    src={focusedNode.iconUrl || getBungieUrl(manifestService.getItem(focusedNode.hash)?.displayProperties?.icon || '')}\r\n                                    alt=\"focused\"\r\n                                    className=\"galaxy-node__icon\"\r\n                                    draggable={false}\r\n                                />\r\n                                {focusedNode.watermarkUrl && (\r\n                                    <img\r\n                                        src={focusedNode.watermarkUrl}\r\n                                        className={`galaxy-node__watermark ${focusedNode.isLegacyWatermark ? 'galaxy-node__watermark--legacy' : 'galaxy-node__watermark--featured'}`}\r\n                                        alt=\"\"\r\n                                        draggable={false}\r\n                                    />\r\n                                )}\r\n                                {focusedNode.type !== 'subclass' && focusedNode.tierClass !== 'exotic' && focusedNode.tier != null && focusedNode.tier > 0 && (\r\n                                    <div className=\"galaxy-node__tier-stars\">\r\n                                        <TierBadge tier={focusedNode.tier} />\r\n                                    </div>\r\n                                )}\r\n                                {focusedNode.power != null && focusedNode.power > 0 && (\r\n                                    <div className=\"galaxy-node__power\">\r\n                                        {focusedNode.damageIconUrl && (\r\n                                            <img src={focusedNode.damageIconUrl} className=\"galaxy-node__damage-icon\" alt=\"\" draggable={false} />\r\n                                        )}\r\n                                        <span className=\"galaxy-node__power-value\">{focusedNode.power}</span>\r\n                                    </div>\r\n                                )}\r\n                                {focusedNode.type === 'weapon' && (focusedNode.isCrafted || focusedNode.isEnhanced) && (\r\n                                    <div className=\"galaxy-node__craft-status\">\r\n                                        {focusedNode.isEnhanced ? (\r\n                                            <img\r\n                                                src={getBungieUrl('/img/destiny_content/items/enhanced-item-overlay.png')}\r\n                                                className=\"galaxy-node__enhanced-icon\"\r\n                                                alt=\"Enhanced\"\r\n                                                draggable={false}\r\n                                            />\r\n                                        ) : focusedNode.isCrafted ? (\r\n                                            <img\r\n                                                src={getBungieUrl('/img/destiny_content/items/crafted-icon-overlay.png')}\r\n                                                className=\"galaxy-node__crafted-icon\"\r\n                                                alt=\"Crafted\"\r\n                                                draggable={false}\r\n                                            />\r\n                                        ) : null}\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                            <div className=\"transmat-overlay\" />\r\n                            <div className=\"galaxy-node__glow\" />\r\n                        </div>\r\n                    );\r\n                })()}\r\n            </div>\r\n\r\n            {/* \r\n            HUD Phase: Synchronized Nodes & Focused Synchronized Node\r\n            These are outside the 3D stage to avoid rotation/tilt jitter.\r\n        */}\r\n            {isSynergyMode && (\r\n                <div className=\"synergy-galaxy-hud-layer\">\r\n                    {nodes.filter(n => isNodeSynchronized(n)).map(node => {\r\n                        const tierClass = node.tierClass;\r\n                        const isMasterwork = node.isMasterwork;\r\n                        const isEquipped = node.isEquipped;\r\n\r\n                        const { activeTransfers, successfulTransfers } = useProfileStore.getState();\r\n                        const isTransferring = node.instanceId ? activeTransfers.has(node.instanceId) : false;\r\n                        const isSuccess = node.instanceId ? successfulTransfers.has(node.instanceId) : false;\r\n\r\n                        // Calculate opacity and visibility based on isolation\r\n                        let nodeOpacity = 1;\r\n                        let nodeDisplay = 'block';\r\n                        const isIsolating = isIsolatingDebounced;\r\n                        const isFocused = focusedNode && (focusedNode.instanceId === node.instanceId || focusedNode.id === node.id);\r\n\r\n                        if (isFocused) {\r\n                            nodeOpacity = 1;\r\n                        } else if (hoveredSynergyWire) {\r\n                            const isHoveredArmor = node.instanceId === hoveredSynergyWire.armorInstanceId;\r\n                            const isHoveredWeapon = node.instanceId === hoveredSynergyWire.weaponInstanceId;\r\n\r\n                            if (isHoveredArmor || isHoveredWeapon) {\r\n                                nodeOpacity = 1;\r\n                            } else {\r\n                                // STRICT HIDE: Don't just dim, completely remove from layout during isolation\r\n                                // to prevent clumping of non-active icons in the HUD layer\r\n                                nodeDisplay = 'none';\r\n                                nodeOpacity = 0;\r\n                            }\r\n                        } else if (isIsolating) {\r\n                            // If isolating for other reasons (focusedNode but no hoveredWire), dim or hide others\r\n                            nodeOpacity = 0.05;\r\n                            if (node.type === 'subclass') nodeDisplay = 'none'; // Hide subclass when focusing items\r\n                        }\r\n\r\n                        return (\r\n                            <div\r\n                                key={`hud-${node.id}`}\r\n                                ref={(el) => {\r\n                                    if (el) {\r\n                                        (el as any).__item = node.originalItem;\r\n                                        (el as any).__instanceId = node.instanceId;\r\n                                        nodeRefs.current.set(node.id, el);\r\n                                    } else {\r\n                                        nodeRefs.current.delete(node.id);\r\n                                    }\r\n                                }}\r\n                                className={`galaxy-node is-synced galaxy-node--${node.type} element--${node.element} node-tier--${tierClass} node-lod--0 ${isEquipped ? 'galaxy-node--equipped' : ''} ${isMasterwork ? 'galaxy-node--masterwork' : ''} ${isTransferring ? 'transfer-active' : ''} ${isSuccess ? 'transfer-success' : ''} ${node.instanceId && equippingItemIds.has(node.instanceId) ? 'transmat-equip' : ''} ${isFocused ? 'galaxy-node--focused galaxy-focused-display' : ''}`}\r\n                                style={{\r\n                                    display: nodeDisplay,\r\n                                    opacity: nodeOpacity,\r\n                                    pointerEvents: 'auto',\r\n                                    zIndex: (isTransferring || isSuccess || (node.instanceId && equippingItemIds.has(node.instanceId))) ? 1000000 : undefined\r\n                                }}\r\n                                onClick={() => handleNodeClick(node)}\r\n                                onMouseEnter={() => {\r\n                                    setHoveredSynergyNodeId(node.instanceId || node.id);\r\n                                }}\r\n                                onMouseLeave={() => {\r\n                                    setHoveredSynergyNodeId(null);\r\n                                }}\r\n                                onContextMenu={(e) => handleTriggerSynergy(node, e)}\r\n                            >\r\n                                <div className=\"galaxy-node__icon-wrap\">\r\n                                    {manifestLoaded && node.hash && (\r\n                                        <>\r\n                                            <img\r\n                                                src={node.iconUrl || getBungieUrl(manifestService.getItem(node.hash)?.displayProperties?.icon || '')}\r\n                                                alt={node.id}\r\n                                                className=\"galaxy-node__icon\"\r\n                                            />\r\n                                            {node.watermarkUrl && (\r\n                                                <img\r\n                                                    src={node.watermarkUrl}\r\n                                                    className={`galaxy-node__watermark ${node.isLegacyWatermark ? 'galaxy-node__watermark--legacy' : 'galaxy-node__watermark--featured'}`}\r\n                                                    alt=\"\"\r\n                                                />\r\n                                            )}\r\n                                        </>\r\n                                    )}\r\n                                </div>\r\n                                <div className=\"transmat-overlay\" />\r\n                                <div className=\"galaxy-node__glow\" />\r\n                            </div>\r\n                        );\r\n                    })}\r\n\r\n                </div>\r\n            )}\r\n\r\n            {/* Synergy Web Overlay - Outside 3D stage to align with screen positions */}\r\n            {isSynergyMode && synergyConnections.length > 0 && (\r\n                <div style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', zIndex: 2000000005, pointerEvents: 'none' }}>\r\n                    <SynergyWeb\r\n                        connections={synergyConnections}\r\n                        sourcePosition={synergySourcePos}\r\n                        sourceNodeId={synergySourceNodeId}\r\n                        getItemPosition={getItemPosition}\r\n                        itemInstances={itemInstances}\r\n                        onWireHoverChange={handleWireHoverChange}\r\n                        onWireHover={handleWireHover}\r\n                        onWireLock={handleSynergyWireLock}\r\n                        onClose={handleCloseSynergyWeb}\r\n                        isExiting={isSynergyExiting}\r\n                        hoveredNodeId={hoveredSynergyNodeId}\r\n                        onSynergyOverlayChange={(isOpen, synergy) => {\r\n                            setIsSynergyMenuOpen(isOpen);\r\n                            onSynergyOverlayChange?.(isOpen, synergy);\r\n                        }}\r\n                        onEquipSynergy={handleEquipSynergy}\r\n                        forceCloseTrigger={forceCloseTrigger}\r\n                    />\r\n                </div>\r\n            )}\r\n\r\n            <div\r\n                className=\"synergy-galaxy-ui\"\r\n                style={{\r\n                    opacity: hideGlobalUI ? 0 : 1,\r\n                    pointerEvents: hideGlobalUI ? 'none' : 'auto',\r\n                    transition: 'opacity 0.3s ease-out'\r\n                }}\r\n            >\r\n                <div className=\"synergy-galaxy-header\">\r\n                    {showFps && (\r\n                        <div className=\"synergy-galaxy-debug\">\r\n                            <span className=\"debug-fps\">{fps} FPS</span>\r\n                        </div>\r\n                    )}\r\n                    <div className=\"synergy-galaxy-title-container\">\r\n                        <h1 className=\"synergy-galaxy-title\">Synergy Galaxy</h1>\r\n                        <button\r\n                            className={`synergy-galaxy-reload-btn ${isLoading ? 'is-loading' : ''} ${isStale ? 'is-stale' : ''}`}\r\n                            onClick={(e) => {\r\n                                e.stopPropagation();\r\n                                profileLoader.loadProfile(true);\r\n                            }}\r\n                            title={isStale ? \"Data is stale. Click to refresh from Bungie.\" : \"Reload Destiny Data\"}\r\n                            aria-label=\"Reload\"\r\n                        >\r\n                            <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n                                <path d=\"M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16\" />\r\n                            </svg>\r\n                            {isStale && (\r\n                                <div className=\"synergy-galaxy-stale-warning\">\r\n                                    <svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#ff4444\" strokeWidth=\"3\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n                                        <path d=\"M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z\" />\r\n                                        <line x1=\"12\" y1=\"9\" x2=\"12\" y2=\"13\" />\r\n                                        <line x1=\"12\" y1=\"17\" x2=\"12.01\" y2=\"17\" />\r\n                                    </svg>\r\n                                </div>\r\n                            )}\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}"],"file":"galaxy-DVJjGVLR.js"}