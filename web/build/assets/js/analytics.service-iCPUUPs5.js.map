{"version":3,"file":"analytics.service-iCPUUPs5.js","sources":["../../../../src/services/analytics.service.ts"],"sourcesContent":["import { db } from './db/indexeddb.service';\r\nimport type { DestinyItem } from '../types';\r\n\r\ninterface UsageStats {\r\n    loadoutEquips: Record<string, number>; // loadoutId -> count\r\n    itemEquips: Record<string, number>; // itemInstanceId -> count\r\n    lastEquipped: Record<string, number>; // itemInstanceId -> timestamp\r\n}\r\n\r\ninterface PerformanceMetrics {\r\n    apiCalls: {\r\n        endpoint: string;\r\n        duration: number;\r\n        success: boolean;\r\n        timestamp: number;\r\n    }[];\r\n    transferStats: {\r\n        total: number;\r\n        successful: number;\r\n        failed: number;\r\n    };\r\n}\r\n\r\nclass AnalyticsService {\r\n    private usageStats: UsageStats = {\r\n        loadoutEquips: {},\r\n        itemEquips: {},\r\n        lastEquipped: {}\r\n    };\r\n\r\n    private performanceMetrics: PerformanceMetrics = {\r\n        apiCalls: [],\r\n        transferStats: { total: 0, successful: 0, failed: 0 }\r\n    };\r\n\r\n    async init(): Promise<void> {\r\n        const saved = await db.getSetting<UsageStats>('usage_stats');\r\n        if (saved) {\r\n            this.usageStats = saved;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Track loadout equip\r\n     */\r\n    trackLoadoutEquip(loadoutId: string): void {\r\n        this.usageStats.loadoutEquips[loadoutId] =\r\n            (this.usageStats.loadoutEquips[loadoutId] || 0) + 1;\r\n        this.persistUsageStats();\r\n    }\r\n\r\n    /**\r\n     * Track item equip\r\n     */\r\n    trackItemEquip(itemInstanceId: string): void {\r\n        this.usageStats.itemEquips[itemInstanceId] =\r\n            (this.usageStats.itemEquips[itemInstanceId] || 0) + 1;\r\n        this.usageStats.lastEquipped[itemInstanceId] = Date.now();\r\n        this.persistUsageStats();\r\n    }\r\n\r\n    /**\r\n     * Track API call performance\r\n     */\r\n    trackApiCall(endpoint: string, duration: number, success: boolean): void {\r\n        this.performanceMetrics.apiCalls.push({\r\n            endpoint,\r\n            duration,\r\n            success,\r\n            timestamp: Date.now()\r\n        });\r\n\r\n        // Keep only last 1000 calls\r\n        if (this.performanceMetrics.apiCalls.length > 1000) {\r\n            this.performanceMetrics.apiCalls = this.performanceMetrics.apiCalls.slice(-1000);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Track transfer result\r\n     */\r\n    trackTransfer(success: boolean): void {\r\n        this.performanceMetrics.transferStats.total++;\r\n        if (success) {\r\n            this.performanceMetrics.transferStats.successful++;\r\n        } else {\r\n            this.performanceMetrics.transferStats.failed++;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get most used loadouts\r\n     */\r\n    getMostUsedLoadouts(limit = 10): Array<{ id: string; count: number }> {\r\n        return Object.entries(this.usageStats.loadoutEquips)\r\n            .map(([id, count]) => ({ id, count }))\r\n            .sort((a, b) => b.count - a.count)\r\n            .slice(0, limit);\r\n    }\r\n\r\n    /**\r\n     * Get most equipped items\r\n     */\r\n    getMostEquippedItems(limit = 10): Array<{ instanceId: string; count: number }> {\r\n        return Object.entries(this.usageStats.itemEquips)\r\n            .map(([instanceId, count]) => ({ instanceId, count }))\r\n            .sort((a, b) => b.count - a.count)\r\n            .slice(0, limit);\r\n    }\r\n\r\n    /**\r\n     * Get API performance stats\r\n     */\r\n    getApiPerformance(): {\r\n        avgDuration: number;\r\n        p50: number;\r\n        p95: number;\r\n        p99: number;\r\n        successRate: number;\r\n    } {\r\n        const durations = this.performanceMetrics.apiCalls\r\n            .filter(c => c.success)\r\n            .map(c => c.duration)\r\n            .sort((a, b) => a - b);\r\n\r\n        if (durations.length === 0) {\r\n            return { avgDuration: 0, p50: 0, p95: 0, p99: 0, successRate: 0 };\r\n        }\r\n\r\n        const avg = durations.reduce((a, b) => a + b, 0) / durations.length;\r\n        const p50 = durations[Math.floor(durations.length * 0.5)];\r\n        const p95 = durations[Math.floor(durations.length * 0.95)];\r\n        const p99 = durations[Math.floor(durations.length * 0.99)];\r\n\r\n        const total = this.performanceMetrics.apiCalls.length;\r\n        const successful = this.performanceMetrics.apiCalls.filter(c => c.success).length;\r\n        const successRate = total > 0 ? (successful / total) * 100 : 0;\r\n\r\n        return {\r\n            avgDuration: Math.round(avg),\r\n            p50: Math.round(p50),\r\n            p95: Math.round(p95),\r\n            p99: Math.round(p99),\r\n            successRate: Math.round(successRate * 100) / 100\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Get transfer success rate\r\n     */\r\n    getTransferStats(): { total: number; successRate: number } {\r\n        const { total, successful } = this.performanceMetrics.transferStats;\r\n        return {\r\n            total,\r\n            successRate: total > 0 ? Math.round((successful / total) * 100 * 100) / 100 : 0\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Detect duplicate items (same hash + perks)\r\n     */\r\n    findDuplicates(items: DestinyItem[]): Array<{ hash: number; count: number; instances: string[] }> {\r\n        const groups = new Map<string, string[]>();\r\n\r\n        for (const item of items) {\r\n            // Create signature from hash + socket plugs\r\n            const signature = `${item.itemHash}`;\r\n            const existing = groups.get(signature) || [];\r\n            if (item.itemInstanceId) {\r\n                existing.push(item.itemInstanceId);\r\n            }\r\n            groups.set(signature, existing);\r\n        }\r\n\r\n        return Array.from(groups.entries())\r\n            .filter(([_, instances]) => instances.length > 1)\r\n            .map(([sig, instances]) => ({\r\n                hash: parseInt(sig),\r\n                count: instances.length,\r\n                instances\r\n            }))\r\n            .sort((a, b) => b.count - a.count);\r\n    }\r\n\r\n    /**\r\n     * Get vault usage breakdown\r\n     */\r\n    getVaultBreakdown(vaultItems: DestinyItem[]): {\r\n        weapons: number;\r\n        armor: number;\r\n        total: number;\r\n        capacity: number;\r\n        usagePercent: number;\r\n    } {\r\n        const WEAPON_BUCKETS = [1498876634, 2465295065, 953998645];\r\n        const ARMOR_BUCKETS = [3448274439, 3551918588, 14239492, 20886954, 1585787867];\r\n\r\n        const weapons = vaultItems.filter(i => WEAPON_BUCKETS.includes(i.bucketHash)).length;\r\n        const armor = vaultItems.filter(i => ARMOR_BUCKETS.includes(i.bucketHash)).length;\r\n        const total = vaultItems.length;\r\n        const capacity = 500;\r\n\r\n        return {\r\n            weapons,\r\n            armor,\r\n            total,\r\n            capacity,\r\n            usagePercent: Math.round((total / capacity) * 100 * 100) / 100\r\n        };\r\n    }\r\n\r\n    private async persistUsageStats(): Promise<void> {\r\n        await db.setSetting('usage_stats', this.usageStats);\r\n    }\r\n\r\n    /**\r\n     * Export all analytics data\r\n     */\r\n    exportData(): string {\r\n        return JSON.stringify({\r\n            usage: this.usageStats,\r\n            performance: this.performanceMetrics,\r\n            exportedAt: Date.now()\r\n        }, null, 2);\r\n    }\r\n\r\n    /**\r\n     * Clear all analytics data\r\n     */\r\n    async clearData(): Promise<void> {\r\n        this.usageStats = { loadoutEquips: {}, itemEquips: {}, lastEquipped: {} };\r\n        this.performanceMetrics = {\r\n            apiCalls: [],\r\n            transferStats: { total: 0, successful: 0, failed: 0 }\r\n        };\r\n        await db.setSetting('usage_stats', this.usageStats);\r\n    }\r\n}\r\n\r\nexport const analyticsService = new AnalyticsService();\r\n"],"names":["AnalyticsService","saved","db","loadoutId","itemInstanceId","endpoint","duration","success","limit","id","count","a","b","instanceId","durations","c","avg","p50","p95","p99","total","successful","successRate","items","groups","item","signature","existing","_","instances","sig","vaultItems","WEAPON_BUCKETS","ARMOR_BUCKETS","weapons","i","armor","capacity","analyticsService"],"mappings":"qKAuBA,MAAMA,CAAiB,CACX,WAAyB,CAC7B,cAAe,CAAA,EACf,WAAY,CAAA,EACZ,aAAc,CAAA,CAAC,EAGX,mBAAyC,CAC7C,SAAU,CAAA,EACV,cAAe,CAAE,MAAO,EAAG,WAAY,EAAG,OAAQ,CAAA,CAAE,EAGxD,MAAM,MAAsB,CACxB,MAAMC,EAAQ,MAAMC,EAAG,WAAuB,aAAa,EACvDD,IACA,KAAK,WAAaA,EAE1B,CAKA,kBAAkBE,EAAyB,CACvC,KAAK,WAAW,cAAcA,CAAS,GAClC,KAAK,WAAW,cAAcA,CAAS,GAAK,GAAK,EACtD,KAAK,kBAAA,CACT,CAKA,eAAeC,EAA8B,CACzC,KAAK,WAAW,WAAWA,CAAc,GACpC,KAAK,WAAW,WAAWA,CAAc,GAAK,GAAK,EACxD,KAAK,WAAW,aAAaA,CAAc,EAAI,KAAK,IAAA,EACpD,KAAK,kBAAA,CACT,CAKA,aAAaC,EAAkBC,EAAkBC,EAAwB,CACrE,KAAK,mBAAmB,SAAS,KAAK,CAClC,SAAAF,EACA,SAAAC,EACA,QAAAC,EACA,UAAW,KAAK,IAAA,CAAI,CACvB,EAGG,KAAK,mBAAmB,SAAS,OAAS,MAC1C,KAAK,mBAAmB,SAAW,KAAK,mBAAmB,SAAS,MAAM,IAAK,EAEvF,CAKA,cAAcA,EAAwB,CAClC,KAAK,mBAAmB,cAAc,QAClCA,EACA,KAAK,mBAAmB,cAAc,aAEtC,KAAK,mBAAmB,cAAc,QAE9C,CAKA,oBAAoBC,EAAQ,GAA0C,CAClE,OAAO,OAAO,QAAQ,KAAK,WAAW,aAAa,EAC9C,IAAI,CAAC,CAACC,EAAIC,CAAK,KAAO,CAAE,GAAAD,EAAI,MAAAC,GAAQ,EACpC,KAAK,CAACC,EAAGC,IAAMA,EAAE,MAAQD,EAAE,KAAK,EAChC,MAAM,EAAGH,CAAK,CACvB,CAKA,qBAAqBA,EAAQ,GAAkD,CAC3E,OAAO,OAAO,QAAQ,KAAK,WAAW,UAAU,EAC3C,IAAI,CAAC,CAACK,EAAYH,CAAK,KAAO,CAAE,WAAAG,EAAY,MAAAH,GAAQ,EACpD,KAAK,CAACC,EAAGC,IAAMA,EAAE,MAAQD,EAAE,KAAK,EAChC,MAAM,EAAGH,CAAK,CACvB,CAKA,mBAME,CACE,MAAMM,EAAY,KAAK,mBAAmB,SACrC,OAAOC,GAAKA,EAAE,OAAO,EACrB,IAAIA,GAAKA,EAAE,QAAQ,EACnB,KAAK,CAACJ,EAAGC,IAAMD,EAAIC,CAAC,EAEzB,GAAIE,EAAU,SAAW,EACrB,MAAO,CAAE,YAAa,EAAG,IAAK,EAAG,IAAK,EAAG,IAAK,EAAG,YAAa,CAAA,EAGlE,MAAME,EAAMF,EAAU,OAAO,CAACH,EAAGC,IAAMD,EAAIC,EAAG,CAAC,EAAIE,EAAU,OACvDG,EAAMH,EAAU,KAAK,MAAMA,EAAU,OAAS,EAAG,CAAC,EAClDI,EAAMJ,EAAU,KAAK,MAAMA,EAAU,OAAS,GAAI,CAAC,EACnDK,EAAML,EAAU,KAAK,MAAMA,EAAU,OAAS,GAAI,CAAC,EAEnDM,EAAQ,KAAK,mBAAmB,SAAS,OACzCC,EAAa,KAAK,mBAAmB,SAAS,OAAON,GAAKA,EAAE,OAAO,EAAE,OACrEO,EAAcF,EAAQ,EAAKC,EAAaD,EAAS,IAAM,EAE7D,MAAO,CACH,YAAa,KAAK,MAAMJ,CAAG,EAC3B,IAAK,KAAK,MAAMC,CAAG,EACnB,IAAK,KAAK,MAAMC,CAAG,EACnB,IAAK,KAAK,MAAMC,CAAG,EACnB,YAAa,KAAK,MAAMG,EAAc,GAAG,EAAI,GAAA,CAErD,CAKA,kBAA2D,CACvD,KAAM,CAAE,MAAAF,EAAO,WAAAC,CAAA,EAAe,KAAK,mBAAmB,cACtD,MAAO,CACH,MAAAD,EACA,YAAaA,EAAQ,EAAI,KAAK,MAAOC,EAAaD,EAAS,IAAM,GAAG,EAAI,IAAM,CAAA,CAEtF,CAKA,eAAeG,EAAmF,CAC9F,MAAMC,MAAa,IAEnB,UAAWC,KAAQF,EAAO,CAEtB,MAAMG,EAAY,GAAGD,EAAK,QAAQ,GAC5BE,EAAWH,EAAO,IAAIE,CAAS,GAAK,CAAA,EACtCD,EAAK,gBACLE,EAAS,KAAKF,EAAK,cAAc,EAErCD,EAAO,IAAIE,EAAWC,CAAQ,CAClC,CAEA,OAAO,MAAM,KAAKH,EAAO,QAAA,CAAS,EAC7B,OAAO,CAAC,CAACI,EAAGC,CAAS,IAAMA,EAAU,OAAS,CAAC,EAC/C,IAAI,CAAC,CAACC,EAAKD,CAAS,KAAO,CACxB,KAAM,SAASC,CAAG,EAClB,MAAOD,EAAU,OACjB,UAAAA,CAAA,EACF,EACD,KAAK,CAAClB,EAAGC,IAAMA,EAAE,MAAQD,EAAE,KAAK,CACzC,CAKA,kBAAkBoB,EAMhB,CACE,MAAMC,EAAiB,CAAC,WAAY,WAAY,SAAS,EACnDC,EAAgB,CAAC,WAAY,WAAY,SAAU,SAAU,UAAU,EAEvEC,EAAUH,EAAW,OAAOI,GAAKH,EAAe,SAASG,EAAE,UAAU,CAAC,EAAE,OACxEC,EAAQL,EAAW,OAAOI,GAAKF,EAAc,SAASE,EAAE,UAAU,CAAC,EAAE,OACrEf,EAAQW,EAAW,OACnBM,EAAW,IAEjB,MAAO,CACH,QAAAH,EACA,MAAAE,EACA,MAAAhB,EACA,SAAAiB,EACA,aAAc,KAAK,MAAOjB,EAAQiB,EAAY,IAAM,GAAG,EAAI,GAAA,CAEnE,CAEA,MAAc,mBAAmC,CAC7C,MAAMnC,EAAG,WAAW,cAAe,KAAK,UAAU,CACtD,CAKA,YAAqB,CACjB,OAAO,KAAK,UAAU,CAClB,MAAO,KAAK,WACZ,YAAa,KAAK,mBAClB,WAAY,KAAK,IAAA,CAAI,EACtB,KAAM,CAAC,CACd,CAKA,MAAM,WAA2B,CAC7B,KAAK,WAAa,CAAE,cAAe,CAAA,EAAI,WAAY,CAAA,EAAI,aAAc,EAAC,EACtE,KAAK,mBAAqB,CACtB,SAAU,CAAA,EACV,cAAe,CAAE,MAAO,EAAG,WAAY,EAAG,OAAQ,CAAA,CAAE,EAExD,MAAMA,EAAG,WAAW,cAAe,KAAK,UAAU,CACtD,CACJ,CAEO,MAAMoC,EAAmB,IAAItC"}