import{o as v,r as C,n as W,Q as _,t as B,u as $,j,w as F,m as y,X as N,Y as E}from"./galaxy-CADwz3wb.js";class P{async saveBuild(e,i){await v.init();const a={id:`build-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:i||e.name,template:e,createdAt:Date.now(),lastModified:Date.now(),tags:[]};return await v.setSavedBuild(a),C.getState().addBuild(a),a}async loadSavedBuilds(){C.getState().setLoading(!0);try{const e=await v.getSavedBuilds();C.getState().setBuilds(e)}catch(e){W("Build","Failed to load saved builds:",e)}finally{C.getState().setLoading(!1)}}async deleteBuild(e){await v.deleteSavedBuild(e),C.getState().removeBuild(e)}synergyToTemplate(e){return{id:e.id,name:e.name,element:e.element,guardianClass:e.guardianClass,requiredExpansion:e.requiredExpansion,exoticWeapon:e.exoticWeapon?{hash:e.exoticWeapon.hash,name:e.exoticWeapon.name,slot:1}:{hash:0,name:"None",slot:0},exoticArmor:e.exoticArmor,subclassConfig:{superHash:e.subclassNode.superHash||0,aspects:e.subclassNode.aspectHashes,fragments:e.subclassNode.fragmentHashes||[],grenadeHash:e.subclassNode.grenadeHash,meleeHash:e.subclassNode.meleeHash,classAbilityHash:e.subclassNode.classAbilityHash},playstyle:e.playstyle,difficulty:e.difficulty,armorMods:_.suggestMods(e.element,e.difficulty),items:(e.recommendedWeapons||[]).map(i=>({hash:i.hash,name:i.name}))}}async equip(e,i,a,d=!1){const f="subclassNode"in e?this.synergyToTemplate(e):e,g=f.name||"Loadout",l=await B.equipBuild(f,i,a,d);if(!l)return{success:!1,error:"Equip failed to starting or returned no results."};const H=l.missing||[],S=l.failed||[],u=l.equipped||[];if(l.success)return{success:!0,equipped:u};{let p=`Failed to equip "${g}".`;return H.length>0?p=`Cannot equip "${g}" - Missing: ${H.join(", ")}`:S.length>0?p=`"${g}" partially equipped. Failed items: ${S.join(", ")}`:l.error&&(p=l.error),{success:!1,error:p,equipped:u,failed:S,missing:H}}}async snapshotToInGameSlot(e,i){return B.snapshotLoadout(e,i)}async captureLoadout(e,i,a,d){a?.("Initializing capture...",10);const f=$.getState(),g=f.characterEquipment[e];if(!g)return null;a?.("Analyzing equipment...",20);const l=[];let H={hash:0,name:"None",slot:0},S={hash:0,name:"None",slot:0},u=null,p=[],w=[];a?.("Fetching item detail sockets...",40);const D=g.map(async s=>{if(!s.itemInstanceId)return{item:s,sockets:[]};try{const r=await j.getItemSockets(s.itemInstanceId);return{item:s,sockets:r}}catch(r){return F("Build",`Failed to fetch sockets for ${s.itemHash}`,r),{item:s,sockets:[]}}}),q=await Promise.all(D);a?.("Parsing item configurations and mods...",60);for(const{item:s,sockets:r}of q){const t=y.getItem(s.itemHash);if(!t)continue;const n={};if(r&&Array.isArray(r)&&t.sockets){const k=o=>(t.sockets.socketCategories||t.sockets.categories)?.find(A=>A.socketIndexes.includes(o))?.socketCategoryHash;r.forEach((o,I)=>{if(!o.isEnabled||!o.plugHash)return;const A=k(I),O=y.getItem(o.plugHash),b=O?.name||"";if(b.includes("Upgrade Armor")||b.includes("Empty Mod Socket")||b.includes("Empty Socket")||o.plugHash===3696633656)return;const R=t.itemCategoryHashes?.includes(1378222069);(A===N.ARMOR_MODS||O?.itemCategoryHashes?.includes(59)||b.includes("Mod")||R)&&p.push(o.plugHash),(A===N.WEAPON_PERKS||A===N.WEAPON_MODS)&&(n[I]=o.plugHash),t.itemType===16&&(n[I]=o.plugHash,A===N.TRANSCENDENCE&&(n[I]=o.plugHash))})}t.itemType===16?u={...s,socketOverrides:n}:t.isExotic?t.itemType===2?S={hash:s.itemHash,name:t.name,slot:2,socketOverrides:n}:t.itemType===3&&(H={hash:s.itemHash,name:t.name,slot:1,socketOverrides:n}):(t.itemType===2||t.itemType===3)&&l.push({hash:s.itemHash,name:t.name,socketOverrides:n})}a?.("Extracting subclass nodes...",80);const c={subclassHash:u?.itemHash||0,superHash:0,aspects:[],fragments:[],grenadeHash:0,meleeHash:0,classAbilityHash:0,jumpHash:0};if(u&&u.socketOverrides){const s=y.getItem(u.itemHash);s&&s.sockets&&Object.entries(u.socketOverrides).forEach(([r,t])=>{const n=t,k=y.getRawDefinition("DestinyInventoryItemDefinition",n);if(!k)return;const o=k.plug?.plugCategoryIdentifier||"";o.includes("supers")?c.superHash=n:o.includes("class_abilities")?c.classAbilityHash=n:o.includes("grenades")?c.grenadeHash=n:o.includes("melee")?c.meleeHash=n:o.includes("movement")?c.jumpHash=n:o.includes("aspects")?c.aspects?.push(n):o.includes("fragments")&&c.fragments?.push(n)})}a?.("Capturing artifact perks...",90);const x=f.characterProgressions?.[e];x?.seasonalArtifact?.tiers&&x.seasonalArtifact.tiers.forEach(s=>{s.items.forEach(r=>{r.isActive&&w.push(r.itemHash)})});const m=f.characters.find(s=>s.characterId===e),L=m?.classType??0;let M;m?.stats&&(M={mobility:m.stats[E.MOBILITY]||0,resilience:m.stats[E.RESILIENCE]||0,recovery:m.stats[E.RECOVERY]||0,discipline:m.stats[E.DISCIPLINE]||0,intellect:m.stats[E.INTELLECT]||0,strength:m.stats[E.STRENGTH]||0,total:Object.values(m.stats).reduce((s,r)=>s+r,0)});const h=c.subclassHash?y.getItem(c.subclassHash):null;let T=d||"kinetic";if(h){const s=h.talentGrid?.hudDamageType||h.defaultDamageType||h.itemType,t={1:"kinetic",2:"arc",3:"solar",4:"void",6:"stasis",7:"strand"}[s];t&&t!=="kinetic"?T=t:t==="kinetic"&&d?T=d:t||(T="prismatic"),([2946726027,2603483315,3170703816,3893112950].includes(c.subclassHash||0)||h.plug?.plugCategoryIdentifier?.includes("prismatic")||h.name?.toLowerCase().includes("prismatic")||h.itemTypeDisplayName?.toLowerCase().includes("prismatic"))&&(T="prismatic")}return a?.("Build captured!",100),{id:`captured-${Date.now()}`,name:i,element:T,guardianClass:L,requiredExpansion:0,exoticWeapon:H,exoticArmor:S,subclassConfig:c,items:l,playstyle:"Captured Loadout",difficulty:"intermediate",armorMods:p,artifactPerks:w,stats:M}}exportToJson(e){const i={id:e.id,name:e.name,classType:e.template.guardianClass,clearSpace:!1,equipped:[{hash:e.template.exoticWeapon?.hash||0,socketOverrides:{}},{hash:e.template.exoticArmor?.hash||0,socketOverrides:{}},{hash:e.template.subclassConfig?.subclassHash||e.template.subclassConfig?.superHash||0,socketOverrides:{}},...(e.template.items||[]).map(a=>({hash:a.hash||0,socketOverrides:a.socketOverrides||{}}))].filter(a=>(a.hash||0)>0),unequipped:[],parameters:{mods:e.template.armorMods||[],modsByBucket:{},exoticArmorHash:e.template.exoticArmor?.hash||0,statConstraints:[]}};return JSON.stringify(i,null,2)}async importFromJson(e){const i=JSON.parse(e),a={id:i.id||`imported-${Date.now()}`,name:i.name||"Imported Loadout",element:"solar",guardianClass:i.classType||0,exoticWeapon:{hash:i.equipped?.[0]?.hash||0,name:"Unknown",slot:1},exoticArmor:{hash:i.parameters?.exoticArmorHash||i.equipped?.[1]?.hash||0,name:"Unknown",slot:3},subclassConfig:{superHash:0,aspects:[],fragments:[]},armorMods:i.parameters?.mods||[],playstyle:"Imported",difficulty:"intermediate"},d={id:a.id,name:a.name,template:a,createdAt:Date.now(),lastModified:Date.now(),tags:["imported"]};return await v.setSavedBuild(d),C.getState().addBuild(d),d}}const z=new P;export{z as b};
//# sourceMappingURL=build.service-Cqpku5ux.js.map
