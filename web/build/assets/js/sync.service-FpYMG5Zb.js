import{i as n,o,r as f,q as c,n as u}from"./galaxy-CADwz3wb.js";import"./markdown-DyKRzreE.js";import"./react-vendor-BrsWO7iZ.js";import"./builder-KXRIEMV5.js";import"./utils-Cl4ySqJD.js";const r="exoengine_saved_builds_v1";class g{isSyncing=!1;async pullFromCloud(){if(!this.isSyncing){this.isSyncing=!0;try{const i=(await n.getUserApplicationData())[r]||[];if(i.length===0)return;const a=await o.getSavedBuilds(),s=this.mergeBuilds(a,i);for(const l of s.toUpdate)await o.setSavedBuild(l);if(s.toUpdate.length>0){const l=await o.getSavedBuilds();f.getState().setBuilds(l),c("Sync",`Pulled ${s.toUpdate.length} updates from cloud.`)}s.requiresPush&&await this.pushToCloud()}catch(t){if(t?.message?.includes("404")||t?.message?.includes("not valid JSON"))return;u("Sync","Pull failed:",t)}finally{this.isSyncing=!1}}}async pushToCloud(){try{const t=await o.getSavedBuilds(),i=await n.getUserApplicationData();i[r]=t,await n.setUserApplicationData(i),c("Sync",`Pushed ${t.length} builds to cloud.`)}catch(t){u("Sync","Push failed:",t)}}mergeBuilds(t,i){const a=[];let s=!1;const l=new Map(t.map(e=>[e.id,e])),p=new Map(i.map(e=>[e.id,e]));for(const e of i){const d=l.get(e.id);d?(e.lastModified||0)>(d.lastModified||0)?a.push(e):(d.lastModified||0)>(e.lastModified||0)&&(s=!0):a.push(e)}for(const e of t)p.has(e.id)||(s=!0);return{toUpdate:a,requiresPush:s}}startHeartbeat(t=300*1e3){setInterval(()=>{this.pullFromCloud().catch(i=>u("Sync","Heartbeat pull failed:",i))},t)}}const w=new g;export{w as syncService};
//# sourceMappingURL=sync.service-FpYMG5Zb.js.map
